<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- SEO Meta Tags -->
    <title>Kiek mol in (KIN) – Restaurants in Ostfriesland | Greetsiel, Norddeich, Norden</title>
    <meta name="description" content="KIN - Kiek mol in: Finde die besten Restaurants in Ostfriesland! Freie Tische in Greetsiel, Norddeich, Norden, Aurich & Emden. Jetzt reservieren - kostenlos & ohne App-Download. Die Restaurant-App für Ostfriesland.">
    <meta name="keywords" content="KIN, Kiek mol in, kiekmolin, Restaurant Ostfriesland, Essen Greetsiel, Restaurant Norddeich, Fischrestaurant Nordsee, Pizzeria Ostfriesland, Café Greetsiel, Tisch reservieren, freie Tische, Urlaub Ostfriesland, Essen gehen Norden, Restaurant Aurich, Gastronomie Emden, Restaurant App, Ostfriesland App, Nordsee Restaurant, Krummhörn, Pewsum, Marienhafe, Norderney, Juist, Baltrum, Langeoog, Spiekeroog, Borkum, Wangerooge, Ostfriesische Inseln, Lieferservice Ostfriesland, Döner Ostfriesland, Shisha Bar Ostfriesland, Bar Ostfriesland, Jobs Gastronomie, Kellner gesucht">
    <meta name="author" content="Kiek mol in (KIN) - Ibrahim Kuran - Kurani Design">
    <meta name="robots" content="index, follow, max-image-preview:large">
    <meta name="google-site-verification" content="mho-dxotdZhwJ4r1IHY3YWie_77u08U4Xt8miG5IEhs">
    <meta name="googlebot" content="index, follow">
    <link rel="canonical" href="https://kiekmolin.de/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kiekmolin.de/">
    <meta property="og:title" content="Kiek mol in (KIN) – Die besten Restaurants in Ostfriesland">
    <meta property="og:description" content="KIN App: Entdecke Restaurants, Cafés und Fischrestaurants in Greetsiel, Norddeich, Norden & mehr. Finde freie Tische und reserviere direkt!">
    <meta property="og:image" content="https://kiekmolin.de/icon-512.png">
    <meta property="og:image:width" content="512">
    <meta property="og:image:height" content="512">
    <meta property="og:locale" content="de_DE">
    <meta property="og:site_name" content="Kiek mol in">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://kiekmolin.de/">
    <meta name="twitter:title" content="Kiek mol in (KIN) – Restaurants in Ostfriesland">
    <meta name="twitter:description" content="KIN: Finde die besten Restaurants in Ostfriesland. Freie Tische, Reservierungen, Bewertungen.">
    <meta name="twitter:image" content="https://kiekmolin.de/icon-512.png">
    
    <!-- Geo Tags für lokale Suche -->
    <meta name="geo.region" content="DE-NI">
    <meta name="geo.placename" content="Ostfriesland">
    <meta name="geo.position" content="53.5021;7.0965">
    <meta name="ICBM" content="53.5021, 7.0965">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a5f4a" id="themeColorMeta">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Kiek mol in">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Kiek mol in">
    <meta name="msapplication-TileColor" content="#1a5f4a">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- App Icons -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    
    <!-- Structured Data / Schema.org für Google -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Kiek mol in",
        "alternateName": ["KIN", "Kiekmolin", "Kiek mol in App", "KIN App"],
        "description": "KIN - Finde die besten Restaurants in Ostfriesland - Greetsiel, Norddeich, Norden, Aurich, Emden. Die Restaurant-App für Ostfriesland.",
        "url": "https://kiekmolin.de",
        "applicationCategory": "FoodEstablishment, TravelApplication",
        "operatingSystem": "Web, iOS, Android",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "EUR"
        },
        "author": {
            "@type": "Organization",
            "name": "Kurani Design",
            "founder": {
                "@type": "Person",
                "name": "Ibrahim Kuran"
            }
        },
        "areaServed": {
            "@type": "Place",
            "name": "Ostfriesland",
            "geo": {
                "@type": "GeoCoordinates",
                "latitude": "53.5021",
                "longitude": "7.0965"
            }
        }
    }
    </script>
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "LocalBusiness",
        "name": "Kiek mol in (KIN) - Restaurant-Finder Ostfriesland",
        "alternateName": "KIN App",
        "description": "KIN: Entdecke Restaurants, Cafés, Bars, Shisha Lounges und Fischrestaurants in Ostfriesland. Jobs in der Gastronomie.",
        "url": "https://kiekmolin.de",
        "telephone": "",
        "email": "info@kiekmolin.de",
        "address": {
            "@type": "PostalAddress",
            "streetAddress": "Waller Weg 37",
            "addressLocality": "Südbrookmerland",
            "postalCode": "26624",
            "addressCountry": "DE"
        },
        "areaServed": ["Greetsiel", "Norddeich", "Norden", "Aurich", "Emden", "Ostfriesland", "Krummhörn", "Pewsum", "Marienhafe", "Leer", "Wiesmoor", "Norderney", "Juist", "Baltrum", "Langeoog"],
        "serviceType": ["Restaurant Reservierung", "Tischreservierung", "Restaurant Suche", "Gastronomie Jobs"]
    }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    // GLOBALE SUPABASE - SOFORT INITIALISIEREN
    var SUPA_URL = 'https://mvrgmbdokdzmumdyezha.supabase.co';
    var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12cmdtYmRva2R6bXVtZHllemhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjEyOTgsImV4cCI6MjA4MTEzNzI5OH0.7Ciwa2UKUHwtorvq3p6sN69XmVvPg0Kvg5lgrovxpDw';
    var RESTAURANT_ID = '888dc5bc-1649-4762-a8ee-2eb1e5e1dfad';
    var KATEGORIE_ID = '35a88714-31fa-4032-a0a0-82f93e27d9d8';
    var sb = null;
    
    try {
        sb = window.supabase.createClient(SUPA_URL, SUPA_KEY);
        window.sb = sb;
        console.log('✅ Supabase OK');
    } catch(e) {
        console.log('❌ Supabase Fehler:', e);
    }
    </script>
    
    <!-- Leaflet Maps (kostenlos) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Tesseract.js - Kostenlose OCR im Browser -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <!-- PDF.js - PDF zu Bild konvertieren (Legacy Build für Kompatibilität) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // PDF.js Worker konfigurieren - nach vollständigem Laden
        document.addEventListener('DOMContentLoaded', function() {
            if (window.pdfjsLib) {
                window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
                console.log('✅ PDF.js Worker konfiguriert');
            } else {
                console.log('⚠️ PDF.js nicht geladen');
            }
        });
    </script>
    
    <style>
        :root {
            --primary: #1a5f4a;
            --primary-light: #2d8a6b;
            --primary-dark: #0f3d2f;
            --accent: #e8a838;
            --accent-light: #ffd07a;
            --cream: #faf8f3;
            --sand: #f0ebe0;
            --charcoal: #2c2c2c;
            --slate: #5a5a5a;
            --white: #ffffff;
            --dark: #2c2c2c;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 40px rgba(0,0,0,0.16);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 28px;
            
            /* Theme-spezifische Variablen */
            --bg-primary: #f0ebe0;
            --bg-secondary: #faf8f3;
            --bg-card: #ffffff;
            --text-primary: #2c2c2c;
            --text-secondary: #5a5a5a;
            --border-color: #e0dbd0;
            
            /* Navigator Theme Variablen */
            --sidebar-bg: #ffffff;
            --sidebar-text: #2c2c2c;
            --sidebar-text-dim: rgba(44, 44, 44, 0.6);
            --sidebar-hover: rgba(44, 44, 44, 0.05);
            --sidebar-active: #1a5f4a;
            --sidebar-active-text: #ffffff;
            --sidebar-border: rgba(44, 44, 44, 0.1);
        }

        /* Dark Mode */
        [data-theme="dark"],
        .dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #242424;
            --bg-card: #2c2c2c;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --border-color: #3a3a3a;
            --sand: #1a1a1a;
            --cream: #242424;
            --charcoal: #f0f0f0;
            --slate: #a0a0a0;
            --white: #2c2c2c;
            --dark: #f0f0f0;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 40px rgba(0,0,0,0.5);
            
            /* Navigator Dark Mode */
            --sidebar-bg: #2c2c2c;
            --sidebar-text: rgba(255, 255, 255, 0.9);
            --sidebar-text-dim: rgba(255, 255, 255, 0.6);
            --sidebar-hover: rgba(255, 255, 255, 0.08);
            --sidebar-active: #1a5f4a;
            --sidebar-active-text: #ffffff;
            --sidebar-border: rgba(255, 255, 255, 0.1);
        }
        
        /* Theme Farben für aktiven Navigator */
        body.theme-green { --sidebar-active: #1a5f4a; }
        body.theme-blue { --sidebar-active: #2563eb; }
        body.theme-purple { --sidebar-active: #8b5cf6; }
        body.theme-orange { --sidebar-active: #f97316; }
        body.theme-pink { --sidebar-active: #ec4899; }
        body.theme-teal { --sidebar-active: #14b8a6; }
        body.theme-red { --sidebar-active: #ef4444; }
        body.theme-yellow { --sidebar-active: #eab308; }

        /* Force dark mode colors on body */
        body.dark-mode {
            background: #1a1a1a !important;
            color: #f0f0f0 !important;
        }

        .dark-mode .guest-view {
            background: #242424 !important;
        }

        .dark-mode .restaurant-card,
        .dark-mode .stat-card,
        .dark-mode .modal,
        .dark-mode .bottom-nav {
            background: #2c2c2c !important;
        }

        .dark-mode .chip:not(.active) {
            background: #2c2c2c !important;
            color: #f0f0f0 !important;
        }

        .dark-mode .search-bar {
            background: #2c2c2c !important;
        }

        .dark-mode .search-bar input {
            background: transparent !important;
            color: #f0f0f0 !important;
        }

        .dark-mode .restaurant-name,
        .dark-mode .section-title,
        .dark-mode .modal-title,
        .dark-mode .favorites-header h1 {
            color: #f0f0f0 !important;
        }

        .dark-mode .restaurant-meta,
        .dark-mode .stat-label {
            color: #a0a0a0 !important;
        }

        /* Dashboard Sidebar Dark Mode Fix */
        .dark-mode .dash-sidebar {
            background: #1a1a1a !important;
        }

        .dark-mode .dash-nav-item {
            color: rgba(255,255,255,0.7) !important;
        }

        .dark-mode .dash-nav-item:hover {
            background: rgba(255,255,255,0.1) !important;
            color: #fff !important;
        }

        .dark-mode .dash-nav-item.active {
            background: var(--primary) !important;
            color: #fff !important;
        }

        .dark-mode .dash-logo .restaurant-label {
            color: rgba(255,255,255,0.5) !important;
        }

        /* ==================== APPLE-STYLE THEME SYSTEM ==================== */
        
        /* Theme Mode Buttons */
        .theme-mode-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .theme-mode-btn:hover {
            border-color: var(--primary);
        }
        
        .theme-mode-btn.active {
            border-color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
        }
        
        .theme-mode-btn span {
            font-size: 12px;
            color: var(--text-primary);
        }
        
        .theme-preview {
            width: 60px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .theme-preview-light {
            background: linear-gradient(135deg, #f8f8f8 50%, #e0e0e0 50%);
        }
        
        .theme-preview-dark {
            background: linear-gradient(135deg, #2c2c2c 50%, #1a1a1a 50%);
        }
        
        .theme-preview-auto {
            background: linear-gradient(135deg, #f8f8f8 25%, #2c2c2c 25%, #2c2c2c 50%, #e0e0e0 50%, #e0e0e0 75%, #1a1a1a 75%);
        }
        
        /* Accent Colors */
        .accent-colors {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .accent-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 3px solid transparent;
            background: var(--accent);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .accent-btn:hover {
            transform: scale(1.1);
        }
        
        .accent-btn.active {
            border-color: var(--text-primary);
            transform: scale(1.15);
        }
        
        /* Glass Effect Buttons */
        .glass-btn, .corner-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .glass-btn:hover, .corner-btn:hover {
            border-color: var(--primary);
        }
        
        .glass-btn.active, .corner-btn.active {
            border-color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
        }
        
        .glass-btn span, .corner-btn span {
            font-size: 13px;
            color: var(--text-primary);
        }
        
        /* Glasmorphism Effects */
        .glass-effect-subtle .modal,
        .glass-effect-subtle .bottom-nav,
        .glass-effect-subtle .dash-sidebar {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.85) !important;
        }
        
        .glass-effect-strong .modal,
        .glass-effect-strong .bottom-nav,
        .glass-effect-strong .restaurant-card,
        .glass-effect-strong .stat-card,
        .glass-effect-strong .dash-sidebar {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(255,255,255,0.75) !important;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .dark-mode.glass-effect-subtle .modal,
        .dark-mode.glass-effect-subtle .bottom-nav {
            background: rgba(30,30,30,0.85) !important;
        }
        
        .dark-mode.glass-effect-strong .modal,
        .dark-mode.glass-effect-strong .bottom-nav,
        .dark-mode.glass-effect-strong .restaurant-card,
        .dark-mode.glass-effect-strong .stat-card {
            background: rgba(30,30,30,0.75) !important;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Icon Labels für Formulare - wie Navigator */
        .label-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            margin-right: 6px;
            vertical-align: middle;
        }
        
        .label-icon svg {
            width: 16px;
            height: 16px;
        }
        
        .form-label {
            display: flex;
            align-items: center;
        }
        
        /* Corner Radius Variants */
        .corners-sharp {
            --radius-sm: 2px;
            --radius-md: 4px;
            --radius-lg: 6px;
            --radius-xl: 8px;
        }
        
        .corners-rounded {
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 18px;
        }
        
        .corners-pill {
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 20px;
            --radius-xl: 24px;
        }

        .dark-mode .form-input,
        .dark-mode .form-select,
        .dark-mode .form-textarea {
            background: #2c2c2c !important;
            color: #f0f0f0 !important;
            border-color: #3a3a3a !important;
        }

        .dark-mode .location-btn:not(.active) {
            background: #2c2c2c !important;
            color: #f0f0f0 !important;
            border-color: #3a3a3a !important;
        }

        .dark-mode .rating {
            background: #3a3a3a !important;
            color: #f0f0f0 !important;
        }

        /* Weather Alert Banner Dark Mode */
        .dark-mode #weatherAlertBanner {
            background: rgba(44, 44, 44, 0.9) !important;
            border-color: rgba(60, 60, 60, 0.5) !important;
        }

        .dark-mode #alertTitle {
            color: #f0f0f0 !important;
        }

        .dark-mode #alertMessage {
            color: #a0a0a0 !important;
        }

        .dark-mode .guest-header::after {
            background: #242424 !important;
        }

        /* Dashboard Dark Mode */
        .dark-mode .dashboard-view {
            background: #1a1a1a !important;
        }

        .dark-mode .dash-main {
            background: #1a1a1a !important;
        }

        .dark-mode .dash-header {
            background: #242424 !important;
            border-color: #3a3a3a !important;
        }

        .dark-mode .dash-greeting {
            color: #f0f0f0 !important;
        }

        .dark-mode .stat-panel,
        .dark-mode .panel {
            background: #2c2c2c !important;
        }

        .dark-mode .stat-panel h3,
        .dark-mode .panel-title {
            color: #f0f0f0 !important;
        }

        .dark-mode .stat-panel p {
            color: #a0a0a0 !important;
        }

        .dark-mode table {
            background: #2c2c2c !important;
        }

        .dark-mode th {
            background: #3a3a3a !important;
            color: #f0f0f0 !important;
        }

        .dark-mode td {
            color: #f0f0f0 !important;
            border-color: #3a3a3a !important;
        }

        .dark-mode tr:hover {
            background: #3a3a3a !important;
        }

        .dark-mode .dash-btn-secondary {
            background: #3a3a3a !important;
            color: #f0f0f0 !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: transparent;
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* View Toggle */
        .view-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 6px;
            box-shadow: var(--shadow-md);
        }

        .toggle-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
        }

        .toggle-btn.active {
            background: var(--primary);
            color: var(--white);
        }

        .toggle-btn:hover:not(.active) {
            background: var(--sand);
        }

        /* Location Buttons */
        .location-btn {
            padding: 14px 16px;
            border: 2px solid var(--sand);
            background: var(--white);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--charcoal);
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        .location-btn:hover {
            border-color: var(--primary);
            background: var(--cream);
        }
        .location-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        /* Filter Chips */
        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1.5px solid var(--border-color);
            background: var(--bg-card);
            color: var(--slate);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        
        .filter-chip:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .filter-chip.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .dark-mode .filter-chip {
            background: #2c2c2c;
            border-color: #3a3a3a;
            color: #a0a0a0;
        }
        
        .dark-mode .filter-chip.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Open Badge */
        .open-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .open-badge.open {
            background: rgba(52, 199, 89, 0.15);
            color: #34c759;
        }
        
        .open-badge.closed {
            background: rgba(255, 59, 48, 0.15);
            color: #ff3b30;
        }

        /* Language Switcher */
        .lang-switcher {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        
        .lang-btn {
            padding: 6px 10px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            color: var(--slate);
            transition: all 0.2s;
        }
        
        .lang-btn.active {
            background: var(--bg-card);
            color: var(--dark);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            max-width: 450px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 24px 24px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        /* Slot Selection Styles */
        .slots-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .slot-btn {
            padding: 10px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-card);
            color: var(--dark);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'DM Sans', sans-serif;
        }
        
        .slot-btn:hover {
            border-color: var(--primary);
            background: rgba(26,79,99,0.05);
        }
        
        .slot-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .slot-btn.unavailable {
            opacity: 0.4;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        .slot-btn .slot-tables {
            font-size: 10px;
            font-weight: 400;
            opacity: 0.7;
            display: block;
            margin-top: 2px;
        }
        
        .slots-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--slate);
        }
        
        .slots-loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            transition: border-color 0.2s ease;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        /* Location Button */
        .location-btn {
            padding: 14px 16px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .location-btn:hover {
            border-color: var(--primary);
        }

        .location-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: #2c2c2c;
            color: #ffffff;
            padding: 14px 24px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        [data-theme="dark"] .toast {
            background: #404040;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Guest View */
        .guest-view {
            display: block;
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
            min-height: 100vh;
            background: var(--bg-secondary);
            position: relative;
            overflow: hidden;
        }
        
        /* Desktop: Volle Breite */
        @media (min-width: 768px) {
            .guest-view {
                max-width: 100%;
            }
            
            .bottom-nav {
                max-width: 100%;
            }
        }
        
        /* Große Bildschirme */
        @media (min-width: 1200px) {
            .guest-view {
                max-width: 100%;
            }
            
            .bottom-nav {
                max-width: 100%;
            }
        }

        .guest-view.hidden {
            display: none;
        }

        /* Header */
        .guest-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 60px 24px 100px;
            position: relative;
            overflow: hidden;
            margin: 0;
        }

        .guest-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -30%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(232,168,56,0.2) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
        }

        .guest-header::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 0;
            right: 0;
            height: 40px;
            background: var(--bg-secondary);
            border-radius: 50% 50% 0 0;
            pointer-events: none;
            z-index: 1;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 32px;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }

        .logo span {
            color: var(--accent);
        }

        .tagline {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            margin-bottom: 24px;
        }

        .location-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 14px 18px;
            border-radius: var(--radius-md);
            color: white;
            cursor: pointer;
        }

        .location-bar svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .location-bar span {
            font-weight: 500;
        }

        .location-bar .change {
            margin-left: auto;
            font-size: 13px;
            opacity: 0.8;
        }

        /* Quick Stats */
        .quick-stats {
            display: flex;
            gap: 12px;
            padding: 0 20px;
            margin-top: -50px;
            position: relative;
            z-index: 10;
        }

        .stat-card {
            flex: 1;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Section */
        .section {
            padding: 24px 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 22px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .see-all {
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
        }

        /* Search Bar */
        .search-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .search-bar svg {
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
        }

        .search-bar input {
            flex: 1;
            border: none;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            outline: none;
            background: transparent;
            color: var(--text-primary);
        }

        .search-bar input::placeholder {
            color: var(--text-secondary);
        }

        /* Filter Chips */
        .filter-chips {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-bottom: 16px;
            -webkit-overflow-scrolling: touch;
        }

        .filter-chips::-webkit-scrollbar {
            display: none;
        }

        .chip {
            padding: 10px 18px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-primary);
        }

        .chip.active {
            background: var(--primary);
            color: white;
        }

        .chip:hover:not(.active) {
            border-color: var(--primary);
        }

        /* Restaurant Card */
        .restaurant-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: visible;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .restaurant-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .restaurant-card.hidden {
            display: none;
        }

        .card-image {
            height: 160px;
            background-size: cover;
            background-position: center;
            position: relative;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            overflow: hidden;
        }

        .card-image::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(transparent, rgba(0,0,0,0.4));
        }

        .availability-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .availability-badge.available {
            background: var(--success);
            color: var(--white);
        }

        .availability-badge.limited {
            background: var(--warning);
            color: var(--white);
        }

        .availability-badge.full {
            background: var(--danger);
            color: var(--white);
        }

        .availability-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .special-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--accent);
            color: #2c2c2c;
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 700;
        }

        .favorite-btn {
            position: absolute;
            bottom: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: var(--bg-card);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            transition: all 0.2s ease;
        }

        .favorite-btn svg {
            width: 20px;
            height: 20px;
            stroke: var(--danger);
            fill: transparent;
            transition: all 0.2s ease;
        }

        .favorite-btn.active svg {
            fill: var(--danger);
        }

        .card-content {
            padding: 16px;
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .restaurant-name {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-cuisine {
            font-size: 13px;
            color: var(--slate);
            margin: 4px 0 8px 0;
        }

        .today-special {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(26, 95, 74, 0.08);
            border: 1px solid rgba(26, 95, 74, 0.2);
            border-radius: 10px;
            padding: 10px 12px;
            margin: 12px 0;
            font-size: 13px;
        }

        .ar-btn {
            background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .special-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .rating svg {
            width: 14px;
            height: 14px;
            fill: var(--accent);
        }

        .restaurant-meta {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .meta-item svg {
            width: 14px;
            height: 14px;
            opacity: 0.6;
        }

        .today-special {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            color: var(--white);
            padding: 12px;
            border-radius: var(--radius-sm);
            font-size: 13px;
        }

        .today-special strong {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .card-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-top: 14px;
        }

        .card-actions::-webkit-scrollbar {
            display: none;
        }

        .card-btn {
            padding: 10px 6px;
            border: none;
            border-radius: var(--radius-md);
            font-family: 'DM Sans', sans-serif;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            text-decoration: none;
            white-space: nowrap;
            min-height: 52px;
        }
        
        .card-btn svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .card-btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .card-btn-primary:hover {
            background: var(--primary-dark);
        }

        .card-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .card-btn-secondary:hover {
            background: var(--border-color);
        }

        .dark-mode .card-btn-secondary {
            background: #3a3a3a !important;
            color: #f0f0f0 !important;
        }

        .card-btn-whatsapp {
            background: #25D366;
            color: white;
        }

        .card-btn-whatsapp:hover {
            background: #1da851;
        }

        .card-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Swipe Container - nur für Buttons */
        .swipe-container {
            /* Normale Liste, kein Swipe für Cards */
        }

        .swipe-dots {
            display: none;
        }

        /* Live Counter */
        .live-section {
            background: var(--charcoal);
            margin: 0 20px;
            border-radius: var(--radius-lg);
            padding: 20px;
            color: var(--white);
            position: relative;
            overflow: hidden;
        }

        .live-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, var(--primary) 0%, transparent 70%);
            opacity: 0.3;
        }

        .live-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .live-title {
            font-weight: 600;
            font-size: 15px;
        }

        .live-count {
            font-family: 'Playfair Display', serif;
            font-size: 48px;
            font-weight: 700;
            color: var(--accent);
            line-height: 1;
        }

        .live-label {
            font-size: 14px;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            background: var(--bg-card);
            padding: 12px 20px calc(12px + env(safe-area-inset-bottom, 16px));
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            border-radius: 0;
            z-index: 1000;
        }
        
        @media screen and (max-width: 430px) {
            .bottom-nav {
                left: 0;
                right: 0;
                max-width: 100%;
                border-radius: 0;
            }
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: color 0.2s ease;
            position: relative;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
        }

        .nav-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: 700;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Favorites View */
        .favorites-view {
            display: none;
            padding: 0;
            padding-bottom: 100px;
        }

        .favorites-view.active {
            display: block;
        }
        
        .favorites-view .guest-header {
            border-radius: 0;
            margin: 0;
        }
        
        .favorites-view .section,
        .favorites-view .quick-stats,
        .favorites-view .search-bar,
        .favorites-view .filter-chips {
            padding-left: 20px;
            padding-right: 20px;
        }
        
        .favorites-view .quick-stats {
            margin: 0;
            padding-top: 20px;
        }

        .favorites-header {
            padding-top: 40px;
            margin-bottom: 24px;
        }

        .favorites-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* ==================== DASHBOARD VIEW ==================== */
        .dashboard-view {
            display: none;
            min-height: 100vh;
            background: var(--bg-secondary);
        }

        .dashboard-view.active {
            display: block;
        }

        .dash-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: var(--sidebar-bg);
            padding: 24px 0;
            z-index: 100;
            transition: all 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .dash-logo {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--sidebar-border);
        }

        .dash-logo .logo {
            font-size: 24px;
            color: var(--sidebar-text);
            transition: color 0.3s ease;
        }

        .dash-logo .restaurant-label {
            color: var(--sidebar-text-dim);
            font-size: 13px;
            margin-top: 4px;
            transition: color 0.3s ease;
        }

        .dash-nav {
            padding: 16px 14px;
        }

        .dash-nav-item {
            display: flex;
            align-items: center;
            gap: 11px;
            padding: 11px 14px;
            color: var(--sidebar-text);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 3px;
            font-size: 14px;
        }

        .dash-nav-item:hover {
            background: var(--sidebar-hover);
        }

        .dash-nav-item.active {
            background: var(--sidebar-active);
            color: var(--sidebar-active-text);
        }

        .dash-nav-item svg {
            width: 19px;
            height: 19px;
            flex-shrink: 0;
        }

        .nav-count {
            margin-left: auto;
            background: var(--primary-light);
            color: var(--white);
            font-size: 10px;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 10px;
        }

        .dash-nav-item.active .nav-count {
            background: rgba(255,255,255,0.3);
        }

        /* Dashboard Sections */
        .dash-section {
            display: none;
        }

        .dash-section.active {
            display: block;
        }

        .gastro-view {
            display: none;
            min-height: 100vh;
            background: var(--bg);
        }
        
        .gastro-view.active {
            display: block;
        }

        .section-back {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .section-back:hover {
            color: var(--primary-dark);
        }

        .section-page-title {
            font-family: 'Playfair Display', serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--charcoal);
            margin-bottom: 24px;
        }

        .dash-main {
            margin-left: 260px;
            padding: 24px 32px;
            padding-bottom: 100px;
        }

        .dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .dash-greeting {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 600;
            color: var(--charcoal);
        }

        .dash-date {
            color: var(--slate);
            font-size: 14px;
            margin-top: 4px;
        }

        .dash-actions {
            display: flex;
            gap: 12px;
        }

        .dash-btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .dash-btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .dash-btn-primary:hover {
            background: var(--primary-dark);
        }

        .dash-btn-secondary {
            background: var(--white);
            color: var(--charcoal);
            box-shadow: var(--shadow-sm);
        }

        .dash-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-box {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
        }

        .stat-box-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-box-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-box-icon.green {
            background: rgba(52, 199, 89, 0.15);
            color: var(--success);
        }

        .stat-box-icon.orange {
            background: rgba(255, 149, 0, 0.15);
            color: var(--warning);
        }

        .stat-box-icon.blue {
            background: rgba(26, 95, 74, 0.15);
            color: var(--primary);
        }

        .stat-box-icon.gold {
            background: rgba(232, 168, 56, 0.15);
            color: var(--accent);
        }

        .stat-box-icon svg {
            width: 24px;
            height: 24px;
        }

        .stat-box-trend {
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-box-trend.up {
            color: var(--success);
        }

        .stat-box-value {
            font-family: 'Playfair Display', serif;
            font-size: 36px;
            font-weight: 700;
            color: var(--charcoal);
            line-height: 1;
        }

        .stat-box-label {
            font-size: 14px;
            color: var(--slate);
            margin-top: 8px;
        }

        /* Panels */
        .panels-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .panel {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .panel-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--sand);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 600;
        }

        .panel-content {
            padding: 20px 24px;
        }

        /* Availability Control */
        .availability-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--sand);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
        }

        .availability-status {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-indicator.closed {
            background: var(--danger);
        }

        .status-text {
            font-weight: 600;
        }

        .toggle-switch {
            width: 52px;
            height: 28px;
            background: var(--success);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            right: 3px;
            width: 22px;
            height: 22px;
            background: var(--white);
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .toggle-switch.off {
            background: var(--danger);
        }

        .toggle-switch.off::after {
            right: auto;
            left: 3px;
        }

        /* Table Grid */
        .table-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .table-item {
            aspect-ratio: 1;
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .table-item.free {
            background: rgba(52, 199, 89, 0.15);
            color: var(--success);
        }

        .table-item.occupied {
            background: rgba(255, 59, 48, 0.15);
            color: var(--danger);
        }

        .table-item.reserved {
            background: rgba(255, 149, 0, 0.15);
            color: var(--warning);
        }

        .table-item:hover {
            border-color: currentColor;
            transform: scale(1.05);
        }

        .table-number {
            font-weight: 700;
            font-size: 18px;
        }

        .table-seats {
            font-size: 11px;
            opacity: 0.8;
        }

        .table-legend {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            font-size: 13px;
            color: var(--slate);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }

        .legend-dot.free { background: rgba(52, 199, 89, 0.3); }
        .legend-dot.occupied { background: rgba(255, 59, 48, 0.3); }
        .legend-dot.reserved { background: rgba(255, 149, 0, 0.3); }

        /* Reservations */
        .reservation-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 0;
            border-bottom: 1px solid var(--sand);
        }

        .reservation-item:last-child {
            border-bottom: none;
        }

        .reservation-time {
            width: 60px;
            text-align: center;
        }

        .reservation-time-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--charcoal);
        }

        .reservation-time-label {
            font-size: 11px;
            color: var(--slate);
        }

        .reservation-info {
            flex: 1;
        }

        .reservation-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .reservation-details {
            font-size: 13px;
            color: var(--slate);
        }

        .reservation-actions {
            display: flex;
            gap: 8px;
        }

        .reservation-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reservation-btn.confirm {
            background: rgba(52, 199, 89, 0.15);
            color: var(--success);
        }

        .reservation-btn.cancel {
            background: rgba(255, 59, 48, 0.15);
            color: var(--danger);
        }

        .reservation-btn svg {
            width: 16px;
            height: 16px;
        }

        .reservation-status {
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
        }

        .reservation-status.confirmed {
            background: rgba(52, 199, 89, 0.15);
            color: var(--success);
        }

        .reservation-status.pending {
            background: rgba(255, 149, 0, 0.15);
            color: var(--warning);
        }

        .reservation-status.cancelled {
            background: rgba(255, 59, 48, 0.15);
            color: var(--danger);
        }

        /* Offer Form */
        .offer-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .offer-preview {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            color: var(--white);
            padding: 20px;
            border-radius: var(--radius-md);
            text-align: center;
        }

        .offer-preview-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .offer-preview-title {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .offer-preview-discount {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Active Offers */
        .active-offers {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--sand);
        }

        .active-offers h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--slate);
        }

        .offer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--sand);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .offer-item-info h5 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .offer-item-info p {
            font-size: 12px;
            color: var(--slate);
        }

        .offer-item-delete {
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(255, 59, 48, 0.15);
            color: var(--danger);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ==================== DESKTOP LAYOUT ==================== */
        @media (min-width: 768px) {
            /* Container zentrieren */
            .guest-view {
                max-width: 1400px;
                margin: 0 auto;
                padding: 0 40px;
            }
            
            /* Header Desktop */
            .guest-header {
                padding: 30px 40px 90px;
                border-radius: 0 0 32px 32px;
            }
            
            .guest-header .logo {
                font-size: 42px;
            }
            
            .guest-header .tagline {
                font-size: 18px;
            }
            
            /* Quick Actions Desktop */
            .quick-stats {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 16px;
            }
            
            /* Restaurant Grid Desktop */
            #restaurantList {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 24px;
            }
            
            .restaurant-card {
                margin-bottom: 0;
            }
            
            /* Offers Grid */
            .live-section {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
            }
            
            /* Navigation Desktop - oben statt unten */
            .bottom-nav {
                position: fixed;
                top: 0;
                bottom: auto;
                border-radius: 0;
                border-top: none;
                border-bottom: 1px solid var(--sand);
                padding: 12px 40px;
                justify-content: flex-end;
                gap: 32px;
                max-width: 1400px;
                left: 50%;
                transform: translateX(-50%);
                width: 100%;
            }
            
            .nav-item {
                flex-direction: row;
                gap: 8px;
            }
            
            .nav-item span {
                font-size: 14px;
            }
            
            /* Content Padding für Top-Nav */
            .guest-view {
                padding-top: 70px;
            }
            
            /* Footer anpassen */
            footer {
                padding-bottom: 40px !important;
            }
            
            /* Assistent Button Position */
            .assistant-btn {
                bottom: 30px;
                right: 40px;
            }
            
            /* Modals größer */
            .modal {
                max-width: 600px;
            }
            
            /* Section Titles */
            .section-title {
                font-size: 28px;
            }
            
            /* Filter Chips */
            .filter-chip {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            /* Wetter Widget */
            #weatherWidget {
                padding: 24px;
                border-radius: 20px;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            
            /* Map größer */
            #guestMap {
                height: 350px;
                border-radius: 20px;
            }
        }
        
        /* Große Desktops */
        @media (min-width: 1200px) {
            #restaurantList {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .quick-stats {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .live-section {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Extra große Bildschirme */
        @media (min-width: 1600px) {
            #restaurantList {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Mobile responsive */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 900px) {
            .dash-sidebar {
                display: none;
            }
            .dash-main {
                margin-left: 0;
            }
            .panels-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Handy - Bottom Nav wieder unten */
        @media (max-width: 767px) {
            .bottom-nav {
                position: fixed;
                top: auto;
                bottom: 0;
                transform: none;
                left: 0;
                border-radius: 20px 20px 0 0;
                border-bottom: none;
                border-top: 1px solid var(--sand);
                padding: 8px 0 25px;
                justify-content: space-around;
            }
            
            .guest-view {
                padding-top: 0;
            }
            
            .nav-item {
                flex-direction: column;
                gap: 2px;
            }
        }

        /* ==================== JOBS SECTION ==================== */
        .job-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .job-card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .job-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .job-badge.fulltime {
            background: rgba(52, 199, 89, 0.15);
            color: #34c759;
        }
        
        .job-badge.parttime {
            background: rgba(255, 149, 0, 0.15);
            color: #ff9500;
        }
        
        .job-badge.minijob {
            background: rgba(90, 200, 250, 0.15);
            color: #5ac8fa;
        }
        
        .job-badge.urgent {
            background: rgba(255, 59, 48, 0.15);
            color: #ff3b30;
        }

        /* KI Assistent */
        .assistant-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(26, 95, 74, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .assistant-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(26, 95, 74, 0.5);
        }

        .assistant-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 2500;
            padding: 20px;
        }

        .assistant-overlay.active {
            display: flex;
        }

        .assistant-chat {
            background: var(--bg-card);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 100%;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -4px 30px rgba(0,0,0,0.2);
            animation: slideUpChat 0.3s ease;
        }

        @keyframes slideUpChat {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .assistant-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .assistant-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .assistant-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .assistant-message {
            display: flex;
            max-width: 85%;
        }

        .assistant-message.bot {
            align-self: flex-start;
        }

        .assistant-message.user {
            align-self: flex-end;
        }

        .assistant-message .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
        }

        .assistant-message.bot .message-content {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .assistant-message.user .message-content {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .assistant-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .assistant-suggestions button {
            padding: 8px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .assistant-suggestions button:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .assistant-input {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
        }

        .assistant-input input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .assistant-input input:focus {
            border-color: var(--primary);
        }

        .assistant-input button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .assistant-input button:hover {
            background: var(--primary-dark);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* Notifications */
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            font-size: 11px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }

        .notification-badge.hidden {
            display: none;
        }

        .notification-item {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: var(--bg-secondary);
        }

        .notification-item.unread {
            background: rgba(26, 95, 74, 0.05);
        }

        [data-theme="dark"] .notification-item.unread {
            background: rgba(26, 95, 74, 0.15);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .notification-icon.green { background: rgba(52, 199, 89, 0.15); }
        .notification-icon.orange { background: rgba(255, 149, 0, 0.15); }
        .notification-icon.blue { background: rgba(0, 122, 255, 0.15); }
        .notification-icon.red { background: rgba(255, 59, 48, 0.15); }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .notification-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .notification-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .notification-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 6px;
        }

        .empty-notifications {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-notifications svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.3;
        }
        
        /* ==================== COMMUNITY & REVIEWS ==================== */
        .live-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(52, 199, 89, 0.15);
            color: #34c759;
            font-size: 11px;
            font-weight: 600;
            border-radius: 6px;
        }
        
        .live-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            background: #34c759;
            border-radius: 50%;
            animation: pulse-live 2s infinite;
        }
        
        @keyframes pulse-live {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .visitors-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(255, 149, 0, 0.15);
            color: #ff9500;
            font-size: 11px;
            font-weight: 600;
            border-radius: 6px;
        }
        
        .trending-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(255, 59, 48, 0.15);
            color: #ff3b30;
            font-size: 11px;
            font-weight: 600;
            border-radius: 6px;
        }
        
        /* Activity Feed */
        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        
        .activity-item.activity-new {
            background: rgba(52, 199, 89, 0.1);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .activity-icon {
            font-size: 16px;
        }
        
        .activity-text {
            flex: 1;
            color: var(--text-primary);
        }
        
        .activity-time {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        /* Reviews */
        .reviews-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .review-card {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .review-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .review-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
        }
        
        .review-meta {
            flex: 1;
        }
        
        .review-author {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .review-date {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .review-stars {
            color: #ffb800;
            font-size: 14px;
        }
        
        .review-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .review-comment {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }
        
        .review-photos {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            overflow-x: auto;
        }
        
        .review-photo {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
        }
        
        .review-helpful {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .helpful-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .helpful-btn:hover {
            background: var(--bg-secondary);
            color: var(--primary);
            border-color: var(--primary);
        }
        
        .helpful-btn.active {
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary);
            border-color: var(--primary);
        }
        
        /* Write Review */
        .star-rating-input {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
        }
        
        .star-rating-input span {
            font-size: 32px;
            cursor: pointer;
            color: #ddd;
            transition: all 0.15s;
        }
        
        .star-rating-input span:hover,
        .star-rating-input span.active {
            color: #ffb800;
            transform: scale(1.1);
        }
        
        .photo-upload-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .photo-upload-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .photo-upload-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-upload-item .remove-photo {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
        }
        
        .photo-upload-add {
            aspect-ratio: 1;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 24px;
            transition: all 0.2s;
        }
        
        .photo-upload-add:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        /* Stats Summary */
        .stats-summary {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        
        .stat-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 20px;
            font-size: 13px;
        }
        
        .stat-chip-icon {
            font-size: 14px;
        }
        
        .stat-chip-value {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .stat-chip-label {
            color: var(--text-secondary);
        }
        
        /* ==================== GEZEITEN WIDGET ==================== */
        .tide-widget {
            background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
            border-radius: 16px;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
        }
        
        .tide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .tide-title {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tide-status {
            font-size: 11px;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .tide-visual {
            height: 60px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .tide-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.3);
            transition: height 1s ease;
        }
        
        .tide-marker {
            position: absolute;
            width: 3px;
            height: 100%;
            background: white;
            opacity: 0.5;
        }
        
        .tide-times {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }
        
        .tide-time {
            text-align: center;
        }
        
        .tide-time-label {
            font-size: 10px;
            opacity: 0.7;
        }
        
        .tide-suggestions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 12px;
            display: flex;
            align-items: flex-start;
        }
        
        /* ==================== GAMIFICATION ==================== */
        .points-display {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%);
            border-radius: 20px;
            font-weight: 700;
            color: #333;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255,183,0,0.3);
        }
        
        .points-display:hover {
            transform: scale(1.05);
        }
        
        .level-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .level-bronze { background: #cd7f32; color: white; }
        .level-silver { background: #c0c0c0; color: #333; }
        .level-gold { background: #ffd700; color: #333; }
        .level-platinum { background: linear-gradient(135deg, #e5e4e2 0%, #a8a8a8 100%); color: #333; }
        .level-diamond { background: linear-gradient(135deg, #b9f2ff 0%, #48d1cc 100%); color: #333; }
        
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            border-radius: 20px;
            padding: 32px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 10000;
            animation: achievementPop 0.5s ease forwards;
        }
        
        @keyframes achievementPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        .achievement-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffb800);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        /* ==================== WARTEZEIT TRACKER ==================== */
        .wait-tracker {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .wait-bar {
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .wait-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .wait-low { background: #34c759; }
        .wait-medium { background: #ff9500; }
        .wait-high { background: #ff3b30; }
        
        .best-time-hint {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(52, 199, 89, 0.15);
            color: #34c759;
            font-size: 11px;
            border-radius: 6px;
        }
        
        /* ==================== ÜBERRASCHUNGS-MODUS ==================== */
        .surprise-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 50%, #48dbfb 100%);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(255,107,107,0.3);
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .surprise-btn:hover {
            transform: scale(1.05);
        }
        
        /* ==================== GRUPPEN-RESERVIERUNG ==================== */
        .group-invite {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            border-radius: 12px;
            padding: 16px;
            color: white;
        }
        
        .group-members {
            display: flex;
            gap: -8px;
        }
        
        .group-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid white;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-left: -8px;
        }
        
        .group-avatar:first-child {
            margin-left: 0;
        }
        
        .vote-option {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .vote-option:hover {
            border-color: var(--primary);
        }
        
        .vote-option.voted {
            border-color: #34c759;
            background: rgba(52, 199, 89, 0.1);
        }
        
        .vote-count {
            display: flex;
            gap: 4px;
        }
        
        .vote-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
        }
        
        /* Reward Icon Buttons */
        .reward-icon-btn {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-secondary);
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reward-icon-btn:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }
        
        .reward-icon-btn.active {
            border-color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.2);
        }
        
        /* ===== TISCHPLAN IM KIN-DESIGN ===== */
        .tischplan-box {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .tischplan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .tischplan-header h3 {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            margin: 0;
        }
        
        .tischplan-btn-add {
            padding: 10px 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .tischplan-btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26,95,74,0.3);
        }
        
        .tischplan-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .tischplan-filter {
            padding: 10px 18px;
            border-radius: 25px;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        .tischplan-filter:hover {
            border-color: var(--primary);
        }
        
        .tischplan-filter.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .tischplan-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            color: var(--slate);
            flex-wrap: wrap;
        }
        
        .tischplan-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tischplan-legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        
        .tischplan-legend-dot.available { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .tischplan-legend-dot.reserved { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .tischplan-legend-dot.billed { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .tischplan-legend-dot.soon { background: linear-gradient(135deg, #f59e0b, #d97706); }
        
        /* FLOORPLAN CANVAS */
        .tischplan-canvas {
            position: relative;
            background: var(--bg-secondary);
            border-radius: 16px;
            height: 420px;
            min-height: 420px;
            border: 2px solid var(--border-color);
            overflow: hidden;
        }
        
        /* Dezentes Raster */
        .tischplan-canvas::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                radial-gradient(circle, var(--border-color) 1px, transparent 1px);
            background-size: 30px 30px;
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* Raum-Elemente */
        .room-wall {
            position: absolute;
            background: var(--dark);
            opacity: 0.15;
        }
        
        .room-label {
            position: absolute;
            background: var(--primary);
            color: white;
            font-family: 'DM Sans', sans-serif;
            font-size: 11px;
            font-weight: 600;
            padding: 8px 14px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(26,95,74,0.3);
        }
        
        .room-label.bar {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            box-shadow: 0 4px 12px rgba(139,92,246,0.3);
        }
        
        .room-label.kitchen {
            background: linear-gradient(135deg, #64748b, #475569);
            box-shadow: 0 4px 12px rgba(100,116,139,0.3);
        }
        
        /* TISCHE */
        .tisch {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.25s ease;
            z-index: 10;
        }
        
        .tisch:hover {
            transform: scale(1.12);
            z-index: 20;
        }
        
        .tisch-body {
            position: relative;
            width: 68px;
            height: 68px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'DM Sans', sans-serif;
            font-weight: 700;
            font-size: 14px;
            color: #1e293b;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border: 4px solid;
            transition: all 0.25s ease;
        }
        
        .tisch-body.round {
            border-radius: 50%;
            width: 62px;
            height: 62px;
        }
        
        .tisch-body.large {
            width: 95px;
            height: 55px;
            border-radius: 12px;
        }
        
        /* Status Farben */
        .tisch.available .tisch-body {
            background: linear-gradient(145deg, #dbeafe, #bfdbfe);
            border-color: #3b82f6;
        }
        
        .tisch.reserved .tisch-body {
            background: linear-gradient(145deg, #fee2e2, #fecaca);
            border-color: #ef4444;
        }
        
        .tisch.billed .tisch-body {
            background: linear-gradient(145deg, #dcfce7, #bbf7d0);
            border-color: #22c55e;
        }
        
        .tisch.soon .tisch-body {
            background: linear-gradient(145deg, #fef3c7, #fde68a);
            border-color: #f59e0b;
        }
        
        /* Stühle */
        .tisch-chairs {
            position: absolute;
            inset: -16px;
            pointer-events: none;
        }
        
        .tisch-chair {
            position: absolute;
            width: 16px;
            height: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background 0.2s;
        }
        
        .tisch.available .tisch-chair { background: #60a5fa; }
        .tisch.reserved .tisch-chair { background: #f87171; }
        .tisch.billed .tisch-chair { background: #4ade80; }
        .tisch.soon .tisch-chair { background: #fbbf24; }
        
        .tisch-chair.top { top: 0; left: 50%; transform: translateX(-50%); }
        .tisch-chair.bottom { bottom: 0; left: 50%; transform: translateX(-50%); }
        .tisch-chair.left { left: 0; top: 50%; transform: translateY(-50%) rotate(90deg); }
        .tisch-chair.right { right: 0; top: 50%; transform: translateY(-50%) rotate(90deg); }
        
        /* Badge */
        .tisch-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            min-width: 26px;
            height: 26px;
            border-radius: 13px;
            background: white;
            border: 3px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'DM Sans', sans-serif;
            font-size: 11px;
            font-weight: 700;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            padding: 0 4px;
        }
        
        .tisch.reserved .tisch-badge { border-color: #ef4444; color: #ef4444; }
        .tisch.billed .tisch-badge { border-color: #22c55e; color: #22c55e; }
        .tisch.soon .tisch-badge { border-color: #f59e0b; color: #f59e0b; }
        
        /* Info Label */
        .tisch-label {
            margin-top: 8px;
            background: var(--bg-card);
            padding: 5px 12px;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 11px;
            color: var(--slate);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-weight: 600;
            white-space: nowrap;
        }
        
        .tisch-label .amount {
            color: var(--primary);
            font-weight: 700;
        }
        
        /* Stats */
        .tischplan-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        }
        
        .tischplan-stat {
            text-align: center;
            padding: 12px 8px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .tischplan-stat-num {
            font-family: 'DM Sans', sans-serif;
            font-size: 26px;
            font-weight: 700;
        }
        
        .tischplan-stat-label {
            font-family: 'DM Sans', sans-serif;
            font-size: 11px;
            color: var(--slate);
            margin-top: 4px;
        }
        
        /* ===== GOOGLE ÖFFNUNGSZEITEN ===== */
        /* ===== GOOGLE MAPS STYLE ÖFFNUNGSZEITEN ===== */
        .hours-google {
            margin-top: 12px;
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg-secondary);
        }
        
        .hours-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .hours-header:hover {
            background: rgba(0,0,0,0.05);
        }
        
        .dark-mode .hours-header:hover {
            background: rgba(255,255,255,0.05);
        }
        
        /* Dark Mode - Reservierungen & Tischplan */
        
        /* Mini Kalender */
        .mini-calendar { margin-bottom: 8px; }
        .mini-cal-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 10px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 4px;
        }
        .mini-cal-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        .mini-cal-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: #1e293b;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .mini-cal-day:hover { background: #f1f5f9; }
        .mini-cal-day.today { background: #fef3c7; color: #92400e; font-weight: 700; }
        .mini-cal-day.selected { background: var(--primary); color: white; }
        .mini-cal-day.has-reservations::after {
            content: '';
            position: absolute;
            bottom: 2px;
            width: 4px;
            height: 4px;
            background: var(--primary);
            border-radius: 50%;
        }
        .mini-cal-day { position: relative; }
        .mini-cal-day.empty { cursor: default; }
        
        /* Zeitslot Buttons */
        .timeslot-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }
        .time-btn {
            padding: 6px 4px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            color: #1f2937;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .time-btn:hover { border-color: var(--primary); background: #f0fdf4; }
        .time-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Status Badge */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-badge.available { background: #dcfce7; color: #16a34a; }
        .status-badge.reserved { background: #fef3c7; color: #d97706; }
        .status-badge.occupied { background: #fee2e2; color: #dc2626; }
        
        /* ===== KIN DESIGN AKTIONS-BUTTONS ===== */
        .kin-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .kin-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .kin-action-btn:active {
            transform: translateY(0);
        }
        .kin-action-btn svg {
            flex-shrink: 0;
        }
        
        .kin-action-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .kin-action-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }
        
        .kin-action-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        .kin-action-warning:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
        }
        
        .kin-action-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .kin-action-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        /* ===== KIN DESIGN ZEIT-BUTTONS ===== */
        .kin-time-btn {
            padding: 10px 12px;
            font-size: 12px;
            font-weight: 600;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .kin-time-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }
        .kin-time-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .dark-mode .kin-time-btn {
            background: var(--bg-card);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        .dark-mode .kin-time-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }
        .dark-mode .kin-time-btn.active {
            background: var(--primary);
            color: white;
        }
        
        /* Dark Mode für neue Elemente */
        .dark-mode .mini-cal-day { color: var(--text-primary); }
        .dark-mode .mini-cal-day:hover { background: var(--bg-card); }
        .dark-mode .mini-cal-day.today { background: var(--bg-card); }
        .dark-mode .time-btn {
            background: var(--bg-card);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        .dark-mode .time-btn:hover { border-color: var(--primary); }
        .dark-mode .time-btn.active {
            background: var(--primary);
            color: white;
        }
        .dark-mode #fpTableDetails input,
        .dark-mode #fpTableDetails select {
            background: var(--bg-card);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .dark-mode .res-tab-btn {
            background: var(--bg-card);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .dark-mode .res-tab-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .dark-mode .cal-day {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .dark-mode .cal-day:hover {
            background: var(--bg-card);
        }
        
        .dark-mode .cal-day.today {
            background: var(--bg-card);
            border-color: var(--primary);
        }
        
        .dark-mode .cal-day.selected {
            background: var(--primary);
            color: white;
        }
        
        .dark-mode .cal-header {
            color: var(--text-secondary);
        }
        
        .dark-mode .cal-nav-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .dark-mode .cal-nav-btn:hover {
            background: var(--bg-card);
        }
        
        .dark-mode .timeslot {
            background: var(--bg-secondary);
            border-left-color: var(--border-color);
        }
        
        .dark-mode .timeslot.has-reservation {
            background: rgba(26, 95, 74, 0.2);
            border-left-color: var(--primary);
        }
        
        .dark-mode .timeslot-time {
            color: var(--text-primary);
        }
        
        .dark-mode .timeslot-name {
            color: var(--text-primary);
        }
        
        .dark-mode .timeslot-details {
            color: var(--text-secondary);
        }
        
        .dark-mode .floorplan-container {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
        }
        
        .dark-mode .floorplan-grid {
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
        }
        
        .dark-mode .fp-table {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
        
        .dark-mode .fp-table .table-number {
            color: var(--text-primary);
        }
        
        .dark-mode .fp-table .table-seats {
            color: var(--text-secondary);
        }
        
        .dark-mode .fp-entrance {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.2) 0%, rgba(14, 165, 233, 0.3) 100%);
            color: var(--text-primary);
        }
        
        .dark-mode .fp-kitchen {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(251, 191, 36, 0.3) 100%);
            color: var(--text-primary);
        }
        
        .dark-mode .floorplan-legend {
            background: var(--bg-card);
        }
        
        .dark-mode .legend-item {
            color: var(--text-primary);
        }
        
        .dark-mode .palette-item {
            background: var(--bg-secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .dark-mode .palette-item:hover {
            background: var(--bg-card);
            border-color: var(--primary);
        }
        
        .dark-mode .palette-item span {
            color: var(--text-secondary);
        }
        
        .dark-mode .palette-preview.table-round,
        .dark-mode .palette-preview.table-round-lg,
        .dark-mode .palette-preview.table-square,
        .dark-mode .palette-preview.table-rect,
        .dark-mode .palette-preview.table-long {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
        
        .dark-mode .table-detail-card {
            background: var(--bg-secondary);
        }
        
        .dark-mode .table-detail-number {
            color: var(--text-primary);
        }
        
        .dark-mode .detail-row {
            color: var(--text-primary);
            border-bottom-color: var(--border-color);
        }
        
        .dark-mode .reservation-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }
        
        .dark-mode .reservation-table td {
            color: var(--text-primary);
            border-bottom-color: var(--border-color);
        }
        
        .dark-mode .reservation-table tbody tr:hover {
            background: var(--bg-secondary);
        }
        
        .dark-mode .fp-divider .divider-line {
            background: linear-gradient(90deg, var(--border-color) 0%, var(--text-secondary) 50%, var(--border-color) 100%);
        }
        
        .dark-mode .fp-element {
            color: var(--text-primary);
        }
        
        .hours-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .hours-icon svg {
            width: 20px;
            height: 20px;
            stroke: var(--slate);
        }
        
        .hours-status {
            flex: 1;
            font-family: 'DM Sans', sans-serif;
        }
        
        .hours-main {
            font-size: 15px;
            font-weight: 600;
        }
        
        .hours-main.open {
            color: #34a853;
        }
        
        .hours-main.closed {
            color: #ea4335;
        }
        
        .hours-sub {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 400;
        }
        
        .hours-arrow {
            color: var(--slate);
            transition: transform 0.3s ease;
            font-size: 14px;
        }
        
        .hours-arrow.expanded {
            transform: rotate(180deg);
        }
        
        .hours-dropdown {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .hours-dropdown.expanded {
            max-height: 400px;
        }
        
        .hours-list {
            padding: 0 16px 16px;
        }
        
        .hours-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            border-bottom: 1px solid var(--border-color);
        }
        
        .hours-row:last-child {
            border-bottom: none;
        }
        
        .hours-row.today {
            font-weight: 700;
            color: var(--primary);
            background: rgba(26, 95, 74, 0.08);
            margin: 0 -16px;
            padding: 10px 16px;
            border-radius: 8px;
        }
        
        .hours-day {
            color: var(--text-primary);
        }
        
        .hours-time {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .hours-time.closed-day {
            color: #ea4335;
        }

        /* ==================== ONLINE BESTELLUNG - KIN DESIGN ==================== */
        
        /* Kategorie Tabs */
        .menu-categories {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 12px 20px;
            scrollbar-width: none;
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }
        
        .menu-categories::-webkit-scrollbar {
            display: none;
        }
        
        .menu-category-tab {
            flex: 0 0 auto;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--dark);
            white-space: nowrap;
        }
        
        .menu-category-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .menu-category-tab:hover:not(.active) {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        /* Produkt Cards */
        .menu-item-card {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .menu-item-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .menu-item-card:active {
            transform: scale(0.98);
        }
        
        .menu-item-image {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .menu-item-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        
        .menu-item-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 4px;
        }
        
        .menu-item-description {
            font-size: 13px;
            color: var(--slate);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex: 1;
        }
        
        .menu-item-bottom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
        }
        
        .menu-item-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .menu-item-badges {
            display: flex;
            gap: 6px;
        }
        
        .menu-badge {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: transform 0.2s ease;
        }
        
        .menu-badge:hover {
            transform: scale(1.15);
        }
        
        /* Beliebt */
        .menu-badge.popular {
            background: #fef3c7;
        }
        
        /* Fleischarten */
        .menu-badge.beef {
            background: #fef2f2;
        }
        
        .menu-badge.chicken {
            background: #fff7ed;
        }
        
        .menu-badge.pork {
            background: #fdf2f8;
        }
        
        .menu-badge.lamb {
            background: #f5f3ff;
        }
        
        .menu-badge.fish {
            background: #e0f2fe;
        }
        
        .menu-badge.seafood {
            background: #ecfeff;
        }
        
        /* Vegetarisch & Vegan */
        .menu-badge.vegetarian {
            background: #f0fdf4;
        }
        
        .menu-badge.vegan {
            background: #dcfce7;
        }
        
        /* Allergene */
        .menu-badge.gluten {
            background: #fefce8;
        }
        
        .menu-badge.glutenfree {
            background: #f7fee7;
        }
        
        .menu-badge.lactosefree {
            background: #f0fdfa;
        }
        
        .menu-badge.nuts {
            background: #fef3c7;
        }
        
        /* Scharf */
        .menu-badge.spicy {
            background: #fee2e2;
        }
        
        /* Halal & Kosher */
        .menu-badge.halal {
            background: #eef2ff;
        }
        
        /* Alkohol */
        .menu-badge.alcohol {
            background: #f5f3ff;
        }
        
        /* Bio */
        .menu-badge.bio {
            background: #f0fdf4;
        }
        
        /* Hausgemacht */
        .menu-badge.homemade {
            background: #fffbeb;
        }
        
        /* Warenkorb Button (Fixed Bottom) */
        .cart-button-fixed {
            position: fixed;
            bottom: 90px;
            left: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 16px 24px;
            border-radius: 16px;
            display: none; /* Standardmäßig versteckt */
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(26, 95, 74, 0.4);
            z-index: 999;
            transition: all 0.3s;
            transform: translateY(0);
            opacity: 0;
            pointer-events: none;
        }
        
        .cart-button-fixed.visible {
            display: flex;
            opacity: 1;
            pointer-events: auto;
            animation: slideUpCart 0.3s ease-out;
        }
        
        @keyframes slideUpCart {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .cart-button-fixed:active {
            transform: scale(0.98);
        }
        
        .cart-button-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .cart-count-badge {
            background: white;
            color: var(--primary);
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }
        
        .cart-button-text {
            font-size: 16px;
            font-weight: 600;
        }
        
        .cart-button-price {
            font-size: 16px;
            font-weight: 700;
        }
        
        /* Options Modal */
        .option-group {
            margin-bottom: 24px;
        }
        
        .option-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .option-group-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .option-group-required {
            font-size: 12px;
            font-weight: 500;
            padding: 4px 10px;
            background: #fef3c7;
            color: #d97706;
            border-radius: 12px;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .option-item:hover {
            background: var(--cream);
        }
        
        .option-item.selected {
            border-color: var(--primary);
            background: var(--cream);
        }
        
        .option-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .option-radio {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .option-item.selected .option-checkbox,
        .option-item.selected .option-radio {
            border-color: var(--primary);
            background: var(--primary);
        }
        
        .option-item.selected .option-checkbox svg,
        .option-item.selected .option-radio svg {
            opacity: 1;
        }
        
        .option-checkbox svg,
        .option-radio svg {
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .option-info {
            flex: 1;
        }
        
        .option-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .option-price {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
        }
        
        /* Quantity Selector */
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 12px;
        }
        
        .qty-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 10px;
            background: var(--bg-card);
            color: var(--dark);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
        }
        
        .qty-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .qty-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .qty-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            min-width: 40px;
            text-align: center;
        }
        
        /* Cart Slide Panel */
        .cart-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
            z-index: 10002;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        
        .cart-panel.open {
            transform: translateY(0);
        }
        
        .cart-panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .cart-panel-title {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .cart-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }
        
        .cart-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .cart-item-qty {
            width: 28px;
            height: 28px;
            background: var(--cream);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--primary);
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .cart-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .cart-item-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .cart-item-options {
            font-size: 12px;
            color: var(--slate);
            margin-top: 2px;
        }
        
        .cart-item-price {
            font-size: 15px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .cart-item-edit {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--slate);
        }
        
        .cart-panel-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-card);
        }
        
        .cart-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--slate);
        }
        
        .cart-summary-total {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .checkout-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .checkout-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 95, 74, 0.3);
        }
        
        /* Checkout Form */
        .checkout-section {
            margin-bottom: 24px;
        }
        
        .checkout-section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .order-type-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .order-type-btn {
            flex: 1;
            padding: 14px 10px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-card);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        
        .order-type-btn:hover {
            border-color: var(--slate);
            transform: translateY(-2px);
        }
        
        .order-type-btn.active {
            border-color: var(--primary);
            background: var(--cream);
        }
        
        .order-type-btn svg {
            width: 24px;
            height: 24px;
            color: var(--slate);
        }
        
        .order-type-btn.active svg {
            color: var(--primary);
        }
        
        .order-type-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .order-type-vat {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--slate);
        }
        
        .order-type-btn.active .order-type-vat {
            background: var(--primary);
            color: white;
        }
        
        .order-type-btn[data-type="dine_in"] .order-type-vat {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .order-type-btn[data-type="dine_in"].active .order-type-vat {
            background: #dc2626;
            color: white;
        }
        
        /* Order Status Tracker */
        .order-status-tracker {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-top: 20px;
        }
        
        .status-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
            position: relative;
        }
        
        .status-step::after {
            content: '';
            position: absolute;
            top: 18px;
            left: 60%;
            width: 80%;
            height: 2px;
            background: var(--border-color);
        }
        
        .status-step:last-child::after {
            display: none;
        }
        
        .status-step.completed::after {
            background: var(--primary);
        }
        
        .status-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        
        .status-step.active .status-icon {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .status-step.completed .status-icon {
            border-color: var(--primary);
            background: var(--cream);
            color: var(--primary);
        }
        
        .status-label {
            font-size: 11px;
            color: var(--slate);
            text-align: center;
        }
        
        .status-step.active .status-label {
            color: var(--primary);
            font-weight: 600;
        }

        /* ==================== ORDERS DASHBOARD ==================== */
        
        .order-status-tab {
            padding: 10px 18px;
            border-radius: 25px;
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .order-status-tab:hover {
            border-color: var(--primary);
        }
        
        .order-status-tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .order-status-tab .tab-count {
            background: var(--bg-secondary);
            color: var(--dark);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .order-status-tab.active .tab-count {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .order-card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 2px solid var(--border-color);
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .order-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        
        .order-card.status-received {
            border-color: #f59e0b;
            animation: orderPulse 2s infinite;
        }
        
        @keyframes orderPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
        }
        
        .order-card.status-accepted { border-color: #3b82f6; }
        .order-card.status-preparing { border-color: #8b5cf6; }
        .order-card.status-ready { border-color: #10b981; }
        .order-card.status-out_for_delivery { border-color: #06b6d4; }
        
        .order-card-header {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
        }
        
        .order-number {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .order-time {
            font-size: 12px;
            color: var(--slate);
        }
        
        .order-status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .order-status-badge.received { background: #fef3c7; color: #d97706; }
        .order-status-badge.accepted { background: #dbeafe; color: #2563eb; }
        .order-status-badge.preparing { background: #ede9fe; color: #7c3aed; }
        .order-status-badge.ready { background: #d1fae5; color: #059669; }
        .order-status-badge.out_for_delivery { background: #cffafe; color: #0891b2; }
        .order-status-badge.delivered { background: #d1fae5; color: #059669; }
        .order-status-badge.cancelled { background: #fee2e2; color: #dc2626; }
        
        .order-card-body {
            padding: 16px;
        }
        
        .order-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .order-type-badge.delivery {
            background: var(--cream);
            color: var(--primary);
        }
        
        .order-type-badge.pickup {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .order-customer {
            margin-bottom: 12px;
        }
        
        .order-customer-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .order-customer-phone {
            font-size: 13px;
            color: var(--slate);
        }
        
        .order-customer-address {
            font-size: 13px;
            color: var(--slate);
            margin-top: 4px;
        }
        
        .order-items-list {
            border-top: 1px solid var(--border-color);
            padding-top: 12px;
            margin-top: 12px;
        }
        
        .order-item-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .order-item-row:last-child {
            border-bottom: none;
        }
        
        .order-item-qty {
            min-width: 24px;
            height: 24px;
            background: var(--bg-secondary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .order-item-name {
            flex: 1;
            font-size: 14px;
            color: var(--dark);
        }
        
        .order-item-extras {
            font-size: 12px;
            color: var(--slate);
        }
        
        .order-item-price {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .order-card-footer {
            padding: 16px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }
        
        .order-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .order-total-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .order-total-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .order-actions {
            display: flex;
            gap: 8px;
        }
        
        .order-action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .order-action-btn.accept {
            background: #10b981;
            color: white;
        }
        
        .order-action-btn.accept:hover {
            background: #059669;
        }
        
        .order-action-btn.reject {
            background: var(--bg-card);
            color: #ef4444;
            border: 2px solid #fecaca;
        }
        
        .order-action-btn.reject:hover {
            background: #fee2e2;
        }
        
        .order-action-btn.next {
            background: var(--primary);
            color: white;
        }
        
        .order-action-btn.next:hover {
            opacity: 0.9;
        }
        
        .order-action-btn.print {
            background: var(--bg-card);
            color: var(--dark);
            border: 2px solid var(--border-color);
        }

        /* ==================== TISCHPLAN EDITOR ==================== */
        
        .tp-tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
            color: var(--slate);
            font-weight: 500;
        }
        
        .tp-tool-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--cream);
        }
        
        .tp-tool-btn svg {
            color: var(--dark);
        }
        
        .tp-tool-btn:hover svg {
            color: var(--primary);
        }
        
        .floorplan-table {
            position: absolute;
            cursor: move;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: box-shadow 0.2s, transform 0.1s;
            user-select: none;
            z-index: 10;
        }
        
        .floorplan-table:hover {
            z-index: 20;
            transform: scale(1.05);
        }
        
        .floorplan-table.dragging {
            opacity: 0.8;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .floorplan-table.selected {
            box-shadow: 0 0 0 3px #3b82f6;
        }
        
        .floorplan-table.round {
            border-radius: 50%;
        }
        
        .floorplan-table.rect {
            border-radius: 8px;
        }
        
        .floorplan-table .table-number {
            font-size: 14px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .floorplan-table .table-seats {
            font-size: 10px;
            color: rgba(255,255,255,0.8);
        }
        
        .floorplan-table.status-free {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .floorplan-table.status-reserved {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .floorplan-table.status-occupied {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .floorplan-chair {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--bg-card);
            border: 2px solid currentColor;
            border-radius: 50%;
        }
        
        .table-context-menu {
            position: absolute;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 8px;
            z-index: 1000;
            min-width: 160px;
        }
        
        .table-context-menu button {
            width: 100%;
            padding: 10px 12px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            border-radius: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--dark);
        }
        
        .table-context-menu button:hover {
            background: var(--bg-secondary);
        }
        
        .table-context-menu button.delete {
            color: #ef4444;
        }
        
        .table-context-menu button.delete:hover {
            background: #fee2e2;
        }
        
        /* ==================== KIN FILTER TABS ==================== */
        
        .kin-filter-tab {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 25px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--slate);
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .kin-filter-tab:hover {
            border-color: var(--primary);
            color: var(--dark);
        }
        
        .kin-filter-tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .kin-filter-tab.active svg {
            stroke: white;
        }
        
        .kin-filter-count {
            background: var(--bg-secondary);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: var(--slate);
        }
        
        .kin-filter-tab.active .kin-filter-count {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .kin-filter-count.new {
            background: #fef3c7;
            color: #d97706;
        }
        
        .kin-filter-tab.active .kin-filter-count.new {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        /* ==================== ORDER CARDS KIN DESIGN ==================== */
        
        .kin-order-card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .kin-order-card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .kin-order-card.status-received {
            border-color: #f59e0b;
            animation: orderPulse 2s infinite;
        }
        
        .kin-order-card.status-accepted {
            border-color: #3b82f6;
        }
        
        .kin-order-card.status-preparing {
            border-color: #8b5cf6;
        }
        
        .kin-order-card.status-ready {
            border-color: #10b981;
        }
        
        .kin-order-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .kin-order-number {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .kin-order-time {
            font-size: 12px;
            color: var(--slate);
        }
        
        .kin-order-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .kin-order-status.received { background: #fef3c7; color: #d97706; }
        .kin-order-status.accepted { background: #dbeafe; color: #2563eb; }
        .kin-order-status.preparing { background: #ede9fe; color: #7c3aed; }
        .kin-order-status.ready { background: #d1fae5; color: #059669; }
        .kin-order-status.out_for_delivery { background: #cffafe; color: #0891b2; }
        
        .kin-order-body {
            padding: 16px;
        }
        
        .kin-order-type {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            color: var(--dark);
            margin-bottom: 12px;
        }
        
        .kin-order-customer {
            margin-bottom: 16px;
        }
        
        .kin-order-customer-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }
        
        .kin-order-customer-info {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--slate);
            margin-top: 4px;
        }
        
        .kin-order-customer-info a {
            color: var(--primary);
            text-decoration: none;
        }
        
        .kin-order-address {
            font-size: 13px;
            color: var(--slate);
            margin-top: 6px;
            padding-left: 20px;
        }
        
        .kin-order-items {
            border-top: 1px dashed var(--border-color);
            padding-top: 12px;
            margin-top: 12px;
        }
        
        .kin-order-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 8px 0;
        }
        
        .kin-order-item-left {
            display: flex;
            gap: 10px;
        }
        
        .kin-order-item-qty {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .kin-order-item-name {
            font-size: 14px;
            color: var(--dark);
            font-weight: 500;
        }
        
        .kin-order-item-options {
            font-size: 12px;
            color: var(--slate);
            margin-top: 2px;
        }
        
        .kin-order-item-price {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .kin-order-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }
        
        .kin-order-total {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .kin-order-payment {
            font-size: 12px;
            color: var(--slate);
        }
        
        .kin-order-actions {
            display: flex;
            gap: 8px;
        }
        
        .kin-order-btn {
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            border: none;
            transition: all 0.2s;
        }
        
        .kin-order-btn.accept {
            background: #10b981;
            color: white;
        }
        
        .kin-order-btn.accept:hover {
            background: #059669;
        }
        
        .kin-order-btn.reject {
            background: #fee2e2;
            color: #ef4444;
        }
        
        .kin-order-btn.reject:hover {
            background: #fecaca;
        }
        
        .kin-order-btn.next {
            background: var(--primary);
            color: white;
        }
        
        .kin-order-btn.next:hover {
            opacity: 0.9;
        }
        
        .kin-order-btn.secondary {
            background: var(--bg-card);
            color: var(--dark);
            border: 1px solid var(--border-color);
        }
        
        .kin-order-btn.secondary:hover {
            background: var(--bg-secondary);
        }
        
        /* ==================== TIME OPTION BUTTONS ==================== */
        
        .time-option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 14px 8px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .time-option-btn:hover {
            border-color: var(--primary);
            background: var(--cream);
        }
        
        .time-option-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
        }
        
        .time-option-btn .time-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
        }
        
        .time-option-btn.selected .time-value {
            color: white;
        }
        
        .time-option-btn .time-unit {
            font-size: 11px;
            color: var(--slate);
            margin-top: 2px;
        }
        
        .time-option-btn.selected .time-unit {
            color: rgba(255,255,255,0.8);
        }
        
        /* ==================== ORDER PROGRESS (Kunden Profil) ==================== */
        
        .order-status-pill {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: #fef3c7;
            color: #d97706;
        }
        
        .order-status-pill.accepted {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .order-status-pill.preparing {
            background: #ede9fe;
            color: #7c3aed;
        }
        
        .order-status-pill.ready {
            background: #d1fae5;
            color: #059669;
        }
        
        .order-status-pill.out_for_delivery {
            background: #cffafe;
            color: #0891b2;
        }
        
        .order-progress-steps {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 16px;
        }
        
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            flex: 0 0 auto;
        }
        
        .progress-step .step-icon {
            width: 32px;
            height: 32px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--slate);
            transition: all 0.3s;
        }
        
        .progress-step.completed .step-icon,
        .progress-step.active .step-icon {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .progress-step.active .step-icon {
            animation: pulseStep 2s infinite;
        }
        
        @keyframes pulseStep {
            0%, 100% { box-shadow: 0 0 0 0 rgba(26, 95, 74, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(26, 95, 74, 0); }
        }
        
        .progress-step .step-label {
            font-size: 10px;
            color: var(--slate);
            text-align: center;
            max-width: 60px;
        }
        
        .progress-step.completed .step-label,
        .progress-step.active .step-label {
            color: var(--primary);
            font-weight: 600;
        }
        
        .progress-line {
            flex: 1;
            height: 2px;
            background: var(--border-color);
            margin: 0 4px;
            margin-bottom: 22px;
            transition: background 0.3s;
        }
        
        .progress-line.completed {
            background: var(--primary);
        }
        
        /* ==================== SPEISEKARTE EDITOR ==================== */
        
        .category-icon-btn {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-card);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--slate);
        }
        
        .category-icon-btn:hover {
            border-color: var(--primary);
            background: var(--cream);
            color: var(--primary);
        }
        
        .category-icon-btn.selected {
            border-color: var(--primary);
            background: var(--cream);
            color: var(--primary);
        }
        
        /* Icon Grid für Kategorien */
        .category-icon-grid {
            max-height: 350px;
            overflow-y: auto;
            padding-right: 8px;
        }
        
        .category-icon-grid::-webkit-scrollbar {
            width: 6px;
        }
        
        .category-icon-grid::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }
        
        .category-icon-grid::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }
        
        .icon-section {
            margin-bottom: 16px;
        }
        
        .icon-section-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--slate);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            padding-left: 4px;
        }
        
        .icon-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        /* Menü Scanner Upload */
        .menu-scan-upload {
            border: 2px dashed var(--border-color);
            border-radius: 16px;
            padding: 30px 20px;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
        }
        
        .menu-scan-upload:hover {
            border-color: var(--primary);
            background: var(--cream);
        }
        
        .menu-scan-upload.dragover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            transform: scale(1.02);
        }
        
        .upload-icon-container {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            color: white;
        }
        
        .upload-format-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 20px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
        }
        
        .upload-format-btn:hover {
            border-color: var(--primary);
            background: var(--cream);
            transform: translateY(-2px);
        }
        
        .upload-format-btn span {
            font-size: 12px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .upload-format-btn svg {
            color: var(--primary);
        }
        
        .upload-format-btn.pdf svg {
            color: #ef4444;
        }
        
        .upload-format-btn.pdf:hover {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .upload-format-btn.camera svg {
            color: #8b5cf6;
        }
        
        .upload-format-btn.camera:hover {
            border-color: #8b5cf6;
            background: #f5f3ff;
        }
        
        /* Property Toggle Buttons - KIN Design */
        .property-toggle-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
        }
        
        .property-toggle-btn:hover {
            border-color: var(--slate);
            transform: translateY(-2px);
        }
        
        .property-toggle-btn.active {
            border-color: var(--primary);
            background: var(--cream);
        }
        
        .property-toggle-btn span {
            font-size: 12px;
            font-weight: 500;
            color: var(--slate);
        }
        
        .property-toggle-btn.active span {
            color: var(--primary);
            font-weight: 600;
        }
        
        .property-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .property-icon.popular {
            background: #fef3c7;
            color: #d97706;
        }
        
        .property-toggle-btn.active .property-icon.popular {
            background: #f59e0b;
            color: white;
        }
        
        .property-icon.vegan {
            background: #d1fae5;
            color: #059669;
        }
        
        .property-toggle-btn.active .property-icon.vegan {
            background: #10b981;
            color: white;
        }
        
        .property-icon.vegetarian {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .property-toggle-btn.active .property-icon.vegetarian {
            background: #22c55e;
            color: white;
        }
        
        .property-icon.spicy {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .property-toggle-btn.active .property-icon.spicy {
            background: #ef4444;
            color: white;
        }
        
        .property-icon.glutenfree {
            background: #fef9c3;
            color: #ca8a04;
        }
        
        .property-toggle-btn.active .property-icon.glutenfree {
            background: #eab308;
            color: white;
        }
        
        .property-icon.halal {
            background: #e0e7ff;
            color: #4f46e5;
        }
        
        .property-toggle-btn.active .property-icon.halal {
            background: #6366f1;
            color: white;
        }
        
        /* Fleischarten */
        .property-icon.beef {
            background: #fef2f2;
            color: #b91c1c;
        }
        
        .property-toggle-btn.active .property-icon.beef {
            background: #dc2626;
            color: white;
        }
        
        .property-icon.chicken {
            background: #fff7ed;
            color: #ea580c;
        }
        
        .property-toggle-btn.active .property-icon.chicken {
            background: #f97316;
            color: white;
        }
        
        .property-icon.pork {
            background: #fdf2f8;
            color: #db2777;
        }
        
        .property-toggle-btn.active .property-icon.pork {
            background: #ec4899;
            color: white;
        }
        
        .property-icon.lamb {
            background: #f5f3ff;
            color: #7c3aed;
        }
        
        .property-toggle-btn.active .property-icon.lamb {
            background: #8b5cf6;
            color: white;
        }
        
        .property-icon.fish {
            background: #e0f2fe;
            color: #0284c7;
        }
        
        .property-toggle-btn.active .property-icon.fish {
            background: #0ea5e9;
            color: white;
        }
        
        .property-icon.seafood {
            background: #ecfeff;
            color: #0891b2;
        }
        
        .property-toggle-btn.active .property-icon.seafood {
            background: #06b6d4;
            color: white;
        }
        
        /* Allergene */
        .property-icon.gluten {
            background: #fefce8;
            color: #ca8a04;
        }
        
        .property-toggle-btn.active .property-icon.gluten {
            background: #eab308;
            color: white;
        }
        
        .property-icon.lactosefree {
            background: #f0fdfa;
            color: #0d9488;
        }
        
        .property-toggle-btn.active .property-icon.lactosefree {
            background: #14b8a6;
            color: white;
        }
        
        .property-icon.nuts {
            background: #fef3c7;
            color: #92400e;
        }
        
        .property-toggle-btn.active .property-icon.nuts {
            background: #b45309;
            color: white;
        }
        
        .property-icon.alcohol {
            background: #f5f3ff;
            color: #7c3aed;
        }
        
        .property-toggle-btn.active .property-icon.alcohol {
            background: #8b5cf6;
            color: white;
        }
        
        .property-icon.bio {
            background: #f0fdf4;
            color: #15803d;
        }
        
        .property-toggle-btn.active .property-icon.bio {
            background: #22c55e;
            color: white;
        }
        
        .property-icon.homemade {
            background: #fffbeb;
            color: #b45309;
        }
        
        .property-toggle-btn.active .property-icon.homemade {
            background: #d97706;
            color: white;
        }
        
        .menu-category-card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
            overflow: hidden;
        }
        
        .menu-category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--bg-secondary);
            cursor: pointer;
        }
        
        .menu-category-header:hover {
            background: var(--cream);
        }
        
        .menu-category-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .menu-category-icon {
            width: 32px;
            height: 32px;
            background: var(--cream);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }
        
        .menu-category-count {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .menu-category-actions {
            display: flex;
            gap: 8px;
        }
        
        .menu-category-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: var(--bg-card);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--slate);
            transition: all 0.2s;
        }
        
        .menu-category-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .menu-category-btn.delete:hover {
            background: #ef4444;
        }
        
        .menu-category-items {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .menu-category-card.open .menu-category-items {
            max-height: 2000px;
            padding: 16px;
        }
        
        .menu-item-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 8px;
        }
        
        .menu-item-row:last-child {
            margin-bottom: 0;
        }
        
        .menu-item-image {
            width: 56px;
            height: 56px;
            border-radius: 10px;
            object-fit: cover;
            background: var(--border-color);
        }
        
        .menu-item-info {
            flex: 1;
        }
        
        .menu-item-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .menu-item-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }
        
        .menu-item-badge svg {
            flex-shrink: 0;
        }
        
        .menu-item-badge.popular {
            background: #fef3c7;
            color: #d97706;
        }
        
        .menu-item-badge.vegan {
            background: #d1fae5;
            color: #059669;
        }
        
        .menu-item-badge.spicy {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .menu-item-badge.inactive {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .menu-item-desc {
            font-size: 13px;
            color: var(--slate);
            margin-top: 2px;
        }
        
        .menu-item-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            white-space: nowrap;
        }
        
        .menu-item-actions {
            display: flex;
            gap: 6px;
        }
        
        .menu-item-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: var(--bg-card);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--slate);
        }
        
        .menu-item-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .menu-item-btn.delete:hover {
            background: #ef4444;
        }
        
        .menu-scan-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }
        
        .menu-scan-item:hover {
            background: var(--cream);
        }
        
        .menu-scan-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-top: 2px;
        }
        
        .menu-scan-item-info {
            flex: 1;
        }
        
        .menu-scan-item-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 2px;
        }
        
        .menu-scan-item-price {
            font-size: 15px;
            color: var(--primary);
            font-weight: 700;
            white-space: nowrap;
        }
        
        /* Scan Badges */
        .scan-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            font-size: 12px;
            border-radius: 4px;
            background: var(--bg-card);
        }
        
        .scan-badge.vegetarian { background: #dcfce7; }
        .scan-badge.vegan { background: #d1fae5; }
        .scan-badge.spicy { background: #fee2e2; }
        .scan-badge.beef { background: #fef2f2; }
        .scan-badge.chicken { background: #fff7ed; }
        .scan-badge.pork { background: #fdf2f8; }
        .scan-badge.fish { background: #e0f2fe; }
        .scan-badge.seafood { background: #ecfeff; }
        .scan-badge.gluten { background: #fefce8; }
        
        /* ==================== RESERVIERUNG & TISCHPLAN ==================== */
        
        /* Tab Navigation */
        .res-tab-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .res-tab-btn:hover {
            border-color: var(--slate);
        }
        
        .res-tab-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .res-tab-btn.active svg {
            stroke: white;
        }
        
        .res-tab-content {
            display: none;
        }
        
        .res-tab-content.active {
            display: block;
        }
        
        /* Kalender */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }
        
        .cal-header {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--slate);
            padding: 8px 0;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        
        .cal-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            background: var(--bg-secondary);
            transition: all 0.2s;
            position: relative;
        }
        
        .cal-day:hover {
            background: var(--cream);
        }
        
        .cal-day.other-month {
            color: var(--slate);
            opacity: 0.5;
        }
        
        .cal-day.today {
            background: var(--cream);
            border: 2px solid var(--primary);
        }
        
        .cal-day.selected {
            background: var(--primary);
            color: white;
        }
        
        .cal-day.has-reservations::after {
            content: '';
            position: absolute;
            bottom: 6px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);
        }
        
        .cal-day.selected.has-reservations::after {
            background: white;
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.5);
        }
        
        .cal-nav-btn {
            background: var(--bg-secondary);
            border: none;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cal-nav-btn:hover {
            background: var(--cream);
        }
        
        /* Timeslot Grid */
        .timeslot-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .timeslot {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 10px;
            border-left: 4px solid #e2e8f0;
        }
        
        .timeslot.has-reservation {
            border-left-color: var(--primary);
            background: #f0fdf4;
        }
        
        .timeslot-time {
            font-size: 14px;
            font-weight: 700;
            color: #0f172a;
            min-width: 50px;
        }
        
        .timeslot-info {
            flex: 1;
        }
        
        .timeslot-name {
            font-weight: 700;
            color: #1e293b;
        }
        
        .timeslot-details {
            font-size: 12px;
            color: #475569;
            font-weight: 500;
        }
        
        .timeslot-empty {
            color: #64748b;
            font-style: italic;
        }
        
        /* Tischplan / Floorplan */
        .floorplan-container {
            position: relative;
            width: 100%;
            height: 500px;
            background: linear-gradient(135deg, #faf9f7 0%, #f5f3ef 100%);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .floorplan-grid {
            position: relative;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        
        .fp-element {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 14px;
            font-size: 12px;
            font-weight: 700;
            color: #1a1a1a;
            cursor: move;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        
        .fp-entrance {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #3b82f6;
            color: #1e3a5f;
        }
        
        .fp-kitchen {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            color: #713f12;
        }
        
        .fp-plant {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 2px solid #22c55e;
            font-size: 20px;
            padding: 8px;
            border-radius: 50%;
        }
        
        .fp-divider {
            flex-direction: row;
            gap: 8px;
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            border: 2px solid #6b7280;
            padding: 6px 16px;
            color: #374151;
        }
        
        .divider-line {
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, #9ca3af 0%, #6b7280 50%, #9ca3af 100%);
            border-radius: 3px;
        }
        
        /* Tische - VERBESSERTE LESBARKEIT */
        .fp-table {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 4px solid;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .fp-table:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        .fp-table.selected {
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 6px rgba(26, 95, 74, 0.3);
            transform: scale(1.05);
        }
        
        .fp-table.available {
            border-color: #22c55e;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }
        
        .fp-table.reserved {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }
        
        .fp-table.occupied {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }
        
        .fp-table-round {
            width: 60px;
            height: 60px;
            border-radius: 50%;
        }
        
        .fp-table-square {
            width: 70px;
            height: 70px;
            border-radius: 12px;
        }
        
        .fp-table-rect {
            width: 100px;
            height: 60px;
            border-radius: 12px;
        }
        
        .fp-table-long {
            width: 140px;
            height: 60px;
            border-radius: 12px;
        }
        
        .table-number {
            font-size: 18px;
            font-weight: 800;
            color: #1a1a1a;
            line-height: 1;
        }
        
        .table-seats {
            font-size: 11px;
            font-weight: 700;
            color: #374151;
            background: rgba(0,0,0,0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        /* Legende */
        .floorplan-legend {
            position: absolute;
            bottom: 12px;
            left: 12px;
            display: flex;
            gap: 16px;
            background: white;
            padding: 10px 18px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.12);
            font-size: 12px;
            font-weight: 600;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--dark);
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .legend-dot.available { background: #22c55e; }
        .legend-dot.reserved { background: #f59e0b; }
        .legend-dot.occupied { background: #ef4444; }
        
        /* Element Palette */
        .element-palette-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .palette-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 8px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: grab;
            transition: all 0.2s;
        }
        
        .palette-item:hover {
            border-color: var(--primary);
            background: var(--cream);
        }
        
        .palette-item:active {
            cursor: grabbing;
        }
        
        .palette-item span {
            font-size: 11px;
            color: var(--slate);
        }
        
        .palette-preview {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .palette-preview.table-round {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--border-color);
        }
        
        .palette-preview.table-round-lg {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--border-color);
        }
        
        .palette-preview.table-square {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: white;
            border: 3px solid var(--border-color);
        }
        
        .palette-preview.table-rect {
            width: 44px;
            height: 28px;
            border-radius: 6px;
            background: white;
            border: 3px solid var(--border-color);
        }
        
        .palette-preview.table-long {
            width: 50px;
            height: 24px;
            border-radius: 6px;
            background: white;
            border: 3px solid var(--border-color);
        }
        
        .palette-preview.divider {
            width: 40px;
            height: 8px;
            background: #a3a3a3;
            border-radius: 4px;
        }
        
        .palette-preview.bar {
            width: 44px;
            height: 16px;
            background: linear-gradient(135deg, #92400e 0%, #78350f 100%);
            border-radius: 4px;
        }
        
        /* Tisch Details */
        .table-detail-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
        }
        
        .table-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .table-detail-number {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .table-detail-status {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 6px;
        }
        
        .table-detail-status.available {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .table-detail-status.reserved {
            background: #fef3c7;
            color: #d97706;
        }
        
        .table-detail-status.occupied {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .table-detail-info {
            margin-bottom: 16px;
        }
        
        .detail-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            color: var(--dark);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .table-detail-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Reservierung Tabelle */
        .reservation-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .reservation-table th,
        .reservation-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .reservation-table th {
            background: var(--bg-secondary);
            font-size: 12px;
            font-weight: 600;
            color: var(--slate);
            text-transform: uppercase;
        }
        
        .reservation-table tbody tr:hover {
            background: var(--cream);
        }
        
        .res-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .res-status.confirmed {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .res-status.pending {
            background: #fef3c7;
            color: #d97706;
        }
        
        .res-status.cancelled {
            background: #fee2e2;
            color: #dc2626;
        }
        
    </style>
</head>
<body>



<!-- View Toggle -->
<div class="view-toggle" style="display: none;">
    <button class="toggle-btn active" onclick="showGuestView()">Gäste-App</button>
    <button class="toggle-btn" onclick="showDashboard()">Gastro-Dashboard</button>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Reservation Modal - Mit Verfügbarkeits-Check -->
<div class="modal-overlay" id="reservationModal">
    <div class="modal" style="max-width: 420px;">
        <div class="modal-header">
            <h2 class="modal-title" data-i18n="reserveNow">Tisch reservieren</h2>
            <button class="modal-close" onclick="closeModal('reservationModal')">×</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 20px; color: var(--slate);" id="reservationRestaurantName"></p>
            <form id="reservationForm" onsubmit="submitReservation(event)">
                <input type="hidden" id="reservationRestaurantId">
                
                <!-- Step 1: Datum & Personen -->
                <div id="reservationStep1">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="date">Datum</label>
                            <input type="date" class="form-input" id="reservationDate" required onchange="loadAvailableSlots()">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="guests">Personen</label>
                            <select class="form-select" id="partySize" required onchange="loadAvailableSlots()">
                                <option value="1">1 Person</option>
                                <option value="2" selected>2 Personen</option>
                                <option value="3">3 Personen</option>
                                <option value="4">4 Personen</option>
                                <option value="5">5 Personen</option>
                                <option value="6">6 Personen</option>
                                <option value="7">7 Personen</option>
                                <option value="8">8+ Personen</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Verfügbare Zeiten -->
                    <div class="form-group">
                        <label class="form-label">Verfügbare Zeiten</label>
                        <div id="availableSlotsContainer" style="min-height: 60px;">
                            <p style="color: var(--slate); font-size: 14px;">Wähle Datum & Personenzahl</p>
                        </div>
                    </div>
                    
                    <!-- Ausgewählte Zeit -->
                    <input type="hidden" id="reservationTime" required>
                    <div id="selectedSlotDisplay" style="display: none; background: rgba(26,79,99,0.1); padding: 12px 16px; border-radius: 12px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-weight: 600; color: var(--dark);" id="selectedTimeText"></span>
                                <span style="color: var(--slate); font-size: 13px; margin-left: 8px;" id="selectedTableText"></span>
                            </div>
                            <button type="button" onclick="clearSelectedSlot()" style="background: none; border: none; color: var(--slate); cursor: pointer; padding: 4px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Kontaktdaten (erscheint nach Slot-Auswahl) -->
                <div id="reservationStep2" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" data-i18n="name">Name</label>
                        <input type="text" class="form-input" id="guestName" required placeholder="Max Mustermann">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefon</label>
                        <input type="tel" class="form-input" id="guestPhone" required placeholder="0123 456789">
                    </div>
                    <div class="form-group">
                        <label class="form-label">E-Mail <span style="font-weight: normal; color: var(--slate);">(optional)</span></label>
                        <input type="email" class="form-input" id="guestEmail" placeholder="email@beispiel.de">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Anlass <span style="font-weight: normal; color: var(--slate);">(optional)</span></label>
                        <select class="form-select" id="reservationOccasion">
                            <option value="">Keiner</option>
                            <option value="birthday">🎂 Geburtstag</option>
                            <option value="anniversary">💑 Jahrestag</option>
                            <option value="business">💼 Geschäftlich</option>
                            <option value="date">❤️ Date</option>
                            <option value="celebration">🎉 Feier</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Anmerkungen <span style="font-weight: normal; color: var(--slate);">(optional)</span></label>
                        <textarea class="form-textarea" id="reservationNotes" placeholder="Allergien, Kinderstuhl, Rollstuhl..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" id="submitReservationBtn" style="width: 100%;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="margin-right: 8px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        Reservierung bestätigen
                    </button>
                </div>
                
                <!-- Warteliste Option -->
                <div id="waitlistOption" style="display: none; margin-top: 16px; padding: 16px; background: rgba(245,158,11,0.1); border-radius: 12px; text-align: center;">
                    <p style="color: var(--dark); margin-bottom: 12px;">Keine Tische verfügbar zu dieser Zeit</p>
                    <button type="button" onclick="showWaitlistForm()" class="btn" style="background: #f59e0b; color: white;">
                        📋 Auf Warteliste setzen
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Profile Modal -->
<div class="modal-overlay" id="profileModal">
    <div class="modal" style="max-width: 420px;">
        <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; background: var(--cream); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </div>
                <h2 class="modal-title" style="font-family: 'Playfair Display', serif; font-size: 18px; margin: 0;">Mein Profil</h2>
            </div>
            <button class="modal-close" onclick="closeModal('profileModal')">×</button>
        </div>
        <div class="modal-body" id="profileContent" style="padding: 0;">
            <!-- Aktive Bestellungen Section -->
            <div id="activeOrdersSection" style="display: none; padding: 20px; background: linear-gradient(135deg, var(--cream) 0%, #fff 100%); border-bottom: 1px solid var(--border-color);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <h3 style="font-size: 16px; font-weight: 600; color: var(--dark); margin: 0; display: flex; align-items: center; gap: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="18" height="18">
                            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                        Aktive Bestellung
                    </h3>
                    <span class="order-status-pill" id="profileOrderStatus">In Bearbeitung</span>
                </div>
                
                <!-- Order Progress -->
                <div id="profileOrderCard" style="background: var(--bg-card); border-radius: 16px; padding: 16px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div>
                            <div style="font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 600; color: var(--dark);" id="profileOrderNumber">#KI-0000</div>
                            <div style="font-size: 13px; color: var(--slate);" id="profileOrderRestaurant">Restaurant</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 13px; color: var(--slate);" id="profileOrderType">Lieferung</div>
                            <div style="font-size: 15px; font-weight: 700; color: var(--dark);" id="profileOrderTotal">0,00 €</div>
                        </div>
                    </div>
                    
                    <!-- Countdown Timer -->
                    <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; text-align: center; margin-bottom: 16px;">
                        <div style="font-size: 12px; color: var(--slate); margin-bottom: 4px;">Geschätzte Wartezeit</div>
                        <div style="font-size: 36px; font-weight: 700; color: var(--primary); font-family: 'Playfair Display', serif;" id="profileCountdown">--:--</div>
                        <div style="font-size: 13px; color: var(--slate); margin-top: 4px;" id="profileReadyTime">Fertig um ca. --:--</div>
                    </div>
                    
                    <!-- Progress Steps -->
                    <div class="order-progress-steps" id="profileProgressSteps">
                        <div class="progress-step completed" data-step="received">
                            <div class="step-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="step-label">Bestellt</div>
                        </div>
                        <div class="progress-line"></div>
                        <div class="progress-step" data-step="accepted">
                            <div class="step-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="step-label">Angenommen</div>
                        </div>
                        <div class="progress-line"></div>
                        <div class="progress-step" data-step="preparing">
                            <div class="step-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83"/>
                                </svg>
                            </div>
                            <div class="step-label">Zubereitung</div>
                        </div>
                        <div class="progress-line"></div>
                        <div class="progress-step" data-step="ready">
                            <div class="step-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                </svg>
                            </div>
                            <div class="step-label" id="profileFinalStep">Fertig</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Profile Menu Items -->
            <div style="padding: 20px;">
                <!-- Nicht eingeloggt Hinweis -->
                <div id="notLoggedInHint" style="text-align: center; padding: 20px 0; display: none;">
                    <div style="width: 64px; height: 64px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="1.5" width="28" height="28">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <p style="font-size: 14px; color: var(--slate); margin-bottom: 16px;">Melde dich an für personalisierte Features</p>
                    <button onclick="closeModal('profileModal'); openModal('loginModal');" style="padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer;">
                        Anmelden
                    </button>
                </div>
                
                <!-- Menu Items -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div onclick="showSection('favorites'); closeModal('profileModal');" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer;">
                        <div style="width: 40px; height: 40px; background: #fee2e2; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="1.5" width="20" height="20">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--dark);">Meine Favoriten</div>
                            <div style="font-size: 12px; color: var(--slate);">Gespeicherte Restaurants</div>
                        </div>
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="2" width="18" height="18">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>
                    
                    <div onclick="showMyOrders(); closeModal('profileModal');" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer;">
                        <div style="width: 40px; height: 40px; background: #dbeafe; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="1.5" width="20" height="20">
                                <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/>
                                <rect x="9" y="3" width="6" height="4" rx="1"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--dark);">Meine Bestellungen</div>
                            <div style="font-size: 12px; color: var(--slate);">Bestellverlauf ansehen</div>
                        </div>
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="2" width="18" height="18">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>
                    
                    <div onclick="openModal('themeModalSimple'); closeModal('profileModal');" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer;">
                        <div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="1.5" width="20" height="20">
                                <circle cx="12" cy="12" r="5"/>
                                <line x1="12" y1="1" x2="12" y2="3"/>
                                <line x1="12" y1="21" x2="12" y2="23"/>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--dark);">Design</div>
                            <div style="font-size: 12px; color: var(--slate);">Dark / Light Mode</div>
                        </div>
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="2" width="18" height="18">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Login Modal -->
<div class="modal-overlay" id="loginModal">
    <div class="modal" style="max-width: 380px;">
        <div class="modal-header">
            <h2 class="modal-title" data-i18n="login">Anmelden</h2>
            <button class="modal-close" onclick="closeModal('loginModal')">×</button>
        </div>
        <div class="modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 20px;" data-i18n="loginToSave">Melde dich an um deine Favoriten zu speichern und Reservierungen zu verwalten.</p>
            
            <!-- Google Login Button -->
            <button onclick="loginWithGoogle()" style="width: 100%; padding: 14px; background: white; border: 2px solid var(--border-color); border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 20px; color: #333;">
                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                <span data-i18n="loginWithGoogle">Mit Google anmelden</span>
            </button>
            
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                <span style="color: var(--text-secondary); font-size: 13px;" data-i18n="orWithEmail">oder mit E-Mail</span>
                <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
            </div>
            
            <!-- Email Login -->
            <form onsubmit="loginWithEmail(event)">
                <div class="form-group">
                    <label class="form-label">E-Mail Adresse</label>
                    <input type="email" class="form-input" id="loginEmail" required placeholder="deine@email.de">
                </div>
                <button type="submit" class="btn btn-primary">Code senden</button>
            </form>
            
            <p style="text-align: center; margin-top: 16px; font-size: 12px; color: var(--text-secondary);">
                Mit der Anmeldung akzeptierst du unsere <a href="#" style="color: var(--primary);">Datenschutzrichtlinie</a>
            </p>
        </div>
    </div>
</div>

<!-- Email Code Modal -->
<div class="modal-overlay" id="emailCodeModal">
    <div class="modal" style="max-width: 380px;">
        <div class="modal-header">
            <h2 class="modal-title">Code eingeben</h2>
            <button class="modal-close" onclick="closeModal('emailCodeModal')">×</button>
        </div>
        <div class="modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Wir haben dir einen 6-stelligen Code an <strong id="sentEmailDisplay"></strong> gesendet.</p>
            
            <form onsubmit="verifyEmailCode(event)">
                <div class="form-group">
                    <label class="form-label">Bestätigungscode</label>
                    <input type="text" class="form-input" id="emailCode" required placeholder="123456" maxlength="6" style="text-align: center; font-size: 24px; letter-spacing: 8px;">
                </div>
                <button type="submit" class="btn btn-primary">Bestätigen</button>
            </form>
            
            <p style="text-align: center; margin-top: 16px; font-size: 13px; color: var(--text-secondary);">
                Keinen Code erhalten? <a href="#" onclick="resendCode()" style="color: var(--primary);">Erneut senden</a>
            </p>
        </div>
    </div>
</div>

<!-- Theme Modal -->
<div class="modal-overlay" id="themeModal">
    <div class="modal" style="max-width: 420px;">
        <div class="modal-header">
            <h2 class="modal-title">Design & Farben</h2>
            <button class="modal-close" onclick="closeModal('themeModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            
            <!-- Erscheinungsbild -->
            <div class="form-group">
                <label class="form-label" style="font-weight: 600; margin-bottom: 12px;">Erscheinungsbild</label>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <button class="theme-mode-btn" onclick="setTheme('light')" id="themeBtnLight">
                        <div class="theme-preview theme-preview-light"></div>
                        <span>Hell</span>
                    </button>
                    <button class="theme-mode-btn" onclick="setTheme('dark')" id="themeBtnDark">
                        <div class="theme-preview theme-preview-dark"></div>
                        <span>Dunkel</span>
                    </button>
                    <button class="theme-mode-btn" onclick="setTheme('auto')" id="themeBtnAuto">
                        <div class="theme-preview theme-preview-auto"></div>
                        <span>Auto</span>
                    </button>
                </div>
            </div>
            
            <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">
            
            <!-- Akzentfarbe -->
            <div class="form-group">
                <label class="form-label" style="font-weight: 600; margin-bottom: 12px;">Akzentfarbe</label>
                <div class="accent-colors" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;">
                    <!-- Reihe 1: Klassische Farben -->
                    <button class="accent-btn" style="--accent: #1a5f4a;" onclick="setAccentColor('#1a5f4a', 'Ostfriesland')" title="Ostfriesland Grün"></button>
                    <button class="accent-btn" style="--accent: #007AFF;" onclick="setAccentColor('#007AFF', 'Blau')" title="Blau"></button>
                    <button class="accent-btn" style="--accent: #34C759;" onclick="setAccentColor('#34C759', 'Grün')" title="Grün"></button>
                    <button class="accent-btn" style="--accent: #FF9500;" onclick="setAccentColor('#FF9500', 'Orange')" title="Orange"></button>
                    <button class="accent-btn" style="--accent: #FF2D55;" onclick="setAccentColor('#FF2D55', 'Pink')" title="Pink"></button>
                    <button class="accent-btn" style="--accent: #AF52DE;" onclick="setAccentColor('#AF52DE', 'Lila')" title="Lila"></button>
                    <!-- Reihe 2: Erweiterte Farben -->
                    <button class="accent-btn" style="--accent: #FF3B30;" onclick="setAccentColor('#FF3B30', 'Rot')" title="Rot"></button>
                    <button class="accent-btn" style="--accent: #5856D6;" onclick="setAccentColor('#5856D6', 'Indigo')" title="Indigo"></button>
                    <button class="accent-btn" style="--accent: #00C7BE;" onclick="setAccentColor('#00C7BE', 'Türkis')" title="Türkis"></button>
                    <button class="accent-btn" style="--accent: #30D158;" onclick="setAccentColor('#30D158', 'Mint')" title="Mint"></button>
                    <button class="accent-btn" style="--accent: #FFD60A;" onclick="setAccentColor('#FFD60A', 'Gelb')" title="Gelb"></button>
                    <button class="accent-btn" style="--accent: #BF5AF2;" onclick="setAccentColor('#BF5AF2', 'Violett')" title="Violett"></button>
                    <!-- Reihe 3: Premium Farben -->
                    <button class="accent-btn" style="--accent: #0A84FF;" onclick="setAccentColor('#0A84FF', 'Sky')" title="Sky Blue"></button>
                    <button class="accent-btn" style="--accent: #FF6482;" onclick="setAccentColor('#FF6482', 'Coral')" title="Coral"></button>
                    <button class="accent-btn" style="--accent: #64D2FF;" onclick="setAccentColor('#64D2FF', 'Cyan')" title="Cyan"></button>
                    <button class="accent-btn" style="--accent: #DA5B3E;" onclick="setAccentColor('#DA5B3E', 'Terracotta')" title="Terracotta"></button>
                    <button class="accent-btn" style="--accent: #1B2A4A;" onclick="setAccentColor('#1B2A4A', 'Navy')" title="Navy"></button>
                    <button class="accent-btn" style="--accent: #2D2D2D;" onclick="setAccentColor('#2D2D2D', 'Schwarz')" title="Schwarz"></button>
                </div>
                
                <!-- Custom Color Picker -->
                <div style="margin-top: 16px; display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color);">
                    <input type="color" id="customColorPicker" value="#1a5f4a" style="width: 44px; height: 44px; border: none; border-radius: 10px; cursor: pointer; padding: 0; background: none;">
                    <div style="flex: 1;">
                        <div style="font-size: 13px; font-weight: 600; color: var(--text-primary);">Eigene Farbe wählen</div>
                        <div style="font-size: 12px; color: var(--text-secondary);" id="customColorHex">#1a5f4a</div>
                    </div>
                    <button onclick="applyCustomColor()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                        Anwenden
                    </button>
                </div>
                
                <p id="currentAccentName" style="text-align: center; margin-top: 10px; font-size: 13px; color: var(--text-secondary);">Aktuell: Ostfriesland Grün</p>
            </div>
            
            <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">
            
            <!-- Glaseffekt -->
            <div class="form-group">
                <label class="form-label" style="font-weight: 600; margin-bottom: 12px;">Glaseffekt (Blur)</label>
                <div style="display: flex; gap: 10px;">
                    <button class="glass-btn" onclick="setGlassEffect('none')" id="glassNone">
                        <span>Aus</span>
                    </button>
                    <button class="glass-btn" onclick="setGlassEffect('subtle')" id="glassSubtle">
                        <span>Dezent</span>
                    </button>
                    <button class="glass-btn active" onclick="setGlassEffect('strong')" id="glassStrong">
                        <span>Stark</span>
                    </button>
                </div>
            </div>
            
            <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">
            
            <!-- Ecken -->
            <div class="form-group">
                <label class="form-label" style="font-weight: 600; margin-bottom: 12px;">Ecken-Radius</label>
                <div style="display: flex; gap: 10px;">
                    <button class="corner-btn" onclick="setCornerRadius('sharp')" id="cornerSharp">
                        <div style="width: 24px; height: 24px; background: var(--primary); border-radius: 2px;"></div>
                        <span>Eckig</span>
                    </button>
                    <button class="corner-btn" onclick="setCornerRadius('rounded')" id="cornerRounded">
                        <div style="width: 24px; height: 24px; background: var(--primary); border-radius: 6px;"></div>
                        <span>Rund</span>
                    </button>
                    <button class="corner-btn active" onclick="setCornerRadius('pill')" id="cornerPill">
                        <div style="width: 24px; height: 24px; background: var(--primary); border-radius: 12px;"></div>
                        <span>Pill</span>
                    </button>
                </div>
            </div>
            
            <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">
            
            <!-- Zurücksetzen -->
            <button onclick="resetDesign()" style="width: 100%; padding: 14px; background: var(--bg-secondary); border: none; border-radius: 12px; color: var(--text-secondary); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                </svg>
                Auf Standard zurücksetzen
            </button>
            
        </div>
    </div>
</div>

<!-- Simple Theme Modal für Gäste (nur Hell/Dunkel/Auto) -->
<div class="modal-overlay" id="themeModalSimple">
    <div class="modal" style="max-width: 340px;">
        <div class="modal-header">
            <h2 class="modal-title">Design</h2>
            <button class="modal-close" onclick="closeModal('themeModalSimple')">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Wähle dein Design</label>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 12px;">
                    <button onclick="setThemeSimple('light')" id="themeBtnLightSimple" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; border: 2px solid var(--border-color); background: var(--bg-card); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f8f8f8, #e0e0e0); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" width="22" height="22">
                                <circle cx="12" cy="12" r="5"/>
                                <line x1="12" y1="1" x2="12" y2="3"/>
                                <line x1="12" y1="21" x2="12" y2="23"/>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                <line x1="1" y1="12" x2="3" y2="12"/>
                                <line x1="21" y1="12" x2="23" y2="12"/>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                            </svg>
                        </div>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">Hell</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Helles Design</div>
                        </div>
                    </button>
                    <button onclick="setThemeSimple('dark')" id="themeBtnDarkSimple" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; border: 2px solid var(--border-color); background: var(--bg-card); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #2c2c2c, #1a1a1a); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" width="22" height="22">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                        </div>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">Dunkel</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Dunkles Design</div>
                        </div>
                    </button>
                    <button onclick="setThemeSimple('auto')" id="themeBtnAutoSimple" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; border: 2px solid var(--border-color); background: var(--bg-card); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f8f8f8 50%, #2c2c2c 50%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                                <rect x="2" y="6" width="20" height="12" rx="2"/>
                                <circle cx="12" cy="12" r="2"/>
                            </svg>
                        </div>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">Automatisch</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Folgt System</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Modal -->
<div class="modal-overlay" id="notificationModal">
    <div class="modal" style="max-width: 380px;">
        <div class="modal-header">
            <h2 class="modal-title">Benachrichtigungen</h2>
            <button class="modal-close" onclick="closeModal('notificationModal')">×</button>
        </div>
        <div class="modal-body" style="padding: 0;">
            <div id="notificationList">
                <!-- Notifications werden hier eingefügt -->
            </div>
            <div style="padding: 16px; border-top: 1px solid var(--border-color);">
                <button onclick="clearNotifications()" style="width: 100%; padding: 12px; background: var(--bg-secondary); border: none; border-radius: 8px; color: var(--text-secondary); font-size: 14px; cursor: pointer;">Alle löschen</button>
            </div>
        </div>
    </div>
</div>

<!-- Location Modal -->
<div class="modal-overlay" id="locationModal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title" data-i18n="chooseLocation">Ort wählen</h2>
            <button class="modal-close" onclick="closeModal('locationModal')">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <!-- Suchleiste -->
                <div style="position: relative; margin-bottom: 16px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--slate);">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" id="locationSearchInput" class="form-input" placeholder="Ort suchen..." style="padding-left: 42px;" oninput="filterLocations()">
                </div>
                
                <label class="form-label" data-i18n="whereToGo">Wo möchtest du hin?</label>
                <div id="locationButtons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; max-height: 300px; overflow-y: auto;">
                    <button class="location-btn active" onclick="setLocation('Alle')" data-location="alle">Alle Orte</button>
                    <!-- Wird dynamisch aus Supabase geladen -->
                </div>
                <p id="noLocationsHint" style="display: none; text-align: center; color: var(--slate); padding: 20px;">Keine Orte gefunden</p>
                
                <!-- Eigenen Ort hinzufügen -->
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                    <p style="font-size: 13px; color: var(--slate); margin-bottom: 10px;" data-i18n="locationNotFound">Dein Ort nicht dabei?</p>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="newLocationInput" class="form-input" placeholder="z.B. Pewsum, Marienhafe..." style="flex: 1;">
                        <button onclick="addCustomLocation()" style="padding: 10px 16px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="18" height="18">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Restaurant Hinzufügen Modal -->
<div class="modal-overlay" id="addRestaurantModal">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <h2 class="modal-title">Restaurant hinzufügen</h2>
            <button class="modal-close" onclick="closeModal('addRestaurantModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <form id="addRestaurantForm" onsubmit="addRestaurant(event)">
                <div class="form-group">
                    <label class="form-label">Restaurant-Name *</label>
                    <input type="text" class="form-input" id="newRestaurantName" required placeholder="z.B. Fischerhaus">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></span>Telefon</label>
                        <input type="tel" class="form-input" id="newRestaurantPhone" placeholder="+49 4926 ...">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></span>WhatsApp</label>
                        <input type="tel" class="form-input" id="newRestaurantWhatsapp" placeholder="+49176...">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></span>E-Mail</label>
                    <input type="email" class="form-input" id="newRestaurantEmail" placeholder="info@restaurant.de">
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></span>Straße + Hausnummer</label>
                    <input type="text" class="form-input" id="newRestaurantStreet" placeholder="Hafenstraße 12">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">PLZ</label>
                        <input type="text" class="form-input" id="newRestaurantZip" placeholder="26736">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ort</label>
                        <select class="form-select" id="newRestaurantCity">
                            <option value="Greetsiel">Greetsiel</option>
                            <option value="Norddeich">Norddeich</option>
                            <option value="Norden">Norden</option>
                            <option value="Aurich">Aurich</option>
                            <option value="Emden">Emden</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg></span>Google Maps Link</label>
                    <input type="url" class="form-input" id="newRestaurantGoogleMaps" placeholder="https://maps.google.com/...">
                    <small style="color: var(--text-secondary); font-size: 11px;">Öffne Google Maps, suche das Restaurant, klicke "Teilen" → Link kopieren</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Küche</label>
                    <select class="form-select" id="newRestaurantCuisine">
                        <option value="fisch">Fisch & Meeresfrüchte</option>
                        <option value="deutsch">Deutsch</option>
                        <option value="italienisch">Italienisch</option>
                        <option value="cafe">Café</option>
                        <option value="imbiss">Imbiss</option>
                        <option value="asiatisch">Asiatisch</option>
                        <option value="griechisch">Griechisch</option>
                        <option value="tuerkisch">Türkisch / Döner</option>
                        <option value="bar">Bar / Kneipe</option>
                        <option value="shisha">Shisha Bar</option>
                        <option value="steakhouse">Steakhouse</option>
                        <option value="burger">Burger</option>
                        <option value="indisch">Indisch</option>
                        <option value="mexikanisch">Mexikanisch</option>
                        <option value="eisdiele">Eisdiele</option>
                        <option value="baeckerei">Bäckerei</option>
                    </select>
                </div>
                
                <h4 style="margin: 16px 0 12px; color: var(--dark);">Social Media</h4>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></span>Instagram Link</label>
                    <input type="url" class="form-input" id="newRestaurantInstagram" placeholder="https://instagram.com/restaurantname">
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg></span>TikTok Link</label>
                    <input type="url" class="form-input" id="newRestaurantTiktok" placeholder="https://tiktok.com/@restaurantname">
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Google Bewertung</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Sterne (1-5)</label>
                        <input type="number" class="form-input" id="newRestaurantRating" value="4.5" min="1" max="5" step="0.1" placeholder="4.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Anzahl Bewertungen</label>
                        <input type="number" class="form-input" id="newRestaurantReviewCount" placeholder="127" min="0">
                    </div>
                </div>
                <p style="font-size: 11px; color: var(--slate); margin-top: -8px; margin-bottom: 12px;">Tipp: Öffne Google Maps → Restaurant suchen → Bewertung & Anzahl ablesen</p>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></span>Restaurant-Bild</label>
                    
                    <!-- Bild Vorschau -->
                    <div id="imagePreviewContainer" style="display: none; margin-bottom: 12px; position: relative;">
                        <img id="imagePreview" src="" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 12px;">
                        <button type="button" onclick="clearImagePreview()" style="position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; border-radius: 50%; background: rgba(0,0,0,0.6); border: none; color: white; cursor: pointer; font-size: 16px;">×</button>
                    </div>
                    
                    <!-- Upload Buttons -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px; background: var(--bg-secondary); border: 2px dashed var(--border-color); border-radius: 12px; cursor: pointer; color: var(--text-primary); font-weight: 500; transition: all 0.2s;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            📷 Foto wählen
                            <input type="file" accept="image/*" onchange="handleImageUpload(event)" style="display: none;">
                        </label>
                        <label style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px; background: var(--bg-secondary); border: 2px dashed var(--border-color); border-radius: 12px; cursor: pointer; color: var(--text-primary); font-weight: 500; transition: all 0.2s;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                <circle cx="12" cy="13" r="4"></circle>
                            </svg>
                            📱 Kamera
                            <input type="file" accept="image/*" capture="environment" onchange="handleImageUpload(event)" style="display: none;">
                        </label>
                    </div>
                    
                    <!-- URL Eingabe (Alternative) -->
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                        <span style="color: var(--text-secondary); font-size: 12px;">oder URL eingeben</span>
                        <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                    </div>
                    <input type="url" class="form-input" id="newRestaurantImage" placeholder="https://..." oninput="previewImageFromUrl(this.value)">
                    <small style="color: var(--text-secondary); font-size: 11px; margin-top: 4px; display: block;">Tipp: Auf Google Maps → Restaurant → Fotos → Bild öffnen → Rechtsklick → Bildadresse kopieren</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Anzahl Tische</label>
                    <input type="number" class="form-input" id="newRestaurantTables" value="8" min="1" max="50">
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Öffnungszeiten</h4>
                
                <div style="display: grid; grid-template-columns: auto 1fr 1fr; gap: 8px; align-items: center; font-size: 14px;">
                    <span style="color: var(--slate);">Mo</span>
                    <input type="time" class="form-input" id="openMoStart" value="11:00" style="padding: 8px;">
                    <input type="time" class="form-input" id="openMoEnd" value="22:00" style="padding: 8px;">
                    
                    <span style="color: var(--slate);">Di</span>
                    <input type="time" class="form-input" id="openDiStart" value="11:00" style="padding: 8px;">
                    <input type="time" class="form-input" id="openDiEnd" value="22:00" style="padding: 8px;">
                    
                    <span style="color: var(--slate);">Mi</span>
                    <input type="time" class="form-input" id="openMiStart" value="11:00" style="padding: 8px;">
                    <input type="time" class="form-input" id="openMiEnd" value="22:00" style="padding: 8px;">
                    
                    <span style="color: var(--slate);">Do</span>
                    <input type="time" class="form-input" id="openDoStart" value="11:00" style="padding: 8px;">
                    <input type="time" class="form-input" id="openDoEnd" value="22:00" style="padding: 8px;">
                    
                    <span style="color: var(--slate);">Fr</span>
                    <input type="time" class="form-input" id="openFrStart" value="11:00" style="padding: 8px;">
                    <input type="time" class="form-input" id="openFrEnd" value="23:00" style="padding: 8px;">
                    
                    <span style="color: var(--slate);">Sa</span>
                    <input type="time" class="form-input" id="openSaStart" value="11:00" style="padding: 8px;">
                    <input type="time" class="form-input" id="openSaEnd" value="23:00" style="padding: 8px;">
                    
                    <span style="color: var(--slate);">So</span>
                    <input type="time" class="form-input" id="openSoStart" value="11:00" style="padding: 8px;">
                    <input type="time" class="form-input" id="openSoEnd" value="22:00" style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-top: 12px;">
                    <label class="form-label">Ruhetag</label>
                    <select class="form-input" id="restDaySelect">
                        <option value="">Kein Ruhetag</option>
                        <option value="0">Montag</option>
                        <option value="1">Dienstag</option>
                        <option value="2">Mittwoch</option>
                        <option value="3">Donnerstag</option>
                        <option value="4">Freitag</option>
                        <option value="5">Samstag</option>
                        <option value="6">Sonntag</option>
                    </select>
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">💳 Zahlungsdaten (intern)</h4>
                
                <div class="form-group">
                    <label class="form-label">Kontoinhaber</label>
                    <input type="text" class="form-input" id="newRestaurantAccountHolder" placeholder="Max Mustermann">
                </div>
                <div class="form-group">
                    <label class="form-label">IBAN</label>
                    <input type="text" class="form-input" id="newRestaurantIBAN" placeholder="DE89 3704 0044 0532 0130 00" style="font-family: monospace;">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Monatsbeitrag</label>
                        <select class="form-select" id="newRestaurantPlan">
                            <option value="0">Kostenlos (Test)</option>
                            <option value="29">Basis - 29€/Monat</option>
                            <option value="49" selected>Standard - 49€/Monat</option>
                            <option value="99">Premium - 99€/Monat</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Vertragsbeginn</label>
                        <input type="date" class="form-input" id="newRestaurantContractStart">
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="newRestaurantAGBAccepted" required>
                        <span style="color: var(--slate); font-size: 13px;">Restaurant akzeptiert die <a href="#" onclick="openModal('agbModal'); return false;" style="color: var(--primary);">AGB</a></span>
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Restaurant hinzufügen</button>
            </form>
        </div>
    </div>
</div>

<!-- Admin Login Modal -->
<div class="modal-overlay" id="adminLoginModal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Admin Login</h2>
            <button class="modal-close" onclick="closeModal('adminLoginModal');">×</button>
        </div>
        <div class="modal-body">
            <p style="color: var(--slate); margin-bottom: 20px;">Gib das Admin-Passwort ein.</p>
            
            <div id="loginError" style="display: none; background: rgba(255,59,48,0.15); color: var(--danger); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px;"></div>
            
            <div class="form-group">
                <label class="form-label">Passwort</label>
                <input type="password" class="form-input" id="adminPassword" placeholder="••••••••" autocomplete="off">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="simpleLogin()">Anmelden</button>
        </div>
    </div>
</div>

<!-- ==================== GUEST VIEW ==================== -->
<div class="guest-view" id="guestView">
    
    <!-- Main View -->
    <div id="mainView">
        <header class="guest-header">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div class="logo" onclick="secretAdminTap()">Kiek mol <span>in</span></div>
                <!-- Punkte & Sprache -->
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="points-display" onclick="openModal('pointsModal')" title="Deine Punkte">
                        <span id="userPoints">0</span>
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    </div>
                    <div class="lang-switcher">
                        <button onclick="setLanguage('de')" id="langDE" class="lang-btn active">DE</button>
                        <button onclick="setLanguage('en')" id="langEN" class="lang-btn">EN</button>
                        <button onclick="setLanguage('nl')" id="langNL" class="lang-btn">NL</button>
                    </div>
                </div>
            </div>
            <p class="tagline" data-i18n="tagline">Ostfriesland genießen</p>
            
            <div class="location-bar" onclick="openModal('locationModal')" style="margin-top: 12px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                <span id="currentLocation">Greetsiel</span>
                <span class="change" data-i18n="change">Ändern ›</span>
            </div>
        </header>
        
        <!-- Quick Actions Bar -->
        <div style="display: flex; justify-content: flex-end; gap: 12px; padding: 0 20px; margin-top: -25px; margin-bottom: 16px; position: relative; z-index: 50;">
            <button onclick="openModal('notificationModal');" style="background: var(--bg-card); color: var(--text-primary); border: none; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 12px rgba(0,0,0,0.15); position: relative;" title="Benachrichtigungen">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
                <span id="notificationBadge" class="notification-badge">3</span>
            </button>
            <button onclick="openModal('themeModalSimple');" style="background: var(--bg-card); color: var(--text-primary); border: none; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 12px rgba(0,0,0,0.15);" title="Design ändern">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
            </button>
            <button onclick="openModal('profileModal');" id="profileBtn" style="background: var(--bg-card); color: var(--text-primary); border: none; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 12px rgba(0,0,0,0.15);" title="Profil">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22" id="profileIcon">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </button>
        </div>

        <!-- Wetter-Eilmeldung Banner -->
        <div id="weatherAlertBanner" style="display: none; margin: 0 20px 16px; padding: 16px 18px; background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 16px; position: relative; box-shadow: 0 4px 24px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04); border: 1px solid rgba(255,255,255,0.5);">
            <button onclick="dismissWeatherAlert()" style="position: absolute; top: 12px; right: 12px; background: var(--bg-secondary); border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.6; transition: opacity 0.2s;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="14" height="14">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            <div style="display: flex; align-items: flex-start; gap: 14px;">
                <div id="alertIconContainer" style="width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);">
                    <span id="alertIcon">⛈️</span>
                </div>
                <div style="flex: 1; padding-right: 20px;">
                    <div style="font-weight: 700; font-size: 15px; color: var(--dark); margin-bottom: 2px;" id="alertTitle">Wetter-Hinweis</div>
                    <div style="font-size: 13px; color: var(--slate); line-height: 1.5;" id="alertMessage">Schlechtes Wetter erwartet</div>
                    <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 6px;" id="alertSuggestions"></div>
                </div>
            </div>
        </div>

        <!-- Wetter Widget - Kompakt mit Klick für Details -->
        <div id="weatherWidget" style="margin: 0 20px 16px; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.12); background: var(--bg-card); border: 1px solid var(--border-color);">
            <!-- Hauptbereich - IMMER SICHTBAR -->
            <div id="weatherBg" onclick="toggleWeatherDetails()" style="padding: 20px; position: relative; cursor: pointer;">
                <!-- Ort + Haupttemperatur -->
                <div style="text-align: center;">
                    <div style="font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600; color: var(--dark);" id="weatherLocation">Ostfriesland</div>
                    <div style="font-size: 64px; font-weight: 200; line-height: 1; color: var(--dark);" id="weatherTemp">3°</div>
                    <div style="font-size: 15px; font-weight: 500; color: var(--slate);" id="weatherDesc">Windig</div>
                    <div style="font-size: 14px; color: var(--slate);">H:<span id="weatherHigh">4°</span>  T:<span id="weatherLow">1°</span></div>
                </div>
                <!-- Expand/Collapse Pfeil -->
                <div style="text-align: center; margin-top: 8px;">
                    <svg id="weatherArrow" viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="2" width="20" height="20" style="transition: transform 0.3s;">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
            </div>
            
            <!-- AUSKLAPPBARER BEREICH -->
            <div id="weatherDetails" style="max-height: 0; overflow: hidden; transition: max-height 0.4s ease;">
                <!-- Stündliche Vorhersage -->
                <div style="background: var(--bg-secondary); padding: 12px 16px; border-top: 1px solid var(--border-color);">
                    <div style="font-size: 12px; color: var(--slate); margin-bottom: 10px;" id="weatherHourlyDesc">Windiges Wetter für den Rest des Tages.</div>
                    <div style="display: flex; gap: 16px; overflow-x: auto; padding-bottom: 8px;" id="weatherHourly">
                        <div style="text-align: center; min-width: 55px;">
                            <div style="font-size: 13px; font-weight: 600; color: var(--dark);">Jetzt</div>
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="28" height="28" style="margin: 6px auto; display: block;"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
                            <div style="font-size: 15px; font-weight: 600; color: var(--dark);">3°</div>
                        </div>
                        <div style="text-align: center; min-width: 55px;">
                            <div style="font-size: 13px; color: var(--slate);">18 Uhr</div>
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="28" height="28" style="margin: 6px auto; display: block;"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
                            <div style="font-size: 15px; font-weight: 600; color: var(--dark);">3°</div>
                        </div>
                        <div style="text-align: center; min-width: 55px;">
                            <div style="font-size: 13px; color: var(--slate);">19 Uhr</div>
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="28" height="28" style="margin: 6px auto; display: block;"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
                            <div style="font-size: 15px; font-weight: 600; color: var(--dark);">3°</div>
                        </div>
                        <div style="text-align: center; min-width: 55px;">
                            <div style="font-size: 13px; color: var(--slate);">20 Uhr</div>
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="28" height="28" style="margin: 6px auto; display: block;"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
                            <div style="font-size: 15px; font-weight: 600; color: var(--dark);">2°</div>
                        </div>
                        <div style="text-align: center; min-width: 55px;">
                            <div style="font-size: 13px; color: var(--slate);">21 Uhr</div>
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="28" height="28" style="margin: 6px auto; display: block;"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
                            <div style="font-size: 15px; font-weight: 600; color: var(--dark);">2°</div>
                        </div>
                    </div>
                </div>
                
                <!-- 7-Tage Vorhersage -->
                <div style="background: var(--bg-secondary); padding: 12px 16px; border-top: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--slate); margin-bottom: 10px; font-weight: 600;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        7-TAGE-VORHERSAGE
                    </div>
                    <div id="weatherForecast">
                        <!-- Heute -->
                        <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 50px; font-size: 14px; font-weight: 600; color: var(--dark);">Heute</div>
                            <div style="width: 40px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="22" height="22"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg></div>
                            <div style="width: 35px; text-align: right; font-size: 14px; color: var(--slate);">1°</div>
                            <div style="flex: 1; margin: 0 12px; height: 4px; background: linear-gradient(to right, var(--primary) 50%, var(--border-color) 50%); border-radius: 2px;"></div>
                            <div style="width: 30px; text-align: right; font-size: 14px; font-weight: 600; color: var(--dark);">4°</div>
                        </div>
                        <!-- Sa -->
                        <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 50px; font-size: 14px; color: var(--dark);">Sa</div>
                            <div style="width: 40px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="22" height="22"><path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"/><line x1="8" y1="16" x2="8.01" y2="16"/><line x1="8" y1="20" x2="8.01" y2="20"/><line x1="12" y1="18" x2="12.01" y2="18"/><line x1="12" y1="22" x2="12.01" y2="22"/><line x1="16" y1="16" x2="16.01" y2="16"/><line x1="16" y1="20" x2="16.01" y2="20"/></svg><div style="font-size: 10px; color: var(--primary); font-weight: 600;">75%</div></div>
                            <div style="width: 35px; text-align: right; font-size: 14px; color: var(--slate);">-1°</div>
                            <div style="flex: 1; margin: 0 12px; height: 4px; background: linear-gradient(to right, var(--primary) 60%, var(--border-color) 60%); border-radius: 2px;"></div>
                            <div style="width: 30px; text-align: right; font-size: 14px; font-weight: 600; color: var(--dark);">2°</div>
                        </div>
                        <!-- So -->
                        <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 50px; font-size: 14px; color: var(--dark);">So</div>
                            <div style="width: 40px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="22" height="22"><line x1="16" y1="13" x2="16" y2="21"/><line x1="8" y1="13" x2="8" y2="21"/><line x1="12" y1="15" x2="12" y2="23"/><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg><div style="font-size: 10px; color: var(--primary); font-weight: 600;">45%</div></div>
                            <div style="width: 35px; text-align: right; font-size: 14px; color: var(--slate);">-3°</div>
                            <div style="flex: 1; margin: 0 12px; height: 4px; background: linear-gradient(to right, var(--primary) 55%, var(--border-color) 55%); border-radius: 2px;"></div>
                            <div style="width: 30px; text-align: right; font-size: 14px; font-weight: 600; color: var(--dark);">1°</div>
                        </div>
                        <!-- Mo -->
                        <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 50px; font-size: 14px; color: var(--dark);">Mo</div>
                            <div style="width: 40px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="22" height="22"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg></div>
                            <div style="width: 35px; text-align: right; font-size: 14px; color: var(--slate);">-3°</div>
                            <div style="flex: 1; margin: 0 12px; height: 4px; background: linear-gradient(to right, var(--primary) 45%, var(--border-color) 45%); border-radius: 2px;"></div>
                            <div style="width: 30px; text-align: right; font-size: 14px; font-weight: 600; color: var(--dark);">0°</div>
                        </div>
                        <!-- Di -->
                        <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 50px; font-size: 14px; color: var(--dark);">Di</div>
                            <div style="width: 40px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="22" height="22"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></div>
                            <div style="width: 35px; text-align: right; font-size: 14px; color: var(--slate);">-2°</div>
                            <div style="flex: 1; margin: 0 12px; height: 4px; background: linear-gradient(to right, var(--primary) 50%, var(--border-color) 50%); border-radius: 2px;"></div>
                            <div style="width: 30px; text-align: right; font-size: 14px; font-weight: 600; color: var(--dark);">3°</div>
                        </div>
                        <!-- Mi -->
                        <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 50px; font-size: 14px; color: var(--dark);">Mi</div>
                            <div style="width: 40px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="22" height="22"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/><circle cx="6" cy="6" r="3" fill="none"/><line x1="6" y1="1" x2="6" y2="2"/><line x1="6" y1="10" x2="6" y2="11"/><line x1="2" y1="6" x2="3" y2="6"/></svg></div>
                            <div style="width: 35px; text-align: right; font-size: 14px; color: var(--slate);">0°</div>
                            <div style="flex: 1; margin: 0 12px; height: 4px; background: linear-gradient(to right, var(--primary) 55%, var(--border-color) 55%); border-radius: 2px;"></div>
                            <div style="width: 30px; text-align: right; font-size: 14px; font-weight: 600; color: var(--dark);">5°</div>
                        </div>
                        <!-- Do -->
                        <div style="display: flex; align-items: center; padding: 10px 0;">
                            <div style="width: 50px; font-size: 14px; color: var(--dark);">Do</div>
                            <div style="width: 40px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="22" height="22"><line x1="16" y1="13" x2="16" y2="21"/><line x1="8" y1="13" x2="8" y2="21"/><line x1="12" y1="15" x2="12" y2="23"/><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg><div style="font-size: 10px; color: var(--primary); font-weight: 600;">30%</div></div>
                            <div style="width: 35px; text-align: right; font-size: 14px; color: var(--slate);">1°</div>
                            <div style="flex: 1; margin: 0 12px; height: 4px; background: linear-gradient(to right, var(--primary) 50%, var(--border-color) 50%); border-radius: 2px;"></div>
                            <div style="width: 30px; text-align: right; font-size: 14px; font-weight: 600; color: var(--dark);">6°</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GEZEITEN WIDGET -->
        <div id="tideWidget" class="tide-widget" style="margin: 0 20px 16px;">
            <div class="tide-header">
                <div class="tide-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 6px;">
                        <path d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>
                        <path d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>
                        <path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>
                    </svg>
                    Gezeiten Nordsee
                </div>
                <div class="tide-status" id="tideStatus">Flut steigt</div>
            </div>
            <div class="tide-visual">
                <div class="tide-wave" id="tideWave" style="height: 40%;"></div>
                <div class="tide-marker" id="tideNow" style="left: 50%;"></div>
            </div>
            <div class="tide-times">
                <div class="tide-time">
                    <div class="tide-time-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12" style="margin-right: 4px;"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
                        Niedrigwasser
                    </div>
                    <div id="tideLow">06:32</div>
                </div>
                <div class="tide-time">
                    <div class="tide-time-label">Jetzt</div>
                    <div id="tideNowTime">--:--</div>
                </div>
                <div class="tide-time">
                    <div class="tide-time-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12" style="margin-right: 4px;"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
                        Hochwasser
                    </div>
                    <div id="tideHigh">12:48</div>
                </div>
            </div>
            <div class="tide-suggestions" id="tideSuggestions">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="margin-right: 4px; flex-shrink: 0;">
                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
                <span><strong>Perfekt jetzt:</strong> Hafenrundfahrt, Fischrestaurants am Wasser</span>
            </div>
            <div style="margin-top: 4px; padding: 6px 10px; background: rgba(255,200,0,0.15); border-radius: 6px; font-size: 10px; color: rgba(255,255,255,0.85); display: flex; align-items: center; gap: 5px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="#ffc107" stroke-width="2" width="10" height="10" style="flex-shrink: 0;">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                Ungefähre Angaben – vor Ort prüfen
            </div>
        </div>

        <div class="quick-stats" style="margin-top: 20px;">
            <div class="stat-card">
                <div class="stat-number" id="statRestaurants">0</div>
                <div class="stat-label">Restaurants</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statTables">0</div>
                <div class="stat-label">Freie Tische</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statOffers">0</div>
                <div class="stat-label">Angebote</div>
            </div>
        </div>

        <!-- KARTE - Kompakt mit Klick zum Vergrößern -->
        <div id="mapSection" class="map-section" onclick="openFullscreenMap()" style="margin: 24px 20px; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.12); position: relative; cursor: pointer;">
            <div id="guestMap" style="height: 160px; width: 100%;"></div>
            
            <!-- Overlay mit "Karte öffnen" Hinweis -->
            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.5)); padding: 12px 16px; display: flex; align-items: center; justify-content: flex-end;">
                <div style="background: white; padding: 8px 14px; border-radius: 20px; display: flex; align-items: center; gap: 6px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" width="16" height="16">
                        <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                    </svg>
                    <span style="font-size: 12px; font-weight: 600; color: var(--primary);">Karte öffnen</span>
                </div>
            </div>
        </div>

        <section class="section">
            <div class="search-bar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" placeholder="Restaurant suchen..." id="searchInput" oninput="searchRestaurants()">
            </div>
            
            <div class="filter-chips" id="filterChips">
                <div class="chip active" data-filter="all" onclick="setFilter('all')">Alle</div>
                <div class="chip" data-filter="fisch" onclick="setFilter('fisch')">Fisch</div>
                <div class="chip" data-filter="deutsch" onclick="setFilter('deutsch')">Deutsch</div>
                <div class="chip" data-filter="italienisch" onclick="setFilter('italienisch')">Italienisch</div>
                <div class="chip" data-filter="cafe" onclick="setFilter('cafe')">Café</div>
                <div class="chip" data-filter="imbiss" onclick="setFilter('imbiss')">Imbiss</div>
            </div>
        </section>

        <section class="live-section">
            <div class="live-header">
                <div class="live-dot"></div>
                <span class="live-title">Gerade in <span id="liveLocation">Ostfriesland</span></span>
            </div>
            <div class="live-count" id="liveCount">0</div>
            <div class="live-label"><span id="liveReservations">0</span> Reservierungen heute • <span id="liveFreeTables">0</span> Tische frei</div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2 class="section-title" data-i18n="restaurants">Restaurants</h2>
            </div>
            
            <!-- Schnellaktionen: Überraschung & Gruppe -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px;">
                <div onclick="surpriseMe()" style="background: var(--primary); border-radius: 12px; padding: 14px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="22" height="22">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <div style="color: white;">
                        <div style="font-size: 14px; font-weight: 700;">Überrasch mich!</div>
                        <div style="font-size: 11px; opacity: 0.8;">Zufällig wählen</div>
                    </div>
                </div>
                <div onclick="openGroupReservationModal()" style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 14px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <div>
                        <div style="font-size: 14px; font-weight: 700;">Gruppen-Tisch</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Mit Freunden</div>
                    </div>
                </div>
            </div>
            
            <!-- Filter Buttons -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px;">
                <button onclick="filterRestaurants('all')" id="filterAll" class="filter-chip active" data-i18n="all">Alle</button>
                <button onclick="filterRestaurants('open')" id="filterOpen" class="filter-chip" data-i18n="openNow">Jetzt geöffnet</button>
                <button onclick="filterRestaurants('tables')" id="filterTables" class="filter-chip" data-i18n="freeTables">Freie Tische</button>
                <button onclick="filterRestaurants('rating')" id="filterRating" class="filter-chip" data-i18n="topRated">Top bewertet</button>
            </div>

            <div id="restaurantList">
                <!-- Restaurant cards will be inserted here -->
            </div>
        </section>

        <!-- Footer -->
        <footer style="padding: 24px 20px 120px; text-align: center; border-top: 1px solid var(--border-color); margin-top: 20px;">
            <div style="font-size: 13px; color: var(--slate); margin-bottom: 12px;">
                <span data-i18n="footerText">© 2025 Kiek mol in – Ostfriesland genießen</span>
            </div>
            <div style="display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; margin-bottom: 16px;">
                <a href="#" onclick="openModal('impressumModal'); return false;" style="font-size: 13px; color: var(--slate); text-decoration: none;" data-i18n="impressum">Impressum</a>
                <a href="#" onclick="openModal('datenschutzModal'); return false;" style="font-size: 13px; color: var(--slate); text-decoration: none;" data-i18n="privacy">Datenschutz</a>
                <a href="/cdn-cgi/l/email-protection#036a6d656c43686a66686e6c6f6a6d2d6766" style="font-size: 13px; color: var(--slate); text-decoration: none;" data-i18n="contact">Kontakt</a>
            </div>
            <div style="font-size: 11px; color: var(--slate); opacity: 0.7; max-width: 320px; margin: 0 auto; line-height: 1.5;">
                Alle Angaben ohne Gewähr. Öffnungszeiten, Verfügbarkeiten und Preise können abweichen. Bitte vor Ort prüfen.
            </div>
        </footer>
    </div>

    <!-- Favorites View -->
    <div class="favorites-view" id="favoritesView">
        <div class="favorites-header">
            <h1 data-i18n="favorites">Favoriten</h1>
        </div>
        <div id="favoritesList">
            <!-- Favorites will be inserted here -->
        </div>
        <div style="height: 100px;"></div>
    </div>

    <!-- Accommodations View -->
    <div class="favorites-view" id="accommodationsView">
        <header class="guest-header">
            <div class="logo">Kiek mol <span>in</span></div>
            <p class="tagline" data-i18n="accommodationsTagline">Unterkünfte in Ostfriesland</p>
            
            <div class="location-bar" onclick="openModal('locationModal')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                <span id="currentLocationAcc">Greetsiel</span>
                <span class="change">Ändern ›</span>
            </div>
        </header>

        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-number" id="statAccommodations">0</div>
                <div class="stat-label">Unterkünfte</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statAvailable">0</div>
                <div class="stat-label">Verfügbar</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statAccOffers">0</div>
                <div class="stat-label">Angebote</div>
            </div>
        </div>

        <section class="section">
            <div class="search-bar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" placeholder="Unterkunft suchen..." id="searchAccommodation" oninput="filterAccommodationsBySearch()">
            </div>
            
            <div class="filter-chips" id="filterChipsAcc">
                <div class="chip active" data-filter="all" onclick="setAccFilter('all')">Alle</div>
                <div class="chip" data-filter="ferienwohnung" onclick="setAccFilter('ferienwohnung')">Ferienwohnung</div>
                <div class="chip" data-filter="hotel" onclick="setAccFilter('hotel')">Hotel</div>
                <div class="chip" data-filter="pension" onclick="setAccFilter('pension')">Pension</div>
                <div class="chip" data-filter="available" onclick="setAccFilter('available')">Verfügbar</div>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Unterkünfte</h2>
            </div>

            <div id="accommodationsList">
                <!-- Accommodation cards will be inserted here -->
            </div>
        </section>

        <div style="height: 100px;"></div>
    </div>

    <!-- Events View -->
    <div class="favorites-view" id="eventsView">
        <header class="guest-header">
            <div class="logo">Kiek mol <span>in</span></div>
            <p class="tagline" data-i18n="eventsTagline">Events in Ostfriesland</p>
        </header>

        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-number" id="statEvents">0</div>
                <div class="stat-label">Events</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statThisMonth">0</div>
                <div class="stat-label">Diesen Monat</div>
            </div>
        </div>

        <section class="section">
            <div class="filter-chips" id="filterChipsEvents">
                <div class="chip active" data-filter="all" onclick="setEventFilter('all')">Alle</div>
                <div class="chip" data-filter="fest" onclick="setEventFilter('fest')">Feste</div>
                <div class="chip" data-filter="markt" onclick="setEventFilter('markt')">Märkte</div>
                <div class="chip" data-filter="konzert" onclick="setEventFilter('konzert')">Konzerte</div>
                <div class="chip" data-filter="natur" onclick="setEventFilter('natur')">Natur</div>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Veranstaltungen</h2>
            </div>
            <div id="eventsList">
                <!-- Events will be inserted here -->
            </div>
        </section>

        <div style="height: 100px;"></div>
    </div>

    <!-- Attractions View -->
    <div class="favorites-view" id="attractionsView">
        <header class="guest-header">
            <div class="logo">Kiek mol <span>in</span></div>
            <p class="tagline">Entdecke Ostfriesland</p>
        </header>

        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-number" id="statAttractions">0</div>
                <div class="stat-label">Ausflugsziele</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    <svg viewBox="0 0 24 24" fill="var(--warning)" width="24" height="24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </div>
                <div class="stat-label">Top bewertet</div>
            </div>
        </div>

        <section class="section">
            <div class="filter-chips" id="filterChipsAttractions">
                <div class="chip active" data-filter="all" onclick="setAttractionFilter('all')">Alle</div>
                <div class="chip" data-filter="natur" onclick="setAttractionFilter('natur')">Natur</div>
                <div class="chip" data-filter="museum" onclick="setAttractionFilter('museum')">Museen</div>
                <div class="chip" data-filter="historisch" onclick="setAttractionFilter('historisch')">Historisch</div>
                <div class="chip" data-filter="familie" onclick="setAttractionFilter('familie')">Familie</div>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Ausflugsziele</h2>
            </div>
            <div id="attractionsList">
                <!-- Attractions will be inserted here -->
            </div>
        </section>

        <div style="height: 100px;"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="showMainView()" id="navHome">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                <line x1="6" y1="1" x2="6" y2="4"/>
                <line x1="10" y1="1" x2="10" y2="4"/>
                <line x1="14" y1="1" x2="14" y2="4"/>
            </svg>
            <span data-i18n="navFood">Essen</span>
        </div>
        <div class="nav-item" onclick="showAccommodations()" id="navAccommodations">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 20v-8a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8"/>
                <path d="M4 10V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4"/>
                <rect x="6" y="12" width="4" height="4"/>
                <rect x="14" y="12" width="4" height="4"/>
            </svg>
            <span data-i18n="navSleep">Schlafen</span>
        </div>
        <div class="nav-item" onclick="showEvents()" id="navEvents">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <span data-i18n="navEvents">Events</span>
        </div>
        <div class="nav-item" onclick="showAttractions()" id="navAttractions">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="10" r="3"/>
                <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z"/>
            </svg>
            <span data-i18n="navDiscover">Entdecken</span>
        </div>
        <div class="nav-item" onclick="showJobs()" id="navJobs">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
            </svg>
            <span data-i18n="navJobs">Jobs</span>
        </div>
    </nav>
    
    <!-- Jobs View -->
    <div class="favorites-view" id="jobsView">
        <header class="guest-header">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div class="logo">Kiek mol <span>in</span></div>
            </div>
            <p class="tagline" data-i18n="jobsTagline">Jobs in Ostfriesland</p>
            
            <div class="location-bar" onclick="openModal('locationModal')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                <span id="currentLocationJobs">Greetsiel</span>
                <span class="change" data-i18n="change">Ändern ›</span>
            </div>
        </header>

        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-number" id="statJobsTotal">0</div>
                <div class="stat-label" data-i18n="jobsOpen">Offene Stellen</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statJobsUrgent">0</div>
                <div class="stat-label" data-i18n="jobsUrgent">Dringend</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statJobsRestaurants">0</div>
                <div class="stat-label" data-i18n="restaurants">Restaurants</div>
            </div>
        </div>
        
        <!-- Job Filter -->
        <div style="padding: 0 20px; margin-bottom: 16px;">
            <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px;">
                <button onclick="filterJobs('all')" id="filterJobsAll" class="filter-chip active" data-i18n="all">Alle</button>
                <button onclick="filterJobs('fulltime')" id="filterJobsFulltime" class="filter-chip" data-i18n="fulltime">Vollzeit</button>
                <button onclick="filterJobs('parttime')" id="filterJobsParttime" class="filter-chip" data-i18n="parttime">Teilzeit</button>
                <button onclick="filterJobs('minijob')" id="filterJobsMinijob" class="filter-chip" data-i18n="minijob">Minijob</button>
            </div>
        </div>

        <section class="section" style="padding: 0 20px;">
            <div class="section-header">
                <h2 class="section-title" data-i18n="currentJobs">Aktuelle Stellenangebote</h2>
            </div>

            <div id="jobsList">
                <!-- Jobs werden hier geladen -->
                <div style="text-align: center; padding: 40px; color: var(--slate);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 16px; opacity: 0.5;">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                    </svg>
                    <p data-i18n="loadingJobs">Jobs werden geladen...</p>
                </div>
            </div>
        </section>

        <div style="height: 100px;"></div>
    </div>
    
    <!-- KI Assistent Button -->
    <button onclick="openAssistant()" class="assistant-btn" id="assistantBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
        </svg>
    </button>
</div>

<!-- KI Assistent Chat -->
<div class="assistant-overlay" id="assistantOverlay">
    <div class="assistant-chat">
        <div class="assistant-header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="assistant-avatar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                        <path d="M12 2a4 4 0 0 1 4 4v2a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4z"/>
                        <path d="M16 14H8a4 4 0 0 0-4 4v2h16v-2a4 4 0 0 0-4-4z"/>
                    </svg>
                </div>
                <div>
                    <div style="font-weight: 700; color: var(--text-primary);">Kiek Assistent</div>
                    <div style="font-size: 12px; color: var(--success);">Online</div>
                </div>
            </div>
            <button onclick="closeAssistant()" style="background: none; border: none; cursor: pointer; padding: 8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-primary)" stroke-width="2" width="24" height="24">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        
        <div class="assistant-messages" id="assistantMessages">
            <div class="assistant-message bot">
                <div class="message-content">
                    Moin! Ich bin dein Kiek mol in Assistent. Wie kann ich dir helfen?
                </div>
            </div>
            <div class="assistant-suggestions" id="assistantSuggestions">
                <button onclick="askAssistant('Wo gibt es guten Fisch?')">Fisch-Restaurant</button>
                <button onclick="askAssistant('Welches Restaurant hat jetzt frei?')">Freie Tische</button>
                <button onclick="askAssistant('Was kann ich in Greetsiel machen?')">Ausflugstipps</button>
                <button onclick="askAssistant('Wie reserviere ich einen Tisch?')">Reservierung</button>
            </div>
        </div>
        
        <div class="assistant-input">
            <input type="text" id="assistantInput" placeholder="Schreib eine Nachricht..." onkeypress="if(event.key==='Enter')sendAssistantMessage()">
            <button onclick="sendAssistantMessage()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- ==================== DASHBOARD VIEW ==================== -->
<div class="dashboard-view" id="dashboardView">
    
    <aside class="dash-sidebar">
        <div class="dash-logo">
            <div class="logo">Kiek mol <span>in</span></div>
            <div class="restaurant-label">Admin Dashboard</div>
        </div>
        
        <!-- Abmelden Button - GANZ OBEN -->
        <div style="padding: 16px; border-bottom: 1px solid var(--sidebar-border);">
            <button onclick="adminLogout()" style="width: 100%; padding: 14px 16px; background: var(--sidebar-active); color: var(--sidebar-active-text); border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                <span style="font-weight: 700;">Abmelden</span>
            </button>
        </div>
        
        <nav class="dash-nav">
            <div class="dash-nav-item active" id="navDashboard" onclick="showDashboardSection('dashboard')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/>
                    <rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/>
                    <rect x="3" y="14" width="7" height="7"/>
                </svg>
                Dashboard
            </div>
            <div class="dash-nav-item" id="navReservations2">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Reservierungen
                <span class="nav-count" id="reservationCount">3</span>
            </div>
            <script>
            document.getElementById('navReservations2').addEventListener('click', function() {
                // Alle Sections verstecken
                document.querySelectorAll('.dash-section').forEach(function(s) {
                    s.classList.remove('active');
                    s.style.display = 'none';
                });
                // Reservierungen zeigen
                var resSection = document.getElementById('sectionReservations');
                if (resSection) {
                    resSection.classList.add('active');
                    resSection.style.display = 'block';
                }
                // Nav Item aktiv setzen
                document.querySelectorAll('.dash-nav-item').forEach(function(n) { n.classList.remove('active'); });
                this.classList.add('active');
                // Kalender und Restaurant initialisieren
                if (typeof initReservationCalendar === 'function') initReservationCalendar();
                if (typeof setupRestaurantDisplay === 'function') setupRestaurantDisplay('reservations');
            });
            </script>
            <div class="dash-nav-item" id="navOffers" onclick="showDashboardSection('offers')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
                Angebote
                <span class="nav-count" id="offerCount">1</span>
            </div>
            <div class="dash-nav-item" id="navAccommodationsDash" onclick="showDashboardSection('accommodationsDash')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M2 20v-8a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8"/>
                    <path d="M4 10V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4"/>
                    <path d="M2 20h20"/>
                    <rect x="6" y="12" width="4" height="4"/>
                    <rect x="14" y="12" width="4" height="4"/>
                </svg>
                Unterkünfte
                <span class="nav-count" id="accommodationCount">0</span>
            </div>
            <div class="dash-nav-item" id="navEventsDash" onclick="showDashboardSection('eventsDash')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Events
                <span class="nav-count" id="eventCount">0</span>
            </div>
            <div class="dash-nav-item" id="navAttractionsDash" onclick="showDashboardSection('attractionsDash')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="10" r="3"/>
                    <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z"/>
                </svg>
                Ausflugsziele
                <span class="nav-count" id="attractionCount">0</span>
            </div>
            <div class="dash-nav-item" id="navJobsDash" onclick="showDashboardSection('jobsDash')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                </svg>
                Jobs
                <span class="nav-count" id="jobCount">0</span>
            </div>
            <div class="dash-nav-item" id="navRestaurantsDash" onclick="showDashboardSection('restaurantsDash')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                    <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                    <line x1="6" y1="1" x2="6" y2="4"/>
                    <line x1="10" y1="1" x2="10" y2="4"/>
                    <line x1="14" y1="1" x2="14" y2="4"/>
                </svg>
                Restaurants
                <span class="nav-count" id="restaurantCountDash">0</span>
            </div>
            <div class="dash-nav-item" id="navOrders" onclick="showDashboardSection('orders')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                    <path d="M9 12h6M9 16h6"/>
                </svg>
                Bestellungen
                <span class="nav-count" id="ordersCountNav" style="background: #ef4444;">0</span>
            </div>
            <div class="dash-nav-item" id="navSpeisekarte2">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    <line x1="8" y1="7" x2="16" y2="7"/>
                    <line x1="8" y1="11" x2="14" y2="11"/>
                </svg>
                Speisekarte
                <span class="nav-count" id="menuItemCount">0</span>
            </div>
            <script>
            document.getElementById('navSpeisekarte2').addEventListener('click', function() {
                console.log('📋 Speisekarte Tab geklickt');
                
                // Alle Sections ausblenden
                document.querySelectorAll('.dash-section').forEach(function(s) {
                    s.classList.remove('active');
                    s.style.display = 'none';
                });
                
                // Speisekarte Section anzeigen
                var section = document.getElementById('sectionSpeisekarte');
                if (section) {
                    section.classList.add('active');
                    section.style.display = 'block';
                    console.log('✅ Section sichtbar');
                } else {
                    console.log('❌ Section nicht gefunden!');
                }
                
                // Nav aktiv setzen
                document.querySelectorAll('.dash-nav-item').forEach(function(n) { n.classList.remove('active'); });
                this.classList.add('active');
                
                // Restaurant-Dropdown direkt befüllen
                var select = document.getElementById('menuRestaurantSelect');
                var container = document.getElementById('menuRestaurantSelectContainer');
                
                if (container) {
                    container.style.display = 'block';
                    console.log('✅ Container sichtbar');
                }
                
                if (select) {
                    console.log('✅ Select gefunden, lade Restaurants...');
                    select.innerHTML = '<option value="">Restaurant auswählen...</option>';
                    
                    // Restaurants aus Supabase laden
                    fetch('https://mvrgmbdokdzmumdyezha.supabase.co/rest/v1/restaurants?select=id,name&order=name', {
                        headers: {
                            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12cmdtYmRva2R6bXVtZHllemhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjEyOTgsImV4cCI6MjA4MTEzNzI5OH0.7Ciwa2UKUHwtorvq3p6sN69XmVvPg0Kvg5lgrovxpDw',
                            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12cmdtYmRva2R6bXVtZHllemhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjEyOTgsImV4cCI6MjA4MTEzNzI5OH0.7Ciwa2UKUHwtorvq3p6sN69XmVvPg0Kvg5lgrovxpDw'
                        }
                    })
                    .then(function(response) {
                        console.log('📡 Response:', response.status);
                        return response.json();
                    })
                    .then(function(data) {
                        console.log('📡 Restaurants:', data);
                        if (data && data.length > 0) {
                            data.forEach(function(r) {
                                var opt = document.createElement('option');
                                opt.value = r.id;
                                opt.textContent = r.name;
                                select.appendChild(opt);
                            });
                            console.log('✅ ' + data.length + ' Restaurants geladen');
                            if (data.length === 1) { select.value = data[0].id; select.dispatchEvent(new Event('change')); }
                        } else {
                            var opt = document.createElement('option');
                            opt.value = '1';
                            opt.textContent = 'Demo Restaurant';
                            select.appendChild(opt);
                            console.log('⚠️ Keine Restaurants, Demo hinzugefügt');
                        }
                    })
                    .catch(function(err) {
                        console.log('❌ Fehler:', err);
                        var opt = document.createElement('option');
                        opt.value = '1';
                        opt.textContent = 'Demo Restaurant';
                        select.appendChild(opt);
                    });
                } else {
                    console.log('❌ Select nicht gefunden!');
                }
            });
            </script>
            <div class="dash-nav-item" id="navRewards" onclick="showDashboardSection('rewards')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="8" r="7"/>
                    <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
                </svg>
                Belohnungen
            </div>
            <div class="dash-nav-item" id="navStatistics" onclick="showDashboardSection('statistics')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Statistiken
            </div>
            <div class="dash-nav-item" id="navRevenue" onclick="showDashboardSection('revenue')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"/>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
                Umsatz
            </div>
            
            <!-- Design Button -->
            <div class="dash-nav-item" onclick="openModal('themeModal');">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                </svg>
                Design
            </div>
        </nav>
    </aside>

    <main class="dash-main">
        <header class="dash-header">
            <div>
                <h1 class="dash-greeting">Moin! </h1>
                <p class="dash-date" id="currentDate"></p>
                <p style="font-size: 12px; color: var(--success); margin-top: 4px;" id="connectionStatus">• Mit Supabase verbunden</p>
            </div>
            <div class="dash-actions">
                <button class="dash-btn dash-btn-secondary" onclick="refreshData()" title="Daten neu laden">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                        <path d="M21 3v5h-5"/>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                        <path d="M8 16H3v5"/>
                    </svg>
                    Aktualisieren
                </button>
                <button class="dash-btn dash-btn-secondary" onclick="openNewRestaurantModal()" title="Restaurant hinzufügen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                        <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                        <line x1="6" y1="1" x2="6" y2="4"/>
                        <line x1="10" y1="1" x2="10" y2="4"/>
                        <line x1="14" y1="1" x2="14" y2="4"/>
                    </svg>
                    Restaurant +
                </button>
                <button class="dash-btn dash-btn-primary" onclick="showDashboardSection('offers')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Angebot erstellen
                </button>
            </div>
        </header>

        <!-- DASHBOARD SECTION -->
        <div id="sectionDashboard" class="dash-section active">
            <!-- Connection Status Banner -->
            <div id="dashboardConnectionBanner" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--bg-card); border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="dbStatusDot" style="width: 10px; height: 10px; border-radius: 50%; background: #f59e0b;"></div>
                    <span id="dbStatusText" style="font-size: 14px; color: var(--slate);">Verbinde mit Supabase...</span>
                </div>
                <button onclick="retrySupabaseConnection()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M23 4v6h-6M1 20v-6h6"/>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                    Neu verbinden
                </button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="dashGuestsToday">0</div>
                    <div class="stat-box-label">Gäste heute via App</div>
                </div>
                
                <div class="stat-box" onclick="showDashboardSection('reservations')" style="cursor: pointer;">
                    <div class="stat-box-header">
                        <div class="stat-box-icon orange">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="dashReservationsToday">0</div>
                    <div class="stat-box-label">Reservierungen heute →</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="dashRevenue">0€</div>
                    <div class="stat-box-label">Umsatz (bezahlt)</div>
                </div>
                
                <div class="stat-box" onclick="showDashboardSection('offers')" style="cursor: pointer;">
                    <div class="stat-box-header">
                        <div class="stat-box-icon gold">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="dashOffersCount">1</div>
                    <div class="stat-box-label">Aktive Angebote →</div>
                </div>
            </div>

            <div class="panels-grid">
                <div class="panel">
                    <div class="panel-header">
                        <h3 class="panel-title">Tischübersicht</h3>
                    </div>
                    <div class="panel-content">
                        <div class="availability-control">
                            <div class="availability-status">
                                <div class="status-indicator" id="restaurantStatus"></div>
                                <span class="status-text" id="restaurantStatusText">Restaurant offen</span>
                            </div>
                            <div class="toggle-switch" id="restaurantToggle" onclick="toggleRestaurant()"></div>
                        </div>
                        <div class="table-grid" id="tableGrid">
                            <!-- Tables will be inserted here -->
                        </div>
                        <div class="table-legend">
                            <span class="legend-item"><span class="legend-dot free"></span> Frei</span>
                            <span class="legend-item"><span class="legend-dot occupied"></span> Besetzt</span>
                            <span class="legend-item"><span class="legend-dot reserved"></span> Reserviert</span>
                        </div>
                    </div>
                </div>

                <div class="panel" onclick="showDashboardSection('reservations')" style="cursor: pointer;">
                    <div class="panel-header">
                        <h3 class="panel-title">Nächste Reservierungen</h3>
                        <span style="color: var(--primary); font-size: 14px; font-weight: 600;">Alle anzeigen →</span>
                    </div>
                    <div class="panel-content" id="reservationsPreview">
                        <!-- Preview will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- RESERVATIONS SECTION -->
        <div id="sectionReservations" class="dash-section">
            <div class="section-back" onclick="showDashboardSection('dashboard')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Zurück zum Dashboard
            </div>
            
            <h2 class="section-page-title">Reservierungen & Tischplan</h2>
            
            <!-- Verbindungs-Status Banner -->
            <div id="resConnectionBanner" style="background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; border: 1px solid #bbf7d0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="resStatusDot" style="width: 10px; height: 10px; border-radius: 50%; background: #10b981; animation: pulse 2s infinite;"></div>
                    <span id="resStatusText" style="font-size: 13px; color: #166534; font-weight: 500;">
                        <span id="resCount">0</span> Reservierungen geladen
                    </span>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="window.resTestOnlineBooking();" style="padding: 6px 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
                        Test Online
                    </button>
                    <button onclick="window.resLoadReservations(); this.textContent='Lädt...';" style="padding: 6px 14px; background: white; color: var(--primary); border: 1px solid var(--primary); border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                        Aktualisieren
                    </button>
                </div>
            </div>
            
            <!-- Restaurant Anzeige für Reservierungen - KIN Design -->
            <div id="resRestaurantDisplay" style="background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 44px; height: 44px; background: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="22" height="22">
                            <path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: var(--slate);">Reservierungen für</div>
                        <select id="resRestaurantSelect" style="width: 100%; padding: 8px 0; font-size: 16px; font-weight: 700; color: var(--text-primary); background: transparent; border: none; cursor: pointer; outline: none;">
                            <option value="1">Greetsieler Börse</option>
                        </select>
                    </div>
                    <div style="background: #dcfce7; padding: 6px 12px; border-radius: 8px;">
                        <span style="color: #16a34a; font-size: 12px; font-weight: 600;">● Offen</span>
                    </div>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="reservation-tabs" style="display: flex; gap: 8px; margin: 20px 0; position: relative; z-index: 10;">
                <button type="button" class="res-tab-btn active" id="resTabBtnCalendar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    Kalender
                </button>
                <button type="button" class="res-tab-btn" id="resTabBtnFloorplan">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18">
                        <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/>
                    </svg>
                    Tischplan
                </button>
                <button type="button" class="res-tab-btn" id="resTabBtnList">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18">
                        <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>
                    </svg>
                    Liste
                </button>
            </div>
            <script>
            (function() {
                function switchResTab(tabName) {
                    // Alle Tabs deaktivieren
                    document.querySelectorAll('.res-tab-btn').forEach(function(b) { b.classList.remove('active'); });
                    document.querySelectorAll('.res-tab-content').forEach(function(c) { 
                        c.classList.remove('active'); 
                        c.style.display = 'none'; 
                    });
                    
                    // Gewählten Tab aktivieren
                    var tabContent = document.getElementById('resTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
                    if (tabContent) {
                        tabContent.classList.add('active');
                        tabContent.style.display = 'block';
                    }
                    
                    // Funktionen aufrufen
                    if (tabName === 'calendar' && typeof renderCalendar === 'function') {
                        renderCalendar();
                        if (typeof renderDayReservations === 'function') renderDayReservations();
                    }
                    if (tabName === 'floorplan' && typeof renderFloorplan === 'function') {
                        renderFloorplan();
                        if (typeof initFloorplanDragDrop === 'function') initFloorplanDragDrop();
                    }
                    if (tabName === 'list' && typeof renderReservationList === 'function') {
                        renderReservationList();
                    }
                }
                
                document.getElementById('resTabBtnCalendar').addEventListener('click', function() {
                    document.querySelectorAll('.res-tab-btn').forEach(function(b) { b.classList.remove('active'); });
                    this.classList.add('active');
                    switchResTab('calendar');
                });
                
                document.getElementById('resTabBtnFloorplan').addEventListener('click', function() {
                    document.querySelectorAll('.res-tab-btn').forEach(function(b) { b.classList.remove('active'); });
                    this.classList.add('active');
                    switchResTab('floorplan');
                });
                
                document.getElementById('resTabBtnList').addEventListener('click', function() {
                    document.querySelectorAll('.res-tab-btn').forEach(function(b) { b.classList.remove('active'); });
                    this.classList.add('active');
                    switchResTab('list');
                });
            })();
            </script>
            
            <!-- KALENDER TAB -->
            <div id="resTabCalendar" class="res-tab-content active" style="display: block;">
                <div class="panels-grid" style="grid-template-columns: 1fr 1.5fr;">
                    <!-- Kalender -->
                    <div class="panel">
                        <div class="panel-header">
                            <button type="button" class="cal-nav-btn" id="calPrevBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M15 18l-6-6 6-6"/></svg>
                            </button>
                            <h3 class="panel-title" id="calendarMonthYear">Januar 2026</h3>
                            <button type="button" class="cal-nav-btn" id="calNextBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M9 18l6-6-6-6"/></svg>
                            </button>
                        </div>
                        <div class="panel-content">
                            <div class="calendar-grid">
                                <div class="cal-header">Mo</div>
                                <div class="cal-header">Di</div>
                                <div class="cal-header">Mi</div>
                                <div class="cal-header">Do</div>
                                <div class="cal-header">Fr</div>
                                <div class="cal-header">Sa</div>
                                <div class="cal-header">So</div>
                            </div>
                            <div class="calendar-days" id="calendarDays">
                                <!-- Wird dynamisch gefüllt -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reservierungen des Tages -->
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                                    <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                <span id="selectedDateTitle">Heute</span>
                            </h3>
                            <button type="button" class="dash-btn dash-btn-primary" style="padding: 8px 16px;" id="openNewResBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Neue Reservierung
                            </button>
                            <button type="button" class="dash-btn" style="padding: 8px 12px;" onclick="window.resLoadReservations(); showToast('Daten werden neu geladen...', 'info');" title="Reservierungen neu laden">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                            </button>
                        </div>
                        <div class="panel-content">
                            <!-- Zeitslots -->
                            <div class="timeslot-grid" id="dayReservations">
                                <!-- Wird dynamisch gefüllt -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========== ECHTZEIT RESERVIERUNGS-SYSTEM MIT SUPABASE ========== -->
            <script>
            (function() {
                'use strict';
                
                // ===== SUPABASE KONFIGURATION =====
                var SUPABASE_URL = 'https://mvrgmbdokdzmumdyezha.supabase.co';
                var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12cmdtYmRva2R6bXVtZHllemhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjEyOTgsImV4cCI6MjA4MTEzNzI5OH0.7Ciwa2UKUHwtorvq3p6sN69XmVvPg0Kvg5lgrovxpDw';
                
                console.log('🚀 Reservierungs-System wird initialisiert...');
                console.log('📡 Supabase URL:', SUPABASE_URL);
                
                // ===== GLOBALE VARIABLEN =====
                window.resSelectedDate = new Date();
                window.resCurrentMonth = new Date();
                window.resAllReservations = []; // Wird von Supabase geladen
                window.resCurrentRestaurant = 1; // Standard Restaurant ID
                window.resLoading = false;
                
                // ===== SUPABASE API FUNKTIONEN =====
                
                // Reservierungen laden - ALLE aus Supabase (auch Online-Reservierungen)
                window.resLoadReservations = async function() {
                    if (window.resLoading) {
                        console.log('⏳ Laden bereits aktiv, überspringe...');
                        return;
                    }
                    window.resLoading = true;
                    console.log('🔄 Starte Laden der Reservierungen...');
                    
                    try {
                        // ALLE Reservierungen laden - OHNE Filter
                        var url = SUPABASE_URL + '/rest/v1/reservations?select=*&order=reservation_date.asc,reservation_time.asc';
                        
                        console.log('📡 Lade Reservierungen von:', url);
                        
                        var response = await fetch(url, {
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': 'Bearer ' + SUPABASE_KEY
                            }
                        });
                        
                        if (response.ok) {
                            var data = await response.json();
                            console.log('📦 Rohdaten von Supabase (' + data.length + ' Einträge):', data);
                            
                            // Clientseitig filtern: keine stornierten/no-show
                            var activeData = data.filter(function(r) {
                                return r.status !== 'cancelled' && r.status !== 'no_show';
                            });
                            console.log('📋 Aktive Reservierungen nach Filter:', activeData.length);
                            
                            window.resAllReservations = activeData.map(function(r) {
                                console.log('  → Reservierung:', r.id, r.guest_name, r.reservation_date, r.reservation_time, 'source:', r.source);
                                return {
                                    id: r.id,
                                    date: r.reservation_date,
                                    time: r.reservation_time,
                                    name: r.guest_name,
                                    persons: r.party_size || 2,
                                    phone: r.guest_phone || '',
                                    table: r.table_id || 1,
                                    notes: r.notes || '',
                                    status: r.status || 'confirmed',
                                    source: r.source || 'dashboard',
                                    restaurant_id: r.restaurant_id
                                };
                            });
                            
                            // Debug: Online-Reservierungen zählen
                            var onlineCount = window.resAllReservations.filter(function(r) { return r.source === 'app'; }).length;
                            var dashboardCount = window.resAllReservations.filter(function(r) { return r.source !== 'app'; }).length;
                            console.log('✅ ' + window.resAllReservations.length + ' Reservierungen geladen (' + onlineCount + ' Online, ' + dashboardCount + ' Dashboard)');
                            
                            // Auch APP_DATA synchronisieren für andere Teile der App
                            if (typeof APP_DATA !== 'undefined') {
                                APP_DATA.reservations = activeData.map(function(r) {
                                    return {
                                        id: r.id,
                                        restaurantId: r.restaurant_id,
                                        guestName: r.guest_name,
                                        guestPhone: r.guest_phone || '',
                                        date: r.reservation_date,
                                        time: r.reservation_time,
                                        partySize: r.party_size,
                                        notes: r.notes || '',
                                        status: r.status,
                                        source: r.source || 'app'
                                    };
                                });
                            }
                        } else {
                            var errorText = await response.text();
                            console.log('⚠️ Konnte Reservierungen nicht laden:', response.status, errorText);
                            window.resAllReservations = [];
                        }
                    } catch (e) {
                        console.log('❌ Fehler beim Laden:', e);
                        window.resAllReservations = [];
                    }
                    
                    window.resLoading = false;
                    
                    // Status-Banner aktualisieren
                    var countEl = document.getElementById('resCount');
                    var statusText = document.getElementById('resStatusText');
                    var statusDot = document.getElementById('resStatusDot');
                    var banner = document.getElementById('resConnectionBanner');
                    
                    if (countEl) countEl.textContent = window.resAllReservations.length;
                    
                    var onlineCount = window.resAllReservations.filter(function(r) { return r.source === 'app'; }).length;
                    if (statusText && onlineCount > 0) {
                        statusText.innerHTML = '<span id="resCount">' + window.resAllReservations.length + '</span> Reservierungen geladen <span style="color: #3b82f6;">(' + onlineCount + ' Online)</span>';
                    }
                    
                    if (window.resAllReservations.length > 0) {
                        if (banner) banner.style.background = 'linear-gradient(135deg, #f0fdf4, #ecfdf5)';
                        if (statusDot) statusDot.style.background = '#10b981';
                    } else {
                        if (banner) banner.style.background = 'linear-gradient(135deg, #fef3c7, #fef9c3)';
                        if (statusDot) statusDot.style.background = '#f59e0b';
                        if (statusText) statusText.innerHTML = 'Keine Reservierungen gefunden';
                    }
                    
                    // UI aktualisieren
                    window.resRenderCalendar();
                    window.resRenderDaySlots();
                    if (typeof window.renderFloorplanCalendar === 'function') window.renderFloorplanCalendar();
                    if (typeof window.updateFloorplanDisplay === 'function') window.updateFloorplanDisplay();
                };
                
                // Reservierung speichern
                window.resSaveToDatabase = async function(reservation) {
                    try {
                        var payload = {
                            restaurant_id: window.resCurrentRestaurant,
                            reservation_date: reservation.date,
                            reservation_time: reservation.time,
                            guest_name: reservation.name,
                            guest_phone: reservation.phone || null,
                            party_size: reservation.persons,
                            table_id: reservation.table,
                            notes: reservation.notes || null,
                            status: 'confirmed',
                            source: 'dashboard'
                        };
                        
                        var response = await fetch(
                            SUPABASE_URL + '/rest/v1/reservations',
                            {
                                method: 'POST',
                                headers: {
                                    'apikey': SUPABASE_KEY,
                                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                                    'Content-Type': 'application/json',
                                    'Prefer': 'return=representation'
                                },
                                body: JSON.stringify(payload)
                            }
                        );
                        
                        if (response.ok) {
                            var data = await response.json();
                            console.log('✅ Reservierung in Datenbank gespeichert:', data);
                            return data[0] || data;
                        } else {
                            var err = await response.text();
                            console.log('❌ Fehler beim Speichern:', err);
                            return null;
                        }
                    } catch (e) {
                        console.log('❌ Fehler:', e);
                        return null;
                    }
                };
                
                // Reservierung löschen
                window.resDeleteFromDatabase = async function(id) {
                    try {
                        var response = await fetch(
                            SUPABASE_URL + '/rest/v1/reservations?id=eq.' + id,
                            {
                                method: 'DELETE',
                                headers: {
                                    'apikey': SUPABASE_KEY,
                                    'Authorization': 'Bearer ' + SUPABASE_KEY
                                }
                            }
                        );
                        return response.ok;
                    } catch (e) {
                        console.log('❌ Fehler beim Löschen:', e);
                        return false;
                    }
                };
                
                // ===== KALENDER RENDERN =====
                window.resRenderCalendar = function() {
                    var container = document.getElementById('calendarDays');
                    var monthLabel = document.getElementById('calendarMonthYear');
                    if (!container) return;
                    
                    var year = window.resCurrentMonth.getFullYear();
                    var month = window.resCurrentMonth.getMonth();
                    var months = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                    
                    if (monthLabel) monthLabel.textContent = months[month] + ' ' + year;
                    
                    var firstDay = new Date(year, month, 1);
                    var lastDay = new Date(year, month + 1, 0);
                    var startDay = firstDay.getDay();
                    if (startDay === 0) startDay = 7;
                    startDay--;
                    
                    var html = '';
                    var prevMonth = new Date(year, month, 0);
                    
                    // Vorheriger Monat
                    for (var i = startDay - 1; i >= 0; i--) {
                        html += '<div class="cal-day other-month">' + (prevMonth.getDate() - i) + '</div>';
                    }
                    
                    // Aktueller Monat
                    var today = new Date();
                    var todayStr = today.toISOString().split('T')[0];
                    var selectedStr = window.resSelectedDate.toISOString().split('T')[0];
                    
                    for (var day = 1; day <= lastDay.getDate(); day++) {
                        var dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                        var isToday = dateStr === todayStr;
                        var isSelected = dateStr === selectedStr;
                        var hasRes = window.resAllReservations.some(function(r) { return r.date === dateStr; });
                        
                        var classes = 'cal-day';
                        if (isToday) classes += ' today';
                        if (isSelected) classes += ' selected';
                        if (hasRes) classes += ' has-reservations';
                        
                        html += '<div class="' + classes + '" data-date="' + dateStr + '">' + day + '</div>';
                    }
                    
                    // Nächster Monat
                    var totalCells = Math.ceil((startDay + lastDay.getDate()) / 7) * 7;
                    var remaining = totalCells - (startDay + lastDay.getDate());
                    for (var d = 1; d <= remaining; d++) {
                        html += '<div class="cal-day other-month">' + d + '</div>';
                    }
                    
                    container.innerHTML = html;
                    
                    // Click Events
                    container.querySelectorAll('.cal-day:not(.other-month)').forEach(function(el) {
                        el.addEventListener('click', function() {
                            window.resSelectDate(this.getAttribute('data-date'));
                        });
                    });
                };
                
                // ===== DATUM AUSWÄHLEN =====
                window.resSelectDate = function(dateStr) {
                    window.resSelectedDate = new Date(dateStr + 'T12:00:00');
                    window.resRenderCalendar();
                    window.resRenderDaySlots();
                    
                    // Titel aktualisieren
                    var titleEl = document.getElementById('selectedDateTitle');
                    if (titleEl) {
                        var options = { weekday: 'long', day: 'numeric', month: 'long' };
                        titleEl.textContent = window.resSelectedDate.toLocaleDateString('de-DE', options);
                    }
                    
                    // SYNC: Tischplan Datum auch setzen
                    window.fpSelectedDate = new Date(dateStr + 'T12:00:00');
                    if (typeof renderFloorplanCalendar === 'function') {
                        renderFloorplanCalendar();
                    }
                    if (typeof updateFloorplanDisplay === 'function') {
                        updateFloorplanDisplay();
                    }
                };
                
                // ===== MONAT WECHSELN =====
                window.resChangeMonth = function(delta) {
                    window.resCurrentMonth.setMonth(window.resCurrentMonth.getMonth() + delta);
                    window.resRenderCalendar();
                };
                
                // ===== TAGES-SLOTS RENDERN =====
                window.resRenderDaySlots = function() {
                    var container = document.getElementById('dayReservations');
                    if (!container) return;
                    
                    var dateStr = window.resSelectedDate.toISOString().split('T')[0];
                    var slots = ['11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', '20:00', '20:30', '21:00'];
                    
                    // Debug: zeige alle Reservierungen für dieses Datum
                    var dayRes = window.resAllReservations.filter(function(r) { return r.date === dateStr; });
                    console.log('📅 Kalender: Reservierungen für ' + dateStr + ':', dayRes.length, dayRes);
                    
                    var html = '';
                    slots.forEach(function(time) {
                        // Zeit normalisieren: "19:00:00" -> "19:00"
                        var res = window.resAllReservations.find(function(r) { 
                            var resTime = (r.time || '').substring(0, 5); // Nimm nur HH:MM
                            return r.date === dateStr && resTime === time; 
                        });
                        
                        if (res) {
                            console.log('✅ Kalender zeigt:', time, res.name);
                            // Online-Buchungen speziell markieren
                            var isOnline = res.source === 'app';
                            var bgColor = isOnline ? '#eff6ff' : '#f0fdf4';
                            var borderColor = isOnline ? '#3b82f6' : '#10b981';
                            var sourceIcon = isOnline ? '📱' : '';
                            var tableText = res.table && res.table !== 1 ? 'Tisch ' + res.table : (isOnline ? '<span style="color: #f59e0b;">⚠️ Tisch zuweisen!</span>' : 'Tisch 1');
                            
                            html += '<div class="timeslot has-reservation" data-res-id="' + res.id + '" style="cursor: pointer; background: ' + bgColor + '; border-left: 3px solid ' + borderColor + ';">';
                            html += '<div class="timeslot-time">' + time + '</div>';
                            html += '<div class="timeslot-info" style="flex: 1;">';
                            html += '<div class="timeslot-name">' + sourceIcon + ' ' + res.name + (isOnline ? ' <span style="font-size: 10px; color: #3b82f6;">(Online)</span>' : '') + '</div>';
                            html += '<div class="timeslot-details">' + res.persons + ' Pers. • ' + tableText;
                            if (res.phone) html += ' • ' + res.phone;
                            html += '</div></div>';
                            html += '<div style="display: flex; gap: 6px;">';
                            html += '<button onclick="event.stopPropagation(); window.resShowDetails(' + res.id + ');" class="dash-btn" style="padding: 6px 10px; font-size: 11px;">Details</button>';
                            html += '<button onclick="event.stopPropagation(); window.resEditReservation(' + res.id + ');" class="dash-btn" style="padding: 6px 10px; font-size: 11px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>';
                            html += '</div></div>';
                        } else {
                            html += '<div class="timeslot" data-time="' + time + '" data-date="' + dateStr + '">';
                            html += '<div class="timeslot-time">' + time + '</div>';
                            html += '<div class="timeslot-info"><span class="timeslot-empty">Frei - Klicken zum Reservieren</span></div>';
                            html += '</div>';
                        }
                    });
                    
                    // ZUSÄTZLICH: Reservierungen die NICHT in Standard-Slots sind auch anzeigen
                    dayRes.forEach(function(res) {
                        var resTime = (res.time || '').substring(0, 5);
                        if (slots.indexOf(resTime) === -1) {
                            // Diese Reservierung ist nicht in einem Standard-Slot
                            console.log('⚠️ Reservierung außerhalb Standard-Slots:', resTime, res.name);
                            var isOnline = res.source === 'app';
                            var bgColor = isOnline ? '#eff6ff' : '#f0fdf4';
                            var borderColor = isOnline ? '#3b82f6' : '#10b981';
                            
                            html += '<div class="timeslot has-reservation" data-res-id="' + res.id + '" style="cursor: pointer; background: ' + bgColor + '; border-left: 3px solid ' + borderColor + ';">';
                            html += '<div class="timeslot-time">' + resTime + '</div>';
                            html += '<div class="timeslot-info" style="flex: 1;">';
                            html += '<div class="timeslot-name">' + (isOnline ? '📱 ' : '') + res.name + (isOnline ? ' <span style="font-size: 10px; color: #3b82f6;">(Online)</span>' : '') + '</div>';
                            html += '<div class="timeslot-details">' + res.persons + ' Pers. • Tisch ' + res.table + '</div>';
                            html += '</div>';
                            html += '<button onclick="event.stopPropagation(); window.resShowDetails(' + res.id + ');" class="dash-btn" style="padding: 6px 10px; font-size: 11px;">Details</button>';
                            html += '</div>';
                        }
                    });
                    
                    container.innerHTML = html;
                    
                    // Click auf freie Slots
                    container.querySelectorAll('.timeslot:not(.has-reservation)').forEach(function(el) {
                        el.addEventListener('click', function() {
                            window.resQuickBook(this.getAttribute('data-date'), this.getAttribute('data-time'));
                        });
                    });
                    
                    // Click auf Reservierung für Details
                    container.querySelectorAll('.timeslot.has-reservation').forEach(function(el) {
                        el.addEventListener('click', function() {
                            var resId = parseInt(this.getAttribute('data-res-id'));
                            window.resShowDetails(resId);
                        });
                    });
                };
                
                // ===== RESERVIERUNG DETAILS ANZEIGEN =====
                window.resShowDetails = function(resId) {
                    var res = window.resAllReservations.find(function(r) { return r.id === resId; });
                    if (!res) return;
                    
                    var modal = document.getElementById('resDetailsModal');
                    if (!modal) {
                        // Modal erstellen - KIN DESIGN
                        var modalHtml = '<div class="modal-overlay" id="resDetailsModal" style="z-index: 10020; display: none;">' +
                            '<div class="modal-container" style="max-width: 480px;">' +
                            '<div class="modal-header">' +
                            '<h3 class="modal-title">Reservierung</h3>' +
                            '<button class="modal-close" onclick="document.getElementById(\'resDetailsModal\').style.display=\'none\'">×</button>' +
                            '</div>' +
                            '<div class="modal-body" id="resDetailsContent"></div>' +
                            '</div></div>';
                        document.body.insertAdjacentHTML('beforeend', modalHtml);
                        modal = document.getElementById('resDetailsModal');
                    }
                    
                    // KIN Design SVG Icons
                    var iconCheck = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="16" height="16"><polyline points="20 6 9 17 4 12"/></svg>';
                    var iconUserX = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></svg>';
                    var iconX = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
                    var iconEdit = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
                    var iconPhone = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>';
                    var iconTimer = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="13" r="8"/><path d="M12 9v4l2 2"/><path d="M5 3L2 6"/><path d="M22 6l-3-3"/><path d="M12 2v2"/></svg>';
                    
                    var timeStr = (res.time || '').substring(0, 5);
                    
                    // KIN DESIGN - Komplett neutral
                    var content = '<div style="padding: 8px 0;">' +
                        
                        // Name groß oben
                        '<div style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: 20px;">' + res.name + '</div>' +
                        
                        // Info Grid - 2x2
                        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">' +
                        '<div style="background: var(--bg-secondary); padding: 14px 16px; border-radius: 10px;">' +
                        '<div style="font-size: 10px; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Datum</div>' +
                        '<div style="font-size: 15px; font-weight: 600; color: var(--text-primary);">' + res.date + '</div>' +
                        '</div>' +
                        '<div style="background: var(--bg-secondary); padding: 14px 16px; border-radius: 10px;">' +
                        '<div style="font-size: 10px; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Uhrzeit</div>' +
                        '<div style="font-size: 15px; font-weight: 600; color: var(--text-primary);">' + timeStr + ' Uhr</div>' +
                        '</div>' +
                        '<div style="background: var(--bg-secondary); padding: 14px 16px; border-radius: 10px;">' +
                        '<div style="font-size: 10px; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Personen</div>' +
                        '<div style="font-size: 15px; font-weight: 600; color: var(--text-primary);">' + res.persons + ' Personen</div>' +
                        '</div>' +
                        '<div style="background: var(--bg-secondary); padding: 14px 16px; border-radius: 10px;">' +
                        '<div style="font-size: 10px; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Tisch</div>' +
                        '<div style="font-size: 15px; font-weight: 600; color: var(--text-primary);">Tisch ' + res.table + '</div>' +
                        '</div>' +
                        '</div>' +
                        
                        // Telefon
                        '<div style="background: var(--bg-secondary); padding: 14px 16px; border-radius: 10px; margin-bottom: 12px;">' +
                        '<div style="font-size: 10px; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Telefon</div>' +
                        '<div style="font-size: 15px; font-weight: 600; color: var(--text-primary);">' + (res.phone || 'Nicht angegeben') + '</div>' +
                        (res.phone ? '<a href="tel:' + res.phone + '" style="display: inline-flex; align-items: center; gap: 6px; margin-top: 8px; color: var(--primary); font-size: 13px; text-decoration: none;">' + iconPhone + ' Anrufen</a>' : '') +
                        '</div>' +
                        
                        // Anmerkungen - neutral
                        (res.notes ? '<div style="background: var(--bg-secondary); padding: 14px 16px; border-radius: 10px; margin-bottom: 16px;">' +
                        '<div style="font-size: 10px; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Anmerkungen</div>' +
                        '<div style="font-size: 14px; color: var(--text-primary);">' + res.notes + '</div>' +
                        '</div>' : '') +
                        
                        // Tischzeit planen
                        '<div style="margin-bottom: 16px;">' +
                        '<div style="display: flex; align-items: center; gap: 8px; font-size: 10px; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; font-weight: 600;">' + iconTimer + ' Tischzeit planen</div>' +
                        '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">' +
                        '<button onclick="window.resSetTableTime(' + res.id + ', 60);" class="kin-time-btn">1 Std</button>' +
                        '<button onclick="window.resSetTableTime(' + res.id + ', 90);" class="kin-time-btn">1,5 Std</button>' +
                        '<button onclick="window.resSetTableTime(' + res.id + ', 120);" class="kin-time-btn active">2 Std</button>' +
                        '<button onclick="window.resSetTableTime(' + res.id + ', 180);" class="kin-time-btn">3 Std</button>' +
                        '</div>' +
                        '</div>' +
                        
                        // Schnell-Aktionen - neutral
                        '<div style="margin-bottom: 16px;">' +
                        '<div style="font-size: 10px; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; font-weight: 600;">Schnell-Aktionen</div>' +
                        '<div style="display: flex; flex-direction: column; gap: 8px;">' +
                        '<button onclick="window.resMarkAsSeated(' + res.id + ', ' + res.table + '); document.getElementById(\'resDetailsModal\').style.display=\'none\';" style="display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 14px; font-size: 14px; font-weight: 600; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer;">' + iconCheck + ' Gast ist da</button>' +
                        '<button onclick="window.resMarkNoShow(' + res.id + '); document.getElementById(\'resDetailsModal\').style.display=\'none\';" style="display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 14px; font-size: 14px; font-weight: 500; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer;">' + iconUserX + ' No-Show</button>' +
                        '<button onclick="window.resCancelReservation(' + res.id + '); document.getElementById(\'resDetailsModal\').style.display=\'none\';" style="display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 14px; font-size: 14px; font-weight: 500; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer;">' + iconX + ' Stornieren</button>' +
                        '</div>' +
                        '</div>' +
                        
                        // Bearbeiten Button
                        '<button onclick="window.resEditReservation(' + res.id + ');" style="display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px; font-size: 13px; font-weight: 500; background: transparent; color: var(--slate); border: 1px dashed var(--border-color); border-radius: 10px; cursor: pointer;">' + iconEdit + ' Bearbeiten</button>' +
                        
                        '</div>';
                    
                    document.getElementById('resDetailsContent').innerHTML = content;
                    modal.style.display = 'flex';
                };
                
                // ===== RESERVIERUNG BEARBEITEN =====
                window.resEditReservation = function(resId) {
                    var res = window.resAllReservations.find(function(r) { return r.id === resId; });
                    if (!res) return;
                    
                    // Details Modal schließen
                    var detailsModal = document.getElementById('resDetailsModal');
                    if (detailsModal) detailsModal.style.display = 'none';
                    
                    // Edit Modal erstellen/öffnen
                    var modal = document.getElementById('resEditModal');
                    if (!modal) {
                        var modalHtml = '<div class="modal-overlay" id="resEditModal" style="z-index: 10025; display: none;">' +
                            '<div class="modal-container" style="max-width: 450px;">' +
                            '<div class="modal-header">' +
                            '<h3 class="modal-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="vertical-align: middle; margin-right: 8px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Reservierung bearbeiten</h3>' +
                            '<button class="modal-close" onclick="document.getElementById(\'resEditModal\').style.display=\'none\'">×</button>' +
                            '</div>' +
                            '<div class="modal-body">' +
                            '<input type="hidden" id="editResId">' +
                            '<div class="form-group"><label class="form-label">Name *</label><input type="text" id="editResName" class="form-input"></div>' +
                            '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">' +
                            '<div class="form-group"><label class="form-label">Datum *</label><input type="date" id="editResDate" class="form-input"></div>' +
                            '<div class="form-group"><label class="form-label">Uhrzeit *</label><input type="time" id="editResTime" class="form-input"></div>' +
                            '</div>' +
                            '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">' +
                            '<div class="form-group"><label class="form-label">Personen</label><select id="editResPersons" class="form-select"><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option></select></div>' +
                            '<div class="form-group"><label class="form-label">Tisch</label><select id="editResTable" class="form-select"><option value="1">Tisch 1</option><option value="2">Tisch 2</option><option value="3">Tisch 3</option><option value="4">Tisch 4</option><option value="5">Tisch 5</option><option value="6">Tisch 6</option><option value="7">Tisch 7</option><option value="8">Tisch 8</option><option value="9">Tisch 9</option></select></div>' +
                            '</div>' +
                            '<div class="form-group"><label class="form-label">Telefon</label><input type="tel" id="editResPhone" class="form-input"></div>' +
                            '<div class="form-group"><label class="form-label">Anmerkungen</label><textarea id="editResNotes" class="form-input" rows="2"></textarea></div>' +
                            '<div class="form-group"><label class="form-label">Status</label><select id="editResStatus" class="form-select"><option value="confirmed">Bestätigt</option><option value="pending">Ausstehend</option><option value="cancelled">Storniert</option></select></div>' +
                            '<div style="display: flex; gap: 12px; margin-top: 20px;">' +
                            '<button onclick="document.getElementById(\'resEditModal\').style.display=\'none\';" class="dash-btn" style="flex: 1;">Abbrechen</button>' +
                            '<button onclick="window.resSaveEdit();" class="dash-btn dash-btn-primary" style="flex: 2;">💾 Speichern</button>' +
                            '</div>' +
                            '</div></div></div>';
                        document.body.insertAdjacentHTML('beforeend', modalHtml);
                        modal = document.getElementById('resEditModal');
                    }
                    
                    // Felder füllen
                    document.getElementById('editResId').value = res.id;
                    document.getElementById('editResName').value = res.name;
                    document.getElementById('editResDate').value = res.date;
                    document.getElementById('editResTime').value = res.time;
                    document.getElementById('editResPersons').value = res.persons;
                    document.getElementById('editResTable').value = res.table;
                    document.getElementById('editResPhone').value = res.phone || '';
                    document.getElementById('editResNotes').value = res.notes || '';
                    document.getElementById('editResStatus').value = res.status || 'confirmed';
                    
                    modal.style.display = 'flex';
                };
                
                // ===== BEARBEITUNG SPEICHERN =====
                window.resSaveEdit = async function() {
                    var resId = parseInt(document.getElementById('editResId').value);
                    var updatedRes = {
                        name: document.getElementById('editResName').value.trim(),
                        date: document.getElementById('editResDate').value,
                        time: document.getElementById('editResTime').value,
                        persons: parseInt(document.getElementById('editResPersons').value),
                        table: parseInt(document.getElementById('editResTable').value),
                        phone: document.getElementById('editResPhone').value.trim(),
                        notes: document.getElementById('editResNotes').value.trim(),
                        status: document.getElementById('editResStatus').value
                    };
                    
                    if (!updatedRes.name || !updatedRes.date || !updatedRes.time) {
                        alert('Bitte Name, Datum und Uhrzeit ausfüllen!');
                        return;
                    }
                    
                    // In Supabase aktualisieren
                    try {
                        var response = await fetch(
                            SUPABASE_URL + '/rest/v1/reservations?id=eq.' + resId,
                            {
                                method: 'PATCH',
                                headers: {
                                    'apikey': SUPABASE_KEY,
                                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                                    'Content-Type': 'application/json',
                                    'Prefer': 'return=representation'
                                },
                                body: JSON.stringify({
                                    guest_name: updatedRes.name,
                                    reservation_date: updatedRes.date,
                                    reservation_time: updatedRes.time,
                                    party_size: updatedRes.persons,
                                    table_id: updatedRes.table,
                                    guest_phone: updatedRes.phone || null,
                                    notes: updatedRes.notes || null,
                                    status: updatedRes.status
                                })
                            }
                        );
                        
                        if (response.ok) {
                            console.log('✅ Reservierung aktualisiert');
                            
                            // Lokal aktualisieren
                            var idx = window.resAllReservations.findIndex(function(r) { return r.id === resId; });
                            if (idx !== -1) {
                                window.resAllReservations[idx] = Object.assign(window.resAllReservations[idx], updatedRes);
                            }
                            
                            // Modal schließen
                            document.getElementById('resEditModal').style.display = 'none';
                            
                            // UI aktualisieren
                            window.resRenderCalendar();
                            window.resRenderDaySlots();
                            if (typeof renderFloorplanCalendar === 'function') renderFloorplanCalendar();
                            if (typeof updateFloorplanDisplay === 'function') updateFloorplanDisplay();
                            
                            if (typeof showToast === 'function') {
                                showToast('✅ Reservierung aktualisiert!', 'success');
                            }
                        } else {
                            alert('Fehler beim Speichern: ' + await response.text());
                        }
                    } catch(e) {
                        console.log('Fehler:', e);
                        alert('Fehler beim Speichern');
                    }
                };
                
                // ===== RESERVIERUNG LÖSCHEN =====
                window.resDeleteReservation = async function(resId) {
                    if (!confirm('Reservierung wirklich löschen?')) return;
                    
                    try {
                        var response = await fetch(
                            SUPABASE_URL + '/rest/v1/reservations?id=eq.' + resId,
                            {
                                method: 'DELETE',
                                headers: {
                                    'apikey': SUPABASE_KEY,
                                    'Authorization': 'Bearer ' + SUPABASE_KEY
                                }
                            }
                        );
                        
                        if (response.ok) {
                            console.log('✅ Reservierung gelöscht');
                            
                            // Lokal entfernen
                            window.resAllReservations = window.resAllReservations.filter(function(r) { return r.id !== resId; });
                            
                            // Modals schließen
                            var detailsModal = document.getElementById('resDetailsModal');
                            if (detailsModal) detailsModal.style.display = 'none';
                            
                            // UI aktualisieren
                            window.resRenderCalendar();
                            window.resRenderDaySlots();
                            if (typeof renderFloorplanCalendar === 'function') renderFloorplanCalendar();
                            if (typeof updateFloorplanDisplay === 'function') updateFloorplanDisplay();
                            
                            if (typeof showToast === 'function') {
                                showToast('✅ Reservierung gelöscht!', 'success');
                            }
                        } else {
                            alert('Fehler beim Löschen');
                        }
                    } catch(e) {
                        console.log('Fehler:', e);
                        alert('Fehler beim Löschen');
                    }
                };
                
                // ===== SCHNELL-RESERVIERUNG =====
                window.resQuickBook = function(date, time) {
                    var modal = document.getElementById('newReservationModal');
                    if (modal) {
                        modal.style.display = 'flex';
                        var dateInput = document.getElementById('resDate');
                        var timeInput = document.getElementById('resTime');
                        if (dateInput) dateInput.value = date;
                        if (timeInput) timeInput.value = time;
                        if (timeInput) timeInput.value = time;
                    }
                };
                
                // ===== NEUE RESERVIERUNG SPEICHERN =====
                window.resSaveNew = async function() {
                    var date = document.getElementById('resDate').value;
                    var time = document.getElementById('resTime').value;
                    var name = document.getElementById('resName').value.trim();
                    var persons = document.getElementById('resPartySize').value;
                    var phone = document.getElementById('resPhone').value.trim();
                    var table = parseInt(document.getElementById('resTable').value) || 1;
                    var notes = document.getElementById('resNotes').value.trim();
                    
                    if (!date || !time || !name) {
                        alert('Bitte Datum, Uhrzeit und Name ausfüllen!');
                        return false;
                    }
                    
                    // ===== VERFÜGBARKEITSPRÜFUNG =====
                    if (typeof window.isTableAvailable === 'function' && !window.isTableAvailable(table, date, time)) {
                        var blockingRes = window.getTableReservations(table, date, time);
                        if (blockingRes.length > 0) {
                            var res = blockingRes[0];
                            alert('❌ Tisch ' + table + ' ist bereits reserviert!\n\nReservierung: ' + res.name + ' um ' + res.time + '\n\nBitte wählen Sie einen anderen Tisch oder eine andere Uhrzeit.');
                            return false;
                        }
                    }
                    
                    // Neue Reservierung erstellen
                    var newRes = {
                        date: date,
                        time: time,
                        name: name,
                        persons: parseInt(persons) || 2,
                        phone: phone,
                        table: table,
                        notes: notes,
                        source: 'dashboard'
                    };
                    
                    // In Supabase speichern
                    var savedRes = await window.resSaveToDatabase(newRes);
                    
                    if (savedRes) {
                        // Mit echter ID aus Datenbank
                        newRes.id = savedRes.id;
                        window.resAllReservations.push(newRes);
                        console.log('✅ Reservierung hinzugefügt, Array hat jetzt', window.resAllReservations.length, 'Einträge');
                        
                        // Modal schließen
                        document.getElementById('newReservationModal').style.display = 'none';
                        
                        // Formular leeren
                        document.getElementById('resName').value = '';
                        document.getElementById('resPhone').value = '';
                        document.getElementById('resNotes').value = '';
                        
                        // ALLE Ansichten aktualisieren (zentral)
                        if (typeof window.resRenderAll === 'function') {
                            window.resRenderAll();
                        } else {
                            window.resRenderCalendar();
                            window.resRenderDaySlots();
                        }
                        
                        // Bestätigung
                        if (typeof showToast === 'function') {
                            showToast('✅ Reservierung für ' + name + ' gespeichert!', 'success');
                        }
                        
                        return true;
                    } else {
                        // Fallback: lokal speichern wenn DB fehlschlägt
                        newRes.id = Date.now();
                        window.resAllReservations.push(newRes);
                        
                        document.getElementById('newReservationModal').style.display = 'none';
                        document.getElementById('resName').value = '';
                        document.getElementById('resPhone').value = '';
                        document.getElementById('resNotes').value = '';
                        
                        if (typeof window.resRenderAll === 'function') {
                            window.resRenderAll();
                        }
                        
                        if (typeof showToast === 'function') {
                            showToast('⚠️ Reservierung lokal gespeichert', 'warning');
                        }
                        return true;
                    }
                };
                
                // ===== EVENT LISTENERS =====
                document.addEventListener('DOMContentLoaded', function() {
                    // Kalender-Navigation
                    var prevBtn = document.getElementById('calPrevBtn');
                    var nextBtn = document.getElementById('calNextBtn');
                    if (prevBtn) prevBtn.addEventListener('click', function() { window.resChangeMonth(-1); });
                    if (nextBtn) nextBtn.addEventListener('click', function() { window.resChangeMonth(1); });
                    
                    // Neue Reservierung öffnen
                    var openBtn = document.getElementById('openNewResBtn');
                    if (openBtn) {
                        openBtn.addEventListener('click', function() {
                            var modal = document.getElementById('newReservationModal');
                            if (modal) {
                                modal.style.display = 'flex';
                                var dateInput = document.getElementById('resDate');
                                if (dateInput) dateInput.value = window.resSelectedDate.toISOString().split('T')[0];
                            }
                        });
                    }
                    
                    // Speichern Button im Modal
                    var saveBtn = document.getElementById('saveReservationBtn');
                    if (saveBtn) {
                        saveBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            window.resSaveNew();
                        });
                    }
                    
                    // Initial: Daten aus Supabase laden
                    setTimeout(function() {
                        window.resLoadReservations();
                        console.log('✅ Reservierungssystem initialisiert - lade Daten aus Supabase...');
                        
                        // Echtzeit-Listener starten
                        window.resStartRealtimeListener();
                    }, 500);
                });
                
                // Bei Section-Wechsel Daten neu laden
                var origShow = window.showDashboardSection;
                window.showDashboardSection = function(section) {
                    if (origShow) origShow(section);
                    if (section === 'reservations') {
                        // Immer frische Daten laden
                        window.resLoadReservations();
                    }
                };
                
                // ===== BENACHRICHTIGUNGS-SOUND =====
                window.resPlayNotificationSound = function() {
                    try {
                        // Erstelle einen Notification-Sound mit Web Audio API
                        var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        
                        // Erster Ton
                        var osc1 = audioCtx.createOscillator();
                        var gain1 = audioCtx.createGain();
                        osc1.connect(gain1);
                        gain1.connect(audioCtx.destination);
                        osc1.frequency.value = 880; // A5
                        osc1.type = 'sine';
                        gain1.gain.setValueAtTime(0.3, audioCtx.currentTime);
                        gain1.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                        osc1.start(audioCtx.currentTime);
                        osc1.stop(audioCtx.currentTime + 0.3);
                        
                        // Zweiter Ton (höher)
                        var osc2 = audioCtx.createOscillator();
                        var gain2 = audioCtx.createGain();
                        osc2.connect(gain2);
                        gain2.connect(audioCtx.destination);
                        osc2.frequency.value = 1174; // D6
                        osc2.type = 'sine';
                        gain2.gain.setValueAtTime(0.3, audioCtx.currentTime + 0.15);
                        gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                        osc2.start(audioCtx.currentTime + 0.15);
                        osc2.stop(audioCtx.currentTime + 0.5);
                        
                        // Dritter Ton (noch höher)
                        var osc3 = audioCtx.createOscillator();
                        var gain3 = audioCtx.createGain();
                        osc3.connect(gain3);
                        gain3.connect(audioCtx.destination);
                        osc3.frequency.value = 1318; // E6
                        osc3.type = 'sine';
                        gain3.gain.setValueAtTime(0.4, audioCtx.currentTime + 0.3);
                        gain3.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);
                        osc3.start(audioCtx.currentTime + 0.3);
                        osc3.stop(audioCtx.currentTime + 0.8);
                        
                    } catch(e) {
                        console.log('Sound nicht möglich:', e);
                    }
                };
                
                // ===== VISUELLE BENACHRICHTIGUNG =====
                window.resShowNewReservationAlert = function(reservation) {
                    // Sound abspielen
                    window.resPlayNotificationSound();
                    
                    // Browser-Notification (wenn erlaubt)
                    var sourceLabel = reservation.source === 'app' ? ' (Online-Buchung)' : '';
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('🍽️ Neue Reservierung!' + sourceLabel, {
                            body: reservation.name + ' - ' + reservation.persons + ' Personen\n' + reservation.date + ' um ' + reservation.time,
                            icon: '🍽️',
                            tag: 'new-reservation'
                        });
                    }
                    
                    // Farbe je nach Quelle
                    var bgColor = reservation.source === 'app' ? 'linear-gradient(135deg, #3b82f6, #1d4ed8)' : 'linear-gradient(135deg, #10b981, #059669)';
                    var shadowColor = reservation.source === 'app' ? 'rgba(59, 130, 246, 0.4)' : 'rgba(16, 185, 129, 0.4)';
                    var sourceText = reservation.source === 'app' ? '📱 Online-Buchung' : '🍽️ Neue Reservierung';
                    
                    // Visuelle Benachrichtigung im Dashboard
                    var alertHtml = '<div id="newResAlert" style="' +
                        'position: fixed; top: 20px; right: 20px; z-index: 99999; ' +
                        'background: ' + bgColor + '; ' +
                        'color: white; padding: 20px 24px; border-radius: 16px; ' +
                        'box-shadow: 0 10px 40px ' + shadowColor + '; ' +
                        'animation: slideInRight 0.5s ease, pulse 1s ease infinite; ' +
                        'max-width: 350px; cursor: pointer;">' +
                        '<div style="display: flex; align-items: center; gap: 12px;">' +
                        '<div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">🔔</div>' +
                        '<div>' +
                        '<div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;">' + sourceText + '</div>' +
                        '<div style="font-size: 18px; font-weight: 700; margin: 4px 0;">' + reservation.name + '</div>' +
                        '<div style="font-size: 14px; opacity: 0.9;">' + reservation.persons + ' Personen • ' + reservation.date + ' • ' + reservation.time + '</div>' +
                        '</div>' +
                        '</div>' +
                        '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 12px; text-align: center;">Klicken zum Schließen</div>' +
                        '</div>';
                    
                    // Animation CSS hinzufügen wenn nicht vorhanden
                    if (!document.getElementById('resAlertStyles')) {
                        var style = document.createElement('style');
                        style.id = 'resAlertStyles';
                        style.textContent = '@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } @keyframes pulse { 0%, 100% { box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 10px 60px rgba(16, 185, 129, 0.6); } }';
                        document.head.appendChild(style);
                    }
                    
                    // Alert einfügen
                    var alertDiv = document.createElement('div');
                    alertDiv.innerHTML = alertHtml;
                    document.body.appendChild(alertDiv.firstChild);
                    
                    // Click zum Schließen
                    document.getElementById('newResAlert').onclick = function() {
                        this.style.animation = 'slideInRight 0.3s ease reverse';
                        setTimeout(function() {
                            var el = document.getElementById('newResAlert');
                            if (el) el.remove();
                        }, 300);
                    };
                    
                    // Automatisch nach 10 Sekunden ausblenden
                    setTimeout(function() {
                        var el = document.getElementById('newResAlert');
                        if (el) {
                            el.style.animation = 'slideInRight 0.3s ease reverse';
                            setTimeout(function() { if (el) el.remove(); }, 300);
                        }
                    }, 10000);
                    
                    // Badge auf Dashboard aktualisieren
                    window.resUpdateDashboardBadge();
                };
                
                // ===== DASHBOARD BADGE =====
                window.resNewCount = 0;
                window.resUpdateDashboardBadge = function() {
                    window.resNewCount++;
                    var badge = document.getElementById('resDashboardBadge');
                    if (!badge) {
                        // Badge erstellen wenn nicht vorhanden
                        var statBox = document.querySelector('[onclick*="reservations"]');
                        if (statBox) {
                            statBox.style.position = 'relative';
                            var badgeHtml = '<div id="resDashboardBadge" style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; font-size: 12px; font-weight: 700; min-width: 24px; height: 24px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4); animation: pulse 1s ease infinite;">' + window.resNewCount + '</div>';
                            statBox.insertAdjacentHTML('beforeend', badgeHtml);
                        }
                    } else {
                        badge.textContent = window.resNewCount;
                        badge.style.display = 'flex';
                    }
                };
                
                // ===== ECHTZEIT-LISTENER =====
                window.resLastKnownIds = [];
                window.resPollingStartedAt = new Date().toISOString();
                window.resStartRealtimeListener = function() {
                    // Aktuelle IDs speichern (alle existierenden = bekannt)
                    window.resLastKnownIds = window.resAllReservations.map(function(r) { return r.id; });
                    
                    // Polling alle 15 Sekunden für neue Reservierungen
                    setInterval(async function() {
                        try {
                            // Nur Reservierungen die NACH dem Start erstellt wurden und nicht cancelled sind
                            var url = SUPABASE_URL + '/rest/v1/reservations?order=created_at.desc&limit=10&status=neq.cancelled&created_at=gte.' + window.resPollingStartedAt;
                            
                            var response = await fetch(url, {
                                headers: {
                                    'apikey': SUPABASE_KEY,
                                    'Authorization': 'Bearer ' + SUPABASE_KEY
                                }
                            });
                            
                            if (response.ok) {
                                var data = await response.json();
                                var hasNew = false;
                                
                                // Prüfe auf neue Reservierungen
                                data.forEach(function(r) {
                                    if (!window.resLastKnownIds.includes(r.id)) {
                                        hasNew = true;
                                        var sourceText = r.source === 'app' ? ' (Online)' : '';
                                        console.log('🆕 Neue Reservierung erkannt' + sourceText + ':', r);
                                        
                                        // Benachrichtigung zeigen
                                        window.resShowNewReservationAlert({
                                            id: r.id,
                                            name: r.guest_name,
                                            date: r.reservation_date,
                                            time: r.reservation_time,
                                            persons: r.party_size,
                                            phone: r.guest_phone,
                                            table: r.table_id || 1,
                                            source: r.source
                                        });
                                        
                                        // ID zu bekannten hinzufügen
                                        window.resLastKnownIds.push(r.id);
                                    }
                                });
                                
                                // UI aktualisieren wenn neue Daten
                                if (hasNew) {
                                    window.resLoadReservations();
                                }
                            }
                        } catch(e) {
                            console.log('Polling-Fehler:', e);
                        }
                    }, 10000); // Alle 10 Sekunden prüfen
                    
                    console.log('✅ Echtzeit-Listener gestartet (10s Polling für ALLE Reservierungen inkl. Online)');
                    
                    // Browser-Notification Berechtigung anfragen
                    if ('Notification' in window && Notification.permission === 'default') {
                        Notification.requestPermission();
                    }
                };
            })();
            </script>
            
            <!-- TISCHPLAN TAB -->
            <div id="resTabFloorplan" class="res-tab-content" style="display: none;">
                <div class="panels-grid" style="grid-template-columns: 250px 1fr 280px;">
                    
                    <!-- LINKE SPALTE: Mini-Kalender + Zeitslots -->
                    <div class="panel">
                        <div class="panel-header" style="padding: 12px;">
                            <button type="button" class="cal-nav-btn" onclick="changeFloorplanMonth(-1)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M15 18l-6-6 6-6"/></svg>
                            </button>
                            <h3 class="panel-title" id="floorplanMonthYear" style="font-size: 14px;">Januar 2026</h3>
                            <button type="button" class="cal-nav-btn" onclick="changeFloorplanMonth(1)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M9 18l6-6-6-6"/></svg>
                            </button>
                        </div>
                        <div class="panel-content" style="padding: 8px;">
                            <!-- Mini Kalender -->
                            <div class="mini-calendar">
                                <div class="mini-cal-header">
                                    <span>Mo</span><span>Di</span><span>Mi</span><span>Do</span><span>Fr</span><span>Sa</span><span>So</span>
                                </div>
                                <div class="mini-cal-days" id="floorplanCalendarDays">
                                    <!-- Wird gefüllt -->
                                </div>
                            </div>
                            
                            <!-- Ausgewähltes Datum -->
                            <div style="background: var(--cream); border-radius: 10px; padding: 12px; margin-top: 12px; text-align: center;">
                                <div style="font-size: 11px; color: var(--slate); text-transform: uppercase;">Ausgewählt</div>
                                <div id="floorplanSelectedDate" style="font-size: 16px; font-weight: 700; color: var(--dark);">Heute</div>
                            </div>
                            
                            <!-- Zeitslot Auswahl -->
                            <div style="margin-top: 12px;">
                                <div style="font-size: 11px; color: var(--slate); text-transform: uppercase; margin-bottom: 8px;">Uhrzeit</div>
                                <div class="timeslot-buttons" id="floorplanTimeSlots">
                                    <button type="button" class="time-btn active" data-time="11:00">11:00</button>
                                    <button type="button" class="time-btn" data-time="12:00">12:00</button>
                                    <button type="button" class="time-btn" data-time="13:00">13:00</button>
                                    <button type="button" class="time-btn" data-time="14:00">14:00</button>
                                    <button type="button" class="time-btn" data-time="17:00">17:00</button>
                                    <button type="button" class="time-btn" data-time="18:00">18:00</button>
                                    <button type="button" class="time-btn" data-time="19:00">19:00</button>
                                    <button type="button" class="time-btn" data-time="20:00">20:00</button>
                                    <button type="button" class="time-btn" data-time="21:00">21:00</button>
                                </div>
                            </div>
                            
                            <!-- Tisch-Statistik -->
                            <div id="floorplanStats" style="margin-top: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="display: flex; gap: 12px; font-size: 11px;">
                                    <span style="color: #10b981;">● 9 frei</span>
                                    <span style="color: #f59e0b;">● 0 reserviert</span>
                                </div>
                            </div>
                            
                            <!-- Reservierungen für Zeitslot -->
                            <div style="margin-top: 16px;">
                                <div style="font-size: 11px; color: var(--slate); text-transform: uppercase; margin-bottom: 8px;">Reservierungen heute</div>
                                <div id="floorplanReservationsList" style="max-height: 150px; overflow-y: auto;">
                                    <div style="color: var(--slate); font-size: 12px; text-align: center; padding: 10px;">Keine Reservierungen</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MITTE: Tischplan -->
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">Restaurant Grundriss</h3>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" onclick="toggleFloorplanEditMode()" class="dash-btn" id="fpEditBtn" style="padding: 6px 12px; font-size: 12px;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                    Bearbeiten
                                </button>
                                <button type="button" onclick="saveFloorplanChanges()" class="dash-btn dash-btn-primary" id="fpSaveBtn" style="padding: 6px 12px; font-size: 12px; display: none;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
                                    Speichern
                                </button>
                            </div>
                        </div>
                        <div class="panel-content" style="padding: 0; overflow: hidden;">
                            <div class="floorplan-container" id="floorplanContainer">
                                <div class="floorplan-grid" id="floorplanGrid">
                                    <!-- Eingang -->
                                    <div class="fp-element fp-entrance" style="left: 45%; top: 2%;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                        Eingang
                                    </div>
                                    <!-- Küche -->
                                    <div class="fp-element fp-kitchen" style="right: 2%; top: 40%;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3v7"/></svg>
                                        Küche
                                    </div>
                                    <!-- Pflanzen -->
                                    <div class="fp-element fp-plant" style="left: 3%; top: 3%;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="1.5" width="22" height="22"><path d="M12 12v10"/><path d="M12 12c2-5 7-6 9-4-1 5-6 6-9 4z"/><path d="M12 12c-2-5-7-6-9-4 1 5 6 6 9 4z"/></svg>
                                    </div>
                                    <div class="fp-element fp-plant" style="right: 3%; top: 3%;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="1.5" width="22" height="22"><path d="M12 12v10"/><path d="M12 12c2-5 7-6 9-4-1 5-6 6-9 4z"/><path d="M12 12c-2-5-7-6-9-4 1 5 6 6 9 4z"/></svg>
                                    </div>
                                    
                                    <!-- Tische -->
                                    <div class="fp-table fp-table-round available" style="left: 10%; top: 25%;" data-table="1" data-seats="2">
                                        <span class="table-number">1</span><span class="table-seats">2P</span>
                                    </div>
                                    <div class="fp-table fp-table-round available" style="left: 10%; top: 50%;" data-table="2" data-seats="2">
                                        <span class="table-number">2</span><span class="table-seats">2P</span>
                                    </div>
                                    <div class="fp-table fp-table-square available" style="left: 10%; top: 75%;" data-table="3" data-seats="4">
                                        <span class="table-number">3</span><span class="table-seats">4P</span>
                                    </div>
                                    <div class="fp-table fp-table-rect available" style="left: 35%; top: 30%;" data-table="4" data-seats="6">
                                        <span class="table-number">4</span><span class="table-seats">6P</span>
                                    </div>
                                    <div class="fp-table fp-table-rect available" style="left: 35%; top: 60%;" data-table="5" data-seats="6">
                                        <span class="table-number">5</span><span class="table-seats">6P</span>
                                    </div>
                                    <div class="fp-table fp-table-round available" style="left: 60%; top: 25%;" data-table="6" data-seats="4">
                                        <span class="table-number">6</span><span class="table-seats">4P</span>
                                    </div>
                                    <div class="fp-table fp-table-square available" style="left: 60%; top: 55%;" data-table="7" data-seats="4">
                                        <span class="table-number">7</span><span class="table-seats">4P</span>
                                    </div>
                                    <div class="fp-table fp-table-long available" style="left: 60%; top: 80%;" data-table="8" data-seats="8">
                                        <span class="table-number">8</span><span class="table-seats">8P</span>
                                    </div>
                                </div>
                                
                                <!-- Legende -->
                                <div class="floorplan-legend">
                                    <div class="legend-item"><span class="legend-dot available"></span> Frei</div>
                                    <div class="legend-item"><span class="legend-dot reserved"></span> Reserviert</div>
                                    <div class="legend-item"><span class="legend-dot occupied"></span> Besetzt</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RECHTE SPALTE: Tisch Details / Element Palette -->
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title" id="fpSidebarTitle">Tisch auswählen</h3>
                        </div>
                        <div class="panel-content" id="fpSidebarContent">
                            <!-- Standard: Tisch auswählen Hinweis -->
                            <div id="fpSelectHint" style="text-align: center; padding: 20px; color: var(--slate);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" width="48" height="48" style="opacity: 0.5; margin-bottom: 12px;">
                                    <circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/>
                                </svg>
                                <p style="font-size: 13px;">Klicke auf einen Tisch um Details zu sehen und zu reservieren</p>
                            </div>
                            
                            <!-- Tisch Details -->
                            <div id="fpTableDetails" style="display: none;">
                                <div style="background: var(--cream); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <span style="font-size: 20px; font-weight: 700;" id="fpDetailTableNum">Tisch 1</span>
                                        <span class="status-badge available" id="fpDetailStatus">Frei</span>
                                    </div>
                                    <div style="display: flex; gap: 16px; font-size: 13px; color: var(--slate);">
                                        <span>👥 <strong id="fpDetailSeats">2</strong> Plätze</span>
                                    </div>
                                </div>
                                
                                <!-- Aktuelle Reservierung - KIN DESIGN -->
                                <div id="fpCurrentReservation" style="display: none; background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border-color);">
                                    <div style="font-size: 10px; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600;">Reserviert</div>
                                    <div style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;" id="fpResName">Max Müller</div>
                                    <div style="font-size: 14px; color: var(--slate);" id="fpResTime">19:00 Uhr · 4 Personen</div>
                                </div>
                                
                                <!-- Schnell-Reservierung -->
                                <div style="border-top: 1px solid var(--border-color); padding-top: 16px;">
                                    <div style="font-size: 11px; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--slate);">Schnell-Reservierung</div>
                                    <input type="text" id="fpQuickName" placeholder="Name" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 8px; font-size: 14px; background: var(--bg-secondary); color: var(--text-primary);">
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                        <select id="fpQuickPersons" style="flex: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 14px; background: var(--bg-secondary); color: var(--text-primary);">
                                            <option value="1">1 Person</option>
                                            <option value="2" selected>2 Personen</option>
                                            <option value="3">3 Personen</option>
                                            <option value="4">4 Personen</option>
                                            <option value="5">5 Personen</option>
                                            <option value="6">6 Personen</option>
                                            <option value="7">7 Personen</option>
                                            <option value="8">8 Personen</option>
                                        </select>
                                    </div>
                                    <input type="tel" id="fpQuickPhone" placeholder="Telefon (optional)" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 12px; font-size: 14px; background: var(--bg-secondary); color: var(--text-primary);">
                                    <button type="button" onclick="if(typeof quickReserveTable==='function')quickReserveTable();" class="dash-btn dash-btn-primary" style="width: 100%; padding: 14px; font-size: 14px; font-weight: 600;">
                                        Jetzt reservieren
                                    </button>
                                </div>
                                
                                <!-- Tisch Aktionen -->
                                <div style="display: flex; gap: 8px; margin-top: 12px;">
                                    <button type="button" onclick="setTableStatus('occupied')" class="dash-btn" style="flex: 1; padding: 10px; font-size: 12px;">
                                        🔴 Besetzen
                                    </button>
                                    <button type="button" onclick="setTableStatus('available')" class="dash-btn" style="flex: 1; padding: 10px; font-size: 12px;">
                                        🟢 Freigeben
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Element Palette (Edit Mode) -->
                            <div id="fpElementPalette" style="display: none;">
                                <p style="font-size: 12px; color: var(--slate); margin-bottom: 12px;">Ziehe Elemente auf den Grundriss:</p>
                                
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 11px; color: var(--slate); text-transform: uppercase; margin-bottom: 8px;">Tische</div>
                                    <div class="element-palette-grid">
                                        <div class="palette-item" draggable="true" data-element="table-round-2">
                                            <div class="palette-preview table-round"></div>
                                            <span>Rund 2P</span>
                                        </div>
                                        <div class="palette-item" draggable="true" data-element="table-round-4">
                                            <div class="palette-preview table-round-lg"></div>
                                            <span>Rund 4P</span>
                                        </div>
                                        <div class="palette-item" draggable="true" data-element="table-square-4">
                                            <div class="palette-preview table-square"></div>
                                            <span>Quadrat 4P</span>
                                        </div>
                                        <div class="palette-item" draggable="true" data-element="table-rect-6">
                                            <div class="palette-preview table-rect"></div>
                                            <span>Rechteck 6P</span>
                                        </div>
                                        <div class="palette-item" draggable="true" data-element="table-long-8">
                                            <div class="palette-preview table-long"></div>
                                            <span>Lang 8P</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 11px; color: var(--slate); text-transform: uppercase; margin-bottom: 8px;">Dekoration</div>
                                    <div class="element-palette-grid">
                                        <div class="palette-item" draggable="true" data-element="plant">
                                            <div class="palette-preview">🌿</div>
                                            <span>Pflanze</span>
                                        </div>
                                        <div class="palette-item" draggable="true" data-element="divider">
                                            <div class="palette-preview divider"></div>
                                            <span>Wand</span>
                                        </div>
                                        <div class="palette-item" draggable="true" data-element="bar">
                                            <div class="palette-preview bar"></div>
                                            <span>Theke</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="font-size: 11px; color: var(--slate); text-transform: uppercase; margin-bottom: 8px;">Bereiche</div>
                                    <div class="element-palette-grid">
                                        <div class="palette-item" draggable="true" data-element="entrance">
                                            <div class="palette-preview">🚪</div>
                                            <span>Eingang</span>
                                        </div>
                                        <div class="palette-item" draggable="true" data-element="kitchen">
                                            <div class="palette-preview">👨‍🍳</div>
                                            <span>Küche</span>
                                        </div>
                                        <div class="palette-item" draggable="true" data-element="wc">
                                            <div class="palette-preview">🚻</div>
                                            <span>WC</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TISCHPLAN INTEGRIERTES SYSTEM SCRIPT -->
            <script>
            (function() {
                // GLOBALE Variablen für Synchronisation
                window.fpSelectedDate = new Date();
                window.fpSelectedTime = '18:00';
                window.fpSelectedTable = null;
                window.fpEditMode = false;
                window.fpCurrentMonth = new Date();
                
                // Lokale Referenzen
                var fpSelectedDate = window.fpSelectedDate;
                var fpSelectedTime = window.fpSelectedTime;
                var fpSelectedTable = window.fpSelectedTable;
                var fpEditMode = window.fpEditMode;
                var fpCurrentMonth = window.fpCurrentMonth;
                
                // Reservierungen - nutze globales Array wenn vorhanden
                function getFpReservations() {
                    if (typeof window.resAllReservations !== 'undefined') {
                        return window.resAllReservations;
                    }
                    return [];
                }
                
                // Reservierung hinzufügen - ruft das globale System auf
                async function addFpReservation(res) {
                    // Nutze das globale Speichersystem
                    if (typeof window.resSaveToDatabase === 'function') {
                        var savedRes = await window.resSaveToDatabase(res);
                        if (savedRes) {
                            res.id = savedRes.id;
                            // Zum Array hinzufügen - NUR HIER, nirgends sonst!
                            window.resAllReservations.push(res);
                            console.log('✅ Reservierung hinzugefügt, Array hat jetzt', window.resAllReservations.length, 'Einträge');
                        }
                    }
                    
                    // Alle Ansichten aktualisieren
                    window.resRenderAll();
                }
                
                // Zentrale Render-Funktion
                window.resRenderAll = function() {
                    console.log('🔄 resRenderAll aufgerufen - ' + window.resAllReservations.length + ' Reservierungen');
                    if (typeof window.resRenderCalendar === 'function') window.resRenderCalendar();
                    if (typeof window.resRenderDaySlots === 'function') window.resRenderDaySlots();
                    if (typeof window.renderFloorplanCalendar === 'function') window.renderFloorplanCalendar();
                    if (typeof updateFloorplanDisplay === 'function') updateFloorplanDisplay();
                };
                
                // DEBUG: Test-Reservierung erstellen (NUR LOKAL - zeigt sofort im Kalender)
                window.resTestOnlineBooking = function() {
                    console.log('🧪 Erstelle Test Online-Reservierung (lokal)...');
                    
                    // Nutze das aktuell ausgewählte Datum im Kalender
                    var selectedDate = window.resSelectedDate || new Date();
                    var dateStr = selectedDate.toISOString().split('T')[0];
                    var testId = Date.now();
                    
                    var localRes = {
                        id: testId,
                        date: dateStr,
                        time: '19:00',  // Exakt 5 Zeichen: HH:MM
                        name: 'Test Online ' + Math.floor(Math.random() * 1000),
                        persons: 4,
                        phone: '0123456789',
                        table: 1,
                        notes: 'Test-Buchung',
                        status: 'pending',
                        source: 'app',
                        restaurant_id: 1
                    };
                    
                    console.log('📅 Datum:', dateStr, 'Zeit:', localRes.time);
                    
                    // DIREKT zum Array hinzufügen
                    window.resAllReservations.push(localRes);
                    console.log('✅ Hinzugefügt:', localRes);
                    console.log('📊 Total Reservierungen:', window.resAllReservations.length);
                    console.log('📋 Alle Reservierungen:', window.resAllReservations);
                    
                    // UI aktualisieren
                    if (typeof window.resRenderAll === 'function') {
                        window.resRenderAll();
                        console.log('🔄 UI aktualisiert');
                    }
                    
                    // Status-Banner aktualisieren
                    var countEl = document.getElementById('resCount');
                    if (countEl) countEl.textContent = window.resAllReservations.length;
                    
                    alert('✅ Test-Reservierung erstellt!\n\nDatum: ' + dateStr + '\nZeit: 19:00\nName: ' + localRes.name + '\n\nSchau jetzt im Kalender!');
                    
                    return localRes;
                };
                
                console.log('💡 Tipp: Rufe window.resTestOnlineBooking() in der Konsole auf');
                
                function getTodayStr() {
                    var d = new Date();
                    return d.toISOString().split('T')[0];
                }
                
                function getTomorrowStr() {
                    var d = new Date();
                    d.setDate(d.getDate() + 1);
                    return d.toISOString().split('T')[0];
                }
                
                function formatDateDE(date) {
                    var days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
                    var months = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                    return days[date.getDay()] + ', ' + date.getDate() + '. ' + months[date.getMonth()];
                }
                
                // Mini-Kalender rendern
                window.renderFloorplanCalendar = function() {
                    var container = document.getElementById('floorplanCalendarDays');
                    if (!container) return;
                    
                    var reservations = getFpReservations();
                    var year = fpCurrentMonth.getFullYear();
                    var month = fpCurrentMonth.getMonth();
                    var firstDay = new Date(year, month, 1);
                    var lastDay = new Date(year, month + 1, 0);
                    var startDay = (firstDay.getDay() + 6) % 7;
                    
                    var months = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                    var monthYearEl = document.getElementById('floorplanMonthYear');
                    if (monthYearEl) monthYearEl.textContent = months[month] + ' ' + year;
                    
                    var html = '';
                    var today = new Date();
                    var todayStr = today.toISOString().split('T')[0];
                    // Nutze globale Variable für Synchronisation
                    var currentFpDate = window.fpSelectedDate || fpSelectedDate || new Date();
                    var selectedStr = currentFpDate.toISOString().split('T')[0];
                    
                    // Leere Tage am Anfang
                    for (var i = 0; i < startDay; i++) {
                        html += '<div class="mini-cal-day empty"></div>';
                    }
                    
                    // Tage des Monats
                    for (var day = 1; day <= lastDay.getDate(); day++) {
                        var dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                        var isToday = dateStr === todayStr;
                        var isSelected = dateStr === selectedStr;
                        var hasRes = reservations.some(function(r) { return r.date === dateStr; });
                        
                        var classes = 'mini-cal-day';
                        if (isToday) classes += ' today';
                        if (isSelected) classes += ' selected';
                        if (hasRes) classes += ' has-reservations';
                        
                        html += '<div class="' + classes + '" data-date="' + dateStr + '">' + day + '</div>';
                    }
                    
                    container.innerHTML = html;
                    
                    // Click Events
                    container.querySelectorAll('.mini-cal-day:not(.empty)').forEach(function(el) {
                        el.onclick = function() {
                            var dateStr = this.dataset.date;
                            // Lokale UND globale Variable setzen
                            fpSelectedDate = new Date(dateStr + 'T12:00:00');
                            window.fpSelectedDate = fpSelectedDate;
                            
                            renderFloorplanCalendar();
                            updateFloorplanDisplay();
                            
                            // SYNC: Hauptkalender auch aktualisieren
                            window.resSelectedDate = new Date(dateStr + 'T12:00:00');
                            if (typeof window.resRenderCalendar === 'function') {
                                window.resRenderCalendar();
                            }
                            if (typeof window.resRenderDaySlots === 'function') {
                                window.resRenderDaySlots();
                            }
                        };
                    });
                };
                
                window.changeFloorplanMonth = function(delta) {
                    fpCurrentMonth.setMonth(fpCurrentMonth.getMonth() + delta);
                    window.fpCurrentMonth = fpCurrentMonth;
                    renderFloorplanCalendar();
                    
                    // SYNC: Hauptkalender Monat auch ändern
                    if (typeof window.resCurrentMonth !== 'undefined') {
                        window.resCurrentMonth.setMonth(window.resCurrentMonth.getMonth() + delta);
                        if (typeof window.resRenderCalendar === 'function') {
                            window.resRenderCalendar();
                        }
                    }
                };
                
                // Zeitslot Buttons
                function initTimeSlots() {
                    document.querySelectorAll('#floorplanTimeSlots .time-btn').forEach(function(btn) {
                        btn.onclick = function() {
                            document.querySelectorAll('#floorplanTimeSlots .time-btn').forEach(function(b) { b.classList.remove('active'); });
                            this.classList.add('active');
                            fpSelectedTime = this.dataset.time;
                            window.fpSelectedTime = fpSelectedTime;
                            updateFloorplanDisplay();
                        };
                    });
                }
                
                // ===== PROFESSIONELLES VERFÜGBARKEITSSYSTEM =====
                
                // Reservierungsdauer in Minuten (Standard: 2 Stunden)
                var RESERVATION_DURATION = 120;
                
                // Zeit in Minuten umrechnen
                function timeToMinutes(timeStr) {
                    var parts = timeStr.split(':');
                    return parseInt(parts[0]) * 60 + parseInt(parts[1]);
                }
                
                // Prüfen ob zwei Zeitfenster überlappen
                function timesOverlap(time1, time2, duration) {
                    var start1 = timeToMinutes(time1);
                    var end1 = start1 + duration;
                    var start2 = timeToMinutes(time2);
                    var end2 = start2 + duration;
                    return start1 < end2 && start2 < end1;
                }
                
                // Prüfen ob Tisch für bestimmte Zeit verfügbar ist
                window.isTableAvailable = function(tableId, date, time) {
                    var allRes = getFpReservations();
                    var conflicting = allRes.filter(function(r) {
                        return r.date === date && 
                               r.table === tableId && 
                               timesOverlap(r.time, time, RESERVATION_DURATION);
                    });
                    return conflicting.length === 0;
                };
                
                // Alle verfügbaren Tische für bestimmte Zeit
                window.getAvailableTables = function(date, time) {
                    var allTables = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                    return allTables.filter(function(tableId) {
                        return window.isTableAvailable(tableId, date, time);
                    });
                };
                
                // Reservierungen die einen Tisch zu einer Zeit blockieren
                window.getTableReservations = function(tableId, date, time) {
                    var allRes = getFpReservations();
                    return allRes.filter(function(r) {
                        return r.date === date && 
                               r.table === tableId && 
                               timesOverlap(r.time, time, RESERVATION_DURATION);
                    });
                };
                
                // Display aktualisieren - GLOBAL & PROFESSIONELL
                window.updateFloorplanDisplay = function() {
                    // Nutze globale Variable für Synchronisation
                    var currentFpDate = window.fpSelectedDate || window.resSelectedDate || new Date();
                    var currentFpTime = window.fpSelectedTime || '18:00';
                    var dateStr = currentFpDate.toISOString().split('T')[0];
                    var todayStr = getTodayStr();
                    
                    // Datum anzeigen
                    var dateDisplay = document.getElementById('floorplanSelectedDate');
                    if (dateDisplay) {
                        if (dateStr === todayStr) {
                            dateDisplay.textContent = 'Heute, ' + formatDateDE(currentFpDate);
                        } else {
                            dateDisplay.textContent = formatDateDE(currentFpDate);
                        }
                    }
                    
                    // Reservierungen für diesen Tag - nutze globales Array
                    var allRes = getFpReservations();
                    var dayReservations = allRes.filter(function(r) { return r.date === dateStr; });
                    
                    // Online-Buchungen ohne Tisch zählen
                    var onlineWithoutTable = dayReservations.filter(function(r) { 
                        return r.source === 'app' && (!r.table || r.table === 1); 
                    }).length;
                    
                    // Statistik berechnen
                    var totalTables = 9;
                    var availableTables = window.getAvailableTables(dateStr, currentFpTime);
                    var reservedCount = totalTables - availableTables.length;
                    
                    // Statistik anzeigen - KIN Design
                    var statsEl = document.getElementById('floorplanStats');
                    if (statsEl) {
                        var statsHtml = '<div style="display: flex; gap: 16px; font-size: 12px; color: var(--text-secondary);">' +
                            '<span>' + availableTables.length + ' frei</span>' +
                            '<span>' + reservedCount + ' reserviert</span>' +
                            '<span>' + dayReservations.length + ' gesamt</span>';
                        
                        if (onlineWithoutTable > 0) {
                            statsHtml += '</div><div style="color: var(--slate); font-size: 11px; margin-top: 6px;">' + onlineWithoutTable + ' Online ohne Tisch</div>';
                        } else {
                            statsHtml += '</div>';
                        }
                        
                        statsEl.innerHTML = statsHtml;
                    }
                    
                    // Reservierungsliste für den Tag - KIN DESIGN
                    var listEl = document.getElementById('floorplanReservationsList');
                    if (listEl) {
                        if (dayReservations.length === 0) {
                            listEl.innerHTML = '<div style="color: var(--slate); font-size: 13px; text-align: center; padding: 20px;">Keine Reservierungen</div>';
                        } else {
                            // Nach Zeit sortieren
                            dayReservations.sort(function(a, b) { return a.time.localeCompare(b.time); });
                            
                            var html = '';
                            dayReservations.forEach(function(r) {
                                var isOnline = r.source === 'app';
                                var needsTable = isOnline && (!r.table || r.table === 1);
                                var timeStr = (r.time || '').substring(0, 5);
                                
                                html += '<div onclick="window.resShowDetails(' + r.id + ');" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; border: 1px solid var(--border-color);">';
                                
                                // Links: Zeit und Name
                                html += '<div style="display: flex; align-items: center; gap: 12px;">';
                                html += '<span style="font-size: 14px; font-weight: 600; color: var(--text-primary); min-width: 45px;">' + timeStr + '</span>';
                                html += '<div>';
                                html += '<div style="font-size: 14px; font-weight: 500; color: var(--text-primary);">' + r.name + '</div>';
                                if (isOnline) {
                                    html += '<div style="font-size: 11px; color: var(--slate); display: flex; align-items: center; gap: 4px;">' + KIN_ICONS.globe + ' Online</div>';
                                }
                                html += '</div>';
                                html += '</div>';
                                
                                // Rechts: Tisch Info oder Warnung
                                if (needsTable) {
                                    html += '<span style="display: flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 500; color: var(--primary); background: var(--bg-card); padding: 4px 10px; border-radius: 6px; border: 1px solid var(--primary);">' + KIN_ICONS.users + ' zuweisen</span>';
                                } else {
                                    html += '<span style="font-size: 12px; color: var(--slate);">T' + r.table + ' · ' + r.persons + 'P</span>';
                                }
                                
                                html += '</div>';
                            });
                            listEl.innerHTML = html;
                        }
                    }
                    
                    // Tisch-Status aktualisieren - PROFESSIONELL mit Zeitfenster-Prüfung
                    document.querySelectorAll('#floorplanGrid .fp-table').forEach(function(table) {
                        var tableId = parseInt(table.dataset.table);
                        var isAvailable = window.isTableAvailable(tableId, dateStr, currentFpTime);
                        var blockingRes = window.getTableReservations(tableId, dateStr, currentFpTime);
                        
                        table.classList.remove('available', 'reserved', 'occupied', 'blocked');
                        
                        if (!isAvailable && blockingRes.length > 0) {
                            table.classList.add('reserved');
                            // Tooltip mit Reservierungsinfo
                            var res = blockingRes[0];
                            table.title = 'Reserviert: ' + res.name + ' (' + res.time + ' - ' + res.persons + ' Pers.)';
                        } else {
                            table.classList.add('available');
                            table.title = 'Tisch ' + tableId + ' - Verfügbar';
                        }
                    });
                    
                    // Tisch Details aktualisieren wenn ausgewählt
                    if (fpSelectedTable) {
                        showTableDetails(fpSelectedTable);
                    }
                }
                
                // Tisch auswählen
                function selectTable(tableId) {
                    fpSelectedTable = tableId;
                    
                    // Visuell markieren
                    document.querySelectorAll('#floorplanGrid .fp-table').forEach(function(t) {
                        t.classList.remove('selected');
                    });
                    var el = document.querySelector('#floorplanGrid .fp-table[data-table="' + tableId + '"]');
                    if (el) el.classList.add('selected');
                    
                    showTableDetails(tableId);
                }
                
                // KIN Design SVG Icons
                var KIN_ICONS = {
                    check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="16" height="16"><polyline points="20 6 9 17 4 12"/></svg>',
                    clock: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
                    userX: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></svg>',
                    x: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
                    edit: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
                    phone: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
                    note: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
                    unlock: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',
                    users: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
                    globe: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>',
                    timer: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="13" r="8"/><path d="M12 9v4l2 2"/><path d="M5 3L2 6"/><path d="M22 6l-3-3"/><path d="M12 2v2"/></svg>'
                };
                
                // Tisch Details anzeigen - KIN DESIGN
                function showTableDetails(tableId) {
                    var tableEl = document.querySelector('#floorplanGrid .fp-table[data-table="' + tableId + '"]');
                    if (!tableEl) return;
                    
                    document.getElementById('fpSelectHint').style.display = 'none';
                    document.getElementById('fpTableDetails').style.display = 'block';
                    document.getElementById('fpSidebarTitle').textContent = 'Tisch ' + tableId;
                    
                    document.getElementById('fpDetailTableNum').textContent = 'Tisch ' + tableId;
                    document.getElementById('fpDetailSeats').textContent = tableEl.dataset.seats || '4';
                    
                    // Status - nutze globales Array mit Zeitfenster-Prüfung
                    var allRes = getFpReservations();
                    var statusEl = document.getElementById('fpDetailStatus');
                    var currentResEl = document.getElementById('fpCurrentReservation');
                    
                    var dateStr = (window.fpSelectedDate || fpSelectedDate).toISOString().split('T')[0];
                    var timeStr = window.fpSelectedTime || fpSelectedTime;
                    
                    // Finde Reservierung die diesen Tisch zu dieser Zeit blockiert
                    var blockingRes = window.getTableReservations ? window.getTableReservations(tableId, dateStr, timeStr) : [];
                    var res = blockingRes.length > 0 ? blockingRes[0] : null;
                    
                    if (res) {
                        statusEl.textContent = 'Reserviert';
                        statusEl.className = 'status-badge reserved';
                        currentResEl.style.display = 'block';
                        document.getElementById('fpResName').textContent = res.name;
                        document.getElementById('fpResTime').textContent = (res.time || '').substring(0,5) + ' Uhr · ' + res.persons + ' Personen';
                        
                        // ===== KIN DESIGN - Professionell & Minimalistisch =====
                        var detailsHtml = '<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">';
                        
                        // Telefon
                        if (res.phone) {
                            detailsHtml += '<a href="tel:' + res.phone + '" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 8px; text-decoration: none; color: var(--text-primary); transition: all 0.2s;">';
                            detailsHtml += KIN_ICONS.phone;
                            detailsHtml += '<span style="font-size: 14px; font-weight: 500;">' + res.phone + '</span>';
                            detailsHtml += '</a>';
                        }
                        
                        // Notizen
                        if (res.notes) {
                            detailsHtml += '<div style="display: flex; align-items: flex-start; gap: 10px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 8px;">';
                            detailsHtml += '<span style="color: var(--slate);">' + KIN_ICONS.note + '</span>';
                            detailsHtml += '<span style="font-size: 13px; color: var(--text-primary);">' + res.notes + '</span>';
                            detailsHtml += '</div>';
                        }
                        
                        // Status Badges - inline
                        detailsHtml += '<div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">';
                        
                        // Online Badge
                        if (res.source === 'app') {
                            detailsHtml += '<span style="display: inline-flex; align-items: center; gap: 4px; background: var(--bg-secondary); color: var(--text-primary); padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">' + KIN_ICONS.globe + ' Online</span>';
                        }
                        
                        // Status Badge
                        var statusText = res.status === 'confirmed' ? 'Bestätigt' : (res.status === 'pending' ? 'Ausstehend' : (res.status === 'seated' ? 'Platziert' : res.status || 'Neu'));
                        detailsHtml += '<span style="display: inline-flex; align-items: center; gap: 4px; background: var(--bg-secondary); color: var(--text-primary); padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">' + statusText + '</span>';
                        
                        detailsHtml += '</div>';
                        
                        // ===== ZEITPLANUNG - KIN Design =====
                        detailsHtml += '<div style="margin-bottom: 16px;">';
                        detailsHtml += '<div style="display: flex; align-items: center; gap: 6px; font-size: 10px; font-weight: 600; color: var(--slate); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">' + KIN_ICONS.timer + ' Tischzeit</div>';
                        detailsHtml += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;">';
                        detailsHtml += '<button onclick="window.resSetTableTime(' + res.id + ', 60);" class="kin-time-btn">1h</button>';
                        detailsHtml += '<button onclick="window.resSetTableTime(' + res.id + ', 90);" class="kin-time-btn">1.5h</button>';
                        detailsHtml += '<button onclick="window.resSetTableTime(' + res.id + ', 120);" class="kin-time-btn active">2h</button>';
                        detailsHtml += '<button onclick="window.resSetTableTime(' + res.id + ', 180);" class="kin-time-btn">3h</button>';
                        detailsHtml += '</div>';
                        detailsHtml += '</div>';
                        
                        // ===== AKTIONS-BUTTONS - KIN Design Komplett Neutral =====
                        detailsHtml += '<div style="display: flex; flex-direction: column; gap: 8px;">';
                        
                        // Gast ist da - Primary Action
                        detailsHtml += '<button onclick="window.resMarkAsSeated(' + res.id + ', ' + tableId + ');" style="display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 14px; font-size: 14px; font-weight: 600; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; transition: all 0.2s;">' + KIN_ICONS.check + ' Gast ist da</button>';
                        
                        // Secondary Actions Row - Alle Neutral
                        detailsHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">';
                        detailsHtml += '<button onclick="window.resMarkNoShow(' + res.id + ');" style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px; font-size: 13px; font-weight: 500; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s;">' + KIN_ICONS.userX + ' No-Show</button>';
                        detailsHtml += '<button onclick="window.resCancelReservation(' + res.id + ');" style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px; font-size: 13px; font-weight: 500; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s;">' + KIN_ICONS.x + ' Stornieren</button>';
                        detailsHtml += '</div>';
                        
                        // Bearbeiten
                        detailsHtml += '<button onclick="window.resEditReservation(' + res.id + ');" style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px; font-size: 13px; font-weight: 500; background: transparent; color: var(--slate); border: 1px dashed var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s;">' + KIN_ICONS.edit + ' Bearbeiten</button>';
                        
                        detailsHtml += '</div>';
                        detailsHtml += '</div>';
                        
                        // Extra Info Container
                        var extraInfo = document.getElementById('fpResExtraInfo');
                        if (!extraInfo) {
                            currentResEl.insertAdjacentHTML('beforeend', '<div id="fpResExtraInfo"></div>');
                            extraInfo = document.getElementById('fpResExtraInfo');
                        }
                        extraInfo.innerHTML = detailsHtml;
                        
                    } else if (tableEl.classList.contains('occupied')) {
                        statusEl.textContent = 'Besetzt';
                        statusEl.className = 'status-badge occupied';
                        currentResEl.style.display = 'block';
                        document.getElementById('fpResName').textContent = 'Walk-in Gast';
                        document.getElementById('fpResTime').textContent = 'Ohne Reservierung';
                        
                        // KIN Design Freigeben
                        var extraInfo = document.getElementById('fpResExtraInfo');
                        if (!extraInfo) {
                            currentResEl.insertAdjacentHTML('beforeend', '<div id="fpResExtraInfo"></div>');
                            extraInfo = document.getElementById('fpResExtraInfo');
                        }
                        extraInfo.innerHTML = '<div style="margin-top: 12px;"><button onclick="window.resReleaseTable(' + tableId + ');" class="kin-action-btn kin-action-success" style="width: 100%;">' + KIN_ICONS.unlock + ' Tisch freigeben</button></div>';
                        
                    } else {
                        statusEl.textContent = 'Frei';
                        statusEl.className = 'status-badge available';
                        currentResEl.style.display = 'none';
                        var extraInfo = document.getElementById('fpResExtraInfo');
                        if (extraInfo) extraInfo.innerHTML = '';
                    }
                    
                    // Personen-Auswahl auf Tisch-Kapazität setzen
                    var seats = parseInt(tableEl.dataset.seats) || 4;
                    document.getElementById('fpQuickPersons').value = Math.min(seats, 2);
                }
                
                // ===== ZEITPLANUNG FUNKTION =====
                window.resSetTableTime = function(resId, minutes) {
                    console.log('⏱️ Setze Tischzeit:', resId, minutes, 'Min.');
                    
                    // Lokal aktualisieren
                    var res = window.resAllReservations.find(function(r) { return r.id === resId; });
                    if (res) {
                        res.duration = minutes;
                        console.log('✅ Dauer gesetzt:', res);
                    }
                    
                    // Globale Dauer aktualisieren
                    if (typeof RESERVATION_DURATION !== 'undefined') {
                        RESERVATION_DURATION = minutes;
                    }
                    
                    // UI aktualisieren
                    if (typeof window.updateFloorplanDisplay === 'function') {
                        window.updateFloorplanDisplay();
                    }
                    if (typeof window.resRenderAll === 'function') {
                        window.resRenderAll();
                    }
                    
                    // Buttons visuell aktualisieren
                    document.querySelectorAll('.kin-time-btn').forEach(function(btn) {
                        btn.classList.remove('active');
                        if (btn.textContent.includes(minutes === 60 ? '1 Std' : (minutes === 90 ? '1,5' : (minutes === 120 ? '2 Std' : '3 Std')))) {
                            btn.classList.add('active');
                        }
                    });
                    
                    if (typeof showToast === 'function') {
                        showToast('Tischzeit auf ' + minutes + ' Min. gesetzt', 'success');
                    }
                    
                    // Optional: In Supabase speichern (im Hintergrund)
                    try {
                        fetch('https://mvrgmbdokdzmumdyezha.supabase.co/rest/v1/reservations?id=eq.' + resId, {
                            method: 'PATCH',
                            headers: {
                                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12cmdtYmRva2R6bXVtZHllemhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjEyOTgsImV4cCI6MjA4MTEzNzI5OH0.7Ciwa2UKUHwtorvq3p6sN69XmVvPg0Kvg5lgrovxpDw',
                                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12cmdtYmRva2R6bXVtZHllemhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjEyOTgsImV4cCI6MjA4MTEzNzI5OH0.7Ciwa2UKUHwtorvq3p6sN69XmVvPg0Kvg5lgrovxpDw',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ duration_minutes: minutes })
                        });
                    } catch(e) { console.log('Supabase sync optional:', e); }
                };
                
                // ===== RESERVIERUNG STORNIEREN =====
                window.resCancelReservation = function(resId) {
                    if (!confirm('Reservierung wirklich stornieren?\n\nDer Tisch wird wieder freigegeben.')) return;
                    
                    console.log('❌ Storniere Reservierung:', resId);
                    
                    // Aus lokalem Array entfernen
                    var oldLength = window.resAllReservations.length;
                    window.resAllReservations = window.resAllReservations.filter(function(r) { return r.id !== resId; });
                    console.log('📊 Reservierungen:', oldLength, '→', window.resAllReservations.length);
                    
                    // UI aktualisieren
                    if (typeof window.resRenderAll === 'function') {
                        window.resRenderAll();
                    }
                    if (typeof showTableDetails === 'function' && typeof fpSelectedTable !== 'undefined') {
                        showTableDetails(fpSelectedTable);
                    }
                    
                    // Modal schließen
                    var modal = document.getElementById('resDetailsModal');
                    if (modal) modal.style.display = 'none';
                    
                    if (typeof showToast === 'function') {
                        showToast('Reservierung storniert - Tisch freigegeben', 'success');
                    }
                    
                    // Optional: In Supabase speichern
                    try {
                        fetch('https://mvrgmbdokdzmumdyezha.supabase.co/rest/v1/reservations?id=eq.' + resId, {
                            method: 'PATCH',
                            headers: {
                                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12cmdtYmRva2R6bXVtZHllemhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjEyOTgsImV4cCI6MjA4MTEzNzI5OH0.7Ciwa2UKUHwtorvq3p6sN69XmVvPg0Kvg5lgrovxpDw',
                                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12cmdtYmRva2R6bXVtZHllemhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjEyOTgsImV4cCI6MjA4MTEzNzI5OH0.7Ciwa2UKUHwtorvq3p6sN69XmVvPg0Kvg5lgrovxpDw',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ status: 'cancelled' })
                        });
                    } catch(e) { console.log('Supabase sync optional:', e); }
                };
                
                // ===== NO-SHOW MARKIEREN =====
                window.resMarkNoShow = function(resId) {
                    if (!confirm('Gast als "Nicht erschienen" markieren?\n\nDer Tisch wird wieder freigegeben.')) return;
                    
                    console.log('⚠️ No-Show:', resId);
                    
                    // Aus lokalem Array entfernen
                    window.resAllReservations = window.resAllReservations.filter(function(r) { return r.id !== resId; });
                    
                    // UI aktualisieren
                    if (typeof window.resRenderAll === 'function') {
                        window.resRenderAll();
                    }
                    if (typeof showTableDetails === 'function' && typeof fpSelectedTable !== 'undefined') {
                        showTableDetails(fpSelectedTable);
                    }
                    
                    // Modal schließen
                    var modal = document.getElementById('resDetailsModal');
                    if (modal) modal.style.display = 'none';
                    
                    if (typeof showToast === 'function') {
                        showToast('No-Show markiert - Tisch freigegeben', 'warning');
                    }
                    
                    // Optional: In Supabase speichern
                    try {
                        fetch('https://mvrgmbdokdzmumdyezha.supabase.co/rest/v1/reservations?id=eq.' + resId, {
                            method: 'PATCH',
                            headers: {
                                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12cmdtYmRva2R6bXVtZHllemhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjEyOTgsImV4cCI6MjA4MTEzNzI5OH0.7Ciwa2UKUHwtorvq3p6sN69XmVvPg0Kvg5lgrovxpDw',
                                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12cmdtYmRva2R6bXVtZHllemhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjEyOTgsImV4cCI6MjA4MTEzNzI5OH0.7Ciwa2UKUHwtorvq3p6sN69XmVvPg0Kvg5lgrovxpDw',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ status: 'no_show' })
                        });
                    } catch(e) { console.log('Supabase sync optional:', e); }
                };
                
                // ===== GAST IST DA - TISCH BELEGEN =====
                window.resMarkAsSeated = function(resId, tableId) {
                    console.log('✅ Gast ist da:', resId, 'Tisch:', tableId);
                    
                    // Lokal aktualisieren
                    var res = window.resAllReservations.find(function(r) { return r.id === resId; });
                    if (res) {
                        res.status = 'seated';
                        console.log('✅ Status gesetzt:', res);
                    }
                    
                    // Tisch visuell als besetzt markieren
                    var tableEl = document.querySelector('#floorplanGrid .fp-table[data-table="' + tableId + '"]');
                    if (tableEl) {
                        tableEl.classList.remove('available', 'reserved');
                        tableEl.classList.add('occupied');
                    }
                    
                    // UI aktualisieren
                    if (typeof window.resRenderAll === 'function') {
                        window.resRenderAll();
                    }
                    if (typeof showTableDetails === 'function') {
                        showTableDetails(tableId);
                    }
                    
                    // Modal schließen
                    var modal = document.getElementById('resDetailsModal');
                    if (modal) modal.style.display = 'none';
                    
                    if (typeof showToast === 'function') {
                        showToast('Gast platziert - Tisch ' + tableId + ' besetzt', 'success');
                    }
                    
                    // Optional: In Supabase speichern
                    try {
                        fetch('https://mvrgmbdokdzmumdyezha.supabase.co/rest/v1/reservations?id=eq.' + resId, {
                            method: 'PATCH',
                            headers: {
                                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12cmdtYmRva2R6bXVtZHllemhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjEyOTgsImV4cCI6MjA4MTEzNzI5OH0.7Ciwa2UKUHwtorvq3p6sN69XmVvPg0Kvg5lgrovxpDw',
                                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12cmdtYmRva2R6bXVtZHllemhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjEyOTgsImV4cCI6MjA4MTEzNzI5OH0.7Ciwa2UKUHwtorvq3p6sN69XmVvPg0Kvg5lgrovxpDw',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ status: 'seated' })
                        });
                    } catch(e) { console.log('Supabase sync optional:', e); }
                };
                
                // ===== TISCH FREIGEBEN (Walk-in beendet) =====
                window.resReleaseTable = function(tableId) {
                    var tableEl = document.querySelector('#floorplanGrid .fp-table[data-table="' + tableId + '"]');
                    if (tableEl) {
                        tableEl.classList.remove('occupied', 'reserved');
                        tableEl.classList.add('available');
                    }
                    
                    // UI aktualisieren
                    if (typeof window.updateFloorplanDisplay === 'function') {
                        window.updateFloorplanDisplay();
                    }
                    showTableDetails(tableId);
                    
                    if (typeof showToast === 'function') {
                        showToast('🔓 Tisch ' + tableId + ' freigegeben', 'success');
                    }
                };
                
                // Schnell-Reservierung
                window.quickReserveTable = async function() {
                    if (!fpSelectedTable) {
                        if (typeof showToast === 'function') showToast('Bitte Tisch auswählen', 'error');
                        return;
                    }
                    
                    var name = document.getElementById('fpQuickName').value.trim();
                    if (!name) {
                        if (typeof showToast === 'function') showToast('Bitte Name eingeben', 'error');
                        return;
                    }
                    
                    var persons = parseInt(document.getElementById('fpQuickPersons').value);
                    var phone = document.getElementById('fpQuickPhone').value.trim();
                    var dateStr = (window.fpSelectedDate || fpSelectedDate).toISOString().split('T')[0];
                    var timeStr = window.fpSelectedTime || fpSelectedTime;
                    
                    // ===== VERFÜGBARKEITSPRÜFUNG =====
                    if (!window.isTableAvailable(fpSelectedTable, dateStr, timeStr)) {
                        var blockingRes = window.getTableReservations(fpSelectedTable, dateStr, timeStr);
                        if (blockingRes.length > 0) {
                            var res = blockingRes[0];
                            if (typeof showToast === 'function') {
                                showToast('❌ Tisch ' + fpSelectedTable + ' ist bereits reserviert! (' + res.name + ' um ' + res.time + ')', 'error');
                            } else {
                                alert('Tisch ' + fpSelectedTable + ' ist bereits reserviert für ' + res.name + ' um ' + res.time);
                            }
                            return;
                        }
                    }
                    
                    // Neue Reservierung - zum globalen Array UND Supabase hinzufügen
                    var newRes = {
                        date: dateStr,
                        time: timeStr,
                        name: name,
                        persons: persons,
                        table: fpSelectedTable,
                        phone: phone,
                        source: 'dashboard'
                    };
                    
                    await addFpReservation(newRes);
                    console.log('✅ Tischplan Reservierung gespeichert:', newRes);
                    
                    // Formular leeren
                    document.getElementById('fpQuickName').value = '';
                    document.getElementById('fpQuickPhone').value = '';
                    
                    // Alle Ansichten aktualisieren
                    window.renderFloorplanCalendar();
                    window.updateFloorplanDisplay();
                    if (typeof window.resRenderCalendar === 'function') window.resRenderCalendar();
                    if (typeof window.resRenderDaySlots === 'function') window.resRenderDaySlots();
                    
                    if (typeof showToast === 'function') {
                        showToast('✅ Reservierung für ' + name + ' auf Tisch ' + fpSelectedTable + ' gespeichert!', 'success');
                    }
                };
                
                // Tisch Status setzen
                window.setTableStatus = function(status) {
                    if (!fpSelectedTable) return;
                    
                    var tableEl = document.querySelector('#floorplanGrid .fp-table[data-table="' + fpSelectedTable + '"]');
                    if (!tableEl) return;
                    
                    tableEl.classList.remove('available', 'reserved', 'occupied');
                    tableEl.classList.add(status);
                    
                    showTableDetails(fpSelectedTable);
                    
                    if (typeof showToast === 'function') {
                        showToast('Tisch ' + fpSelectedTable + ' ' + (status === 'occupied' ? 'besetzt' : 'freigegeben'), 'success');
                    }
                };
                
                // Edit Mode
                window.toggleFloorplanEditMode = function() {
                    fpEditMode = !fpEditMode;
                    
                    document.getElementById('fpEditBtn').style.display = fpEditMode ? 'none' : 'block';
                    document.getElementById('fpSaveBtn').style.display = fpEditMode ? 'block' : 'none';
                    document.getElementById('fpSelectHint').style.display = fpEditMode ? 'none' : (fpSelectedTable ? 'none' : 'block');
                    document.getElementById('fpTableDetails').style.display = fpEditMode ? 'none' : (fpSelectedTable ? 'block' : 'none');
                    document.getElementById('fpElementPalette').style.display = fpEditMode ? 'block' : 'none';
                    document.getElementById('fpSidebarTitle').textContent = fpEditMode ? 'Elemente' : (fpSelectedTable ? 'Tisch ' + fpSelectedTable : 'Tisch auswählen');
                    
                    if (fpEditMode) {
                        initDragDrop();
                        if (typeof showToast === 'function') showToast('Bearbeitungsmodus aktiv', 'info');
                    }
                };
                
                window.saveFloorplanChanges = function() {
                    fpEditMode = false;
                    document.getElementById('fpEditBtn').style.display = 'block';
                    document.getElementById('fpSaveBtn').style.display = 'none';
                    document.getElementById('fpElementPalette').style.display = 'none';
                    document.getElementById('fpSelectHint').style.display = fpSelectedTable ? 'none' : 'block';
                    document.getElementById('fpTableDetails').style.display = fpSelectedTable ? 'block' : 'none';
                    
                    if (typeof showToast === 'function') showToast('Tischplan gespeichert!', 'success');
                };
                
                // Drag & Drop
                function initDragDrop() {
                    var grid = document.getElementById('floorplanGrid');
                    var items = document.querySelectorAll('#fpElementPalette .palette-item');
                    
                    items.forEach(function(item) {
                        item.ondragstart = function(e) {
                            e.dataTransfer.setData('element', this.dataset.element);
                            this.style.opacity = '0.5';
                        };
                        item.ondragend = function() {
                            this.style.opacity = '1';
                        };
                    });
                    
                    grid.ondragover = function(e) {
                        e.preventDefault();
                        this.style.background = 'rgba(26, 95, 74, 0.1)';
                    };
                    
                    grid.ondragleave = function() {
                        this.style.background = '';
                    };
                    
                    grid.ondrop = function(e) {
                        e.preventDefault();
                        this.style.background = '';
                        
                        var type = e.dataTransfer.getData('element');
                        if (!type) return;
                        
                        var rect = this.getBoundingClientRect();
                        var x = ((e.clientX - rect.left) / rect.width) * 100;
                        var y = ((e.clientY - rect.top) / rect.height) * 100;
                        
                        addNewElement(type, x, y);
                    };
                }
                
                function addNewElement(type, x, y) {
                    var grid = document.getElementById('floorplanGrid');
                    var el = document.createElement('div');
                    var newId = document.querySelectorAll('.fp-table').length + 1;
                    
                    if (type.indexOf('table') === 0) {
                        var parts = type.split('-');
                        var shape = parts[1];
                        var seats = parts[2] || '4';
                        
                        var cls = 'fp-table-round';
                        if (shape === 'square') cls = 'fp-table-square';
                        if (shape === 'rect') cls = 'fp-table-rect';
                        if (shape === 'long') cls = 'fp-table-long';
                        
                        el.className = 'fp-table ' + cls + ' available';
                        el.dataset.table = newId;
                        el.dataset.seats = seats;
                        el.innerHTML = '<span class="table-number">' + newId + '</span><span class="table-seats">' + seats + 'P</span>';
                    } else if (type === 'plant') {
                        el.className = 'fp-element fp-plant';
                        el.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="1.5" width="22" height="22"><path d="M12 12v10"/><path d="M12 12c2-5 7-6 9-4-1 5-6 6-9 4z"/><path d="M12 12c-2-5-7-6-9-4 1 5 6 6 9 4z"/></svg>';
                    } else if (type === 'divider') {
                        el.className = 'fp-element fp-divider';
                        el.style.width = '80px';
                        el.innerHTML = '<div class="divider-line"></div>';
                    } else if (type === 'bar') {
                        el.className = 'fp-element';
                        el.style.cssText = 'background:linear-gradient(135deg,#92400e,#78350f);color:white;padding:8px 20px;border-radius:6px;font-size:11px;font-weight:600;border:2px solid #78350f;';
                        el.textContent = 'Theke';
                    } else if (type === 'entrance') {
                        el.className = 'fp-element fp-entrance';
                        el.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Eingang';
                    } else if (type === 'kitchen') {
                        el.className = 'fp-element fp-kitchen';
                        el.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3v7"/></svg>Küche';
                    } else if (type === 'wc') {
                        el.className = 'fp-element';
                        el.style.cssText = 'background:linear-gradient(135deg,#e0f2fe,#bae6fd);padding:8px 12px;border-radius:6px;font-size:11px;font-weight:600;border:2px solid #0ea5e9;color:#0369a1;';
                        el.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16" style="margin-right:4px;"><circle cx="9" cy="6" r="2"/><path d="M9 11v8"/><circle cx="15" cy="6" r="2"/><path d="M15 11v8"/></svg>WC';
                    }
                    
                    el.style.position = 'absolute';
                    el.style.left = x + '%';
                    el.style.top = y + '%';
                    
                    grid.appendChild(el);
                    makeMovable(el);
                    
                    // Tisch klickbar machen
                    if (el.classList.contains('fp-table')) {
                        el.onclick = function() {
                            if (!fpEditMode) selectTable(parseInt(this.dataset.table));
                        };
                    }
                    
                    if (typeof showToast === 'function') showToast('Element hinzugefügt', 'success');
                }
                
                function makeMovable(el) {
                    var dragging = false, startX, startY, origX, origY;
                    
                    el.style.cursor = 'move';
                    
                    el.onmousedown = function(e) {
                        if (!fpEditMode) return;
                        dragging = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        origX = parseFloat(el.style.left) || 0;
                        origY = parseFloat(el.style.top) || 0;
                        el.style.zIndex = '999';
                        e.preventDefault();
                    };
                    
                    document.addEventListener('mousemove', function(e) {
                        if (!dragging) return;
                        var grid = document.getElementById('floorplanGrid');
                        var rect = grid.getBoundingClientRect();
                        var dx = ((e.clientX - startX) / rect.width) * 100;
                        var dy = ((e.clientY - startY) / rect.height) * 100;
                        el.style.left = Math.max(0, Math.min(90, origX + dx)) + '%';
                        el.style.top = Math.max(0, Math.min(90, origY + dy)) + '%';
                    });
                    
                    document.addEventListener('mouseup', function() {
                        if (dragging) {
                            dragging = false;
                            el.style.zIndex = '';
                        }
                    });
                }
                
                // Tisch Click Events
                function initTableClicks() {
                    document.querySelectorAll('#floorplanGrid .fp-table').forEach(function(table) {
                        table.onclick = function() {
                            if (!fpEditMode) {
                                selectTable(parseInt(this.dataset.table));
                            }
                        };
                        makeMovable(table);
                    });
                    
                    document.querySelectorAll('#floorplanGrid .fp-element').forEach(function(el) {
                        makeMovable(el);
                    });
                }
                
                // Initialisierung
                function init() {
                    renderFloorplanCalendar();
                    initTimeSlots();
                    initTableClicks();
                    updateFloorplanDisplay();
                    console.log('✅ Tischplan-System initialisiert');
                }
                
                // Starten wenn Tab sichtbar wird
                setTimeout(init, 500);
                
                document.addEventListener('click', function(e) {
                    if (e.target.closest('#resTabBtnFloorplan') || (e.target.textContent && e.target.textContent.indexOf('Tischplan') > -1)) {
                        setTimeout(init, 200);
                    }
                });
            })();
            </script>
            
            <!-- LISTE TAB -->
            <div id="resTabList" class="res-tab-content" style="display: none;">
                <div class="panel">
                    <div class="panel-header">
                        <h3 class="panel-title">Alle Reservierungen</h3>
                        <div style="display: flex; gap: 8px;">
                            <select class="form-select" id="listFilterDate" onchange="filterReservationList()" style="width: auto;">
                                <option value="today">Heute</option>
                                <option value="tomorrow">Morgen</option>
                                <option value="week">Diese Woche</option>
                                <option value="all">Alle</option>
                            </select>
                            <button onclick="document.getElementById('newReservationModal').style.display='flex';" class="dash-btn dash-btn-primary" style="padding: 8px 16px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Neue
                            </button>
                        </div>
                    </div>
                    <div class="panel-content" style="padding: 0;">
                        <table class="reservation-table">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Uhrzeit</th>
                                    <th>Name</th>
                                    <th>Personen</th>
                                    <th>Tisch</th>
                                    <th>Status</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="reservationTableBody">
                                <!-- Wird dynamisch gefüllt -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Neue Reservierung Modal -->
        <div class="modal-overlay" id="newReservationModal" style="z-index: 10010; display: none;">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 class="modal-title" style="font-family: 'Playfair Display', serif;">Neue Reservierung</h2>
                    <button class="modal-close" onclick="closeModal('newReservationModal')">×</button>
                </div>
                <div class="modal-body">
                    <div id="newReservationForm">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Datum *</label>
                                <input type="date" class="form-input" id="resDate" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Uhrzeit *</label>
                                <select class="form-select" id="resTime" required>
                                    <option value="">Wählen...</option>
                                    <option value="11:00">11:00</option>
                                    <option value="11:30">11:30</option>
                                    <option value="12:00">12:00</option>
                                    <option value="12:30">12:30</option>
                                    <option value="13:00">13:00</option>
                                    <option value="13:30">13:30</option>
                                    <option value="17:00">17:00</option>
                                    <option value="17:30">17:30</option>
                                    <option value="18:00">18:00</option>
                                    <option value="18:30">18:30</option>
                                    <option value="19:00">19:00</option>
                                    <option value="19:30">19:30</option>
                                    <option value="20:00">20:00</option>
                                    <option value="20:30">20:30</option>
                                    <option value="21:00">21:00</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label class="form-label">Name *</label>
                                <input type="text" class="form-input" id="resName" required placeholder="Name des Gastes">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Personen *</label>
                                <select class="form-select" id="resPartySize" required>
                                    <option value="1">1</option>
                                    <option value="2" selected>2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10+</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefon</label>
                            <input type="tel" class="form-input" id="resPhone" placeholder="Für Rückfragen">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tisch zuweisen</label>
                            <select class="form-select" id="resTable">
                                <option value="">Automatisch</option>
                                <option value="1">Tisch 1 (2P)</option>
                                <option value="2">Tisch 2 (2P)</option>
                                <option value="3">Tisch 3 (4P)</option>
                                <option value="4">Tisch 4 (6P)</option>
                                <option value="5">Tisch 5 (6P)</option>
                                <option value="6">Tisch 6 (4P)</option>
                                <option value="7">Tisch 7 (4P)</option>
                                <option value="8">Tisch 8 (8P)</option>
                                <option value="9">Tisch 9 (2P)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Anmerkungen</label>
                            <textarea class="form-input" id="resNotes" rows="2" placeholder="z.B. Kinderstuhl, Allergien, Geburtstag..."></textarea>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 20px;">
                            <button type="button" onclick="document.getElementById('newReservationModal').style.display='none';" class="dash-btn" style="flex: 1;">Abbrechen</button>
                            <button type="button" id="saveReservationBtn" class="dash-btn dash-btn-primary" style="flex: 2;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="20 6 9 17 4 12"/></svg>
                                Reservierung speichern
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Event Listener ist bereits im Haupt-Script definiert -->

        <!-- OFFERS SECTION -->
        <div id="sectionOffers" class="dash-section">
            <div class="section-back" onclick="showDashboardSection('dashboard')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Zurück zum Dashboard
            </div>
            
            <h2 class="section-page-title">Angebote verwalten</h2>
            
            <div class="panels-grid" style="margin-top: 20px;">
                <div class="panel">
                    <div class="panel-header">
                        <h3 class="panel-title">Neues Angebot erstellen</h3>
                        <span style="font-size: 13px; color: var(--slate);">Erreicht ~1.200 Nutzer</span>
                    </div>
                    <div class="panel-content">
                        <form class="offer-form" id="offerForm" onsubmit="createOffer(event)">
                            <div class="form-group">
                                <label class="form-label">Angebot-Titel *</label>
                                <input type="text" class="form-input" id="offerTitle" placeholder="z.B. Matjes-Spezial" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Rabatt *</label>
                                    <input type="text" class="form-input" id="offerDiscount" placeholder="z.B. 15%" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Gültig bis *</label>
                                    <input type="time" class="form-input" id="offerValidUntil" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Beschreibung (optional)</label>
                                <input type="text" class="form-input" id="offerDescription" placeholder="Kurze Beschreibung">
                            </div>
                            
                            <div class="offer-preview" style="margin: 20px 0;">
                                <div class="offer-preview-label">Vorschau</div>
                                <div class="offer-preview-title" id="previewTitle">Dein Angebot</div>
                                <div class="offer-preview-discount" id="previewDiscount">Rabatt bis --:--</div>
                            </div>
                            
                            <button type="submit" class="dash-btn dash-btn-primary" style="width: 100%;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="22" y1="2" x2="11" y2="13"/>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                </svg>
                                Jetzt veröffentlichen
                            </button>
                        </form>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <h3 class="panel-title">Aktive Angebote</h3>
                    </div>
                    <div class="panel-content" id="activeOffersList">
                        <!-- Active offers will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- CUSTOMERS SECTION -->
        <div id="sectionCustomers" class="dash-section">
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Kundenverwaltung</h2>
                    <p style="color: var(--slate); margin-top: 4px;">Restaurant-Partner verwalten</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="dash-btn" onclick="exportSEPACSV()" style="background: var(--bg-secondary); color: var(--dark);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        SEPA Export
                    </button>
                    <button class="dash-btn dash-btn-primary" onclick="openModal('addCustomerModal')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Neuer Kunde
                    </button>
                </div>
            </div>

            <!-- Statistiken -->
            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="totalCustomers">0</div>
                    <div class="stat-box-label">Kunden gesamt</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="paidCustomers">0</div>
                    <div class="stat-box-label">Bezahlt</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon orange">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="pendingCustomers">0</div>
                    <div class="stat-box-label">Ausstehend</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon" style="background: rgba(255,59,48,0.15);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#ff3b30" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="overdueCustomers" style="color: var(--danger);">0</div>
                    <div class="stat-box-label">Überfällig</div>
                </div>
            </div>

            <!-- Kundenliste -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">Alle Kunden</h3>
                </div>
                <div class="panel-content" id="customersList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Lade Kunden...</p>
                </div>
            </div>
        </div>

        <!-- ACCOMMODATIONS DASHBOARD SECTION -->
        <div id="sectionAccommodationsDash" class="dash-section">
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Unterkünfte</h2>
                    <p style="color: var(--slate); margin-top: 4px;">Hotels, Ferienwohnungen & Pensionen verwalten</p>
                </div>
                <button class="dash-btn dash-btn-primary" onclick="openModal('addAccommodationModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Neue Unterkunft
                </button>
            </div>

            <!-- Statistiken -->
            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M2 20v-8a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8"/>
                                <path d="M4 10V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="totalAccommodations">0</div>
                    <div class="stat-box-label">Unterkünfte gesamt</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="availableAccommodations">0</div>
                    <div class="stat-box-label">Verfügbar</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon orange">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="accommodationInquiries">0</div>
                    <div class="stat-box-label">Anfragen</div>
                </div>
            </div>

            <!-- Unterkünfte Liste -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">Alle Unterkünfte</h3>
                </div>
                <div class="panel-content" id="accommodationsDashList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Lade Unterkünfte...</p>
                </div>
            </div>

            <!-- Anfragen Liste -->
            <div class="panel" style="margin-top: 24px;">
                <div class="panel-header">
                    <h3 class="panel-title">Aktuelle Anfragen</h3>
                </div>
                <div class="panel-content" id="accommodationInquiriesList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Keine Anfragen</p>
                </div>
            </div>
        </div>

        <!-- EVENTS DASHBOARD SECTION -->
        <div id="sectionEventsDash" class="dash-section">
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Events</h2>
                    <p style="color: var(--slate); margin-top: 4px;">Veranstaltungen verwalten</p>
                </div>
                <button class="dash-btn dash-btn-primary" onclick="openModal('addEventModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Neues Event
                </button>
            </div>

            <!-- Stats -->
            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-box">
                    <div class="stat-box-value" id="statTotalEvents">0</div>
                    <div class="stat-box-label">Gesamt</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="statUpcomingEvents">0</div>
                    <div class="stat-box-label">Kommende</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="statFeaturedEvents">0</div>
                    <div class="stat-box-label">Highlights</div>
                </div>
            </div>

            <!-- Events Liste -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">Alle Events</h3>
                </div>
                <div class="panel-content" id="eventsDashList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Lade Events...</p>
                </div>
            </div>
        </div>

        <!-- ATTRACTIONS DASHBOARD SECTION -->
        <div id="sectionAttractionsDash" class="dash-section">
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Ausflugsziele</h2>
                    <p style="color: var(--slate); margin-top: 4px;">Sehenswürdigkeiten verwalten</p>
                </div>
                <button class="dash-btn dash-btn-primary" onclick="openModal('addAttractionModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Neues Ausflugsziel
                </button>
            </div>

            <!-- Stats -->
            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-box">
                    <div class="stat-box-value" id="statTotalAttractions">0</div>
                    <div class="stat-box-label">Gesamt</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="statNaturAttractions">0</div>
                    <div class="stat-box-label">Natur</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="statMuseumAttractions">0</div>
                    <div class="stat-box-label">Museen</div>
                </div>
            </div>

            <!-- Attractions Liste -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">Alle Ausflugsziele</h3>
                </div>
                <div class="panel-content" id="attractionsDashList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Lade Ausflugsziele...</p>
                </div>
            </div>
        </div>

        <!-- JOBS DASHBOARD SECTION -->
        <div id="sectionJobsDash" class="dash-section">
            <div class="section-header" style="margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Jobs verwalten</h2>
                <p style="color: var(--slate); margin-top: 4px;">Stellenanzeigen erstellen und verwalten</p>
            </div>

            <!-- Job hinzufügen -->
            <div class="panel" style="margin-bottom: 24px;">
                <div class="panel-header">
                    <h3 class="panel-title">Neue Stellenanzeige</h3>
                </div>
                <div class="panel-content">
                    <form id="addJobForm" onsubmit="addJob(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Jobtitel *</label>
                                <input type="text" class="form-input" id="newJobTitle" placeholder="z.B. Kellner/in gesucht" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Art</label>
                                <select class="form-select" id="newJobType">
                                    <option value="fulltime">Vollzeit</option>
                                    <option value="parttime">Teilzeit</option>
                                    <option value="minijob">Minijob</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Restaurant</label>
                                <select class="form-select" id="newJobRestaurant">
                                    <option value="">-- Restaurant wählen --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gehalt (optional)</label>
                                <input type="text" class="form-input" id="newJobSalary" placeholder="z.B. 13€/Stunde">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Beschreibung</label>
                            <textarea class="form-input" id="newJobDescription" rows="3" placeholder="Was sind die Aufgaben? Was wird erwartet?"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Kontakt WhatsApp</label>
                                <input type="text" class="form-input" id="newJobWhatsApp" placeholder="+49 176 ...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Kontakt E-Mail</label>
                                <input type="email" class="form-input" id="newJobEmail" placeholder="jobs@restaurant.de">
                            </div>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="newJobUrgent">
                                <span style="color: var(--slate);">Dringend gesucht</span>
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary">Job veröffentlichen</button>
                    </form>
                </div>
            </div>

            <!-- Jobs Liste -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">Aktive Stellenanzeigen</h3>
                </div>
                <div class="panel-content" id="jobsDashList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Lade Jobs...</p>
                </div>
            </div>
        </div>

        <!-- RESTAURANTS DASHBOARD SECTION -->
        <!-- RESTAURANTS DASHBOARD SECTION - KIN DESIGN -->
        <div id="sectionRestaurantsDash" class="dash-section">
            <div class="section-header" style="margin-bottom: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 48px; height: 48px; background: var(--cream); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="24" height="24">
                                <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                                <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                                <line x1="6" y1="1" x2="6" y2="4"/>
                                <line x1="10" y1="1" x2="10" y2="4"/>
                                <line x1="14" y1="1" x2="14" y2="4"/>
                            </svg>
                        </div>
                        <div>
                            <h2 style="font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600; color: var(--dark); margin: 0;">Restaurants</h2>
                            <p style="color: var(--slate); margin: 4px 0 0; font-size: 14px;">Verwalte alle Restaurants</p>
                        </div>
                    </div>
                    <button onclick="openNewRestaurantModal()" style="padding: 12px 20px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Neues Restaurant
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px;">
                <div style="background: var(--bg-card); border-radius: 16px; padding: 16px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                            <path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                        </svg>
                        <span style="font-size: 12px; color: var(--slate);">Aktiv</span>
                    </div>
                    <div style="font-size: 28px; font-weight: 700; color: var(--dark);" id="statActiveRestaurants">0</div>
                </div>
                <div style="background: var(--bg-card); border-radius: 16px; padding: 16px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="1.5" width="20" height="20">
                            <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
                        </svg>
                        <span style="font-size: 12px; color: var(--slate);">Tische</span>
                    </div>
                    <div style="font-size: 28px; font-weight: 700; color: var(--dark);" id="statTotalTablesAll">0</div>
                </div>
                <div style="background: var(--bg-card); border-radius: 16px; padding: 16px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="1.5" width="20" height="20">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        <span style="font-size: 12px; color: var(--slate);">Frei</span>
                    </div>
                    <div style="font-size: 28px; font-weight: 700; color: #10b981;" id="statFreeTablesAll">0</div>
                </div>
                <div style="background: var(--bg-card); border-radius: 16px; padding: 16px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="1.5" width="20" height="20">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
                        </svg>
                        <span style="font-size: 12px; color: var(--slate);">Heute</span>
                    </div>
                    <div style="font-size: 28px; font-weight: 700; color: #f59e0b;" id="statTodayReservationsAll">0</div>
                </div>
            </div>

            <!-- Restaurant Cards Grid -->
            <div id="restaurantsDashList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                <p style="grid-column: 1 / -1; padding: 40px; color: var(--slate); text-align: center;">Lade Restaurants...</p>
            </div>
        </div>

        <!-- BESTELLUNGEN DASHBOARD SECTION -->
        <!-- BESTELLUNGEN DASHBOARD SECTION - KIN DESIGN -->
        <div id="sectionOrders" class="dash-section">
            <!-- Header -->
            <div class="section-header" style="margin-bottom: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 48px; height: 48px; background: var(--cream); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="24" height="24">
                                <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/>
                                <rect x="9" y="3" width="6" height="4" rx="1"/>
                                <path d="M9 12h6"/><path d="M9 16h6"/>
                            </svg>
                        </div>
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <h2 style="font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600; color: var(--dark); margin: 0;">Live Bestellungen</h2>
                                <span id="ordersConnectionStatus" style="display: inline-flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 20px; background: #d1fae5; color: #059669;">
                                    <span style="width: 6px; height: 6px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></span>
                                    Live
                                </span>
                            </div>
                            <p style="color: var(--slate); margin: 4px 0 0; font-size: 14px;">Echtzeit-Bestellverwaltung</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="toggleOrderSound()" id="orderSoundBtn" style="padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-card); cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--dark);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18" id="orderSoundIcon">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                            </svg>
                            <span id="orderSoundText">Ton</span>
                        </button>
                        <button onclick="refreshOrders()" style="padding: 10px 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <path d="M23 4v6h-6"/><path d="M1 20v-6h6"/>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                            </svg>
                            Aktualisieren
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Restaurant Auswahl für Orders -->
            <div style="background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                        <path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                    </svg>
                    <select id="ordersRestaurantSelect" onchange="loadOrdersForRestaurant(this.value)" style="flex: 1; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 15px; background: var(--bg-secondary); color: var(--dark); cursor: pointer;">
                        <option value="">Alle Restaurants</option>
                    </select>
                </div>
            </div>
            
            <!-- Bestelloptionen Einstellungen -->
            <div id="orderSettingsPanel" style="background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                            <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                        <span style="font-weight: 600; color: var(--dark);">Bestelloptionen</span>
                    </div>
                    <span style="font-size: 12px; color: var(--slate);">für Kunden sichtbar</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <!-- Abholung -->
                    <label id="togglePickup" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 14px 10px; background: var(--bg-secondary); border-radius: 12px; border: 2px solid var(--primary); cursor: pointer; transition: all 0.2s;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="24" height="24">
                            <path d="M16 11V7a4 4 0 0 0-8 0v4M5 9h14l1 12H4L5 9z"/>
                        </svg>
                        <span style="font-size: 13px; font-weight: 600; color: var(--dark);">Abholung</span>
                        <input type="checkbox" id="settingPickup" checked onchange="saveOrderSettings()" style="display: none;">
                        <div style="width: 36px; height: 20px; background: var(--primary); border-radius: 10px; position: relative; transition: all 0.2s;" class="toggle-switch">
                            <div style="width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 2px; right: 2px; transition: all 0.2s;" class="toggle-knob"></div>
                        </div>
                    </label>
                    <!-- Lieferung -->
                    <label id="toggleDelivery" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 14px 10px; background: var(--bg-secondary); border-radius: 12px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="1.5" width="24" height="24">
                            <circle cx="9" cy="20" r="1.5"/><circle cx="17" cy="20" r="1.5"/>
                            <path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17"/>
                        </svg>
                        <span style="font-size: 13px; font-weight: 600; color: var(--dark);">Lieferung</span>
                        <input type="checkbox" id="settingDelivery" onchange="saveOrderSettings()" style="display: none;">
                        <div style="width: 36px; height: 20px; background: #d1d5db; border-radius: 10px; position: relative; transition: all 0.2s;" class="toggle-switch">
                            <div style="width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.2s;" class="toggle-knob"></div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Status Filter Tabs -->
            <div style="display: flex; gap: 6px; overflow-x: auto; padding-bottom: 16px; margin-bottom: 16px; -webkit-overflow-scrolling: touch;">
                <button class="kin-filter-tab active" onclick="filterOrders('all', this)" data-status="all">
                    Alle
                    <span class="kin-filter-count" id="ordersCountAll">0</span>
                </button>
                <button class="kin-filter-tab" onclick="filterOrders('received', this)" data-status="received">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" width="14" height="14"><circle cx="12" cy="12" r="10"/></svg>
                    Neu
                    <span class="kin-filter-count new" id="ordersCountNew">0</span>
                </button>
                <button class="kin-filter-tab" onclick="filterOrders('accepted', this)" data-status="accepted">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" width="14" height="14"><polyline points="20 6 9 17 4 12"/></svg>
                    Angenommen
                    <span class="kin-filter-count" id="ordersCountAccepted">0</span>
                </button>
                <button class="kin-filter-tab" onclick="filterOrders('preparing', this)" data-status="preparing">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2" width="14" height="14"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg>
                    Zubereitung
                    <span class="kin-filter-count" id="ordersCountPreparing">0</span>
                </button>
                <button class="kin-filter-tab" onclick="filterOrders('ready', this)" data-status="ready">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" width="14" height="14"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    Fertig
                    <span class="kin-filter-count" id="ordersCountReady">0</span>
                </button>
                <button class="kin-filter-tab" onclick="filterOrders('out_for_delivery', this)" data-status="out_for_delivery">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2" width="14" height="14"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    Unterwegs
                    <span class="kin-filter-count" id="ordersCountDelivery">0</span>
                </button>
            </div>
            
            <!-- Stats Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px;">
                <div style="background: var(--bg-card); border-radius: 16px; padding: 16px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="1.5" width="20" height="20">
                            <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/>
                            <rect x="9" y="3" width="6" height="4" rx="1"/>
                        </svg>
                        <span style="font-size: 12px; color: var(--slate);">Heute</span>
                    </div>
                    <div style="font-size: 28px; font-weight: 700; color: var(--dark);" id="statOrdersToday">0</div>
                </div>
                <div style="background: var(--bg-card); border-radius: 16px; padding: 16px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="1.5" width="20" height="20">
                            <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                        <span style="font-size: 12px; color: var(--slate);">Umsatz</span>
                    </div>
                    <div style="font-size: 28px; font-weight: 700; color: #10b981;" id="statRevenueToday">0 €</div>
                </div>
                <div style="background: var(--bg-card); border-radius: 16px; padding: 16px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="1.5" width="20" height="20">
                            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <span style="font-size: 12px; color: var(--slate);">Ø Zeit</span>
                    </div>
                    <div style="font-size: 28px; font-weight: 700; color: #3b82f6;" id="statAvgTime">--</div>
                </div>
                <div style="background: var(--bg-card); border-radius: 16px; padding: 16px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="1.5" width="20" height="20">
                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/>
                        </svg>
                        <span style="font-size: 12px; color: var(--slate);">Ø Wert</span>
                    </div>
                    <div style="font-size: 28px; font-weight: 700; color: #8b5cf6;" id="statAvgOrder">0 €</div>
                </div>
            </div>
            
            <!-- Bestellungen Grid -->
            <div id="ordersGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px;">
                <!-- Wird dynamisch gefüllt -->
            </div>
            
            <!-- Leerer Zustand -->
            <div id="ordersEmptyState" style="text-align: center; padding: 60px 20px; display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="1" width="80" height="80" style="margin-bottom: 20px; opacity: 0.3;">
                    <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/>
                    <rect x="9" y="3" width="6" height="4" rx="1"/>
                    <path d="M9 12h6"/><path d="M9 16h6"/>
                </svg>
                <h3 style="font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 600; color: var(--dark); margin-bottom: 8px;">Keine Bestellungen</h3>
                <p style="color: var(--slate); font-size: 14px;">Neue Bestellungen erscheinen hier automatisch</p>
            </div>
        </div>

        <!-- SPEISEKARTE SECTION - KIN DESIGN -->
        <div id="sectionSpeisekarte" class="dash-section">
            <div class="section-header" style="margin-bottom: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 48px; height: 48px; background: var(--cream); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="24" height="24">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 style="font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600; color: var(--dark); margin: 0;">Speisekarte</h2>
                            <p style="color: var(--slate); margin: 4px 0 0; font-size: 14px;">Gerichte verwalten</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Restaurant Auswahl -->
            <div id="menuRestaurantSelectContainer" style="background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                        <path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                    </svg>
                    <select id="menuRestaurantSelect" style="flex: 1; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 15px; background: var(--bg-secondary); color: var(--dark); cursor: pointer;">
                        <option value="">Restaurant auswählen...</option>
                    </select>
                </div>
                <script>
                document.getElementById('menuRestaurantSelect').addEventListener('change', function() {
                    var restaurantId = this.value;
                    console.log('🍽️ Restaurant gewählt:', restaurantId);
                    
                    if (!restaurantId) {
                        console.log('⚠️ Kein Restaurant gewählt');
                        return;
                    }
                    
                    // Globale Variable setzen
                    window.currentMenuRestaurant = restaurantId;
                    if (typeof currentMenuRestaurant !== 'undefined') {
                        currentMenuRestaurant = restaurantId;
                    }
                    
                    // Editor anzeigen
                    var editor = document.getElementById('menuEditorSection');
                    if (editor) editor.style.display = 'block';
                    
                    // Toast
                    if (typeof showToast === 'function') {
                        showToast('Restaurant ausgewählt', 'success');
                    }
                    
                    // Kategorien und Items laden
                    var SUPA_URL = 'https://mvrgmbdokdzmumdyezha.supabase.co';
                    var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12cmdtYmRva2R6bXVtZHllemhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjEyOTgsImV4cCI6MjA4MTEzNzI5OH0.7Ciwa2UKUHwtorvq3p6sN69XmVvPg0Kvg5lgrovxpDw';
                    
                    // Kategorien laden
                    fetch(SUPA_URL + '/rest/v1/menu_categories?restaurant_id=eq.' + restaurantId + '&order=sort_order', {
                        headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
                    })
                    .then(function(res) { return res.json(); })
                    .then(function(cats) {
                        console.log('📂 Kategorien:', cats);
                        if (typeof menuCategories !== 'undefined') {
                            menuCategories = cats || [];
                            window.menuCategories = menuCategories;
                        }
                        
                        // Items laden
                        return fetch(SUPA_URL + '/rest/v1/menu_items?restaurant_id=eq.' + restaurantId + '&order=sort_order', {
                            headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
                        });
                    })
                    .then(function(res) { return res.json(); })
                    .then(function(items) {
                        console.log('🍕 Items:', items);
                        if (typeof menuItems !== 'undefined') {
                            menuItems = items || [];
                            window.menuItems = menuItems;
                        }
                        
                        // UI aktualisieren
                        if (typeof renderMenuCategories === 'function') {
                            renderMenuCategories();
                        }
                        if (typeof updateMenuStats === 'function') {
                            updateMenuStats();
                        }
                        
                        console.log('✅ Speisekarte geladen!');
                    })
                    .catch(function(err) {
                        console.log('❌ Fehler beim Laden:', err);
                        // Demo-Daten
                        if (typeof menuCategories !== 'undefined') {
                            menuCategories = [
                                { id: 1, name: 'Vorspeisen', icon: '🥗', sort_order: 1 },
                                { id: 2, name: 'Hauptgerichte', icon: '🍽️', sort_order: 2 }
                            ];
                            window.menuCategories = menuCategories;
                        }
                        if (typeof menuItems !== 'undefined') {
                            menuItems = [
                                { id: 1, category_id: 1, name: 'Tagessuppe', price: 5.90, is_active: true },
                                { id: 2, category_id: 2, name: 'Schnitzel', price: 14.90, is_active: true }
                            ];
                            window.menuItems = menuItems;
                        }
                        if (typeof renderMenuCategories === 'function') renderMenuCategories();
                        if (typeof updateMenuStats === 'function') updateMenuStats();
                    });
                });
                </script>
            </div>
            
            <!-- Menu Editor -->
            <div id="menuEditorSection" style="display: block;">
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; position: relative; z-index: 100;">
                    <button type="button" id="menuScannerBtn2" style="flex: 1; min-width: 200px; padding: 16px 20px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 16px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                        <span>Menü scannen (KI)</span>
                    </button>
                    <button type="button" id="addCategoryBtn2" style="padding: 16px 24px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 16px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-primary);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                            <line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/>
                        </svg>
                        Kategorie
                    </button>
                    <button type="button" id="addMenuItemBtn2" style="padding: 16px 24px; background: var(--primary); color: white; border: none; border-radius: 16px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Gericht hinzufügen
                    </button>
                </div>
                
                <script>
                document.getElementById('menuScannerBtn2').addEventListener('click', function() {
                    var modal = document.getElementById('menuScannerModal');
                    if (modal) { modal.style.display = 'flex'; modal.classList.add('active'); }
                });
                document.getElementById('addCategoryBtn2').addEventListener('click', function() {
                    var modal = document.getElementById('addCategoryModal');
                    if (modal) { modal.style.display = 'flex'; modal.classList.add('active'); }
                });
                document.getElementById('addMenuItemBtn2').addEventListener('click', async function() {
                    console.log('➕ Gericht hinzufügen geklickt');
                    
                    var restaurantId = currentMenuRestaurant || window.currentMenuRestaurant || RESTAURANT_ID;
                    
                    var catSelect = document.getElementById('menuItemCategory');
                    catSelect.innerHTML = '<option value="">Lädt Kategorien...</option>';
                    
                    var client = sb || window.sb;
                    if (!client) {
                        catSelect.innerHTML = '<option value="">Verbindungsfehler</option>';
                        return;
                    }
                    
                    try {
                        var { data: cats, error } = await client.from('menu_categories').select('*').eq('restaurant_id', restaurantId).order('sort_order');
                        
                        if (error) throw new Error(error.message);
                        
                        catSelect.innerHTML = '<option value="">Kategorie wählen...</option>';
                        if (cats && cats.length > 0) {
                            cats.forEach(function(cat) {
                                var opt = document.createElement('option');
                                opt.value = cat.id;
                                opt.textContent = cat.name;
                                catSelect.appendChild(opt);
                            });
                        } else {
                            catSelect.innerHTML = '<option value="' + KATEGORIE_ID + '">Vorspeisen</option>';
                        }
                    } catch(e) {
                        console.log('❌ Fehler:', e);
                        catSelect.innerHTML = '<option value="' + KATEGORIE_ID + '">Vorspeisen</option>';
                    }
                    
                    var modal = document.getElementById('addMenuItemModal');
                    if (modal) { modal.style.display = 'flex'; modal.classList.add('active'); }
                });
                </script>
                
                <!-- Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px;">
                    <div style="background: var(--bg-card); border-radius: 16px; padding: 16px; border: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="1.5" width="20" height="20">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                            </svg>
                            <span style="font-size: 12px; color: var(--slate);">Kategorien</span>
                        </div>
                        <div style="font-size: 28px; font-weight: 700; color: var(--dark);" id="menuCategoryCount">0</div>
                    </div>
                    <div style="background: var(--bg-card); border-radius: 16px; padding: 16px; border: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                                <circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/>
                            </svg>
                            <span style="font-size: 12px; color: var(--slate);">Gerichte</span>
                        </div>
                        <div style="font-size: 28px; font-weight: 700; color: var(--primary);" id="menuTotalItems">0</div>
                    </div>
                    <div style="background: var(--bg-card); border-radius: 16px; padding: 16px; border: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="1.5" width="20" height="20">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span style="font-size: 12px; color: var(--slate);">Aktiv</span>
                        </div>
                        <div style="font-size: 28px; font-weight: 700; color: #10b981;" id="menuActiveItems">0</div>
                    </div>
                    <div style="background: var(--bg-card); border-radius: 16px; padding: 16px; border: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="1.5" width="20" height="20">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                            <span style="font-size: 12px; color: var(--slate);">Beliebt</span>
                        </div>
                        <div style="font-size: 28px; font-weight: 700; color: #f59e0b;" id="menuPopularItems">0</div>
                    </div>
                </div>
                
                <!-- Menu Categories List -->
                <div id="menuCategoriesList">
                    <!-- Wird dynamisch gefüllt -->
                </div>
            </div>
            
            <!-- Empty State -->
            <div id="menuEmptyState" style="text-align: center; padding: 60px 20px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="1" width="80" height="80" style="margin-bottom: 20px; opacity: 0.3;">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                <h3 style="font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 600; color: var(--dark); margin-bottom: 8px;">Kein Restaurant ausgewählt</h3>
                <p style="color: var(--slate); font-size: 14px;">Wähle oben ein Restaurant um die Speisekarte zu bearbeiten</p>
            </div>
        </div>

        <!-- TISCHPLAN wurde in Reservierungen integriert -->

        <!-- REWARDS SECTION - Belohnungen verwalten -->
        <div id="sectionRewards" class="dash-section">
            <div class="section-header" style="margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Belohnungen</h2>
                <p style="color: var(--slate); margin-top: 4px;">Erstelle Belohnungen für treue Gäste</p>
            </div>

            <!-- Info Box -->
            <div style="background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%); border-radius: 16px; padding: 20px; margin-bottom: 24px; color: #333;">
                <h3 style="margin: 0 0 8px; font-size: 18px;">💡 So funktioniert's</h3>
                <p style="margin: 0; font-size: 14px; line-height: 1.5;">
                    Gäste sammeln Punkte für Reservierungen und Bewertungen. 
                    Mit deinen Belohnungen gibst du ihnen einen Grund, wiederzukommen!
                    <br><strong>Tipp:</strong> Belohnungen ab 300-500 Punkte sind am beliebtesten.
                </p>
            </div>

            <!-- Aktive Belohnungen -->
            <div class="panel" style="margin-bottom: 24px;">
                <div class="panel-header">
                    <h3 class="panel-title">Meine Belohnungen</h3>
                    <button class="btn btn-primary" onclick="openModal('addRewardModal')" style="padding: 8px 16px; font-size: 13px;">
                        + Neue Belohnung
                    </button>
                </div>
                <div class="panel-content" id="rewardsList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Noch keine Belohnungen erstellt</p>
                </div>
            </div>

            <!-- Eingelöste Belohnungen -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">📋 Eingelöste Belohnungen</h3>
                    <span id="pendingRedemptionsCount" style="background: var(--warning); color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">0 offen</span>
                </div>
                <div class="panel-content" id="redemptionsList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Keine Einlösungen vorhanden</p>
                </div>
            </div>
        </div>

        <!-- STATISTICS SECTION -->
        <div id="sectionStatistics" class="dash-section">
            <div class="section-header" style="margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Statistiken</h2>
                <p style="color: var(--slate); margin-top: 4px;">Übersicht über alle Aktivitäten</p>
            </div>

            <!-- Übersicht Karten -->
            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                                <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="statTotalRestaurants">0</div>
                    <div class="stat-box-label">Restaurants</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M2 20v-8a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8"/>
                                <rect x="6" y="12" width="4" height="4"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="statTotalAccommodations">0</div>
                    <div class="stat-box-label">Unterkünfte</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon orange">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="statTotalReservations">0</div>
                    <div class="stat-box-label">Reservierungen</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon purple" style="background: rgba(175,82,222,0.15);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #AF52DE;">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="statTotalCustomers">0</div>
                    <div class="stat-box-label">Kunden</div>
                </div>
            </div>

            <!-- Aktivitäten diese Woche -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">Diese Woche</h3>
                </div>
                <div class="panel-content">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center;">
                        <div>
                            <div style="font-size: 32px; font-weight: 700; color: var(--primary);" id="weekReservations">0</div>
                            <div style="font-size: 13px; color: var(--slate);">Reservierungen</div>
                        </div>
                        <div>
                            <div style="font-size: 32px; font-weight: 700; color: var(--success);" id="weekInquiries">0</div>
                            <div style="font-size: 13px; color: var(--slate);">Anfragen</div>
                        </div>
                        <div>
                            <div style="font-size: 32px; font-weight: 700; color: var(--warning);" id="weekNewCustomers">0</div>
                            <div style="font-size: 13px; color: var(--slate);">Neue Kunden</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orte Übersicht -->
            <div class="panel" style="margin-top: 24px;">
                <div class="panel-header">
                    <h3 class="panel-title">Nach Ort</h3>
                </div>
                <div class="panel-content" id="locationStats">
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--cream); border-radius: 8px;">
                            <span style="font-weight: 600;">Greetsiel</span>
                            <span style="color: var(--primary); font-weight: 700;" id="statGreetsiel">0 Einträge</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--cream); border-radius: 8px;">
                            <span style="font-weight: 600;">Norddeich</span>
                            <span style="color: var(--primary); font-weight: 700;" id="statNorddeich">0 Einträge</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--cream); border-radius: 8px;">
                            <span style="font-weight: 600;">Norden</span>
                            <span style="color: var(--primary); font-weight: 700;" id="statNorden">0 Einträge</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--cream); border-radius: 8px;">
                            <span style="font-weight: 600;">Andere</span>
                            <span style="color: var(--primary); font-weight: 700;" id="statOther">0 Einträge</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- REVENUE SECTION -->
        <div id="sectionRevenue" class="dash-section">
            <div class="section-header" style="margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Umsatz</h2>
                <p style="color: var(--slate); margin-top: 4px;">Einnahmen und Zahlungsübersicht</p>
            </div>

            <!-- Umsatz Karten -->
            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="monthlyRevenue">0 €</div>
                    <div class="stat-box-label">Diesen Monat</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="yearlyRevenue">0 €</div>
                    <div class="stat-box-label">Dieses Jahr</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon orange">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="pendingRevenue">0 €</div>
                    <div class="stat-box-label">Ausstehend</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon" style="background: rgba(255,59,48,0.15);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--danger);">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="overdueRevenue" style="color: var(--danger);">0 €</div>
                    <div class="stat-box-label">Überfällig</div>
                </div>
            </div>

            <!-- Monatliche Einnahmen -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">Monatliche Einnahmen</h3>
                </div>
                <div class="panel-content" id="monthlyRevenueChart">
                    <div style="display: flex; align-items: flex-end; justify-content: space-between; height: 150px; padding: 20px 0;">
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0; transition: height 0.3s;" id="barJan"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Jan</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barFeb"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Feb</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barMar"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Mär</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barApr"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Apr</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barMay"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Mai</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barJun"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Jun</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barJul"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Jul</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barAug"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Aug</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barSep"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Sep</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barOct"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Okt</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barNov"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Nov</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--success); width: 30px; border-radius: 4px 4px 0 0;" id="barDec"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Dez</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Letzte Zahlungen -->
            <div class="panel" style="margin-top: 24px;">
                <div class="panel-header">
                    <h3 class="panel-title">Letzte Zahlungen</h3>
                </div>
                <div class="panel-content" id="recentPaymentsList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Keine Zahlungen</p>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Add Accommodation Modal -->
<div class="modal-overlay" id="addAccommodationModal">
    <div class="modal" style="max-width: 550px;">
        <div class="modal-header">
            <h2 class="modal-title">Neue Unterkunft</h2>
            <button class="modal-close" onclick="closeModal('addAccommodationModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <form id="addAccommodationForm" onsubmit="addAccommodation(event)">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="accName" required placeholder="z.B. Ferienwohnung Meerblick">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Typ</label>
                        <select class="form-input" id="accType">
                            <option value="ferienwohnung">Ferienwohnung</option>
                            <option value="hotel">Hotel</option>
                            <option value="pension">Pension</option>
                            <option value="b&b">B&B</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ort</label>
                        <input type="text" class="form-input" id="accCity" placeholder="z.B. Greetsiel">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></span>Preis-Info</label>
                        <input type="text" class="form-input" id="accPrice" placeholder="z.B. ab 75€ / Nacht">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max. Gäste</label>
                        <input type="number" class="form-input" id="accMaxGuests" value="4" min="1">
                    </div>
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Adresse</h4>
                
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></span>Straße</label>
                    <input type="text" class="form-input" id="accStreet" placeholder="z.B. Deichstraße 15">
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg></span>Google Maps Link</label>
                    <input type="url" class="form-input" id="accGoogleMaps" placeholder="https://maps.google.com/...">
                    <p style="font-size: 11px; color: var(--slate); margin-top: 4px;">Google Maps → Ort suchen → Teilen → Link kopieren</p>
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Kontakt</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></span>Telefon</label>
                        <input type="tel" class="form-input" id="accPhone" placeholder="+49 ...">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></span>WhatsApp</label>
                        <input type="tel" class="form-input" id="accWhatsapp" placeholder="+49 176 ...">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></span>Email</label>
                    <input type="email" class="form-input" id="accEmail" placeholder="info@unterkunft.de">
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Online</h4>
                
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></span>Webseite</label>
                    <input type="url" class="form-input" id="accWebsite" placeholder="https://...">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></span>Instagram</label>
                        <input type="text" class="form-input" id="accInstagram" placeholder="@name">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></span>Facebook</label>
                        <input type="url" class="form-input" id="accFacebook" placeholder="https://facebook.com/...">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span>Buchungslink</label>
                    <input type="url" class="form-input" id="accBookingUrl" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></span>Bild-URL</label>
                    <input type="url" class="form-input" id="accImage" placeholder="https://...">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 12px;">Unterkunft anlegen</button>
            </form>
        </div>
    </div>
</div>

<!-- Add Customer Modal -->
<div class="modal-overlay" id="addCustomerModal">
    <div class="modal" style="max-width: 550px;">
        <div class="modal-header">
            <h2 class="modal-title">Neuer Kunde</h2>
            <button class="modal-close" onclick="closeModal('addCustomerModal')">×</button>
        </div>
        <div class="modal-body">
            <form id="addCustomerForm" onsubmit="addCustomer(event)">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Kundendaten</h4>
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="customerName" required placeholder="z.B. Hans Müller">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-input" id="customerEmail" required placeholder="email@restaurant.de">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Passwort *</label>
                        <input type="text" class="form-input" id="customerPassword" required placeholder="Login-Passwort">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></span>Telefon</label>
                    <input type="tel" class="form-input" id="customerPhone" placeholder="+49 ...">
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--sand);">
                
                <h4 style="margin-bottom: 12px; color: var(--dark);">Restaurant</h4>
                <div class="form-group">
                    <label class="form-label">Restaurant zuweisen</label>
                    <select class="form-input" id="customerRestaurant" onchange="toggleNewRestaurant()">
                        <option value="">-- Neues Restaurant anlegen --</option>
                    </select>
                </div>
                
                <div id="newRestaurantFields">
                    <div class="form-group">
                        <label class="form-label">Restaurant Name *</label>
                        <input type="text" class="form-input" id="newRestName" placeholder="z.B. Greetsieler Fischhaus">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label class="form-label">Ort</label>
                            <input type="text" class="form-input" id="newRestCity" placeholder="z.B. Greetsiel, Norddeich, Norden...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Küche</label>
                            <input type="text" class="form-input" id="newRestCuisine" placeholder="z.B. Fisch, Deutsch, Türkisch, Café...">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></span>Telefon</label>
                            <input type="tel" class="form-input" id="newRestPhone" placeholder="+49 4926 ...">
                        </div>
                        <div class="form-group">
                            <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></span>WhatsApp</label>
                            <input type="tel" class="form-input" id="newRestWhatsapp" placeholder="+49 176 ...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></span>Webseite</label>
                        <input type="url" class="form-input" id="newRestWebsite" placeholder="https://www.restaurant.de">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></span>Facebook</label>
                            <input type="url" class="form-input" id="newRestFacebook" placeholder="https://facebook.com/...">
                        </div>
                        <div class="form-group">
                            <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></span>Instagram</label>
                            <input type="url" class="form-input" id="newRestInstagram" placeholder="https://instagram.com/...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Speisekarte</label>
                        <input type="text" class="form-input" id="newRestMenu" placeholder="Link zur Speisekarte oder PDF-URL">
                        <p style="font-size: 11px; color: var(--slate); margin-top: 4px;">Tipp: PDF auf Google Drive oder Dropbox hochladen und Link hier einfügen</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></span>Straße</label>
                        <input type="text" class="form-input" id="newRestStreet" placeholder="z.B. Hafenstraße 12">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg></span>Google Maps Link</label>
                        <input type="url" class="form-input" id="newRestGoogleMaps" placeholder="https://maps.google.com/...">
                        <p style="font-size: 11px; color: var(--slate); margin-top: 4px;">Google Maps öffnen → Restaurant suchen → "Teilen" → Link kopieren</p>
                    </div>
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--sand);">
                
                <h4 style="margin-bottom: 12px; color: var(--dark);">Abrechnung</h4>
                <div class="form-group">
                    <label class="form-label">Monatsbeitrag (€)</label>
                    <input type="number" class="form-input" id="customerFee" value="29.90" step="0.01" min="0">
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--sand);">
                
                <h4 style="margin-bottom: 12px; color: var(--dark);">SEPA-Lastschrift</h4>
                <div class="form-group">
                    <label class="form-label">Kontoinhaber</label>
                    <input type="text" class="form-input" id="customerAccountHolder" placeholder="Name wie auf dem Konto">
                </div>
                <div class="form-group">
                    <label class="form-label">IBAN</label>
                    <input type="text" class="form-input" id="customerIBAN" placeholder="DE89 3704 0044 0532 0130 00" oninput="formatIBAN(this)">
                </div>
                <div class="form-group">
                    <label class="form-label">BIC (optional)</label>
                    <input type="text" class="form-input" id="customerBIC" placeholder="COBADEFFXXX">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="customerSEPAMandat" style="margin-top: 4px; width: 18px; height: 18px;">
                        <span style="font-size: 13px; color: var(--slate); line-height: 1.4;">
                            Ich ermächtige Kiek mol in, Zahlungen von meinem Konto mittels Lastschrift einzuziehen. 
                            Zugleich weise ich mein Kreditinstitut an, die von Kiek mol in auf mein Konto gezogenen 
                            Lastschriften einzulösen.
                        </span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">Mandatsreferenz (wird automatisch generiert)</label>
                    <input type="text" class="form-input" id="customerMandateRef" readonly placeholder="Wird beim Speichern generiert" style="background: var(--cream);">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">Kunde anlegen</button>
            </form>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal-overlay" id="paymentModal">
    <div class="modal" style="max-width: 400px;">
        <div class="modal-header">
            <h2 class="modal-title">Zahlung erfassen</h2>
            <button class="modal-close" onclick="closeModal('paymentModal')">×</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 16px; color: var(--slate);">Zahlung für: <strong id="paymentCustomerName"></strong></p>
            <input type="hidden" id="paymentCustomerId">
            <div class="form-group">
                <label class="form-label">Betrag (€)</label>
                <input type="number" class="form-input" id="paymentAmount" value="29.90" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label class="form-label">Zahlungsart</label>
                <select class="form-input" id="paymentMethod">
                    <option value="bank">Überweisung</option>
                    <option value="paypal">PayPal</option>
                    <option value="cash">Bar</option>
                </select>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="recordPayment()">Zahlung buchen</button>
        </div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal-overlay" id="addEventModal">
    <div class="modal" style="max-width: 550px;">
        <div class="modal-header">
            <h2 class="modal-title">Neues Event</h2>
            <button class="modal-close" onclick="closeModal('addEventModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <form id="addEventForm" onsubmit="addEvent(event)">
                <div class="form-group">
                    <label class="form-label">Titel *</label>
                    <input type="text" class="form-input" id="eventTitle" required placeholder="z.B. Greetsieler Woche">
                </div>
                <div class="form-group">
                    <label class="form-label">Beschreibung</label>
                    <textarea class="form-textarea" id="eventDescription" placeholder="Was erwartet die Besucher?"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Datum *</label>
                        <input type="date" class="form-input" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Uhrzeit</label>
                        <input type="time" class="form-input" id="eventTime">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Ort</label>
                        <input type="text" class="form-input" id="eventCity" placeholder="z.B. Greetsiel">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kategorie</label>
                        <select class="form-input" id="eventCategory">
                            <option value="fest">Fest</option>
                            <option value="markt">Markt</option>
                            <option value="konzert">Konzert</option>
                            <option value="natur">Natur</option>
                            <option value="sonstiges">Sonstiges</option>
                        </select>
                    </div>
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Adresse & Kontakt</h4>
                
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></span>Straße</label>
                    <input type="text" class="form-input" id="eventStreet" placeholder="z.B. Hafenstraße 12">
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg></span>Google Maps Link</label>
                    <input type="url" class="form-input" id="eventGoogleMaps" placeholder="https://maps.google.com/...">
                    <p style="font-size: 11px; color: var(--slate); margin-top: 4px;">Google Maps → Ort suchen → Teilen → Link kopieren</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></span>Telefon</label>
                        <input type="tel" class="form-input" id="eventPhone" placeholder="+49 ...">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></span>WhatsApp</label>
                        <input type="tel" class="form-input" id="eventWhatsapp" placeholder="+49 176 ...">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></span>Webseite</label>
                        <input type="url" class="form-input" id="eventWebsite" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></span>Instagram</label>
                        <input type="text" class="form-input" id="eventInstagram" placeholder="@eventname">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></span>Facebook</label>
                    <input type="url" class="form-input" id="eventFacebook" placeholder="https://facebook.com/...">
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></span>Preis-Info</label>
                        <input type="text" class="form-input" id="eventPrice" placeholder="z.B. Eintritt frei">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></span>Bild-URL</label>
                        <input type="url" class="form-input" id="eventImage" placeholder="https://...">
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="eventFeatured">
                        <span>Als Highlight markieren</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Event hinzufügen</button>
            </form>
        </div>
    </div>
</div>

<!-- Add Attraction Modal -->
<div class="modal-overlay" id="addAttractionModal">
    <div class="modal" style="max-width: 550px;">
        <div class="modal-header">
            <h2 class="modal-title">Neues Ausflugsziel</h2>
            <button class="modal-close" onclick="closeModal('addAttractionModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <form id="addAttractionForm" onsubmit="addAttraction(event)">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="attractionName" required placeholder="z.B. Pilsumer Leuchtturm">
                </div>
                <div class="form-group">
                    <label class="form-label">Beschreibung</label>
                    <textarea class="form-textarea" id="attractionDescription" placeholder="Was macht diesen Ort besonders?"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Ort</label>
                        <input type="text" class="form-input" id="attractionCity" placeholder="z.B. Pilsum">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kategorie</label>
                        <select class="form-input" id="attractionCategory">
                            <option value="natur">Natur</option>
                            <option value="museum">Museum</option>
                            <option value="historisch">Historisch</option>
                            <option value="familie">Familie</option>
                            <option value="sonstiges">Sonstiges</option>
                        </select>
                    </div>
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Adresse & Kontakt</h4>
                
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></span>Straße</label>
                    <input type="text" class="form-input" id="attractionStreet" placeholder="z.B. Leuchtturmweg 1">
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg></span>Google Maps Link</label>
                    <input type="url" class="form-input" id="attractionGoogleMaps" placeholder="https://maps.google.com/...">
                    <p style="font-size: 11px; color: var(--slate); margin-top: 4px;">Google Maps → Ort suchen → Teilen → Link kopieren</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></span>Telefon</label>
                        <input type="tel" class="form-input" id="attractionPhone" placeholder="+49 ...">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></span>WhatsApp</label>
                        <input type="tel" class="form-input" id="attractionWhatsapp" placeholder="+49 176 ...">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></span>Webseite</label>
                        <input type="url" class="form-input" id="attractionWebsite" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></span>Instagram</label>
                        <input type="text" class="form-input" id="attractionInstagram" placeholder="@name">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></span>Facebook</label>
                    <input type="url" class="form-input" id="attractionFacebook" placeholder="https://facebook.com/...">
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></span>Preis-Info</label>
                        <input type="text" class="form-input" id="attractionPrice" placeholder="z.B. Eintritt frei">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg></span>Bewertung</label>
                        <input type="number" class="form-input" id="attractionRating" value="4.5" min="1" max="5" step="0.1">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></span>Bild-URL</label>
                    <input type="url" class="form-input" id="attractionImage" placeholder="https://...">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Ausflugsziel hinzufügen</button>
            </form>
        </div>
    </div>
</div>

<!-- Accommodation Inquiry Modal -->
<div class="modal-overlay" id="accommodationInquiryModal">
    <div class="modal" style="max-width: 450px;">
        <div class="modal-header">
            <h2 class="modal-title">Unterkunft anfragen</h2>
            <button class="modal-close" onclick="closeModal('accommodationInquiryModal')">×</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 16px; color: var(--slate);"><strong id="inquiryAccommodationName"></strong></p>
            <input type="hidden" id="inquiryAccommodationId">
            
            <form id="accommodationInquiryForm" onsubmit="submitAccommodationInquiry(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Check-in *</label>
                        <input type="date" class="form-input" id="inquiryCheckIn" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Check-out *</label>
                        <input type="date" class="form-input" id="inquiryCheckOut" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Anzahl Gäste</label>
                    <select class="form-input" id="inquiryGuests">
                        <option value="1">1 Person</option>
                        <option value="2" selected>2 Personen</option>
                        <option value="3">3 Personen</option>
                        <option value="4">4 Personen</option>
                        <option value="5">5 Personen</option>
                        <option value="6">6+ Personen</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ihr Name *</label>
                    <input type="text" class="form-input" id="inquiryName" required placeholder="Max Mustermann">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></span>Email</label>
                        <input type="email" class="form-input" id="inquiryEmail" placeholder="ihre@email.de">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefon *</label>
                        <input type="tel" class="form-input" id="inquiryPhone" required placeholder="+49 ...">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Nachricht (optional)</label>
                    <textarea class="form-input" id="inquiryMessage" rows="2" placeholder="Besondere Wünsche..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Anfrage senden</button>
            </form>
            
            <div id="accommodationBookingLink" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--sand); text-align: center; display: none;">
                <p style="font-size: 13px; color: var(--slate); margin-bottom: 8px;">Oder direkt buchen:</p>
                <a id="bookingLinkBtn" href="#" target="_blank" class="btn btn-secondary" style="width: 100%;">
                    Zur Buchungsseite
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// ==================== GLOBALE RESERVIERUNGS-VARIABLE ====================
// Muss früh initialisiert werden damit Online-Buchungen funktionieren
window.resAllReservations = window.resAllReservations || [];
console.log('🔧 window.resAllReservations initialisiert');

// ==================== SOFORTIGE THEME-INITIALISIERUNG ====================
(function() {
    const savedTheme = localStorage.getItem('kmi_theme') || 'auto';
    let actualTheme = savedTheme;
    
    if (savedTheme === 'auto') {
        // Safari-kompatible Erkennung
        try {
            const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            actualTheme = darkModeMediaQuery.matches ? 'dark' : 'light';
            
            // Safari braucht manchmal einen Listener
            darkModeMediaQuery.addListener(function(e) {
                if (localStorage.getItem('kmi_theme') === 'auto') {
                    if (e.matches) {
                        document.documentElement.classList.add('dark-mode');
                        document.body.classList.add('dark-mode');
                    } else {
                        document.documentElement.classList.remove('dark-mode');
                        document.body.classList.remove('dark-mode');
                    }
                }
            });
        } catch(e) {
            actualTheme = 'light';
        }
    }
    
    if (actualTheme === 'dark') {
        document.documentElement.classList.add('dark-mode');
    }
})();

// ==================== MEHRSPRACHIGKEIT ====================
let currentLanguage = localStorage.getItem('kmi_language') || 'de';

const translations = {
    de: {
        // Header & Tagline
        tagline: 'Ostfriesland genießen',
        change: 'Ändern ›',
        
        // Restaurants
        restaurants: 'Restaurants',
        all: 'Alle',
        openNow: 'Jetzt geöffnet',
        closed: 'Geschlossen',
        freeTables: 'Freie Tische',
        topRated: 'Top bewertet',
        available: 'Sofort verfügbar',
        waitlist: 'Warteliste',
        tablesLeft: 'Noch',
        tables: 'Tische',
        table: 'Tisch',
        reserve: 'Reservieren',
        reserveNow: 'Jetzt reservieren',
        noRestaurants: 'Keine Restaurants gefunden',
        searchPlaceholder: 'Restaurant suchen...',
        
        // Navigation
        navFood: 'Essen',
        navSleep: 'Schlafen',
        navEvents: 'Events',
        navDiscover: 'Entdecken',
        navJobs: 'Jobs',
        home: 'Start',
        map: 'Karte',
        search: 'Suchen',
        favorites: 'Favoriten',
        profile: 'Profil',
        settings: 'Einstellungen',
        
        // Location
        chooseLocation: 'Ort wählen',
        whereToGo: 'Wo möchtest du hin?',
        locationNotFound: 'Dein Ort nicht dabei?',
        allLocations: 'Alle Orte',
        searchLocation: 'Ort suchen...',
        addLocation: 'Ort hinzufügen',
        
        // Taglines
        accommodationsTagline: 'Unterkünfte in Ostfriesland',
        eventsTagline: 'Events in Ostfriesland',
        jobsTagline: 'Jobs in Ostfriesland',
        attractionsTagline: 'Ausflugsziele in Ostfriesland',
        
        // Jobs
        jobsOpen: 'Offene Stellen',
        jobsUrgent: 'Dringend',
        currentJobs: 'Aktuelle Stellenangebote',
        loadingJobs: 'Jobs werden geladen...',
        noJobs: 'Keine Stellenangebote verfügbar',
        fulltime: 'Vollzeit',
        parttime: 'Teilzeit',
        minijob: 'Minijob',
        apply: 'Bewerben',
        urgent: 'Dringend',
        
        // Reservierung
        name: 'Name',
        phone: 'Telefon',
        email: 'E-Mail',
        date: 'Datum',
        time: 'Uhrzeit',
        guests: 'Personen',
        person: 'Person',
        persons: 'Personen',
        notes: 'Anmerkungen',
        notesPlaceholder: 'z.B. Kinderstuhl benötigt',
        send: 'Absenden',
        cancel: 'Abbrechen',
        confirm: 'Bestätigen',
        reservationSuccess: 'Reservierung erfolgreich!',
        reservationError: 'Fehler bei der Reservierung',
        
        // Restaurant Details
        cuisine: 'Küche',
        address: 'Adresse',
        openingHours: 'Öffnungszeiten',
        rating: 'Bewertung',
        reviews: 'Bewertungen',
        menu: 'Speisekarte',
        call: 'Anrufen',
        directions: 'Route',
        website: 'Webseite',
        share: 'Teilen',
        
        // Wetter
        weather: 'Wetter',
        sunny: 'Sonnig',
        cloudy: 'Bewölkt',
        rainy: 'Regnerisch',
        stormy: 'Gewitter',
        wind: 'Wind',
        temperature: 'Temperatur',
        
        // Zeit
        today: 'Heute',
        tomorrow: 'Morgen',
        yesterday: 'Gestern',
        now: 'Jetzt',
        daysAgo: 'Tagen',
        monday: 'Montag',
        tuesday: 'Dienstag',
        wednesday: 'Mittwoch',
        thursday: 'Donnerstag',
        friday: 'Freitag',
        saturday: 'Samstag',
        sunday: 'Sonntag',
        restDay: 'Ruhetag',
        
        // Allgemein
        more: 'Mehr',
        less: 'Weniger',
        none: 'Keine',
        loading: 'Laden...',
        error: 'Fehler',
        success: 'Erfolg',
        noResults: 'Keine Ergebnisse',
        tryAgain: 'Erneut versuchen',
        back: 'Zurück',
        close: 'Schließen',
        save: 'Speichern',
        delete: 'Löschen',
        edit: 'Bearbeiten',
        
        // Footer & Legal
        footerText: '© 2025 Kiek mol in – Ostfriesland genießen',
        impressum: 'Impressum',
        privacy: 'Datenschutz',
        contact: 'Kontakt',
        agb: 'AGB',
        
        // Angebote
        todaysOffers: 'Angebote heute',
        discount: 'Rabatt',
        validUntil: 'Gültig bis',
        specialOffer: 'Tagesangebot',
        
        // Unterkünfte
        accommodations: 'Unterkünfte',
        hotel: 'Hotel',
        apartment: 'Ferienwohnung',
        pension: 'Pension',
        pricePerNight: 'pro Nacht',
        checkIn: 'Anreise',
        checkOut: 'Abreise',
        availability: 'Verfügbarkeit',
        bookNow: 'Jetzt buchen',
        inquire: 'Anfragen',
        
        // Events
        events: 'Events',
        upcomingEvents: 'Kommende Events',
        noEvents: 'Keine Events',
        eventDate: 'Datum',
        eventTime: 'Uhrzeit',
        eventLocation: 'Ort',
        
        // Attraktionen
        attractions: 'Ausflugsziele',
        sights: 'Sehenswürdigkeiten',
        nature: 'Natur',
        culture: 'Kultur',
        family: 'Familie',
        
        // Suche
        searchResults: 'Suchergebnisse',
        filterBy: 'Filtern nach',
        sortBy: 'Sortieren nach',
        distance: 'Entfernung',
        popularity: 'Beliebtheit',
        
        // Bewertungen
        excellent: 'Ausgezeichnet',
        veryGood: 'Sehr gut',
        good: 'Gut',
        average: 'Durchschnittlich',
        
        // Cookie
        cookieText: 'Wir nutzen Cookies für die Funktion der App.',
        cookieMore: 'Mehr erfahren',
        cookieAccept: 'Verstanden',
        
        // Favoriten
        addToFavorites: 'Zu Favoriten',
        removeFromFavorites: 'Aus Favoriten entfernen',
        noFavorites: 'Noch keine Favoriten',
        
        // Assistent
        assistantTitle: 'Dein Ostfriesland-Guide',
        assistantPlaceholder: 'Schreib eine Nachricht...',
        askMe: 'Frag mich etwas...',
        
        // Reservierung erweitert
        sendReservation: 'Reservierung anfragen',
        optional: 'optional',
        namePlaceholder: 'Max Mustermann',
        notesPlaceholder: 'Kinderstuhl benötigt, Allergien, etc.',
        '1person': '1 Person',
        '2persons': '2 Personen',
        '3persons': '3 Personen',
        '4persons': '4 Personen',
        '5persons': '5 Personen',
        '6persons': '6 Personen',
        '7persons': '7 Personen',
        '8persons': '8+ Personen',
        
        // Profil
        myProfile: 'Mein Profil',
        notLoggedIn: 'Noch nicht angemeldet',
        loginToSave: 'Melde dich an um deine Favoriten zu speichern und Reservierungen zu verwalten.',
        loginWithGoogle: 'Mit Google anmelden',
        orWithEmail: 'oder mit E-Mail',
        logout: 'Abmelden',
        
        // Statistiken
        reservationsToday: 'Reservierungen heute',
        tablesFree: 'Tische frei',
        
        // Suche
        searchRestaurant: 'Restaurant suchen...',
        
        // Profil & Login
        loginNow: 'Jetzt anmelden',
        login: 'Anmelden',
        useWithoutLogin: 'Du kannst die App auch ohne Anmeldung nutzen.',
        myFavorites: 'Meine Favoriten',
        savedLocally: 'Lokal gespeichert',
        design: 'Design',
        
        // Reviews & Community
        writeReview: 'Bewertung schreiben',
        reviewSuccess: 'Bewertung gespeichert! ⭐',
        reviewError: 'Fehler beim Speichern',
        noReviews: 'Noch keine Bewertungen',
        beFirst: 'Sei der Erste!',
        helpful: 'Hilfreich',
        liveActivity: 'Letzte Aktivität',
        visitorsToday: 'Besucher heute',
        reservedTable: 'hat einen Tisch reserviert',
        gaveStars: 'hat bewertet',
        uploadedPhoto: 'hat ein Foto hochgeladen',
        howWasExperience: 'Wie war dein Erlebnis?',
        yourName: 'Dein Name',
        titleOptional: 'Titel (optional)',
        yourReview: 'Deine Bewertung',
        addPhotos: 'Fotos hinzufügen',
        submitReview: 'Bewertung absenden',
        maxPhotos: 'Maximal 4 Fotos',
        pleaseRate: 'Bitte Sterne vergeben'
    },
    en: {
        // Header & Tagline
        tagline: 'Enjoy East Frisia',
        change: 'Change ›',
        
        // Restaurants
        restaurants: 'Restaurants',
        all: 'All',
        openNow: 'Open now',
        closed: 'Closed',
        freeTables: 'Free tables',
        topRated: 'Top rated',
        available: 'Available now',
        waitlist: 'Waitlist',
        tablesLeft: 'Only',
        tables: 'tables left',
        table: 'table',
        reserve: 'Reserve',
        reserveNow: 'Reserve now',
        noRestaurants: 'No restaurants found',
        searchPlaceholder: 'Search restaurants...',
        
        // Navigation
        navFood: 'Food',
        navSleep: 'Stay',
        navEvents: 'Events',
        navDiscover: 'Discover',
        navJobs: 'Jobs',
        home: 'Home',
        map: 'Map',
        search: 'Search',
        favorites: 'Favorites',
        profile: 'Profile',
        settings: 'Settings',
        
        // Location
        chooseLocation: 'Choose location',
        whereToGo: 'Where would you like to go?',
        locationNotFound: 'Location not listed?',
        allLocations: 'All locations',
        searchLocation: 'Search location...',
        addLocation: 'Add location',
        
        // Taglines
        accommodationsTagline: 'Accommodations in East Frisia',
        eventsTagline: 'Events in East Frisia',
        jobsTagline: 'Jobs in East Frisia',
        attractionsTagline: 'Attractions in East Frisia',
        
        // Jobs
        jobsOpen: 'Open positions',
        jobsUrgent: 'Urgent',
        currentJobs: 'Current job offers',
        loadingJobs: 'Loading jobs...',
        noJobs: 'No job offers available',
        fulltime: 'Full-time',
        parttime: 'Part-time',
        minijob: 'Mini job',
        apply: 'Apply',
        urgent: 'Urgent',
        
        // Reservation
        name: 'Name',
        phone: 'Phone',
        email: 'Email',
        date: 'Date',
        time: 'Time',
        guests: 'Guests',
        person: 'person',
        persons: 'persons',
        notes: 'Notes',
        notesPlaceholder: 'e.g. need high chair',
        send: 'Send',
        cancel: 'Cancel',
        confirm: 'Confirm',
        reservationSuccess: 'Reservation successful!',
        reservationError: 'Reservation failed',
        
        // Restaurant Details
        cuisine: 'Cuisine',
        address: 'Address',
        openingHours: 'Opening hours',
        rating: 'Rating',
        reviews: 'reviews',
        menu: 'Menu',
        call: 'Call',
        directions: 'Directions',
        website: 'Website',
        share: 'Share',
        
        // Weather
        weather: 'Weather',
        sunny: 'Sunny',
        cloudy: 'Cloudy',
        rainy: 'Rainy',
        stormy: 'Stormy',
        wind: 'Wind',
        temperature: 'Temperature',
        
        // Time
        today: 'Today',
        tomorrow: 'Tomorrow',
        yesterday: 'Yesterday',
        now: 'Now',
        daysAgo: 'days ago',
        monday: 'Monday',
        tuesday: 'Tuesday',
        wednesday: 'Wednesday',
        thursday: 'Thursday',
        friday: 'Friday',
        saturday: 'Saturday',
        sunday: 'Sunday',
        restDay: 'Closed',
        
        // General
        more: 'More',
        less: 'Less',
        none: 'None',
        loading: 'Loading...',
        error: 'Error',
        success: 'Success',
        noResults: 'No results',
        tryAgain: 'Try again',
        back: 'Back',
        close: 'Close',
        save: 'Save',
        delete: 'Delete',
        edit: 'Edit',
        
        // Footer & Legal
        footerText: '© 2025 Kiek mol in – Enjoy East Frisia',
        impressum: 'Legal Notice',
        privacy: 'Privacy Policy',
        contact: 'Contact',
        agb: 'Terms',
        
        // Offers
        todaysOffers: "Today's offers",
        discount: 'Discount',
        validUntil: 'Valid until',
        specialOffer: 'Special offer',
        
        // Accommodations
        accommodations: 'Accommodations',
        hotel: 'Hotel',
        apartment: 'Holiday apartment',
        pension: 'Guest house',
        pricePerNight: 'per night',
        checkIn: 'Check-in',
        checkOut: 'Check-out',
        availability: 'Availability',
        bookNow: 'Book now',
        inquire: 'Inquire',
        
        // Events
        events: 'Events',
        upcomingEvents: 'Upcoming events',
        noEvents: 'No events',
        eventDate: 'Date',
        eventTime: 'Time',
        eventLocation: 'Location',
        
        // Attractions
        attractions: 'Attractions',
        sights: 'Sights',
        nature: 'Nature',
        culture: 'Culture',
        family: 'Family',
        
        // Search
        searchResults: 'Search results',
        filterBy: 'Filter by',
        sortBy: 'Sort by',
        distance: 'Distance',
        popularity: 'Popularity',
        
        // Ratings
        excellent: 'Excellent',
        veryGood: 'Very good',
        good: 'Good',
        average: 'Average',
        
        // Cookie
        cookieText: 'We use cookies for app functionality.',
        cookieMore: 'Learn more',
        cookieAccept: 'Got it',
        
        // Favorites
        addToFavorites: 'Add to favorites',
        removeFromFavorites: 'Remove from favorites',
        noFavorites: 'No favorites yet',
        
        // Assistant
        assistantTitle: 'Your East Frisia Guide',
        assistantPlaceholder: 'Write a message...',
        askMe: 'Ask me something...',
        
        // Reservation extended
        sendReservation: 'Request reservation',
        optional: 'optional',
        namePlaceholder: 'John Doe',
        notesPlaceholder: 'High chair needed, allergies, etc.',
        '1person': '1 person',
        '2persons': '2 persons',
        '3persons': '3 persons',
        '4persons': '4 persons',
        '5persons': '5 persons',
        '6persons': '6 persons',
        '7persons': '7 persons',
        '8persons': '8+ persons',
        
        // Profile
        myProfile: 'My Profile',
        notLoggedIn: 'Not logged in',
        loginToSave: 'Log in to save your favorites and manage reservations.',
        loginWithGoogle: 'Login with Google',
        orWithEmail: 'or with email',
        logout: 'Logout',
        
        // Statistics
        reservationsToday: 'Reservations today',
        tablesFree: 'tables free',
        
        // Search
        searchRestaurant: 'Search restaurant...',
        
        // Profile & Login
        loginNow: 'Login now',
        login: 'Login',
        useWithoutLogin: 'You can use the app without logging in.',
        myFavorites: 'My Favorites',
        savedLocally: 'Saved locally',
        design: 'Design',
        
        // Reviews & Community
        writeReview: 'Write a review',
        reviewSuccess: 'Review saved! ⭐',
        reviewError: 'Error saving review',
        noReviews: 'No reviews yet',
        beFirst: 'Be the first!',
        helpful: 'Helpful',
        liveActivity: 'Recent activity',
        visitorsToday: 'Visitors today',
        reservedTable: 'reserved a table',
        gaveStars: 'gave a rating',
        uploadedPhoto: 'uploaded a photo',
        howWasExperience: 'How was your experience?',
        yourName: 'Your name',
        titleOptional: 'Title (optional)',
        yourReview: 'Your review',
        addPhotos: 'Add photos',
        submitReview: 'Submit review',
        maxPhotos: 'Maximum 4 photos',
        pleaseRate: 'Please give a rating'
    },
    nl: {
        // Header & Tagline
        tagline: 'Geniet van Oost-Friesland',
        change: 'Wijzigen ›',
        
        // Restaurants
        restaurants: 'Restaurants',
        all: 'Alles',
        openNow: 'Nu open',
        closed: 'Gesloten',
        freeTables: 'Vrije tafels',
        topRated: 'Best beoordeeld',
        available: 'Direct beschikbaar',
        waitlist: 'Wachtlijst',
        tablesLeft: 'Nog',
        tables: 'tafels vrij',
        table: 'tafel',
        reserve: 'Reserveren',
        reserveNow: 'Nu reserveren',
        noRestaurants: 'Geen restaurants gevonden',
        searchPlaceholder: 'Zoek restaurants...',
        
        // Navigation
        navFood: 'Eten',
        navSleep: 'Slapen',
        navEvents: 'Events',
        navDiscover: 'Ontdekken',
        navJobs: 'Vacatures',
        home: 'Home',
        map: 'Kaart',
        search: 'Zoeken',
        favorites: 'Favorieten',
        profile: 'Profiel',
        settings: 'Instellingen',
        
        // Location
        chooseLocation: 'Kies locatie',
        whereToGo: 'Waar wil je naartoe?',
        locationNotFound: 'Locatie niet gevonden?',
        allLocations: 'Alle locaties',
        searchLocation: 'Zoek locatie...',
        addLocation: 'Locatie toevoegen',
        
        // Taglines
        accommodationsTagline: 'Accommodaties in Oost-Friesland',
        eventsTagline: 'Evenementen in Oost-Friesland',
        jobsTagline: 'Vacatures in Oost-Friesland',
        attractionsTagline: 'Bezienswaardigheden in Oost-Friesland',
        
        // Jobs
        jobsOpen: 'Open vacatures',
        jobsUrgent: 'Dringend',
        currentJobs: 'Actuele vacatures',
        loadingJobs: 'Vacatures laden...',
        noJobs: 'Geen vacatures beschikbaar',
        fulltime: 'Voltijd',
        parttime: 'Deeltijd',
        minijob: 'Bijbaan',
        apply: 'Solliciteren',
        urgent: 'Dringend',
        
        // Reservering
        name: 'Naam',
        phone: 'Telefoon',
        email: 'E-mail',
        date: 'Datum',
        time: 'Tijd',
        guests: 'Gasten',
        person: 'persoon',
        persons: 'personen',
        notes: 'Opmerkingen',
        notesPlaceholder: 'bijv. kinderstoel nodig',
        send: 'Versturen',
        cancel: 'Annuleren',
        confirm: 'Bevestigen',
        reservationSuccess: 'Reservering gelukt!',
        reservationError: 'Reservering mislukt',
        
        // Restaurant Details
        cuisine: 'Keuken',
        address: 'Adres',
        openingHours: 'Openingstijden',
        rating: 'Beoordeling',
        reviews: 'beoordelingen',
        menu: 'Menukaart',
        call: 'Bellen',
        directions: 'Route',
        website: 'Website',
        share: 'Delen',
        
        // Weer
        weather: 'Weer',
        sunny: 'Zonnig',
        cloudy: 'Bewolkt',
        rainy: 'Regenachtig',
        stormy: 'Onweer',
        wind: 'Wind',
        temperature: 'Temperatuur',
        
        // Tijd
        today: 'Vandaag',
        tomorrow: 'Morgen',
        yesterday: 'Gisteren',
        now: 'Nu',
        daysAgo: 'dagen geleden',
        monday: 'Maandag',
        tuesday: 'Dinsdag',
        wednesday: 'Woensdag',
        thursday: 'Donderdag',
        friday: 'Vrijdag',
        saturday: 'Zaterdag',
        sunday: 'Zondag',
        restDay: 'Rustdag',
        
        // Algemeen
        more: 'Meer',
        less: 'Minder',
        none: 'Geen',
        loading: 'Laden...',
        error: 'Fout',
        success: 'Gelukt',
        noResults: 'Geen resultaten',
        tryAgain: 'Opnieuw proberen',
        back: 'Terug',
        close: 'Sluiten',
        save: 'Opslaan',
        delete: 'Verwijderen',
        edit: 'Bewerken',
        
        // Footer & Legal
        footerText: '© 2025 Kiek mol in – Geniet van Oost-Friesland',
        impressum: 'Impressum',
        privacy: 'Privacybeleid',
        contact: 'Contact',
        agb: 'Voorwaarden',
        
        // Aanbiedingen
        todaysOffers: 'Aanbiedingen vandaag',
        discount: 'Korting',
        validUntil: 'Geldig tot',
        specialOffer: 'Dagaanbieding',
        
        // Accommodaties
        accommodations: 'Accommodaties',
        hotel: 'Hotel',
        apartment: 'Vakantieappartement',
        pension: 'Pension',
        pricePerNight: 'per nacht',
        checkIn: 'Inchecken',
        checkOut: 'Uitchecken',
        availability: 'Beschikbaarheid',
        bookNow: 'Nu boeken',
        inquire: 'Aanvragen',
        
        // Events
        events: 'Evenementen',
        upcomingEvents: 'Komende evenementen',
        noEvents: 'Geen evenementen',
        eventDate: 'Datum',
        eventTime: 'Tijd',
        eventLocation: 'Locatie',
        
        // Attracties
        attractions: 'Bezienswaardigheden',
        sights: 'Bezienswaardigheden',
        nature: 'Natuur',
        culture: 'Cultuur',
        family: 'Familie',
        
        // Zoeken
        searchResults: 'Zoekresultaten',
        filterBy: 'Filteren op',
        sortBy: 'Sorteren op',
        distance: 'Afstand',
        popularity: 'Populariteit',
        
        // Beoordelingen
        excellent: 'Uitstekend',
        veryGood: 'Zeer goed',
        good: 'Goed',
        average: 'Gemiddeld',
        
        // Cookie
        cookieText: 'We gebruiken cookies voor de werking van de app.',
        cookieMore: 'Meer informatie',
        cookieAccept: 'Begrepen',
        
        // Favorieten
        addToFavorites: 'Aan favorieten toevoegen',
        removeFromFavorites: 'Uit favorieten verwijderen',
        noFavorites: 'Nog geen favorieten',
        
        // Assistent
        assistantTitle: 'Jouw Oost-Friesland Gids',
        assistantPlaceholder: 'Schrijf een bericht...',
        askMe: 'Vraag me iets...',
        
        // Reservering uitgebreid
        sendReservation: 'Reservering aanvragen',
        optional: 'optioneel',
        namePlaceholder: 'Jan Jansen',
        notesPlaceholder: 'Kinderstoel nodig, allergieën, etc.',
        '1person': '1 persoon',
        '2persons': '2 personen',
        '3persons': '3 personen',
        '4persons': '4 personen',
        '5persons': '5 personen',
        '6persons': '6 personen',
        '7persons': '7 personen',
        '8persons': '8+ personen',
        
        // Profiel
        myProfile: 'Mijn Profiel',
        notLoggedIn: 'Niet ingelogd',
        loginToSave: 'Log in om je favorieten op te slaan en reserveringen te beheren.',
        loginWithGoogle: 'Inloggen met Google',
        orWithEmail: 'of met e-mail',
        logout: 'Uitloggen',
        
        // Statistieken
        reservationsToday: 'Reserveringen vandaag',
        tablesFree: 'tafels vrij',
        
        // Zoeken
        searchRestaurant: 'Zoek restaurant...',
        
        // Profiel & Login
        loginNow: 'Nu inloggen',
        login: 'Inloggen',
        useWithoutLogin: 'Je kunt de app ook zonder inloggen gebruiken.',
        myFavorites: 'Mijn Favorieten',
        savedLocally: 'Lokaal opgeslagen',
        design: 'Design',
        
        // Reviews & Community
        writeReview: 'Schrijf een beoordeling',
        reviewSuccess: 'Beoordeling opgeslagen! ⭐',
        reviewError: 'Fout bij opslaan',
        noReviews: 'Nog geen beoordelingen',
        beFirst: 'Wees de eerste!',
        helpful: 'Nuttig',
        liveActivity: 'Recente activiteit',
        visitorsToday: 'Bezoekers vandaag',
        reservedTable: 'heeft gereserveerd',
        gaveStars: 'heeft beoordeeld',
        uploadedPhoto: 'heeft een foto geüpload',
        howWasExperience: 'Hoe was je ervaring?',
        yourName: 'Je naam',
        titleOptional: 'Titel (optioneel)',
        yourReview: 'Je beoordeling',
        addPhotos: "Foto's toevoegen",
        submitReview: 'Beoordeling versturen',
        maxPhotos: "Maximaal 4 foto's",
        pleaseRate: 'Geef een beoordeling'
    }
};

function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('kmi_language', lang);
    
    const t = translations[lang] || translations.de;
    
    // Buttons aktualisieren
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const activeBtn = document.getElementById('lang' + lang.toUpperCase());
    if (activeBtn) activeBtn.classList.add('active');
    
    // Texte aktualisieren
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
            el.textContent = t[key];
        }
    });
    
    // Placeholders aktualisieren
    document.querySelectorAll('[data-placeholder-i18n]').forEach(el => {
        const key = el.getAttribute('data-placeholder-i18n');
        if (t[key]) {
            el.placeholder = t[key];
        }
    });
    
    // Select Optionen (Personen) aktualisieren
    const partySizeSelect = document.getElementById('partySize');
    if (partySizeSelect) {
        const personWord = lang === 'en' ? 'person' : (lang === 'nl' ? 'persoon' : 'Person');
        const personsWord = lang === 'en' ? 'persons' : (lang === 'nl' ? 'personen' : 'Personen');
        partySizeSelect.innerHTML = `
            <option value="1">1 ${personWord}</option>
            <option value="2" selected>2 ${personsWord}</option>
            <option value="3">3 ${personsWord}</option>
            <option value="4">4 ${personsWord}</option>
            <option value="5">5 ${personsWord}</option>
            <option value="6">6 ${personsWord}</option>
            <option value="7">7 ${personsWord}</option>
            <option value="8">8+ ${personsWord}</option>
        `;
    }
    
    // Suchfeld Placeholder
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.placeholder = t.searchRestaurant || t.searchPlaceholder || 'Suchen...';
    }
    
    // Live Stats Text
    const liveLabel = document.querySelector('.live-label');
    if (liveLabel) {
        const resCount = document.getElementById('liveReservations')?.textContent || '0';
        const tablesCount = document.getElementById('liveFreeTables')?.textContent || '0';
        const resText = lang === 'en' ? 'reservations today' : (lang === 'nl' ? 'reserveringen vandaag' : 'Reservierungen heute');
        const tablesText = lang === 'en' ? 'tables free' : (lang === 'nl' ? 'tafels vrij' : 'Tische frei');
        liveLabel.innerHTML = `<span id="liveReservations">${resCount}</span> ${resText} • <span id="liveFreeTables">${tablesCount}</span> ${tablesText}`;
    }
    
    // Restaurants neu rendern
    renderRestaurants(currentRestaurantFilter);
    
    console.log('[OK] Sprache geändert:', lang);
}

function initLanguage() {
    const savedLang = localStorage.getItem('kmi_language') || 'de';
    setLanguage(savedLang);
}

// ==================== ÖFFNUNGSZEITEN ====================
function checkIfOpen(restaurant) {
    if (!restaurant.opening_hours) return true; // Default: offen
    
    const now = new Date();
    const currentDay = now.getDay(); // 0 = Sonntag, 1 = Montag, ...
    const currentTime = now.getHours() * 60 + now.getMinutes(); // Minuten seit Mitternacht
    
    // Ruhetag prüfen
    if (restaurant.rest_day !== null && restaurant.rest_day !== undefined) {
        const restDayMap = { 0: 1, 1: 2, 2: 3, 3: 4, 4: 5, 5: 6, 6: 0 }; // Konvertierung
        if (currentDay === restDayMap[restaurant.rest_day]) return false;
    }
    
    // Öffnungszeiten parsen
    const hours = restaurant.opening_hours;
    if (typeof hours === 'object') {
        const dayNames = ['so', 'mo', 'di', 'mi', 'do', 'fr', 'sa'];
        const dayKey = dayNames[currentDay];
        
        if (hours[dayKey + '_start'] && hours[dayKey + '_end']) {
            const openTime = parseTime(hours[dayKey + '_start']);
            const closeTime = parseTime(hours[dayKey + '_end']);
            return currentTime >= openTime && currentTime <= closeTime;
        }
    }
    
    // Standard-Öffnungszeiten (11:00 - 22:00)
    return currentTime >= 660 && currentTime <= 1320;
}

function parseTime(timeStr) {
    if (!timeStr) return 0;
    const [hours, minutes] = timeStr.split(':').map(Number);
    return hours * 60 + (minutes || 0);
}

// Google-Style Wochentage HTML generieren
function getWeekdayHoursHTML(restaurant) {
    const days = [
        {key: 'mo', name: 'Montag'},
        {key: 'di', name: 'Dienstag'},
        {key: 'mi', name: 'Mittwoch'},
        {key: 'do', name: 'Donnerstag'},
        {key: 'fr', name: 'Freitag'},
        {key: 'sa', name: 'Samstag'},
        {key: 'so', name: 'Sonntag'}
    ];
    
    const now = new Date();
    const currentDayIndex = now.getDay(); // 0=So, 1=Mo...
    const todayKey = ['so','mo','di','mi','do','fr','sa'][currentDayIndex];
    
    // Standard Öffnungszeiten aus Restaurant oder Default
    const openTime = restaurant?.opening_time || '11:00';
    const closeTime = restaurant?.closing_time || '22:00';
    const restDay = restaurant?.rest_day; // 0=Mo, 1=Di, 2=Mi, 3=Do, 4=Fr, 5=Sa, 6=So
    const restDayKeys = ['mo', 'di', 'mi', 'do', 'fr', 'sa', 'so'];
    
    let html = '';
    days.forEach(function(d, index) {
        const isToday = d.key === todayKey;
        let timeText = openTime + ' – ' + closeTime;
        let isClosed = false;
        
        // Ruhetag prüfen
        if (restDay !== null && restDay !== undefined && restDayKeys[restDay] === d.key) {
            timeText = 'Ruhetag';
            isClosed = true;
        }
        
        html += '<div class="hours-row' + (isToday ? ' today' : '') + '">';
        html += '<span class="hours-day">' + d.name + '</span>';
        html += '<span class="hours-time' + (isClosed ? ' closed-day' : '') + '">' + timeText + '</span>';
        html += '</div>';
    });
    
    return html;
}

// ==================== RESTAURANT FILTER ====================
let currentRestaurantFilter = 'all';

function filterRestaurants(filter) {
    currentRestaurantFilter = filter;
    
    // Buttons aktualisieren
    document.querySelectorAll('.filter-chip').forEach(btn => {
        btn.classList.remove('active');
    });
    const activeBtn = document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1));
    if (activeBtn) activeBtn.classList.add('active');
    
    // Restaurants neu rendern
    renderRestaurants(filter);
}

// ==================== SUPABASE CONFIG ====================
// HINWEIS: Keys werden für Realtime benötigt, aber API-Calls gehen über Netlify Functions
var SUPABASE_URL = 'https://mvrgmbdokdzmumdyezha.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12cmdtYmRva2R6bXVtZHllemhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjEyOTgsImV4cCI6MjA4MTEzNzI5OH0.7Ciwa2UKUHwtorvq3p6sN69XmVvPg0Kvg5lgrovxpDw';

// Sicherer API Wrapper - nutzt Netlify Function wenn verfügbar
const USE_SECURE_API = window.location.hostname !== 'localhost' && window.location.protocol !== 'file:';

async function secureApiCall(action, table, options = {}) {
    const { data, filters, id } = options;
    
    // Auf localhost direkt zu Supabase (für Entwicklung)
    if (!USE_SECURE_API) {
        return directSupabaseCall(action, table, options);
    }
    
    // Über Netlify Function (Produktion)
    try {
        const response = await fetch('/.netlify/functions/api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, table, data, filters, id })
        });
        
        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('Secure API Error:', error);
        // Fallback zu direktem Call
        return directSupabaseCall(action, table, options);
    }
}

async function directSupabaseCall(action, table, options = {}) {
    const { data, filters, id } = options;
    let url = `${SUPABASE_URL}/rest/v1/${table}`;
    let method = 'GET';
    let body = null;
    
    switch (action) {
        case 'select':
            if (filters) url += `?${filters}`;
            method = 'GET';
            break;
        case 'insert':
            method = 'POST';
            body = JSON.stringify(data);
            break;
        case 'update':
            if (id) url += `?id=eq.${id}`;
            else if (filters) url += `?${filters}`;
            method = 'PATCH';
            body = JSON.stringify(data);
            break;
        case 'delete':
            if (id) url += `?id=eq.${id}`;
            else if (filters) url += `?${filters}`;
            method = 'DELETE';
            break;
    }
    
    const response = await fetch(url, {
        method,
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': action === 'insert' ? 'return=representation' : undefined
        },
        body
    });
    
    return await response.json().catch(() => ({}));
}

let useSupabase = true; // Immer Supabase verwenden
let currentAdmin = null;

// Session ID für Presence Tracking
const SESSION_ID = localStorage.getItem('kmi_session_id') || (() => {
    const id = 'sess_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('kmi_session_id', id);
    return id;
})();

// ==================== REALTIME SUBSCRIPTIONS ====================
let realtimeSubscriptions = [];

async function initRealtime() {
    if (!window.supabaseClient) return;
    
    try {
        // Reviews Echtzeit
        const reviewChannel = window.supabaseClient
            .channel('reviews-changes')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'reviews' },
                (payload) => {
                    console.log('🔴 Neue Review:', payload);
                    handleRealtimeReview(payload);
                }
            )
            .subscribe();
        realtimeSubscriptions.push(reviewChannel);
        
        // Activity Echtzeit
        const activityChannel = window.supabaseClient
            .channel('activity-changes')
            .on('postgres_changes',
                { event: 'INSERT', schema: 'public', table: 'activity_log' },
                (payload) => {
                    console.log('🔴 Neue Aktivität:', payload);
                    handleRealtimeActivity(payload);
                }
            )
            .subscribe();
        realtimeSubscriptions.push(activityChannel);
        
        console.log('[OK] Realtime aktiviert');
    } catch (e) {
        console.log('Realtime nicht verfügbar:', e);
    }
}

function handleRealtimeReview(payload) {
    if (payload.eventType === 'INSERT') {
        const review = payload.new;
        // Toast anzeigen
        showToast(`⭐ Neue ${review.rating}-Sterne Bewertung!`, 'success');
        // Reviews neu laden wenn Modal offen
        if (document.getElementById('reviewsModal')?.classList.contains('active')) {
            loadReviews(review.target_type, review.target_id);
        }
    }
}

function handleRealtimeActivity(payload) {
    const activity = payload.new;
    // Live-Feed aktualisieren
    updateLiveActivityFeed(activity);
}

// ==================== REVIEWS SYSTEM ====================
async function loadReviews(targetType, targetId) {
    try {
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/reviews?target_type=eq.${targetType}&target_id=eq.${targetId}&is_approved=eq.true&order=created_at.desc&limit=20`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY
                }
            }
        );
        
        if (!response.ok) return [];
        return await response.json();
    } catch (e) {
        console.error('Reviews laden fehlgeschlagen:', e);
        return [];
    }
}

async function loadReviewPhotos(reviewId) {
    try {
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/review_photos?review_id=eq.${reviewId}`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY
                }
            }
        );
        
        if (!response.ok) return [];
        return await response.json();
    } catch (e) {
        console.error('Review Fotos laden fehlgeschlagen:', e);
        return [];
    }
}

async function submitReview(targetType, targetId, targetName, rating, title, comment, photos = []) {
    const t = translations[currentLanguage] || translations.de;
    
    // User Name
    const userName = APP_DATA.currentUser?.name || localStorage.getItem('kmi_guest_name') || 'Gast';
    
    try {
        // Review erstellen
        const response = await fetch(`${SUPABASE_URL}/rest/v1/reviews`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify({
                target_type: targetType,
                target_id: targetId,
                user_id: APP_DATA.currentUser?.id || null,
                user_name: userName,
                user_avatar: APP_DATA.currentUser?.avatar || null,
                rating: rating,
                title: title,
                comment: comment
            })
        });
        
        if (!response.ok) throw new Error('Review speichern fehlgeschlagen');
        
        const review = (await response.json())[0];
        
        // Fotos hochladen
        if (photos.length > 0) {
            for (const photo of photos) {
                await fetch(`${SUPABASE_URL}/rest/v1/review_photos`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        review_id: review.id,
                        image_url: photo
                    })
                });
            }
        }
        
        // Activity loggen
        await logActivity('review', targetType, targetId, targetName, `hat ${rating} Sterne gegeben`, { rating, title });
        
        showToast(t.reviewSuccess || 'Bewertung gespeichert! ⭐', 'success');
        return review;
        
    } catch (e) {
        console.error('Review Fehler:', e);
        showToast(t.reviewError || 'Fehler beim Speichern', 'error');
        return null;
    }
}

// ==================== ACTIVITY LOG ====================
async function logActivity(activityType, targetType, targetId, targetName, message, metadata = {}) {
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/activity_log`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                activity_type: activityType,
                target_type: targetType,
                target_id: targetId,
                target_name: targetName,
                user_id: APP_DATA.currentUser?.id || null,
                user_name: APP_DATA.currentUser?.name || localStorage.getItem('kmi_guest_name') || 'Jemand',
                message: message,
                metadata: metadata
            })
        });
    } catch (e) {
        console.log('Activity log fehlgeschlagen:', e);
    }
}

async function loadRecentActivity(targetType, targetId, limit = 5) {
    try {
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/activity_log?target_type=eq.${targetType}&target_id=eq.${targetId}&order=created_at.desc&limit=${limit}`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY
                }
            }
        );
        
        if (!response.ok) return [];
        return await response.json();
    } catch (e) {
        console.error('Activity laden fehlgeschlagen:', e);
        return [];
    }
}

// ==================== PRESENCE TRACKING ====================
async function updatePresence(targetType, targetId) {
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/presence`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'resolution=merge-duplicates'
            },
            body: JSON.stringify({
                target_type: targetType,
                target_id: targetId,
                session_id: SESSION_ID,
                user_id: APP_DATA.currentUser?.id || null,
                last_seen: new Date().toISOString()
            })
        });
    } catch (e) {
        console.log('Presence update fehlgeschlagen:', e);
    }
}

async function getPresenceCount(targetType, targetId) {
    try {
        // Nur Sessions der letzten 5 Minuten
        const fiveMinAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
        
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/presence?target_type=eq.${targetType}&target_id=eq.${targetId}&last_seen=gte.${fiveMinAgo}&select=count`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Prefer': 'count=exact'
                }
            }
        );
        
        const count = response.headers.get('content-range')?.split('/')[1] || 0;
        return parseInt(count);
    } catch (e) {
        return 0;
    }
}

// ==================== STATS ====================
async function getTargetStats(targetType, targetId) {
    try {
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/target_stats?target_type=eq.${targetType}&target_id=eq.${targetId}`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY
                }
            }
        );
        
        if (!response.ok) return null;
        const data = await response.json();
        return data[0] || null;
    } catch (e) {
        return null;
    }
}

async function getTodayVisitors(targetType, targetId) {
    try {
        const today = new Date().toISOString().split('T')[0];
        
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/activity_log?target_type=eq.${targetType}&target_id=eq.${targetId}&created_at=gte.${today}&select=count`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Prefer': 'count=exact'
                }
            }
        );
        
        const count = response.headers.get('content-range')?.split('/')[1] || 0;
        return parseInt(count);
    } catch (e) {
        return 0;
    }
}

// Live Activity Feed Update
function updateLiveActivityFeed(activity) {
    const feedContainer = document.getElementById('liveActivityFeed');
    if (!feedContainer) return;
    
    const timeAgo = getTimeAgo(new Date(activity.created_at));
    const icon = activity.activity_type === 'reservation' ? '🍴' : 
                 activity.activity_type === 'review' ? '⭐' : 
                 activity.activity_type === 'photo' ? '📸' : '👀';
    
    const item = document.createElement('div');
    item.className = 'activity-item activity-new';
    item.innerHTML = `
        <span class="activity-icon">${icon}</span>
        <span class="activity-text">${activity.user_name || 'Jemand'} ${activity.message}</span>
        <span class="activity-time">${timeAgo}</span>
    `;
    
    feedContainer.insertBefore(item, feedContainer.firstChild);
    
    // Animation
    setTimeout(() => item.classList.remove('activity-new'), 100);
    
    // Max 10 Items
    while (feedContainer.children.length > 10) {
        feedContainer.removeChild(feedContainer.lastChild);
    }
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    if (seconds < 60) return 'gerade eben';
    if (seconds < 3600) return `vor ${Math.floor(seconds / 60)} Min`;
    if (seconds < 86400) return `vor ${Math.floor(seconds / 3600)} Std`;
    return `vor ${Math.floor(seconds / 86400)} Tagen`;
}

// ==================== ADMIN AUTH ====================
// Passwort wird in Supabase gespeichert - nicht im Code!

function checkAdminSession() {
    return localStorage.getItem('kmi_admin_logged_in') === 'true';
}

async function simpleLogin() {
    const password = document.getElementById('adminPassword').value;
    const errorEl = document.getElementById('loginError');
    
    if (!password) {
        if (errorEl) {
            errorEl.textContent = 'Bitte Passwort eingeben';
            errorEl.style.display = 'block';
        }
        return;
    }
    
    try {
        // Passwort aus Supabase prüfen
        const response = await fetch(`${SUPABASE_URL}/rest/v1/settings?key=eq.admin_password`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        const data = await response.json();
        const storedPassword = data[0]?.value;
        
        if (password === storedPassword) {
            localStorage.setItem('kmi_admin_logged_in', 'true');
            currentAdmin = { 
                name: 'Ibo', 
                email: 'ibo@kiekmolin.de', 
                role: 'Admin',
                restaurant_id: null,        // Admin hat KEIN eigenes Restaurant
                restaurant_name: null,
                isAdmin: true               // Admin kann ALLE Restaurants sehen/verwalten
            };
            
            closeModal('adminLoginModal');
            document.getElementById('adminPassword').value = '';
            
            // Dashboard anzeigen
            document.getElementById('guestView').classList.add('hidden');
            document.getElementById('dashboardView').classList.add('active');
            document.querySelectorAll('.toggle-btn')[0].classList.remove('active');
            document.querySelectorAll('.toggle-btn')[1].classList.add('active');
            
            // Initiale Section anzeigen
            showDashboardSection('dashboard');
            
            // Greeting aktualisieren
            const greeting = document.querySelector('.dash-greeting');
            if (greeting) greeting.textContent = 'Moin, Ibo! ';
            
            updateAdminProfile();
            
            // Supabase Verbindung initialisieren und Dashboard updaten
            initSupabase().then(() => {
                updateDashboard();
                loadDashboardStats();
            });
            
            showToast('Willkommen zurück, Ibo!', 'success');
        } else {
            if (errorEl) {
                errorEl.textContent = 'Falsches Passwort';
                errorEl.style.display = 'block';
            }
            document.getElementById('adminPassword').value = '';
        }
    } catch (e) {
        console.error('Login Fehler:', e);
        if (errorEl) {
            errorEl.textContent = 'Verbindungsfehler';
            errorEl.style.display = 'block';
        }
    }
}

// Geheimer Admin-Zugang: 5x auf Logo tippen
let adminTapCount = 0;
let adminTapTimer = null;

function secretAdminTap() {
    adminTapCount++;
    
    if (adminTapTimer) clearTimeout(adminTapTimer);
    
    // Reset nach 3 Sekunden
    adminTapTimer = setTimeout(() => {
        adminTapCount = 0;
    }, 3000);
    
    // Nach 5 Taps: Admin Login öffnen
    if (adminTapCount >= 5) {
        adminTapCount = 0;
        openModal('adminLoginModal');
    }
}

function adminLogout() {
    currentAdmin = null;
    localStorage.removeItem('kmi_admin_logged_in');
    
    document.getElementById('guestView').classList.remove('hidden');
    document.getElementById('dashboardView').classList.remove('active');
    document.querySelectorAll('.toggle-btn')[0].classList.add('active');
    document.querySelectorAll('.toggle-btn')[1].classList.remove('active');
    
    showToast('Abgemeldet');
}

function updateAdminProfile() {
    const avatarEl = document.getElementById('adminAvatar');
    const nameEl = document.getElementById('adminName');
    const emailEl = document.getElementById('adminEmailDisplay');
    
    if (avatarEl) avatarEl.textContent = 'I';
    if (nameEl) nameEl.textContent = 'Ibo';
    if (emailEl) emailEl.textContent = 'Inhaber • Kiek mol in';
}

// REST API Helper
async function supabaseGet(table, query = '') {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, {
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + SUPABASE_KEY
        }
    });
    if (!response.ok) throw new Error('HTTP ' + response.status);
    return response.json();
}

async function supabaseDelete(table, id) {
    var r = await fetch(SUPABASE_URL+'/rest/v1/'+table+'?id=eq.'+id,{method:'DELETE',headers:{'apikey':SUPABASE_KEY,'Authorization':'Bearer '+SUPABASE_KEY}});
    if (!r.ok) throw new Error('HTTP '+r.status); return true;
}

async function supabasePost(table, data) {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
        method: 'POST',
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + SUPABASE_KEY,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
        },
        body: JSON.stringify(data)
    });
    if (!response.ok) throw new Error('HTTP ' + response.status);
    return true;
}

async function initSupabase() {
    const statusEl = document.getElementById('connectionStatus');
    console.log('Verbinde mit Supabase...');
    
    var client = sb || window.sb;
    if (!client) {
        console.log('[!] Kein Supabase Client');
        return;
    }
    
    try {
        // Lade Restaurants mit Supabase Client (kein fetch!)
        var { data: restaurants, error } = await client.from('restaurants').select('*').eq('is_active', true);
        
        if (error) throw new Error(error.message);
        
        console.log('[OK] Supabase verbunden! Restaurants:', restaurants.length);
        
        useSupabase = true;
        if (typeof updateConnectionStatus === 'function') {
            updateConnectionStatus(true, '✓ Verbunden - ' + restaurants.length + ' Restaurants');
        }
        
        if (statusEl) {
            statusEl.innerHTML = '● Mit Supabase verbunden';
            statusEl.style.color = 'var(--success)';
        }
        
        // Restaurants direkt verarbeiten
        if (restaurants && restaurants.length > 0) {
            APP_DATA.restaurants = restaurants.map(function(r) {
                return {
                    id: r.id,
                    name: r.name,
                    cuisine: r.cuisine_type ? r.cuisine_type[0] : 'deutsch',
                    rating: r.rating || 4.5,
                    reviewCount: r.review_count || 0,
                    freeTables: 5,
                    waitTime: 0,
                    phone: r.phone || '',
                    whatsapp: r.whatsapp || null,
                    address: r.address || (r.street || '') + ', ' + (r.zip || '') + ' ' + (r.city || ''),
                    street: r.street || '',
                    city: r.city || '',
                    zip: r.zip || '',
                    googleMapsUrl: r.google_maps_url || '',
                    instagram: r.instagram || '',
                    tiktok: r.tiktok || '',
                    lat: parseFloat(r.latitude) || 53.5021,
                    lng: parseFloat(r.longitude) || 7.0965,
                    image: r.image_url || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800',
                    offer: null
                };
            });
            console.log('[OK] Restaurants geladen:', APP_DATA.restaurants.length);
        }
        
        // UI aktualisieren
        if (typeof renderRestaurants === 'function') renderRestaurants();
        if (typeof updateMapMarkers === 'function') updateMapMarkers();
        
        setTimeout(function() {
            if (typeof loadLocations === 'function') loadLocations();
            if (typeof loadCustomLocations === 'function') loadCustomLocations();
            if (typeof updateLiveStats === 'function') updateLiveStats();
        }, 500);
        
        if (typeof showToast === 'function') showToast(APP_DATA.restaurants.length + ' Restaurants geladen!', 'success');
        
    } catch (e) {
        console.error('[!] Supabase Fehler:', e.message);
        useSupabase = false;
        if (typeof updateConnectionStatus === 'function') {
            updateConnectionStatus(false, '✗ Fehler: ' + e.message);
        }
        
        if (statusEl) {
            statusEl.innerHTML = '○ Offline-Modus';
            statusEl.style.color = 'var(--warning)';
        }
    }
}

async function refreshData() {
    showToast('Daten werden aktualisiert...', '');
    
    if (useSupabase) {
        await loadFromSupabase();
        showToast('Daten aktualisiert!', 'success');
    } else {
        // Versuche erneut zu verbinden
        await loadFromSupabase();
    }
}

// Verbindungsstatus aktualisieren
function updateConnectionStatus(connected, message) {
    const dot = document.getElementById('dbStatusDot');
    const text = document.getElementById('dbStatusText');
    const banner = document.getElementById('dashboardConnectionBanner');
    
    if (!dot || !text) return;
    
    if (connected) {
        dot.style.background = '#10b981';
        dot.style.animation = 'pulse 2s infinite';
        text.textContent = message || '✓ Mit Supabase verbunden';
        text.style.color = '#059669';
        if (banner) banner.style.borderColor = '#10b981';
    } else {
        dot.style.background = '#ef4444';
        dot.style.animation = 'none';
        text.textContent = message || '✗ Offline - Keine Verbindung';
        text.style.color = '#dc2626';
        if (banner) banner.style.borderColor = '#fecaca';
    }
}

// Erneut verbinden
async function retrySupabaseConnection() {
    const text = document.getElementById('dbStatusText');
    const dot = document.getElementById('dbStatusDot');
    
    if (text) {
        text.textContent = 'Verbinde...';
        text.style.color = 'var(--slate)';
    }
    if (dot) {
        dot.style.background = '#f59e0b';
        dot.style.animation = 'pulse 1s infinite';
    }
    
    await initSupabase();
}

async function loadFromSupabase() {
    try {
        // Restaurants laden
        const restaurants = await supabaseGet('restaurants', 'select=*&is_active=eq.true');
        
        if (restaurants && restaurants.length > 0) {
            APP_DATA.restaurants = restaurants.map(r => ({
                id: r.id,
                name: r.name,
                cuisine: r.cuisine_type?.[0] || 'deutsch',
                rating: r.rating || 4.5,
                freeTables: 5,
                waitTime: 0,
                phone: r.phone || '',
                whatsapp: r.whatsapp || null,
                address: r.address || `${r.street || ''}, ${r.zip || ''} ${r.city || ''}`,
                street: r.street || '',
                city: r.city || '',
                zip: r.zip || '',
                googleMapsUrl: r.google_maps_url || '',
                instagram: r.instagram || '',
                tiktok: r.tiktok || '',
                lat: parseFloat(r.latitude) || 53.5021,
                lng: parseFloat(r.longitude) || 7.0965,
                image: r.image_url || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800',
                offer: null
            }));
        }
        
        // Tische laden
        const tables = await supabaseGet('tables', 'select=*');
        if (tables) {
            APP_DATA.restaurants.forEach(r => {
                const restaurantTables = tables.filter(t => t.restaurant_id === r.id);
                const free = restaurantTables.filter(t => t.status === 'free').length;
                if (free > 0) r.freeTables = free;
            });
        }
        
        // Reservierungen laden
        const reservations = await supabaseGet('reservations', `select=*&reservation_date=eq.${TODAY}`);
        if (reservations && reservations.length > 0) {
            APP_DATA.reservations = reservations.map(r => ({
                id: r.id,
                restaurantId: r.restaurant_id,
                restaurantName: APP_DATA.restaurants.find(rest => rest.id === r.restaurant_id)?.name || '',
                guestName: r.guest_name,
                guestPhone: r.guest_phone || '',
                date: r.reservation_date,
                time: r.reservation_time,
                partySize: r.party_size,
                notes: r.notes || '',
                status: r.status,
                source: r.source || 'app'
            }));
        }
        
        // Angebote laden
        const offers = await supabaseGet('offers', 'select=*&is_active=eq.true');
        if (offers && offers.length > 0) {
            APP_DATA.offers = offers.map(o => ({
                id: o.id,
                restaurantId: o.restaurant_id,
                title: o.title,
                discount: o.discount,
                validUntil: o.valid_until ? new Date(o.valid_until).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'}) : '20:00',
                description: o.description || ''
            }));
            
            // Offers zu Restaurants zuordnen
            APP_DATA.restaurants.forEach(r => {
                const offer = offers.find(o => o.restaurant_id === r.id);
                if (offer) {
                    r.offer = { title: offer.title, discount: offer.discount, price: '' };
                }
            });
        }
        
        // UI aktualisieren
        renderRestaurants();
        updateDashboard();
        if (typeof updateMapMarkers === 'function') updateMapMarkers();
        
        console.log('[OK] Daten geladen:', APP_DATA.restaurants.length, 'Restaurants');
        
    } catch (e) {
        console.error('Fehler beim Laden:', e);
    }
}

async function saveReservationToSupabase(reservation) {
    if (!useSupabase) {
        console.log('⚠️ Supabase nicht aktiv');
        return;
    }
    
    console.log('📤 Speichere Online-Reservierung in Supabase:', reservation);
    
    try {
        // Direkt in Supabase speichern (nicht über RPC)
        const response = await fetch(SUPABASE_URL + '/rest/v1/reservations', {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify({
                restaurant_id: reservation.restaurantId || 1,
                guest_name: reservation.guestName,
                guest_phone: reservation.guestPhone || '',
                party_size: parseInt(reservation.partySize) || 2,
                reservation_date: reservation.date,
                reservation_time: reservation.time,
                status: 'pending',
                source: 'app',
                notes: reservation.notes || '',
                table_id: reservation.tableId || 1
            })
        });
        
        if (response.ok) {
            const savedRes = await response.json();
            console.log('✅ Online-Reservierung gespeichert:', savedRes);
            
            // WICHTIG: Auch in lokales Array für Kalender/Tischplan
            if (savedRes && savedRes.length > 0) {
                const r = savedRes[0];
                const localRes = {
                    id: r.id,
                    date: r.reservation_date,
                    time: r.reservation_time,
                    name: r.guest_name,
                    persons: r.party_size || 2,
                    phone: r.guest_phone || '',
                    table: r.table_id || 1,
                    notes: r.notes || '',
                    status: r.status || 'pending',
                    source: 'app',
                    restaurant_id: r.restaurant_id
                };
                
                // Zu globalem Array hinzufügen
                if (window.resAllReservations) {
                    window.resAllReservations.push(localRes);
                    console.log('📅 Zum Kalender hinzugefügt:', localRes);
                }
                
                // UI aktualisieren
                if (typeof window.resRenderAll === 'function') {
                    window.resRenderAll();
                }
                
                // Benachrichtigung zeigen
                if (typeof window.resShowNewReservationAlert === 'function') {
                    window.resShowNewReservationAlert(localRes);
                }
            }
            
            showToast('Reservierung erfolgreich gespeichert!', 'success');
        } else {
            const errText = await response.text();
            console.error('❌ Fehler beim Speichern:', response.status, errText);
            showToast('Fehler beim Speichern der Reservierung', 'error');
        }
    } catch (e) {
        console.error('❌ Speichern fehlgeschlagen:', e);
        showToast('Verbindungsfehler', 'error');
    }
}

async function saveOfferToSupabase(offer) {
    if (!useSupabase) return;
    
    try {
        const validUntil = new Date();
        const [hours, minutes] = offer.validUntil.split(':');
        validUntil.setHours(parseInt(hours), parseInt(minutes), 0);
        
        await supabasePost('offers', {
            restaurant_id: offer.restaurantId || APP_DATA.restaurants[0]?.id,
            title: offer.title,
            discount: offer.discount,
            description: offer.description || '',
            valid_until: validUntil.toISOString(),
            is_active: true
        });
        console.log('[OK] Angebot gespeichert');
    } catch (e) {
        console.error('Speichern fehlgeschlagen:', e);
    }
}

// ==================== DATA STORE ====================
// Get today's date in YYYY-MM-DD format
const TODAY = new Date().toISOString().split('T')[0];

// Keine Demo-Daten - alles aus Supabase
const DEFAULT_RESERVATIONS = [];
const DEFAULT_OFFERS = [];

// Initialize data
function getInitialData(key, defaultValue) {
    return defaultValue; // Immer leer starten, Daten kommen aus Supabase
}

const APP_DATA = {
    currentLocation: 'Greetsiel',
    currentFilter: 'all',
    favorites: getInitialData('kmi_favorites', []),
    reservations: getInitialData('kmi_reservations', []),
    offers: [],
    restaurantOpen: true,
    tables: [],
    restaurants: []
};

// ==================== UTILITY FUNCTIONS ====================
function saveData() {
    localStorage.setItem('kmi_favorites', JSON.stringify(APP_DATA.favorites));
    localStorage.setItem('kmi_reservations', JSON.stringify(APP_DATA.reservations));
    localStorage.setItem('kmi_offers', JSON.stringify(APP_DATA.offers));
    localStorage.setItem('kmi_tables', JSON.stringify(APP_DATA.tables));
    localStorage.setItem('kmi_restaurant_open', JSON.stringify(APP_DATA.restaurantOpen));
}

function showToast(message, type = 'default') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
    } else {
        console.error('Modal nicht gefunden:', modalId);
    }
}

function closeModal(modalId) {
    console.log('🔥 MODAL SCHLIESSEN:', modalId);
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
        console.log('✅ Modal geschlossen:', modalId);
    }
}

function formatDate(date) {
    const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
    return new Date(date).toLocaleDateString('de-DE', options);
}

// ==================== VIEW SWITCHING ====================
function showGuestView() {
    document.getElementById('guestView').classList.remove('hidden');
    document.getElementById('dashboardView').classList.remove('active');
    document.querySelectorAll('.toggle-btn')[0].classList.add('active');
    document.querySelectorAll('.toggle-btn')[1].classList.remove('active');
    
    // Warenkorb Button aktualisieren (zeigen falls Artikel vorhanden)
    if (typeof updateCartBadges === 'function') updateCartBadges();
}

function showView(view) {
    if (view === 'guest') {
        showGuestView();
    } else if (view === 'dashboard') {
        showDashboard();
    }
    
    // Warenkorb Button aktualisieren nach View-Wechsel
    setTimeout(() => {
        if (typeof updateCartBadges === 'function') updateCartBadges();
    }, 100);
}

function showDashboard() {
    // Check if logged in
    if (!currentAdmin && !checkAdminSession()) {
        // Show login modal
        openModal('adminLoginModal');
        return;
    }
    
    // Warenkorb Button verstecken im Dashboard
    const cartBtn = document.getElementById('cartButtonFixed');
    if (cartBtn) cartBtn.classList.remove('visible');
    
    // Update greeting with name
    const greeting = document.querySelector('.dash-greeting');
    if (greeting && currentAdmin) {
        greeting.textContent = `Moin, ${currentAdmin.name}! `;
    }
    
    // Update sidebar profile
    updateAdminProfile();
    
    document.getElementById('guestView').classList.add('hidden');
    document.getElementById('dashboardView').classList.add('active');
    document.querySelectorAll('.toggle-btn')[0].classList.remove('active');
    document.querySelectorAll('.toggle-btn')[1].classList.add('active');
    updateDashboard();
}

// ==================== GUEST APP FUNCTIONS ====================
function renderRestaurants(filter = 'all') {
    const container = document.getElementById('restaurantList');
    if (!container) return;
    
    const t = translations[currentLanguage] || translations.de;
    
    const searchInput = document.getElementById('searchInput');
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    
    // Wenn keine Restaurants, zeige Ladehinweis
    if (!APP_DATA.restaurants || APP_DATA.restaurants.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                <div style="font-size: 32px; margin-bottom: 16px; color: var(--slate);">🍽️</div>
                <h3 style="color: var(--text-primary); margin-bottom: 8px;">${t.noRestaurants || 'Keine Restaurants gefunden'}</h3>
                <p>${t.loading || 'Laden...'}</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    let visibleCount = 0;
    let totalFreeTables = 0;
    let offersCount = 0;
    
    // Sortierung basierend auf Filter
    let restaurants = [...APP_DATA.restaurants];
    if (filter === 'rating') {
        restaurants.sort((a, b) => (b.rating || 0) - (a.rating || 0));
    }
    
    restaurants.forEach(r => {
        const matchesFilter = APP_DATA.currentFilter === 'all' || r.cuisine === APP_DATA.currentFilter;
        const matchesSearch = r.name.toLowerCase().includes(searchTerm);
        
        // Öffnungszeiten prüfen
        const isOpen = checkIfOpen(r);
        
        // Filter-Logik
        let passesFilter = true;
        if (filter === 'open' && !isOpen) passesFilter = false;
        if (filter === 'tables' && r.freeTables < 1) passesFilter = false;
        
        const isVisible = matchesFilter && matchesSearch && passesFilter;
        
        if (isVisible) {
            visibleCount++;
            totalFreeTables += r.freeTables;
            if (r.offer) offersCount++;
        }
        
        const isFavorite = APP_DATA.favorites.includes(r.id);
        
        let availabilityClass, availabilityText;
        if (r.freeTables === 0) {
            availabilityClass = 'full';
            availabilityText = t.waitlist || 'Warteliste';
        } else if (r.freeTables <= 2) {
            availabilityClass = 'limited';
            availabilityText = `${t.tablesLeft || 'Noch'} ${r.freeTables} ${r.freeTables === 1 ? (t.table || 'Tisch') : (t.tables || 'Tische')}`;
        } else {
            availabilityClass = 'available';
            availabilityText = t.available || 'Sofort verfügbar';
        }
        
        // Öffnungszeiten Badge
        const openBadge = isOpen 
            ? `<span class="open-badge open">${t.openNow || 'Jetzt geöffnet'}</span>`
            : `<span class="open-badge closed">${t.closed || 'Geschlossen'}</span>`;
        
        // Tische frei Text
        const tablesText = r.freeTables === 1 
            ? `1 ${t.table || 'Tisch'} ${currentLanguage === 'nl' ? 'vrij' : (currentLanguage === 'en' ? 'free' : 'frei')}`
            : `${r.freeTables} ${t.tables || 'Tische'} ${currentLanguage === 'nl' ? 'vrij' : (currentLanguage === 'en' ? 'free' : 'frei')}`;
        
        // Wartezeit Text
        const waitText = r.waitTime > 0 
            ? `~${r.waitTime} ${currentLanguage === 'en' ? 'min' : 'Min'}`
            : (t.available || 'Sofort verfügbar');
        
        // Heute Spezial Text
        const specialLabel = currentLanguage === 'en' ? 'Special today' : (currentLanguage === 'nl' ? 'Dagspecial' : 'Heute Spezial');
        const onlyText = currentLanguage === 'en' ? 'only' : (currentLanguage === 'nl' ? 'slechts' : 'nur');
        
        // WhatsApp Nachricht
        const whatsappMsg = currentLanguage === 'en' 
            ? 'Hello! I would like to reserve a table via Kiek mol in.'
            : (currentLanguage === 'nl' 
                ? 'Hallo! Ik wil graag een tafel reserveren via Kiek mol in.'
                : 'Hallo! Ich möchte gerne einen Tisch reservieren über Kiek mol in.');
        
        // Besucher heute (aus Cache oder 0)
        const visitorsToday = r.visitorsToday || Math.floor(Math.random() * 15) + 1; // Demo-Daten
        const isTrending = visitorsToday > 10;
        const visitorsText = currentLanguage === 'en' ? 'today' : (currentLanguage === 'nl' ? 'vandaag' : 'heute');
        
        // Beste Zeit berechnen
        const bestTimeInfo = getBestTime(r.id);
        const bestTimeText = bestTimeInfo ? `Beste Zeit: ${bestTimeInfo.bestHour}:00` : '';
        
        // Wartezeit berechnen
        const waitTimeInfo = getWaitTime(r.id);
        const dynamicWaitText = waitTimeInfo.waitTime > 0 
            ? `~${waitTimeInfo.waitTime} Min Wartezeit`
            : (t.available || 'Sofort verfügbar');
        
        html += `
            <div class="restaurant-card ${isVisible ? '' : 'hidden'}" data-id="${r.id}" data-cuisine="${r.cuisine}">
                <div class="card-image" style="background-image: url('${r.image}')">
                    ${r.offer ? `<div class="special-badge">${r.offer.discount}</div>` : ''}
                    <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite('${r.id}')">
                        <svg viewBox="0 0 24 24" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                    </button>
                </div>
                <div class="card-content">
                    <div class="card-top">
                        <h3 class="restaurant-name">${r.name}</h3>
                        <div class="rating">
                            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            ${r.rating}
                        </div>
                    </div>
                    <p class="card-cuisine">${r.cuisine} · ${r.city || 'Ostfriesland'}</p>
                    
                    <!-- Google Öffnungszeiten -->
                    <div class="hours-google">
                        <div class="hours-header" onclick="this.nextElementSibling.classList.toggle('expanded'); this.querySelector('.hours-arrow').classList.toggle('expanded')">
                            <div class="hours-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                            </div>
                            <div class="hours-status">
                                <span class="hours-main ${isOpen ? 'open' : 'closed'}">${isOpen ? 'Geöffnet' : 'Geschlossen'}</span><span class="hours-sub"> · ${isOpen ? 'Schließt um ' + (r.closing_time || '22:00') : 'Öffnet ' + (r.opening_time || '11:00')}</span>
                            </div>
                            <svg class="hours-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                        <div class="hours-dropdown">
                            <div class="hours-list">
                                ${getWeekdayHoursHTML(r)}
                            </div>
                        </div>
                    </div>
                    
                    ${r.offer ? `
                        <div class="today-special">
                            <div>
                                <strong>Heute:</strong> ${r.offer.title}
                            </div>
                            <button onclick="event.stopPropagation(); openARPreview('${r.offer.title.replace(/'/g, "\\'")}', '${r.image}')" class="ar-btn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                    <circle cx="12" cy="13" r="4"/>
                                </svg>
                                AR
                            </button>
                        </div>
                    ` : ''}
                    
                    <div class="card-actions">
                        <button class="card-btn card-btn-primary" onclick="openMenuModal('${r.id}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3h18v18H3zM12 8v8M8 12h8"/>
                            </svg>
                            Bestellen
                        </button>
                        <button class="card-btn card-btn-secondary" onclick="openReservation('${r.id}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            Reservieren
                        </button>
                        <a href="https://wa.me/${(r.whatsapp || r.phone || '').replace(/[^0-9]/g, '')}?text=${encodeURIComponent('Hallo! Ich möchte gerne einen Tisch reservieren bei ' + r.name)}" target="_blank" class="card-btn card-btn-whatsapp">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                            </svg>
                        </a>
                        <a href="${r.googleMapsUrl || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.name + ' ' + (r.city || 'Ostfriesland'))}`}" target="_blank" class="card-btn card-btn-secondary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="3 11 22 2 13 21 11 13 3 11"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Update stats (nur wenn Elemente existieren)
    const statRestaurants = document.getElementById('statRestaurants');
    const statTables = document.getElementById('statTables');
    const statOffers = document.getElementById('statOffers');
    
    if (statRestaurants) statRestaurants.textContent = visibleCount;
    if (statTables) statTables.textContent = totalFreeTables;
    if (statOffers) statOffers.textContent = offersCount + APP_DATA.offers.length;
    
    updateFavoritesBadge();
    
    // Karte aktualisieren
    if (typeof updateMapMarkers === 'function') {
        updateMapMarkers();
    }
}

function searchRestaurants() {
    renderRestaurants(currentRestaurantFilter);
}

function setFilter(filter) {
    APP_DATA.currentFilter = filter;
    document.querySelectorAll('.chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.filter === filter);
    });
    renderRestaurants(currentRestaurantFilter);
}

function toggleFavorite(id) {
    const index = APP_DATA.favorites.indexOf(id);
    if (index > -1) {
        APP_DATA.favorites.splice(index, 1);
        showToast('Aus Favoriten entfernt');
    } else {
        APP_DATA.favorites.push(id);
        showToast('Zu Favoriten hinzugefügt', 'success');
    }
    saveData();
    renderRestaurants();
}

function updateFavoritesBadge() {
    const badge = document.getElementById('favBadge');
    if (!badge) return;
    const count = APP_DATA.favorites ? APP_DATA.favorites.length : 0;
    badge.textContent = count;
    badge.style.display = count > 0 ? 'flex' : 'none';
}

function renderFavorites() {
    const container = document.getElementById('favoritesList');
    const favorites = APP_DATA.restaurants.filter(r => APP_DATA.favorites.includes(r.id));
    
    if (favorites.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
                <p>Noch keine Favoriten</p>
                <p style="font-size: 14px;">Tippe auf das Herz bei einem Restaurant</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    favorites.forEach(r => {
        html += `
            <div class="restaurant-card" style="margin-bottom: 16px;">
                <div class="card-image" style="background-image: url('${r.image}'); height: 120px;">
                    <button class="favorite-btn active" onclick="toggleFavorite('${r.id}'); renderFavorites();">
                        <svg viewBox="0 0 24 24" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                    </button>
                </div>
                <div class="card-content">
                    <h3 class="restaurant-name">${r.name}</h3>
                    <p style="color: var(--slate); font-size: 14px;">${r.freeTables} Tische frei</p>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function changeLocation() {
    const select = document.getElementById('locationSelect');
    setLocation(select.value);
}

let currentLocation = 'Alle';
let availableLocations = [];

// Orte aus Supabase laden
async function loadLocations() {
    try {
        // Alle einzigartigen Orte aus restaurants, events, attractions, accommodations sammeln
        const cities = new Set();
        
        // Aus Restaurants
        APP_DATA.restaurants.forEach(r => {
            if (r.city) cities.add(r.city);
        });
        
        // Aus Events
        events.forEach(e => {
            if (e.city) cities.add(e.city);
        });
        
        // Aus Attractions
        attractions.forEach(a => {
            if (a.city) cities.add(a.city);
        });
        
        // Aus Accommodations
        accommodations.forEach(a => {
            if (a.city) cities.add(a.city);
        });
        
        availableLocations = Array.from(cities).sort();
        console.log('Orte geladen:', availableLocations);
        
        renderLocationButtons();
        
    } catch (e) {
        console.error('Fehler beim Laden der Orte:', e);
    }
}

function renderLocationButtons(filter = '') {
    const container = document.getElementById('locationButtons');
    const hint = document.getElementById('noLocationsHint');
    if (!container) return;
    
    const filterLower = filter.toLowerCase().trim();
    
    let html = '';
    
    // "Alle Orte" nur anzeigen wenn kein Filter
    if (!filterLower) {
        html += '<button class="location-btn active" onclick="setLocation(\'Alle\')" data-location="alle">Alle Orte</button>';
    }
    
    let matchCount = 0;
    
    if (availableLocations.length === 0 && !filterLower) {
        if (hint) {
            hint.textContent = 'Noch keine Orte in der Datenbank';
            hint.style.display = 'block';
        }
    } else {
        availableLocations.forEach(city => {
            // Filter anwenden
            if (filterLower && !city.toLowerCase().includes(filterLower)) {
                return;
            }
            matchCount++;
            const isActive = city === currentLocation;
            html += `<button class="location-btn ${isActive ? 'active' : ''}" onclick="setLocation('${city}')" data-location="${city.toLowerCase()}">${city}</button>`;
        });
        
        if (matchCount === 0 && filterLower) {
            if (hint) {
                hint.textContent = `Kein Ort mit "${filter}" gefunden`;
                hint.style.display = 'block';
            }
        } else {
            if (hint) hint.style.display = 'none';
        }
    }
    
    container.innerHTML = html;
}

function filterLocations() {
    const searchInput = document.getElementById('locationSearchInput');
    const filter = searchInput ? searchInput.value : '';
    renderLocationButtons(filter);
}

function addCustomLocation() {
    const input = document.getElementById('newLocationInput');
    const newLocation = input ? input.value.trim() : '';
    
    if (!newLocation) {
        showToast('Bitte einen Ortsnamen eingeben');
        return;
    }
    
    // Prüfen ob Ort schon existiert
    const exists = availableLocations.some(loc => loc.toLowerCase() === newLocation.toLowerCase());
    if (exists) {
        showToast('Dieser Ort existiert bereits');
        setLocation(availableLocations.find(loc => loc.toLowerCase() === newLocation.toLowerCase()));
        input.value = '';
        return;
    }
    
    // Ort hinzufügen und auswählen
    availableLocations.push(newLocation);
    availableLocations.sort();
    
    // In localStorage speichern für spätere Nutzung
    const customLocations = JSON.parse(localStorage.getItem('kmi_custom_locations') || '[]');
    if (!customLocations.includes(newLocation)) {
        customLocations.push(newLocation);
        localStorage.setItem('kmi_custom_locations', JSON.stringify(customLocations));
    }
    
    renderLocationButtons();
    setLocation(newLocation);
    input.value = '';
    
    showToast(`"${newLocation}" hinzugefügt!`, 'success');
}

// Custom Locations beim Start laden
function loadCustomLocations() {
    const customLocations = JSON.parse(localStorage.getItem('kmi_custom_locations') || '[]');
    customLocations.forEach(loc => {
        if (!availableLocations.includes(loc)) {
            availableLocations.push(loc);
        }
    });
    availableLocations.sort();
}

function setLocation(location) {
    currentLocation = location;
    APP_DATA.currentLocation = location;
    
    // Update UI
    const currentLocationEl = document.getElementById('currentLocation');
    if (currentLocationEl) currentLocationEl.textContent = location === 'Alle' ? 'Ostfriesland' : location;
    const liveLocation = document.getElementById('liveLocation');
    if (liveLocation) liveLocation.textContent = location === 'Alle' ? 'Ostfriesland' : location;
    
    const currentLocationAcc = document.getElementById('currentLocationAcc');
    if (currentLocationAcc) currentLocationAcc.textContent = location === 'Alle' ? 'Ostfriesland' : location;
    
    // Update active button
    document.querySelectorAll('.location-btn').forEach(btn => {
        const btnText = btn.textContent.replace('', '');
        btn.classList.toggle('active', btnText === location || (location === 'Alle' && btnText === 'Alle Orte'));
    });
    
    closeModal('locationModal');
    showToast(location === 'Alle' ? 'Alle Orte' : location);
    
    // Echtzeit Statistiken basierend auf Daten
    const restaurantsInLocation = location === 'Alle' 
        ? APP_DATA.restaurants 
        : APP_DATA.restaurants.filter(r => r.city === location);
    
    const freeTables = restaurantsInLocation.reduce((sum, r) => sum + (r.freeTables || 0), 0);
    const reservationsToday = APP_DATA.reservations.filter(r => {
        if (location === 'Alle') return true;
        const restaurant = APP_DATA.restaurants.find(rest => rest.id === r.restaurantId);
        return restaurant && restaurant.city === location;
    }).length;
    
    const liveCount = document.getElementById('liveCount');
    const liveReservations = document.getElementById('liveReservations');
    const liveFreeTables = document.getElementById('liveFreeTables');
    
    if (liveCount) liveCount.textContent = reservationsToday;
    if (liveReservations) liveReservations.textContent = reservationsToday;
    if (liveFreeTables) liveFreeTables.textContent = freeTables;
    
    // Karte auf neuen Ort zentrieren
    if (guestMap && LOCATIONS[location]) {
        const loc = LOCATIONS[location];
        guestMap.flyTo([loc.lat, loc.lng], loc.zoom, { duration: 1 });
    } else if (guestMap && location !== 'Alle') {
        // Dynamische Koordinaten aus erstem Restaurant des Ortes
        const firstInCity = APP_DATA.restaurants.find(r => r.city === location);
        if (firstInCity && firstInCity.lat && firstInCity.lng) {
            guestMap.flyTo([firstInCity.lat, firstInCity.lng], 15, { duration: 1 });
        }
    }
    
    // Wetter für neuen Ort laden
    loadWeatherForLocation(location);
    
    // Filter restaurants & accommodations by location
    renderRestaurants();
    if (typeof renderAccommodations === 'function') renderAccommodations();
}

// Echtzeit Stats aktualisieren
function updateLiveStats() {
    const location = APP_DATA.currentLocation || 'Alle';
    
    const restaurantsInLocation = location === 'Alle' 
        ? APP_DATA.restaurants 
        : APP_DATA.restaurants.filter(r => r.city === location);
    
    const freeTables = restaurantsInLocation.reduce((sum, r) => sum + (r.freeTables || 0), 0);
    const reservationsToday = APP_DATA.reservations.length;
    
    const liveCount = document.getElementById('liveCount');
    const liveReservations = document.getElementById('liveReservations');
    const liveFreeTables = document.getElementById('liveFreeTables');
    
    if (liveCount) liveCount.textContent = reservationsToday;
    if (liveReservations) liveReservations.textContent = reservationsToday;
    if (liveFreeTables) liveFreeTables.textContent = freeTables;
}

async function loadWeatherForLocation(location) {
    // Koordinaten für jeden Ort
    const coords = {
        'Greetsiel': { lat: 53.5021, lon: 7.0965 },
        'Norddeich': { lat: 53.6108, lon: 7.1542 },
        'Norden': { lat: 53.5967, lon: 7.2058 },
        'Aurich': { lat: 53.4714, lon: 7.4808 },
        'Emden': { lat: 53.3594, lon: 7.2060 },
        'Norderney': { lat: 53.7066, lon: 7.1509 },
        'Juist': { lat: 53.6772, lon: 6.9936 },
        'Alle': { lat: 53.5021, lon: 7.0965 }
    };
    
    const loc = coords[location] || coords['Greetsiel'];
    
    try {
        // Erweiterte API mit stündlicher und täglicher Vorhersage
        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current=temperature_2m,wind_speed_10m,weather_code,relative_humidity_2m,is_day&hourly=temperature_2m,weather_code,is_day&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=Europe/Berlin&forecast_days=10`);
        const data = await response.json();
        
        const temp = Math.round(data.current.temperature_2m);
        const windSpeed = Math.round(data.current.wind_speed_10m);
        const weatherCode = data.current.weather_code;
        const humidity = data.current.relative_humidity_2m;
        const isDay = data.current.is_day;
        
        // Wetter-Beschreibung
        const desc = getWeatherDescription(weatherCode);
        
        // High/Low für heute
        const todayHigh = Math.round(data.daily.temperature_2m_max[0]);
        const todayLow = Math.round(data.daily.temperature_2m_min[0]);
        
        // UI Updates
        updateWeatherUI(temp, desc, windSpeed, humidity, todayHigh, todayLow, location, isDay);
        updateHourlyForecast(data.hourly);
        updateDailyForecast(data.daily);
        updateWeatherTheme(weatherCode, isDay);
        
    } catch (e) {
        console.log('Wetter-API Fehler:', e);
    }
}

function getWeatherDescription(code) {
    if (code === 0) return 'Sonnig';
    if (code <= 3) return 'Meist bewölkt';
    if (code <= 48) return 'Nebelig';
    if (code <= 55) return 'Leichter Nieselregen';
    if (code <= 67) return 'Regen';
    if (code <= 77) return 'Schneefall';
    if (code <= 86) return 'Regenschauer';
    if (code >= 95) return 'Gewitter';
    return 'Bewölkt';
}

function getWeatherIcon(code, isDay = 1) {
    // SVG Icons statt Emojis
    if (code === 0) {
        return isDay 
            ? '<svg viewBox="0 0 24 24" fill="#FFD700" width="24" height="24"><circle cx="12" cy="12" r="5"/><path stroke="#FFD700" stroke-width="2" d="M12 1v3M12 20v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M1 12h3M20 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/></svg>'
            : '<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="24" height="24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
    }
    if (code <= 3) {
        return isDay
            ? '<svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/><circle cx="12" cy="12" r="4" fill="#FFD700"/><path d="M18 10a4 4 0 0 1 0 8H8a5 5 0 1 1 .9-9.9" fill="white" opacity="0.9"/></svg>'
            : '<svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M18 10a4 4 0 0 1 0 8H8a5 5 0 1 1 .9-9.9"/></svg>';
    }
    if (code <= 48) return '<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="24" height="24"><path d="M5 5h14M3 10h18M5 15h14M7 20h10"/></svg>';
    if (code <= 67) return '<svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M18 10a4 4 0 0 1 0 8H8a5 5 0 1 1 .9-9.9"/><path d="M8 16v2M12 16v3M16 16v2" stroke="white" stroke-width="2"/></svg>';
    if (code <= 77) return '<svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M18 10a4 4 0 0 1 0 8H8a5 5 0 1 1 .9-9.9"/><circle cx="8" cy="18" r="1"/><circle cx="12" cy="20" r="1"/><circle cx="16" cy="18" r="1"/></svg>';
    return '<svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M18 10a4 4 0 0 1 0 8H8a5 5 0 1 1 .9-9.9"/></svg>';
}

function updateWeatherUI(temp, desc, wind, humidity, high, low, location, isDay) {
    // Haupt-Widget
    const tempEl = document.getElementById('weatherTemp');
    const descEl = document.getElementById('weatherDesc');
    const highEl = document.getElementById('weatherHigh');
    const lowEl = document.getElementById('weatherLow');
    const locEl = document.getElementById('weatherLocation');
    
    if (tempEl) tempEl.textContent = temp + '°';
    if (descEl) descEl.textContent = desc;
    if (highEl) highEl.textContent = high + '°';
    if (lowEl) lowEl.textContent = low + '°';
    if (locEl) locEl.textContent = location.toUpperCase();
    
    // Speichere aktuelle Wetter-Daten global
    window.currentWeatherData = { temp, desc, wind, humidity, high, low, location, isDay };
    
    // Modal auch aktualisieren
    syncWeatherModal();
}

function syncWeatherModal() {
    const data = window.currentWeatherData;
    if (!data) return;
    
    const modalTemp = document.getElementById('weatherModalTemp');
    const modalDesc = document.getElementById('weatherModalDesc');
    const modalHigh = document.getElementById('weatherModalHigh');
    const modalLow = document.getElementById('weatherModalLow');
    const modalLoc = document.getElementById('weatherModalLocation');
    const modalWind = document.getElementById('weatherModalWind');
    const modalHumidity = document.getElementById('weatherModalHumidity');
    const modalSummary = document.getElementById('weatherModalSummary');
    
    if (modalTemp) modalTemp.textContent = data.temp + '°';
    if (modalDesc) modalDesc.textContent = data.desc;
    if (modalHigh) modalHigh.textContent = data.high + '°';
    if (modalLow) modalLow.textContent = data.low + '°';
    if (modalLoc) modalLoc.textContent = data.location.toUpperCase();
    if (modalWind) modalWind.textContent = data.wind + ' km/h';
    if (modalHumidity) modalHumidity.textContent = data.humidity + '%';
    if (modalSummary) modalSummary.textContent = `${data.desc}. Wind mit bis zu ${data.wind} km/h.`;
}

function toggleWeatherDetails() {
    const details = document.getElementById('weatherDetails');
    const arrow = document.getElementById('weatherArrow');
    if (!details) return;
    
    if (details.style.maxHeight === '0px' || details.style.maxHeight === '') {
        details.style.maxHeight = '600px';
        if (arrow) arrow.style.transform = 'rotate(180deg)';
    } else {
        details.style.maxHeight = '0px';
        if (arrow) arrow.style.transform = 'rotate(0deg)';
    }
}

function openWeatherDetail() {
    // Modal Daten synchronisieren
    syncWeatherModal();
    // Modal öffnen
    openModal('weatherDetailModal');
}

function updateHourlyForecast(hourly) {
    const container = document.getElementById('weatherHourly');
    const modalContainer = document.getElementById('hourlyForecastModal');
    if (!container && !modalContainer) return;
    
    const now = new Date();
    const currentHour = now.getHours();
    
    // Für das KIN-Design Widget (kein Gradient-Hintergrund)
    let html = '';
    for (let i = 0; i < 6; i++) {
        const hourIndex = currentHour + i;
        if (hourIndex >= hourly.time.length) break;
        
        const time = i === 0 ? 'Jetzt' : `${(currentHour + i) % 24} Uhr`;
        const temp = Math.round(hourly.temperature_2m[hourIndex]);
        const code = hourly.weather_code[hourIndex];
        const icon = getWeatherIconSVG(code);
        
        html += `
            <div style="text-align: center; min-width: 55px;">
                <div style="font-size: 13px; ${i === 0 ? 'font-weight: 600;' : ''} color: var(--${i === 0 ? 'dark' : 'slate'});">${time}</div>
                <div style="margin: 6px auto; display: flex; justify-content: center;">${icon}</div>
                <div style="font-size: 15px; font-weight: 600; color: var(--dark);">${temp}°</div>
            </div>
        `;
    }
    
    if (container) container.innerHTML = html;
    if (modalContainer) modalContainer.innerHTML = html;
}

// SVG Icons für KIN-Design (stroke mit primary color)
function getWeatherIconSVG(code) {
    const base = 'viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="28" height="28"';
    
    if (code === 0) return `<svg ${base}><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`;
    if (code <= 3) return `<svg ${base}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>`;
    if (code <= 48) return `<svg ${base}><path d="M5 5h14M3 10h18M5 15h14M7 20h10"/></svg>`;
    if (code <= 67) return `<svg ${base}><line x1="16" y1="13" x2="16" y2="21"/><line x1="8" y1="13" x2="8" y2="21"/><line x1="12" y1="15" x2="12" y2="23"/><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg>`;
    if (code <= 77) return `<svg ${base}><path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"/><line x1="8" y1="16" x2="8.01" y2="16"/><line x1="8" y1="20" x2="8.01" y2="20"/><line x1="12" y1="18" x2="12.01" y2="18"/><line x1="12" y1="22" x2="12.01" y2="22"/><line x1="16" y1="16" x2="16.01" y2="16"/><line x1="16" y1="20" x2="16.01" y2="20"/></svg>`;
    if (code <= 86) return `<svg ${base}><line x1="16" y1="13" x2="16" y2="21"/><line x1="8" y1="13" x2="8" y2="21"/><line x1="12" y1="15" x2="12" y2="23"/><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg>`;
    if (code >= 95) return `<svg ${base}><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"/><polyline points="13 11 9 17 15 17 11 23"/></svg>`;
    return `<svg ${base}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>`;
}

function updateDailyForecast(daily) {
    const container = document.getElementById('weatherForecast');
    const modalContainer = document.getElementById('dailyForecastModal');
    if (!container && !modalContainer) return;
    
    const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
    
    // Min/Max für Temperatur-Balken
    const allTemps = [...daily.temperature_2m_min, ...daily.temperature_2m_max];
    const minTemp = Math.min(...allTemps);
    const maxTemp = Math.max(...allTemps);
    const tempRange = maxTemp - minTemp || 1;
    
    let html = '';
    for (let i = 0; i < Math.min(7, daily.time.length); i++) {
        const date = new Date(daily.time[i]);
        const dayName = i === 0 ? 'Heute' : days[date.getDay()];
        const low = Math.round(daily.temperature_2m_min[i]);
        const high = Math.round(daily.temperature_2m_max[i]);
        const code = daily.weather_code[i];
        const icon = getWeatherIconSVG(code).replace('width="28" height="28"', 'width="22" height="22"');
        
        // Temperatur-Balken Position
        const lowPos = Math.max(0, ((low - minTemp) / tempRange) * 100);
        const highPos = Math.min(100, ((high - minTemp) / tempRange) * 100);
        
        const isLast = i === Math.min(6, daily.time.length - 1);
        
        html += `
            <div style="display: flex; align-items: center; padding: 10px 0; ${!isLast ? 'border-bottom: 1px solid var(--border-color);' : ''}">
                <div style="width: 50px; font-size: 14px; ${i === 0 ? 'font-weight: 600;' : ''} color: var(--dark);">${dayName}</div>
                <div style="width: 40px; text-align: center;">${icon}</div>
                <div style="width: 35px; text-align: right; font-size: 14px; color: var(--slate);">${low}°</div>
                <div style="flex: 1; margin: 0 12px; height: 4px; background: var(--border-color); border-radius: 2px; position: relative;">
                    <div style="position: absolute; left: ${lowPos}%; width: ${highPos - lowPos}%; height: 100%; background: var(--primary); border-radius: 2px;"></div>
                </div>
                <div style="width: 30px; text-align: right; font-size: 14px; font-weight: 600; color: var(--dark);">${high}°</div>
            </div>
        `;
    }
    
    if (container) container.innerHTML = html;
    if (modalContainer) modalContainer.innerHTML = html;
    
    // Auch Beschreibung aktualisieren
    const descEl = document.getElementById('weatherHourlyDesc');
    if (descEl && daily.weather_code) {
        const todayCode = daily.weather_code[0];
        const desc = getWeatherDescription(todayCode);
        descEl.textContent = `${desc} für den Rest des Tages.`;
    }
}

// ==================== RESERVATION FUNCTIONS ====================
function openReservation(restaurantId) {
    const restaurant = APP_DATA.restaurants.find(r => r.id == restaurantId);
    if (!restaurant) {
        console.error('Restaurant nicht gefunden:', restaurantId);
        showToast('Restaurant nicht gefunden', 'error');
        return;
    }
    const reservationRestaurantId = document.getElementById('reservationRestaurantId');
    const reservationRestaurantName = document.getElementById('reservationRestaurantName');
    const reservationDate = document.getElementById('reservationDate');
    
    if (reservationRestaurantId) reservationRestaurantId.value = restaurantId;
    if (reservationRestaurantName) reservationRestaurantName.textContent = restaurant.name;
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    if (reservationDate) {
        reservationDate.value = today;
        reservationDate.min = today;
    }
    
    openModal('reservationModal');
}

// ============================================================================
// RESERVATION SYSTEM - Mit Verfügbarkeits-Check
// ============================================================================

let selectedSlot = null;
let availableSlots = [];

async function loadAvailableSlots() {
    const restaurantId = document.getElementById('reservationRestaurantId').value;
    const date = document.getElementById('reservationDate').value;
    const partySize = parseInt(document.getElementById('partySize').value);
    
    if (!date || !partySize) return;
    
    const container = document.getElementById('availableSlotsContainer');
    container.innerHTML = '<div class="slots-loading">Verfügbarkeit prüfen</div>';
    
    // Verstecke Step 2 und Warteliste
    document.getElementById('reservationStep2').style.display = 'none';
    document.getElementById('waitlistOption').style.display = 'none';
    document.getElementById('selectedSlotDisplay').style.display = 'none';
    selectedSlot = null;
    
    try {
        // Supabase RPC aufrufen
        const { data, error } = await getSupabase().rpc('get_available_slots', {
            p_restaurant_id: restaurantId,
            p_date: date,
            p_party_size: partySize
        });
        
        if (error) throw error;
        
        availableSlots = data || [];
        renderSlots(availableSlots);
        
    } catch (err) {
        console.error('Slot-Fehler:', err);
        // Fallback: Generiere Standard-Slots ohne DB-Check
        renderFallbackSlots();
    }
}

function renderSlots(slots) {
    const container = document.getElementById('availableSlotsContainer');
    
    if (!slots || slots.length === 0) {
        container.innerHTML = '<p style="color: var(--slate); font-size: 14px;">Keine verfügbaren Zeiten</p>';
        document.getElementById('waitlistOption').style.display = 'block';
        return;
    }
    
    // Gruppiere nach Tageszeit
    const morning = slots.filter(s => s.slot_time < '12:00:00');
    const afternoon = slots.filter(s => s.slot_time >= '12:00:00' && s.slot_time < '17:00:00');
    const evening = slots.filter(s => s.slot_time >= '17:00:00');
    
    let html = '<div class="slots-grid">';
    
    const allSlots = [...morning, ...afternoon, ...evening];
    
    allSlots.forEach(slot => {
        const time = slot.slot_time.substring(0, 5);
        const tableCount = slot.available_tables?.length || 0;
        const areas = [...new Set(slot.areas || [])].join(', ');
        
        html += `
            <button type="button" class="slot-btn" onclick="selectSlot('${slot.slot_time}', ${JSON.stringify(slot.available_tables)}, '${areas}')">
                ${time}
                <span class="slot-tables">${tableCount} ${tableCount === 1 ? 'Tisch' : 'Tische'}</span>
            </button>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function renderFallbackSlots() {
    // Fallback wenn Supabase nicht erreichbar
    const container = document.getElementById('availableSlotsContainer');
    const times = ['11:30', '12:00', '12:30', '13:00', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', '20:00', '20:30'];
    
    let html = '<div class="slots-grid">';
    times.forEach(time => {
        html += `
            <button type="button" class="slot-btn" onclick="selectSlot('${time}:00', null, '')">
                ${time}
            </button>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function selectSlot(time, tables, areas) {
    selectedSlot = { time, tables, areas };
    
    // Alle Buttons deselektieren
    document.querySelectorAll('.slot-btn').forEach(btn => btn.classList.remove('selected'));
    
    // Geklickten Button selektieren
    event.target.closest('.slot-btn').classList.add('selected');
    
    // Hidden Input setzen
    document.getElementById('reservationTime').value = time;
    
    // Anzeige aktualisieren
    const displayTime = time.substring(0, 5);
    document.getElementById('selectedTimeText').textContent = displayTime + ' Uhr';
    document.getElementById('selectedTableText').textContent = areas ? `(${areas})` : '';
    document.getElementById('selectedSlotDisplay').style.display = 'block';
    
    // Step 2 zeigen
    document.getElementById('reservationStep2').style.display = 'block';
    document.getElementById('waitlistOption').style.display = 'none';
    
    // Zum Formular scrollen
    document.getElementById('guestName').focus();
}

function clearSelectedSlot() {
    selectedSlot = null;
    document.getElementById('reservationTime').value = '';
    document.getElementById('selectedSlotDisplay').style.display = 'none';
    document.getElementById('reservationStep2').style.display = 'none';
    document.querySelectorAll('.slot-btn').forEach(btn => btn.classList.remove('selected'));
}

function showWaitlistForm() {
    // TODO: Wartelisten-Modal öffnen
    showToast('Wartelisten-Funktion kommt bald!', 'info');
}

function submitReservation(e) {
    e.preventDefault();
    
    const restaurantId = document.getElementById('reservationRestaurantId').value;
    const restaurant = APP_DATA.restaurants.find(r => r.id == restaurantId);
    
    const reservation = {
        id: Date.now(),
        restaurantId: restaurantId,
        restaurantName: restaurant?.name || 'Restaurant',
        guestName: document.getElementById('guestName').value,
        guestPhone: document.getElementById('guestPhone').value,
        guestEmail: document.getElementById('guestEmail')?.value || '',
        date: document.getElementById('reservationDate').value,
        time: document.getElementById('reservationTime').value,
        partySize: parseInt(document.getElementById('partySize').value),
        occasion: document.getElementById('reservationOccasion')?.value || '',
        notes: document.getElementById('reservationNotes').value,
        tableId: selectedSlot?.tables?.[0] || 1,
        status: 'pending',
        source: 'app',
        createdAt: new Date().toISOString()
    };
    
    APP_DATA.reservations.push(reservation);
    saveData();
    
    // WICHTIG: Direkt in Kalender/Tischplan Array einfügen
    if (window.resAllReservations) {
        const calendarRes = {
            id: reservation.id,
            date: reservation.date,
            time: reservation.time,
            name: reservation.guestName,
            persons: reservation.partySize,
            phone: reservation.guestPhone,
            table: reservation.tableId || 1,
            notes: reservation.notes,
            status: 'pending',
            source: 'app',
            restaurant_id: reservation.restaurantId
        };
        window.resAllReservations.push(calendarRes);
        console.log('✅ Online-Reservierung zu Kalender hinzugefügt:', calendarRes);
        
        // UI sofort aktualisieren
        if (typeof window.resRenderAll === 'function') {
            window.resRenderAll();
        }
        
        // Benachrichtigung im Dashboard
        if (typeof window.resShowNewReservationAlert === 'function') {
            window.resShowNewReservationAlert(calendarRes);
        }
    }
    
    // Auch in Supabase speichern (async, im Hintergrund)
    createReservationInSupabase(reservation);
    
    closeModal('reservationModal');
    document.getElementById('reservationForm').reset();
    clearSelectedSlot();
    
    // WhatsApp oder Bestätigung
    if (restaurant?.whatsapp) {
        const formattedDate = new Date(reservation.date).toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' });
        const message = `Hallo ${restaurant.name}! 

Ich möchte gerne einen Tisch reservieren:

📅 Datum: ${formattedDate}
🕐 Uhrzeit: ${reservation.time.substring(0,5)} Uhr
👥 Personen: ${reservation.partySize}
👤 Name: ${reservation.guestName}
📞 Telefon: ${reservation.guestPhone}
${reservation.occasion ? `🎉 Anlass: ${reservation.occasion}` : ''}
${reservation.notes ? `📝 Anmerkungen: ${reservation.notes}` : ''}

Gesendet über Kiek mol in`;
        
        const whatsappUrl = `https://wa.me/${restaurant.whatsapp.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
        showReservationConfirmation(reservation, whatsappUrl);
    } else {
        showToast('Reservierung angefragt! Das Restaurant wird Sie kontaktieren.', 'success');
    }
    
    updateDashboard();
}

async function createReservationInSupabase(reservation) {
    // Direkt die einheitliche Speicherfunktion nutzen
    console.log('🌐 Online-Reservierung wird erstellt...');
    await saveReservationToSupabase(reservation);
}

function showReservationConfirmation(reservation, whatsappUrl) {
    const formattedDate = new Date(reservation.date).toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' });
    
    // Create confirmation modal
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'confirmationModal';
    modal.innerHTML = `
        <div class="modal" style="text-align: center;">
            <div class="modal-body" style="padding: 40px;">
                <div style="width: 80px; height: 80px; background: rgba(52,199,89,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#34c759" stroke-width="3" width="40" height="40">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                </div>
                <h2 style="font-family: 'Playfair Display', serif; font-size: 28px; margin-bottom: 8px;">Reservierung erstellt!</h2>
                <p style="color: var(--slate); margin-bottom: 24px;">${reservation.restaurantName}<br>${formattedDate} um ${reservation.time} Uhr<br>${reservation.partySize} Personen</p>
                
                <p style="font-weight: 600; margin-bottom: 16px;">Jetzt per WhatsApp bestätigen:</p>
                
                <a href="${whatsappUrl}" target="_blank" class="card-btn card-btn-whatsapp" style="display: flex; justify-content: center; padding: 16px 32px; font-size: 16px; margin-bottom: 16px; text-decoration: none;">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24" style="margin-right: 12px;">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                    </svg>
                    WhatsApp öffnen
                </a>
                
                <button onclick="closeConfirmationModal()" style="background: none; border: none; color: var(--slate); font-size: 14px; cursor: pointer;">
                    Später bestätigen
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function closeConfirmationModal() {
    const modal = document.getElementById('confirmationModal');
    if (modal) modal.remove();
    showToast('Reservierung gespeichert!', 'success');
}

// ==================== DASHBOARD SECTION SWITCHING ====================
function showDashboardSection(section) {
    console.log('📌 showDashboardSection aufgerufen:', section);
    
    // Hide all sections - sowohl class als auch style
    document.querySelectorAll('.dash-section').forEach(s => {
        s.classList.remove('active');
        s.style.display = 'none';
    });
    
    // Build section ID - handle camelCase properly
    let sectionId = 'section' + section.charAt(0).toUpperCase() + section.slice(1);
    
    // Show selected section
    const sectionEl = document.getElementById(sectionId);
    if (sectionEl) {
        sectionEl.classList.add('active');
        sectionEl.style.display = 'block';
        console.log('✅ Section aktiviert:', sectionId);
    } else {
        console.error('❌ Section nicht gefunden:', sectionId);
        // Fallback: zeige Dashboard
        const dashEl = document.getElementById('sectionDashboard');
        if (dashEl) {
            dashEl.classList.add('active');
            dashEl.style.display = 'block';
        }
        return;
    }
    
    // Update nav items
    document.querySelectorAll('.dash-nav-item').forEach(item => item.classList.remove('active'));
    const navId = 'nav' + section.charAt(0).toUpperCase() + section.slice(1);
    const navItem = document.getElementById(navId);
    if (navItem) {
        navItem.classList.add('active');
    }
    
    // Load content based on section
    switch(section) {
        case 'reservations':
            initReservationCalendar();
            setupRestaurantDisplay('reservations');
            renderReservations();
            const todayDate = document.getElementById('todayDate');
            if (todayDate) todayDate.textContent = formatDate(new Date());
            break;
        case 'offers':
            renderActiveOffers();
            break;
        case 'customers':
            loadCustomers();
            break;
        case 'accommodationsDash':
            loadAccommodationsDash();
            break;
        case 'eventsDash':
            loadEventsDash();
            break;
        case 'attractionsDash':
            loadAttractionsDash();
            break;
        case 'jobsDash':
            loadJobsDash();
            break;
        case 'restaurantsDash':
            loadRestaurantsDash();
            break;
        case 'orders':
            loadDashboardOrders();
            setupOrdersRealtime();
            startOrdersPolling();
            break;
        case 'tischplan':
            loadAdminTischplan();
            break;
        case 'speisekarte':
            setupRestaurantDisplay('speisekarte');
            loadMenuRestaurantSelect();
            // Nochmal nach kurzer Verzögerung laden falls APP_DATA noch nicht bereit
            setTimeout(loadMenuRestaurantSelect, 500);
            break;
        case 'rewards':
            loadRestaurantRewards();
            break;
        case 'statistics':
            loadStatistics();
            break;
        case 'revenue':
            loadRevenue();
            break;
        case 'dashboard':
            updateDashboard();
            break;
    }
}

// Restaurant-Anzeige Setup basierend auf Admin/Gastronom
function setupRestaurantDisplay(section) {
    if (section === 'speisekarte') {
        // Immer Restaurant-Auswahl anzeigen
        var selectContainer = document.getElementById('menuRestaurantSelectContainer');
        var displayContainer = document.getElementById('currentRestaurantDisplay');
        
        if (selectContainer) selectContainer.style.display = 'block';
        if (displayContainer) displayContainer.style.display = 'none';
    }
    
    if (section === 'reservations') {
        const resDisplay = document.getElementById('resRestaurantDisplay');
        const nameDisplay = document.getElementById('resRestaurantName');
        
        if (isAdmin) {
            // Admin: Restaurant auswählen lassen
            if (resDisplay) {
                resDisplay.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 44px; height: 44px; background: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="22" height="22">
                                <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: var(--slate);">Reservierungen für</div>
                            <select id="resRestaurantSelect" onchange="loadReservationsForRestaurant(this.value)" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 16px; font-weight: 600; background: var(--bg-card); color: var(--text-primary); cursor: pointer; margin-top: 4px;">
                                <option value="">Restaurant auswählen...</option>
                            </select>
                        </div>
                    </div>
                `;
                // Restaurants laden
                loadResRestaurantSelect();
            }
        } else {
            // Gastronom: Nur eigenes Restaurant
            if (nameDisplay) nameDisplay.textContent = restaurantName;
        }
    }
}

// Restaurants für Reservierungs-Dropdown laden
async function loadResRestaurantSelect() {
    const select = document.getElementById('resRestaurantSelect');
    if (!select) return;
    
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/restaurants?select=id,name&order=name`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (response.ok) {
            const restaurants = await response.json();
            select.innerHTML = '<option value="">Restaurant auswählen...</option>' +
                restaurants.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
        }
    } catch (e) {
        console.error('Fehler beim Laden der Restaurants:', e);
    }
}

// Reservierungen für Restaurant laden
function loadReservationsForRestaurant(restaurantId) {
    if (!restaurantId) return;
    console.log('Lade Reservierungen für Restaurant:', restaurantId);
    // Hier können später echte Reservierungen geladen werden
}

// ==================== JOBS DASHBOARD ====================
let dashboardJobs = [];

async function loadJobsDash() {
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/jobs?select=*,restaurants(name,city)&order=created_at.desc`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (response.ok) {
            dashboardJobs = await response.json();
        }
    } catch (e) {
        console.log('Jobs laden Fehler:', e);
    }
    
    // Stats aktualisieren
    const jobCount = document.getElementById('jobCount');
    if (jobCount) jobCount.textContent = dashboardJobs.filter(j => j.is_active).length;
    
    // Restaurant-Dropdown füllen
    const select = document.getElementById('newJobRestaurant');
    if (select && APP_DATA.restaurants) {
        select.innerHTML = '<option value="">-- Restaurant wählen --</option>';
        APP_DATA.restaurants.forEach(r => {
            select.innerHTML += `<option value="${r.id}">${r.name} (${r.city})</option>`;
        });
    }
    
    renderJobsDash();
}

function renderJobsDash() {
    const container = document.getElementById('jobsDashList');
    if (!container) return;
    
    if (dashboardJobs.length === 0) {
        container.innerHTML = '<p style="padding: 20px; color: var(--slate); text-align: center;">Keine Stellenanzeigen vorhanden</p>';
        return;
    }
    
    let html = '<table class="dash-table"><thead><tr><th>Titel</th><th>Restaurant</th><th>Art</th><th>Status</th><th>Erstellt</th><th>Aktionen</th></tr></thead><tbody>';
    
    dashboardJobs.forEach(job => {
        const restaurantName = job.restaurants ? job.restaurants.name : '-';
        const typeLabels = { fulltime: 'Vollzeit', parttime: 'Teilzeit', minijob: 'Minijob' };
        const typeLabel = typeLabels[job.job_type] || job.job_type;
        const createdDate = new Date(job.created_at).toLocaleDateString('de-DE');
        
        html += `
            <tr>
                <td>
                    <strong>${job.title}</strong>
                    ${job.is_urgent ? '<span style="background: #ff3b30; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 6px;">DRINGEND</span>' : ''}
                </td>
                <td>${restaurantName}</td>
                <td><span class="job-badge ${job.job_type}">${typeLabel}</span></td>
                <td>
                    <span style="color: ${job.is_active ? 'var(--success)' : 'var(--slate)'};">
                        ${job.is_active ? '● Aktiv' : '○ Inaktiv'}
                    </span>
                </td>
                <td>${createdDate}</td>
                <td>
                    <button onclick="toggleJobStatus('${job.id}', ${!job.is_active})" class="action-btn" title="${job.is_active ? 'Deaktivieren' : 'Aktivieren'}">
                        ${job.is_active ? '⏸' : '▶'}
                    </button>
                    <button onclick="deleteJob('${job.id}')" class="action-btn delete" title="Löschen">🗑</button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

async function addJob(event) {
    event.preventDefault();
    
    const job = {
        title: document.getElementById('newJobTitle').value,
        job_type: document.getElementById('newJobType').value,
        restaurant_id: document.getElementById('newJobRestaurant').value || null,
        salary: document.getElementById('newJobSalary').value || null,
        description: document.getElementById('newJobDescription').value || null,
        contact_whatsapp: document.getElementById('newJobWhatsApp').value || null,
        contact_email: document.getElementById('newJobEmail').value || null,
        is_urgent: document.getElementById('newJobUrgent').checked,
        is_active: true
    };
    
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/jobs`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
            },
            body: JSON.stringify(job)
        });
        
        if (response.ok) {
            showToast('Stellenanzeige veröffentlicht!', 'success');
            document.getElementById('addJobForm').reset();
            loadJobsDash();
        } else {
            showToast('Fehler beim Speichern', 'error');
        }
    } catch (e) {
        console.error('Job speichern Fehler:', e);
        showToast('Fehler beim Speichern', 'error');
    }
}

async function toggleJobStatus(jobId, newStatus) {
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/jobs?id=eq.${jobId}`, {
            method: 'PATCH',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_active: newStatus })
        });
        loadJobsDash();
        showToast(newStatus ? 'Job aktiviert' : 'Job deaktiviert');
    } catch (e) {
        console.error('Status ändern Fehler:', e);
    }
}

async function deleteJob(jobId) {
    if (!confirm('Stellenanzeige wirklich löschen?')) return;
    
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/jobs?id=eq.${jobId}`, {
            method: 'DELETE',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        loadJobsDash();
        showToast('Stellenanzeige gelöscht');
    } catch (e) {
        console.error('Löschen Fehler:', e);
    }
}

// ==================== RESTAURANTS DASHBOARD ====================
async function loadRestaurantsDash() {
    // Stats berechnen
    const restaurants = APP_DATA.restaurants || [];
    const activeCount = restaurants.filter(r => r.is_active !== false).length;
    const totalTables = restaurants.reduce((sum, r) => sum + (r.totalTables || 0), 0);
    const freeTables = restaurants.reduce((sum, r) => sum + (r.freeTables || 0), 0);
    
    // Reservierungen heute zählen
    let todayReservations = 0;
    const today = new Date().toISOString().split('T')[0];
    if (APP_DATA.reservations) {
        todayReservations = APP_DATA.reservations.filter(r => r.date === today).length;
    }
    
    // Stats updaten
    const statActive = document.getElementById('statActiveRestaurants');
    const statTotal = document.getElementById('statTotalTablesAll');
    const statFree = document.getElementById('statFreeTablesAll');
    const statToday = document.getElementById('statTodayReservationsAll');
    const restaurantCountDash = document.getElementById('restaurantCountDash');
    
    if (statActive) statActive.textContent = activeCount;
    if (statTotal) statTotal.textContent = totalTables;
    if (statFree) statFree.textContent = freeTables;
    if (statToday) statToday.textContent = todayReservations;
    if (restaurantCountDash) restaurantCountDash.textContent = restaurants.length;
    
    renderRestaurantsDash();
}

function renderRestaurantsDash() {
    const container = document.getElementById('restaurantsDashList');
    if (!container) return;
    
    const restaurants = APP_DATA.restaurants || [];
    
    if (restaurants.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="1" width="64" height="64" style="margin-bottom: 16px; opacity: 0.4;">
                    <path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                </svg>
                <h3 style="font-size: 18px; font-weight: 600; color: var(--dark); margin-bottom: 8px;">Keine Restaurants</h3>
                <p style="color: var(--slate);">Füge dein erstes Restaurant hinzu</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = restaurants.map(r => {
        const todayRes = (APP_DATA.reservations || []).filter(res => res.restaurant_id === r.id && res.date === new Date().toISOString().split('T')[0]).length;
        
        return `
            <div style="background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border-color); overflow: hidden; transition: all 0.2s;">
                <!-- Header mit Bild -->
                <div style="position: relative; height: 120px; background: linear-gradient(135deg, var(--primary) 0%, #0d4a3a 100%);">
                    ${r.image ? `<img src="${r.image}" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.6;">` : ''}
                    <div style="position: absolute; bottom: 12px; left: 16px; right: 16px;">
                        <h3 style="font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 600; color: white; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${r.name}</h3>
                        <p style="font-size: 13px; color: rgba(255,255,255,0.8); margin: 4px 0 0;">${r.city || 'Ostfriesland'} • ${r.cuisine || 'Restaurant'}</p>
                    </div>
                    ${r.is_active === false ? `<div style="position: absolute; top: 12px; right: 12px; background: #ef4444; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">Inaktiv</div>` : ''}
                </div>
                
                <!-- Stats -->
                <div style="padding: 16px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; border-bottom: 1px solid var(--border-color);">
                    <div style="text-align: center;">
                        <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${r.freeTables || 0}/${r.totalTables || 0}</div>
                        <div style="font-size: 11px; color: var(--slate);">Tische frei</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 20px; font-weight: 700; color: #f59e0b;">${todayRes}</div>
                        <div style="font-size: 11px; color: var(--slate);">Heute</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 20px; font-weight: 700; color: var(--dark);">⭐ ${r.rating || '-'}</div>
                        <div style="font-size: 11px; color: var(--slate);">Bewertung</div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="padding: 12px 16px; display: flex; gap: 8px;">
                    <button onclick="editRestaurant('${r.id}')" style="flex: 1; padding: 10px; background: var(--bg-secondary); border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 13px; color: var(--dark); font-weight: 500;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        Bearbeiten
                    </button>
                    <button onclick="viewRestaurantReservations('${r.id}')" style="flex: 1; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 13px; font-weight: 500;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
                        </svg>
                        Reservierungen
                    </button>
                    <button onclick="deleteRestaurant('${r.id}')" style="padding: 10px; background: #fee2e2; color: #ef4444; border: none; border-radius: 10px; cursor: pointer;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function viewRestaurantReservations(restaurantId) {
    const restaurant = APP_DATA.restaurants.find(r => r.id === restaurantId);
    if (!restaurant) return;
    
    const reservations = (APP_DATA.reservations || []).filter(r => r.restaurant_id === restaurantId);
    
    let html = `
        <div style="padding: 20px;">
            <h3 style="margin-bottom: 16px;">Reservierungen für ${restaurant.name}</h3>
    `;
    
    if (reservations.length === 0) {
        html += '<p style="color: var(--slate);">Keine Reservierungen vorhanden</p>';
    } else {
        html += '<table class="dash-table"><thead><tr><th>Datum</th><th>Uhrzeit</th><th>Name</th><th>Personen</th><th>Status</th></tr></thead><tbody>';
        
        reservations.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(res => {
            const statusColors = { confirmed: 'var(--success)', pending: 'var(--warning)', cancelled: 'var(--error)' };
            const statusLabels = { confirmed: 'Bestätigt', pending: 'Ausstehend', cancelled: 'Storniert' };
            
            html += `
                <tr>
                    <td>${new Date(res.date).toLocaleDateString('de-DE')}</td>
                    <td>${res.time}</td>
                    <td>${res.name}</td>
                    <td>${res.guests} Pers.</td>
                    <td style="color: ${statusColors[res.status] || 'var(--slate)'};">${statusLabels[res.status] || res.status}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
    }
    
    html += '</div>';
    
    // Modal anzeigen
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Reservierungen</h2>
                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                ${html}
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function deleteRestaurant(restaurantId) {
    if (!confirm('Restaurant wirklich löschen? Alle Reservierungen werden auch gelöscht!')) return;
    
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/restaurants?id=eq.${restaurantId}`, {
            method: 'DELETE',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        // Lokal entfernen
        APP_DATA.restaurants = APP_DATA.restaurants.filter(r => r.id !== restaurantId);
        loadRestaurantsDash();
        renderRestaurants();
        showToast('Restaurant gelöscht');
    } catch (e) {
        console.error('Löschen Fehler:', e);
        showToast('Fehler beim Löschen', 'error');
    }
}

function editRestaurant(restaurantId) {
    const restaurant = APP_DATA.restaurants.find(r => r.id === restaurantId);
    if (!restaurant) {
        showToast('Restaurant nicht gefunden', 'error');
        return;
    }
    
    console.log('Bearbeite Restaurant:', restaurant);
    
    // Formular mit Daten füllen - mit null-checks
    const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.value = val || '';
    };
    
    setVal('newRestaurantName', restaurant.name);
    setVal('newRestaurantPhone', restaurant.phone);
    setVal('newRestaurantWhatsapp', restaurant.whatsapp);
    setVal('newRestaurantEmail', restaurant.email);
    setVal('newRestaurantStreet', restaurant.street);
    setVal('newRestaurantZip', restaurant.zip);
    setVal('newRestaurantCity', restaurant.city);
    setVal('newRestaurantCuisine', restaurant.cuisine);
    setVal('newRestaurantInstagram', restaurant.instagram);
    setVal('newRestaurantTiktok', restaurant.tiktok);
    setVal('newRestaurantRating', restaurant.rating);
    setVal('newRestaurantReviewCount', restaurant.reviewCount);
    setVal('newRestaurantTables', restaurant.totalTables);
    setVal('newRestaurantImage', restaurant.image);
    setVal('newRestaurantGoogleMaps', restaurant.googleMapsUrl);
    
    // Bild-Vorschau wenn vorhanden
    if (restaurant.image) {
        const preview = document.getElementById('imagePreview');
        const container = document.getElementById('imagePreviewContainer');
        if (preview && container) {
            preview.src = restaurant.image;
            container.style.display = 'block';
        }
    }
    
    // Restaurant-ID speichern für Update
    const form = document.getElementById('addRestaurantForm');
    if (form) form.dataset.editId = restaurantId;
    
    // Modal-Titel ändern
    const modalTitle = document.querySelector('#addRestaurantModal .modal-title');
    if (modalTitle) modalTitle.textContent = 'Restaurant bearbeiten';
    
    // Button-Text ändern
    const submitBtn = document.querySelector('#addRestaurantForm button[type="submit"]');
    if (submitBtn) submitBtn.textContent = 'Änderungen speichern';
    
    openModal('addRestaurantModal');
}

function openNewRestaurantModal() {
    // Formular zurücksetzen
    const form = document.getElementById('addRestaurantForm');
    if (form) {
        form.reset();
        delete form.dataset.editId;
    }
    
    // Bild-Preview zurücksetzen
    uploadedImageBase64 = null;
    if (typeof clearImagePreview === 'function') clearImagePreview();
    
    // Modal-Titel für Neu
    const modalTitle = document.querySelector('#addRestaurantModal .modal-title');
    if (modalTitle) modalTitle.textContent = 'Neues Restaurant';
    
    // Button-Text für Neu
    const submitBtn = document.querySelector('#addRestaurantForm button[type="submit"]');
    if (submitBtn) submitBtn.textContent = 'Restaurant hinzufügen';
    
    openModal('addRestaurantModal');
}

// ==================== EVENTS DASHBOARD ====================
async function loadEventsDash() {
    // Stats aktualisieren
    const statTotal = document.getElementById('statTotalEvents');
    const statUpcoming = document.getElementById('statUpcomingEvents');
    const statFeatured = document.getElementById('statFeaturedEvents');
    const eventCount = document.getElementById('eventCount');
    
    const today = new Date().toISOString().split('T')[0];
    const upcoming = events.filter(e => e.event_date >= today).length;
    const featured = events.filter(e => e.is_featured).length;
    
    if (statTotal) statTotal.textContent = events.length;
    if (statUpcoming) statUpcoming.textContent = upcoming;
    if (statFeatured) statFeatured.textContent = featured;
    if (eventCount) eventCount.textContent = events.length;
    
    renderEventsDash();
}

function renderEventsDash() {
    const container = document.getElementById('eventsDashList');
    if (!container) return;
    
    if (events.length === 0) {
        container.innerHTML = '<p style="padding: 20px; color: var(--slate); text-align: center;">Keine Events vorhanden</p>';
        return;
    }
    
    let html = '<table class="dash-table"><thead><tr><th>Titel</th><th>Datum</th><th>Ort</th><th>Kategorie</th><th>Status</th><th>Aktionen</th></tr></thead><tbody>';
    
    events.forEach(e => {
        const eventDate = new Date(e.event_date);
        const dateStr = eventDate.toLocaleDateString('de-DE');
        const isPast = e.event_date < new Date().toISOString().split('T')[0];
        
        html += `
            <tr>
                <td style="font-weight: 600;">${e.title}</td>
                <td>${dateStr}</td>
                <td>${e.city || '-'}</td>
                <td><span style="background: var(--cream); padding: 2px 8px; border-radius: 4px; font-size: 12px;">${e.category || 'sonstiges'}</span></td>
                <td>
                    ${e.is_featured ? '<span style="color: var(--warning);">Highlight</span>' : ''}
                    ${isPast ? '<span style="color: var(--slate);">Vergangen</span>' : '<span style="color: var(--success);">Aktiv</span>'}
                </td>
                <td>
                    <button onclick="deleteEvent('${e.id}')" style="background: none; border: none; cursor: pointer; color: var(--danger);" title="Löschen">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

async function addEvent(e) {
    e.preventDefault();
    
    const newEvent = {
        id: Date.now(),
        title: document.getElementById('eventTitle').value,
        description: document.getElementById('eventDescription').value,
        event_date: document.getElementById('eventDate').value,
        event_time: document.getElementById('eventTime').value,
        city: document.getElementById('eventCity').value || 'Greetsiel',
        category: document.getElementById('eventCategory').value,
        price_info: document.getElementById('eventPrice').value,
        website: document.getElementById('eventWebsite').value,
        is_featured: document.getElementById('eventFeatured').checked,
        is_active: true
    };
    
    if (useSupabase) {
        try {
            await supabasePost('events', newEvent);
            await loadEvents();
        } catch (err) {
            console.error('Fehler beim Speichern:', err);
        }
    } else {
        events.push(newEvent);
    }
    
    closeModal('addEventModal');
    document.getElementById('addEventForm').reset();
    loadEventsDash();
    showToast('Event hinzugefügt!', 'success');
}

async function deleteEvent(id) {
    if (!confirm('Event wirklich löschen?')) return;
    
    if (useSupabase) {
        try {
            await supabaseDelete('events', id);
            await loadEvents();
        } catch (err) {
            console.error('Fehler beim Löschen:', err);
        }
    } else {
        events = events.filter(e => e.id != id);
    }
    
    loadEventsDash();
    showToast('Event gelöscht', 'success');
}

// ==================== ATTRACTIONS DASHBOARD ====================
async function loadAttractionsDash() {
    // Stats aktualisieren
    const statTotal = document.getElementById('statTotalAttractions');
    const statNatur = document.getElementById('statNaturAttractions');
    const statMuseum = document.getElementById('statMuseumAttractions');
    const attractionCount = document.getElementById('attractionCount');
    
    const natur = attractions.filter(a => a.category === 'natur').length;
    const museum = attractions.filter(a => a.category === 'museum').length;
    
    if (statTotal) statTotal.textContent = attractions.length;
    if (statNatur) statNatur.textContent = natur;
    if (statMuseum) statMuseum.textContent = museum;
    if (attractionCount) attractionCount.textContent = attractions.length;
    
    renderAttractionsDash();
}

function renderAttractionsDash() {
    const container = document.getElementById('attractionsDashList');
    if (!container) return;
    
    if (attractions.length === 0) {
        container.innerHTML = '<p style="padding: 20px; color: var(--slate); text-align: center;">Keine Ausflugsziele vorhanden</p>';
        return;
    }
    
    let html = '<table class="dash-table"><thead><tr><th>Name</th><th>Ort</th><th>Kategorie</th><th>Bewertung</th><th>Aktionen</th></tr></thead><tbody>';
    
    attractions.forEach(a => {
        html += `
            <tr>
                <td style="font-weight: 600;">${a.name}</td>
                <td>${a.city || '-'}</td>
                <td><span style="background: var(--cream); padding: 2px 8px; border-radius: 4px; font-size: 12px;">${a.category || 'sonstiges'}</span></td>
                <td>
                    <span style="color: var(--warning);">H</span> ${a.rating || 4.5}
                </td>
                <td>
                    <button onclick="deleteAttraction('${a.id}')" style="background: none; border: none; cursor: pointer; color: var(--danger);" title="Löschen">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

async function addAttraction(e) {
    e.preventDefault();
    
    const newAttraction = {
        id: Date.now(),
        name: document.getElementById('attractionName').value,
        description: document.getElementById('attractionDescription').value,
        city: document.getElementById('attractionCity').value || 'Greetsiel',
        category: document.getElementById('attractionCategory').value,
        price_info: document.getElementById('attractionPrice').value,
        rating: parseFloat(document.getElementById('attractionRating').value) || 4.5,
        phone: document.getElementById('attractionPhone').value,
        website: document.getElementById('attractionWebsite').value,
        is_active: true
    };
    
    if (useSupabase) {
        try {
            await supabasePost('attractions', newAttraction);
            await loadAttractions();
        } catch (err) {
            console.error('Fehler beim Speichern:', err);
        }
    } else {
        attractions.push(newAttraction);
    }
    
    closeModal('addAttractionModal');
    document.getElementById('addAttractionForm').reset();
    loadAttractionsDash();
    showToast('Ausflugsziel hinzugefügt!', 'success');
}

async function deleteAttraction(id) {
    if (!confirm('Ausflugsziel wirklich löschen?')) return;
    
    if (useSupabase) {
        try {
            await supabaseDelete('attractions', id);
            await loadAttractions();
        } catch (err) {
            console.error('Fehler beim Löschen:', err);
        }
    } else {
        attractions = attractions.filter(a => a.id != id);
    }
    
    loadAttractionsDash();
    showToast('Ausflugsziel gelöscht', 'success');
}

// ==================== STATISTICS ====================
async function loadStatistics() {
    // Grundzahlen
    const statRestaurants = document.getElementById('statTotalRestaurants');
    const statAccommodations = document.getElementById('statTotalAccommodations');
    const statReservations = document.getElementById('statTotalReservations');
    const statCustomers = document.getElementById('statTotalCustomers');
    
    if (statRestaurants) statRestaurants.textContent = APP_DATA.restaurants?.length || 0;
    if (statAccommodations) statAccommodations.textContent = accommodations?.length || 0;
    if (statReservations) statReservations.textContent = APP_DATA.reservations?.length || 0;
    if (statCustomers) statCustomers.textContent = customers?.length || 0;
    
    // Diese Woche (Demo-Daten)
    const weekRes = document.getElementById('weekReservations');
    const weekInq = document.getElementById('weekInquiries');
    const weekNew = document.getElementById('weekNewCustomers');
    
    if (weekRes) weekRes.textContent = Math.floor(Math.random() * 20) + 5;
    if (weekInq) weekInq.textContent = Math.floor(Math.random() * 10) + 2;
    if (weekNew) weekNew.textContent = Math.floor(Math.random() * 5) + 1;
    
    // Nach Ort
    const allItems = [...(APP_DATA.restaurants || []), ...(accommodations || [])];
    const greetsiel = allItems.filter(i => i.city === 'Greetsiel' || i.location === 'Greetsiel').length;
    const norddeich = allItems.filter(i => i.city === 'Norddeich' || i.location === 'Norddeich').length;
    const norden = allItems.filter(i => i.city === 'Norden' || i.location === 'Norden').length;
    const other = allItems.length - greetsiel - norddeich - norden;
    
    const statGreetsiel = document.getElementById('statGreetsiel');
    const statNorddeich = document.getElementById('statNorddeich');
    const statNorden = document.getElementById('statNorden');
    const statOther = document.getElementById('statOther');
    
    if (statGreetsiel) statGreetsiel.textContent = greetsiel + ' Einträge';
    if (statNorddeich) statNorddeich.textContent = norddeich + ' Einträge';
    if (statNorden) statNorden.textContent = norden + ' Einträge';
    if (statOther) statOther.textContent = other + ' Einträge';
}

// ==================== REVENUE ====================
async function loadRevenue() {
    // Berechne Umsatz aus Kunden
    const monthlyFee = 29.90;
    const paidCustomers = customers.filter(c => c.payment_status === 'paid').length;
    const pendingCustomers = customers.filter(c => c.payment_status === 'pending').length;
    const overdueCustomers = customers.filter(c => c.payment_status === 'overdue').length;
    
    const monthlyRev = (paidCustomers * monthlyFee).toFixed(2);
    const yearlyRev = (paidCustomers * monthlyFee * 12).toFixed(2);
    const pendingRev = (pendingCustomers * monthlyFee).toFixed(2);
    const overdueRev = (overdueCustomers * monthlyFee).toFixed(2);
    
    const monthlyRevEl = document.getElementById('monthlyRevenue');
    const yearlyRevEl = document.getElementById('yearlyRevenue');
    const pendingRevEl = document.getElementById('pendingRevenue');
    const overdueRevEl = document.getElementById('overdueRevenue');
    
    if (monthlyRevEl) monthlyRevEl.textContent = monthlyRev + ' €';
    if (yearlyRevEl) yearlyRevEl.textContent = yearlyRev + ' €';
    if (pendingRevEl) pendingRevEl.textContent = pendingRev + ' €';
    if (overdueRevEl) overdueRevEl.textContent = overdueRev + ' €';
    
    // Balkendiagramm (Demo-Daten für Monate)
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const currentMonth = new Date().getMonth();
    
    months.forEach((month, i) => {
        const bar = document.getElementById('bar' + month.charAt(0).toUpperCase() + month.slice(1));
        if (bar) {
            // Demo: Höhe basiert auf Kundenanzahl + Variation
            const baseHeight = customers.length * 10;
            const variation = Math.random() * 30;
            const height = i <= currentMonth ? Math.min(baseHeight + variation, 100) : 5;
            bar.style.height = height + 'px';
        }
    });
    
    // Letzte Zahlungen laden
    loadRecentPayments();
}

async function loadRecentPayments() {
    const container = document.getElementById('recentPaymentsList');
    if (!container) return;
    
    if (!useSupabase) {
        container.innerHTML = '<p style="padding: 20px; color: var(--slate); text-align: center;">Keine Zahlungen vorhanden</p>';
        return;
    }
    
    try {
        const payments = await supabaseGet('payments', 'select=*,customers(name)&order=payment_date.desc&limit=10');
        
        if (!payments || payments.length === 0) {
            container.innerHTML = '<p style="padding: 20px; color: var(--slate); text-align: center;">Keine Zahlungen vorhanden</p>';
            return;
        }
        
        let html = '';
        payments.forEach(p => {
            const date = new Date(p.payment_date).toLocaleDateString('de-DE');
            const customer = p.customers?.name || 'Unbekannt';
            const statusColor = p.status === 'completed' ? 'var(--success)' : p.status === 'pending' ? 'var(--warning)' : 'var(--danger)';
            const statusText = p.status === 'completed' ? 'Bezahlt' : p.status === 'pending' ? 'Ausstehend' : 'Fehlgeschlagen';
            
            html += `
                <div style="padding: 16px; border-bottom: 1px solid var(--sand); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: var(--dark);">${customer}</div>
                        <div style="font-size: 13px; color: var(--slate);">${date} • ${p.payment_method || 'Überweisung'}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-weight: 700; color: var(--primary);">${p.amount?.toFixed(2) || '29.90'} €</span>
                        <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(52,199,89,0.15); color: ${statusColor};">${statusText}</span>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (e) {
        console.error('Fehler beim Laden der Zahlungen:', e);
    }
}

// ==================== DASHBOARD FUNCTIONS ====================
function updateDashboard() {
    // Update date
    const currentDate = document.getElementById('currentDate');
    if (currentDate) currentDate.textContent = formatDate(new Date());
    
    // Update reservations count
    const todayReservations = APP_DATA.reservations.filter(r => r.date === TODAY);
    const dashReservationsToday = document.getElementById('dashReservationsToday');
    if (dashReservationsToday) {
        dashReservationsToday.textContent = todayReservations.length;
    }
    
    // Update reservation count in nav
    const reservationCount = document.getElementById('reservationCount');
    if (reservationCount) reservationCount.textContent = todayReservations.length;
    
    // Update offers count
    const offerCount = document.getElementById('offerCount');
    if (offerCount) offerCount.textContent = APP_DATA.offers.length;
    
    const dashOffersCount = document.getElementById('dashOffersCount');
    if (dashOffersCount) dashOffersCount.textContent = APP_DATA.offers.length;
    
    // Update Gäste heute (aus Reservierungen berechnen)
    const dashGuestsToday = document.getElementById('dashGuestsToday');
    if (dashGuestsToday) {
        const totalGuests = todayReservations.reduce((sum, r) => sum + (r.partySize || r.guests || 2), 0);
        dashGuestsToday.textContent = totalGuests;
    }
    
    // Update Umsatz (aus Kunden berechnen)
    const dashRevenue = document.getElementById('dashRevenue');
    if (dashRevenue) {
        const monthlyRevenue = customers.reduce((sum, c) => {
            if (c.payment_status === 'paid') {
                return sum + (c.monthly_fee || 29.90);
            }
            return sum;
        }, 0);
        dashRevenue.textContent = monthlyRevenue.toFixed(0) + '€';
    }
    
    // Restaurants Anzahl
    const dashRestaurants = document.getElementById('dashRestaurants');
    if (dashRestaurants) {
        dashRestaurants.textContent = APP_DATA.restaurants.length;
    }
    
    // Render tables
    renderTables();
    
    // Render reservations preview
    renderReservationsPreview();
    
    // Render active offers
    renderActiveOffers();
    
    // Update restaurant status
    updateRestaurantStatus();
    
    // Lade Echtzeit-Statistiken aus Supabase
    loadDashboardStats();
}

// Echtzeit Statistiken aus Supabase laden
async function loadDashboardStats() {
    console.log('📊 Lade Dashboard Stats...');
    
    try {
        // Restaurants zählen
        const restResponse = await fetch(`${SUPABASE_URL}/rest/v1/restaurants?select=id&is_active=eq.true`, {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
        
        if (!restResponse.ok) {
            throw new Error('API Fehler: ' + restResponse.status);
        }
        
        const restaurants = await restResponse.json();
        const restCount = Array.isArray(restaurants) ? restaurants.length : 0;
        console.log('✅ Restaurants geladen:', restCount);
        
        // Status auf "verbunden" setzen
        updateConnectionStatus(true, `✓ Verbunden - ${restCount} Restaurants`);
        
        // Sichere Element-Updates
        const updateEl = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        };
        
        updateEl('statRestaurants', restCount);
        updateEl('statTotalRestaurants', restCount);
        updateEl('dashRestaurants', restCount);
        
        // Heutige Reservierungen
        const today = new Date().toISOString().split('T')[0];
        try {
            const resResponse = await fetch(`${SUPABASE_URL}/rest/v1/reservations?select=id,guests,party_size&reservation_date=eq.${today}`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            });
            const todayRes = await resResponse.json();
            const resArray = Array.isArray(todayRes) ? todayRes : [];
            console.log('✅ Reservierungen heute:', resArray.length);
            
            updateEl('dashReservationsToday', resArray.length);
            updateEl('reservationCount', resArray.length);
            
            const totalGuests = resArray.reduce((sum, r) => sum + (r.party_size || r.guests || 2), 0);
            updateEl('dashGuestsToday', totalGuests);
        } catch (e) {
            console.log('Reservierungen Fehler:', e.message);
        }
        
        // Aktive Angebote
        try {
            const offersResponse = await fetch(`${SUPABASE_URL}/rest/v1/offers?select=id`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            });
            const offers = await offersResponse.json();
            const offersArray = Array.isArray(offers) ? offers : [];
            
            updateEl('dashOffersCount', offersArray.length);
            updateEl('offerCount', offersArray.length);
        } catch (e) {
            console.log('Angebote Fehler:', e.message);
        }
        
        // Freie Tische
        try {
            const tablesResponse = await fetch(`${SUPABASE_URL}/rest/v1/restaurants?select=free_tables&is_active=eq.true`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            });
            const tablesData = await tablesResponse.json();
            const tablesArray = Array.isArray(tablesData) ? tablesData : [];
            const totalFreeTables = tablesArray.reduce((sum, r) => sum + (r.free_tables || 0), 0);
            
            updateEl('statTables', totalFreeTables);
        } catch (e) {
            console.log('Tische Fehler:', e.message);
        }
        
        // Kunden zählen
        try {
            const customersResponse = await fetch(`${SUPABASE_URL}/rest/v1/customers?select=id,payment_status,is_active`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            });
            const customersData = await customersResponse.json();
            const custArray = Array.isArray(customersData) ? customersData : [];
            
            updateEl('totalCustomers', custArray.length);
            updateEl('customerCount', custArray.length);
            updateEl('paidCustomers', custArray.filter(c => c.payment_status === 'paid').length);
            updateEl('pendingCustomers', custArray.filter(c => c.payment_status === 'pending').length);
            updateEl('overdueCustomers', custArray.filter(c => c.payment_status === 'overdue').length);
        } catch (e) {
            console.log('Kunden Fehler:', e.message);
        }
        
        // Unterkünfte zählen
        try {
            const accResponse = await fetch(`${SUPABASE_URL}/rest/v1/accommodations?select=id,has_availability`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            });
            const accData = await accResponse.json();
            const accArray = Array.isArray(accData) ? accData : [];
            
            updateEl('totalAccommodations', accArray.length);
            updateEl('statTotalAccommodations', accArray.length);
            updateEl('accommodationCount', accArray.length);
            updateEl('availableAccommodations', accArray.filter(a => a.has_availability).length);
        } catch (e) {
            console.log('Unterkünfte Fehler:', e.message);
        }
        
        // Events zählen
        try {
            const eventsResponse = await fetch(`${SUPABASE_URL}/rest/v1/events?select=id,is_featured,date`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            });
            const eventsData = await eventsResponse.json();
            const eventsArray = Array.isArray(eventsData) ? eventsData : [];
            
            updateEl('statTotalEvents', eventsArray.length);
            
            const upcomingEvents = eventsArray.filter(e => new Date(e.date) >= new Date());
            updateEl('statUpcomingEvents', upcomingEvents.length);
            updateEl('statFeaturedEvents', eventsArray.filter(e => e.is_featured).length);
        } catch (e) {
            console.log('Events Fehler:', e.message);
        }
        
        // Attraktionen zählen
        try {
            const attrResponse = await fetch(`${SUPABASE_URL}/rest/v1/attractions?select=id,category`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            });
            const attrData = await attrResponse.json();
            const attrArray = Array.isArray(attrData) ? attrData : [];
            
            updateEl('statTotalAttractions', attrArray.length);
        } catch (e) {
            console.log('Attraktionen Fehler:', e.message);
        }
        
        console.log('✅ Dashboard Stats aktualisiert');
        
    } catch (e) {
        console.log('❌ Dashboard Stats Fehler:', e.message);
        updateConnectionStatus(false, '✗ Verbindung fehlgeschlagen: ' + e.message);
    }
}

// Auto-Refresh: Dashboard alle 30 Sekunden aktualisieren
setInterval(() => {
    if (document.getElementById('dashboardView')?.classList.contains('active') || 
        document.querySelector('.dash-section.active')) {
        loadDashboardStats();
    }
}, 30000);

function renderReservationsPreview() {
    const container = document.getElementById('reservationsPreview');
    if (!container) return;
    
    const todayReservations = APP_DATA.reservations.filter(r => r.date === TODAY);
    
    if (todayReservations.length === 0) {
        container.innerHTML = '<p style="color: var(--slate); text-align: center; padding: 20px;">Keine Reservierungen</p>';
        return;
    }
    
    // Show only first 3
    let html = '';
    todayReservations.sort((a, b) => a.time.localeCompare(b.time)).slice(0, 3).forEach(r => {
        const statusClass = r.status === 'confirmed' ? 'confirmed' : r.status === 'cancelled' ? 'cancelled' : 'pending';
        const statusText = r.status === 'confirmed' ? 'Bestätigt' : r.status === 'cancelled' ? 'Storniert' : 'Ausstehend';
        
        html += `
            <div class="reservation-item">
                <div class="reservation-time">
                    <div class="reservation-time-value">${r.time}</div>
                </div>
                <div class="reservation-info">
                    <div class="reservation-name">${r.guestName}</div>
                    <div class="reservation-details">${r.partySize} Pers.</div>
                </div>
                <span class="reservation-status ${statusClass}">${statusText}</span>
            </div>
        `;
    });
    
    if (todayReservations.length > 3) {
        html += `<p style="text-align: center; color: var(--primary); font-weight: 600; margin-top: 12px;">+${todayReservations.length - 3} weitere</p>`;
    }
    
    container.innerHTML = html;
}

function renderActiveOffers() {
    const container = document.getElementById('activeOffersList');
    if (!container) return;
    
    if (APP_DATA.offers.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--slate);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48" style="opacity: 0.3; margin-bottom: 16px;">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
                <p>Keine aktiven Angebote</p>
                <p style="font-size: 13px; margin-top: 4px;">Erstelle dein erstes Angebot links!</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    APP_DATA.offers.forEach(offer => {
        html += `
            <div class="offer-item" style="margin-bottom: 12px;">
                <div class="offer-item-info">
                    <h5 style="font-size: 16px; margin-bottom: 4px;">${offer.title}</h5>
                    <p>${offer.discount} • Gültig bis ${offer.validUntil}</p>
                    ${offer.description ? `<p style="margin-top: 4px; font-size: 12px;">${offer.description}</p>` : ''}
                </div>
                <button class="offer-item-delete" onclick="deleteOffer(${offer.id})" title="Löschen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function addManualReservation(e) {
    e.preventDefault();
    
    const reservation = {
        id: Date.now(),
        restaurantId: 1,
        restaurantName: APP_DATA.restaurants[0]?.name || 'Restaurant',
        guestName: document.getElementById('manualGuestName').value,
        guestPhone: document.getElementById('manualGuestPhone').value || '',
        date: TODAY,
        time: document.getElementById('manualTime').value,
        partySize: document.getElementById('manualPartySize').value,
        notes: '',
        status: 'confirmed',
        source: 'phone',
        createdAt: new Date().toISOString()
    };
    
    APP_DATA.reservations.push(reservation);
    saveData();
    
    // Reset form
    document.getElementById('manualGuestName').value = '';
    document.getElementById('manualGuestPhone').value = '';
    
    renderReservations();
    renderReservationsPreview();
    updateDashboard();
    
    showToast(`Reservierung für ${reservation.guestName} hinzugefügt!`, 'success');
}

function renderTables() {
    const container = document.getElementById('tableGrid');
    let html = '';
    
    APP_DATA.tables.forEach(table => {
        html += `
            <div class="table-item ${table.status}" onclick="cycleTableStatus(${table.id})">
                <span class="table-number">${table.id}</span>
                <span class="table-seats">${table.seats} Plätze</span>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Update free tables count in guest view
    const freeTables = APP_DATA.tables.filter(t => t.status === 'free').length;
    // Update first restaurant to reflect dashboard (if exists)
    if (APP_DATA.restaurants && APP_DATA.restaurants.length > 0) {
        APP_DATA.restaurants[0].freeTables = freeTables;
    }
}

function cycleTableStatus(tableId) {
    const table = APP_DATA.tables.find(t => t.id === tableId);
    const statuses = ['free', 'reserved', 'occupied'];
    const currentIndex = statuses.indexOf(table.status);
    table.status = statuses[(currentIndex + 1) % 3];
    
    saveData();
    renderTables();
    renderRestaurants();
    
    const statusNames = { free: 'Frei', reserved: 'Reserviert', occupied: 'Besetzt' };
    showToast(`Tisch ${tableId}: ${statusNames[table.status]}`);
}

function renderReservations() {
    const container = document.getElementById('reservationsList');
    if (!container) return;
    
    const todayReservations = APP_DATA.reservations.filter(r => r.date === TODAY);
    
    // Update stats
    const dashReservationsToday = document.getElementById('dashReservationsToday');
    if (dashReservationsToday) {
        dashReservationsToday.textContent = todayReservations.length;
    }
    
    if (todayReservations.length === 0) {
        container.innerHTML = '<p style="color: var(--slate); text-align: center; padding: 20px;">Keine Reservierungen für heute</p>';
        return;
    }
    
    let html = '';
    todayReservations.sort((a, b) => a.time.localeCompare(b.time)).forEach(r => {
        const statusClass = r.status === 'confirmed' ? 'confirmed' : r.status === 'cancelled' ? 'cancelled' : 'pending';
        const statusText = r.status === 'confirmed' ? 'Bestätigt' : r.status === 'cancelled' ? 'Storniert' : 'Ausstehend';
        
        // Prepare WhatsApp message for guest
        const guestPhone = r.guestPhone ? r.guestPhone.replace(/[^0-9]/g, '') : '';
        const confirmMessage = `Hallo ${r.guestName}!

Ihre Reservierung ist bestätigt:

Heute um ${r.time} Uhr
${r.partySize} Personen

Wir freuen uns auf Sie!`;
        
        html += `
            <div class="reservation-item">
                <div class="reservation-time">
                    <div class="reservation-time-value">${r.time}</div>
                    <div class="reservation-time-label">Heute</div>
                </div>
                <div class="reservation-info">
                    <div class="reservation-name">${r.guestName}</div>
                    <div class="reservation-details">${r.partySize} Personen • via ${r.source === 'app' ? 'App' : 'Telefon'}${r.notes ? ' • ' + r.notes : ''}</div>
                    ${r.guestPhone ? `<div class="reservation-details" style="margin-top: 2px; font-size: 12px;">${r.guestPhone}</div>` : ''}
                </div>
                ${r.status === 'pending' ? `
                    <div class="reservation-actions">
                        <button class="reservation-btn confirm" onclick="updateReservation('${r.id}', 'confirmed')" title="Bestätigen">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </button>
                        ${guestPhone ? `
                            <a href="https://wa.me/${guestPhone}?text=${encodeURIComponent(confirmMessage)}" target="_blank" class="reservation-btn" style="background: rgba(37,211,102,0.15); color: #25D366;" title="WhatsApp Bestätigung senden">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/>
                                </svg>
                            </a>
                        ` : ''}
                        <button class="reservation-btn cancel" onclick="updateReservation('${r.id}', 'cancelled')" title="Stornieren">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                ` : `
                    <span class="reservation-status ${statusClass}">${statusText}</span>
                `}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

async function updateReservation(id, status) {
    // Lokal aktualisieren
    const reservation = APP_DATA.reservations.find(r => r.id == id);
    if (reservation) {
        reservation.status = status;
        saveData();
        renderReservations();
        renderReservationsPreview();
        
        // In Supabase aktualisieren
        if (useSupabase) {
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/reservations?id=eq.${id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_KEY,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ status: status })
                });
                console.log('[OK] Reservierung in Supabase aktualisiert');
            } catch (e) {
                console.error('Fehler beim Aktualisieren:', e);
            }
        }
        
        if (status === 'confirmed') {
            showToast(`Reservierung für ${reservation.guestName} bestätigt!`, 'success');
        } else {
            showToast(`Reservierung für ${reservation.guestName} storniert`, 'error');
        }
    }
}

function toggleRestaurant() {
    APP_DATA.restaurantOpen = !APP_DATA.restaurantOpen;
    saveData();
    updateRestaurantStatus();
    showToast(APP_DATA.restaurantOpen ? 'Restaurant geöffnet' : 'Restaurant geschlossen');
}

function updateRestaurantStatus() {
    const toggle = document.getElementById('restaurantToggle');
    const indicator = document.getElementById('restaurantStatus');
    const text = document.getElementById('restaurantStatusText');
    
    if (APP_DATA.restaurantOpen) {
        toggle.classList.remove('off');
        indicator.classList.remove('closed');
        text.textContent = 'Restaurant offen';
    } else {
        toggle.classList.add('off');
        indicator.classList.add('closed');
        text.textContent = 'Restaurant geschlossen';
    }
}

// ==================== OFFER FUNCTIONS ====================
function createOffer(e) {
    e.preventDefault();
    
    const titleEl = document.getElementById('offerTitle');
    const discountEl = document.getElementById('offerDiscount');
    const validUntilEl = document.getElementById('offerValidUntil');
    const descEl = document.getElementById('offerDescription');
    
    if (!titleEl.value || !discountEl.value || !validUntilEl.value) {
        showToast('Bitte alle Pflichtfelder ausfüllen', 'error');
        return;
    }
    
    const offer = {
        id: Date.now(),
        title: titleEl.value,
        discount: discountEl.value,
        validUntil: validUntilEl.value,
        description: descEl.value,
        createdAt: new Date().toISOString()
    };
    
    APP_DATA.offers.push(offer);
    saveData();
    
    // In Supabase speichern
    saveOfferToSupabase(offer);
    
    // Reset form
    titleEl.value = '';
    discountEl.value = '';
    validUntilEl.value = '';
    descEl.value = '';
    
    const previewTitle = document.getElementById('previewTitle');
    const previewDiscount = document.getElementById('previewDiscount');
    if (previewTitle) previewTitle.textContent = 'Dein Angebot';
    if (previewDiscount) previewDiscount.textContent = 'Rabatt bis --:--';
    
    renderOffers();
    renderActiveOffers();
    renderRestaurants();
    updateDashboard();
    showToast('Angebot veröffentlicht!', 'success');
}

async function deleteOffer(id) {
    APP_DATA.offers = APP_DATA.offers.filter(o => o.id != id);
    saveData();
    
    // In Supabase löschen (deaktivieren)
    if (useSupabase) {
        try {
            await fetch(`${SUPABASE_URL}/rest/v1/offers?id=eq.${id}`, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({ is_active: false })
            });
            console.log('[OK] Angebot in Supabase gelöscht');
        } catch (e) {
            console.error('Fehler beim Löschen:', e);
        }
    }
    
    renderOffers();
    renderActiveOffers();
    renderRestaurants();
    updateDashboard();
    showToast('Angebot gelöscht');
}

function renderOffers() {
    const container = document.getElementById('activeOffers');
    if (!container) return;
    
    if (APP_DATA.offers.length === 0) {
        container.innerHTML = '<h4>Aktive Angebote</h4><p style="color: var(--slate); font-size: 13px;">Keine aktiven Angebote</p>';
        return;
    }
    
    let html = '<h4>Aktive Angebote</h4>';
    APP_DATA.offers.forEach(offer => {
        html += `
            <div class="offer-item">
                <div class="offer-item-info">
                    <h5>${offer.title}</h5>
                    <p>${offer.discount} bis ${offer.validUntil}</p>
                </div>
                <button class="offer-item-delete" onclick="deleteOffer(${offer.id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ==================== RESET FUNCTION ====================
function resetAllData() {
    if (confirm('Alle Demo-Daten zurücksetzen?')) {
        localStorage.removeItem('kmi_favorites');
        localStorage.removeItem('kmi_reservations');
        localStorage.removeItem('kmi_offers');
        localStorage.removeItem('kmi_tables');
        localStorage.removeItem('kmi_restaurant_open');
        localStorage.removeItem('kmi_restaurants');
        location.reload();
    }
}

// ==================== REWARDS SYSTEM (Restaurant) ====================
let restaurantRewards = [];

async function loadRestaurantRewards() {
    const restaurantId = currentAdmin?.restaurant_id;
    if (!restaurantId) return;
    
    try {
        const { data, error } = await window.supabaseClient
            .from('rewards')
            .select('*')
            .eq('restaurant_id', restaurantId)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        restaurantRewards = data || [];
        renderRestaurantRewards();
        loadRedemptions();
    } catch (e) {
        console.error('Rewards laden fehlgeschlagen:', e);
        // Demo-Daten
        restaurantRewards = [];
        renderRestaurantRewards();
    }
}

function renderRestaurantRewards() {
    const container = document.getElementById('rewardsList');
    if (!container) return;
    
    if (restaurantRewards.length === 0) {
        container.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--slate);">
                <div style="width: 64px; height: 64px; margin: 0 auto 16px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    ${getRewardIconSvg('gift', 32)}
                </div>
                <p>Noch keine Belohnungen erstellt</p>
                <p style="font-size: 13px; margin-top: 8px;">Erstelle deine erste Belohnung um Stammkunden zu gewinnen!</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    restaurantRewards.forEach(r => {
        const statusBadge = r.is_active 
            ? '<span style="background: #34c759; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">Aktiv</span>'
            : '<span style="background: var(--slate); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">Inaktiv</span>';
        
        const redemptionInfo = r.max_redemptions 
            ? `${r.current_redemptions || 0}/${r.max_redemptions} eingelöst`
            : `${r.current_redemptions || 0}x eingelöst`;
        
        const iconHtml = `<div style="width: 44px; height: 44px; background: var(--bg-secondary); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 16px;">${getRewardIconSvg(r.icon || 'gift', 24)}</div>`;
        
        html += `
            <div style="display: flex; align-items: center; padding: 16px; border-bottom: 1px solid var(--border-color);">
                ${iconHtml}
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <strong>${r.title}</strong>
                        ${statusBadge}
                    </div>
                    <div style="font-size: 13px; color: var(--slate);">
                        ${r.points_required} Pkt. • ${redemptionInfo}
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="toggleRewardActive('${r.id}', ${!r.is_active})" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">
                        ${r.is_active ? 'Pause' : 'Aktiv'}
                    </button>
                    <button onclick="deleteReward('${r.id}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; color: #ff3b30;">
                        Löschen
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

async function saveReward(e) {
    e.preventDefault();
    
    const restaurantId = currentAdmin?.restaurant_id;
    if (!restaurantId) {
        showToast('Bitte erst Restaurant auswählen', 'error');
        return;
    }
    
    const reward = {
        restaurant_id: restaurantId,
        icon: document.getElementById('rewardIcon').value,
        title: document.getElementById('rewardTitle').value,
        description: document.getElementById('rewardDescription').value,
        points_required: parseInt(document.getElementById('rewardPoints').value),
        reward_type: document.getElementById('rewardType').value,
        discount_percent: document.getElementById('rewardType').value === 'discount' 
            ? parseInt(document.getElementById('rewardDiscount').value) : null,
        max_redemptions: document.getElementById('rewardMaxRedemptions').value 
            ? parseInt(document.getElementById('rewardMaxRedemptions').value) : null,
        is_active: true
    };
    
    try {
        const { data, error } = await window.supabaseClient
            .from('rewards')
            .insert([reward])
            .select();
        
        if (error) throw error;
        
        showToast('Belohnung erstellt!', 'success');
        closeModal('addRewardModal');
        document.getElementById('addRewardForm').reset();
        loadRestaurantRewards();
    } catch (e) {
        console.error('Speichern fehlgeschlagen:', e);
        showToast('Fehler beim Speichern', 'error');
    }
}

async function toggleRewardActive(rewardId, isActive) {
    try {
        const { error } = await window.supabaseClient
            .from('rewards')
            .update({ is_active: isActive })
            .eq('id', rewardId);
        
        if (error) throw error;
        
        showToast(isActive ? 'Belohnung aktiviert' : 'Belohnung pausiert', 'success');
        loadRestaurantRewards();
    } catch (e) {
        showToast('Fehler beim Aktualisieren', 'error');
    }
}

async function deleteReward(rewardId) {
    if (!confirm('Belohnung wirklich löschen?')) return;
    
    try {
        const { error } = await window.supabaseClient
            .from('rewards')
            .delete()
            .eq('id', rewardId);
        
        if (error) throw error;
        
        showToast('Belohnung gelöscht', 'success');
        loadRestaurantRewards();
    } catch (e) {
        showToast('Fehler beim Löschen', 'error');
    }
}

function selectRewardIcon(btn) {
    document.querySelectorAll('.reward-icon-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('rewardIcon').value = btn.dataset.icon;
}

// SVG Icons für Belohnungen
const REWARD_ICONS = {
    coffee: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>',
    cake: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1"/><path d="M2 21h20"/></svg>',
    percent: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>',
    utensils: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/></svg>',
    gift: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>',
    star: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
    award: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>',
    crown: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg>'
};

function getRewardIconSvg(iconName, size = 24) {
    const icon = REWARD_ICONS[iconName] || REWARD_ICONS.gift;
    return icon.replace(/width="24"/g, `width="${size}"`).replace(/height="24"/g, `height="${size}"`);
}

function toggleDiscountField() {
    const type = document.getElementById('rewardType').value;
    document.getElementById('discountField').style.display = type === 'discount' ? 'block' : 'none';
}

// Einlösungen laden (für Restaurant Dashboard)
async function loadRedemptions() {
    const restaurantId = currentAdmin?.restaurant_id;
    if (!restaurantId) return;
    
    try {
        const { data, error } = await window.supabaseClient
            .from('reward_redemptions')
            .select('*, rewards!inner(title, icon, restaurant_id)')
            .eq('rewards.restaurant_id', restaurantId)
            .order('redeemed_at', { ascending: false })
            .limit(50);
        
        if (error) throw error;
        renderRedemptions(data || []);
    } catch (e) {
        console.error('Einlösungen laden fehlgeschlagen:', e);
    }
}

function renderRedemptions(redemptions) {
    const container = document.getElementById('redemptionsList');
    const countEl = document.getElementById('pendingRedemptionsCount');
    if (!container) return;
    
    const pending = redemptions.filter(r => r.status === 'pending');
    if (countEl) countEl.textContent = `${pending.length} offen`;
    
    if (redemptions.length === 0) {
        container.innerHTML = '<p style="padding: 20px; color: var(--slate); text-align: center;">Keine Einlösungen vorhanden</p>';
        return;
    }
    
    let html = '';
    redemptions.forEach(r => {
        const statusColors = {
            pending: '#ff9500',
            confirmed: '#34c759',
            expired: '#8e8e93',
            cancelled: '#ff3b30'
        };
        const statusLabels = {
            pending: 'Offen',
            confirmed: 'Bestätigt',
            expired: 'Abgelaufen',
            cancelled: 'Storniert'
        };
        
        const date = new Date(r.redeemed_at).toLocaleDateString('de-DE', { 
            day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' 
        });
        
        html += `
            <div style="display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border-color);">
                <div style="font-size: 24px; margin-right: 12px;">${r.rewards?.icon || '🎁'}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600;">${r.rewards?.title || 'Belohnung'}</div>
                    <div style="font-size: 12px; color: var(--slate);">
                        ${r.user_name || 'Gast'} • Code: <strong>${r.redemption_code}</strong>
                    </div>
                    <div style="font-size: 11px; color: var(--slate);">${date}</div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px;">
                    <span style="background: ${statusColors[r.status]}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                        ${statusLabels[r.status]}
                    </span>
                    ${r.status === 'pending' ? `
                        <button onclick="confirmRedemption('${r.id}')" class="btn btn-primary" style="padding: 4px 12px; font-size: 11px;">
                            ✓ Bestätigen
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

async function confirmRedemption(redemptionId) {
    try {
        const { error } = await window.supabaseClient
            .from('reward_redemptions')
            .update({ 
                status: 'confirmed',
                confirmed_at: new Date().toISOString()
            })
            .eq('id', redemptionId);
        
        if (error) throw error;
        
        showToast('Einlösung bestätigt! ✓', 'success');
        loadRedemptions();
    } catch (e) {
        showToast('Fehler beim Bestätigen', 'error');
    }
}

// ==================== REWARDS FÜR GÄSTE ====================
async function loadAvailableRewards() {
    document.getElementById('availableRewardsPoints').textContent = userPoints;
    const container = document.getElementById('availableRewardsList');
    
    try {
        const { data, error } = await window.supabaseClient
            .from('rewards')
            .select('*, restaurants(name, city)')
            .eq('is_active', true)
            .order('points_required', { ascending: true });
        
        if (error) throw error;
        
        if (!data || data.length === 0) {
            container.innerHTML = `
                <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                    <div style="width: 64px; height: 64px; margin: 0 auto 16px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        ${getRewardIconSvg('gift', 32)}
                    </div>
                    <p>Noch keine Belohnungen verfügbar</p>
                    <p style="font-size: 13px; margin-top: 8px;">Schau später nochmal vorbei!</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        data.forEach(r => {
            const canRedeem = userPoints >= r.points_required;
            const restaurantName = r.restaurants?.name || 'Restaurant';
            const city = r.restaurants?.city ? ` • ${r.restaurants.city}` : '';
            const iconHtml = `<div style="width: 48px; height: 48px; background: var(--bg-secondary); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 16px;">${getRewardIconSvg(r.icon || 'gift', 24)}</div>`;
            
            html += `
                <div style="display: flex; align-items: center; padding: 16px; border: 2px solid ${canRedeem ? 'var(--primary)' : 'var(--border-color)'}; border-radius: 12px; margin-bottom: 12px; ${canRedeem ? '' : 'opacity: 0.6;'}">
                    ${iconHtml}
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 2px;">${r.title}</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">@ ${restaurantName}${city}</div>
                        <div style="font-size: 14px; color: var(--primary); font-weight: 600; margin-top: 4px;">${r.points_required} Punkte</div>
                    </div>
                    <button 
                        onclick="redeemReward('${r.id}')" 
                        class="btn ${canRedeem ? 'btn-primary' : 'btn-secondary'}" 
                        style="padding: 8px 16px;"
                        ${canRedeem ? '' : 'disabled'}
                    >
                        ${canRedeem ? 'Einlösen' : 'Gesperrt'}
                    </button>
                </div>
            `;
        });
        
        container.innerHTML = html;
    } catch (e) {
        console.error('Rewards laden fehlgeschlagen:', e);
        container.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--text-secondary);">Fehler beim Laden</p>';
    }
}

async function redeemReward(rewardId) {
    if (!confirm('Belohnung wirklich einlösen?')) return;
    
    try {
        const { data, error } = await window.supabaseClient
            .rpc('redeem_reward', {
                p_reward_id: rewardId,
                p_session: SESSION_ID,
                p_user_name: localStorage.getItem('kmi_guest_name') || null,
                p_user_email: localStorage.getItem('kmi_guest_email') || null
            });
        
        if (error) throw error;
        
        if (data?.success) {
            // Code anzeigen
            document.getElementById('redemptionCode').textContent = data.code;
            document.getElementById('redeemedRewardTitle').textContent = data.reward;
            
            // Restaurant Name laden
            const sb = getSupabase();
            const { data: restData } = sb ? await sb
                .from('restaurants')
                .select('name')
                .eq('id', data.restaurant_id)
                .single() : { data: null };
            
            document.getElementById('redeemedRewardRestaurant').textContent = `@ ${restData?.name || 'Restaurant'}`;
            
            // Lokale Punkte aktualisieren
            await syncUserPoints();
            
            closeModal('availableRewardsModal');
            openModal('redeemCodeModal');
            
            showToast('Belohnung eingelöst!', 'success');
        } else {
            showToast(data?.error || 'Einlösen fehlgeschlagen', 'error');
        }
    } catch (e) {
        console.error('Einlösen fehlgeschlagen:', e);
        showToast('Fehler beim Einlösen', 'error');
    }
}

function copyRedemptionCode() {
    const code = document.getElementById('redemptionCode').textContent;
    navigator.clipboard.writeText(code).then(() => {
        showToast('Code kopiert! 📋', 'success');
    });
}

// Punkte mit Server synchronisieren
async function syncUserPoints() {
    try {
        const { data, error } = await window.supabaseClient
            .from('user_points')
            .select('total_points, level')
            .eq('user_session', SESSION_ID)
            .single();
        
        if (data) {
            userPoints = data.total_points;
            userLevel = data.level;
            localStorage.setItem('kmi_points', userPoints.toString());
            localStorage.setItem('kmi_level', userLevel);
            updatePointsDisplay();
        }
    } catch (e) {
        // Fallback zu lokalen Punkten
    }
}

// Points Modal öffnen - mit Belohnungen Button
function openPointsModal() {
    document.getElementById('pointsModalTotal').textContent = userPoints;
    updateLevelProgress();
    openModal('pointsModal');
}

function updateLevelProgress() {
    const levels = ['bronze', 'silver', 'gold', 'platinum', 'diamond'];
    const thresholds = [0, 500, 1500, 3000, 5000];
    
    const currentIdx = levels.indexOf(userLevel);
    const nextIdx = Math.min(currentIdx + 1, levels.length - 1);
    
    const currentThreshold = thresholds[currentIdx];
    const nextThreshold = thresholds[nextIdx];
    
    const progress = currentIdx === levels.length - 1 
        ? 100 
        : ((userPoints - currentThreshold) / (nextThreshold - currentThreshold)) * 100;
    
    const progressBar = document.getElementById('levelProgress');
    if (progressBar) progressBar.style.width = Math.min(progress, 100) + '%';
    
    const currentLabel = document.getElementById('currentLevelLabel');
    const nextLabel = document.getElementById('nextLevelLabel');
    if (currentLabel) currentLabel.textContent = LEVELS[userLevel].name;
    if (nextLabel) nextLabel.textContent = currentIdx < levels.length - 1 
        ? `${LEVELS[levels[nextIdx]].name} (${nextThreshold})` 
        : 'Max Level erreicht!';
}

// ==================== GEZEITEN SYSTEM ====================
// Gezeiten für Norderney/Greetsiel Bereich (vereinfacht)
let tideData = {
    highTide: null,
    lowTide: null,
    nextHigh: null,
    nextLow: null,
    currentLevel: 50 // 0-100%
};

function initTides() {
    updateTideData();
    setInterval(updateTideData, 60000); // Jede Minute aktualisieren
}

function updateTideData() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const currentTime = hours * 60 + minutes;
    
    // Vereinfachte Gezeitenberechnung (ca. 12h 25min Zyklus)
    // Basierend auf typischen Nordsee-Gezeiten
    const tidalCycle = 745; // 12h 25min in Minuten
    const dayStart = 0;
    
    // Simulierte Hochwasser-Zeiten (2x täglich, verschiebt sich ~50min pro Tag)
    const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    const baseHighTide = (dayOfYear * 50) % tidalCycle; // Verschiebung pro Tag
    
    const highTide1 = baseHighTide % (24 * 60);
    const highTide2 = (baseHighTide + tidalCycle) % (24 * 60);
    const lowTide1 = (baseHighTide + tidalCycle / 2) % (24 * 60);
    const lowTide2 = (baseHighTide + tidalCycle * 1.5) % (24 * 60);
    
    // Nächste Gezeiten finden
    const tides = [
        { type: 'high', time: highTide1 },
        { type: 'high', time: highTide2 },
        { type: 'low', time: lowTide1 },
        { type: 'low', time: lowTide2 }
    ].sort((a, b) => a.time - b.time);
    
    // Aktuelle Position im Zyklus
    let nextTide = tides.find(t => t.time > currentTime) || tides[0];
    let prevTide = tides.filter(t => t.time <= currentTime).pop() || tides[tides.length - 1];
    
    // Wasserstand berechnen (0-100%)
    const cyclePosition = (currentTime - prevTide.time) / (nextTide.time - prevTide.time || 1);
    
    if (nextTide.type === 'high') {
        tideData.currentLevel = 20 + (cyclePosition * 80); // Steigt
        tideData.status = 'rising';
    } else {
        tideData.currentLevel = 100 - (cyclePosition * 80); // Fällt
        tideData.status = 'falling';
    }
    
    // Zeiten formatieren
    const formatTime = (mins) => {
        const h = Math.floor(mins / 60) % 24;
        const m = mins % 60;
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    };
    
    tideData.nextHigh = formatTime(tides.find(t => t.type === 'high' && t.time > currentTime)?.time || highTide1);
    tideData.nextLow = formatTime(tides.find(t => t.type === 'low' && t.time > currentTime)?.time || lowTide1);
    
    // UI aktualisieren
    updateTideUI();
}

function updateTideUI() {
    const t = translations[currentLanguage] || translations.de;
    
    const waveEl = document.getElementById('tideWave');
    const statusEl = document.getElementById('tideStatus');
    const highEl = document.getElementById('tideHigh');
    const lowEl = document.getElementById('tideLow');
    const nowTimeEl = document.getElementById('tideNowTime');
    const suggestionsEl = document.getElementById('tideSuggestions');
    
    if (waveEl) waveEl.style.height = tideData.currentLevel + '%';
    
    const now = new Date();
    if (nowTimeEl) nowTimeEl.textContent = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
    if (highEl) highEl.textContent = tideData.nextHigh;
    if (lowEl) lowEl.textContent = tideData.nextLow;
    
    if (statusEl) {
        if (tideData.status === 'rising') {
            statusEl.textContent = currentLanguage === 'en' ? 'Tide rising' : (currentLanguage === 'nl' ? 'Vloed stijgt' : 'Flut steigt');
            statusEl.style.background = 'rgba(52, 199, 89, 0.3)';
        } else {
            statusEl.textContent = currentLanguage === 'en' ? 'Tide falling' : (currentLanguage === 'nl' ? 'Eb daalt' : 'Ebbe fällt');
            statusEl.style.background = 'rgba(255, 149, 0, 0.3)';
        }
    }
    
    // Aktivitäts-Empfehlungen
    const infoIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="margin-right: 4px; flex-shrink: 0;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>';
    if (suggestionsEl) {
        if (tideData.currentLevel > 70) {
            suggestionsEl.innerHTML = infoIcon + '<span><strong>Perfekt jetzt:</strong> Hafenrundfahrt, Restaurants am Wasser, Schiffstouren</span>';
        } else if (tideData.currentLevel > 40) {
            suggestionsEl.innerHTML = infoIcon + '<span><strong>Empfohlen:</strong> Strandspaziergang, Krabbenpulen lernen</span>';
        } else {
            suggestionsEl.innerHTML = infoIcon + '<span><strong>Ideal für:</strong> Wattwanderung, Muscheln sammeln, Wattführung</span>';
        }
    }
}

// ==================== GAMIFICATION SYSTEM ====================
let userPoints = parseInt(localStorage.getItem('kmi_points') || '0');
let userLevel = localStorage.getItem('kmi_level') || 'bronze';
let userAchievements = JSON.parse(localStorage.getItem('kmi_achievements') || '[]');

const POINTS_CONFIG = {
    reservation: 50,
    review: 100,
    photoUpload: 30,
    firstVisit: 20,
    shareApp: 200,
    inviteFriend: 300,
    fiveReservations: 250,
    tenReviews: 500
};

const LEVELS = {
    bronze: { min: 0, name: 'Bronze', icon: '🥉' },
    silver: { min: 500, name: 'Silber', icon: '🥈' },
    gold: { min: 1500, name: 'Gold', icon: '🥇' },
    platinum: { min: 3000, name: 'Platin', icon: '💎' },
    diamond: { min: 5000, name: 'Diamant', icon: '👑' }
};

const ACHIEVEMENTS = [
    { id: 'first_reservation', name: 'Erste Reservierung', icon: '🍽️', points: 50, desc: 'Erste Tischreservierung gemacht' },
    { id: 'first_review', name: 'Kritiker', icon: '⭐', points: 100, desc: 'Erste Bewertung geschrieben' },
    { id: 'photo_star', name: 'Foto-Star', icon: '📸', points: 150, desc: '5 Fotos hochgeladen' },
    { id: 'explorer', name: 'Entdecker', icon: '🗺️', points: 200, desc: '10 verschiedene Restaurants besucht' },
    { id: 'local_hero', name: 'Local Hero', icon: '🦸', points: 500, desc: '50 Bewertungen geschrieben' },
    { id: 'tide_master', name: 'Gezeiten-Meister', icon: '🌊', points: 100, desc: 'App bei Ebbe UND Flut genutzt' }
];

function addPoints(amount, reason) {
    userPoints += amount;
    localStorage.setItem('kmi_points', userPoints.toString());
    
    // Level prüfen
    updateLevel();
    
    // UI aktualisieren
    updatePointsDisplay();
    
    // Toast zeigen
    showToast(`+${amount} 🌟 ${reason}`, 'success');
    
    // Konfetti bei Level-Up
    if (checkLevelUp()) {
        showLevelUpCelebration();
    }
}

function updateLevel() {
    let newLevel = 'bronze';
    for (const [level, config] of Object.entries(LEVELS)) {
        if (userPoints >= config.min) {
            newLevel = level;
        }
    }
    
    if (newLevel !== userLevel) {
        userLevel = newLevel;
        localStorage.setItem('kmi_level', userLevel);
        return true; // Level Up!
    }
    return false;
}

function checkLevelUp() {
    return updateLevel();
}

function updatePointsDisplay() {
    const pointsEl = document.getElementById('userPoints');
    const levelEl = document.getElementById('userLevel');
    
    if (pointsEl) pointsEl.textContent = userPoints;
    if (levelEl) {
        levelEl.textContent = LEVELS[userLevel].icon + ' ' + LEVELS[userLevel].name;
        levelEl.className = `level-badge level-${userLevel}`;
    }
}

function unlockAchievement(achievementId) {
    if (userAchievements.includes(achievementId)) return;
    
    const achievement = ACHIEVEMENTS.find(a => a.id === achievementId);
    if (!achievement) return;
    
    userAchievements.push(achievementId);
    localStorage.setItem('kmi_achievements', JSON.stringify(userAchievements));
    
    // Punkte hinzufügen
    addPoints(achievement.points, achievement.name);
    
    // Achievement Popup
    showAchievementPopup(achievement);
}

function showAchievementPopup(achievement) {
    const popup = document.createElement('div');
    popup.className = 'achievement-popup';
    popup.innerHTML = `
        <div class="achievement-icon">${achievement.icon}</div>
        <h3 style="margin: 0 0 8px; font-size: 24px;">Achievement freigeschaltet!</h3>
        <p style="font-size: 18px; font-weight: 600; margin: 0 0 8px;">${achievement.name}</p>
        <p style="color: var(--text-secondary); margin: 0 0 16px;">${achievement.desc}</p>
        <div style="color: #ffd700; font-size: 20px; font-weight: 700;">+${achievement.points} 🌟</div>
    `;
    
    document.body.appendChild(popup);
    
    // Sound abspielen (optional)
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2JjoyMi4eCenZ4');
        audio.volume = 0.3;
        audio.play().catch(() => {});
    } catch (e) {}
    
    // Nach 3 Sekunden entfernen
    setTimeout(() => {
        popup.style.animation = 'achievementPop 0.3s ease reverse forwards';
        setTimeout(() => popup.remove(), 300);
    }, 3000);
}

function showLevelUpCelebration() {
    const level = LEVELS[userLevel];
    
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;';
    overlay.innerHTML = `
        <div style="text-align: center; color: white; animation: achievementPop 0.5s ease;">
            <div style="font-size: 100px; margin-bottom: 24px;">${level.icon}</div>
            <h2 style="font-size: 36px; margin: 0 0 12px;">LEVEL UP!</h2>
            <p style="font-size: 24px; opacity: 0.9;">Du bist jetzt ${level.name}!</p>
        </div>
    `;
    
    document.body.appendChild(overlay);
    overlay.onclick = () => overlay.remove();
    
    setTimeout(() => overlay.remove(), 4000);
}

// ==================== ÜBERRASCHUNGS-MODUS ====================
function surpriseMe() {
    const restaurants = APP_DATA.restaurants.filter(r => r.freeTables > 0);
    
    if (restaurants.length === 0) {
        showToast('Keine verfügbaren Restaurants gefunden', 'error');
        return;
    }
    
    // Zufälliges Restaurant
    const random = restaurants[Math.floor(Math.random() * restaurants.length)];
    
    // Loading Overlay zeigen
    const overlay = document.createElement('div');
    overlay.id = 'surpriseOverlay';
    overlay.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;';
    overlay.innerHTML = `
        <div style="text-align: center; color: white;">
            <div style="font-size: 24px; margin-bottom: 16px;" id="surpriseText">Suche Restaurant...</div>
            <div style="width: 200px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; overflow: hidden;">
                <div style="width: 0%; height: 100%; background: white; border-radius: 2px; animation: loadBar 1.5s ease forwards;"></div>
            </div>
        </div>
        <style>
            @keyframes loadBar { to { width: 100%; } }
        </style>
    `;
    document.body.appendChild(overlay);
    
    // Slot-Machine Effekt
    let count = 0;
    const textEl = overlay.querySelector('#surpriseText');
    const interval = setInterval(() => {
        const temp = restaurants[Math.floor(Math.random() * restaurants.length)];
        textEl.textContent = temp.name;
        count++;
        
        if (count > 12) {
            clearInterval(interval);
            textEl.innerHTML = `<div style="font-size: 18px; opacity: 0.7; margin-bottom: 8px;">Perfekt für dich:</div><div style="font-size: 28px; font-weight: 700;">${random.name}</div>`;
            
            // Nach 2 Sekunden Reservierung öffnen
            setTimeout(() => {
                overlay.remove();
                openReservation(random.id);
            }, 1500);
        }
    }, 100);
    
    // Punkte für Abenteuer
    addPoints(10, 'Abenteurer!');
}

function createConfetti() {
    const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd'];
    
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.style.cssText = `
            position: fixed;
            width: 10px;
            height: 10px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            top: -10px;
            left: ${Math.random() * 100}%;
            z-index: 10000;
            pointer-events: none;
            border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
            animation: confettiFall ${2 + Math.random() * 2}s linear forwards;
        `;
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 4000);
    }
    
    // Confetti Animation CSS hinzufügen wenn nicht vorhanden
    if (!document.getElementById('confettiStyle')) {
        const style = document.createElement('style');
        style.id = 'confettiStyle';
        style.textContent = `
            @keyframes confettiFall {
                to {
                    transform: translateY(100vh) rotate(720deg);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    }
}

// ==================== BESTE ZEIT VORHERSAGE ====================
function getBestTime(restaurantId) {
    // Simulierte Daten (in Produktion: echte Analytics)
    const hours = [];
    for (let h = 11; h <= 22; h++) {
        const busyness = Math.sin((h - 11) / 11 * Math.PI) * 70 + 30 + Math.random() * 20;
        hours.push({ hour: h, busyness: Math.min(100, busyness) });
    }
    
    const bestHour = hours.reduce((best, h) => h.busyness < best.busyness ? h : best, hours[0]);
    
    return {
        hours,
        bestTime: bestHour.hour,
        currentBusyness: hours.find(h => h.hour === new Date().getHours())?.busyness || 50
    };
}

// ==================== WARTEZEIT TRACKER ====================
function getWaitTime(restaurantId) {
    const restaurant = APP_DATA.restaurants.find(r => r.id === restaurantId);
    if (!restaurant) return null;
    
    // Simuliert basierend auf freien Tischen
    const occupancy = ((restaurant.totalTables - restaurant.freeTables) / restaurant.totalTables) * 100;
    
    let waitMinutes = 0;
    let status = 'low';
    
    if (occupancy > 90) {
        waitMinutes = 20 + Math.floor(Math.random() * 20);
        status = 'high';
    } else if (occupancy > 70) {
        waitMinutes = 10 + Math.floor(Math.random() * 10);
        status = 'medium';
    } else if (occupancy > 50) {
        waitMinutes = 5;
        status = 'low';
    }
    
    return { waitMinutes, occupancy, status };
}

// ==================== GRUPPEN-RESERVIERUNG ====================
let groupSession = null;
let currentGroupData = JSON.parse(localStorage.getItem('kmi_group') || 'null');

function openGroupReservationModal() {
    // Datum auf heute setzen
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('groupDate');
    if (dateInput) {
        dateInput.value = today;
        dateInput.min = today;
    }
    
    // Prüfen ob aktive Gruppe existiert
    if (currentGroupData) {
        document.getElementById('activeGroupSection').style.display = 'block';
        document.getElementById('activeGroupName').textContent = currentGroupData.name;
        document.getElementById('activeGroupMembers').textContent = (currentGroupData.size || currentGroupData.members?.length || 1) + ' Personen';
        const dateTimeEl = document.getElementById('activeGroupDateTime');
        if (dateTimeEl && currentGroupData.formattedDate) {
            dateTimeEl.textContent = '📅 ' + currentGroupData.formattedDate + ' um ' + currentGroupData.time + ' Uhr';
        }
        renderGroupVoting();
    } else {
        document.getElementById('activeGroupSection').style.display = 'none';
    }
    openModal('groupReservationModal');
}

function createNewGroup() {
    const name = document.getElementById('groupName').value || 'Meine Gruppe';
    const size = parseInt(document.getElementById('groupSize').value) || 6;
    const date = document.getElementById('groupDate').value || new Date().toISOString().split('T')[0];
    const time = document.getElementById('groupTime').value || '18:00';
    
    const sessionId = 'grp_' + Math.random().toString(36).substr(2, 9);
    
    // Datum formatieren
    const dateObj = new Date(date);
    const formattedDate = dateObj.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' });
    
    currentGroupData = {
        id: sessionId,
        name: name,
        size: size,
        date: date,
        time: time,
        formattedDate: formattedDate,
        creator: localStorage.getItem('kmi_guest_name') || 'Anonym',
        members: [localStorage.getItem('kmi_guest_name') || 'Du'],
        votes: {},
        myVotes: [],
        restaurants: [],
        createdAt: new Date().toISOString()
    };
    
    // In localStorage speichern (für alle Teilnehmer abrufbar)
    const savedGroups = JSON.parse(localStorage.getItem('kmi_groups') || '{}');
    savedGroups[sessionId] = currentGroupData;
    localStorage.setItem('kmi_groups', JSON.stringify(savedGroups));
    localStorage.setItem('kmi_group', JSON.stringify(currentGroupData));
    
    // Link teilen
    shareGroupLink();
    
    // UI aktualisieren
    document.getElementById('activeGroupSection').style.display = 'block';
    document.getElementById('activeGroupName').textContent = name;
    document.getElementById('activeGroupMembers').textContent = size + ' Personen';
    document.getElementById('activeGroupDateTime').textContent = '📅 ' + formattedDate + ' um ' + time + ' Uhr';
    
    showToast('Gruppe erstellt! Teile den Link!', 'success');
    addPoints(50, 'Gruppenplaner');
}

function shareGroupLink() {
    if (!currentGroupData) {
        showToast('Keine Gruppe vorhanden', 'error');
        return;
    }
    
    const link = `${window.location.origin}?group=${currentGroupData.id}`;
    
    // Text zusammenbauen
    let text = `Hey! 🍽️\n\n`;
    text += `Wir planen: "${currentGroupData.name || 'Gemeinsames Essen'}"\n`;
    if (currentGroupData.formattedDate) {
        text += `📅 ${currentGroupData.formattedDate}\n`;
    }
    if (currentGroupData.time) {
        text += `🕐 ${currentGroupData.time} Uhr\n`;
    }
    text += `👥 ${currentGroupData.size || 6} Personen\n\n`;
    text += `Stimm hier ab wo wir hingehen:\n${link}`;
    
    if (navigator.share) {
        navigator.share({
            title: currentGroupData.name || 'Gruppenessen',
            text: text,
            url: link
        });
    } else {
        // WhatsApp Fallback
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
    }
}

function renderGroupVoting() {
    const container = document.getElementById('groupVotingList');
    const modalContainer = document.getElementById('groupVotingListModal');
    if (!currentGroupData) return;
    
    // Gruppen-Infos im Modal anzeigen
    const nameEl = document.getElementById('votingGroupName');
    const infoEl = document.getElementById('votingGroupInfo');
    const dateEl = document.getElementById('votingGroupDateTime');
    
    if (nameEl) nameEl.textContent = currentGroupData.name || 'Gruppenessen';
    if (infoEl) infoEl.textContent = (currentGroupData.size || 6) + ' Personen';
    if (dateEl && currentGroupData.formattedDate) {
        dateEl.textContent = '📅 ' + currentGroupData.formattedDate + ' um ' + currentGroupData.time + ' Uhr';
    }
    
    // Top 3 Restaurants vorschlagen
    const suggestions = APP_DATA.restaurants
        .filter(r => r.freeTables >= Math.ceil((currentGroupData.size || 6) / 4))
        .slice(0, 5);
    
    if (suggestions.length === 0) {
        const noResults = '<p style="color: var(--text-secondary); font-size: 14px; text-align: center; padding: 20px;">Keine passenden Restaurants gefunden</p>';
        if (container) container.innerHTML = noResults;
        if (modalContainer) modalContainer.innerHTML = noResults;
        return;
    }
    
    let html = '';
    suggestions.forEach(r => {
        const votes = currentGroupData.votes?.[r.id] || 0;
        const hasVoted = currentGroupData.myVotes?.includes(r.id);
        
        html += `
            <div onclick="voteForRestaurant('${r.id}')" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 10px; cursor: pointer; border: 2px solid ${hasVoted ? 'var(--primary)' : 'transparent'}; transition: all 0.2s;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <img src="${r.image}" style="width: 50px; height: 50px; border-radius: 10px; object-fit: cover;">
                    <div>
                        <div style="font-weight: 600; font-size: 15px;">${r.name}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${r.cuisine || 'Restaurant'} • ${r.freeTables} Tische frei</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; background: ${hasVoted ? 'var(--primary)' : 'var(--bg-card)'}; padding: 8px 12px; border-radius: 20px;">
                    <span style="font-weight: 700; color: ${hasVoted ? 'white' : 'var(--primary)'}; font-size: 16px;">${votes}</span>
                    <svg viewBox="0 0 24 24" fill="${hasVoted ? 'white' : 'none'}" stroke="${hasVoted ? 'white' : 'var(--primary)'}" stroke-width="2" width="18" height="18">
                        <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
                    </svg>
                </div>
            </div>
        `;
    });
    
    if (container) container.innerHTML = html;
    if (modalContainer) modalContainer.innerHTML = html;
}

function voteForRestaurant(restaurantId) {
    if (!currentGroupData) return;
    
    if (!currentGroupData.votes) currentGroupData.votes = {};
    if (!currentGroupData.myVotes) currentGroupData.myVotes = [];
    
    if (currentGroupData.myVotes.includes(restaurantId)) {
        // Vote entfernen
        currentGroupData.votes[restaurantId] = (currentGroupData.votes[restaurantId] || 1) - 1;
        currentGroupData.myVotes = currentGroupData.myVotes.filter(id => id !== restaurantId);
        showToast('Stimme entfernt');
    } else {
        // Vote hinzufügen
        currentGroupData.votes[restaurantId] = (currentGroupData.votes[restaurantId] || 0) + 1;
        currentGroupData.myVotes.push(restaurantId);
        showToast('Abgestimmt! 👍');
    }
    
    // In localStorage speichern
    localStorage.setItem('kmi_group', JSON.stringify(currentGroupData));
    
    // Auch in groups-Liste aktualisieren
    const savedGroups = JSON.parse(localStorage.getItem('kmi_groups') || '{}');
    savedGroups[currentGroupData.id] = currentGroupData;
    localStorage.setItem('kmi_groups', JSON.stringify(savedGroups));
    
    renderGroupVoting();
}

function joinGroup(groupId) {
    // In echter App: Gruppe von Server laden
    showToast('Gruppe beigetreten!', 'success');
    openGroupReservationModal();
}

function createGroupReservation(restaurantId) {
    const sessionId = 'grp_' + Math.random().toString(36).substr(2, 9);
    
    groupSession = {
        id: sessionId,
        restaurantId,
        creator: APP_DATA.currentUser?.name || localStorage.getItem('kmi_guest_name') || 'Anonym',
        members: [],
        votes: {},
        createdAt: new Date()
    };
    
    // Link generieren
    const shareLink = `${window.location.origin}?group=${sessionId}`;
    
    // Share Modal öffnen
    openGroupShareModal(shareLink);
    
    return sessionId;
}

function openGroupShareModal(link) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.innerHTML = `
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">Gruppe einladen</h2>
                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
            </div>
            <div class="modal-body">
                <div class="group-invite" style="margin-bottom: 16px;">
                    <p style="margin: 0 0 12px;">Teile diesen Link mit deinen Freunden:</p>
                    <input type="text" value="${link}" readonly style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 12px;" onclick="this.select()">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button onclick="shareViaWhatsApp('${link}')" class="btn btn-primary" style="background: #25D366;">
                        WhatsApp
                    </button>
                    <button onclick="copyToClipboard('${link}')" class="btn btn-secondary">
                        Kopieren
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function shareViaWhatsApp(link) {
    const text = encodeURIComponent(`Hey! Lass uns zusammen essen gehen! Stimm hier ab: ${link}`);
    window.open(`https://wa.me/?text=${text}`, '_blank');
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Link kopiert!', 'success');
    });
}

// ==================== PUSH-BENACHRICHTIGUNGEN ====================
let pushEnabled = localStorage.getItem('kmi_push_enabled') === 'true';

function enablePushNotifications() {
    if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                pushEnabled = true;
                localStorage.setItem('kmi_push_enabled', 'true');
                
                // Einstellungen speichern
                const settings = {
                    reservations: document.getElementById('pushReservations').checked,
                    offers: document.getElementById('pushOffers').checked,
                    tables: document.getElementById('pushTables').checked
                };
                localStorage.setItem('kmi_push_settings', JSON.stringify(settings));
                
                showToast('Benachrichtigungen aktiviert!', 'success');
                closeModal('pushNotificationModal');
                
                // Test-Benachrichtigung
                setTimeout(() => {
                    sendPushNotification('Willkommen!', 'Du erhältst jetzt Updates zu deinen Favoriten.');
                }, 1000);
                
                addPoints(30, 'Benachrichtigungen aktiviert');
            } else {
                showToast('Benachrichtigungen wurden abgelehnt', 'error');
            }
        });
    } else {
        showToast('Dein Browser unterstützt keine Benachrichtigungen', 'error');
    }
}

function sendPushNotification(title, body, icon = null) {
    if (pushEnabled && 'Notification' in window && Notification.permission === 'granted') {
        const notification = new Notification(title, {
            body: body,
            icon: icon || '/icon-192.png',
            badge: '/icon-192.png',
            tag: 'kmi-notification'
        });
        
        notification.onclick = () => {
            window.focus();
            notification.close();
        };
    }
}

function checkAndShowPushModal() {
    // Nach 30 Sekunden Push-Modal zeigen wenn noch nicht aktiviert
    if (!pushEnabled && !localStorage.getItem('kmi_push_asked')) {
        setTimeout(() => {
            localStorage.setItem('kmi_push_asked', 'true');
            openModal('pushNotificationModal');
        }, 30000);
    }
}

// ==================== VOICE-RESERVIERUNG ====================
let voiceRecognition = null;
let isListening = false;

function initVoiceRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        voiceRecognition = new SpeechRecognition();
        voiceRecognition.continuous = false;
        voiceRecognition.interimResults = true;
        voiceRecognition.lang = 'de-DE';
        
        voiceRecognition.onresult = (event) => {
            const transcript = Array.from(event.results)
                .map(result => result[0].transcript)
                .join('');
            
            document.getElementById('voiceTranscript').textContent = transcript;
            
            if (event.results[0].isFinal) {
                processVoiceCommand(transcript);
            }
        };
        
        voiceRecognition.onend = () => {
            isListening = false;
            updateVoiceButton();
        };
        
        voiceRecognition.onerror = (event) => {
            console.error('Voice error:', event.error);
            isListening = false;
            updateVoiceButton();
            
            if (event.error === 'not-allowed') {
                showToast('Mikrofon-Zugriff verweigert', 'error');
            }
        };
        
        return true;
    }
    return false;
}

function toggleVoiceRecognition() {
    if (!voiceRecognition) {
        if (!initVoiceRecognition()) {
            showToast('Spracherkennung nicht unterstützt', 'error');
            return;
        }
    }
    
    if (isListening) {
        voiceRecognition.stop();
        isListening = false;
    } else {
        openModal('voiceReservationModal');
        document.getElementById('voiceTranscript').textContent = 'Höre zu...';
        document.getElementById('voiceResult').innerHTML = '';
        
        setTimeout(() => {
            voiceRecognition.start();
            isListening = true;
            updateVoiceButton();
        }, 500);
    }
}

function updateVoiceButton() {
    const btn = document.getElementById('voiceMicBtn');
    if (btn) {
        btn.classList.toggle('listening', isListening);
    }
}

function processVoiceCommand(text) {
    const lower = text.toLowerCase();
    let persons = 2;
    let time = null;
    let date = 'heute';
    let restaurant = null;
    
    // Personenanzahl erkennen
    const personMatch = lower.match(/(\d+)\s*(person|leute|gäste|personen)/);
    if (personMatch) persons = parseInt(personMatch[1]);
    
    // "für zwei", "für drei" etc.
    const wordNumbers = {'zwei': 2, 'drei': 3, 'vier': 4, 'fünf': 5, 'sechs': 6, 'sieben': 7, 'acht': 8};
    Object.entries(wordNumbers).forEach(([word, num]) => {
        if (lower.includes(`für ${word}`)) persons = num;
    });
    
    // Zeit erkennen
    const timeMatch = lower.match(/(\d{1,2})\s*(uhr|:)/);
    if (timeMatch) time = timeMatch[1] + ':00';
    
    if (lower.includes('mittag')) time = '12:00';
    if (lower.includes('abend')) time = '19:00';
    if (lower.includes('nachmittag')) time = '15:00';
    
    // Datum erkennen
    if (lower.includes('morgen')) date = 'morgen';
    if (lower.includes('übermorgen')) date = 'übermorgen';
    if (lower.includes('samstag')) date = 'Samstag';
    if (lower.includes('sonntag')) date = 'Sonntag';
    
    // Restaurant erkennen
    APP_DATA.restaurants.forEach(r => {
        if (lower.includes(r.name.toLowerCase())) {
            restaurant = r;
        }
    });
    
    // Küche erkennen
    let cuisine = null;
    const cuisines = {
        'italienisch': 'Italienisch',
        'pizza': 'Italienisch',
        'deutsch': 'Deutsch',
        'fisch': 'Fisch',
        'asiatisch': 'Asiatisch',
        'griechisch': 'Griechisch'
    };
    Object.entries(cuisines).forEach(([key, value]) => {
        if (lower.includes(key)) cuisine = value;
    });
    
    // Ergebnis anzeigen
    displayVoiceResult(persons, time, date, restaurant, cuisine);
}

function displayVoiceResult(persons, time, date, restaurant, cuisine) {
    const resultDiv = document.getElementById('voiceResult');
    
    let html = `
        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-top: 16px;">
            <h4 style="margin: 0 0 12px;">Verstanden:</h4>
            <div style="display: grid; gap: 8px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Personen:</span>
                    <strong>${persons}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Datum:</span>
                    <strong>${date}</strong>
                </div>
                ${time ? `
                    <div style="display: flex; justify-content: space-between;">
                        <span>Uhrzeit:</span>
                        <strong>${time}</strong>
                    </div>
                ` : ''}
                ${restaurant ? `
                    <div style="display: flex; justify-content: space-between;">
                        <span>Restaurant:</span>
                        <strong>${restaurant.name}</strong>
                    </div>
                ` : cuisine ? `
                    <div style="display: flex; justify-content: space-between;">
                        <span>Küche:</span>
                        <strong>${cuisine}</strong>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    // Passende Restaurants vorschlagen
    let suggestions = APP_DATA.restaurants.filter(r => r.freeTables > 0);
    if (cuisine) {
        suggestions = suggestions.filter(r => r.cuisine === cuisine);
    }
    if (restaurant) {
        suggestions = [restaurant];
    }
    suggestions = suggestions.slice(0, 3);
    
    if (suggestions.length > 0) {
        html += `
            <div style="margin-top: 16px;">
                <h4 style="margin: 0 0 12px;">${restaurant ? 'Dein Restaurant:' : 'Vorschläge:'}</h4>
                ${suggestions.map(r => {
                    const routeUrl = r.googleMapsUrl || (r.lat && r.lng ? `https://www.google.com/maps/dir/?api=1&destination=${r.lat},${r.lng}` : `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent((r.street || '') + ' ' + (r.city || r.name))}`);
                    return `
                    <div style="background: var(--bg-secondary); border-radius: 12px; margin-bottom: 10px; overflow: hidden;">
                        <div onclick="closeModal('voiceReservationModal'); openReservation('${r.id}')" style="display: flex; align-items: center; gap: 12px; padding: 12px; cursor: pointer;">
                            <img src="${r.image}" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${r.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${r.freeTables} Tische frei</div>
                            </div>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="opacity: 0.5;">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid var(--border-color);">
                            <button onclick="closeModal('voiceReservationModal'); openReservation('${r.id}')" style="background: var(--primary); color: white; border: none; padding: 10px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                Reservieren
                            </button>
                            <a href="${routeUrl}" target="_blank" onclick="event.stopPropagation();" style="background: transparent; color: var(--text-primary); border: none; padding: 10px; font-size: 13px; font-weight: 500; cursor: pointer; text-decoration: none; text-align: center; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <polygon points="3 11 22 2 13 21 11 13 3 11"/>
                                </svg>
                                Route
                            </a>
                        </div>
                    </div>
                `}).join('')}
            </div>
        `;
    }
    
    resultDiv.innerHTML = html;
    
    addPoints(15, 'Voice-Reservierung genutzt');
}

function retryVoice() {
    document.getElementById('voiceTranscript').textContent = 'Höre zu...';
    document.getElementById('voiceResult').innerHTML = '';
    voiceRecognition.start();
    isListening = true;
    updateVoiceButton();
}

// ==================== AR PREVIEW ====================
let arStream = null;
let arCanvas = null;
let arContext = null;

function openARPreview(dishName, dishImage) {
    openModal('arPreviewModal');
    document.getElementById('arDishName').textContent = dishName;
    document.getElementById('arDishImg').src = dishImage;
    
    // Kamera starten
    startARCamera();
}

async function startARCamera() {
    const video = document.getElementById('arVideo');
    const container = document.getElementById('arCameraContainer');
    
    try {
        arStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }
        });
        video.srcObject = arStream;
        video.play();
        
        // Canvas für Overlay
        arCanvas = document.getElementById('arCanvas');
        arContext = arCanvas.getContext('2d');
        
        // Warten bis Video geladen
        video.onloadedmetadata = () => {
            arCanvas.width = video.videoWidth;
            arCanvas.height = video.videoHeight;
            renderARFrame();
        };
        
        document.getElementById('arPlaceholder').style.display = 'none';
        video.style.display = 'block';
        arCanvas.style.display = 'block';
        
    } catch (err) {
        console.error('Kamera-Fehler:', err);
        document.getElementById('arPlaceholder').innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48" style="margin-bottom: 12px; opacity: 0.5;">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
            </svg>
            <p>Kamera nicht verfügbar</p>
            <p style="font-size: 12px; opacity: 0.7;">Bitte Zugriff erlauben</p>
        `;
    }
}

function renderARFrame() {
    if (!arStream || !arContext) return;
    
    const video = document.getElementById('arVideo');
    const dishImg = document.getElementById('arDishImg');
    const scale = parseFloat(document.getElementById('arScale')?.value || 1);
    
    // Video Frame zeichnen
    arContext.drawImage(video, 0, 0, arCanvas.width, arCanvas.height);
    
    // Gericht-Bild überlagern (Mitte des Bildschirms)
    const imgSize = Math.min(arCanvas.width, arCanvas.height) * 0.4 * scale;
    const x = (arCanvas.width - imgSize) / 2;
    const y = (arCanvas.height - imgSize) / 2;
    
    // Schatten für 3D-Effekt
    arContext.shadowColor = 'rgba(0,0,0,0.4)';
    arContext.shadowBlur = 20;
    arContext.shadowOffsetY = 10;
    
    // Rundes Bild zeichnen
    arContext.save();
    arContext.beginPath();
    arContext.arc(x + imgSize/2, y + imgSize/2, imgSize/2, 0, Math.PI * 2);
    arContext.clip();
    arContext.drawImage(dishImg, x, y, imgSize, imgSize);
    arContext.restore();
    
    // Schatten zurücksetzen
    arContext.shadowColor = 'transparent';
    
    // Nächsten Frame
    requestAnimationFrame(renderARFrame);
}

function closeARPreview() {
    if (arStream) {
        arStream.getTracks().forEach(track => track.stop());
        arStream = null;
    }
    closeModal('arPreviewModal');
}

function captureARPhoto() {
    if (!arCanvas) return;
    
    // Canvas als Bild speichern
    const dataUrl = arCanvas.toDataURL('image/png');
    
    // Download Link erstellen
    const link = document.createElement('a');
    link.download = 'kiek-mol-in-ar-preview.png';
    link.href = dataUrl;
    link.click();
    
    showToast('Foto gespeichert!', 'success');
    addPoints(10, 'AR Foto gemacht');
}

// ==================== INIT NEUE FEATURES ====================
function initNewFeatures() {
    initTides();
    updatePointsDisplay();
    
    // Check für Gruppe in URL
    const urlParams = new URLSearchParams(window.location.search);
    const groupId = urlParams.get('group');
    if (groupId) {
        joinGroup(groupId);
    }
    
    // Erste Nutzung Achievement
    if (!localStorage.getItem('kmi_first_visit')) {
        localStorage.setItem('kmi_first_visit', 'true');
        setTimeout(() => {
            addPoints(POINTS_CONFIG.firstVisit, 'Willkommen!');
        }, 2000);
    }
    
    // Push-Benachrichtigungen Modal anzeigen
    checkAndShowPushModal();
}

// ==================== REVIEWS UI ====================
let currentReviewRating = 0;
let currentReviewPhotos = [];
let currentReviewTarget = { type: null, id: null, name: null };

function openReviewsModal(targetType, targetId, targetName) {
    currentReviewTarget = { type: targetType, id: targetId, name: targetName };
    
    document.getElementById('reviewsModalTitle').textContent = `Bewertungen - ${targetName}`;
    
    // Daten laden
    loadReviewsForModal(targetType, targetId);
    
    openModal('reviewsModal');
    
    // Presence tracken
    updatePresence(targetType, targetId);
}

async function loadReviewsForModal(targetType, targetId) {
    const reviewsList = document.getElementById('reviewsList');
    const activityFeed = document.getElementById('liveActivityFeed');
    
    // Reviews laden
    const reviews = await loadReviews(targetType, targetId);
    
    if (reviews.length === 0) {
        reviewsList.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                <div style="font-size: 48px; margin-bottom: 12px;">💬</div>
                <p>Noch keine Bewertungen</p>
                <p style="font-size: 13px;">Sei der Erste!</p>
            </div>
        `;
    } else {
        // Durchschnitt berechnen
        const avgRating = (reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length).toFixed(1);
        document.getElementById('reviewsAvgRating').textContent = avgRating;
        document.getElementById('reviewsTotalCount').textContent = reviews.length;
        
        reviewsList.innerHTML = reviews.map(review => renderReviewCard(review)).join('');
    }
    
    // Activity laden
    const activities = await loadRecentActivity(targetType, targetId, 5);
    
    if (activities.length === 0) {
        activityFeed.innerHTML = `
            <div style="text-align: center; padding: 12px; color: var(--text-secondary); font-size: 13px;">
                Noch keine Aktivität
            </div>
        `;
    } else {
        activityFeed.innerHTML = activities.map(activity => {
            const icon = activity.activity_type === 'reservation' ? '🍴' : 
                         activity.activity_type === 'review' ? '⭐' : 
                         activity.activity_type === 'photo' ? '📸' : '👀';
            const timeAgo = getTimeAgo(new Date(activity.created_at));
            
            return `
                <div class="activity-item">
                    <span class="activity-icon">${icon}</span>
                    <span class="activity-text">${activity.user_name || 'Jemand'} ${activity.message}</span>
                    <span class="activity-time">${timeAgo}</span>
                </div>
            `;
        }).join('');
    }
    
    // Today visitors
    const todayCount = await getTodayVisitors(targetType, targetId);
    document.getElementById('reviewsTodayVisitors').textContent = todayCount;
}

function renderReviewCard(review) {
    const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
    const initial = (review.user_name || 'G')[0].toUpperCase();
    const timeAgo = getTimeAgo(new Date(review.created_at));
    
    return `
        <div class="review-card">
            <div class="review-header">
                <div class="review-avatar" style="background: ${getAvatarColor(review.user_name)};">
                    ${review.user_avatar ? `<img src="${review.user_avatar}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : initial}
                </div>
                <div class="review-meta">
                    <div class="review-author">${review.user_name || 'Gast'}${review.is_verified ? ' ✓' : ''}</div>
                    <div class="review-date">${timeAgo}</div>
                </div>
                <div class="review-stars">${stars}</div>
            </div>
            ${review.title ? `<div class="review-title">${escapeHtml(review.title)}</div>` : ''}
            ${review.comment ? `<div class="review-comment">${escapeHtml(review.comment)}</div>` : ''}
            <div class="review-helpful">
                <button class="helpful-btn" onclick="markHelpful('${review.id}')">
                    👍 Hilfreich ${review.helpful_count > 0 ? `(${review.helpful_count})` : ''}
                </button>
            </div>
        </div>
    `;
}

function getAvatarColor(name) {
    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dfe6e9', '#a29bfe', '#fd79a8'];
    const index = (name || 'G').charCodeAt(0) % colors.length;
    return colors[index];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function openWriteReview() {
    if (!currentReviewTarget.id) return;
    
    document.getElementById('reviewTargetType').value = currentReviewTarget.type;
    document.getElementById('reviewTargetId').value = currentReviewTarget.id;
    document.getElementById('reviewTargetName').value = currentReviewTarget.name;
    document.getElementById('writeReviewFor').textContent = currentReviewTarget.name;
    
    // Reset Form
    currentReviewRating = 0;
    currentReviewPhotos = [];
    document.getElementById('writeReviewForm').reset();
    updateStarDisplay();
    updatePhotoGrid();
    
    // Name-Feld nur zeigen wenn nicht eingeloggt
    const nameGroup = document.getElementById('reviewNameGroup');
    if (APP_DATA.currentUser) {
        nameGroup.style.display = 'none';
    } else {
        nameGroup.style.display = 'block';
        const savedName = localStorage.getItem('kmi_guest_name');
        if (savedName) {
            document.getElementById('reviewUserName').value = savedName;
        }
    }
    
    closeModal('reviewsModal');
    openModal('writeReviewModal');
}

function setRating(rating) {
    currentReviewRating = rating;
    updateStarDisplay();
    
    const texts = ['', 'Schlecht', 'Geht so', 'Okay', 'Gut', 'Ausgezeichnet!'];
    document.getElementById('ratingText').textContent = texts[rating] || '';
}

function updateStarDisplay() {
    const stars = document.querySelectorAll('#starRatingInput span');
    stars.forEach((star, index) => {
        if (index < currentReviewRating) {
            star.textContent = '★';
            star.classList.add('active');
        } else {
            star.textContent = '☆';
            star.classList.remove('active');
        }
    });
}

function handleReviewPhotoUpload(event) {
    const files = event.target.files;
    
    for (const file of files) {
        if (currentReviewPhotos.length >= 4) {
            showToast('Maximal 4 Fotos', 'error');
            break;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            showToast('Bild zu groß (max 5MB)', 'error');
            continue;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            compressImage(e.target.result, 800, 0.8, function(compressed) {
                currentReviewPhotos.push(compressed);
                updatePhotoGrid();
            });
        };
        reader.readAsDataURL(file);
    }
    
    event.target.value = '';
}

function removeReviewPhoto(index) {
    currentReviewPhotos.splice(index, 1);
    updatePhotoGrid();
}

function updatePhotoGrid() {
    const grid = document.getElementById('reviewPhotoGrid');
    
    let html = currentReviewPhotos.map((photo, index) => `
        <div class="photo-upload-item">
            <img src="${photo}" alt="Foto ${index + 1}">
            <button type="button" class="remove-photo" onclick="removeReviewPhoto(${index})">×</button>
        </div>
    `).join('');
    
    if (currentReviewPhotos.length < 4) {
        html += `
            <label class="photo-upload-add">
                <input type="file" accept="image/*" multiple onchange="handleReviewPhotoUpload(event)" style="display: none;">
                +
            </label>
        `;
    }
    
    grid.innerHTML = html;
}

async function handleSubmitReview(event) {
    event.preventDefault();
    
    if (currentReviewRating === 0) {
        showToast('Bitte Sterne vergeben', 'error');
        return;
    }
    
    const targetType = document.getElementById('reviewTargetType').value;
    const targetId = document.getElementById('reviewTargetId').value;
    const targetName = document.getElementById('reviewTargetName').value;
    const title = document.getElementById('reviewTitle').value;
    const comment = document.getElementById('reviewComment').value;
    
    // Name speichern für nächstes Mal
    const userName = document.getElementById('reviewUserName').value;
    if (userName && !APP_DATA.currentUser) {
        localStorage.setItem('kmi_guest_name', userName);
    }
    
    const result = await submitReview(
        targetType,
        targetId,
        targetName,
        currentReviewRating,
        title,
        comment,
        currentReviewPhotos
    );
    
    if (result) {
        closeModal('writeReviewModal');
        // Reviews Modal wieder öffnen
        setTimeout(() => {
            openReviewsModal(targetType, targetId, targetName);
        }, 500);
    }
}

async function markHelpful(reviewId) {
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/helpful_votes`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                review_id: reviewId,
                user_id: APP_DATA.currentUser?.id || null,
                session_id: SESSION_ID
            })
        });
        
        showToast('Danke! 👍', 'success');
    } catch (e) {
        console.log('Helpful vote fehlgeschlagen:', e);
    }
}

// ==================== IMAGE UPLOAD ====================
let uploadedImageBase64 = null;

function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Dateigröße prüfen (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showToast('Bild zu groß (max. 5MB)', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const base64 = e.target.result;
        
        // Bild komprimieren
        compressImage(base64, 800, 0.8, function(compressedBase64) {
            uploadedImageBase64 = compressedBase64;
            
            // Vorschau anzeigen
            document.getElementById('imagePreview').src = compressedBase64;
            document.getElementById('imagePreviewContainer').style.display = 'block';
            document.getElementById('newRestaurantImage').value = '';
            
            showToast('Bild geladen!', 'success');
        });
    };
    reader.readAsDataURL(file);
}

function compressImage(base64, maxWidth, quality, callback) {
    const img = new Image();
    img.onload = function() {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        // Skalieren wenn zu groß
        if (width > maxWidth) {
            height = Math.round((height * maxWidth) / width);
            width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        callback(canvas.toDataURL('image/jpeg', quality));
    };
    img.src = base64;
}

function previewImageFromUrl(url) {
    if (!url) {
        document.getElementById('imagePreviewContainer').style.display = 'none';
        return;
    }
    
    // Prüfen ob gültige URL
    if (url.startsWith('http')) {
        document.getElementById('imagePreview').src = url;
        document.getElementById('imagePreviewContainer').style.display = 'block';
        uploadedImageBase64 = null;
    }
}

function clearImagePreview() {
    document.getElementById('imagePreviewContainer').style.display = 'none';
    document.getElementById('imagePreview').src = '';
    document.getElementById('newRestaurantImage').value = '';
    uploadedImageBase64 = null;
}

// ==================== ADD RESTAURANT ====================
async function addRestaurant(e) {
    e.preventDefault();
    
    // Prüfen ob Edit-Modus
    const editId = document.getElementById('addRestaurantForm').dataset.editId;
    const isEdit = !!editId;
    
    const name = document.getElementById('newRestaurantName').value;
    const cuisine = document.getElementById('newRestaurantCuisine').value;
    const phone = document.getElementById('newRestaurantPhone').value || '';
    const whatsapp = document.getElementById('newRestaurantWhatsapp').value || null;
    const email = document.getElementById('newRestaurantEmail').value || null;
    const city = document.getElementById('newRestaurantCity')?.value || 'Greetsiel';
    const street = document.getElementById('newRestaurantStreet')?.value || '';
    const zip = document.getElementById('newRestaurantZip')?.value || '';
    const googleMaps = document.getElementById('newRestaurantGoogleMaps')?.value || '';
    const instagram = document.getElementById('newRestaurantInstagram')?.value || '';
    const tiktok = document.getElementById('newRestaurantTiktok')?.value || '';
    const rating = parseFloat(document.getElementById('newRestaurantRating')?.value) || 4.5;
    const reviewCount = parseInt(document.getElementById('newRestaurantReviewCount')?.value) || 0;
    
    // Bild: Erst Upload prüfen, dann URL, dann Default
    const image = uploadedImageBase64 || document.getElementById('newRestaurantImage').value || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800';
    const tables = parseInt(document.getElementById('newRestaurantTables').value) || 8;
    
    // Koordinaten basierend auf Ort
    const cityCoords = {
        'Greetsiel': { lat: 53.5021, lng: 7.0965 },
        'Norddeich': { lat: 53.6108, lng: 7.1542 },
        'Norden': { lat: 53.5967, lng: 7.2058 },
        'Aurich': { lat: 53.4714, lng: 7.4808 },
        'Emden': { lat: 53.3594, lng: 7.2060 }
    };
    const coords = cityCoords[city] || { lat: 53.5021, lng: 7.0965 };
    
    // Vollständige Adresse für Route (wird aus street/zip/city zusammengesetzt)
    const fullAddress = `${street}, ${zip} ${city}, Deutschland`;
    
    // Restaurant Daten
    const restaurantData = {
        name: name,
        phone: phone,
        whatsapp: whatsapp,
        email: email,
        city: city,
        street: street,
        zip: zip,
        google_maps_url: googleMaps,
        instagram: instagram,
        tiktok: tiktok,
        cuisine_type: [cuisine],
        image_url: image,
        rating: rating,
        review_count: reviewCount
    };
    
    // Nur bei Neuanlage Koordinaten und Status setzen
    if (!isEdit) {
        const lat = coords.lat + (Math.random() - 0.5) * 0.005;
        const lng = coords.lng + (Math.random() - 0.5) * 0.005;
        restaurantData.latitude = lat;
        restaurantData.longitude = lng;
        restaurantData.is_active = true;
        restaurantData.is_open = true;
    }
    
    console.log(isEdit ? 'Restaurant aktualisieren:' : 'Restaurant hinzufügen:', name);
    
    // In Supabase speichern oder aktualisieren
    try {
        let url = `${SUPABASE_URL}/rest/v1/restaurants`;
        let method = 'POST';
        
        if (isEdit) {
            url += `?id=eq.${editId}`;
            method = 'PATCH';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify(restaurantData)
        });
        
        console.log('Response Status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Supabase Fehler:', errorText);
            showToast('Fehler beim Speichern: ' + errorText, 'error');
            return;
        }
        
        const data = await response.json();
        console.log('Restaurant gespeichert:', data);
        
        if (isEdit) {
            // Bei Update: Restaurant in APP_DATA aktualisieren
            const index = APP_DATA.restaurants.findIndex(r => r.id === editId);
            if (index !== -1) {
                APP_DATA.restaurants[index] = {
                    ...APP_DATA.restaurants[index],
                    name: name,
                    cuisine: cuisine,
                    phone: phone,
                    whatsapp: whatsapp,
                    image: image,
                    city: city,
                    street: street,
                    zip: zip
                };
            }
        } else {
            // Bei Neuanlage: Restaurant hinzufügen
            const newRestaurant = {
                id: data[0].id,
                name: name,
                cuisine: cuisine,
                rating: rating,
                freeTables: tables,
                waitTime: 0,
                phone: phone,
                whatsapp: whatsapp,
                lat: restaurantData.latitude,
                lng: restaurantData.longitude,
                image: image,
                offer: null
            };
            
            APP_DATA.restaurants.push(newRestaurant);
            
            // Tische für das Restaurant erstellen (nur bei Neuanlage)
            for (let i = 1; i <= tables; i++) {
                await fetch(`${SUPABASE_URL}/rest/v1/tables`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        restaurant_id: data[0].id,
                        table_number: i,
                        seats: i <= 2 ? 2 : (i <= 4 ? 4 : 6),
                        status: 'free'
                    })
                });
            }
        }
        
        // Modal schließen und Form zurücksetzen
        closeModal('addRestaurantModal');
        const addRestaurantForm = document.getElementById('addRestaurantForm');
        if (addRestaurantForm) {
            addRestaurantForm.reset();
            delete addRestaurantForm.dataset.editId; // Edit-ID entfernen
        }
        
        // Bild-Upload zurücksetzen
        uploadedImageBase64 = null;
        clearImagePreview();
        
        // UI aktualisieren
        try { renderRestaurants(); } catch(e) { console.log('renderRestaurants error:', e); }
        try { if (typeof updateMapMarkers === 'function') updateMapMarkers(); } catch(e) { console.log('updateMapMarkers error:', e); }
        try { updateDashboard(); } catch(e) { console.log('updateDashboard error:', e); }
        try { loadRestaurantsDash(); } catch(e) { console.log('loadRestaurantsDash error:', e); }
        
        showToast(isEdit ? `${name} aktualisiert!` : `${name} hinzugefügt!`, 'success');
        
    } catch (e) {
        console.error('Fehler:', e);
        showToast('Verbindungsfehler: ' + e.message, 'error');
    }
}

// Live preview for offer form
function updateOfferPreview() {
    const title = document.getElementById('offerTitle');
    const discount = document.getElementById('offerDiscount');
    const validUntil = document.getElementById('offerValidUntil');
    const previewTitle = document.getElementById('previewTitle');
    const previewDiscount = document.getElementById('previewDiscount');
    
    if (title && previewTitle) {
        previewTitle.textContent = title.value || 'Dein Angebot';
    }
    if (discount && validUntil && previewDiscount) {
        const discountVal = discount.value || 'Rabatt';
        const timeVal = validUntil.value || '--:--';
        previewDiscount.textContent = `${discountVal} bis ${timeVal}`;
    }
}

// ==================== EVENTS ====================
let events = [];
let currentEventFilter = 'all';

async function loadEvents() {
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/events?select=*&is_active=eq.true&order=event_date`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (response.ok) {
            events = await response.json();
            console.log('[OK] Events geladen:', events.length);
        } else {
            events = [];
        }
        renderEvents();
    } catch (e) {
        console.error('Fehler beim Laden der Events:', e);
        events = [];
        renderEvents();
    }
}

function renderEvents(filter = currentEventFilter) {
    const container = document.getElementById('eventsList');
    if (!container) return;
    
    let filtered = events;
    if (filter !== 'all') {
        filtered = events.filter(e => e.category === filter);
    }
    
    if (filtered.length === 0) {
        container.innerHTML = '<p style="padding: 40px; color: var(--slate); text-align: center;">Keine Events gefunden</p>';
        return;
    }
    
    let html = '';
    filtered.forEach(e => {
        const eventDate = new Date(e.event_date);
        const dateStr = eventDate.toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' });
        const categoryLabel = e.category === 'fest' ? 'Fest' : e.category === 'markt' ? 'Markt' : e.category === 'konzert' ? 'Konzert' : e.category === 'natur' ? 'Natur' : 'Event';
        
        html += `
            <div class="restaurant-card" style="margin-bottom: 16px;">
                <div class="card-image" style="background-image: url('${e.image_url || 'https://images.unsplash.com/photo-1533174072545-7a4b6ad7a6c3?w=800'}');">
                    ${e.is_featured ? '<div class="special-badge">Highlight</div>' : ''}
                    <div class="availability-badge available">${dateStr}</div>
                </div>
                <div class="card-content">
                    <div class="card-top">
                        <h3 class="restaurant-name">${e.title}</h3>
                        <span style="background: var(--cream); padding: 4px 8px; border-radius: 4px; font-size: 11px; color: var(--primary);">${categoryLabel}</span>
                    </div>
                    <div class="restaurant-meta">
                        <span class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            ${e.city || 'Ostfriesland'}
                        </span>
                        <span class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            ${e.event_time || 'Ganztägig'}
                        </span>
                    </div>
                    <p style="color: var(--slate); font-size: 14px; margin: 8px 0;">${e.description || ''}</p>
                    <div style="font-weight: 700; color: var(--primary);">${e.price_info || ''}</div>
                    <div class="card-actions" style="margin-top: 12px;">
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent((e.location_name || e.title) + ' ' + (e.city || 'Ostfriesland'))}" target="_blank" class="card-btn card-btn-secondary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="3 11 22 2 13 21 11 13 3 11"/>
                            </svg>
                            Route
                        </a>
                        ${e.website || e.ticket_url ? `
                            <a href="${e.ticket_url || e.website}" target="_blank" class="card-btn card-btn-primary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                    <polyline points="15 3 21 3 21 9"/>
                                    <line x1="10" y1="14" x2="21" y2="3"/>
                                </svg>
                                Mehr Info
                            </a>
                        ` : ''}
                        <button class="card-btn card-btn-secondary" onclick="openReviewsModal('event', '${e.id}', '${e.title.replace(/'/g, "\\'")}')">
                            ⭐ Bewertungen
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Update stats
    const statEvents = document.getElementById('statEvents');
    if (statEvents) statEvents.textContent = events.length;
}

function setEventFilter(filter) {
    currentEventFilter = filter;
    document.querySelectorAll('#filterChipsEvents .chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.filter === filter);
    });
    renderEvents(filter);
}

function showEvents() {
    document.getElementById('mainView').style.display = 'none';
    document.getElementById('favoritesView').classList.remove('active');
    document.getElementById('accommodationsView').classList.remove('active');
    document.getElementById('eventsView').classList.add('active');
    document.getElementById('attractionsView').classList.remove('active');
    if (document.getElementById('jobsView')) document.getElementById('jobsView').classList.remove('active');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('navEvents').classList.add('active');
    
    loadEvents();
}

// ==================== ATTRACTIONS ====================
let attractions = [];
let currentAttractionFilter = 'all';

async function loadAttractions() {
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/attractions?select=*&is_active=eq.true&order=rating.desc`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (response.ok) {
            attractions = await response.json();
            console.log('[OK] Ausflugsziele geladen:', attractions.length);
        } else {
            attractions = [];
        }
        renderAttractions();
    } catch (e) {
        console.error('Fehler beim Laden der Ausflugsziele:', e);
        attractions = [];
        renderAttractions();
    }
}

function renderAttractions(filter = currentAttractionFilter) {
    const container = document.getElementById('attractionsList');
    if (!container) return;
    
    let filtered = attractions;
    if (filter !== 'all') {
        filtered = attractions.filter(a => a.category === filter);
    }
    
    if (filtered.length === 0) {
        container.innerHTML = '<p style="padding: 40px; color: var(--slate); text-align: center;">Keine Ausflugsziele gefunden</p>';
        return;
    }
    
    let html = '';
    filtered.forEach(a => {
        const categoryLabel = a.category === 'natur' ? 'Natur' : a.category === 'museum' ? 'Museum' : a.category === 'historisch' ? 'Historisch' : a.category === 'familie' ? 'Familie' : 'Ausflug';
        
        html += `
            <div class="restaurant-card" style="margin-bottom: 16px;">
                <div class="card-image" style="background-image: url('${a.image_url || 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=800'}');">
                    <div class="rating" style="position: absolute; top: 12px; right: 12px; background: white; padding: 4px 10px; border-radius: 20px; display: flex; align-items: center; gap: 4px;">
                        <svg viewBox="0 0 24 24" fill="var(--warning)" width="14" height="14">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <span style="font-weight: 700; font-size: 13px; color: var(--charcoal);">${a.rating || 4.5}</span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="card-top">
                        <h3 class="restaurant-name">${a.name}</h3>
                        <span style="background: var(--cream); padding: 4px 8px; border-radius: 4px; font-size: 11px; color: var(--primary); font-weight: 600;">${categoryLabel}</span>
                    </div>
                    <div class="restaurant-meta">
                        <span class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            ${a.city || 'Ostfriesland'}
                        </span>
                        ${a.opening_hours ? `
                            <span class="meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                                ${a.opening_hours}
                            </span>
                        ` : ''}
                    </div>
                    <p style="color: var(--slate); font-size: 14px; margin: 8px 0; line-height: 1.4;">${a.description || ''}</p>
                    <div style="font-weight: 700; color: var(--primary); margin-bottom: 12px;">${a.price_info || ''}</div>
                    <div class="card-actions">
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(a.name + ' ' + (a.city || 'Ostfriesland'))}" target="_blank" class="card-btn card-btn-secondary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="3 11 22 2 13 21 11 13 3 11"/>
                            </svg>
                            Route
                        </a>
                        ${a.phone ? `
                            <a href="tel:${a.phone}" class="card-btn card-btn-secondary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                </svg>
                                Anrufen
                            </a>
                        ` : ''}
                        ${a.website ? `
                            <a href="${a.website}" target="_blank" class="card-btn card-btn-primary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                    <polyline points="15 3 21 3 21 9"/>
                                    <line x1="10" y1="14" x2="21" y2="3"/>
                                </svg>
                                Website
                            </a>
                        ` : ''}
                        <button class="card-btn card-btn-secondary" onclick="openReviewsModal('attraction', '${a.id}', '${a.name.replace(/'/g, "\\'")}')">
                            ⭐ Bewertungen
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Update stats
    const statAttractions = document.getElementById('statAttractions');
    if (statAttractions) statAttractions.textContent = attractions.length;
}

function setAttractionFilter(filter) {
    currentAttractionFilter = filter;
    document.querySelectorAll('#filterChipsAttractions .chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.filter === filter);
    });
    renderAttractions(filter);
}

function showAttractions() {
    document.getElementById('mainView').style.display = 'none';
    document.getElementById('favoritesView').classList.remove('active');
    document.getElementById('accommodationsView').classList.remove('active');
    document.getElementById('eventsView').classList.remove('active');
    document.getElementById('attractionsView').classList.add('active');
    if (document.getElementById('jobsView')) document.getElementById('jobsView').classList.remove('active');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('navAttractions').classList.add('active');
    
    loadAttractions();
}

// ==================== JOBS ====================
let jobs = [];
let currentJobFilter = 'all';

function showJobs() {
    document.getElementById('mainView').style.display = 'none';
    document.getElementById('favoritesView').classList.remove('active');
    document.getElementById('accommodationsView').classList.remove('active');
    document.getElementById('eventsView').classList.remove('active');
    document.getElementById('attractionsView').classList.remove('active');
    document.getElementById('jobsView').classList.add('active');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('navJobs').classList.add('active');
    
    loadJobs();
}

async function loadJobs() {
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/jobs?select=*,restaurants(name,city)&is_active=eq.true&order=created_at.desc`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (response.ok) {
            jobs = await response.json();
            renderJobs();
            updateJobStats();
        }
    } catch (e) {
        console.log('Jobs laden Fehler:', e);
        renderJobs();
    }
}

function renderJobs(filter = 'all') {
    const container = document.getElementById('jobsList');
    if (!container) return;
    
    let filteredJobs = jobs;
    if (filter !== 'all') {
        filteredJobs = jobs.filter(j => j.job_type === filter);
    }
    
    if (filteredJobs.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--slate);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 16px; opacity: 0.5;">
                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                </svg>
                <p>${translations[currentLanguage].noJobs || 'Keine Stellenangebote verfügbar'}</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    filteredJobs.forEach(job => {
        const restaurantName = job.restaurants ? job.restaurants.name : 'Restaurant';
        const city = job.restaurants ? job.restaurants.city : '';
        
        const typeLabels = {
            fulltime: { de: 'Vollzeit', en: 'Full-time', nl: 'Voltijd' },
            parttime: { de: 'Teilzeit', en: 'Part-time', nl: 'Deeltijd' },
            minijob: { de: 'Minijob', en: 'Mini job', nl: 'Minibaan' }
        };
        
        const typeLabel = typeLabels[job.job_type] ? typeLabels[job.job_type][currentLanguage] || typeLabels[job.job_type].de : job.job_type;
        
        html += `
            <div class="job-card" onclick="showJobDetail('${job.id}')">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <div>
                        <h3 style="font-size: 17px; font-weight: 700; color: var(--dark); margin-bottom: 4px;">${job.title}</h3>
                        <p style="font-size: 14px; color: var(--slate);">${restaurantName}${city ? ' • ' + city : ''}</p>
                    </div>
                    ${job.is_urgent ? '<span class="job-badge urgent">Dringend</span>' : ''}
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                    <span class="job-badge ${job.job_type}">${typeLabel}</span>
                    ${job.salary ? `<span style="font-size: 13px; color: var(--slate);">${job.salary}</span>` : ''}
                </div>
                ${job.description ? `<p style="font-size: 14px; color: var(--slate); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${job.description}</p>` : ''}
                <div style="margin-top: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 12px; color: var(--slate);">${formatJobDate(job.created_at)}</span>
                    <button style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;" onclick="event.stopPropagation(); applyForJob('${job.id}')">
                        ${translations[currentLanguage].apply || 'Bewerben'}
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function filterJobs(filter) {
    currentJobFilter = filter;
    
    document.querySelectorAll('[id^="filterJobs"]').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const filterMap = { all: 'All', fulltime: 'Fulltime', parttime: 'Parttime', minijob: 'Minijob' };
    const activeBtn = document.getElementById('filterJobs' + filterMap[filter]);
    if (activeBtn) activeBtn.classList.add('active');
    
    renderJobs(filter);
}

function updateJobStats() {
    const totalEl = document.getElementById('statJobsTotal');
    const urgentEl = document.getElementById('statJobsUrgent');
    const restaurantsEl = document.getElementById('statJobsRestaurants');
    
    if (totalEl) totalEl.textContent = jobs.length;
    if (urgentEl) urgentEl.textContent = jobs.filter(j => j.is_urgent).length;
    if (restaurantsEl) {
        const uniqueRestaurants = [...new Set(jobs.map(j => j.restaurant_id))];
        restaurantsEl.textContent = uniqueRestaurants.length;
    }
}

function formatJobDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const now = new Date();
    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return translations[currentLanguage].today || 'Heute';
    if (diffDays === 1) return translations[currentLanguage].yesterday || 'Gestern';
    if (diffDays < 7) return `${diffDays} ${translations[currentLanguage].daysAgo || 'Tage'}`;
    return date.toLocaleDateString('de-DE');
}

function applyForJob(jobId) {
    const job = jobs.find(j => j.id === jobId);
    if (!job) return;
    
    // WhatsApp oder Email
    if (job.contact_whatsapp) {
        const text = encodeURIComponent(`Hallo, ich interessiere mich für die Stelle "${job.title}".`);
        window.open(`https://wa.me/${job.contact_whatsapp.replace(/[^0-9]/g, '')}?text=${text}`, '_blank');
    } else if (job.contact_email) {
        window.location.href = `mailto:${job.contact_email}?subject=Bewerbung: ${job.title}`;
    } else {
        showToast('Kontaktdaten nicht verfügbar');
    }
}

// ==================== ACCOMMODATIONS ====================
let accommodations = [];

async function loadAccommodations() {
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/accommodations?select=*&is_active=eq.true&order=name`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (response.ok) {
            accommodations = await response.json();
            console.log('[OK] Unterkünfte geladen:', accommodations.length);
        } else {
            accommodations = [];
        }
        renderAccommodations();
    } catch (e) {
        console.error('Fehler beim Laden der Unterkünfte:', e);
        accommodations = [];
        renderAccommodations();
    }
}

function renderAccommodations(filter = 'all') {
    const container = document.getElementById('accommodationsList');
    if (!container) return;
    
    const searchTerm = document.getElementById('searchAccommodation')?.value?.toLowerCase() || '';
    
    let filtered = accommodations;
    
    // Filter by type
    if (filter === 'available') {
        filtered = accommodations.filter(a => a.has_availability);
    } else if (filter !== 'all') {
        filtered = accommodations.filter(a => a.type === filter);
    }
    
    // Filter by search
    if (searchTerm) {
        filtered = filtered.filter(a => 
            a.name.toLowerCase().includes(searchTerm) ||
            (a.city && a.city.toLowerCase().includes(searchTerm)) ||
            (a.type && a.type.toLowerCase().includes(searchTerm))
        );
    }
    
    // Update stats
    const statAcc = document.getElementById('statAccommodations');
    const statAvail = document.getElementById('statAvailable');
    const statOffers = document.getElementById('statAccOffers');
    
    if (statAcc) statAcc.textContent = accommodations.length;
    if (statAvail) statAvail.textContent = accommodations.filter(a => a.has_availability).length;
    if (statOffers) statOffers.textContent = accommodations.filter(a => a.offer).length;
    
    if (filtered.length === 0) {
        container.innerHTML = '<p style="padding: 40px; color: var(--slate); text-align: center;">Keine Unterkünfte gefunden</p>';
        return;
    }
    
    let html = '';
    filtered.forEach(a => {
        const typeLabel = a.type === 'ferienwohnung' ? 'Ferienwohnung' : 
                         a.type === 'hotel' ? 'Hotel' : 
                         a.type === 'pension' ? 'Pension' : 'Unterkunft';
        
        html += `
            <div class="restaurant-card" style="margin-bottom: 16px;">
                <div class="card-image" style="background-image: url('${a.image_url || 'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=800'}');">
                    <div class="availability-badge ${a.has_availability ? 'available' : 'full'}">
                        ${a.has_availability ? 'Verfügbar' : 'Ausgebucht'}
                    </div>
                    ${a.offer ? `<div class="special-badge">${a.offer.discount}</div>` : ''}
                </div>
                <div class="card-content">
                    <div class="card-top">
                        <h3 class="restaurant-name">${a.name}</h3>
                        <span style="background: var(--cream); padding: 4px 8px; border-radius: 4px; font-size: 11px; color: var(--primary);">${typeLabel}</span>
                    </div>
                    <div class="restaurant-meta">
                        <span class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            ${a.city || 'Ostfriesland'}
                        </span>
                        <span class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                            </svg>
                            max. ${a.max_guests || 4} Gäste
                        </span>
                    </div>
                    <div style="font-weight: 700; color: var(--primary); margin: 8px 0; font-size: 16px;">${a.price_info || ''}</div>
                    
                    <div class="card-actions">
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(a.name + ' ' + (a.city || 'Ostfriesland'))}" target="_blank" class="card-btn card-btn-secondary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="3 11 22 2 13 21 11 13 3 11"/>
                            </svg>
                            Route
                        </a>
                        ${a.whatsapp ? `
                            <a href="https://wa.me/${a.whatsapp.replace(/[^0-9]/g, '')}?text=${encodeURIComponent('Hallo! Ich interessiere mich für Ihre Unterkunft über Kiek mol in.')}" target="_blank" class="card-btn card-btn-whatsapp">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                </svg>
                                WhatsApp
                            </a>
                        ` : `
                            <a href="tel:${a.phone}" class="card-btn card-btn-secondary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                </svg>
                                Anrufen
                            </a>
                        `}
                        <button class="card-btn card-btn-primary" onclick="openAccommodationInquiry('${a.id}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            Anfragen
                        </button>
                        <button class="card-btn card-btn-secondary" onclick="openReviewsModal('accommodation', '${a.id}', '${a.name.replace(/'/g, "\\'")}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>
                            ⭐ Bewertungen
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function filterAccommodations(filter) {
    renderAccommodations(filter);
}

let currentAccFilter = 'all';

function setAccFilter(filter) {
    currentAccFilter = filter;
    
    // Update active chip
    document.querySelectorAll('#filterChipsAcc .chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.filter === filter);
    });
    
    renderAccommodations(filter);
}

function filterAccommodationsBySearch() {
    renderAccommodations(currentAccFilter);
}

function showMainView() {
    document.getElementById('mainView').style.display = 'block';
    document.getElementById('favoritesView').classList.remove('active');
    document.getElementById('accommodationsView').classList.remove('active');
    document.getElementById('eventsView').classList.remove('active');
    document.getElementById('attractionsView').classList.remove('active');
    if (document.getElementById('jobsView')) document.getElementById('jobsView').classList.remove('active');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('navHome').classList.add('active');
}

function showFavorites() {
    document.getElementById('mainView').style.display = 'none';
    document.getElementById('favoritesView').classList.add('active');
    document.getElementById('accommodationsView').classList.remove('active');
    document.getElementById('eventsView').classList.remove('active');
    document.getElementById('attractionsView').classList.remove('active');
    if (document.getElementById('jobsView')) document.getElementById('jobsView').classList.remove('active');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    
    renderFavorites();
}

function showAccommodations() {
    document.getElementById('mainView').style.display = 'none';
    document.getElementById('favoritesView').classList.remove('active');
    document.getElementById('accommodationsView').classList.add('active');
    document.getElementById('eventsView').classList.remove('active');
    document.getElementById('attractionsView').classList.remove('active');
    if (document.getElementById('jobsView')) document.getElementById('jobsView').classList.remove('active');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('navAccommodations').classList.add('active');
    
    loadAccommodations();
}

function openAccommodationInquiry(accommodationId) {
    const accommodation = accommodations.find(a => a.id == accommodationId);
    if (!accommodation) return;
    
    document.getElementById('inquiryAccommodationId').value = accommodationId;
    document.getElementById('inquiryAccommodationName').textContent = accommodation.name;
    
    // Set default dates
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const dayAfter = new Date(today);
    dayAfter.setDate(dayAfter.getDate() + 3);
    
    document.getElementById('inquiryCheckIn').value = tomorrow.toISOString().split('T')[0];
    document.getElementById('inquiryCheckIn').min = today.toISOString().split('T')[0];
    document.getElementById('inquiryCheckOut').value = dayAfter.toISOString().split('T')[0];
    
    // Show booking link if available
    const bookingLinkDiv = document.getElementById('accommodationBookingLink');
    const bookingLinkBtn = document.getElementById('bookingLinkBtn');
    if (accommodation.booking_url) {
        bookingLinkBtn.href = accommodation.booking_url;
        bookingLinkDiv.style.display = 'block';
    } else {
        bookingLinkDiv.style.display = 'none';
    }
    
    openModal('accommodationInquiryModal');
}

async function submitAccommodationInquiry(e) {
    e.preventDefault();
    
    const accommodationId = document.getElementById('inquiryAccommodationId').value;
    const accommodation = accommodations.find(a => a.id == accommodationId);
    
    const inquiry = {
        accommodation_id: accommodationId,
        guest_name: document.getElementById('inquiryName').value,
        guest_email: document.getElementById('inquiryEmail').value,
        guest_phone: document.getElementById('inquiryPhone').value,
        check_in: document.getElementById('inquiryCheckIn').value,
        check_out: document.getElementById('inquiryCheckOut').value,
        guests_count: parseInt(document.getElementById('inquiryGuests').value),
        message: document.getElementById('inquiryMessage').value,
        status: 'pending'
    };
    
    if (useSupabase) {
        try {
            await supabasePost('accommodation_inquiries', inquiry);
            console.log('[OK] Anfrage gespeichert');
        } catch (e) {
            console.error('Fehler:', e);
        }
    }
    
    closeModal('accommodationInquiryModal');
    document.getElementById('accommodationInquiryForm').reset();
    
    // WhatsApp wenn vorhanden
    if (accommodation && accommodation.whatsapp) {
        const checkIn = new Date(inquiry.check_in).toLocaleDateString('de-DE');
        const checkOut = new Date(inquiry.check_out).toLocaleDateString('de-DE');
        const message = `Hallo! 

Ich interessiere mich für Ihre Unterkunft "${accommodation.name}":

Check-in: ${checkIn}
Check-out: ${checkOut}
${inquiry.guests_count} Gäste
Name: ${inquiry.guest_name}
Telefon: ${inquiry.guest_phone}
${inquiry.message ? `${inquiry.message}` : ''}

Gesendet über Kiek mol in`;
        
        const whatsappUrl = `https://wa.me/${accommodation.whatsapp.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }
    
    showToast('Anfrage gesendet! Die Unterkunft wird sich bei Ihnen melden.', 'success');
}

// ==================== ACCOMMODATIONS DASHBOARD ====================
async function loadAccommodationsDash() {
    if (!useSupabase) {
        renderAccommodationsDash();
        return;
    }
    
    try {
        const accData = await supabaseGet('accommodations', 'select=*&is_active=eq.true&order=name');
        accommodations = accData || [];
        
        const inquiryData = await supabaseGet('accommodation_inquiries', 'select=*&order=created_at.desc&limit=20');
        
        renderAccommodationsDash();
        renderAccommodationInquiries(inquiryData || []);
        updateAccommodationStats();
        
    } catch (e) {
        console.error('Fehler beim Laden:', e);
    }
}

function renderAccommodationsDash() {
    const container = document.getElementById('accommodationsDashList');
    if (!container) return;
    
    if (accommodations.length === 0) {
        container.innerHTML = '<p style="padding: 40px; color: var(--slate); text-align: center;">Noch keine Unterkünfte angelegt</p>';
        return;
    }
    
    let html = `
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: var(--cream); text-align: left;">
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Unterkunft</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Typ</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Ort</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Status</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Aktionen</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    accommodations.forEach(a => {
        const typeLabel = a.type === 'ferienwohnung' ? 'Ferienwohnung' : 
                         a.type === 'hotel' ? 'Hotel' : 
                         a.type === 'pension' ? 'Pension' : 'Unterkunft';
        
        html += `
            <tr style="border-bottom: 1px solid var(--sand);">
                <td style="padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 50px; height: 50px; background-image: url('${a.image_url || 'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=200'}'); background-size: cover; border-radius: 8px;"></div>
                        <div>
                            <div style="font-weight: 600; color: var(--dark);">${a.name}</div>
                            <div style="font-size: 13px; color: var(--slate);">${a.price_info || ''}</div>
                        </div>
                    </div>
                </td>
                <td style="padding: 16px; color: var(--dark);">${typeLabel}</td>
                <td style="padding: 16px; color: var(--dark);">${a.city || '-'}</td>
                <td style="padding: 16px;">
                    <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${a.has_availability ? 'rgba(52,199,89,0.15)' : 'rgba(255,149,0,0.15)'}; color: ${a.has_availability ? 'var(--success)' : 'var(--warning)'};">
                        ${a.has_availability ? 'Verfügbar' : 'Ausgebucht'}
                    </span>
                </td>
                <td style="padding: 16px;">
                    <div style="display: flex; gap: 8px;">
                        <button onclick="toggleAccommodationAvailability('${a.id}', ${a.has_availability})" style="padding: 8px 12px; background: ${a.has_availability ? 'rgba(255,149,0,0.15)' : 'rgba(52,199,89,0.15)'}; color: ${a.has_availability ? 'var(--warning)' : 'var(--success)'}; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;" title="${a.has_availability ? 'Als ausgebucht markieren' : 'Als verfügbar markieren'}">
                            ${a.has_availability ? 'Ausgebucht' : 'Verfügbar'}
                        </button>
                        <button onclick="deleteAccommodation('${a.id}', '${a.name}')" style="padding: 8px 12px; background: rgba(255,59,48,0.15); color: var(--danger); border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Löschen"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function renderAccommodationInquiries(inquiries) {
    const container = document.getElementById('accommodationInquiriesList');
    if (!container) return;
    
    if (!inquiries || inquiries.length === 0) {
        container.innerHTML = '<p style="padding: 20px; color: var(--slate); text-align: center;">Keine Anfragen</p>';
        return;
    }
    
    let html = '';
    inquiries.forEach(i => {
        const accommodation = accommodations.find(a => a.id === i.accommodation_id);
        const checkIn = new Date(i.check_in).toLocaleDateString('de-DE');
        const checkOut = new Date(i.check_out).toLocaleDateString('de-DE');
        
        html += `
            <div style="padding: 16px; border-bottom: 1px solid var(--sand); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600; color: var(--dark);">${i.guest_name}</div>
                    <div style="font-size: 13px; color: var(--slate);">
                        ${accommodation ? accommodation.name : 'Unterkunft'} • ${checkIn} - ${checkOut} • ${i.guests_count} Gäste
                    </div>
                    <div style="font-size: 13px; color: var(--slate); margin-top: 4px;">
                        ${i.guest_phone || '-'} • ${i.guest_email || '-'}
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${i.status === 'confirmed' ? 'rgba(52,199,89,0.15)' : i.status === 'cancelled' ? 'rgba(255,59,48,0.15)' : 'rgba(255,149,0,0.15)'}; color: ${i.status === 'confirmed' ? 'var(--success)' : i.status === 'cancelled' ? 'var(--danger)' : 'var(--warning)'};">
                        ${i.status === 'confirmed' ? 'Bestätigt' : i.status === 'cancelled' ? 'Storniert' : 'Neu'}
                    </span>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Update inquiry count
    const countEl = document.getElementById('accommodationInquiries');
    if (countEl) countEl.textContent = inquiries.filter(i => i.status === 'pending').length;
}

function updateAccommodationStats() {
    const totalEl = document.getElementById('totalAccommodations');
    const availEl = document.getElementById('availableAccommodations');
    const countEl = document.getElementById('accommodationCount');
    
    if (totalEl) totalEl.textContent = accommodations.length;
    if (availEl) availEl.textContent = accommodations.filter(a => a.has_availability).length;
    if (countEl) countEl.textContent = accommodations.length;
}

async function addAccommodation(e) {
    e.preventDefault();
    
    const accommodation = {
        name: document.getElementById('accName').value,
        type: document.getElementById('accType').value,
        city: document.getElementById('accCity').value || 'Greetsiel',
        price_info: document.getElementById('accPrice').value,
        max_guests: parseInt(document.getElementById('accMaxGuests').value) || 4,
        phone: document.getElementById('accPhone').value,
        whatsapp: document.getElementById('accWhatsapp').value,
        email: document.getElementById('accEmail').value,
        website: document.getElementById('accWebsite').value,
        booking_url: document.getElementById('accBookingUrl').value,
        is_active: true,
        has_availability: true,
        latitude: 53.5021,
        longitude: 7.0965
    };
    
    if (!useSupabase) {
        showToast('Keine Datenbankverbindung', 'error');
        return;
    }
    
    try {
        await supabasePost('accommodations', accommodation);
        
        closeModal('addAccommodationModal');
        document.getElementById('addAccommodationForm').reset();
        loadAccommodationsDash();
        showToast(`${accommodation.name} angelegt!`, 'success');
        
    } catch (e) {
        showToast('Fehler: ' + e.message, 'error');
    }
}

async function toggleAccommodationAvailability(id, currentStatus) {
    if (!useSupabase) return;
    
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/accommodations?id=eq.${id}`, {
            method: 'PATCH',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ has_availability: !currentStatus })
        });
        
        loadAccommodationsDash();
        loadAccommodations();
        showToast(currentStatus ? 'Als ausgebucht markiert' : 'Als verfügbar markiert', 'success');
        
    } catch (e) {
        showToast('Fehler: ' + e.message, 'error');
    }
}

async function deleteAccommodation(id, name) {
    if (!confirm(`Unterkunft "${name}" wirklich löschen?`)) return;
    
    if (!useSupabase) return;
    
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/accommodations?id=eq.${id}`, {
            method: 'DELETE',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        loadAccommodationsDash();
        loadAccommodations();
        showToast('Unterkunft gelöscht', 'success');
        
    } catch (e) {
        showToast('Fehler: ' + e.message, 'error');
    }
}

// ==================== CUSTOMER MANAGEMENT ====================
let customers = [];

async function loadCustomers() {
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/customers?select=*&role=neq.superadmin&order=created_at.desc`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (response.ok) {
            customers = await response.json();
            console.log('[OK] Kunden geladen:', customers.length);
            renderCustomers();
            updateCustomerStats();
            populateRestaurantDropdown();
        }
    } catch (e) {
        console.error('Fehler beim Laden der Kunden:', e);
    }
}

function renderCustomers() {
    const container = document.getElementById('customersList');
    if (!container) return;
    
    if (customers.length === 0) {
        container.innerHTML = '<p style="padding: 40px; color: var(--slate); text-align: center;">Noch keine Kunden angelegt</p>';
        return;
    }
    
    let html = `
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: var(--cream); text-align: left;">
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Kunde</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Restaurant</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Beitrag</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Status</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Aktionen</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    customers.forEach(c => {
        const statusColor = c.payment_status === 'paid' ? 'var(--success)' : 
                           c.payment_status === 'overdue' ? 'var(--danger)' : 'var(--warning)';
        const statusBg = c.payment_status === 'paid' ? 'rgba(52,199,89,0.15)' : 
                        c.payment_status === 'overdue' ? 'rgba(255,59,48,0.15)' : 'rgba(255,149,0,0.15)';
        const statusText = c.payment_status === 'paid' ? 'Bezahlt' : 
                          c.payment_status === 'overdue' ? 'Überfällig' : 'Ausstehend';
        
        const restaurant = APP_DATA.restaurants.find(r => r.id === c.restaurant_id);
        
        html += `
            <tr style="border-bottom: 1px solid var(--sand);">
                <td style="padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">${c.name.charAt(0).toUpperCase()}</div>
                        <div>
                            <div style="font-weight: 600; color: var(--dark);">${c.name}</div>
                            <div style="font-size: 13px; color: var(--slate);">${c.email}</div>
                        </div>
                    </div>
                </td>
                <td style="padding: 16px; color: var(--dark);">${restaurant ? restaurant.name : '<span style="color: var(--slate);">-</span>'}</td>
                <td style="padding: 16px; font-weight: 600; color: var(--dark);">${c.monthly_fee ? c.monthly_fee.toFixed(2) + ' €' : '-'}</td>
                <td style="padding: 16px;">
                    <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${statusBg}; color: ${statusColor};">${statusText}</span>
                </td>
                <td style="padding: 16px;">
                    <div style="display: flex; gap: 8px;">
                        <button onclick="openPaymentModal('${c.id}', '${c.name.replace(/'/g, "\\'")}', ${c.monthly_fee || 29.90})" style="padding: 8px 12px; background: rgba(52,199,89,0.15); color: var(--success); border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Zahlung erfassen"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></button>
                        <button onclick="toggleCustomerStatus('${c.id}', ${c.is_active})" style="padding: 8px 12px; background: ${c.is_active ? 'rgba(255,149,0,0.15)' : 'rgba(52,199,89,0.15)'}; color: ${c.is_active ? 'var(--warning)' : 'var(--success)'}; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="${c.is_active ? 'Sperren' : 'Aktivieren'}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">${c.is_active ? '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>' : '<polyline points="20 6 9 17 4 12"/>'}</svg></button>
                        <button onclick="deleteCustomer('${c.id}', '${c.name.replace(/'/g, "\\'")}')\" style="padding: 8px 12px; background: rgba(255,59,48,0.15); color: var(--danger); border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Löschen"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function updateCustomerStats() {
    const total = customers.length;
    const paid = customers.filter(c => c.payment_status === 'paid').length;
    const pending = customers.filter(c => c.payment_status === 'pending').length;
    const overdue = customers.filter(c => c.payment_status === 'overdue').length;
    
    const totalEl = document.getElementById('totalCustomers');
    const paidEl = document.getElementById('paidCustomers');
    const pendingEl = document.getElementById('pendingCustomers');
    const overdueEl = document.getElementById('overdueCustomers');
    const countEl = document.getElementById('customerCount');
    
    if (totalEl) totalEl.textContent = total;
    if (paidEl) paidEl.textContent = paid;
    if (pendingEl) pendingEl.textContent = pending;
    if (overdueEl) overdueEl.textContent = overdue;
    if (countEl) countEl.textContent = total;
}

function populateRestaurantDropdown() {
    const select = document.getElementById('customerRestaurant');
    if (!select) return;
    
    let html = '<option value="">-- Kein Restaurant --</option>';
    APP_DATA.restaurants.forEach(r => {
        html += `<option value="${r.id}">${r.name}</option>`;
    });
    select.innerHTML = html;
}

function toggleNewRestaurant() {
    const select = document.getElementById('customerRestaurant');
    const fields = document.getElementById('newRestaurantFields');
    if (fields) {
        fields.style.display = select.value ? 'none' : 'block';
    }
}

async function addCustomer(e) {
    e.preventDefault();
    
    const name = document.getElementById('customerName').value;
    const email = document.getElementById('customerEmail').value;
    const password = document.getElementById('customerPassword').value;
    const phone = document.getElementById('customerPhone').value;
    let restaurantId = document.getElementById('customerRestaurant').value;
    const fee = parseFloat(document.getElementById('customerFee').value) || 29.90;
    
    console.log('Kunde anlegen:', name, email);
    
    try {
        // Wenn kein Restaurant ausgewählt, neues anlegen
        if (!restaurantId) {
            const restName = document.getElementById('newRestName').value;
            if (!restName) {
                showToast('Bitte Restaurant-Name eingeben', 'error');
                return;
            }
            
            const restCity = document.getElementById('newRestCity').value || 'Greetsiel';
            const restCuisine = document.getElementById('newRestCuisine').value || 'deutsch';
            const restPhone = document.getElementById('newRestPhone').value || '';
            const restWhatsapp = document.getElementById('newRestWhatsapp').value || '';
            const restWebsite = document.getElementById('newRestWebsite').value || '';
            const restFacebook = document.getElementById('newRestFacebook').value || '';
            const restInstagram = document.getElementById('newRestInstagram').value || '';
            const restMenu = document.getElementById('newRestMenu').value || '';
            const restStreet = document.getElementById('newRestStreet').value || '';
            const restGoogleMaps = document.getElementById('newRestGoogleMaps').value || '';
            
            // Koordinaten basierend auf Ort
            const cityCoords = {
                'Greetsiel': { lat: 53.5021, lng: 7.0965 },
                'Norddeich': { lat: 53.6108, lng: 7.1542 },
                'Norden': { lat: 53.5967, lng: 7.2058 },
                'Aurich': { lat: 53.4714, lng: 7.4808 },
                'Emden': { lat: 53.3594, lng: 7.2060 }
            };
            const coords = cityCoords[restCity] || { lat: 53.5021, lng: 7.0965 };
            const lat = coords.lat + (Math.random() - 0.5) * 0.005;
            const lng = coords.lng + (Math.random() - 0.5) * 0.005;
            
            // Restaurant in Supabase anlegen
            const response = await fetch(`${SUPABASE_URL}/rest/v1/restaurants`, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify({
                    name: restName,
                    city: restCity,
                    street: restStreet,
                    cuisine_type: [restCuisine],
                    phone: restPhone,
                    whatsapp: restWhatsapp,
                    website: restWebsite,
                    facebook: restFacebook,
                    instagram: restInstagram,
                    menu_url: restMenu,
                    google_maps_url: restGoogleMaps,
                    is_active: true,
                    is_open: true,
                    rating: 4.5,
                    latitude: lat,
                    longitude: lng
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                restaurantId = data[0].id;
                console.log('[OK] Restaurant angelegt:', restName);
                
                // Lokal auch hinzufügen
                APP_DATA.restaurants.push({
                    id: restaurantId,
                    name: restName,
                    cuisine: restCuisine,
                    rating: 4.5,
                    freeTables: 8,
                    waitTime: 0,
                    phone: restPhone,
                    whatsapp: restWhatsapp,
                    website: restWebsite,
                    googleMapsUrl: restGoogleMaps,
                    lat: lat,
                    lng: lng,
                    image: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800',
                    offer: null
                });
            } else {
                const error = await response.json();
                throw new Error(error.message || 'Restaurant konnte nicht angelegt werden');
            }
        }
        
        // Kunde anlegen
        console.log('Speichere Kunde in Supabase...');
        
        // SEPA-Daten
        const accountHolder = document.getElementById('customerAccountHolder')?.value || '';
        const iban = document.getElementById('customerIBAN')?.value?.replace(/\s/g, '') || '';
        const bic = document.getElementById('customerBIC')?.value || '';
        const sepaMandat = document.getElementById('customerSEPAMandat')?.checked || false;
        const mandateRef = sepaMandat ? 'KMI-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase() : '';
        
        const customerResponse = await fetch(`${SUPABASE_URL}/rest/v1/customers`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify({
                name: name,
                email: email,
                password: password,
                phone: phone,
                restaurant_id: restaurantId || null,
                monthly_fee: fee,
                payment_status: 'pending',
                is_active: true,
                role: 'restaurant',
                account_holder: accountHolder,
                iban: iban,
                bic: bic,
                sepa_mandate: sepaMandat,
                mandate_reference: mandateRef,
                mandate_date: sepaMandat ? new Date().toISOString().split('T')[0] : null
            })
        });
        
        if (!customerResponse.ok) {
            const errorText = await customerResponse.text();
            console.error('Kunde Fehler:', errorText);
            throw new Error(errorText);
        }
        
        console.log('[OK] Kunde gespeichert');
        
        closeModal('addCustomerModal');
        const addCustomerForm = document.getElementById('addCustomerForm');
        if (addCustomerForm) addCustomerForm.reset();
        const newRestaurantFields = document.getElementById('newRestaurantFields');
        if (newRestaurantFields) newRestaurantFields.style.display = 'block';
        
        try { loadCustomers(); } catch(e) { console.log('loadCustomers error:', e); }
        try { renderRestaurants(); } catch(e) { console.log('renderRestaurants error:', e); }
        try { populateRestaurantDropdown(); } catch(e) { console.log('populateRestaurantDropdown error:', e); }
        
        showToast(`Kunde ${name} angelegt!`, 'success');
        
    } catch (e) {
        console.error('Fehler:', e);
        showToast('Fehler: ' + e.message, 'error');
    }
}

function openPaymentModal(customerId, customerName, amount) {
    document.getElementById('paymentCustomerId').value = customerId;
    document.getElementById('paymentCustomerName').textContent = customerName;
    document.getElementById('paymentAmount').value = amount;
    openModal('paymentModal');
}

async function recordPayment() {
    const customerId = document.getElementById('paymentCustomerId').value;
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const method = document.getElementById('paymentMethod').value;
    
    if (!useSupabase) {
        showToast('Keine Datenbankverbindung', 'error');
        return;
    }
    
    try {
        // Zahlung speichern
        await supabasePost('payments', {
            customer_id: customerId,
            amount,
            payment_method: method,
            status: 'completed'
        });
        
        // Kundenstatus aktualisieren
        const nextMonth = new Date();
        nextMonth.setMonth(nextMonth.getMonth() + 1);
        
        await fetch(`${SUPABASE_URL}/rest/v1/customers?id=eq.${customerId}`, {
            method: 'PATCH',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                payment_status: 'paid',
                last_payment_date: new Date().toISOString().split('T')[0],
                next_payment_date: nextMonth.toISOString().split('T')[0]
            })
        });
        
        closeModal('paymentModal');
        loadCustomers();
        showToast('Zahlung erfasst!', 'success');
        
    } catch (e) {
        showToast('Fehler: ' + e.message, 'error');
    }
}

// IBAN automatisch formatieren (DE89 3704 0044 ...)
function formatIBAN(input) {
    let value = input.value.replace(/\s/g, '').toUpperCase();
    let formatted = '';
    for (let i = 0; i < value.length; i++) {
        if (i > 0 && i % 4 === 0) formatted += ' ';
        formatted += value[i];
    }
    input.value = formatted;
    
    // Mandatsreferenz generieren wenn IBAN eingegeben
    if (value.length >= 22) {
        const mandateEl = document.getElementById('customerMandateRef');
        if (mandateEl && !mandateEl.value) {
            mandateEl.value = 'KMI-' + Date.now().toString().slice(-8);
        }
    }
}

// SEPA-Lastschrift CSV Export
function exportSEPACSV() {
    const sepaCustomers = customers.filter(c => c.iban && c.sepa_mandate);
    
    if (sepaCustomers.length === 0) {
        showToast('Keine Kunden mit SEPA-Mandat gefunden', 'error');
        return;
    }
    
    // CSV Header
    let csv = 'Mandatsreferenz;Kontoinhaber;IBAN;BIC;Betrag;Verwendungszweck;Mandatsdatum\n';
    
    // Daten
    sepaCustomers.forEach(c => {
        const restaurant = APP_DATA.restaurants.find(r => r.id === c.restaurant_id);
        const verwendung = `Kiek mol in - ${restaurant?.name || 'Monatsbeitrag'} - ${new Date().toLocaleDateString('de-DE', { month: 'long', year: 'numeric' })}`;
        
        csv += `${c.mandate_reference || ''};${c.account_holder || c.name};${c.iban};${c.bic || ''};${c.monthly_fee || 29.90};${verwendung};${c.mandate_date || ''}\n`;
    });
    
    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `SEPA-Lastschrift-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast(`${sepaCustomers.length} SEPA-Lastschriften exportiert`, 'success');
}

async function toggleCustomerStatus(customerId, currentStatus) {
    if (!useSupabase) return;
    
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/customers?id=eq.${customerId}`, {
            method: 'PATCH',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_active: !currentStatus })
        });
        
        loadCustomers();
        showToast(currentStatus ? 'Kunde gesperrt' : 'Kunde aktiviert', 'success');
        
    } catch (e) {
        showToast('Fehler: ' + e.message, 'error');
    }
}

async function deleteCustomer(customerId, customerName) {
    if (!confirm(`Kunde "${customerName}" wirklich löschen?`)) return;
    
    if (!useSupabase) {
        showToast('Supabase nicht verbunden', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/customers?id=eq.${customerId}`, {
            method: 'DELETE',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Prefer': 'return=minimal'
            }
        });
        
        if (!response.ok) {
            throw new Error('Löschen fehlgeschlagen: ' + response.status);
        }
        
        // Aus lokaler Liste entfernen
        customers = customers.filter(c => c.id !== customerId);
        renderCustomers();
        showToast('Kunde gelöscht', 'success');
        
    } catch (e) {
        console.error('Delete Customer Error:', e);
        showToast('Fehler: ' + e.message, 'error');
    }
}

// ==================== INITIALIZATION ====================
function init() {
    // Nur App-Daten löschen, NICHT Theme-Einstellungen
    localStorage.removeItem('kmi_favorites');
    localStorage.removeItem('kmi_reservations');
    localStorage.removeItem('kmi_offers');
    localStorage.removeItem('kmi_tables');
    console.log('[CLEAR] App-Daten zurückgesetzt (Theme behalten)');
    
    renderRestaurants();
    updateDashboard();
    initMap();
    
    // Supabase verbinden - Daten laden
    initSupabase();
    
    // Kunden laden
    setTimeout(() => loadCustomers(), 1000);
    
    // Wetter laden (Theme wird automatisch mit aktualisiert)
    loadWeather();
    
    // Bind offer form live preview
    const offerTitle = document.getElementById('offerTitle');
    const offerDiscount = document.getElementById('offerDiscount');
    const offerValidUntil = document.getElementById('offerValidUntil');
    
    if (offerTitle) offerTitle.addEventListener('input', updateOfferPreview);
    if (offerDiscount) offerDiscount.addEventListener('input', updateOfferPreview);
    if (offerValidUntil) offerValidUntil.addEventListener('input', updateOfferPreview);
    
    // Live Stats alle 30 Sekunden aktualisieren
    setInterval(() => {
        updateLiveStats();
    }, 30000);
    
    // Theme initialisieren
    initTheme();
    
    // Sprache initialisieren
    initLanguage();
    
    // Benachrichtigungen initialisieren
    initNotifications();
    
    // Profil initialisieren
    initProfile();
    
    // Auto-Refresh für Restaurant Updates (alle 30 Sekunden)
    setInterval(autoRefreshRestaurants, 30000);
    
    console.log('Kiek mol in - App initialisiert');
}

// ==================== NOTIFICATIONS ====================
let notifications = [];

function initNotifications() {
    // Gespeicherte Notifications laden
    const saved = localStorage.getItem('kmi_notifications');
    if (saved) {
        try {
            notifications = JSON.parse(saved);
        } catch (e) {
            notifications = [];
        }
    }
    
    // Keine Demo-Notifications - nur echte Daten
    renderNotifications();
    updateNotificationBadge();
}

function renderNotifications() {
    const container = document.getElementById('notificationList');
    if (!container) return;
    
    if (notifications.length === 0) {
        container.innerHTML = `
            <div class="empty-notifications">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
                <p>Keine Benachrichtigungen</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    notifications.forEach(n => {
        const timeAgo = getTimeAgo(n.time);
        html += `
            <div class="notification-item ${n.read ? '' : 'unread'}" onclick="markAsRead(${n.id})">
                <div class="notification-icon ${n.iconClass}">${n.icon}</div>
                <div class="notification-content">
                    <div class="notification-title">${n.title}</div>
                    <div class="notification-text">${n.text}</div>
                    <div class="notification-time">${timeAgo}</div>
                </div>
                ${n.read ? '' : '<div class="notification-dot"></div>'}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function getTimeAgo(timestamp) {
    const diff = Date.now() - timestamp;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Gerade eben';
    if (minutes < 60) return `Vor ${minutes} Min.`;
    if (hours < 24) return `Vor ${hours} Std.`;
    return `Vor ${days} Tag${days > 1 ? 'en' : ''}`;
}

function markAsRead(id) {
    const notification = notifications.find(n => n.id === id);
    if (notification) {
        notification.read = true;
        saveNotifications();
        renderNotifications();
        updateNotificationBadge();
    }
}

function updateNotificationBadge() {
    const badge = document.getElementById('notificationBadge');
    if (!badge) return;
    
    const unread = notifications.filter(n => !n.read).length;
    if (unread > 0) {
        badge.textContent = unread;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

function clearNotifications() {
    notifications = [];
    saveNotifications();
    renderNotifications();
    updateNotificationBadge();
    closeModal('notificationModal');
    showToast('Alle Benachrichtigungen gelöscht');
}

function saveNotifications() {
    localStorage.setItem('kmi_notifications', JSON.stringify(notifications));
}

function addNotification(type, icon, iconClass, title, text) {
    const notification = {
        id: Date.now(),
        type,
        icon,
        iconClass,
        title,
        text,
        time: Date.now(),
        read: false
    };
    
    notifications.unshift(notification);
    if (notifications.length > 20) notifications.pop();
    
    saveNotifications();
    renderNotifications();
    updateNotificationBadge();
    
    // Toast anzeigen
    showToast(`🔔 ${title}`);
}

// ==================== AUTO-REFRESH ====================
let previousFreeTables = {};

function autoRefreshRestaurants() {
    // Speichere vorherige Werte
    APP_DATA.restaurants.forEach(r => {
        if (previousFreeTables[r.id] === undefined) {
            previousFreeTables[r.id] = r.freeTables;
        }
    });
    
    // Simuliere Updates (in Produktion: API-Call)
    APP_DATA.restaurants.forEach(r => {
        const change = Math.floor(Math.random() * 3) - 1;
        const newTables = Math.max(0, Math.min(r.totalTables, r.freeTables + change));
        
        // Prüfe ob Favorit wieder frei wurde
        if (previousFreeTables[r.id] === 0 && newTables > 0) {
            if (APP_DATA.favorites.includes(r.id)) {
                addNotification(
                    'table',
                    'table',
                    'green',
                    'Tisch frei bei Favorit!',
                    `${r.name} hat wieder ${newTables} ${newTables === 1 ? 'Tisch' : 'Tische'} frei!`
                );
            }
        }
        
        previousFreeTables[r.id] = newTables;
        r.freeTables = newTables;
    });
    
    // UI aktualisieren
    renderRestaurants();
    updateMapMarkers();
}

// ==================== PROFILE / AUTH ====================
let currentUser = null;

function initProfile() {
    // Gespeicherten User laden
    const saved = localStorage.getItem('kmi_user');
    if (saved) {
        try {
            currentUser = JSON.parse(saved);
            updateProfileUI();
        } catch (e) {
            currentUser = null;
        }
    }
    renderProfileContent();
}

function renderProfileContent() {
    const container = document.getElementById('profileContent');
    if (!container) return;
    
    if (currentUser) {
        // Eingeloggt
        container.innerHTML = `
            <div style="text-align: center; padding: 10px 0 20px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 32px; color: white;">
                    ${currentUser.avatar || currentUser.name.charAt(0).toUpperCase()}
                </div>
                <h3 style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${currentUser.name}</h3>
                <p style="font-size: 14px; color: var(--text-secondary);">${currentUser.email}</p>
            </div>
            
            <div style="border-top: 1px solid var(--border-color); padding-top: 20px;">
                <div onclick="showMyReservations()" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer; margin-bottom: 10px;">
                    <div style="width: 40px; height: 40px; background: rgba(26, 95, 74, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" width="20" height="20">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary);">Meine Reservierungen</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${currentUser.reservations || 0} Buchungen</div>
                    </div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" width="20" height="20">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </div>
                
                <div onclick="showSection('favorites')" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer; margin-bottom: 10px;">
                    <div style="width: 40px; height: 40px; background: rgba(255, 59, 48, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#ff3b30" stroke-width="2" width="20" height="20">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary);">Meine Favoriten</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${APP_DATA.favorites.length} gespeichert</div>
                    </div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" width="20" height="20">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </div>
                
                <div onclick="openModal('themeModal'); closeModal('profileModal');" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer; margin-bottom: 20px;">
                    <div style="width: 40px; height: 40px; background: rgba(255, 149, 0, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#ff9500" stroke-width="2" width="20" height="20">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary);">Design</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Dark / Light Mode</div>
                    </div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" width="20" height="20">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </div>
            </div>
            
            <button onclick="logout()" style="width: 100%; padding: 14px; background: var(--bg-secondary); border: none; border-radius: 12px; font-size: 15px; font-weight: 600; color: var(--danger); cursor: pointer;">
                Abmelden
            </button>
        `;
    } else {
        // Nicht eingeloggt
        container.innerHTML = `
            <div style="text-align: center; padding: 20px 0;">
                <div style="width: 80px; height: 80px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="1.5" width="40" height="40">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </div>
                <h3 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">Noch nicht angemeldet</h3>
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px;">Melde dich an um deine Favoriten zu speichern und Reservierungen zu verwalten.</p>
                
                <button onclick="closeModal('profileModal'); openModal('loginModal');" class="btn btn-primary" style="margin-bottom: 16px;">
                    Jetzt anmelden
                </button>
                
                <p style="font-size: 13px; color: var(--text-secondary);">Du kannst die App auch ohne Anmeldung nutzen.</p>
            </div>
            
            <div style="border-top: 1px solid var(--border-color); padding-top: 20px; margin-top: 10px;">
                <div onclick="showSection('favorites'); closeModal('profileModal');" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer; margin-bottom: 10px;">
                    <div style="width: 40px; height: 40px; background: rgba(255, 59, 48, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#ff3b30" stroke-width="2" width="20" height="20">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary);">Meine Favoriten</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${APP_DATA.favorites.length} gespeichert (lokal)</div>
                    </div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" width="20" height="20">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </div>
                
                <div onclick="openModal('themeModal'); closeModal('profileModal');" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer;">
                    <div style="width: 40px; height: 40px; background: rgba(255, 149, 0, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#ff9500" stroke-width="2" width="20" height="20">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary);">Design</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Dark / Light Mode</div>
                    </div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" width="20" height="20">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </div>
            </div>
        `;
    }
}

function updateProfileUI() {
    const profileBtn = document.getElementById('profileBtn');
    if (profileBtn && currentUser) {
        profileBtn.style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%)';
        profileBtn.innerHTML = `<span style="color: white; font-weight: 700; font-size: 16px;">${currentUser.name.charAt(0).toUpperCase()}</span>`;
    }
}

// Supabase Client für Auth
let supabaseClient = null;

function initSupabaseAuth() {
    // Nutze den global initialisierten Client
    if (sb || window.sb) {
        supabaseClient = sb || window.sb;
        window.supabaseDB = supabaseClient;
        window.supabaseClient = supabaseClient;
        window.supabaseReady = true;
        console.log('[OK] Supabase Client verbunden');
        
        // Auth State Listener
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth Event:', event, session ? 'mit Session' : 'ohne Session');
            if (event === 'SIGNED_IN' && session?.user) {
                handleGoogleLoginSuccess(session.user);
            } else if (event === 'SIGNED_OUT') {
                handleLogout();
            } else if (event === 'TOKEN_REFRESHED') {
                console.log('[OK] Token aktualisiert');
            }
        });
        
        // Check if returning from OAuth redirect
        handleOAuthRedirect();
        
        // Check if already logged in
        checkExistingSession();
        
        // Test-Verbindung
        testSupabaseConnection();
    } else {
        console.log('[!] Supabase Library nicht geladen - Offline Modus');
        window.supabaseReady = false;
    }
}

// Hilfsfunktion um Supabase Client zu bekommen
function getSupabase() {
    if (sb) return sb;
    if (window.sb) return window.sb;
    if (window.supabaseDB) return window.supabaseDB;
    
    // Fallback: Neu erstellen
    var supabaseLib = window.supabase || window.Supabase;
    if (supabaseLib && typeof supabaseLib.createClient === 'function') {
        sb = supabaseLib.createClient(SUPA_URL, SUPA_KEY);
        window.sb = sb;
        return sb;
    }
    return null;
}

// Test ob Supabase erreichbar ist
async function testSupabaseConnection() {
    try {
        const sb = getSupabase();
        if (!sb) return;
        
        const { data, error } = await sb
            .from('restaurants')
            .select('id')
            .limit(1);
        
        if (error) {
            console.log('[!] Supabase Verbindung fehlgeschlagen:', error.message);
        } else {
            console.log('[OK] Supabase Verbindung erfolgreich - Online');
        }
    } catch (e) {
        console.log('[!] Supabase nicht erreichbar:', e.message);
    }
}

// Handle OAuth Redirect (nach Google Login)
async function handleOAuthRedirect() {
    // Prüfe ob wir von OAuth zurückkommen (URL enthält access_token oder code)
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const queryParams = new URLSearchParams(window.location.search);
    
    if (hashParams.get('access_token') || queryParams.get('code')) {
        console.log('[OK] OAuth Redirect erkannt, verarbeite...');
        
        try {
            const { data, error } = await supabaseClient.auth.getSession();
            
            if (error) {
                console.error('OAuth Session Fehler:', error);
                showToast('Anmeldung fehlgeschlagen', 'error');
            } else if (data?.session?.user) {
                console.log('[OK] OAuth Session erfolgreich');
                // URL aufräumen (Hash entfernen)
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        } catch (e) {
            console.error('OAuth Redirect Fehler:', e);
        }
    }
}

async function checkExistingSession() {
    try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session?.user) {
            console.log('[OK] Bestehende Session gefunden');
            handleGoogleLoginSuccess(session.user);
        }
    } catch (e) {
        console.log('Keine bestehende Session');
    }
}

async function loginWithGoogle() {
    if (!supabaseClient) {
        showToast('Verbindung wird hergestellt...', 'default');
        initSupabaseAuth();
        setTimeout(loginWithGoogle, 500);
        return;
    }
    
    try {
        closeModal('loginModal');
        showToast('Weiterleitung zu Google...', 'default');
        
        const { data, error } = await supabaseClient.auth.signInWithOAuth({
            provider: 'google',
            options: {
                redirectTo: window.location.origin + window.location.pathname
            }
        });
        
        if (error) {
            console.error('Google Login Fehler:', error);
            showToast('Login fehlgeschlagen: ' + error.message, 'error');
        }
    } catch (e) {
        console.error('Google Login Fehler:', e);
        showToast('Login fehlgeschlagen', 'error');
    }
}

function handleGoogleLoginSuccess(user) {
    console.log('Google User:', user);
    
    const userEmail = user.email;
    
    // Prüfen ob User ein Gastronom ist (Email in customers Tabelle)
    checkIfGastronom(userEmail, user);
}

async function checkIfGastronom(email, googleUser) {
    try {
        // Prüfe ob Email in der Kunden-Tabelle existiert
        const response = await fetch(`${SUPABASE_URL}/rest/v1/customers?email=eq.${encodeURIComponent(email)}&is_active=eq.true`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        const customers = await response.json();
        
        if (customers && customers.length > 0) {
            // GASTRONOM gefunden!
            const customer = customers[0];
            console.log('[OK] Gastronom erkannt:', customer.name);
            
            currentUser = {
                id: googleUser.id,
                name: customer.name || googleUser.user_metadata?.full_name,
                email: email,
                avatar: googleUser.user_metadata?.avatar_url || null,
                role: 'gastronom',
                customerId: customer.id,
                restaurantId: customer.restaurant_id
            };
            
            localStorage.setItem('kmi_user', JSON.stringify(currentUser));
            localStorage.setItem('kmi_gastro_logged_in', 'true');
            
            closeModal('loginModal');
            
            // Gastro-Dashboard öffnen
            showGastroDashboard(customer);
            
        } else {
            // Normaler Gast
            console.log('[OK] Normaler Gast');
            
            currentUser = {
                id: googleUser.id,
                name: googleUser.user_metadata?.full_name || email.split('@')[0] || 'Gast',
                email: email,
                avatar: googleUser.user_metadata?.avatar_url || null,
                role: 'guest',
                reservations: 0,
                createdAt: googleUser.created_at
            };
            
            localStorage.setItem('kmi_user', JSON.stringify(currentUser));
            
            closeModal('loginModal');
            renderProfileContent();
            updateProfileUI();
            showToast(`Willkommen ${currentUser.name}!`, 'success');
            
            addNotification('login', '', 'icon-green', 'Angemeldet', `Willkommen zurück, ${currentUser.name}!`);
        }
        
    } catch (e) {
        console.error('Gastronom-Check Fehler:', e);
        // Fallback: als Gast anmelden
        currentUser = {
            id: googleUser.id,
            name: googleUser.user_metadata?.full_name || googleUser.email?.split('@')[0] || 'Gast',
            email: googleUser.email,
            avatar: googleUser.user_metadata?.avatar_url || null,
            role: 'guest'
        };
        localStorage.setItem('kmi_user', JSON.stringify(currentUser));
        closeModal('loginModal');
        renderProfileContent();
        updateProfileUI();
        showToast(`Willkommen ${currentUser.name}!`, 'success');
    }
}

// Gastro-Dashboard anzeigen
async function showGastroDashboard(customer) {
    // Restaurant-Daten laden
    let restaurant = APP_DATA.restaurants.find(r => r.id === customer.restaurant_id);
    
    if (!restaurant && customer.restaurant_id) {
        // Aus Supabase laden
        try {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/restaurants?id=eq.${customer.restaurant_id}`, {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY
                }
            });
            const data = await response.json();
            if (data && data[0]) {
                restaurant = data[0];
            }
        } catch (e) {
            console.error('Restaurant laden Fehler:', e);
        }
    }
    
    // Gastro-View aktivieren
    document.getElementById('guestView').classList.add('hidden');
    document.getElementById('dashboardView').classList.remove('active');
    
    // Gastro-Dashboard erstellen/anzeigen
    let gastroView = document.getElementById('gastroView');
    if (!gastroView) {
        gastroView = document.createElement('div');
        gastroView.id = 'gastroView';
        gastroView.className = 'gastro-view';
        document.querySelector('.app-container').appendChild(gastroView);
    }
    
    gastroView.innerHTML = renderGastroDashboardHTML(customer, restaurant);
    gastroView.classList.add('active');
    
    // Reservierungen für dieses Restaurant laden
    loadGastroReservations(customer.restaurant_id);
    
    // Tischplan initialisieren
    setTimeout(tpInit, 500);
    
    showToast(`Willkommen ${customer.name}!`, 'success');
}

function renderGastroDashboardHTML(customer, restaurant) {
    const restName = restaurant?.name || 'Mein Restaurant';
    
    return `
        <div class="gastro-dashboard" style="padding: 20px; padding-bottom: 100px;">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h1 style="font-size: 24px; font-weight: 700; color: var(--dark);">Moin, ${customer.name}!</h1>
                    <p style="color: var(--slate); margin-top: 4px;">${restName}</p>
                </div>
                <button onclick="gastroLogout()" style="padding: 10px 16px; background: var(--bg-secondary); border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; color: var(--slate);">
                    Abmelden
                </button>
            </div>
            
            <!-- Quick Stats -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px;">
                <div style="background: var(--bg-card); padding: 16px; border-radius: 16px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                    <div style="font-size: 28px; font-weight: 700; color: var(--primary);" id="gastroTodayRes">0</div>
                    <div style="font-size: 12px; color: var(--slate);">Heute</div>
                </div>
                <div style="background: var(--bg-card); padding: 16px; border-radius: 16px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                    <div style="font-size: 28px; font-weight: 700; color: var(--success);" id="gastroFreeTables">${restaurant?.free_tables || 0}</div>
                    <div style="font-size: 12px; color: var(--slate);">Freie Tische</div>
                </div>
                <div style="background: var(--bg-card); padding: 16px; border-radius: 16px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                    <div style="font-size: 28px; font-weight: 700; color: var(--warning);" id="gastroWeekRes">0</div>
                    <div style="font-size: 12px; color: var(--slate);">Diese Woche</div>
                </div>
            </div>
            
            <!-- PROFI TISCHPLAN -->
            <div class="tischplan-box">
                <div class="tischplan-header">
                    <h3>Tischplan</h3>
                    <button class="tischplan-btn-add" onclick="tpAddTable()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Tisch hinzufügen
                    </button>
                </div>
                <div class="tischplan-filters">
                    <button class="tischplan-filter active" data-filter="all" onclick="tpFilter('all')">Alle Tische</button>
                    <button class="tischplan-filter" data-filter="available" onclick="tpFilter('available')">Verfügbar</button>
                    <button class="tischplan-filter" data-filter="reserved" onclick="tpFilter('reserved')">Reserviert</button>
                    <button class="tischplan-filter" data-filter="billed" onclick="tpFilter('billed')">Besetzt</button>
                </div>
                <div class="tischplan-legend">
                    <div class="tischplan-legend-item"><div class="tischplan-legend-dot available"></div> Verfügbar</div>
                    <div class="tischplan-legend-item"><div class="tischplan-legend-dot reserved"></div> Reserviert</div>
                    <div class="tischplan-legend-item"><div class="tischplan-legend-dot billed"></div> Besetzt</div>
                    <div class="tischplan-legend-item"><div class="tischplan-legend-dot soon"></div> Bald frei</div>
                </div>
                <div class="tischplan-canvas" id="tischplanCanvas">
                    <!-- Statische Tische als Fallback -->
                    <div class="room-label kitchen" style="left:20px;top:20px;">🍳 Küche</div>
                    <div class="room-label bar" style="right:20px;top:45%;padding:15px;">🍺 Bar</div>
                    <div class="room-label" style="left:50%;bottom:10px;transform:translateX(-50%);">🚪 Eingang</div>
                    
                    <div class="tisch available" style="left:18%;top:20%;" onclick="tpOpen(1)">
                        <div class="tisch-body round"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-01</div>
                        <div class="tisch-label">4 Plätze</div>
                    </div>
                    
                    <div class="tisch available" style="left:40%;top:20%;" onclick="tpOpen(2)">
                        <div class="tisch-body"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-02</div>
                        <div class="tisch-label">4 Plätze</div>
                    </div>
                    
                    <div class="tisch billed" style="left:62%;top:18%;" onclick="tpOpen(3)">
                        <div class="tisch-body large"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-03</div>
                        <div class="tisch-badge">€</div>
                        <div class="tisch-label"><span class="amount">87€</span> · 45m</div>
                    </div>
                    
                    <div class="tisch reserved" style="left:18%;top:50%;" onclick="tpOpen(4)">
                        <div class="tisch-body"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-04</div>
                        <div class="tisch-badge">⏰</div>
                        <div class="tisch-label">19:30 Uhr</div>
                    </div>
                    
                    <div class="tisch available" style="left:40%;top:50%;" onclick="tpOpen(5)">
                        <div class="tisch-body round"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-05</div>
                        <div class="tisch-label">2 Plätze</div>
                    </div>
                    
                    <div class="tisch soon" style="left:62%;top:48%;" onclick="tpOpen(6)">
                        <div class="tisch-body large"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-06</div>
                        <div class="tisch-badge">€</div>
                        <div class="tisch-label"><span class="amount">156€</span> · 72m</div>
                    </div>
                    
                    <div class="tisch available" style="left:18%;top:78%;" onclick="tpOpen(7)">
                        <div class="tisch-body"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-07</div>
                        <div class="tisch-label">4 Plätze</div>
                    </div>
                    
                    <div class="tisch billed" style="left:40%;top:78%;" onclick="tpOpen(8)">
                        <div class="tisch-body"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-08</div>
                        <div class="tisch-badge">€</div>
                        <div class="tisch-label"><span class="amount">43€</span> · 28m</div>
                    </div>
                </div>
                <div class="tischplan-stats">
                    <div class="tischplan-stat"><div class="tischplan-stat-num" id="tpAvailable" style="color:#3b82f6">0</div><div class="tischplan-stat-label">Verfügbar</div></div>
                    <div class="tischplan-stat"><div class="tischplan-stat-num" id="tpReserved" style="color:#ef4444">0</div><div class="tischplan-stat-label">Reserviert</div></div>
                    <div class="tischplan-stat"><div class="tischplan-stat-num" id="tpBilled" style="color:#22c55e">0</div><div class="tischplan-stat-label">Besetzt</div></div>
                    <div class="tischplan-stat"><div class="tischplan-stat-num" id="tpRevenue" style="color:var(--primary)">0€</div><div class="tischplan-stat-label">Umsatz</div></div>
                </div>
            </div>
            
            <!-- Heutiges Angebot -->
            <div style="background: var(--bg-card); padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--dark);">Tagesangebot</h3>
                <input type="text" id="gastroOfferTitle" placeholder="z.B. Fischplatte für 2 Personen" style="width: 100%; padding: 14px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 15px; margin-bottom: 12px; box-sizing: border-box;">
                <div style="display: flex; gap: 12px;">
                    <input type="text" id="gastroOfferDiscount" placeholder="z.B. -20%" style="flex: 1; padding: 14px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 15px;">
                    <button onclick="saveGastroOffer()" style="padding: 14px 24px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer;">Speichern</button>
                </div>
            </div>
            
            <!-- Reservierungen -->
            <div style="background: var(--bg-card); padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--dark);">Heutige Reservierungen</h3>
                <div id="gastroReservationsList">
                    <p style="color: var(--slate); text-align: center; padding: 20px;">Lade Reservierungen...</p>
                </div>
            </div>
        </div>
    `;
}

// Reservierungen für Gastronom laden
async function loadGastroReservations(restaurantId) {
    if (!restaurantId) return;
    
    const today = new Date().toISOString().split('T')[0];
    
    try {
        // Reservierungen laden mit neuen Spaltennamen
        const sb = getSupabase();
        if (!sb) {
            document.getElementById('gastroReservationsList').innerHTML = '<p style="color: var(--slate); text-align: center; padding: 20px;">Offline - keine Verbindung</p>';
            return;
        }
        
        const { data: reservations, error } = await sb
            .from('reservations')
            .select('*')
            .eq('restaurant_id', restaurantId)
            .eq('reservation_date', today)
            .in('status', ['pending', 'confirmed', 'reminded', 'seated'])
            .order('reservation_time', { ascending: true });
        
        if (error) throw error;
        
        const container = document.getElementById('gastroReservationsList');
        if (!container) return;
        
        if (!reservations || reservations.length === 0) {
            container.innerHTML = '<p style="color: var(--slate); text-align: center; padding: 20px;">Keine Reservierungen für heute</p>';
            document.getElementById('gastroTodayRes').textContent = '0';
            return;
        }
        
        // Stats aktualisieren
        document.getElementById('gastroTodayRes').textContent = reservations.length;
        
        // Reservierungen rendern
        container.innerHTML = reservations.map(r => {
            const time = r.reservation_time ? r.reservation_time.substring(0,5) : '19:00';
            const statusColors = {
                'pending': { bg: 'rgba(245,158,11,0.15)', color: '#f59e0b', text: 'Ausstehend' },
                'confirmed': { bg: 'rgba(59,130,246,0.15)', color: '#3b82f6', text: 'Bestätigt' },
                'reminded': { bg: 'rgba(139,92,246,0.15)', color: '#8b5cf6', text: 'Erinnert' },
                'seated': { bg: 'rgba(34,197,94,0.15)', color: '#22c55e', text: 'Sitzt' }
            };
            const statusStyle = statusColors[r.status] || statusColors.pending;
            
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 10px; border-left: 4px solid ${statusStyle.color};">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--dark); display: flex; align-items: center; gap: 8px;">
                            ${r.guest_name || 'Gast'}
                            <span style="font-size: 11px; padding: 2px 8px; background: ${statusStyle.bg}; color: ${statusStyle.color}; border-radius: 6px;">${statusStyle.text}</span>
                        </div>
                        <div style="font-size: 13px; color: var(--slate); margin-top: 4px;">
                            👥 ${r.party_size || 2} Personen • 🕐 ${time} Uhr
                            ${r.table_id ? ' • 🪑 Tisch zugewiesen' : ''}
                        </div>
                        ${r.special_requests ? `<div style="font-size: 12px; color: var(--slate); margin-top: 4px;">📝 ${r.special_requests}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        ${r.status === 'pending' ? `
                            <button onclick="updateReservationStatus('${r.id}', 'confirmed')" style="padding: 8px 12px; background: rgba(34,197,94,0.15); color: #22c55e; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">✓ Bestätigen</button>
                        ` : ''}
                        ${r.status === 'confirmed' || r.status === 'reminded' ? `
                            <button onclick="updateReservationStatus('${r.id}', 'seated')" style="padding: 8px 12px; background: rgba(59,130,246,0.15); color: #3b82f6; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">🪑 Sitzt</button>
                        ` : ''}
                        ${r.status === 'seated' ? `
                            <button onclick="updateReservationStatus('${r.id}', 'finished')" style="padding: 8px 12px; background: rgba(34,197,94,0.15); color: #22c55e; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">✓ Fertig</button>
                        ` : ''}
                        <button onclick="updateReservationStatus('${r.id}', 'cancelled')" style="padding: 8px 12px; background: rgba(239,68,68,0.1); color: #ef4444; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">✕</button>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (e) {
        console.error('Reservierungen laden Fehler:', e);
        document.getElementById('gastroReservationsList').innerHTML = '<p style="color: var(--slate); text-align: center; padding: 20px;">Fehler beim Laden</p>';
    }
    
    // Auch Tische laden
    loadGastroTables(restaurantId);
}

// Reservierungsstatus aktualisieren
async function updateReservationStatus(reservationId, newStatus) {
    try {
        const { data, error } = await getSupabase().rpc('update_reservation_status', {
            p_reservation_id: reservationId,
            p_new_status: newStatus
        });
        
        if (error) throw error;
        
        if (data?.success) {
            showToast(`Status: ${newStatus}`, 'success');
            // Reload
            const customer = JSON.parse(localStorage.getItem('gastro_customer') || '{}');
            if (customer.restaurant_id) {
                loadGastroReservations(customer.restaurant_id);
            }
        } else {
            showToast(data?.error || 'Fehler', 'error');
        }
    } catch (e) {
        console.error('Status-Update Fehler:', e);
        showToast('Fehler beim Aktualisieren', 'error');
    }
}

// Tische aus Datenbank laden
async function loadGastroTables(restaurantId) {
    try {
        const today = new Date().toISOString().split('T')[0];
        
        const { data, error } = await getSupabase().rpc('get_live_table_status', {
            p_restaurant_id: restaurantId,
            p_date: today
        });
        
        if (error) throw error;
        
        if (data && data.length > 0) {
            // Konvertiere DB-Daten zu tpTables Format
            tpTables = data.map((t, idx) => {
                let status = 'available';
                if (t.current_reservation) status = 'billed';
                else if (t.next_reservation && isUpcomingSoon(t.next_reservation.time)) status = 'reserved';
                else if (t.current_status === 'blocked') status = 'blocked';
                
                return {
                    id: t.table_id,
                    num: t.table_number,
                    name: t.table_name,
                    seats: t.max_capacity,
                    area: t.area,
                    status: status,
                    shape: t.max_capacity > 6 ? 'large' : (t.max_capacity <= 2 ? 'round' : 'square'),
                    x: 15 + (idx % 3) * 28,
                    y: 18 + Math.floor(idx / 3) * 30,
                    currentRes: t.current_reservation,
                    nextRes: t.next_reservation,
                    upcoming: t.upcoming_count
                };
            });
            
            // Stats aktualisieren
            const available = tpTables.filter(t => t.status === 'available').length;
            const reserved = tpTables.filter(t => t.status === 'reserved').length;
            const billed = tpTables.filter(t => t.status === 'billed').length;
            
            document.getElementById('gastroFreeTables').textContent = available;
            
            tpRender();
            tpUpdateStats();
        }
    } catch (e) {
        console.error('Tische laden Fehler:', e);
    }
}

function isUpcomingSoon(timeStr) {
    if (!timeStr) return false;
    const now = new Date();
    const [h, m] = timeStr.split(':');
    const resTime = new Date(now);
    resTime.setHours(parseInt(h), parseInt(m), 0);
    const diff = (resTime - now) / 1000 / 60;
    return diff <= 30 && diff >= -15;
}

// ===== PROFI TISCHPLAN =====
var tpTables = [];
var tpFilter_current = 'all';

function tpInit() {
    console.log('tpInit gestartet');
    
    // Tische initialisieren
    if (tpTables.length === 0) {
        tpTables = [
            {id:1, num:'T-01', seats:4, status:'available', shape:'round', x:15, y:18},
            {id:2, num:'T-02', seats:4, status:'available', shape:'square', x:38, y:18},
            {id:3, num:'T-03', seats:6, status:'billed', shape:'large', x:62, y:15, amount:87, time:45},
            {id:4, num:'T-04', seats:4, status:'reserved', shape:'square', x:15, y:48},
            {id:5, num:'T-05', seats:2, status:'available', shape:'round', x:38, y:48},
            {id:6, num:'T-06', seats:8, status:'soon', shape:'large', x:62, y:45, amount:156, time:72},
            {id:7, num:'T-07', seats:4, status:'available', shape:'square', x:15, y:78},
            {id:8, num:'T-08', seats:4, status:'billed', shape:'square', x:38, y:78, amount:43, time:28}
        ];
    }
    
    var canvas = document.getElementById('tischplanCanvas');
    console.log('Canvas:', canvas);
    
    if (canvas) {
        // Direkt Content setzen
        tpRender();
        tpUpdateStats();
        console.log('Tischplan gerendert!');
    } else {
        console.log('Canvas nicht gefunden, retry...');
        setTimeout(tpInit, 500);
    }
}

function tpRender() {
    var c = document.getElementById('tischplanCanvas');
    if (!c) { console.log('tpRender: Canvas nicht da'); return; }
    
    var list = tpFilter_current === 'all' ? tpTables : tpTables.filter(function(t){ return t.status === tpFilter_current; });
    console.log('Rendering', list.length, 'Tische');
    
    var h = '';
    
    // Wände
    h += '<div class="room-wall" style="left:0;top:0;width:100%;height:12px;"></div>';
    h += '<div class="room-wall" style="left:0;top:0;width:12px;height:100%;"></div>';
    h += '<div class="room-wall" style="right:0;top:0;width:12px;height:100%;"></div>';
    h += '<div class="room-wall" style="left:0;bottom:0;width:35%;height:12px;"></div>';
    h += '<div class="room-wall" style="right:0;bottom:0;width:35%;height:12px;"></div>';
    
    // Eingang
    h += '<div class="room-label" style="left:50%;bottom:8px;transform:translateX(-50%);">';
    h += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"/></svg>';
    h += 'Eingang</div>';
    
    // Küche
    h += '<div class="room-label kitchen" style="left:20px;top:20px;">';
    h += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>';
    h += 'Küche</div>';
    
    // Bar
    h += '<div class="room-label bar" style="right:20px;top:50%;transform:translateY(-50%);flex-direction:column;padding:12px 16px;">';
    h += '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 22h8M12 11v11M17 2c-.7 0-1.4.3-2 1-.5-.7-1.3-1-2-1-1.2 0-2.6.7-3 3h10c-.4-2.3-1.8-3-3-3z"/><path d="M7 6c-.7 0-1.4.3-2 1-.5-.7-1.3-1-2-1-1.2 0-2.6.7-3 3h10c-.4-2.3-1.8-3-3-3z"/></svg>';
    h += '<span style="margin-top:4px;">Bar</span></div>';
    
    // Tische rendern
    if (list.length === 0) {
        h += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--slate);font-size:15px;font-family:DM Sans,sans-serif;">Keine Tische in dieser Ansicht</div>';
    } else {
        for (var i = 0; i < list.length; i++) {
            var t = list[i];
            var px = t.x || (15 + (i % 3) * 25);
            var py = t.y || (18 + Math.floor(i / 3) * 28);
            
            h += '<div class="tisch ' + t.status + '" style="left:' + px + '%;top:' + py + '%;" onclick="tpOpen(' + t.id + ')">';
            h += '<div class="tisch-body ' + (t.shape || 'square') + '">';
            
            // Stühle
            h += '<div class="tisch-chairs">';
            h += '<div class="tisch-chair top"></div>';
            h += '<div class="tisch-chair bottom"></div>';
            h += '<div class="tisch-chair left"></div>';
            h += '<div class="tisch-chair right"></div>';
            h += '</div>';
            
            h += t.num;
            h += '</div>';
            
            // Badge
            if (t.status === 'reserved') {
                h += '<div class="tisch-badge">⏰</div>';
            } else if (t.status === 'billed' || t.status === 'soon') {
                h += '<div class="tisch-badge">€</div>';
            }
            
            // Label
            if (t.status === 'available') {
                h += '<div class="tisch-label">' + t.seats + ' Plätze</div>';
            } else if (t.amount) {
                h += '<div class="tisch-label"><span class="amount">' + t.amount + '€</span> · ' + t.time + 'm</div>';
            } else if (t.status === 'reserved') {
                h += '<div class="tisch-label">Reserviert</div>';
            }
            
            h += '</div>';
        }
    }
    
    c.innerHTML = h;
}

function tpFilter(f) {
    tpFilter_current = f;
    document.querySelectorAll('.tischplan-filter').forEach(function(b){ b.classList.remove('active'); if(b.dataset.filter===f) b.classList.add('active'); });
    tpRender();
}

function tpUpdateStats() {
    var av=0, res=0, bil=0, rev=0;
    tpTables.forEach(function(t){ if(t.status==='available')av++; if(t.status==='reserved')res++; if(t.status==='billed'||t.status==='soon')bil++; if(t.amount)rev+=t.amount; });
    var e1=document.getElementById('tpAvailable'), e2=document.getElementById('tpReserved'), e3=document.getElementById('tpBilled'), e4=document.getElementById('tpRevenue');
    if(e1)e1.textContent=av; if(e2)e2.textContent=res; if(e3)e3.textContent=bil; if(e4)e4.textContent=rev+'€';
    var ft=document.getElementById('gastroFreeTables'); if(ft)ft.textContent=av;
}

function tpOpen(id) {
    var t = tpTables.find(function(x){return x.id===id;});
    if (!t) return;
    var colors = {'available':'#3b82f6','reserved':'#ef4444','billed':'#22c55e','soon':'#f59e0b'};
    var h = '<div id="tpModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px" onclick="if(event.target===this)this.remove()">';
    h += '<div style="background:var(--bg-card);border-radius:20px;width:100%;max-width:340px;overflow:hidden">';
    h += '<div style="padding:24px;text-align:center;background:'+(colors[t.status]||'#3b82f6')+';color:white"><div style="font-size:36px;font-weight:700">'+t.num+'</div><div style="opacity:0.9">'+t.seats+' Plätze</div></div>';
    h += '<div style="padding:20px">';
    if (t.status === 'available') {
        h += '<button onclick="tpSet('+id+',\'billed\')" style="width:100%;padding:14px;background:#22c55e;color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;margin-bottom:10px">🍽️ Gäste setzen</button>';
        h += '<button onclick="tpSet('+id+',\'reserved\')" style="width:100%;padding:14px;background:#ef4444;color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer">📅 Reservieren</button>';
    } else if (t.status === 'billed' || t.status === 'soon') {
        h += '<div style="background:var(--bg-secondary);padding:14px;border-radius:12px;margin-bottom:14px"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Umsatz</span><b style="color:#22c55e">'+(t.amount||0)+'€</b></div><div style="display:flex;justify-content:space-between"><span>Zeit</span><b>'+(t.time||0)+' Min</b></div></div>';
        h += '<button onclick="tpAddAmount('+id+')" style="width:100%;padding:14px;background:#ff6b35;color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;margin-bottom:10px">💰 Betrag +</button>';
        h += '<button onclick="tpSet('+id+',\'available\')" style="width:100%;padding:14px;background:#3b82f6;color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer">✓ Freigeben</button>';
    } else {
        h += '<button onclick="tpSet('+id+',\'billed\')" style="width:100%;padding:14px;background:#22c55e;color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;margin-bottom:10px">🍽️ Gäste da</button>';
        h += '<button onclick="tpSet('+id+',\'available\')" style="width:100%;padding:14px;background:var(--bg-secondary);color:var(--dark);border:none;border-radius:12px;font-weight:600;cursor:pointer">✗ Stornieren</button>';
    }
    h += '</div><div style="padding:0 20px 20px"><button onclick="document.getElementById(\'tpModal\').remove()" style="width:100%;padding:12px;background:var(--bg-secondary);color:var(--slate);border:none;border-radius:10px;cursor:pointer">Schließen</button></div></div></div>';
    document.body.insertAdjacentHTML('beforeend', h);
}

function tpSet(id, status) {
    var t = tpTables.find(function(x){return x.id===id;});
    if(t){ t.status=status; if(status==='billed'||status==='available'){t.time=0;t.amount=0;} }
    var m=document.getElementById('tpModal'); if(m)m.remove();
    tpRender(); tpUpdateStats(); showToast('Tisch aktualisiert','success');
}

function tpAddAmount(id) {
    var val = prompt('Betrag (€):');
    if(!val) return;
    var t = tpTables.find(function(x){return x.id===id;});
    if(t) t.amount = (t.amount||0) + (parseFloat(val)||0);
    var m=document.getElementById('tpModal'); if(m)m.remove();
    tpRender(); tpUpdateStats(); showToast(val+'€ hinzugefügt','success');
}

function tpAddTable() {
    var num = prompt('Tischnummer (z.B. T-14):');
    if(!num) return;
    var seats = parseInt(prompt('Plätze:','4')) || 4;
    var newId = Math.max.apply(null,tpTables.map(function(t){return t.id;}))+1;
    tpTables.push({id:newId, num:num, seats:seats, status:'available', shape:'square'});
    tpRender(); tpUpdateStats(); showToast('Tisch '+num+' hinzugefügt','success');
}

// ===== ADMIN TISCHPLAN =====
// ==================== NEUER TISCHPLAN EDITOR ====================

var floorplanTables = [];
let selectedTable = null;
let isDragging = false;
let dragOffset = { x: 0, y: 0 };
let currentTischplanRestaurant = null;
let tableIdCounter = 1;

async function loadAdminTischplan() {
    const select = document.getElementById('tischplanRestaurantSelect');
    if (!select) return;
    
    // Restaurants laden
    select.innerHTML = '<option value="">Restaurant auswählen...</option>';
    
    if (APP_DATA && APP_DATA.restaurants) {
        APP_DATA.restaurants.forEach(r => {
            select.innerHTML += `<option value="${r.id}">${r.name} (${r.city || 'Ostfriesland'})</option>`;
        });
    }
}

function loadTischplanForRestaurant(restaurantId) {
    const editor = document.getElementById('tischplanEditor');
    const emptyState = document.getElementById('tischplanEmptyState');
    
    if (!restaurantId) {
        if (editor) editor.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
        return;
    }
    
    if (editor) editor.style.display = 'block';
    if (emptyState) emptyState.style.display = 'none';
    
    currentTischplanRestaurant = restaurantId;
    
    // Demo-Tische laden (später aus Supabase)
    floorplanTables = [
        { id: 1, number: 1, type: 'round-4', seats: 4, status: 'free', x: 50, y: 50 },
        { id: 2, number: 2, type: 'round-4', seats: 4, status: 'reserved', x: 150, y: 50 },
        { id: 3, number: 3, type: 'rect-4', seats: 4, status: 'free', x: 250, y: 50 },
        { id: 4, number: 4, type: 'rect-6', seats: 6, status: 'occupied', x: 50, y: 180 },
        { id: 5, number: 5, type: 'rect-2', seats: 2, status: 'free', x: 200, y: 180 },
        { id: 6, number: 6, type: 'round-6', seats: 6, status: 'free', x: 320, y: 180 },
    ];
    tableIdCounter = 7;
    
    renderFloorplan();
    updateTischplanStats();
}

function renderFloorplan() {
    const canvas = document.getElementById('floorplanCanvas');
    if (!canvas) return;
    
    canvas.innerHTML = '';
    
    floorplanTables.forEach(table => {
        const tableEl = createTableElement(table);
        canvas.appendChild(tableEl);
    });
}

function createTableElement(table) {
    const el = document.createElement('div');
    el.className = `floorplan-table ${table.type.startsWith('round') ? 'round' : 'rect'} status-${table.status}`;
    el.dataset.tableId = table.id;
    
    // Größen je nach Typ
    const sizes = {
        'round-4': { w: 70, h: 70 },
        'round-6': { w: 90, h: 90 },
        'rect-2': { w: 60, h: 50 },
        'rect-4': { w: 80, h: 60 },
        'rect-6': { w: 110, h: 60 },
        'rect-8': { w: 150, h: 60 }
    };
    
    const size = sizes[table.type] || { w: 70, h: 70 };
    
    el.style.cssText = `
        left: ${table.x}px;
        top: ${table.y}px;
        width: ${size.w}px;
        height: ${size.h}px;
    `;
    
    el.innerHTML = `
        <div class="table-number">T${table.number}</div>
        <div class="table-seats">${table.seats} Pl.</div>
    `;
    
    // Drag Events
    el.addEventListener('mousedown', startDrag);
    el.addEventListener('touchstart', startDragTouch, { passive: false });
    
    // Kontextmenü
    el.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showTableContextMenu(table, e.clientX, e.clientY);
    });
    
    // Doppelklick zum Bearbeiten
    el.addEventListener('dblclick', () => {
        showTableContextMenu(table, el.offsetLeft + 50, el.offsetTop + 50);
    });
    
    return el;
}

function startDrag(e) {
    if (e.button !== 0) return; // Nur linke Maustaste
    
    const tableEl = e.target.closest('.floorplan-table');
    if (!tableEl) return;
    
    isDragging = true;
    selectedTable = tableEl;
    tableEl.classList.add('dragging', 'selected');
    
    const rect = tableEl.getBoundingClientRect();
    dragOffset.x = e.clientX - rect.left;
    dragOffset.y = e.clientY - rect.top;
    
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', stopDrag);
    
    hideContextMenu();
}

function startDragTouch(e) {
    const tableEl = e.target.closest('.floorplan-table');
    if (!tableEl) return;
    
    e.preventDefault();
    
    isDragging = true;
    selectedTable = tableEl;
    tableEl.classList.add('dragging', 'selected');
    
    const touch = e.touches[0];
    const rect = tableEl.getBoundingClientRect();
    dragOffset.x = touch.clientX - rect.left;
    dragOffset.y = touch.clientY - rect.top;
    
    document.addEventListener('touchmove', dragTouch, { passive: false });
    document.addEventListener('touchend', stopDragTouch);
}

function drag(e) {
    if (!isDragging || !selectedTable) return;
    
    const canvas = document.getElementById('floorplanCanvas');
    const canvasRect = canvas.getBoundingClientRect();
    
    let x = e.clientX - canvasRect.left - dragOffset.x;
    let y = e.clientY - canvasRect.top - dragOffset.y;
    
    // Grenzen
    x = Math.max(0, Math.min(x, canvasRect.width - selectedTable.offsetWidth));
    y = Math.max(0, Math.min(y, canvasRect.height - selectedTable.offsetHeight));
    
    // Snap to Grid (20px)
    x = Math.round(x / 20) * 20;
    y = Math.round(y / 20) * 20;
    
    selectedTable.style.left = x + 'px';
    selectedTable.style.top = y + 'px';
}

function dragTouch(e) {
    if (!isDragging || !selectedTable) return;
    e.preventDefault();
    
    const touch = e.touches[0];
    const canvas = document.getElementById('floorplanCanvas');
    const canvasRect = canvas.getBoundingClientRect();
    
    let x = touch.clientX - canvasRect.left - dragOffset.x;
    let y = touch.clientY - canvasRect.top - dragOffset.y;
    
    x = Math.max(0, Math.min(x, canvasRect.width - selectedTable.offsetWidth));
    y = Math.max(0, Math.min(y, canvasRect.height - selectedTable.offsetHeight));
    
    x = Math.round(x / 20) * 20;
    y = Math.round(y / 20) * 20;
    
    selectedTable.style.left = x + 'px';
    selectedTable.style.top = y + 'px';
}

function stopDrag() {
    if (selectedTable) {
        selectedTable.classList.remove('dragging');
        
        // Position speichern
        const tableId = parseInt(selectedTable.dataset.tableId);
        const table = floorplanTables.find(t => t.id === tableId);
        if (table) {
            table.x = parseInt(selectedTable.style.left);
            table.y = parseInt(selectedTable.style.top);
        }
    }
    
    isDragging = false;
    document.removeEventListener('mousemove', drag);
    document.removeEventListener('mouseup', stopDrag);
}

function stopDragTouch() {
    stopDrag();
    document.removeEventListener('touchmove', dragTouch);
    document.removeEventListener('touchend', stopDragTouch);
}

function addTableToFloorplan(type) {
    const seats = {
        'round-4': 4, 'round-6': 6,
        'rect-2': 2, 'rect-4': 4, 'rect-6': 6, 'rect-8': 8
    };
    
    const newTable = {
        id: tableIdCounter++,
        number: floorplanTables.length + 1,
        type: type,
        seats: seats[type] || 4,
        status: 'free',
        x: 100 + Math.random() * 200,
        y: 100 + Math.random() * 200
    };
    
    floorplanTables.push(newTable);
    
    const canvas = document.getElementById('floorplanCanvas');
    if (canvas) {
        canvas.appendChild(createTableElement(newTable));
    }
    
    updateTischplanStats();
    showToast(`Tisch ${newTable.number} hinzugefügt`);
}

function showTableContextMenu(table, x, y) {
    hideContextMenu();
    
    const menu = document.createElement('div');
    menu.className = 'table-context-menu';
    menu.id = 'tableContextMenu';
    
    const canvas = document.getElementById('floorplanCanvas');
    const canvasRect = canvas.getBoundingClientRect();
    
    menu.style.left = (x - canvasRect.left) + 'px';
    menu.style.top = (y - canvasRect.top) + 'px';
    
    menu.innerHTML = `
        <button onclick="setTableStatus(${table.id}, 'free')">
            <svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" width="16" height="16"><polyline points="20 6 9 17 4 12"/></svg>
            Frei setzen
        </button>
        <button onclick="setTableStatus(${table.id}, 'reserved')">
            <svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
            Reserviert
        </button>
        <button onclick="setTableStatus(${table.id}, 'occupied')">
            <svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" width="16" height="16"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
            Besetzt
        </button>
        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 4px 0;">
        <button class="delete" onclick="deleteTable(${table.id})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            Löschen
        </button>
    `;
    
    canvas.appendChild(menu);
    
    // Schließen bei Klick außerhalb
    setTimeout(() => {
        document.addEventListener('click', hideContextMenuOnClick);
    }, 100);
}

function hideContextMenu() {
    const menu = document.getElementById('tableContextMenu');
    if (menu) menu.remove();
}

function hideContextMenuOnClick(e) {
    if (!e.target.closest('.table-context-menu')) {
        hideContextMenu();
        document.removeEventListener('click', hideContextMenuOnClick);
    }
}

function setTableStatus(tableId, status) {
    const table = floorplanTables.find(t => t.id === tableId);
    if (table) {
        table.status = status;
        renderFloorplan();
        updateTischplanStats();
        
        const labels = { free: 'Frei', reserved: 'Reserviert', occupied: 'Besetzt' };
        showToast(`Tisch ${table.number}: ${labels[status]}`);
    }
    hideContextMenu();
}

function deleteTable(tableId) {
    if (!confirm('Tisch wirklich löschen?')) return;
    
    floorplanTables = floorplanTables.filter(t => t.id !== tableId);
    renderFloorplan();
    updateTischplanStats();
    hideContextMenu();
    showToast('Tisch gelöscht');
}

function updateTischplanStats() {
    const free = floorplanTables.filter(t => t.status === 'free').length;
    const reserved = floorplanTables.filter(t => t.status === 'reserved').length;
    const occupied = floorplanTables.filter(t => t.status === 'occupied').length;
    const total = floorplanTables.length;
    
    const updateEl = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
    };
    
    updateEl('tpStatFree', free);
    updateEl('tpStatReserved', reserved);
    updateEl('tpStatOccupied', occupied);
    updateEl('tpStatTotal', total);
}

async function saveTischplan() {
    if (!currentTischplanRestaurant) {
        showToast('Kein Restaurant ausgewählt', 'error');
        return;
    }
    
    // Hier später Speichern in Supabase
    console.log('Speichere Tischplan:', floorplanTables);
    
    showToast('Tischplan gespeichert!', 'success');
}

// Alte Funktionen für Kompatibilität
function adminLoadTischplan(restaurantId) {
    loadTischplanForRestaurant(restaurantId);
}

function tpRenderAdmin() {
    renderFloorplan();
}

function tpUpdateStatsAdmin() {
    updateTischplanStats();
}

// Tische aktualisieren (Kompatibilität)
async function updateGastroTables(change) {
    tpUpdateStats();
}

// Angebot speichern
async function saveGastroOffer() {
    const title = document.getElementById('gastroOfferTitle')?.value;
    const discount = document.getElementById('gastroOfferDiscount')?.value;
    
    if (!title) {
        showToast('Bitte Angebot eingeben', 'error');
        return;
    }
    
    const restaurantId = currentUser?.restaurantId;
    if (!restaurantId) return;
    
    try {
        // Altes Angebot löschen
        await fetch(`${SUPABASE_URL}/rest/v1/offers?restaurant_id=eq.${restaurantId}`, {
            method: 'DELETE',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        // Neues Angebot speichern
        await fetch(`${SUPABASE_URL}/rest/v1/offers`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                restaurant_id: restaurantId,
                title: title,
                discount: discount,
                valid_until: new Date(Date.now() + 24*60*60*1000).toISOString().split('T')[0]
            })
        });
        
        showToast('Angebot gespeichert!', 'success');
        
    } catch (e) {
        showToast('Fehler beim Speichern', 'error');
    }
}

// Reservierung bestätigen
async function confirmGastroReservation(reservationId) {
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/reservations?id=eq.${reservationId}`, {
            method: 'PATCH',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: 'confirmed' })
        });
        
        showToast('Reservierung bestätigt!', 'success');
        loadGastroReservations(currentUser?.restaurantId);
        
    } catch (e) {
        showToast('Fehler', 'error');
    }
}

// Gastro Logout
function gastroLogout() {
    localStorage.removeItem('kmi_gastro_logged_in');
    localStorage.removeItem('kmi_user');
    currentUser = null;
    
    // Zurück zur Gäste-App
    const gastroView = document.getElementById('gastroView');
    if (gastroView) gastroView.classList.remove('active');
    document.getElementById('guestView').classList.remove('hidden');
    
    if (supabaseClient) {
        supabaseClient.auth.signOut();
    }
    
    renderProfileContent();
    updateProfileUI();
    showToast('Abgemeldet', 'success');
}

function handleLogout() {
    currentUser = null;
    localStorage.removeItem('kmi_user');
    renderProfileContent();
    updateProfileUI();
}

async function logout() {
    if (supabaseClient) {
        await supabaseClient.auth.signOut();
    }
    handleLogout();
    showToast('Erfolgreich abgemeldet', 'success');
}

// Init Auth when page loads
document.addEventListener('DOMContentLoaded', function() {
    initSupabaseAuth(); // Sofort, kein Timeout!
    initNewFeatures();
    checkGroupFromURL();
});

// Prüft ob jemand über einen Gruppen-Link kommt
function checkGroupFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const groupId = urlParams.get('group');
    
    if (groupId) {
        // Gruppen-Daten aus localStorage laden
        const savedGroups = JSON.parse(localStorage.getItem('kmi_groups') || '{}');
        
        if (savedGroups[groupId]) {
            currentGroupData = savedGroups[groupId];
            setTimeout(() => {
                openModal('groupVotingModal');
                renderGroupVoting();
                showToast('Stimme für dein Lieblingsrestaurant ab! 🗳️');
            }, 500);
        } else {
            // Neue Gruppen-Session erstellen für Teilnehmer
            currentGroupData = {
                id: groupId,
                name: 'Gemeinsam Essen',
                size: 4,
                votes: {},
                myVotes: []
            };
            localStorage.setItem('kmi_groups', JSON.stringify({...savedGroups, [groupId]: currentGroupData}));
            setTimeout(() => {
                openModal('groupVotingModal');
                renderGroupVoting();
                showToast('Willkommen! Stimme ab wo ihr essen wollt! 🍽️');
            }, 500);
        }
        
        // URL Parameter entfernen (cleaner)
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}

function loginWithEmail(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    
    // Email speichern für Code-Eingabe
    localStorage.setItem('kmi_pending_email', email);
    document.getElementById('sentEmailDisplay').textContent = email;
    
    closeModal('loginModal');
    openModal('emailCodeModal');
    
    showToast('Code wurde gesendet!');
}

function verifyEmailCode(e) {
    e.preventDefault();
    const code = document.getElementById('emailCode').value;
    const email = localStorage.getItem('kmi_pending_email');
    
    // Simuliert Code-Verifizierung (in Produktion: Backend-Call)
    if (code.length === 6) {
        const name = email.split('@')[0];
        simulateLogin(name.charAt(0).toUpperCase() + name.slice(1), email, 'email');
        closeModal('emailCodeModal');
        localStorage.removeItem('kmi_pending_email');
    } else {
        showToast('Bitte 6-stelligen Code eingeben', 'error');
    }
}

function resendCode() {
    showToast('Neuer Code wurde gesendet!');
}

function simulateLogin(name, email, avatar) {
    currentUser = {
        id: Date.now(),
        name: name,
        email: email,
        avatar: avatar,
        reservations: Math.floor(Math.random() * 5),
        createdAt: new Date().toISOString()
    };
    
    localStorage.setItem('kmi_user', JSON.stringify(currentUser));
    updateProfileUI();
    renderProfileContent();
    openModal('profileModal');
    
    showToast('Willkommen, ' + name + '! ', 'success');
    
    addNotification('login', '', 'green', 'Anmeldung erfolgreich', 'Willkommen bei Kiek mol in!');
}

function logout() {
    currentUser = null;
    localStorage.removeItem('kmi_user');
    
    const profileBtn = document.getElementById('profileBtn');
    if (profileBtn) {
        profileBtn.style.background = 'var(--bg-card)';
        profileBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
        `;
    }
    
    renderProfileContent();
    closeModal('profileModal');
    showToast('Du wurdest abgemeldet');
}

function showMyReservations() {
    closeModal('profileModal');
    showToast('Reservierungen werden geladen...');
    // Hier könnte man eine Reservierungsübersicht anzeigen
}

// ==================== THEME ====================
function initTheme() {
    const savedTheme = localStorage.getItem('kmi_theme') || 'auto';
    const savedAccent = localStorage.getItem('kmi_accent') || '#1a5f4a';
    const savedAccentName = localStorage.getItem('kmi_accent_name') || 'Ostfriesland Grün';
    const savedGlass = localStorage.getItem('kmi_glass') || 'none';
    const savedCorners = localStorage.getItem('kmi_corners') || 'pill';
    
    applyTheme(savedTheme);
    applyAccentColor(savedAccent, savedAccentName);
    applyGlassEffect(savedGlass);
    applyCornerRadius(savedCorners);
    
    updateThemeButtons(savedTheme);
    updateGlassButtons(savedGlass);
    updateCornerButtons(savedCorners);
    
    // System Theme Change Listener
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        const currentTheme = localStorage.getItem('kmi_theme');
        if (currentTheme === 'auto') {
            applyTheme('auto');
        }
    });
}

function setTheme(theme) {
    localStorage.setItem('kmi_theme', theme);
    applyTheme(theme);
    updateThemeButtons(theme);
    
    const themeNames = { light: 'Hell', dark: 'Dunkel', auto: 'Automatisch' };
    showToast('' + themeNames[theme] + ' aktiviert');
}

// Einfache Theme-Funktion für Gäste
function setThemeSimple(theme) {
    localStorage.setItem('kmi_theme', theme);
    applyTheme(theme);
    
    // Simple Buttons aktualisieren
    ['Light', 'Dark', 'Auto'].forEach(btn => {
        const el = document.getElementById('themeBtn' + btn + 'Simple');
        if (el) {
            if (btn.toLowerCase() === theme) {
                el.style.borderColor = 'var(--primary)';
                el.style.background = 'var(--cream)';
            } else {
                el.style.borderColor = 'var(--border-color)';
                el.style.background = 'var(--bg-card)';
            }
        }
    });
    
    closeModal('themeModalSimple');
    const themeNames = { light: 'Hell', dark: 'Dunkel', auto: 'Automatisch' };
    showToast('' + themeNames[theme] + ' aktiviert');
}

function setAccentColor(color, name) {
    localStorage.setItem('kmi_accent', color);
    localStorage.setItem('kmi_accent_name', name);
    applyAccentColor(color, name);
    
    // Update active button
    document.querySelectorAll('.accent-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.style.getPropertyValue('--accent') === color) {
            btn.classList.add('active');
        }
    });
    
    showToast('' + name + ' aktiviert');
}

function applyAccentColor(color, name) {
    // Hex → RGB
    var r = parseInt(color.slice(1,3), 16);
    var g = parseInt(color.slice(3,5), 16);
    var b = parseInt(color.slice(5,7), 16);
    
    // Primary setzen
    document.documentElement.style.setProperty('--primary', color);
    document.documentElement.style.setProperty('--primary-rgb', r + ', ' + g + ', ' + b);
    
    // Light Version (20% Helligkeit dazu)
    var lr = Math.min(255, r + Math.round((255 - r) * 0.3));
    var lg = Math.min(255, g + Math.round((255 - g) * 0.3));
    var lb = Math.min(255, b + Math.round((255 - b) * 0.3));
    document.documentElement.style.setProperty('--primary-light', 'rgb(' + lr + ',' + lg + ',' + lb + ')');
    
    // Dark Version (30% dunkler)
    var dr = Math.round(r * 0.7);
    var dg = Math.round(g * 0.7);
    var db = Math.round(b * 0.7);
    document.documentElement.style.setProperty('--primary-dark', 'rgb(' + dr + ',' + dg + ',' + db + ')');
    
    // Meta Theme Color
    var meta = document.getElementById('themeColorMeta');
    if (meta) meta.content = color;
    
    // Label aktualisieren
    var nameEl = document.getElementById('currentAccentName');
    if (nameEl) nameEl.textContent = 'Aktuell: ' + name;
    
    // Custom Color Picker synchronisieren
    var picker = document.getElementById('customColorPicker');
    if (picker) picker.value = color;
    var hexLabel = document.getElementById('customColorHex');
    if (hexLabel) hexLabel.textContent = color;
}

// Custom Color Picker
function applyCustomColor() {
    var picker = document.getElementById('customColorPicker');
    if (!picker) return;
    var color = picker.value;
    setAccentColor(color, 'Eigene Farbe');
}

// Color Picker live-Vorschau
document.addEventListener('DOMContentLoaded', function() {
    var picker = document.getElementById('customColorPicker');
    if (picker) {
        picker.addEventListener('input', function() {
            var hexLabel = document.getElementById('customColorHex');
            if (hexLabel) hexLabel.textContent = this.value;
        });
    }
});

function setGlassEffect(effect) {
    localStorage.setItem('kmi_glass', effect);
    applyGlassEffect(effect);
    updateGlassButtons(effect);
    
    const names = { none: 'Aus', subtle: 'Dezent', strong: 'Stark' };
    showToast('Glaseffekt: ' + names[effect]);
}

function applyGlassEffect(effect) {
    document.body.classList.remove('glass-effect-none', 'glass-effect-subtle', 'glass-effect-strong');
    if (effect !== 'none') {
        document.body.classList.add('glass-effect-' + effect);
    }
}

function updateGlassButtons(active) {
    ['None', 'Subtle', 'Strong'].forEach(btn => {
        const el = document.getElementById('glass' + btn);
        if (el) {
            el.classList.toggle('active', btn.toLowerCase() === active);
        }
    });
}

function setCornerRadius(corners) {
    localStorage.setItem('kmi_corners', corners);
    applyCornerRadius(corners);
    updateCornerButtons(corners);
    
    const names = { sharp: 'Eckig', rounded: 'Rund', pill: 'Pill' };
    showToast('Ecken: ' + names[corners]);
}

function applyCornerRadius(corners) {
    document.body.classList.remove('corners-sharp', 'corners-rounded', 'corners-pill');
    document.body.classList.add('corners-' + corners);
}

function updateCornerButtons(active) {
    ['Sharp', 'Rounded', 'Pill'].forEach(btn => {
        const el = document.getElementById('corner' + btn);
        if (el) {
            el.classList.toggle('active', btn.toLowerCase() === active);
        }
    });
}

function resetDesign() {
    localStorage.removeItem('kmi_theme');
    localStorage.removeItem('kmi_accent');
    localStorage.removeItem('kmi_accent_name');
    localStorage.removeItem('kmi_glass');
    localStorage.removeItem('kmi_corners');
    
    applyTheme('auto');
    applyAccentColor('#1a5f4a', 'Ostfriesland Grün');
    applyGlassEffect('none');
    applyCornerRadius('pill');
    
    updateThemeButtons('auto');
    updateGlassButtons('none');
    updateCornerButtons('pill');
    
    showToast('Design zurückgesetzt');
    closeModal('themeModal');
}

function applyTheme(theme) {
    let actualTheme = theme;
    
    if (theme === 'auto') {
        // Safari-kompatible Erkennung
        try {
            const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            actualTheme = darkModeMediaQuery.matches ? 'dark' : 'light';
            console.log('Auto-Theme erkannt:', actualTheme);
        } catch(e) {
            // Fallback für ältere Browser
            actualTheme = 'light';
            console.log('Auto-Theme Fallback: light');
        }
    }
    
    // Theme anwenden - mehrere Methoden für beste Kompatibilität
    if (actualTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.documentElement.classList.add('dark-mode');
        if (document.body) document.body.classList.add('dark-mode');
    } else {
        document.documentElement.removeAttribute('data-theme');
        document.documentElement.classList.remove('dark-mode');
        if (document.body) document.body.classList.remove('dark-mode');
    }
    
    // Theme color für Statusleiste aktualisieren
    const themeColorMeta = document.getElementById('themeColorMeta');
    if (themeColorMeta) {
        themeColorMeta.content = actualTheme === 'dark' ? '#1a1a1a' : '#6B46C1';
    }
    
    // Karten-Theme aktualisieren
    if (typeof updateMapTheme === 'function') {
        setTimeout(updateMapTheme, 100);
    }
    
    console.log('[OK] Theme angewendet:', actualTheme);
}

function updateThemeButtons(activeTheme) {
    const buttons = ['Light', 'Dark', 'Auto'];
    buttons.forEach(btn => {
        const el = document.getElementById('themeBtn' + btn);
        if (el) {
            el.classList.toggle('active', btn.toLowerCase() === activeTheme);
        }
    });
}

// ==================== WEATHER ====================
let currentWeatherCode = 0; // Speichert aktuellen Wetter-Code

async function loadWeather() {
    // Hole Location aus aktueller Auswahl
    const loc = LOCATIONS[APP_DATA.currentLocation] || LOCATIONS['Greetsiel'];
    const lat = loc.lat;
    const lon = loc.lng;
    const locationName = APP_DATA.currentLocation || 'Ostfriesland';
    
    try {
        // Erweiterte API mit stündlicher und täglicher Vorhersage
        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m,weather_code,relative_humidity_2m,is_day&hourly=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=Europe/Berlin&forecast_days=7`);
        const data = await response.json();
        
        const temp = Math.round(data.current.temperature_2m);
        const windSpeed = Math.round(data.current.wind_speed_10m);
        const weatherCode = data.current.weather_code;
        const humidity = data.current.relative_humidity_2m;
        const isDay = data.current.is_day;
        
        currentWeatherCode = weatherCode;
        
        // Wetter-Beschreibung
        const desc = getWeatherDescription(weatherCode);
        
        // High/Low für heute
        const todayHigh = Math.round(data.daily.temperature_2m_max[0]);
        const todayLow = Math.round(data.daily.temperature_2m_min[0]);
        
        // Haupt-Widget aktualisieren
        const tempEl = document.getElementById('weatherTemp');
        const descEl = document.getElementById('weatherDesc');
        const highEl = document.getElementById('weatherHigh');
        const lowEl = document.getElementById('weatherLow');
        const locEl = document.getElementById('weatherLocation');
        
        if (tempEl) tempEl.textContent = temp + '°';
        if (descEl) descEl.textContent = desc;
        if (highEl) highEl.textContent = todayHigh + '°';
        if (lowEl) lowEl.textContent = todayLow + '°';
        if (locEl) locEl.textContent = locationName;
        
        // Stündliche und 7-Tage Vorhersage aktualisieren
        if (data.hourly) updateHourlyForecast(data.hourly);
        if (data.daily) updateDailyForecast(data.daily);
        
        // Theme aktualisieren
        updateWeatherTheme(weatherCode, isDay);
        
        // Wetter-Vorhersage für Eilmeldung laden
        checkWeatherForecast(lat, lon);
        
        console.log('[OK] Wetter aktualisiert:', temp + '°', desc, isDay ? '(Tag)' : '(Nacht)');
        
    } catch (e) {
        console.log('Wetter-API Fehler:', e);
    }
}

// Wetter-Vorhersage prüfen und ggf. Eilmeldung zeigen
async function checkWeatherForecast(lat, lon) {
    try {
        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=weather_code,precipitation_probability&forecast_hours=12&timezone=Europe/Berlin`);
        const data = await response.json();
        
        const hourlyWeather = data.hourly.weather_code;
        const hourlyPrecip = data.hourly.precipitation_probability;
        const times = data.hourly.time;
        
        // Prüfe die nächsten 6 Stunden auf schlechtes Wetter
        let alertInfo = null;
        
        for (let i = 0; i < Math.min(6, hourlyWeather.length); i++) {
            const code = hourlyWeather[i];
            const precip = hourlyPrecip[i];
            const time = new Date(times[i]);
            const hours = time.getHours();
            const timeStr = hours + ':00 Uhr';
            
            // Gewitter (95+)
            if (code >= 95) {
                alertInfo = {
                    icon: '⛈️',
                    title: 'Gewitter erwartet!',
                    message: `Ab ca. ${timeStr} sind Gewitter möglich. Sucht Schutz in Gebäuden!`,
                    gradient: 'linear-gradient(135deg, #1F1C2C 0%, #928DAB 100%)',
                    suggestions: ['Teemuseum Norden', 'Seehundstation', 'Cafés', 'Shopping']
                };
                break;
            }
            // Starker Regen (61-67) oder Schauer (80-86)
            else if ((code >= 61 && code <= 67) || (code >= 80 && code <= 86)) {
                alertInfo = {
                    icon: '🌧️',
                    title: 'Regen angekündigt',
                    message: `Ab ca. ${timeStr} wird Regen erwartet. Perfekt für Indoor-Aktivitäten!`,
                    gradient: 'linear-gradient(135deg, #373B44 0%, #4286f4 100%)',
                    suggestions: ['Museen', 'Cafés', 'Wellness', 'Kino']
                };
                break;
            }
            // Schnee (71-77)
            else if (code >= 71 && code <= 77) {
                alertInfo = {
                    icon: '❄️',
                    title: 'Schneefall erwartet',
                    message: `Ab ca. ${timeStr} kann es schneien. Warme Kleidung empfohlen!`,
                    gradient: 'linear-gradient(135deg, #E6DADA 0%, #274046 100%)',
                    suggestions: ['Tee trinken', 'Museen', 'Sauna', 'Restaurants']
                };
                break;
            }
            // Dichter Nebel (45-48)
            else if (code >= 45 && code <= 48) {
                alertInfo = {
                    icon: '🌫️',
                    title: 'Dichter Nebel',
                    message: `Nebel erwartet - Fährverbindungen könnten verzögert sein.`,
                    gradient: 'linear-gradient(135deg, #8E9EAB 0%, #B8C6DB 100%)',
                    suggestions: ['Fähre prüfen', 'Indoor-Tipps', 'Restaurants']
                };
                break;
            }
            // Hohe Regenwahrscheinlichkeit (>70%)
            else if (precip > 70 && !alertInfo) {
                alertInfo = {
                    icon: '🌦️',
                    title: 'Regen möglich',
                    message: `${precip}% Regenwahrscheinlichkeit ab ${timeStr}. Regenjacke einpacken!`,
                    gradient: 'linear-gradient(135deg, #536976 0%, #4B79A1 100%)',
                    suggestions: ['Cafés', 'Museen', 'Shopping']
                };
            }
        }
        
        // Alert anzeigen oder verstecken
        showWeatherAlert(alertInfo);
        
    } catch (e) {
        console.log('Wetter-Vorhersage Fehler:', e);
    }
}

// Wetter-Eilmeldung anzeigen
function showWeatherAlert(alertInfo) {
    const banner = document.getElementById('weatherAlertBanner');
    if (!banner) return;
    
    // Prüfen ob User die Meldung schon weggeklickt hat (für diese Stunde)
    const dismissedUntil = localStorage.getItem('kmi_weather_alert_dismissed');
    if (dismissedUntil && new Date().getTime() < parseInt(dismissedUntil)) {
        banner.style.display = 'none';
        return;
    }
    
    if (alertInfo) {
        document.getElementById('alertIcon').textContent = alertInfo.icon;
        document.getElementById('alertTitle').textContent = alertInfo.title;
        document.getElementById('alertMessage').textContent = alertInfo.message;
        
        // Icon-Container Farbe setzen
        const iconContainer = document.getElementById('alertIconContainer');
        if (iconContainer) {
            iconContainer.style.background = alertInfo.gradient;
        }
        
        // Vorschläge anzeigen im Apple-Style
        const suggestionsEl = document.getElementById('alertSuggestions');
        if (suggestionsEl && alertInfo.suggestions) {
            suggestionsEl.innerHTML = alertInfo.suggestions.map(s => 
                `<span style="background: var(--bg-secondary); color: var(--dark); padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; border: 1px solid var(--border-color);">${s}</span>`
            ).join('');
        }
        
        banner.style.display = 'block';
    } else {
        banner.style.display = 'none';
    }
}

// Wetter-Eilmeldung schließen (für 1 Stunde)
function dismissWeatherAlert() {
    const banner = document.getElementById('weatherAlertBanner');
    if (banner) banner.style.display = 'none';
    
    // Für 1 Stunde nicht mehr anzeigen
    const dismissUntil = new Date().getTime() + (60 * 60 * 1000);
    localStorage.setItem('kmi_weather_alert_dismissed', dismissUntil.toString());
}

// Dynamisches Theme basierend auf ECHTEM Wetter + Tageszeit
function updateWeatherTheme(weatherCode = currentWeatherCode, isDay = 1) {
    const hour = new Date().getHours();
    const weatherBg = document.getElementById('weatherBg');
    const weatherModalBg = document.getElementById('weatherModalBg');
    const mapContainer = document.getElementById('guestMap');
    
    let gradient, mapFilter;
    
    // Nacht (egal welches Wetter)
    if (!isDay || hour < 6 || hour >= 21) {
        gradient = 'linear-gradient(180deg, #0f172a 0%, #1e293b 30%, #334155 100%)';
        mapFilter = 'brightness(0.7) saturate(0.8)';
    }
    // Sonnig / Klar (weatherCode 0)
    else if (weatherCode === 0) {
        if (hour >= 6 && hour < 9) {
            // Morgen - Sonnenaufgang
            gradient = 'linear-gradient(180deg, #FF9A8B 0%, #FECFEF 40%, #87CEEB 100%)';
            mapFilter = 'brightness(1.05) saturate(1.1) sepia(0.05)';
        } else if (hour >= 17 && hour < 21) {
            // Abend - Sonnenuntergang
            gradient = 'linear-gradient(180deg, #ff7e5f 0%, #feb47b 30%, #ffcf91 100%)';
            mapFilter = 'brightness(0.95) saturate(1.2) sepia(0.1)';
        } else {
            // Klarer Tag
            gradient = 'linear-gradient(180deg, #4A90D9 0%, #56CCF2 50%, #87CEEB 100%)';
            mapFilter = 'brightness(1.05) saturate(1.1)';
        }
    }
    // Teilweise bewölkt (weatherCode 1-3)
    else if (weatherCode <= 3) {
        gradient = 'linear-gradient(180deg, #4A90D9 0%, #67B8DE 50%, #8BC4E8 100%)';
        mapFilter = 'brightness(1) saturate(1)';
    }
    // Nebel (weatherCode 45-48)
    else if (weatherCode <= 48) {
        gradient = 'linear-gradient(180deg, #8E9EAB 0%, #B8C6DB 50%, #D7DDE8 100%)';
        mapFilter = 'brightness(0.9) saturate(0.7) contrast(0.95)';
    }
    // Regen (weatherCode 51-67)
    else if (weatherCode <= 67) {
        gradient = 'linear-gradient(180deg, #373B44 0%, #4286f4 50%, #667eea 100%)';
        mapFilter = 'brightness(0.85) saturate(0.9)';
    }
    // Schnee (weatherCode 71-77)
    else if (weatherCode <= 77) {
        gradient = 'linear-gradient(180deg, #e0e5ec 0%, #f5f7fa 50%, #c3cfe2 100%)';
        mapFilter = 'brightness(1.1) saturate(0.8) contrast(1.05)';
    }
    // Schauer (weatherCode 80-86)
    else if (weatherCode <= 86) {
        gradient = 'linear-gradient(180deg, #536976 0%, #292E49 50%, #4B79A1 100%)';
        mapFilter = 'brightness(0.9) saturate(0.85)';
    }
    // Gewitter (weatherCode 95+)
    else if (weatherCode >= 95) {
        gradient = 'linear-gradient(180deg, #1F1C2C 0%, #3E3B4F 50%, #928DAB 100%)';
        mapFilter = 'brightness(0.75) saturate(0.7) contrast(1.1)';
    }
    // Fallback
    else {
        gradient = 'linear-gradient(180deg, #4A90D9 0%, #67B8DE 50%, #8BC4E8 100%)';
        mapFilter = 'brightness(1) saturate(1)';
    }
    
    if (weatherBg) {
        weatherBg.style.background = gradient;
        weatherBg.style.transition = 'background 1s ease';
    }
    
    if (weatherModalBg) {
        weatherModalBg.style.background = gradient;
    }
    
    if (mapContainer) {
        mapContainer.style.filter = mapFilter;
        mapContainer.style.transition = 'filter 1s ease';
    }
}

// Wetter alle 10 Minuten aktualisieren
setInterval(loadWeather, 600000);

// ==================== MAP FUNCTIONS ====================
let guestMap = null;
let mapMarkers = [];

const LOCATIONS = {
    'Greetsiel': { lat: 53.5021, lng: 7.0965, zoom: 16 },
    'Norddeich': { lat: 53.6108, lng: 7.1542, zoom: 15 },
    'Norden': { lat: 53.5967, lng: 7.2058, zoom: 14 },
    'Aurich': { lat: 53.4714, lng: 7.4808, zoom: 14 },
    'Emden': { lat: 53.3594, lng: 7.2060, zoom: 14 },
    'Norderney': { lat: 53.7066, lng: 7.1509, zoom: 14 },
    'Juist': { lat: 53.6772, lng: 6.9936, zoom: 14 },
    'Alle': { lat: 53.55, lng: 7.20, zoom: 10 }
};

function initMap() {
    const mapContainer = document.getElementById('guestMap');
    if (!mapContainer) {
        console.log('Karte Container nicht gefunden');
        return;
    }
    
    if (guestMap) {
        console.log('Karte bereits initialisiert');
        return;
    }
    
    // Warte bis Container sichtbar ist
    if (mapContainer.offsetWidth === 0) {
        setTimeout(initMap, 100);
        return;
    }
    
    try {
        const loc = LOCATIONS[APP_DATA.currentLocation] || LOCATIONS['Greetsiel'];
        
        guestMap = L.map('guestMap', {
            zoomControl: false,
            attributionControl: false
        }).setView([loc.lat, loc.lng], loc.zoom);
        
        // Dark/Light Mode Tile Layer
        const isDarkMode = document.body.classList.contains('dark-mode');
        const tileUrl = isDarkMode 
            ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
            : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
        
        window.guestMapTileLayer = L.tileLayer(tileUrl, {
            maxZoom: 19
        }).addTo(guestMap);
        
        // User Location anzeigen
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    
                    const userIcon = L.divIcon({
                        className: 'user-location-marker',
                        html: '<div style="background:var(--primary);width:14px;height:14px;border-radius:50%;border:3px solid var(--bg-card);box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
                        iconSize: [14, 14],
                        iconAnchor: [7, 7]
                    });
                    
                    L.marker([userLat, userLng], { icon: userIcon })
                        .addTo(guestMap)
                        .bindPopup('Dein Standort');
                },
                (error) => console.log('Geolocation nicht verfügbar'),
                { enableHighAccuracy: true, timeout: 5000 }
            );
        }
        
        updateMapMarkers();
        console.log('Karte erfolgreich initialisiert');
        
    } catch (e) {
        console.error('Karten-Fehler:', e);
    }
}

function updateMapMarkers() {
    console.log('updateMapMarkers aufgerufen');
    
    if (!guestMap) {
        console.log('Keine Map vorhanden - versuche zu initialisieren');
        initMap();
        return;
    }
    
    // Alte Marker entfernen
    mapMarkers.forEach(m => guestMap.removeLayer(m));
    mapMarkers = [];
    
    // Keine Restaurants? Nichts anzeigen
    if (!APP_DATA.restaurants || APP_DATA.restaurants.length === 0) {
        console.log('Keine Restaurants zum Anzeigen');
        return;
    }
    
    // Review Cards für Map Preview
    let reviewCardsHtml = '';
    
    // KIN Design Icons (konsistent mit Fullscreen Map)
    const cuisineIcons = {
        'Italienisch': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="18" height="18"><circle cx="12" cy="12" r="9"/><circle cx="9" cy="10" r="1.5" fill="white"/><circle cx="15" cy="9" r="1" fill="white"/><circle cx="14" cy="14" r="1.5" fill="white"/></svg>`,
        'Deutsch': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="18" height="18"><rect x="7" y="3" width="10" height="15" rx="2"/><path d="M5 8h2M5 12h2"/></svg>`,
        'Fisch': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="18" height="18"><path d="M6.5 12c3-4 8-4 11 0-3 4-8 4-11 0z"/><circle cx="15" cy="12" r="1" fill="white"/></svg>`,
        'Café': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="18" height="18"><path d="M17 8h1a3 3 0 0 1 0 6h-1"/><path d="M3 8h14v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V8z"/></svg>`,
        'Asiatisch': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="18" height="18"><path d="M12 3C7 3 3 8 3 12h18c0-4-4-9-9-9z"/><line x1="12" y1="12" x2="12" y2="21"/></svg>`,
        'Griechisch': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="18" height="18"><ellipse cx="12" cy="14" rx="8" ry="5"/><path d="M8 14c0-4 2-6 4-6s4 2 4 6"/></svg>`,
        'Türkisch': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="18" height="18"><ellipse cx="12" cy="16" rx="7" ry="4"/><path d="M7 12c0-4 2.5-7 5-7s5 3 5 7"/></svg>`,
        'Imbiss': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="18" height="18"><path d="M4 15h16l-2 5H6l-2-5z"/><ellipse cx="12" cy="11" rx="6" ry="3"/></svg>`,
        'default': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="18" height="18"><circle cx="12" cy="12" r="9"/><path d="M8 10v4M12 8v8M16 10v4"/></svg>`
    };
    
    const cuisineColors = {
        'Italienisch': 'var(--primary)',
        'Deutsch': '#d97706',
        'Fisch': '#0ea5e9',
        'Café': '#8b5cf6',
        'Asiatisch': '#10b981',
        'Griechisch': '#14b8a6',
        'Türkisch': '#f97316',
        'Imbiss': '#ec4899',
        'default': 'var(--primary)'
    };
    
    // Neue Marker hinzufügen
    APP_DATA.restaurants.forEach((r, index) => {
        if (!r.lat || !r.lng) {
            return;
        }
        
        const iconSvg = cuisineIcons[r.cuisine] || cuisineIcons['default'];
        const bgColor = cuisineColors[r.cuisine] || cuisineColors['default'];
        
        // Verfügbarkeits-Ring
        let ringColor = '#22c55e';
        if (r.freeTables === 0) ringColor = '#ef4444';
        else if (r.freeTables <= 2) ringColor = '#f59e0b';
        
        // KIN Design Marker
        const icon = L.divIcon({
            className: 'kin-map-marker',
            html: `
                <div class="map-marker-pin" data-id="${r.id}" style="
                    width: 40px;
                    height: 40px;
                    background: ${bgColor};
                    border-radius: 50%;
                    border: 3px solid var(--bg-card);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    position: relative;
                ">
                    ${iconSvg}
                    <div style="
                        position: absolute;
                        bottom: -2px;
                        right: -2px;
                        width: 12px;
                        height: 12px;
                        background: ${ringColor};
                        border-radius: 50%;
                        border: 2px solid var(--bg-card);
                    "></div>
                </div>
            `,
            iconSize: [44, 44],
            iconAnchor: [22, 44]
        });
        
        const marker = L.marker([r.lat, r.lng], { icon }).addTo(guestMap);
        
        // Bei Klick: Bottom Sheet öffnen
        marker.on('click', () => {
            openMapBottomSheet(r);
        });
        
        mapMarkers.push(marker);
        
        // Review Card für Preview (nur erste 5)
        if (index < 5 && r.freeTables > 0) {
            reviewCardsHtml += `
                <div onclick="openMapBottomSheet(APP_DATA.restaurants.find(x => x.id === '${r.id}'))" style="
                    flex: 0 0 auto;
                    width: 200px;
                    background: var(--bg-card);
                    border-radius: 16px;
                    padding: 12px;
                    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
                    cursor: pointer;
                    border: 1px solid var(--border-color);
                ">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="${r.image}" style="width: 40px; height: 40px; border-radius: 10px; object-fit: cover;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 13px; font-weight: 700; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${r.name}</div>
                            <div style="font-size: 11px; color: ${ringColor}; font-weight: 600;">${r.freeTables} Tische frei</div>
                        </div>
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="2" width="16" height="16">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </div>
                </div>
            `;
        }
    });
    
    // Review Cards einfügen
    const reviewContainer = document.getElementById('mapReviewCards');
    if (reviewContainer) {
        reviewContainer.innerHTML = reviewCardsHtml;
    }
}

// Bottom Sheet für Restaurant öffnen
function openMapBottomSheet(restaurant) {
    if (!restaurant) return;
    
    // Bestehendes Sheet entfernen
    const existing = document.getElementById('mapBottomSheet');
    if (existing) existing.remove();
    
    const isOpen = checkIfOpen(restaurant);
    const routeUrl = restaurant.googleMapsUrl || `https://www.google.com/maps/dir/?api=1&destination=${restaurant.lat},${restaurant.lng}`;
    
    const sheet = document.createElement('div');
    sheet.id = 'mapBottomSheet';
    sheet.innerHTML = `
        <div style="
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -4px 32px rgba(0,0,0,0.15);
            z-index: 10000;
            max-height: 70vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        ">
            <style>
                @keyframes slideUp {
                    from { transform: translateY(100%); }
                    to { transform: translateY(0); }
                }
            </style>
            
            <!-- Handle -->
            <div style="display: flex; justify-content: center; padding: 12px;">
                <div style="width: 40px; height: 4px; background: #e2e8f0; border-radius: 2px;"></div>
            </div>
            
            <!-- Restaurant Header -->
            <div style="position: relative;">
                <img src="${restaurant.image}" style="width: 100%; height: 180px; object-fit: cover;">
                <button onclick="document.getElementById('mapBottomSheet').remove()" style="
                    position: absolute;
                    top: 12px;
                    right: 12px;
                    width: 32px;
                    height: 32px;
                    background: rgba(0,0,0,0.5);
                    border: none;
                    border-radius: 50%;
                    color: white;
                    font-size: 18px;
                    cursor: pointer;
                ">×</button>
                <div style="
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    padding: 16px;
                    background: linear-gradient(transparent, rgba(0,0,0,0.7));
                    color: white;
                ">
                    <h3 style="margin: 0; font-size: 20px; font-weight: 700;">${restaurant.name}</h3>
                    <div style="font-size: 13px; opacity: 0.9;">${restaurant.street || restaurant.city || 'Ostfriesland'}</div>
                </div>
            </div>
            
            <!-- Info -->
            <div style="padding: 16px;">
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div style="flex: 1; text-align: center; padding: 12px; background: #f8fafc; border-radius: 12px;">
                        <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">Status</div>
                        <div style="font-size: 13px; font-weight: 600; color: ${isOpen ? '#34c759' : '#ff3b30'};">${isOpen ? 'Geöffnet' : 'Geschlossen'}</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 12px; background: #f8fafc; border-radius: 12px;">
                        <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">Tische</div>
                        <div style="font-size: 13px; font-weight: 600; color: ${restaurant.freeTables > 0 ? '#34c759' : '#ff3b30'};">${restaurant.freeTables} frei</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 12px; background: #f8fafc; border-radius: 12px;">
                        <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">Bewertung</div>
                        <div style="font-size: 13px; font-weight: 600;">⭐ ${restaurant.rating || '4.5'}</div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button onclick="document.getElementById('mapBottomSheet').remove(); openReservation('${restaurant.id}')" style="
                        background: var(--primary);
                        color: white;
                        border: none;
                        padding: 14px;
                        border-radius: 12px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                    ">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <rect x="3" y="4" width="18" height="18" rx="2"/>
                            <path d="M16 2v4M8 2v4M3 10h18"/>
                        </svg>
                        Reservieren
                    </button>
                    <a href="${routeUrl}" target="_blank" style="
                        background: #f1f5f9;
                        color: var(--text-primary);
                        border: none;
                        padding: 14px;
                        border-radius: 12px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        text-decoration: none;
                    ">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <polygon points="3 11 22 2 13 21 11 13 3 11"/>
                        </svg>
                        Route
                    </a>
                </div>
                
                ${restaurant.whatsapp ? `
                    <a href="https://wa.me/${restaurant.whatsapp.replace(/[^0-9]/g, '')}" target="_blank" style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        background: #25D366;
                        color: white;
                        padding: 14px;
                        border-radius: 12px;
                        margin-top: 10px;
                        text-decoration: none;
                        font-weight: 600;
                    ">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/></svg>
                        WhatsApp
                    </a>
                ` : ''}
            </div>
        </div>
        <div onclick="document.getElementById('mapBottomSheet').remove()" style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 9999;
        "></div>
    `;
    
    document.body.appendChild(sheet);
    
    // Karte auf Restaurant zentrieren
    if (guestMap) {
        guestMap.flyTo([restaurant.lat, restaurant.lng], 16, { duration: 0.5 });
    }
}

// User Location zentrieren
let userLocationMarker = null;

function centerOnUserLocation() {
    if (navigator.geolocation) {
        showToast('Suche Standort...', 'info');
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Auf Fullscreen Map zentrieren
                if (fullscreenMap) {
                    fullscreenMap.flyTo([lat, lng], 15, { duration: 1 });
                    addUserLocationMarker(fullscreenMap, lat, lng);
                }
                
                // Auch auf kleine Karte
                if (guestMap) {
                    guestMap.flyTo([lat, lng], 14, { duration: 1 });
                    addUserLocationMarker(guestMap, lat, lng);
                }
                
                showToast('Standort gefunden!', 'success');
            },
            (error) => {
                showToast('Standort nicht verfügbar', 'error');
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    } else {
        showToast('Standort nicht unterstützt', 'error');
    }
}

function addUserLocationMarker(map, lat, lng) {
    // Bestehenden Marker entfernen
    if (userLocationMarker) {
        try { userLocationMarker.remove(); } catch(e) {}
    }
    
    // Blauer pulsierender Punkt (wie bei Google Maps)
    const userIcon = L.divIcon({
        className: 'user-location-marker',
        html: `
            <div style="position: relative; width: 24px; height: 24px;">
                <div style="
                    position: absolute;
                    width: 24px;
                    height: 24px;
                    background: rgba(66, 133, 244, 0.2);
                    border-radius: 50%;
                    animation: pulse 2s ease-out infinite;
                "></div>
                <div style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 14px;
                    height: 14px;
                    background: #4285F4;
                    border: 3px solid white;
                    border-radius: 50%;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                "></div>
            </div>
        `,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });
    
    userLocationMarker = L.marker([lat, lng], { icon: userIcon, zIndexOffset: 1000 }).addTo(map);
}

// CSS für Pulsing Animation hinzufügen
if (!document.getElementById('userLocationStyles')) {
    const style = document.createElement('style');
    style.id = 'userLocationStyles';
    style.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
}

// Vollbild-Karte öffnen
let fullscreenMap = null;
let fullscreenMarkers = [];

function openFullscreenMap() {
    openModal('fullscreenMapModal');
    
    // Kleine Verzögerung für Modal-Animation
    setTimeout(() => {
        initFullscreenMap();
    }, 100);
}

function initFullscreenMap() {
    const container = document.getElementById('fullscreenMapContainer');
    if (!container) return;
    
    // Bestehende Map zerstören
    if (fullscreenMap) {
        fullscreenMap.remove();
        fullscreenMap = null;
    }
    
    // Neue Map erstellen
    const loc = LOCATIONS[APP_DATA.currentLocation] || LOCATIONS['Greetsiel'];
    fullscreenMap = L.map('fullscreenMapContainer', {
        zoomControl: false
    }).setView([loc.lat, loc.lng], 12);
    
    // Dark/Light Mode Tile Layer
    const isDarkMode = document.body.classList.contains('dark-mode');
    const tileUrl = isDarkMode 
        ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'  // Dark Mode
        : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png'; // Light Mode
    
    window.fullscreenTileLayer = L.tileLayer(tileUrl, {
        attribution: '© OpenStreetMap © CartoDB',
        maxZoom: 19
    }).addTo(fullscreenMap);
    
    // Zoom Control rechts unten
    L.control.zoom({ position: 'bottomright' }).addTo(fullscreenMap);
    
    // Marker hinzufügen
    updateFullscreenMarkers();
    
    // Live Stats aktualisieren
    updateMapLiveStats();
    
    // Map-Größe korrigieren
    setTimeout(() => {
        fullscreenMap.invalidateSize();
    }, 200);
    
    // Auto-Update alle 30 Sekunden
    if (window.mapLiveInterval) clearInterval(window.mapLiveInterval);
    window.mapLiveInterval = setInterval(updateMapLiveStats, 30000);
}

// Map Theme wechseln wenn Dark Mode sich ändert
function updateMapTheme() {
    const isDarkMode = document.body.classList.contains('dark-mode');
    const darkTiles = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
    const lightTiles = 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
    const tileUrl = isDarkMode ? darkTiles : lightTiles;
    
    // Fullscreen Map
    if (fullscreenMap && window.fullscreenTileLayer) {
        fullscreenMap.removeLayer(window.fullscreenTileLayer);
        window.fullscreenTileLayer = L.tileLayer(tileUrl, {
            attribution: '© OpenStreetMap © CartoDB',
            maxZoom: 19
        }).addTo(fullscreenMap);
    }
    
    // Mini Map (guestMap)
    if (guestMap && window.guestMapTileLayer) {
        guestMap.removeLayer(window.guestMapTileLayer);
        window.guestMapTileLayer = L.tileLayer(tileUrl, {
            maxZoom: 19
        }).addTo(guestMap);
    }
    
    // Marker neu rendern für Border-Farben
    if (fullscreenMap) updateFullscreenMarkers();
    if (guestMap) updateMapMarkers();
}

// Live Stats für die Karte
function updateMapLiveStats() {
    const restaurants = APP_DATA.restaurants || [];
    const available = restaurants.filter(r => r.freeTables > 0).length;
    const total = restaurants.length;
    const totalFreeTables = restaurants.reduce((sum, r) => sum + (r.freeTables || 0), 0);
    
    // Header Stats
    const liveCount = document.getElementById('mapLiveCount');
    if (liveCount) liveCount.textContent = `${total} Restaurants online`;
    
    // Bottom Stats
    const availableCount = document.getElementById('mapAvailableCount');
    if (availableCount) availableCount.textContent = `${totalFreeTables} Tische frei`;
    
    const reservationsToday = document.getElementById('mapReservationsToday');
    if (reservationsToday) {
        const todayRes = APP_DATA.reservations?.filter(r => r.date === new Date().toISOString().split('T')[0]).length || 0;
        reservationsToday.textContent = `${todayRes} heute`;
    }
}

function updateFullscreenMarkers(filter = 'all') {
    if (!fullscreenMap) return;
    
    // Alte Marker entfernen
    fullscreenMarkers.forEach(m => fullscreenMap.removeLayer(m));
    fullscreenMarkers = [];
    
    // Cards HTML
    let cardsHtml = '';
    let cardCount = 0;
    
    // KIN Design Icons (SVG, skalierbar, farb-neutral)
    const cuisineIcons = {
        'Italienisch': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="22" height="22">
            <circle cx="12" cy="12" r="9"/>
            <circle cx="9" cy="10" r="1.5" fill="white"/>
            <circle cx="15" cy="9" r="1" fill="white"/>
            <circle cx="14" cy="14" r="1.5" fill="white"/>
            <circle cx="8" cy="13" r="1" fill="white"/>
        </svg>`,
        'Deutsch': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="22" height="22">
            <rect x="7" y="3" width="10" height="15" rx="2"/>
            <path d="M5 8h2M5 12h2"/>
            <line x1="7" y1="18" x2="17" y2="18"/>
        </svg>`,
        'Fisch': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="22" height="22">
            <path d="M6.5 12c3-4 8-4 11 0-3 4-8 4-11 0z"/>
            <circle cx="15" cy="12" r="1" fill="white"/>
            <path d="M2 12l3-2v4l-3-2z" fill="white"/>
        </svg>`,
        'Café': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="22" height="22">
            <path d="M17 8h1a3 3 0 0 1 0 6h-1"/>
            <path d="M3 8h14v9a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V8z"/>
            <path d="M6 1v3M10 1v3M14 1v3"/>
        </svg>`,
        'Asiatisch': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="22" height="22">
            <path d="M12 3C7 3 3 8 3 12h18c0-4-4-9-9-9z"/>
            <line x1="12" y1="12" x2="12" y2="21"/>
            <path d="M8 17h8"/>
        </svg>`,
        'Griechisch': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="22" height="22">
            <ellipse cx="12" cy="14" rx="8" ry="5"/>
            <path d="M8 14c0-4 2-6 4-6s4 2 4 6"/>
            <circle cx="10" cy="13" r="1" fill="white"/>
            <circle cx="14" cy="13" r="1" fill="white"/>
        </svg>`,
        'Türkisch': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="22" height="22">
            <ellipse cx="12" cy="16" rx="7" ry="4"/>
            <path d="M7 12c0-4 2.5-7 5-7s5 3 5 7"/>
            <line x1="12" y1="5" x2="12" y2="3"/>
        </svg>`,
        'Imbiss': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="22" height="22">
            <path d="M4 15h16l-2 5H6l-2-5z"/>
            <ellipse cx="12" cy="11" rx="6" ry="3"/>
            <path d="M6 11V8c0-2 2.5-4 6-4s6 2 6 4v3"/>
        </svg>`,
        'default': `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="22" height="22">
            <circle cx="12" cy="12" r="9"/>
            <path d="M8 10v4M12 8v8M16 10v4"/>
        </svg>`
    };
    
    // KIN Farben
    const cuisineColors = {
        'Italienisch': 'var(--primary)',
        'Deutsch': '#d97706',
        'Fisch': '#0ea5e9',
        'Café': '#8b5cf6',
        'Asiatisch': '#10b981',
        'Griechisch': '#14b8a6',
        'Türkisch': '#f97316',
        'Imbiss': '#ec4899',
        'default': 'var(--primary)'
    };
    
    APP_DATA.restaurants.forEach((r, index) => {
        if (!r.lat || !r.lng) return;
        
        // Filter anwenden
        if (filter === 'available' && r.freeTables === 0) return;
        if (filter === 'restaurant' && r.cuisine === 'Café') return;
        if (filter === 'cafe' && r.cuisine !== 'Café') return;
        if (filter === 'fisch' && r.cuisine !== 'Fisch') return;
        
        // Icon und Farbe bestimmen
        const iconSvg = cuisineIcons[r.cuisine] || cuisineIcons['default'];
        const bgColor = cuisineColors[r.cuisine] || cuisineColors['default'];
        
        // Verfügbarkeits-Status
        let statusColor = '#22c55e'; // KIN Success Green
        let statusText = r.freeTables + ' frei';
        if (r.freeTables === 0) {
            statusColor = '#ef4444';
            statusText = 'Voll';
        } else if (r.freeTables <= 2) {
            statusColor = '#f59e0b';
            statusText = 'Fast voll';
        }
        
        // KIN Design Marker
        const icon = L.divIcon({
            className: 'kin-map-marker',
            html: `
                <div style="
                    width: 48px;
                    height: 48px;
                    background: ${bgColor};
                    border-radius: 50%;
                    border: 3px solid var(--bg-card);
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    position: relative;
                    transition: transform 0.2s, box-shadow 0.2s;
                ">
                    ${iconSvg}
                    <div style="
                        position: absolute;
                        bottom: -3px;
                        right: -3px;
                        width: 16px;
                        height: 16px;
                        background: ${statusColor};
                        border-radius: 50%;
                        border: 2px solid var(--bg-card);
                        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
                    "></div>
                </div>
            `,
            iconSize: [48, 48],
            iconAnchor: [24, 48]
        });
        
        const marker = L.marker([r.lat, r.lng], { icon }).addTo(fullscreenMap);
        marker.on('click', () => openMapBottomSheet(r));
        fullscreenMarkers.push(marker);
        
        // Premium Card für Preview (erste 8)
        if (cardCount < 8) {
            const rating = r.rating || 4.5;
            cardsHtml += `
                <div onclick="openMapBottomSheet(APP_DATA.restaurants.find(x => x.id === '${r.id}')); fullscreenMap.flyTo([${r.lat}, ${r.lng}], 16);" style="
                    flex: 0 0 auto;
                    width: 200px;
                    background: var(--bg-card);
                    border-radius: 16px;
                    overflow: hidden;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
                    cursor: pointer;
                    border: 1px solid var(--border-color);
                    transition: transform 0.2s, box-shadow 0.2s;
                ">
                    <div style="position: relative;">
                        <img src="${r.image}" style="width: 100%; height: 80px; object-fit: cover;">
                        <div style="position: absolute; top: 8px; left: 8px; background: ${bgColor}; padding: 4px 8px; border-radius: 8px; display: flex; align-items: center; gap: 4px;">
                            <div style="width: 18px; height: 18px;">${iconSvg.replace('width="22" height="22"', 'width="14" height="14"')}</div>
                        </div>
                        <div style="position: absolute; top: 8px; right: 8px; background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: 700;">
                            ${statusText}
                        </div>
                    </div>
                    <div style="padding: 10px 12px;">
                        <div style="font-size: 14px; font-weight: 700; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${r.name}</div>
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 6px;">
                            <span style="font-size: 12px; color: var(--slate);">${r.cuisine || 'Restaurant'}</span>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <svg viewBox="0 0 24 24" fill="var(--primary)" width="12" height="12"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                <span style="font-size: 12px; font-weight: 600; color: var(--dark);">${rating.toFixed(1)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            cardCount++;
        }
    });
    
    // Cards einfügen
    const cardsContainer = document.getElementById('fullscreenMapCards');
    if (cardsContainer) cardsContainer.innerHTML = cardsHtml;
    
    // Live Stats aktualisieren
    updateMapLiveStats();
}

function filterMapFullscreen(filter, btn) {
    // Button-Status - Reset alle
    document.querySelectorAll('#fullscreenMapModal .map-chip').forEach(b => {
        b.style.background = 'var(--bg-card)';
        b.style.color = 'var(--dark)';
        b.style.border = '1px solid var(--border-color)';
        b.style.boxShadow = 'none';
        b.classList.remove('active');
    });
    
    // Aktiven Button stylen
    btn.style.background = 'var(--primary)';
    btn.style.color = 'white';
    btn.style.border = 'none';
    btn.style.boxShadow = '0 2px 8px rgba(26,95,74,0.25)';
    btn.classList.add('active');
    
    // Marker aktualisieren
    updateFullscreenMarkers(filter);
}

function filterMap(filter) {
    // Button-Status aktualisieren
    document.querySelectorAll('.map-chip').forEach(btn => {
        btn.style.background = 'white';
        btn.style.color = '#64748b';
        btn.style.fontWeight = '500';
    });
    event.target.style.background = 'white';
    event.target.style.color = 'var(--primary)';
    event.target.style.fontWeight = '600';
    event.target.style.color = 'white';
    
    // Marker filtern
    if (!guestMap) return;
    
    mapMarkers.forEach(m => guestMap.removeLayer(m));
    mapMarkers = [];
    
    APP_DATA.restaurants.forEach(r => {
        if (!r.lat || !r.lng) return;
        
        // Filter anwenden
        if (filter === 'available' && r.freeTables === 0) return;
        if (filter === 'offers' && !r.offer) return;
        
        let color = '#34c759';
        if (r.freeTables === 0) color = '#ff3b30';
        else if (r.freeTables <= 2) color = '#ff9500';
        if (r.offer) color = '#e8a838'; // Gold für Angebote
        
        const icon = L.divIcon({
            className: 'custom-map-marker',
            html: `<div style="
                background: ${color};
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 700;
                font-size: 14px;
            ">${r.offer ? 'H' : r.freeTables}</div>`,
            iconSize: [36, 36],
            iconAnchor: [18, 18]
        });
        
        const marker = L.marker([r.lat, r.lng], { icon }).addTo(guestMap);
        marker.bindPopup(`
            <div style="text-align: center; min-width: 150px;">
                <strong style="font-size: 14px;">${r.name}</strong><br>
                ${r.offer ? `<span style="color: #e8a838; font-weight: 600;">${r.offer.discount} Rabatt!</span><br>` : ''}
                <span style="color: #5a5a5a; font-size: 12px;">${r.freeTables} Tische frei</span><br>
                <button onclick="openReservation('${r.id}')" style="
                    margin-top: 8px;
                    padding: 8px 16px;
                    background: #1a5f4a;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    ">Reservieren</button>
            </div>
        `);
        
        guestMapMarkers.push(marker);
    });
}

// ==================== KI ASSISTENT ====================
function openAssistant() {
    document.getElementById('assistantOverlay').classList.add('active');
    document.getElementById('assistantInput').focus();
}

function closeAssistant() {
    document.getElementById('assistantOverlay').classList.remove('active');
}

function sendAssistantMessage() {
    const input = document.getElementById('assistantInput');
    const message = input.value.trim();
    if (!message) return;
    
    addMessage(message, 'user');
    input.value = '';
    
    // Suggestions ausblenden nach erster Nachricht
    const suggestions = document.getElementById('assistantSuggestions');
    if (suggestions) suggestions.style.display = 'none';
    
    // Typing Indicator
    showTyping();
    
    // Antwort generieren
    setTimeout(() => {
        hideTyping();
        const response = generateResponse(message);
        addMessage(response, 'bot');
    }, 800 + Math.random() * 700);
}

function askAssistant(question) {
    document.getElementById('assistantInput').value = question;
    sendAssistantMessage();
}

function addMessage(text, type) {
    const container = document.getElementById('assistantMessages');
    const div = document.createElement('div');
    div.className = `assistant-message ${type}`;
    div.innerHTML = `<div class="message-content">${text}</div>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function showTyping() {
    const container = document.getElementById('assistantMessages');
    const div = document.createElement('div');
    div.className = 'assistant-message bot';
    div.id = 'typingIndicator';
    div.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function hideTyping() {
    const typing = document.getElementById('typingIndicator');
    if (typing) typing.remove();
}

function generateResponse(message) {
    const msg = message.toLowerCase().trim();
    const hour = new Date().getHours();
    const isEvening = hour >= 17 || hour < 6;
    const isMorning = hour >= 6 && hour < 11;
    const isLunchTime = hour >= 11 && hour < 14;
    
    // Zeitbasierte Begrüßung
    const greeting = isMorning ? 'Guten Morgen' : (isEvening ? 'Guten Abend' : 'Hallo');
    
    // Wetter-Daten holen
    const currentTemp = document.getElementById('weatherTemp')?.textContent || '8°C';
    const currentWeather = document.getElementById('weatherDesc')?.textContent || 'Bewölkt';
    const isRainy = currentWeather.toLowerCase().includes('regen') || currentWeather.toLowerCase().includes('schauer');
    const isSunny = currentWeather.toLowerCase().includes('sonn') || currentWeather.toLowerCase().includes('klar');
    
    // ==================== BEGRÜSSUNGEN ====================
    if (msg.match(/^(hallo|hi|hey|moin|guten|servus|grüß)/)) {
        const greetings = [
            `Moin moin! 👋 Schön dass du da bist! Was suchst du? Ich kann dir bei Restaurants, freien Tischen, Ausflügen oder Unterkünften helfen.`,
            `${greeting}! Willkommen in Ostfriesland! 🌊 Wie kann ich dir helfen? Restaurant gesucht? Oder Tipps für heute?`,
            `Moin! Bei uns in Ostfriesland ist es gerade ${currentTemp} und ${currentWeather}. Was möchtest du unternehmen?`
        ];
        return greetings[Math.floor(Math.random() * greetings.length)];
    }
    
    // ==================== PERSONALISIERTE EMPFEHLUNGEN ====================
    // "Was soll ich essen" / "Was empfiehlst du" / "Hunger"
    if (msg.match(/(was.*(essen|empf)|hunger|hungrig|appetit|lust auf|worauf)/)) {
        const available = APP_DATA.restaurants.filter(r => r.freeTables > 0);
        
        if (isLunchTime) {
            const quick = available.filter(r => ['imbiss', 'cafe', 'italienisch'].includes(r.cuisine));
            if (quick.length > 0) {
                const r = quick[Math.floor(Math.random() * quick.length)];
                return `🍽️ Zur Mittagszeit empfehle ich <strong>${r.name}</strong>! Schnell, lecker und ${r.freeTables} Tische sind noch frei. ${r.offer ? `<br><br>🎁 Tipp: ${r.offer.title}!` : ''}`;
            }
        }
        
        if (isEvening) {
            const dinner = available.filter(r => ['fisch', 'deutsch', 'italienisch', 'griechisch'].includes(r.cuisine));
            if (dinner.length > 0) {
                const r = dinner[Math.floor(Math.random() * dinner.length)];
                return `🌙 Für ein schönes Abendessen empfehle ich <strong>${r.name}</strong> (${r.cuisine})! Noch ${r.freeTables} Tische frei. Bewertung: ⭐ ${r.rating}`;
            }
        }
        
        if (available.length > 0) {
            const r = available[Math.floor(Math.random() * available.length)];
            return `Ich empfehle dir <strong>${r.name}</strong>! ${r.freeTables > 0 ? `Noch ${r.freeTables} Plätze frei.` : ''} ${r.offer ? `Aktuelles Angebot: ${r.offer.title}` : ''}`;
        }
        
        return 'Alle Restaurants sind gut besucht! Schau unter "Essen" - dort siehst du wer gerade Platz hat.';
    }
    
    // ==================== WETTER-BASIERTE EMPFEHLUNGEN ====================
    if (msg.match(/(wetter|regen|sonn|kalt|warm|draußen|drinnen)/)) {
        if (isRainy) {
            return `🌧️ Aktuell: ${currentTemp}, ${currentWeather}. <br><br>Bei Regen empfehle ich:<br>• Gemütliches Café mit Tee<br>• Fischrestaurant am Hafen (mit Blick aufs Wasser!)<br>• Museum oder Seehundstation<br><br>Soll ich ein Restaurant mit überdachter Terrasse suchen?`;
        }
        if (isSunny) {
            return `☀️ Super Wetter! ${currentTemp}, ${currentWeather}.<br><br>Perfekt für:<br>• Terrasse am Hafen<br>• Eis essen am Strand<br>• Wattwanderung & danach Fischbrötchen<br><br>Unter "Entdecken" findest du Outdoor-Aktivitäten!`;
        }
        return `🌤️ Aktuell: ${currentTemp}, ${currentWeather}. Gutes Wetter für einen Spaziergang am Hafen! Danach lecker Einkehren?`;
    }
    
    // ==================== KÜCHEN-SPEZIFISCH ====================
    // Fisch
    if (msg.match(/(fisch|krabben|meer|garnelen|lachs|matjes|hering|nordsee)/)) {
        const fish = APP_DATA.restaurants.filter(r => r.cuisine === 'fisch');
        if (fish.length > 0) {
            const r = fish[0];
            const r2 = fish[1];
            let response = `🐟 Frischer Fisch? Da bist du in Ostfriesland richtig!<br><br>`;
            response += `<strong>${r.name}</strong> - ${r.freeTables > 0 ? `${r.freeTables} Tische frei` : 'Voll, aber Warteliste möglich'} - ⭐ ${r.rating}`;
            if (r2) response += `<br><strong>${r2.name}</strong> - ${r2.freeTables > 0 ? `${r2.freeTables} Tische frei` : 'Beliebt!'} - ⭐ ${r2.rating}`;
            response += `<br><br>🦐 Tipp: Probier die Krabbensuppe - ostfriesische Spezialität!`;
            return response;
        }
        return 'Leider gerade keine Fisch-Restaurants verfügbar. Schau später nochmal!';
    }
    
    // Pizza/Italienisch
    if (msg.match(/(pizza|pasta|italien|lasagne|spaghetti)/)) {
        const italian = APP_DATA.restaurants.filter(r => r.cuisine === 'italienisch');
        if (italian.length > 0) {
            const r = italian[0];
            return `🍕 Pizza-Zeit! <strong>${r.name}</strong> hat leckere italienische Küche!<br><br>• ${r.freeTables} Tische verfügbar<br>• Bewertung: ⭐ ${r.rating}<br>${r.offer ? `• 🎁 ${r.offer.title}` : ''}<br><br>Soll ich reservieren?`;
        }
    }
    
    // Café/Kaffee
    if (msg.match(/(kaffee|café|cafe|kuchen|tee|frühstück|torte)/)) {
        const cafes = APP_DATA.restaurants.filter(r => r.cuisine === 'cafe');
        if (cafes.length > 0) {
            const r = cafes[0];
            return `☕ ${isMorning ? 'Perfekt für ein Frühstück!' : 'Zeit für Kaffee und Kuchen!'}<br><br><strong>${r.name}</strong> - Gemütlich mit ${r.freeTables > 0 ? `${r.freeTables} freien Plätzen` : 'aktuell voller Hütte'}.<br><br>🍵 Tipp: Probier einen echten Ostfriesentee mit Kluntje und Sahne!`;
        }
    }
    
    // Döner/Türkisch
    if (msg.match(/(döner|türk|kebab|lahmacun|pide)/)) {
        const turkish = APP_DATA.restaurants.filter(r => r.cuisine === 'tuerkisch');
        if (turkish.length > 0) {
            const r = turkish[0];
            return `🥙 Döner gesucht? <strong>${r.name}</strong> hat leckere türkische Küche! ${r.freeTables > 0 ? `Noch ${r.freeTables} Plätze.` : ''}`;
        }
        return 'Ich suche nach türkischen Restaurants in der Nähe... Schau mal unter "Essen" und filtere nach Küche!';
    }
    
    // Bar/Shisha
    if (msg.match(/(bar|cocktail|bier|shisha|kneipe|ausgehen|trinken|abend)/)) {
        const bars = APP_DATA.restaurants.filter(r => r.cuisine === 'bar' || r.cuisine === 'shisha');
        if (bars.length > 0) {
            const r = bars[0];
            return `🍹 Lust auf Ausgehen? <strong>${r.name}</strong> ist ein guter Spot! ${r.freeTables > 0 ? `${r.freeTables} Plätze frei.` : ''}<br><br>Schau unter "Essen" und filtere nach "Bar" oder "Shisha"!`;
        }
        return 'Bars und Shisha-Lounges findest du unter "Essen" - wähle die passende Kategorie!';
    }
    
    // ==================== FREIE TISCHE ====================
    if (msg.match(/(frei|verfügbar|tisch|platz|sofort|jetzt|spontan)/)) {
        const available = APP_DATA.restaurants.filter(r => r.freeTables > 0).sort((a,b) => b.freeTables - a.freeTables);
        if (available.length > 0) {
            let response = `✅ ${available.length} Restaurants mit freien Tischen:<br><br>`;
            available.slice(0, 4).forEach(r => {
                response += `• <strong>${r.name}</strong> - ${r.freeTables} Tische - ⭐ ${r.rating}<br>`;
            });
            response += `<br>Tippe auf "Jetzt geöffnet" im Filter für alle!`;
            return response;
        }
        return '😅 Gerade sind alle Restaurants voll. Versuch es in 30 Minuten nochmal oder ruf direkt an!';
    }
    
    // ==================== RESERVIERUNG ====================
    if (msg.match(/(reserv|buchen|bestellen|tisch.*für)/)) {
        // Versuche Personenzahl zu erkennen
        const personMatch = msg.match(/(\d+)\s*(person|leute|gäste|pax)/);
        const persons = personMatch ? personMatch[1] : null;
        
        let response = '📋 <strong>So reservierst du:</strong><br><br>';
        response += '1️⃣ Geh zu "Essen" und wähle ein Restaurant<br>';
        response += '2️⃣ Tippe auf "Reservieren"<br>';
        response += '3️⃣ Wähle Datum, Uhrzeit' + (persons ? ` und ${persons} Personen` : ' und Personenzahl') + '<br>';
        response += '4️⃣ Bestätige per WhatsApp<br><br>';
        response += '💡 Das Restaurant meldet sich dann bei dir!';
        return response;
    }
    
    // ==================== AUSFLÜGE & AKTIVITÄTEN ====================
    if (msg.match(/(ausflug|machen|sehen|tipps|unternehmen|aktivität|sehenswürdig|besuch|entdecken|langweilig)/)) {
        const tips = [
            { name: 'Pilsumer Leuchtturm', desc: 'Der berühmte gelbe Otto-Leuchtturm', icon: '🏠' },
            { name: 'Seehundstation', desc: 'Robbenbabys beobachten', icon: '🦭' },
            { name: 'Wattwanderung', desc: 'UNESCO Weltnaturerbe erleben', icon: '🦶' },
            { name: 'Greetsiel Hafen', desc: 'Krabbenkutter und frischer Fisch', icon: '⛵' },
            { name: 'Teemuseum', desc: 'Ostfriesische Teekultur', icon: '🍵' }
        ];
        
        let response = '🗺️ <strong>Top Ausflugstipps:</strong><br><br>';
        tips.forEach(t => {
            response += `${t.icon} <strong>${t.name}</strong> - ${t.desc}<br>`;
        });
        response += `<br>Mehr unter "Entdecken"!`;
        
        if (isRainy) {
            response += `<br><br>☔ Bei Regen: Seehundstation oder Teemuseum sind drinnen!`;
        }
        return response;
    }
    
    // ==================== UNTERKÜNFTE ====================
    if (msg.match(/(hotel|unterkunft|übernacht|schlafen|ferien|pension|ferienwohnung|airbnb)/)) {
        return '🏨 <strong>Unterkünfte findest du unter "Schlafen"!</strong><br><br>Wir haben:<br>• Hotels<br>• Ferienwohnungen<br>• Pensionen<br><br>Du kannst direkt anfragen oder per WhatsApp Kontakt aufnehmen. Brauchst du was Bestimmtes?';
    }
    
    // ==================== EVENTS ====================
    if (msg.match(/(event|veranstaltung|fest|markt|konzert|heute abend|was.*los)/)) {
        return '🎉 <strong>Events findest du unter "Events"!</strong><br><br>Dort siehst du:<br>• Wochenmärkte<br>• Feste & Feiern<br>• Konzerte<br>• Naturevents<br><br>Schau mal rein - vielleicht ist heute was los!';
    }
    
    // ==================== JOBS ====================
    if (msg.match(/(job|arbeit|stell|bewerbung|kellner|koch|aushilfe)/)) {
        return '💼 <strong>Jobs findest du unter "Jobs"!</strong><br><br>Restaurants suchen:<br>• Kellner/innen<br>• Köche<br>• Aushilfen<br>• Minijobber<br><br>Du kannst dich direkt per WhatsApp bewerben!';
    }
    
    // ==================== PREISE ====================
    if (msg.match(/(preis|kostet|günstig|billig|teuer|budget)/)) {
        const cheap = APP_DATA.restaurants.filter(r => ['imbiss', 'cafe'].includes(r.cuisine));
        return '💰 <strong>Preisübersicht:</strong><br><br>• Imbiss/Café: 5-15€<br>• Pizzeria: 10-20€<br>• Fischrestaurant: 15-35€<br>• Gehobenes Restaurant: 25-50€<br><br>Tipp: Schau auf "Angebote" - dort gibt es oft Rabatte!';
    }
    
    // ==================== ÖFFNUNGSZEITEN ====================
    if (msg.match(/(öffnung|geöffnet|wann.*auf|wann.*zu|schließ)/)) {
        return '🕐 <strong>Typische Öffnungszeiten:</strong><br><br>• Mittagstisch: 11:30 - 14:00<br>• Abends: 17:30 - 21:00<br>• Cafés: oft durchgehend<br><br>Tippe auf "Jetzt geöffnet" um nur offene Restaurants zu sehen!';
    }
    
    // ==================== DANKE ====================
    if (msg.match(/(danke|super|toll|perfekt|klasse|prima|genial)/)) {
        const thanks = [
            'Gern geschehen! 😊 Genieß deinen Aufenthalt in Ostfriesland!',
            'Freut mich dass ich helfen konnte! Bei Fragen - einfach schreiben!',
            'Immer gerne! Viel Spaß beim Essen und Entdecken! 🌊'
        ];
        return thanks[Math.floor(Math.random() * thanks.length)];
    }
    
    // ==================== HILFE ====================
    if (msg.match(/(hilfe|help|was kannst|wie funktioniert|erklär)/)) {
        return '🤖 <strong>Ich bin dein Ostfriesland-Guide!</strong><br><br>Frag mich nach:<br>• 🍽️ "Wo kann ich Fisch essen?"<br>• 🪑 "Wer hat freie Tische?"<br>• 🌧️ "Was bei Regen machen?"<br>• 🗺️ "Ausflugstipps"<br>• 🏨 "Unterkünfte"<br>• ☕ "Gutes Café in der Nähe"<br><br>Ich kenne alle Restaurants und gebe dir persönliche Tipps!';
    }
    
    // ==================== ENGLISCH ERKENNEN ====================
    if (msg.match(/^(hello|hi there|good|what|where|how|can you|please|thank)/)) {
        return '🇬🇧 Hi! I can help you in English too!<br><br>Ask me about:<br>• Restaurants with free tables<br>• Fish restaurants<br>• Things to do<br>• Weather tips<br><br>Or switch to English with the language button (EN) at the top!';
    }
    
    // ==================== NIEDERLÄNDISCH ERKENNEN ====================
    if (msg.match(/^(hoi|hallo|goedendag|waar|wat|hoe|kun je|alsjeblieft|bedankt)/)) {
        return '🇳🇱 Hoi! Ik kan je ook in het Nederlands helpen!<br><br>Klik op "NL" bovenaan om de taal te wijzigen. Dan is alles in het Nederlands!';
    }
    
    // ==================== FALLBACK - SMARTER ====================
    // Versuche irgendwas Nützliches zu finden
    if (APP_DATA.restaurants && APP_DATA.restaurants.length > 0) {
        const random = APP_DATA.restaurants[Math.floor(Math.random() * APP_DATA.restaurants.length)];
        const fallbacks = [
            `Hmm, das habe ich nicht verstanden. 🤔 Aber schau mal: <strong>${random.name}</strong> hat gerade ${random.freeTables} freie Tische! Oder frag mich nach "freie Tische", "Fischrestaurant" oder "Ausflugstipps"!`,
            `Das weiß ich leider nicht. Aber ich kann dir bei Restaurants helfen! Gerade ist <strong>${random.name}</strong> eine gute Wahl mit ⭐ ${random.rating} Bewertung.`,
            `Keine Ahnung... 😅 Aber versuch mal: "Was soll ich essen?" oder "Wer hat freie Tische?" - da kann ich helfen!`
        ];
        return fallbacks[Math.floor(Math.random() * fallbacks.length)];
    }
    
    return 'Das habe ich nicht verstanden. Versuch mal: "Freie Tische", "Fisch-Restaurant", "Ausflugstipps" oder "Hilfe"!';
}

// Initialize on load
document.addEventListener("DOMContentLoaded", function() {
    init();
    
    // Event Listeners für Header Buttons
    const themeBtn = document.getElementById('themeBtn');
    const notificationBtn = document.getElementById('notificationBtn');
    
    if (themeBtn) {
        themeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Theme Button geklickt');
            openModal('themeModal');
        });
    }
    
    if (notificationBtn) {
        notificationBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Notification Button geklickt');
            openModal('notificationModal');
        });
    }
});

// ==================== PWA SERVICE WORKER ====================
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then((registration) => {
                console.log('[OK] ServiceWorker registriert:', registration.scope);
            })
            .catch((error) => {
                console.log('❌ ServiceWorker Fehler:', error);
            });
    });
}

// ==================== PWA INSTALL BANNER ====================
let deferredPrompt;
const installBanner = document.getElementById('installBanner');

window.addEventListener('beforeinstallprompt', (e) => {
    console.log('Install Prompt verfügbar');
    e.preventDefault();
    deferredPrompt = e;
    
    // Banner anzeigen wenn noch nicht installiert
    if (installBanner) {
        installBanner.classList.add('show');
    }
});

function installPWA() {
    if (!deferredPrompt) {
        console.log('Kein Install Prompt verfügbar');
        return;
    }
    
    deferredPrompt.prompt();
    
    deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
            console.log('[OK] App wurde installiert');
            showToast('App wurde installiert!', 'success');
        }
        deferredPrompt = null;
        
        if (installBanner) {
            installBanner.classList.remove('show');
        }
    });
}

function dismissInstallBanner() {
    if (installBanner) {
        installBanner.classList.remove('show');
    }
    localStorage.setItem('kmi_install_dismissed', 'true');
}

// Banner nicht anzeigen wenn schon abgelehnt
window.addEventListener('appinstalled', () => {
    console.log('[OK] PWA wurde zum Homescreen hinzugefügt');
    if (installBanner) {
        installBanner.classList.remove('show');
    }
});
</script>

<!-- PWA Install Banner -->
<div id="installBanner" class="install-banner">
    <div class="install-content">
        <div class="install-icon" style="font-size: 24px;">App</div>
        <div class="install-text">
            <strong>Kiek mol in installieren</strong>
            <span>Zum Startbildschirm hinzufügen</span>
        </div>
    </div>
    <div class="install-actions">
        <button onclick="dismissInstallBanner()" class="install-btn-later">Später</button>
        <button onclick="installPWA()" class="install-btn-install">Installieren</button>
    </div>
</div>

<style>
.install-banner {
    position: fixed;
    bottom: -120px;
    left: 20px;
    right: 20px;
    max-width: 400px;
    margin: 0 auto;
    background: var(--bg-card);
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 -4px 30px rgba(0,0,0,0.2);
    z-index: 9999;
    transition: bottom 0.4s ease;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.install-banner.show {
    bottom: 90px;
}

.install-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

.install-icon {
    font-size: 32px;
}

.install-text {
    display: flex;
    flex-direction: column;
}

.install-text strong {
    font-size: 15px;
    color: var(--text-primary);
}

.install-text span {
    font-size: 13px;
    color: var(--text-secondary);
}

.install-actions {
    display: flex;
    gap: 10px;
}

.install-btn-later {
    flex: 1;
    padding: 12px;
    background: var(--bg-secondary);
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
}

.install-btn-install {
    flex: 2;
    padding: 12px;
    background: var(--primary);
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    color: white;
    cursor: pointer;
}

/* Loading Spinner Animation */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Checkout Button Disabled State */
.checkout-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}
</style>

<!-- Cookie Banner -->
<div id="cookieBanner" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 16px 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 10000; border-top: 1px solid var(--border-color);">
    <div style="max-width: 600px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
            <p style="font-size: 14px; color: var(--dark); margin: 0; line-height: 1.5;">
                <span data-i18n="cookieText">Wir nutzen Cookies für die Funktion der App.</span> 
                <a href="#" onclick="openModal('datenschutzModal'); return false;" style="color: var(--primary); text-decoration: underline;" data-i18n="cookieMore">Mehr erfahren</a>
            </p>
        </div>
        <button onclick="acceptCookies()" style="padding: 12px 28px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;" data-i18n="cookieAccept">
            Verstanden
        </button>
    </div>
</div>

<!-- Impressum Modal -->
<div class="modal-overlay" id="impressumModal">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <h2 class="modal-title">Impressum</h2>
            <button class="modal-close" onclick="closeModal('impressumModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">Angaben gemäß § 5 TMG</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px;">
                Ibrahim Kuran<br>
                Kurani Design<br>
                Waller Weg 37<br>
                26624 Südbrookmerland<br>
                Deutschland
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">Kontakt</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px;">
                E-Mail: <a href="/cdn-cgi/l/email-protection#92fbfcf4fdd2f9fbf7f9fffdfefbfcbcf6f7" style="color: var(--primary);"><span class="__cf_email__" data-cfemail="274e494148674c4e424c4a484b4e49094342">[email&#160;protected]</span></a>
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">Verantwortlich für den Inhalt</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px;">
                Ibrahim Kuran<br>
                Waller Weg 37<br>
                26624 Südbrookmerland
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">Haftungsausschluss</h3>
            <p style="color: var(--slate); line-height: 1.6; font-size: 13px;">
                Die Inhalte unserer Seiten wurden mit größter Sorgfalt erstellt. Für die Richtigkeit, Vollständigkeit und Aktualität der Inhalte können wir jedoch keine Gewähr übernehmen. Als Diensteanbieter sind wir gemäß § 7 Abs.1 TMG für eigene Inhalte auf diesen Seiten nach den allgemeinen Gesetzen verantwortlich.
            </p>
        </div>
    </div>
</div>

<!-- Datenschutz Modal -->
<div class="modal-overlay" id="datenschutzModal">
    <div class="modal" style="max-width: 550px;">
        <div class="modal-header">
            <h2 class="modal-title">Datenschutzerklärung</h2>
            <button class="modal-close" onclick="closeModal('datenschutzModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">1. Datenschutz auf einen Blick</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Wir nehmen den Schutz Ihrer persönlichen Daten sehr ernst. Diese Datenschutzerklärung klärt Sie über die Art, den Umfang und Zweck der Verarbeitung von personenbezogenen Daten auf.
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">2. Verantwortlicher</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Ibrahim Kuran<br>
                Kurani Design<br>
                Waller Weg 37<br>
                26624 Südbrookmerland<br>
                E-Mail: <a href="/cdn-cgi/l/email-protection#0d64636b624d666468666062616463236968" style="color: var(--primary);"><span class="__cf_email__" data-cfemail="f0999e969fb09b99959b9d9f9c999ede9495">[email&#160;protected]</span></a>
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">3. Welche Daten wir erheben</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                <strong>Technisch notwendige Cookies:</strong> Wir nutzen localStorage, um Ihre Einstellungen (z.B. Dark Mode) zu speichern. Diese Daten bleiben auf Ihrem Gerät.<br><br>
                <strong>Google Login:</strong> Wenn Sie sich mit Google anmelden, erhalten wir Ihren Namen und Ihre E-Mail-Adresse von Google.<br><br>
                <strong>Reservierungen:</strong> Bei einer Reservierung speichern wir Ihren Namen, Kontaktdaten und die Reservierungsdetails.
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">4. Datenverarbeitung</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Die Daten werden auf Servern von Supabase (EU) gespeichert. Wir geben keine Daten an Dritte weiter, außer an die Restaurants für Ihre Reservierung.
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">5. Ihre Rechte</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Sie haben jederzeit das Recht auf Auskunft, Berichtigung, Löschung und Einschränkung der Verarbeitung Ihrer Daten. Kontaktieren Sie uns unter <a href="/cdn-cgi/l/email-protection#92fbfcf4fdd2f9fbf7f9fffdfefbfcbcf6f7" style="color: var(--primary);"><span class="__cf_email__" data-cfemail="432a2d252c03282a26282e2c2f2a2d6d2726">[email&#160;protected]</span></a>.
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">6. Wetter-Daten</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Wir nutzen die Open-Meteo API für Wetterdaten. Es werden keine persönlichen Daten an Open-Meteo übermittelt.
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">7. Hinweis zur Genauigkeit</h3>
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; border-left: 4px solid var(--primary);">
                <p style="color: var(--slate); line-height: 1.6; font-size: 14px; margin: 0;">
                    <strong>Wichtiger Hinweis:</strong> Alle Angaben in dieser App (Öffnungszeiten, Verfügbarkeiten, Gezeiten, Preise etc.) sind ohne Gewähr. Wir bemühen uns um Aktualität und Richtigkeit, können jedoch keine Garantie übernehmen. Bitte prüfen Sie wichtige Informationen vor Ort oder kontaktieren Sie die Restaurants direkt.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Reviews Modal -->
<div class="modal-overlay" id="reviewsModal">
    <div class="modal" style="max-width: 550px;">
        <div class="modal-header">
            <h2 class="modal-title" id="reviewsModalTitle">Bewertungen</h2>
            <button class="modal-close" onclick="closeModal('reviewsModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Stats Summary -->
            <div class="stats-summary" id="reviewsStatsSummary">
                <div class="stat-chip">
                    <span class="stat-chip-icon">⭐</span>
                    <span class="stat-chip-value" id="reviewsAvgRating">-</span>
                    <span class="stat-chip-label">Bewertung</span>
                </div>
                <div class="stat-chip">
                    <span class="stat-chip-icon">💬</span>
                    <span class="stat-chip-value" id="reviewsTotalCount">0</span>
                    <span class="stat-chip-label">Bewertungen</span>
                </div>
                <div class="stat-chip">
                    <span class="stat-chip-icon">🔥</span>
                    <span class="stat-chip-value" id="reviewsTodayVisitors">0</span>
                    <span class="stat-chip-label">heute</span>
                </div>
            </div>
            
            <!-- Live Activity -->
            <div style="margin-bottom: 20px;">
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 10px; color: var(--text-primary);">
                    <span class="live-badge">LIVE</span> Letzte Aktivität
                </h4>
                <div class="activity-feed" id="liveActivityFeed">
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        Lade Aktivität...
                    </div>
                </div>
            </div>
            
            <!-- Write Review Button -->
            <button onclick="openWriteReview()" class="btn btn-primary" style="width: 100%; margin-bottom: 20px;">
                ✏️ Bewertung schreiben
            </button>
            
            <!-- Reviews List -->
            <div class="reviews-container" id="reviewsList">
                <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                    <div style="font-size: 48px; margin-bottom: 12px;">💬</div>
                    <p>Noch keine Bewertungen</p>
                    <p style="font-size: 13px;">Sei der Erste!</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Write Review Modal -->
<div class="modal-overlay" id="writeReviewModal">
    <div class="modal" style="max-width: 450px;">
        <div class="modal-header">
            <h2 class="modal-title">Bewertung schreiben</h2>
            <button class="modal-close" onclick="closeModal('writeReviewModal')">×</button>
        </div>
        <div class="modal-body">
            <form id="writeReviewForm" onsubmit="handleSubmitReview(event)">
                <input type="hidden" id="reviewTargetType">
                <input type="hidden" id="reviewTargetId">
                <input type="hidden" id="reviewTargetName">
                
                <p style="margin-bottom: 16px; font-weight: 600; color: var(--text-primary);" id="writeReviewFor"></p>
                
                <!-- Star Rating -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Wie war dein Erlebnis?</p>
                    <div class="star-rating-input" id="starRatingInput">
                        <span onclick="setRating(1)" data-rating="1">☆</span>
                        <span onclick="setRating(2)" data-rating="2">☆</span>
                        <span onclick="setRating(3)" data-rating="3">☆</span>
                        <span onclick="setRating(4)" data-rating="4">☆</span>
                        <span onclick="setRating(5)" data-rating="5">☆</span>
                    </div>
                    <p id="ratingText" style="font-size: 14px; color: var(--primary); font-weight: 500;"></p>
                </div>
                
                <!-- Name (wenn nicht eingeloggt) -->
                <div class="form-group" id="reviewNameGroup">
                    <label class="form-label">Dein Name</label>
                    <input type="text" class="form-input" id="reviewUserName" placeholder="Wie möchtest du heißen?">
                </div>
                
                <!-- Title -->
                <div class="form-group">
                    <label class="form-label">Titel (optional)</label>
                    <input type="text" class="form-input" id="reviewTitle" placeholder="z.B. Tolles Essen!">
                </div>
                
                <!-- Comment -->
                <div class="form-group">
                    <label class="form-label">Deine Bewertung</label>
                    <textarea class="form-textarea" id="reviewComment" rows="4" placeholder="Erzähl von deinem Erlebnis..."></textarea>
                </div>
                
                <!-- Photo Upload -->
                <div class="form-group">
                    <label class="form-label">📸 Fotos hinzufügen (optional)</label>
                    <div class="photo-upload-grid" id="reviewPhotoGrid">
                        <label class="photo-upload-add">
                            <input type="file" accept="image/*" multiple onchange="handleReviewPhotoUpload(event)" style="display: none;">
                            +
                        </label>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    ⭐ Bewertung absenden
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Punkte & Achievements Modal -->
<div class="modal-overlay" id="pointsModal">
    <div class="modal" style="max-width: 450px;">
        <div class="modal-header">
            <h2 class="modal-title">Meine Belohnungen</h2>
            <button class="modal-close" onclick="closeModal('pointsModal')">×</button>
        </div>
        <div class="modal-body">
            <!-- Punkte Übersicht -->
            <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%); border-radius: 16px; margin-bottom: 20px; color: #333;">
                <div style="font-size: 48px; font-weight: 700;" id="pointsModalTotal">0</div>
                <div style="font-size: 14px; opacity: 0.8;">Gesammelte Punkte</div>
                <div style="margin-top: 12px;">
                    <span class="level-badge" id="userLevel">🥉 Bronze</span>
                </div>
            </div>
            
            <!-- Fortschritt zum nächsten Level -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px;">
                    <span id="currentLevelLabel">Bronze</span>
                    <span id="nextLevelLabel">Silber (500)</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="levelProgress" style="width: 0%;"></div>
                </div>
            </div>
            
            <!-- So verdienst du Punkte -->
            <h4 style="margin: 0 0 12px; font-size: 14px;">So verdienst du Punkte:</h4>
            <div style="display: grid; gap: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                    <span>🍽️ Tisch reservieren</span>
                    <span style="font-weight: 600; color: #ffd700;">+50</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                    <span>⭐ Bewertung schreiben</span>
                    <span style="font-weight: 600; color: #ffd700;">+100</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                    <span>📸 Foto hochladen</span>
                    <span style="font-weight: 600; color: #ffd700;">+30</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                    <span>👥 Freund einladen</span>
                    <span style="font-weight: 600; color: #ffd700;">+300</span>
                </div>
            </div>
            
            <!-- Achievements -->
            <h4 style="margin: 0 0 12px; font-size: 14px;">🏅 Achievements:</h4>
            <div id="achievementsList" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                <!-- Wird dynamisch gefüllt -->
            </div>
            
            <!-- Belohnungen Button -->
            <button onclick="closeModal('pointsModal'); loadAvailableRewards(); openModal('availableRewardsModal');" class="btn btn-primary" style="width: 100%; margin-top: 20px; padding: 14px; font-size: 16px;">
                Belohnungen einlösen
            </button>
        </div>
    </div>
</div>

<!-- Belohnung erstellen Modal -->
<div class="modal-overlay" id="addRewardModal">
    <div class="modal" style="max-width: 480px;">
        <div class="modal-header">
            <h2 class="modal-title">Neue Belohnung erstellen</h2>
            <button class="modal-close" onclick="closeModal('addRewardModal')">×</button>
        </div>
        <div class="modal-body">
            <form id="addRewardForm" onsubmit="saveReward(event)">
                <!-- Icon Auswahl -->
                <div class="form-group">
                    <label class="form-label">Icon wählen:</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;" id="rewardIconPicker">
                        <button type="button" class="reward-icon-btn active" data-icon="coffee" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
                        </button>
                        <button type="button" class="reward-icon-btn" data-icon="cake" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1"/><path d="M2 21h20"/><path d="M7 8v2"/><path d="M12 8v2"/><path d="M17 8v2"/><path d="M7 4h.01"/><path d="M12 4h.01"/><path d="M17 4h.01"/></svg>
                        </button>
                        <button type="button" class="reward-icon-btn" data-icon="percent" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>
                        </button>
                        <button type="button" class="reward-icon-btn" data-icon="utensils" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/></svg>
                        </button>
                        <button type="button" class="reward-icon-btn" data-icon="gift" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>
                        </button>
                        <button type="button" class="reward-icon-btn" data-icon="star" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                        </button>
                        <button type="button" class="reward-icon-btn" data-icon="award" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
                        </button>
                        <button type="button" class="reward-icon-btn" data-icon="crown" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg>
                        </button>
                    </div>
                    <input type="hidden" id="rewardIcon" value="coffee">
                </div>

                <!-- Titel -->
                <div class="form-group">
                    <label class="form-label">Titel der Belohnung *</label>
                    <input type="text" class="form-input" id="rewardTitle" placeholder="z.B. Gratis Kaffee" required maxlength="100">
                </div>

                <!-- Beschreibung -->
                <div class="form-group">
                    <label class="form-label">Beschreibung (optional)</label>
                    <textarea class="form-input" id="rewardDescription" placeholder="z.B. Ein Heißgetränk nach Wahl" rows="2"></textarea>
                </div>

                <!-- Punkte -->
                <div class="form-group">
                    <label class="form-label">Benötigte Punkte *</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" class="form-input" id="rewardPoints" value="500" min="100" max="10000" step="50" required>
                        <span style="display: flex; align-items: center; color: var(--text-secondary);">🌟</span>
                    </div>
                    <small style="color: var(--text-secondary);">Empfohlen: 300-1000 Punkte</small>
                </div>

                <!-- Typ -->
                <div class="form-group">
                    <label class="form-label">Art der Belohnung</label>
                    <select class="form-input" id="rewardType" onchange="toggleDiscountField()">
                        <option value="freebie">Gratis-Artikel (Kaffee, Dessert, etc.)</option>
                        <option value="discount">Rabatt auf Rechnung</option>
                        <option value="upgrade">Upgrade (größere Portion, etc.)</option>
                        <option value="special">Spezial-Erlebnis</option>
                    </select>
                </div>

                <!-- Rabatt Prozent (nur bei discount) -->
                <div class="form-group" id="discountField" style="display: none;">
                    <label class="form-label">Rabatt in %</label>
                    <input type="number" class="form-input" id="rewardDiscount" value="10" min="5" max="50" step="5">
                </div>

                <!-- Max Einlösungen -->
                <div class="form-group">
                    <label class="form-label">Maximale Einlösungen (optional)</label>
                    <input type="number" class="form-input" id="rewardMaxRedemptions" placeholder="Leer = unbegrenzt" min="1">
                    <small style="color: var(--text-secondary);">Leer lassen für unbegrenzt</small>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">
                    🎁 Belohnung erstellen
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Code einlösen Modal (für Gäste) -->
<div class="modal-overlay" id="redeemCodeModal">
    <div class="modal" style="max-width: 400px; text-align: center;">
        <div class="modal-header">
            <h2 class="modal-title">Dein Belohnungs-Code</h2>
            <button class="modal-close" onclick="closeModal('redeemCodeModal')">×</button>
        </div>
        <div class="modal-body">
            <div style="background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%); border-radius: 16px; padding: 24px; margin-bottom: 20px;">
                <div style="font-size: 14px; color: #333; opacity: 0.8; margin-bottom: 8px;">Zeige diesen Code im Restaurant:</div>
                <div id="redemptionCode" style="font-size: 32px; font-weight: 700; color: #333; letter-spacing: 4px; font-family: monospace;">
                    KMI-XXXXXX
                </div>
            </div>
            
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: left;">
                <div style="font-weight: 600; margin-bottom: 8px;" id="redeemedRewardTitle">Gratis Kaffee</div>
                <div style="font-size: 14px; color: var(--text-secondary);" id="redeemedRewardRestaurant">@ Restaurant Name</div>
            </div>

            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                Gültig für 24 Stunden. Zeige den Code beim Bezahlen.
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button onclick="copyRedemptionCode()" class="btn btn-secondary">
                    📋 Kopieren
                </button>
                <button onclick="closeModal('redeemCodeModal')" class="btn btn-primary">
                    ✓ Verstanden
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Verfügbare Belohnungen Modal (für Gäste) -->
<div class="modal-overlay" id="availableRewardsModal">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <h2 class="modal-title">Belohnungen einlösen</h2>
            <button class="modal-close" onclick="closeModal('availableRewardsModal')">×</button>
        </div>
        <div class="modal-body">
            <!-- Punkte-Stand -->
            <div style="background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center; color: #333;">
                <div style="font-size: 12px; opacity: 0.8;">Deine Punkte</div>
                <div style="font-size: 36px; font-weight: 700;" id="availableRewardsPoints">0</div>
            </div>

            <!-- Belohnungen Liste -->
            <div id="availableRewardsList">
                <p style="padding: 20px; color: var(--text-secondary); text-align: center;">Lade Belohnungen...</p>
            </div>
        </div>
    </div>
</div>

<!-- Vollbild Karten Modal -->
<div class="modal-overlay" id="fullscreenMapModal" style="z-index: 10001; display: none;">
    <div class="modal" style="max-width: 100%; max-height: 100%; width: 100%; height: 100%; margin: 0; border-radius: 0; overflow: hidden; background: var(--bg-primary);">
        <!-- Premium Header mit KIN Branding -->
        <div style="position: absolute; top: 0; left: 0; right: 0; z-index: 1001; padding: 16px; background: linear-gradient(to bottom, var(--bg-primary) 0%, rgba(255,255,255,0.95) 50%, transparent 100%);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <button onclick="closeModal('fullscreenMapModal')" style="background: var(--bg-card); border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--dark)" stroke-width="2" width="20" height="20">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                </button>
                <div style="text-align: center;">
                    <h3 style="margin: 0; font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 600; color: var(--dark);">Kiek mol in</h3>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 2px;">
                        <div style="width: 6px; height: 6px; background: #34c759; border-radius: 50%; animation: pulse 2s infinite;"></div>
                        <span style="font-size: 11px; color: var(--slate);" id="mapLiveCount">12 Restaurants online</span>
                    </div>
                </div>
                <button onclick="centerOnUserLocation()" style="background: var(--primary); border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 10px rgba(26,95,74,0.3);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="18" height="18">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
                    </svg>
                </button>
            </div>
            
            <!-- Filter Chips - KIN Style -->
            <div style="display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; padding-bottom: 4px;">
                <button class="map-chip active" onclick="filterMapFullscreen('all', this)" style="background: var(--primary); color: white; border: none; padding: 10px 18px; border-radius: 25px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 8px rgba(26,95,74,0.25);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><circle cx="12" cy="12" r="10"/></svg>
                        Alle
                    </span>
                </button>
                <button class="map-chip" onclick="filterMapFullscreen('available', this)" style="background: var(--bg-card); color: var(--dark); border: 1px solid var(--border-color); padding: 10px 18px; border-radius: 25px; font-size: 13px; font-weight: 500; cursor: pointer; white-space: nowrap;">
                    <span style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 8px; height: 8px; background: #34c759; border-radius: 50%;"></span>
                        Verfügbar
                    </span>
                </button>
                <button class="map-chip" onclick="filterMapFullscreen('restaurant', this)" style="background: var(--bg-card); color: var(--dark); border: 1px solid var(--border-color); padding: 10px 18px; border-radius: 25px; font-size: 13px; font-weight: 500; cursor: pointer; white-space: nowrap;">
                    🍽️ Restaurants
                </button>
                <button class="map-chip" onclick="filterMapFullscreen('cafe', this)" style="background: var(--bg-card); color: var(--dark); border: 1px solid var(--border-color); padding: 10px 18px; border-radius: 25px; font-size: 13px; font-weight: 500; cursor: pointer; white-space: nowrap;">
                    ☕ Cafés
                </button>
                <button class="map-chip" onclick="filterMapFullscreen('fisch', this)" style="background: var(--bg-card); color: var(--dark); border: 1px solid var(--border-color); padding: 10px 18px; border-radius: 25px; font-size: 13px; font-weight: 500; cursor: pointer; white-space: nowrap;">
                    🐟 Fisch
                </button>
            </div>
        </div>
        
        <!-- Fullscreen Map Container -->
        <div id="fullscreenMapContainer" style="width: 100%; height: 100%;"></div>
        
        <!-- Live Stats Bar -->
        <div style="position: absolute; bottom: 130px; left: 16px; z-index: 1001; display: flex; gap: 8px;">
            <div style="background: var(--bg-card); padding: 8px 14px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 6px;">
                <div style="width: 8px; height: 8px; background: #34c759; border-radius: 50%;"></div>
                <span style="font-size: 12px; font-weight: 600; color: var(--dark);" id="mapAvailableCount">8 frei</span>
            </div>
            <div style="background: var(--bg-card); padding: 8px 14px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 6px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" width="14" height="14"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                <span style="font-size: 12px; font-weight: 600; color: var(--dark);" id="mapReservationsToday">24 heute</span>
            </div>
        </div>
        
        <!-- Bottom Preview Cards - Premium Design -->
        <div id="fullscreenMapCards" style="position: absolute; bottom: 24px; left: 0; right: 0; z-index: 1001; display: flex; gap: 12px; padding: 0 16px; overflow-x: auto; scrollbar-width: none;">
            <!-- Wird dynamisch gefüllt -->
        </div>
    </div>
</div>

<!-- Wetter Detail Modal - Apple Style -->
<div class="modal-overlay" id="weatherDetailModal">
    <div class="modal" style="max-width: 100%; max-height: 90vh; width: 100%; margin: auto 0 0; border-radius: 20px 20px 0 0; overflow: hidden;">
        <div id="weatherModalBg" style="background: linear-gradient(180deg, #4A90D9 0%, #67B8DE 100%); min-height: 80vh; position: relative;">
            <!-- Close Button -->
            <button onclick="closeModal('weatherDetailModal')" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 50%; color: white; font-size: 18px; cursor: pointer; z-index: 10;">×</button>
            
            <!-- Header -->
            <div style="text-align: center; padding: 40px 20px 20px; color: white;">
                <div style="font-size: 28px; font-weight: 300;">Mein Standort</div>
                <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;" id="weatherModalLocation">OSTFRIESLAND</div>
                <div style="font-size: 86px; font-weight: 100; line-height: 1; margin: 10px 0;" id="weatherModalTemp">8°</div>
                <div style="font-size: 18px;" id="weatherModalDesc">Meist bewölkt</div>
                <div style="font-size: 16px; opacity: 0.9; margin-top: 6px;">
                    H: <span id="weatherModalHigh">12°</span>  T: <span id="weatherModalLow">5°</span>
                </div>
            </div>
            
            <!-- Stündliche Vorhersage Card -->
            <div style="margin: 0 16px 16px; background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 16px; overflow: hidden;">
                <div style="padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.2); color: white; font-size: 13px; opacity: 0.8;" id="weatherModalSummary">
                    Wolken den ganzen Tag. Windböen mit bis zu 15 km/h.
                </div>
                <div id="hourlyForecastModal" style="display: flex; overflow-x: auto; padding: 12px 8px; gap: 0; scrollbar-width: none;">
                    <!-- Wird dynamisch gefüllt -->
                </div>
            </div>
            
            <!-- 10-Tage Vorhersage -->
            <div style="margin: 0 16px 20px; background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 16px; overflow: hidden;">
                <div style="padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.2); color: white; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
                    10-TAGE-VORHERSAGE
                </div>
                <div id="dailyForecastModal" style="padding: 8px 16px; color: white;">
                    <!-- Wird dynamisch gefüllt -->
                </div>
            </div>
            
            <!-- Zusätzliche Infos -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 0 16px 30px;">
                <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); border-radius: 16px; padding: 14px;">
                    <div style="color: white; opacity: 0.7; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M17.7 7.7a7.5 7.5 0 1 0-10.6 10.6"/><path d="M12 2v4M2 12h4M20 12h2M12 20v2"/></svg>
                        WIND
                    </div>
                    <div style="color: white; font-size: 28px; font-weight: 300; margin-top: 8px;" id="weatherModalWind">15 km/h</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); border-radius: 16px; padding: 14px;">
                    <div style="color: white; opacity: 0.7; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                        LUFTFEUCHTIGKEIT
                    </div>
                    <div style="color: white; font-size: 28px; font-weight: 300; margin-top: 8px;" id="weatherModalHumidity">75%</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gruppen-Reservierung Modal -->
<div class="modal-overlay" id="groupReservationModal">
    <div class="modal" style="max-width: 480px;">
        <div class="modal-header">
            <h2 class="modal-title">Gruppen-Reservierung</h2>
            <button class="modal-close" onclick="closeModal('groupReservationModal')">×</button>
        </div>
        <div class="modal-body">
            <!-- Info -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" width="20" height="20">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <strong>So funktioniert's:</strong>
                </div>
                <ol style="margin: 0; padding-left: 20px; font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                    <li>Erstelle eine Gruppen-Session</li>
                    <li>Teile den Link mit Freunden</li>
                    <li>Alle können abstimmen</li>
                    <li>Reserviere für alle zusammen</li>
                </ol>
            </div>
            
            <!-- Neue Gruppe erstellen -->
            <div style="margin-bottom: 16px;">
                <label class="form-label">Gruppenname</label>
                <input type="text" class="form-input" id="groupName" placeholder="z.B. Geburtstagsessen Anna">
            </div>
            
            <div style="margin-bottom: 16px;">
                <label class="form-label">Anzahl Personen (ca.)</label>
                <input type="number" class="form-input" id="groupSize" value="6" min="2" max="30">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label class="form-label">Datum</label>
                    <input type="date" class="form-input" id="groupDate">
                </div>
                <div>
                    <label class="form-label">Uhrzeit</label>
                    <select class="form-input" id="groupTime">
                        <option value="12:00">12:00</option>
                        <option value="12:30">12:30</option>
                        <option value="13:00">13:00</option>
                        <option value="13:30">13:30</option>
                        <option value="14:00">14:00</option>
                        <option value="17:00">17:00</option>
                        <option value="17:30">17:30</option>
                        <option value="18:00" selected>18:00</option>
                        <option value="18:30">18:30</option>
                        <option value="19:00">19:00</option>
                        <option value="19:30">19:30</option>
                        <option value="20:00">20:00</option>
                        <option value="20:30">20:30</option>
                        <option value="21:00">21:00</option>
                    </select>
                </div>
            </div>
            
            <button onclick="createNewGroup()" class="btn btn-primary" style="width: 100%;">
                Gruppe erstellen & Link teilen
            </button>
            
            <!-- Aktive Gruppe -->
            <div id="activeGroupSection" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
                <h4 style="margin-bottom: 12px;">Deine aktive Gruppe:</h4>
                <div style="background: var(--primary); color: white; border-radius: 12px; padding: 16px;">
                    <div style="font-weight: 600; margin-bottom: 4px;" id="activeGroupName">Geburtstagsessen</div>
                    <div style="font-size: 13px; opacity: 0.8;" id="activeGroupMembers">3 Teilnehmer</div>
                    <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;" id="activeGroupDateTime"></div>
                </div>
                
                <!-- Voting -->
                <div style="margin-top: 16px;">
                    <h5 style="margin-bottom: 8px;">Restaurant-Vorschläge:</h5>
                    <div id="groupVotingList">
                        <!-- Wird dynamisch gefüllt -->
                    </div>
                </div>
                
                <button onclick="shareGroupLink()" class="btn btn-secondary" style="width: 100%; margin-top: 12px;">
                    Link erneut teilen
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Gruppen-Voting Modal für Teilnehmer -->
<div class="modal-overlay" id="groupVotingModal">
    <div class="modal" style="max-width: 480px;">
        <div class="modal-header">
            <h2 class="modal-title">Gruppen-Abstimmung</h2>
            <button class="modal-close" onclick="closeModal('groupVotingModal')">×</button>
        </div>
        <div class="modal-body">
            <!-- Gruppen-Info -->
            <div style="background: var(--primary); color: white; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                <div style="font-weight: 700; font-size: 18px; margin-bottom: 4px;" id="votingGroupName">Gruppenname</div>
                <div style="font-size: 14px; opacity: 0.9;" id="votingGroupInfo">6 Personen</div>
                <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;" id="votingGroupDateTime"></div>
            </div>
            
            <!-- Abstimmung Info -->
            <div style="text-align: center; margin-bottom: 16px;">
                <p style="color: var(--text-secondary); font-size: 14px;">Tippe auf dein Lieblingsrestaurant um abzustimmen!</p>
            </div>
            
            <!-- Restaurant Voting Liste -->
            <div id="groupVotingListModal">
                <!-- Wird dynamisch gefüllt -->
            </div>
            
            <!-- Teilen Button -->
            <button onclick="shareGroupLink()" class="btn btn-secondary" style="width: 100%; margin-top: 16px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;">
                    <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                </svg>
                Weitere Freunde einladen
            </button>
        </div>
    </div>
</div>

<!-- AR Preview Modal -->
<div class="modal-overlay" id="arPreviewModal">
    <div class="modal" style="max-width: 100%; max-height: 100%; width: 100%; height: 100%; margin: 0; border-radius: 0;">
        <div class="modal-header" style="position: absolute; top: 0; left: 0; right: 0; z-index: 10; background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent); padding: 16px;">
            <h2 class="modal-title" style="color: white;" id="arDishName">Gericht</h2>
            <button class="modal-close" onclick="closeARPreview()" style="color: white;">×</button>
        </div>
        <div class="modal-body" style="padding: 0; height: 100%; position: relative; overflow: hidden;">
            <!-- Kamera Container -->
            <div id="arCameraContainer" style="width: 100%; height: 100%; background: #000;">
                <video id="arVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover; display: none;"></video>
                <canvas id="arCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none;"></canvas>
                
                <!-- Placeholder -->
                <div id="arPlaceholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: white; text-align: center; padding: 20px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64" style="margin-bottom: 16px; opacity: 0.5;">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                        <circle cx="12" cy="13" r="4"/>
                    </svg>
                    <p style="margin: 0 0 8px;">Kamera wird geladen...</p>
                    <p style="font-size: 12px; opacity: 0.7;">Erlaube den Kamera-Zugriff</p>
                </div>
            </div>
            
            <!-- Hidden Dish Image für AR -->
            <img id="arDishImg" src="" crossorigin="anonymous" style="display: none;">
            
            <!-- Controls -->
            <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);">
                <!-- Größen-Slider -->
                <div style="margin-bottom: 16px;">
                    <label style="color: white; font-size: 12px; display: block; margin-bottom: 8px;">Größe anpassen:</label>
                    <input type="range" id="arScale" min="0.5" max="2" step="0.1" value="1" style="width: 100%;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button onclick="captureARPhoto()" class="btn btn-primary">
                        Foto machen
                    </button>
                    <button onclick="closeARPreview()" class="btn btn-secondary" style="background: rgba(255,255,255,0.2); color: white; border: none;">
                        Schließen
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Push-Benachrichtigungen Modal -->
<div class="modal-overlay" id="pushNotificationModal">
    <div class="modal" style="max-width: 400px; text-align: center;">
        <div class="modal-header">
            <h2 class="modal-title">Benachrichtigungen</h2>
            <button class="modal-close" onclick="closeModal('pushNotificationModal')">×</button>
        </div>
        <div class="modal-body">
            <div style="width: 80px; height: 80px; background: var(--bg-secondary); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" width="40" height="40">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
            </div>
            
            <h3 style="margin-bottom: 8px;">Verpasse nichts!</h3>
            <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 24px;">
                Erhalte Benachrichtigungen über:
            </p>
            
            <div style="text-align: left; margin-bottom: 24px;">
                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="pushReservations" checked style="width: 18px; height: 18px;">
                    <div>
                        <div style="font-weight: 600;">Reservierungsbestätigungen</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Wenn dein Tisch bestätigt wird</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="pushOffers" checked style="width: 18px; height: 18px;">
                    <div>
                        <div style="font-weight: 600;">Neue Angebote</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Spezielle Deals in deiner Nähe</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; cursor: pointer;">
                    <input type="checkbox" id="pushTables" style="width: 18px; height: 18px;">
                    <div>
                        <div style="font-weight: 600;">Tisch frei geworden</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Bei deinen Favoriten</div>
                    </div>
                </label>
            </div>
            
            <button onclick="enablePushNotifications()" class="btn btn-primary" style="width: 100%;">
                Benachrichtigungen aktivieren
            </button>
            <button onclick="closeModal('pushNotificationModal')" class="btn btn-secondary" style="width: 100%; margin-top: 8px;">
                Später
            </button>
        </div>
    </div>
</div>

<!-- AGB Modal -->
<div class="modal-overlay" id="agbModal">
    <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
            <h2 class="modal-title">Allgemeine Geschäftsbedingungen</h2>
            <button class="modal-close" onclick="closeModal('agbModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">1. Geltungsbereich</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Diese AGB gelten für alle Verträge zwischen Kurani Design (nachfolgend "Anbieter") und den teilnehmenden Restaurants (nachfolgend "Partner") über die Nutzung der Plattform "Kiek mol in" (kiekmolin.de).
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">2. Leistungen</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Der Anbieter stellt dem Partner eine Online-Plattform zur Verfügung, über die:<br><br>
                • Das Restaurant präsentiert wird<br>
                • Tischverfügbarkeiten angezeigt werden<br>
                • Reservierungsanfragen entgegengenommen werden<br>
                • Angebote und Aktionen beworben werden können
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">3. Vertragslaufzeit</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Der Vertrag wird auf unbestimmte Zeit geschlossen. Er kann von beiden Seiten mit einer Frist von 30 Tagen zum Monatsende gekündigt werden.
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">4. Preise und Zahlung</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                • Die monatliche Gebühr richtet sich nach dem gewählten Tarif<br>
                • Die Zahlung erfolgt per SEPA-Lastschrift<br>
                • Der Betrag wird am 1. eines jeden Monats eingezogen<br>
                • Bei fehlgeschlagener Abbuchung werden 5€ Mahngebühren berechnet
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">5. Pflichten des Partners</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Der Partner verpflichtet sich:<br><br>
                • Korrekte und aktuelle Daten bereitzustellen<br>
                • Tischverfügbarkeiten zeitnah zu aktualisieren<br>
                • Reservierungsanfragen zu bearbeiten<br>
                • Keine irreführenden Informationen zu veröffentlichen
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">6. Haftung</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Der Anbieter haftet nicht für entgangene Umsätze oder Schäden, die durch technische Störungen entstehen. Die Plattform wird "wie besehen" bereitgestellt.
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">7. Datenschutz</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Beide Parteien verpflichten sich zur Einhaltung der DSGVO. Kundendaten werden nur zum Zweck der Bearbeitung verwendet.
            </p>
        </div>
    </div>
</div>

<!-- ==================== ONLINE BESTELLUNG MODALS ==================== -->

<!-- Speisekarte Modal (Fullscreen) -->
<div class="modal-overlay" id="menuModal" style="z-index: 10001; display: none;">
    <div class="modal" style="max-width: 100%; max-height: 100%; width: 100%; height: 100%; margin: 0; border-radius: 0; display: flex; flex-direction: column;">
        <!-- Header -->
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px;">
            <button onclick="closeModal('menuModal')" style="background: var(--bg-secondary); border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--dark)" stroke-width="2" width="20" height="20">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>
            <div style="flex: 1;">
                <h2 style="font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 600; color: var(--dark); margin: 0;" id="menuRestaurantName">Restaurant</h2>
                <div style="font-size: 12px; color: var(--slate);" id="menuRestaurantMeta">Lieferung 30-45 Min</div>
            </div>
            <button onclick="openCartPanel()" style="background: var(--primary); border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative;">
                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="20" height="20">
                    <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                </svg>
                <span id="menuCartBadge" style="position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 11px; font-weight: 700; display: none; align-items: center; justify-content: center;">0</span>
            </button>
        </div>
        
        <!-- Kategorie Tabs -->
        <div class="menu-categories" id="menuCategoryTabs">
            <!-- Wird dynamisch gefüllt -->
        </div>
        
        <!-- Produkte Liste -->
        <div style="flex: 1; overflow-y: auto; padding: 16px 20px;" id="menuItemsList">
            <!-- Wird dynamisch gefüllt -->
        </div>
    </div>
</div>

<!-- Produkt-Detail Modal (Options Auswahl) -->
<div class="modal-overlay" id="itemOptionsModal" style="z-index: 10002; display: none;">
    <div class="modal" style="max-width: 500px; max-height: 90vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h2 class="modal-title" id="itemOptionsTitle">Pizza Margherita</h2>
            <button class="modal-close" onclick="closeModal('itemOptionsModal')">×</button>
        </div>
        <div class="modal-body" style="flex: 1; overflow-y: auto;" id="itemOptionsBody">
            <!-- Wird dynamisch gefüllt -->
        </div>
        <div style="padding: 20px; border-top: 1px solid var(--border-color); background: var(--bg-card);">
            <!-- Quantity -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                <span style="font-size: 15px; font-weight: 600; color: var(--dark);">Anzahl</span>
                <div class="quantity-selector">
                    <button class="qty-btn" onclick="changeItemQty(-1)">−</button>
                    <span class="qty-value" id="itemQtyValue">1</span>
                    <button class="qty-btn" onclick="changeItemQty(1)">+</button>
                </div>
            </div>
            <!-- Add Button -->
            <button onclick="addItemToCart()" style="width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                </svg>
                <span>In den Warenkorb</span>
                <span id="itemTotalPrice" style="margin-left: auto;">8,00 €</span>
            </button>
        </div>
    </div>
</div>

<!-- Warenkorb Panel -->
<div class="cart-panel" id="cartPanel">
    <div class="cart-panel-header" style="background: var(--bg-card); border-bottom: 1px solid var(--border-color);">
        <h3 class="cart-panel-title" style="color: var(--text-primary);">Warenkorb</h3>
        <button onclick="closeCartPanel()" style="background: none; border: none; cursor: pointer; padding: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-primary)" stroke-width="2" width="24" height="24">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
    </div>
    <div class="cart-panel-body" id="cartItemsList" style="background: var(--bg-card);">
        <!-- Wird dynamisch gefüllt -->
        <div style="text-align: center; padding: 40px 20px; color: var(--slate);" id="cartEmptyState">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 12px; opacity: 0.5;">
                <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
            </svg>
            <p style="font-size: 15px; font-weight: 500; color: var(--text-primary);">Ihr Warenkorb ist leer</p>
            <p style="font-size: 13px; margin-top: 4px;">Fügen Sie Gerichte hinzu, um zu bestellen.</p>
        </div>
    </div>
    <div class="cart-panel-footer" id="cartFooter" style="display: none; background: var(--bg-card); border-top: 1px solid var(--border-color);">
        <div class="cart-summary-row" style="color: var(--text-primary);">
            <span>Zwischensumme</span>
            <span id="cartSubtotal">0,00 €</span>
        </div>
        <div class="cart-summary-row" id="cartDeliveryRow" style="color: var(--text-primary);">
            <span>Liefergebühr</span>
            <span id="cartDeliveryFee">2,50 €</span>
        </div>
        <div class="cart-summary-total" style="color: var(--text-primary);">
            <span>Gesamtbetrag</span>
            <span id="cartTotal">0,00 €</span>
        </div>
        <button class="checkout-btn" onclick="openCheckout()" style="font-size: 15px; font-weight: 600;">
            Zur Kasse
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
        </button>
    </div>
</div>

<!-- Checkout Modal -->
<div class="modal-overlay" id="checkoutModal" style="z-index: 10003; display: none;">
    <div class="modal" style="max-width: 500px; max-height: 95vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <button onclick="closeModal('checkoutModal')" style="background: none; border: none; cursor: pointer; padding: 8px; margin-right: 8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-primary)" stroke-width="2" width="20" height="20">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>
            <h2 class="modal-title" style="color: var(--text-primary);">Bestellung abschließen</h2>
            <div style="width: 36px;"></div>
        </div>
        <div class="modal-body" style="flex: 1; overflow-y: auto;">
            <!-- Bestellart -->
            <div class="checkout-section">
                <div class="checkout-section-title" style="margin-bottom: 12px; color: var(--text-primary);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                        <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/>
                    </svg>
                    Bestellart wählen
                </div>
                <div class="order-type-toggle" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                    <button class="order-type-btn active" onclick="setOrderType('pickup', this)" data-type="pickup">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M16 11V7a4 4 0 0 0-8 0v4M5 9h14l1 12H4L5 9z"/>
                        </svg>
                        <span class="order-type-label">Abholung</span>
                        <span class="order-type-vat">7% MwSt</span>
                    </button>
                    <button class="order-type-btn" onclick="setOrderType('delivery', this)" data-type="delivery">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="9" cy="20" r="1.5"/><circle cx="17" cy="20" r="1.5"/>
                            <path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17"/>
                        </svg>
                        <span class="order-type-label">Lieferung</span>
                        <span class="order-type-vat">7% MwSt</span>
                    </button>
                </div>
                <!-- MwSt Info - KIN Design -->
                <div id="vatInfoBox" style="margin-top: 12px; padding: 10px 14px; background: var(--bg-secondary); border-radius: 10px; display: flex; align-items: center; gap: 10px; border: 1px solid var(--border-color);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="1.5" width="18" height="18">
                        <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                    </svg>
                    <span style="font-size: 12px; color: var(--text-primary);" id="vatInfoText">Abholung & Lieferung: <strong>7% MwSt</strong> (§12 Abs. 2 UStG)</span>
                </div>
            </div>
            
            <!-- Lieferadresse (nur bei Lieferung) -->
            <div class="checkout-section" id="deliveryAddressSection" style="display: none;">
                <div class="checkout-section-title" style="color: var(--text-primary);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    Lieferadresse <span style="color: var(--primary);">*</span>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <input type="text" class="form-input" id="checkoutStreet" placeholder="Straße *" required style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <input type="text" class="form-input" id="checkoutHouseNumber" placeholder="Nr." style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <input type="text" class="form-input" id="checkoutZip" placeholder="PLZ *" required style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);">
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <input type="text" class="form-input" id="checkoutCity" placeholder="Ort" value="Ostfriesland" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);">
                    </div>
                </div>
                <div class="form-group">
                    <input type="text" class="form-input" id="checkoutDeliveryNotes" placeholder="Lieferhinweis (Etage, Klingel...)" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);">
                </div>
            </div>
            
            <!-- Kontaktdaten -->
            <div class="checkout-section">
                <div class="checkout-section-title" style="color: var(--text-primary);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    Kontaktdaten <span style="color: var(--primary);">*</span>
                </div>
                <div class="form-group">
                    <input type="text" class="form-input" id="checkoutName" placeholder="Vor- und Nachname *" required style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);">
                </div>
                <div class="form-group">
                    <input type="tel" class="form-input" id="checkoutPhone" placeholder="Telefonnummer *" required style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);">
                </div>
                <div class="form-group">
                    <input type="email" class="form-input" id="checkoutEmail" placeholder="E-Mail (für Bestätigung)" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);">
                </div>
            </div>
            
            <!-- Gewünschte Zeit -->
            <div class="checkout-section">
                <div class="checkout-section-title" style="color: var(--text-primary);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    Gewünschte Zeit
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="order-type-btn active" onclick="setDeliveryTime('asap', this)" style="flex: 1;">
                        <span class="order-type-label">Schnellstmöglich</span>
                    </button>
                    <button class="order-type-btn" onclick="setDeliveryTime('scheduled', this)" style="flex: 1;">
                        <span class="order-type-label">Uhrzeit wählen</span>
                    </button>
                </div>
                <div id="scheduledTimeSelector" style="display: none; margin-top: 12px;">
                    <input type="time" class="form-input" id="checkoutScheduledTime" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);">
                </div>
            </div>
            
            <!-- Bezahlung -->
            <div class="checkout-section">
                <div class="checkout-section-title" style="color: var(--text-primary);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                        <line x1="1" y1="10" x2="23" y2="10"/>
                    </svg>
                    Zahlungsart
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div class="option-item selected" onclick="setPaymentMethod('cash', this)" style="background: var(--bg-secondary); border-color: var(--border-color);">
                        <div class="option-radio">
                            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" width="14" height="14">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                        <div class="option-info">
                            <div class="option-name" style="color: var(--text-primary);">Barzahlung</div>
                        </div>
                    </div>
                    <div class="option-item" onclick="setPaymentMethod('card_on_delivery', this)" style="background: var(--bg-secondary); border-color: var(--border-color);">
                        <div class="option-radio">
                            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" width="14" height="14">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                        <div class="option-info">
                            <div class="option-name" style="color: var(--text-primary);">Kartenzahlung</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Anmerkungen -->
            <div class="checkout-section">
                <div class="checkout-section-title" style="color: var(--text-primary);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    Anmerkungen
                </div>
                <textarea class="form-textarea" id="checkoutNotes" placeholder="Allergien, Sonderwünsche..." style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);"></textarea>
            </div>
            
            <!-- Trinkgeld -->
            <div class="checkout-section">
                <div class="checkout-section-title" style="color: var(--text-primary);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                    Trinkgeld (optional)
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                    <button type="button" class="kin-time-btn" onclick="setTip(0, this)" id="tipBtn0">Kein</button>
                    <button type="button" class="kin-time-btn active" onclick="setTip(1, this)" id="tipBtn1">1 €</button>
                    <button type="button" class="kin-time-btn" onclick="setTip(2, this)" id="tipBtn2">2 €</button>
                    <button type="button" class="kin-time-btn" onclick="setTip(5, this)" id="tipBtn5">5 €</button>
                </div>
                <div style="margin-top: 10px;">
                    <input type="number" class="form-input" id="checkoutCustomTip" placeholder="Anderer Betrag (€)" min="0" step="0.50" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);" onchange="setCustomTip(this.value)">
                </div>
                <p style="font-size: 11px; color: var(--slate); margin-top: 8px;">100% des Trinkgelds geht an das Servicepersonal.</p>
            </div>
            
            <!-- E-Mail für Bestätigung -->
            <div class="checkout-section">
                <div class="checkout-section-title" style="color: var(--text-primary);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    Bestellbestätigung per E-Mail
                </div>
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin-bottom: 12px;">
                    <input type="checkbox" id="checkoutSendEmail" checked style="width: 18px; height: 18px; accent-color: var(--primary);">
                    <span style="font-size: 13px; color: var(--text-primary);">Bestellbestätigung per E-Mail senden</span>
                </label>
                <input type="email" class="form-input" id="checkoutEmailConfirm" placeholder="E-Mail-Adresse eingeben" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);">
            </div>
            
            <!-- Push-Benachrichtigungen -->
            <div class="checkout-section">
                <div class="checkout-section-title" style="color: var(--text-primary);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    Benachrichtigungen
                </div>
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                    <input type="checkbox" id="checkoutPushNotifications" checked style="width: 18px; height: 18px; accent-color: var(--primary);">
                    <span style="font-size: 13px; color: var(--text-primary);">Status-Updates per Push-Benachrichtigung</span>
                </label>
                <p style="font-size: 11px; color: var(--slate); margin-top: 8px; margin-left: 30px;">Sie werden benachrichtigt, wenn Ihre Bestellung in Zubereitung ist und zur Abholung/Lieferung bereit ist.</p>
            </div>
            
            <!-- AGB & Datenschutz -->
            <div class="checkout-section" style="padding-bottom: 0;">
                <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                    <input type="checkbox" id="checkoutAgbAccepted" style="width: 20px; height: 20px; margin-top: 2px; accent-color: var(--primary);">
                    <span style="font-size: 13px; color: var(--text-primary); line-height: 1.5;">
                        Ich akzeptiere die <a href="#" style="color: var(--primary); text-decoration: underline;">AGB</a> und <a href="#" style="color: var(--primary); text-decoration: underline;">Datenschutzerklärung</a>. <span style="color: var(--primary);">*</span>
                    </span>
                </label>
            </div>
        </div>
        
        <!-- Footer - KIN Design -->
        <div style="padding: 20px; border-top: 1px solid var(--border-color); background: var(--bg-card);">
            <div class="cart-summary-row" style="color: var(--text-primary);">
                <span>Zwischensumme</span>
                <span id="checkoutSubtotal">0,00 €</span>
            </div>
            <div class="cart-summary-row" id="checkoutDeliveryRow" style="color: var(--text-primary);">
                <span>Liefergebühr</span>
                <span id="checkoutDeliveryFee">2,50 €</span>
            </div>
            <div class="cart-summary-row" id="checkoutTipRow" style="color: var(--text-primary); display: none;">
                <span>Trinkgeld</span>
                <span id="checkoutTipAmount">0,00 €</span>
            </div>
            <div class="cart-summary-total" style="color: var(--text-primary); font-size: 18px;">
                <span>Gesamtbetrag</span>
                <span id="checkoutTotal">0,00 €</span>
            </div>
            <button class="checkout-btn" onclick="submitOrder()" id="submitOrderBtn" style="font-size: 16px; font-weight: 600;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/>
                    <path d="M9 12l2 2 4-4"/>
                </svg>
                Jetzt zahlungspflichtig bestellen
            </button>
            <p style="font-size: 11px; color: var(--slate); text-align: center; margin-top: 12px;">
                Mit Klick auf "Jetzt zahlungspflichtig bestellen" schließen Sie einen verbindlichen Kaufvertrag ab.
            </p>
        </div>
    </div>
</div>

<!-- Menü Scanner Modal -->
<div class="modal-overlay" id="menuScannerModal" style="z-index: 10006; display: none;">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" width="20" height="20">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                        <circle cx="12" cy="13" r="4"/>
                    </svg>
                </div>
                <div>
                    <h2 class="modal-title" style="font-family: 'Playfair Display', serif; font-size: 18px; margin: 0;">Menü Scanner</h2>
                    <p style="font-size: 12px; color: var(--slate); margin: 0;">KI-gestützte Speisekarten-Erkennung</p>
                </div>
            </div>
            <button class="modal-close" onclick="closeModal('menuScannerModal')">×</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <!-- Upload Area -->
            <div id="menuScanUploadArea" class="menu-scan-upload" ondrop="handleMenuDrop(event)" ondragover="handleMenuDragOver(event)" ondragleave="handleMenuDragLeave(event)">
                <input type="file" id="menuScanInput" accept="image/*,application/pdf,.pdf" style="display: none;" onchange="handleMenuScan(event)">
                
                <!-- Upload Icon -->
                <div class="upload-icon-container">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="32" height="32">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </div>
                
                <h3 style="font-size: 16px; font-weight: 600; color: var(--dark); margin-bottom: 8px;">Speisekarte hochladen</h3>
                <p style="font-size: 13px; color: var(--slate); margin-bottom: 16px;">Ziehen Sie eine Datei hierher oder klicken Sie zum Auswählen</p>
                
                <!-- Format Buttons -->
                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                    <button type="button" onclick="document.getElementById('menuScanInput').click()" class="upload-format-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                        <span>Bild</span>
                    </button>
                    <button type="button" onclick="triggerPdfUpload()" class="upload-format-btn pdf">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <path d="M9 15h6"/>
                            <path d="M9 11h6"/>
                        </svg>
                        <span>PDF</span>
                    </button>
                    <button type="button" onclick="triggerCameraCapture()" class="upload-format-btn camera">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                        <span>Kamera</span>
                    </button>
                </div>
                
                <p style="font-size: 11px; color: var(--slate); margin-top: 16px;">
                    Unterstützte Formate: JPG, PNG, WEBP, PDF (max. 100MB)
                </p>
                <p id="scannerDebugInfo" style="font-size: 10px; color: var(--slate); margin-top: 8px; opacity: 0.7;"></p>
                <script>
                                        // Debug Info beim Laden
                    setTimeout(function() {
                        var info = document.getElementById('scannerDebugInfo');
                        if (info) {
                            var pdfOk = !!window.pdfjsLib;
                            var ocrOk = typeof Tesseract !== 'undefined';
                            info.textContent = 'Status: PDF.js ' + (pdfOk ? '✓' : '✗') + ' | Tesseract ' + (ocrOk ? '✓' : '✗');
                            info.style.color = (pdfOk && ocrOk) ? '#16a34a' : '#dc2626';
                        }
                    }, 1000);
                </script>
            </div>
            
            <!-- Preview Area (hidden initially) -->
            <div id="menuScanPreview" style="display: none; margin-top: 16px;">
                <div id="menuPreviewContent">
                    <img id="menuScanImage" src="" style="width: 100%; border-radius: 12px; margin-bottom: 16px; display: none;">
                    <div id="menuPdfPreview" style="display: none; background: var(--bg-secondary); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 16px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="1.5" width="48" height="48" style="margin-bottom: 12px;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <path d="M9 15h6"/>
                            <path d="M9 11h6"/>
                        </svg>
                        <p id="menuPdfName" style="font-weight: 600; color: var(--dark); margin-bottom: 4px;">dokument.pdf</p>
                        <p id="menuPdfPages" style="font-size: 12px; color: var(--slate);"></p>
                    </div>
                </div>
                <button onclick="startMenuScan()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                    </svg>
                    Mit KI analysieren
                </button>
            </div>
            
            <!-- Scanning Progress (hidden initially) -->
            <div id="menuScanProgress" style="display: none; text-align: center; padding: 40px 20px;">
                <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                <h3 style="font-size: 16px; font-weight: 600; color: var(--dark); margin-bottom: 8px;">Analysiere Speisekarte...</h3>
                <p style="font-size: 13px; color: var(--slate);" id="menuScanStatus">Texterkennung läuft...</p>
            </div>
            
            <!-- Results Area (hidden initially) -->
            <div id="menuScanResults" style="display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <h3 style="font-size: 16px; font-weight: 600; color: var(--dark);">Erkannte Gerichte</h3>
                    <span style="background: #d1fae5; color: #059669; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="menuScanCount">0 gefunden</span>
                </div>
                <div id="menuScanItemsList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Erkannte Items -->
                </div>
                <div style="margin-top: 16px; display: flex; gap: 12px;">
                    <button onclick="cancelMenuScan()" style="flex: 1; padding: 14px; background: var(--bg-secondary); border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; color: var(--dark);">
                        Abbrechen
                    </button>
                    <button onclick="importScannedMenu()" style="flex: 2; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer;">
                        Alle importieren
                    </button>
                </div>
                <!-- Test Button für Entwicklung -->
                <div style="margin-top: 12px; text-align: center;">
                    <button onclick="testImportWithDemoData()" style="padding: 8px 16px; background: #f0f0f0; border: 1px dashed #ccc; border-radius: 8px; font-size: 12px; cursor: pointer; color: #666;">
                        🧪 Mit Demo-Daten testen
                    </button>
                </div>
            </div>
            
            <!-- Info Box -->
            <div style="background: #ede9fe; border-radius: 12px; padding: 12px; margin-top: 20px; display: flex; gap: 10px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="#7c3aed" stroke-width="2" width="20" height="20" style="flex-shrink: 0; margin-top: 2px;">
                    <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                </svg>
                <p style="font-size: 12px; color: #5b21b6; margin: 0; line-height: 1.4;">
                    <strong>Tipp:</strong> Fotografiere die Speisekarte bei gutem Licht. Die KI erkennt automatisch Gerichte, Beschreibungen und Preise.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Kategorie hinzufügen Modal -->
<div class="modal-overlay" id="addCategoryModal" style="z-index: 10006; display: none;">
    <div class="modal" style="max-width: 400px;">
        <div class="modal-header">
            <h2 class="modal-title" style="font-family: 'Playfair Display', serif;">Neue Kategorie</h2>
            <button class="modal-close" onclick="closeModal('addCategoryModal')">×</button>
        </div>
        <div class="modal-body">
            <div id="addCategoryFormWrapper">
                <div class="form-group">
                    <label class="form-label">Kategorie-Name *</label>
                    <input type="text" class="form-input" id="newCategoryName" required placeholder="z.B. Vorspeisen, Hauptgerichte, Desserts...">
                </div>
                <div class="form-group">
                    <label class="form-label">Icon wählen</label>
                    <div class="category-icon-grid">
                        <!-- Fleisch & Geflügel -->
                        <div class="icon-section">
                            <span class="icon-section-label">Fleisch & Geflügel</span>
                            <div class="icon-row">
                                <button type="button" class="category-icon-btn selected" data-icon="beef" onclick="selectCategoryIcon(this)" title="Rind">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><circle cx="12.5" cy="8.5" r="2.5"/><path d="M12.5 2a6.5 6.5 0 0 0-6.22 4.6c-1.1 3.13-.78 3.9-3.18 6.08A3 3 0 0 0 5 18c4 0 8.4-1.8 11.4-4.3A6.5 6.5 0 0 0 12.5 2Z"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="chicken" onclick="selectCategoryIcon(this)" title="Huhn/Geflügel">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M15.5 8.5a4 4 0 1 0-5.66 5.66l5.66-5.66z"/><path d="m11.25 12.75-5.66 5.66a2 2 0 0 0 2.83 2.83l5.66-5.66"/><circle cx="18" cy="6" r="2"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="lamb" onclick="selectCategoryIcon(this)" title="Lamm">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><ellipse cx="12" cy="14" rx="7" ry="5"/><circle cx="12" cy="8" r="4"/><path d="M8 6c-1-2-3-2-4 0"/><path d="M16 6c1-2 3-2 4 0"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="pork" onclick="selectCategoryIcon(this)" title="Schwein">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><ellipse cx="12" cy="13" rx="8" ry="6"/><circle cx="8" cy="11" r="1"/><circle cx="16" cy="11" r="1"/><ellipse cx="12" cy="15" rx="2" ry="1"/><path d="M4 10c-2-1-2-4 0-4"/><path d="M20 10c2-1 2-4 0-4"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="steak" onclick="selectCategoryIcon(this)" title="Steak">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M14 6c2.5 0 5 2 5 6s-2 8-7 8-8-4-8-8 3-6 6-6c1.5 0 2.5.5 4 0z"/><path d="M10 12c0 1.5 1 3 3 3"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="grill" onclick="selectCategoryIcon(this)" title="Grill">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><rect x="3" y="10" width="18" height="8" rx="2"/><path d="M6 10V8"/><path d="M10 10V6"/><path d="M14 10V6"/><path d="M18 10V8"/><path d="M3 18h18"/><path d="M8 22v-4"/><path d="M16 22v-4"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Fisch & Meeresfrüchte -->
                        <div class="icon-section">
                            <span class="icon-section-label">Fisch & Meer</span>
                            <div class="icon-row">
                                <button type="button" class="category-icon-btn" data-icon="fish" onclick="selectCategoryIcon(this)" title="Fisch">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M6.5 12c.94-3.46 4.94-6 8.5-6 3.56 0 6.06 2.54 7 6-.94 3.47-3.44 6-7 6-3.56 0-7.56-2.53-8.5-6Z"/><path d="M18 12v.5"/><path d="M2 10l3 2-3 2"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="shrimp" onclick="selectCategoryIcon(this)" title="Garnelen">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M18 9c0 3-2.5 6-6.5 6S5 15 5 12c0-4 3-7 7-7 2 0 4 1 5 3"/><path d="M18 9c1.5 0 3 1 3 3s-1 3-3 3"/><path d="M5 16l-2 4"/><path d="M8 17l-1 3"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="crab" onclick="selectCategoryIcon(this)" title="Krabben">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><ellipse cx="12" cy="13" rx="6" ry="4"/><path d="M6 11c-2-2-4-1-5 1"/><path d="M18 11c2-2 4-1 5 1"/><path d="M8 17l-2 3"/><path d="M16 17l2 3"/><circle cx="10" cy="12" r="1"/><circle cx="14" cy="12" r="1"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="sushi" onclick="selectCategoryIcon(this)" title="Sushi">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><ellipse cx="12" cy="14" rx="8" ry="4"/><path d="M4 14v2c0 2.2 3.6 4 8 4s8-1.8 8-4v-2"/><path d="M12 10c2.5 0 5 1 5 2.5"/><ellipse cx="12" cy="8" rx="4" ry="2"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Vegetarisch & Vegan -->
                        <div class="icon-section">
                            <span class="icon-section-label">Vegetarisch & Vegan</span>
                            <div class="icon-row">
                                <button type="button" class="category-icon-btn" data-icon="salad" onclick="selectCategoryIcon(this)" title="Salat">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M7 21h10"/><path d="M12 21a9 9 0 0 0 9-9H3a9 9 0 0 0 9 9Z"/><path d="M11 12c-1.5-1-3 0-3 2"/><path d="M15 12c-1-2 1-3 2-2"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="vegan" onclick="selectCategoryIcon(this)" title="Vegan">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="vegetarian" onclick="selectCategoryIcon(this)" title="Vegetarisch">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M2 2a26.6 26.6 0 0 1 10 20c.9-6.82 1.5-9.5 4-14 4.5-8 6-4 6-4"/><path d="M2 2c2 2.5 3.5 5 4.5 7.5"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="carrot" onclick="selectCategoryIcon(this)" title="Gemüse">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M12 2c2 2 3 5 3 8l-6 12c-.5-1-1-4 0-8 1-3 2-5 3-6"/><path d="M9 3c-1-1-3-1-4 1"/><path d="M15 3c1-1 3-1 4 1"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="mushroom" onclick="selectCategoryIcon(this)" title="Pilze">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M12 4c-5 0-9 3-9 7h18c0-4-4-7-9-7z"/><path d="M8 11v9c0 1 1 2 2 2h4c1 0 2-1 2-2v-9"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Internationale Küche -->
                        <div class="icon-section">
                            <span class="icon-section-label">Internationale Küche</span>
                            <div class="icon-row">
                                <button type="button" class="category-icon-btn" data-icon="pizza" onclick="selectCategoryIcon(this)" title="Pizza">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M15 11h.01"/><path d="M11 15h.01"/><path d="M16 16h.01"/><path d="m2 16 20 6-6-20A20 20 0 0 0 2 16"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="pasta" onclick="selectCategoryIcon(this)" title="Pasta">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M12 12a4 4 0 0 0 4 4h1a2 2 0 0 1 0 4H7a2 2 0 0 1 0-4h1a4 4 0 0 0 4-4Z"/><path d="M8 8c0-2 1-4 4-4s4 2 4 4"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="burger" onclick="selectCategoryIcon(this)" title="Burger">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M4 15h16a2 2 0 0 1 0 4H4a2 2 0 0 1 0-4z"/><path d="m4 11 7.77-6.04a2 2 0 0 1 2.46 0L22 11H4Z"/><path d="M4 11h16v4H4z"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="taco" onclick="selectCategoryIcon(this)" title="Mexikanisch">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M4 15c0 3 3.5 5 8 5s8-2 8-5c0-4-4-10-8-10S4 11 4 15z"/><path d="M8 13c0 1 1 2 2 2"/><path d="M14 11c0 1 1 2 2 2"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="noodles" onclick="selectCategoryIcon(this)" title="Asiatisch/Nudeln">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M12 21a9 9 0 0 0 9-9H3a9 9 0 0 0 9 9Z"/><path d="M7 21h10"/><path d="M6 8c1-2 3-3 6-3s5 1 6 3"/><path d="M6 12h12"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="kebab" onclick="selectCategoryIcon(this)" title="Döner/Kebab">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M12 3v18"/><ellipse cx="12" cy="6" rx="4" ry="2"/><ellipse cx="12" cy="10" rx="5" ry="2"/><ellipse cx="12" cy="14" rx="4" ry="2"/><ellipse cx="12" cy="18" rx="3" ry="1.5"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Vorspeisen & Suppen -->
                        <div class="icon-section">
                            <span class="icon-section-label">Vorspeisen & Suppen</span>
                            <div class="icon-row">
                                <button type="button" class="category-icon-btn" data-icon="soup" onclick="selectCategoryIcon(this)" title="Suppe">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M12 21a9 9 0 0 0 9-9H3a9 9 0 0 0 9 9Z"/><path d="M7 21h10"/><path d="M9.5 4c0 .5.5 1 .5 1.5s-.5 1-.5 1.5"/><path d="M14.5 4c0 .5.5 1 .5 1.5s-.5 1-.5 1.5"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="appetizer" onclick="selectCategoryIcon(this)" title="Vorspeisen">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><circle cx="12" cy="12" r="9"/><path d="M12 3v4"/><circle cx="12" cy="12" r="3"/><path d="M8 10h8"/><path d="M8 14h8"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="bread" onclick="selectCategoryIcon(this)" title="Brot & Gebäck">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M5 10c0-4 3-6 7-6s7 2 7 6c0 2-1 3-2 4H7c-1-1-2-2-2-4z"/><path d="M7 14v6h10v-6"/><path d="M9 10c0-1 1-2 3-2s3 1 3 2"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="fries" onclick="selectCategoryIcon(this)" title="Pommes/Beilagen">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M6 9h12l-1 12H7L6 9z"/><path d="M8 9V6"/><path d="M11 9V4"/><path d="M14 9V5"/><path d="M17 9V7"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Desserts & Süßes -->
                        <div class="icon-section">
                            <span class="icon-section-label">Desserts & Süßes</span>
                            <div class="icon-row">
                                <button type="button" class="category-icon-btn" data-icon="cake" onclick="selectCategoryIcon(this)" title="Kuchen">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1"/><path d="M2 21h20"/><path d="M12 4v7"/><circle cx="12" cy="3" r="1"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="icecream" onclick="selectCategoryIcon(this)" title="Eis">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="m7 11 4.08 10.35a1 1 0 0 0 1.84 0L17 11"/><path d="M17 7A5 5 0 0 0 7 7"/><path d="M17 7a2 2 0 0 1 0 4H7a2 2 0 0 1 0-4"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="cookie" onclick="selectCategoryIcon(this)" title="Kekse">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><circle cx="12" cy="12" r="9"/><circle cx="8" cy="9" r="1"/><circle cx="15" cy="8" r="1"/><circle cx="10" cy="14" r="1"/><circle cx="15" cy="14" r="1"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="croissant" onclick="selectCategoryIcon(this)" title="Croissant/Frühstück">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="m4.6 13.11 5.79-3.21c1.89-1.05 4.79 1.78 3.71 3.71l-3.22 5.81C8.8 23.16.79 15.23 4.6 13.11Z"/><path d="m10.5 9.5-1-2.29C9.2 6.48 8.8 6 8 6H4.5C2.79 6 2 6.5 2 8.5a7.71 7.71 0 0 0 2 4.83"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="chocolate" onclick="selectCategoryIcon(this)" title="Schokolade">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><rect x="4" y="6" width="16" height="14" rx="2"/><path d="M4 10h16"/><path d="M4 14h16"/><path d="M10 6v14"/><path d="M14 6v14"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Getränke -->
                        <div class="icon-section">
                            <span class="icon-section-label">Getränke</span>
                            <div class="icon-row">
                                <button type="button" class="category-icon-btn" data-icon="coffee" onclick="selectCategoryIcon(this)" title="Kaffee">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" y1="2" x2="6" y2="4"/><line x1="10" y1="2" x2="10" y2="4"/><line x1="14" y1="2" x2="14" y2="4"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="tea" onclick="selectCategoryIcon(this)" title="Tee">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M17 8h2a2 2 0 0 1 2 2v1a3 3 0 0 1-3 3h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><path d="M6 2c.6 1 1 2 1 3 0 1-.4 2-1 3"/><path d="M10 2c.6 1 1 2 1 3 0 1-.4 2-1 3"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="softdrink" onclick="selectCategoryIcon(this)" title="Softdrinks">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M15.2 22H8.8a2 2 0 0 1-2-1.79L5 3h14l-1.81 17.21A2 2 0 0 1 15.2 22Z"/><path d="M6 12a5 5 0 0 1 6 0 5 5 0 0 0 6 0"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="juice" onclick="selectCategoryIcon(this)" title="Saft/Smoothie">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M8 22h8l-1-14H9l-1 14z"/><path d="M6 4h12l-1 4H7L6 4z"/><circle cx="12" cy="12" r="2"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="wine" onclick="selectCategoryIcon(this)" title="Wein">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M8 22h8"/><path d="M12 15v7"/><path d="M12 15a5 5 0 0 0 5-5c0-2-.5-4-2-8H9c-1.5 4-2 6-2 8a5 5 0 0 0 5 5Z"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="beer" onclick="selectCategoryIcon(this)" title="Bier">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M17 11h1a3 3 0 0 1 0 6h-1"/><path d="M5 8v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8"/><path d="M5 8h12V6a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v2"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="cocktail" onclick="selectCategoryIcon(this)" title="Cocktails">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M8 22h8"/><path d="M12 15v7"/><path d="m19 3-7 8-7-8h14z"/><circle cx="15" cy="6" r="1"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Spezial -->
                        <div class="icon-section">
                            <span class="icon-section-label">Spezial</span>
                            <div class="icon-row">
                                <button type="button" class="category-icon-btn" data-icon="utensils" onclick="selectCategoryIcon(this)" title="Hauptgerichte">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="kids" onclick="selectCategoryIcon(this)" title="Kindergerichte">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><circle cx="12" cy="8" r="5"/><path d="M12 13v8"/><path d="M8 17h8"/><path d="M10 6c0-.5.5-1 1-1"/><path d="M14 6c0-.5-.5-1-1-1"/><path d="M10 9h4"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="spicy" onclick="selectCategoryIcon(this)" title="Scharf">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="special" onclick="selectCategoryIcon(this)" title="Tagesangebot">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                </button>
                                <button type="button" class="category-icon-btn" data-icon="halal" onclick="selectCategoryIcon(this)" title="Halal">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="22" height="22"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="selectedCategoryIcon" value="beef">
                </div>
                <button type="button" id="saveCategoryBtn" class="btn btn-primary" style="width: 100%; margin-top: 16px;">Kategorie erstellen</button>
            </div>
        </div>
    </div>
</div>
<script>
document.getElementById('saveCategoryBtn').addEventListener('click', async function() {
    var name = document.getElementById('newCategoryName').value;
    if (!name) { alert('Bitte Kategorie-Name eingeben'); return; }
    var rid = (typeof currentMenuRestaurant !== 'undefined' && currentMenuRestaurant) ? currentMenuRestaurant : RESTAURANT_ID;
    this.disabled = true; this.textContent = 'Speichert...';
    try {
        var client = sb || window.sb;
        if (client) {
            var { data, error } = await client.from('menu_categories').insert({ restaurant_id: rid, name: name, sort_order: (typeof menuCategories !== 'undefined' ? menuCategories.length : 0) + 1 }).select();
            if (error) throw new Error(error.message);
            // Frisch laden
            var { data: cats } = await client.from('menu_categories').select('*').eq('restaurant_id', rid).order('sort_order');
            if (cats) { menuCategories = cats; window.menuCategories = cats; }
            var { data: items } = await client.from('menu_items').select('*').eq('restaurant_id', rid).order('sort_order');
            if (items) { menuItems = items; window.menuItems = items; }
        }
        document.getElementById('addCategoryModal').style.display = 'none';
        document.getElementById('newCategoryName').value = '';
        if (typeof renderMenuCategories === 'function') renderMenuCategories();
        if (typeof updateMenuStats === 'function') updateMenuStats();
        if (typeof showToast === 'function') showToast('Kategorie "' + name + '" erstellt!', 'success');
    } catch(e) { alert('Fehler: ' + e.message); }
    this.disabled = false; this.textContent = 'Kategorie erstellen';
});
</script>

<!-- Gericht hinzufügen Modal -->
<div class="modal-overlay" id="addMenuItemModal" style="z-index: 10006; display: none;">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <h2 class="modal-title" style="font-family: 'Playfair Display', serif;">Gericht hinzufügen</h2>
            <button class="modal-close" onclick="closeModal('addMenuItemModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <div id="addMenuItemForm">
                <div class="form-group">
                    <label class="form-label">Kategorie *</label>
                    <select class="form-select" id="menuItemCategory" required>
                        <option value="">Kategorie wählen...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="menuItemName" required placeholder="z.B. Wiener Schnitzel">
                </div>
                <div class="form-group">
                    <label class="form-label">Beschreibung</label>
                    <textarea class="form-input" id="menuItemDescription" rows="2" placeholder="z.B. Mit Pommes und Salat"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Preis (€) *</label>
                        <input type="number" class="form-input" id="menuItemPrice" required step="0.10" min="0" placeholder="12.90">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Artikelnummer</label>
                        <input type="text" class="form-input" id="menuItemNumber" placeholder="101">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Bild URL (optional)</label>
                    <input type="url" class="form-input" id="menuItemImage" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label class="form-label">Optionen / Extras</label>
                    <div id="menuItemOptionsContainer">
                        <!-- Dynamisch hinzugefügt -->
                    </div>
                    <button type="button" onclick="addMenuItemOption()" style="padding: 8px 12px; background: var(--bg-secondary); border: 1px dashed var(--border-color); border-radius: 8px; font-size: 13px; cursor: pointer; color: var(--slate); margin-top: 8px;">
                        + Option hinzufügen
                    </button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="menuItemActive" checked>
                            <span>Aktiv</span>
                        </label>
                    </div>
                </div>
                
                <!-- Eigenschaften als Icon-Toggle-Buttons -->
                <div class="form-group">
                    <label class="form-label">Eigenschaften</label>
                    
                    <!-- Fleischarten -->
                    <p style="font-size: 11px; color: var(--slate); margin: 8px 0 6px; text-transform: uppercase; letter-spacing: 0.5px;">Fleisch & Fisch</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
                        <button type="button" class="property-toggle-btn" id="toggleBeef" onclick="togglePropertyBtn('Beef')">
                            <div class="property-icon beef">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <circle cx="12.5" cy="8.5" r="2.5"/><path d="M12.5 2a6.5 6.5 0 0 0-6.22 4.6c-1.1 3.13-.78 3.9-3.18 6.08A3 3 0 0 0 5 18c4 0 8.4-1.8 11.4-4.3A6.5 6.5 0 0 0 12.5 2Z"/>
                                </svg>
                            </div>
                            <span>Rind</span>
                        </button>
                        <input type="checkbox" id="menuItemBeef" style="display: none;">
                        
                        <button type="button" class="property-toggle-btn" id="toggleChicken" onclick="togglePropertyBtn('Chicken')">
                            <div class="property-icon chicken">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <path d="M15.5 8.5a4 4 0 1 0-5.66 5.66l5.66-5.66z"/><path d="m11.25 12.75-5.66 5.66a2 2 0 0 0 2.83 2.83l5.66-5.66"/><circle cx="18" cy="6" r="2"/>
                                </svg>
                            </div>
                            <span>Huhn</span>
                        </button>
                        <input type="checkbox" id="menuItemChicken" style="display: none;">
                        
                        <button type="button" class="property-toggle-btn" id="togglePork" onclick="togglePropertyBtn('Pork')">
                            <div class="property-icon pork">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <ellipse cx="12" cy="13" rx="8" ry="6"/><circle cx="8" cy="11" r="1"/><circle cx="16" cy="11" r="1"/><ellipse cx="12" cy="15" rx="2" ry="1"/><path d="M4 10c-2-1-2-4 0-4"/><path d="M20 10c2-1 2-4 0-4"/>
                                </svg>
                            </div>
                            <span>Schwein</span>
                        </button>
                        <input type="checkbox" id="menuItemPork" style="display: none;">
                        
                        <button type="button" class="property-toggle-btn" id="toggleLamb" onclick="togglePropertyBtn('Lamb')">
                            <div class="property-icon lamb">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <ellipse cx="12" cy="14" rx="7" ry="5"/><circle cx="12" cy="8" r="4"/><path d="M8 6c-1-2-3-2-4 0"/><path d="M16 6c1-2 3-2 4 0"/>
                                </svg>
                            </div>
                            <span>Lamm</span>
                        </button>
                        <input type="checkbox" id="menuItemLamb" style="display: none;">
                        
                        <button type="button" class="property-toggle-btn" id="toggleFish" onclick="togglePropertyBtn('Fish')">
                            <div class="property-icon fish">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <path d="M6.5 12c.94-3.46 4.94-6 8.5-6 3.56 0 6.06 2.54 7 6-.94 3.47-3.44 6-7 6-3.56 0-7.56-2.53-8.5-6Z"/><path d="M18 12v.5"/><path d="M2 10l3 2-3 2"/>
                                </svg>
                            </div>
                            <span>Fisch</span>
                        </button>
                        <input type="checkbox" id="menuItemFish" style="display: none;">
                        
                        <button type="button" class="property-toggle-btn" id="toggleSeafood" onclick="togglePropertyBtn('Seafood')">
                            <div class="property-icon seafood">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <path d="M18 9c0 3-2.5 6-6.5 6S5 15 5 12c0-4 3-7 7-7 2 0 4 1 5 3"/><path d="M18 9c1.5 0 3 1 3 3s-1 3-3 3"/><path d="M5 16l-2 4"/><path d="M8 17l-1 3"/>
                                </svg>
                            </div>
                            <span>Meer</span>
                        </button>
                        <input type="checkbox" id="menuItemSeafood" style="display: none;">
                    </div>
                    
                    <!-- Ernährungsweise -->
                    <p style="font-size: 11px; color: var(--slate); margin: 8px 0 6px; text-transform: uppercase; letter-spacing: 0.5px;">Ernährungsweise</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
                        <button type="button" class="property-toggle-btn" id="toggleVegetarian" onclick="togglePropertyBtn('Vegetarian')">
                            <div class="property-icon vegetarian">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <path d="M2 2a26.6 26.6 0 0 1 10 20c.9-6.82 1.5-9.5 4-14 4.5-8 6-4 6-4"/>
                                    <path d="M2 2c2 2.5 3.5 5 4.5 7.5"/>
                                </svg>
                            </div>
                            <span>Vegetarisch</span>
                        </button>
                        <input type="checkbox" id="menuItemVegetarian" style="display: none;">
                        
                        <button type="button" class="property-toggle-btn" id="toggleVegan" onclick="togglePropertyBtn('Vegan')">
                            <div class="property-icon vegan">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/>
                                    <path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/>
                                </svg>
                            </div>
                            <span>Vegan</span>
                        </button>
                        <input type="checkbox" id="menuItemVegan" style="display: none;">
                        
                        <button type="button" class="property-toggle-btn" id="toggleHalal" onclick="togglePropertyBtn('Halal')">
                            <div class="property-icon halal">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/>
                                </svg>
                            </div>
                            <span>Halal</span>
                        </button>
                        <input type="checkbox" id="menuItemHalal" style="display: none;">
                        
                        <button type="button" class="property-toggle-btn" id="toggleBio" onclick="togglePropertyBtn('Bio')">
                            <div class="property-icon bio">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
                                </svg>
                            </div>
                            <span>Bio</span>
                        </button>
                        <input type="checkbox" id="menuItemBio" style="display: none;">
                    </div>
                    
                    <!-- Allergene & Zusatzstoffe -->
                    <p style="font-size: 11px; color: var(--slate); margin: 8px 0 6px; text-transform: uppercase; letter-spacing: 0.5px;">Allergene & Hinweise</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
                        <button type="button" class="property-toggle-btn" id="toggleGluten" onclick="togglePropertyBtn('Gluten')">
                            <div class="property-icon gluten">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <path d="M12 2v8"/><path d="M8 6c0 2 2 4 4 4s4-2 4-4"/><path d="M6 10c0 2 3 4 6 4s6-2 6-4"/><path d="M4 14c0 2 4 4 8 4s8-2 8-4"/><path d="M12 18v4"/>
                                </svg>
                            </div>
                            <span>Weizen</span>
                        </button>
                        <input type="checkbox" id="menuItemGluten" style="display: none;">
                        
                        <button type="button" class="property-toggle-btn" id="toggleGlutenFree" onclick="togglePropertyBtn('GlutenFree')">
                            <div class="property-icon glutenfree">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <circle cx="12" cy="12" r="10"/><path d="m8 12 3 3 5-5"/>
                                </svg>
                            </div>
                            <span>Glutenfrei</span>
                        </button>
                        <input type="checkbox" id="menuItemGlutenFree" style="display: none;">
                        
                        <button type="button" class="property-toggle-btn" id="toggleLactoseFree" onclick="togglePropertyBtn('LactoseFree')">
                            <div class="property-icon lactosefree">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <path d="M8 2h8l1 7H7l1-7z"/><path d="M7 9h10v10a3 3 0 0 1-3 3h-4a3 3 0 0 1-3-3V9z"/><path d="m4 4 16 16"/>
                                </svg>
                            </div>
                            <span>Laktosefrei</span>
                        </button>
                        <input type="checkbox" id="menuItemLactoseFree" style="display: none;">
                        
                        <button type="button" class="property-toggle-btn" id="toggleNuts" onclick="togglePropertyBtn('Nuts')">
                            <div class="property-icon nuts">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <ellipse cx="12" cy="12" rx="6" ry="8"/><path d="M12 4c-2 0-4 2-4 4"/>
                                </svg>
                            </div>
                            <span>Nüsse</span>
                        </button>
                        <input type="checkbox" id="menuItemNuts" style="display: none;">
                        
                        <button type="button" class="property-toggle-btn" id="toggleAlcohol" onclick="togglePropertyBtn('Alcohol')">
                            <div class="property-icon alcohol">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <path d="M8 22h8"/><path d="M12 15v7"/><path d="M12 15a5 5 0 0 0 5-5c0-2-.5-4-2-8H9c-1.5 4-2 6-2 8a5 5 0 0 0 5 5Z"/>
                                </svg>
                            </div>
                            <span>Alkohol</span>
                        </button>
                        <input type="checkbox" id="menuItemAlcohol" style="display: none;">
                    </div>
                    
                    <!-- Spezial -->
                    <p style="font-size: 11px; color: var(--slate); margin: 8px 0 6px; text-transform: uppercase; letter-spacing: 0.5px;">Spezial</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button type="button" class="property-toggle-btn" id="togglePopular" onclick="togglePropertyBtn('Popular')">
                            <div class="property-icon popular">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                </svg>
                            </div>
                            <span>Beliebt</span>
                        </button>
                        <input type="checkbox" id="menuItemPopular" style="display: none;">
                        
                        <button type="button" class="property-toggle-btn" id="toggleSpicy" onclick="togglePropertyBtn('Spicy')">
                            <div class="property-icon spicy">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
                                </svg>
                            </div>
                            <span>Scharf</span>
                        </button>
                        <input type="checkbox" id="menuItemSpicy" style="display: none;">
                        
                        <button type="button" class="property-toggle-btn" id="toggleHomemade" onclick="togglePropertyBtn('Homemade')">
                            <div class="property-icon homemade">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20">
                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
                                </svg>
                            </div>
                            <span>Hausgemacht</span>
                        </button>
                        <input type="checkbox" id="menuItemHomemade" style="display: none;">
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="button" onclick="document.getElementById('addMenuItemModal').style.display='none';" style="flex: 1; padding: 14px; background: var(--bg-secondary); border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; color: var(--dark);">
                        Abbrechen
                    </button>
                    <button type="button" id="saveMenuItemBtn" style="flex: 2; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer;">
                        Gericht speichern
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
document.getElementById('saveMenuItemBtn').addEventListener('click', async function() {
    console.log('💾 Gericht speichern geklickt');
    
    var categoryId = document.getElementById('menuItemCategory').value;
    var name = document.getElementById('menuItemName').value.trim();
    var description = document.getElementById('menuItemDescription').value.trim();
    var priceStr = document.getElementById('menuItemPrice').value.trim();
    
    if (!categoryId || !name || !priceStr) {
        alert('Bitte Kategorie, Name und Preis ausfüllen');
        return;
    }
    
    var price = parseFloat(priceStr.replace(',', '.'));
    if (isNaN(price) || price <= 0) {
        alert('Bitte gültigen Preis eingeben');
        return;
    }
    
    var restaurantId = currentMenuRestaurant || window.currentMenuRestaurant || RESTAURANT_ID;
    
    var client = sb || window.sb;
    if (!client) {
        alert('Verbindungsfehler - bitte Seite neu laden');
        return;
    }
    
    var btn = document.getElementById('saveMenuItemBtn');
    btn.disabled = true;
    btn.textContent = 'Speichert...';
    
    try {
        var { data, error } = await client.from('menu_items').insert({
            restaurant_id: restaurantId,
            category_id: categoryId,
            name: name,
            description: description,
            base_price: price,
            is_available: true,
            sort_order: 1
        }).select();
        
        if (error) throw new Error(error.message);
        
        console.log('✅ Gespeichert:', data[0].id);
        document.getElementById('addMenuItemModal').style.display = 'none';
        document.getElementById('menuItemName').value = '';
        document.getElementById('menuItemDescription').value = '';
        document.getElementById('menuItemPrice').value = '';
        try {
            var { data: fi } = await client.from('menu_items').select('*').eq('restaurant_id', restaurantId).order('sort_order');
            if (fi) { menuItems = fi; window.menuItems = fi; }
            var { data: fc } = await client.from('menu_categories').select('*').eq('restaurant_id', restaurantId).order('sort_order');
            if (fc) { menuCategories = fc; window.menuCategories = fc; }
        } catch(re) {}
        if (typeof renderMenuCategories === 'function') renderMenuCategories();
        if (typeof updateMenuStats === 'function') updateMenuStats();
        if (typeof showToast === 'function') showToast('"' + name + '" hinzugefügt!', 'success');
        
    } catch(e) {
        console.log('❌ Fehler:', e);
        alert('Fehler: ' + e.message);
    }
    
    btn.disabled = false;
    btn.textContent = 'Gericht speichern';
});
</script>

<!-- Accept Order Modal -->
<div class="modal-overlay" id="acceptOrderModal" style="z-index: 10005; display: none;">
    <div class="modal" style="max-width: 420px;">
        <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; background: var(--cream); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="20" height="20">
                        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                    </svg>
                </div>
                <div>
                    <h2 class="modal-title" style="font-family: 'Playfair Display', serif; font-size: 18px;">Bestellung annehmen</h2>
                    <p style="font-size: 12px; color: var(--slate); margin: 0;">Wartezeit für den Kunden festlegen</p>
                </div>
            </div>
            <button class="modal-close" onclick="closeModal('acceptOrderModal')">×</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <!-- Order Info -->
            <div id="acceptOrderInfo" style="margin-bottom: 20px;">
                <!-- Wird dynamisch gefüllt -->
            </div>
            
            <!-- Zeit-Optionen -->
            <p style="font-size: 14px; font-weight: 600; color: var(--dark); margin-bottom: 12px;">Geschätzte Wartezeit:</p>
            
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px;">
                <button type="button" class="time-option-btn" data-time="15" onclick="selectTimeOption(this, 15)">
                    <span class="time-value">15</span>
                    <span class="time-unit">Min</span>
                </button>
                <button type="button" class="time-option-btn" data-time="25" onclick="selectTimeOption(this, 25)">
                    <span class="time-value">25</span>
                    <span class="time-unit">Min</span>
                </button>
                <button type="button" class="time-option-btn" data-time="35" onclick="selectTimeOption(this, 35)">
                    <span class="time-value">35</span>
                    <span class="time-unit">Min</span>
                </button>
                <button type="button" class="time-option-btn" data-time="45" onclick="selectTimeOption(this, 45)">
                    <span class="time-value">45</span>
                    <span class="time-unit">Min</span>
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px;">
                <button type="button" class="time-option-btn" data-time="60" onclick="selectTimeOption(this, 60)">
                    <span class="time-value">60</span>
                    <span class="time-unit">Min</span>
                </button>
                <button type="button" class="time-option-btn" data-time="75" onclick="selectTimeOption(this, 75)">
                    <span class="time-value">75</span>
                    <span class="time-unit">Min</span>
                </button>
                <button type="button" class="time-option-btn" data-time="90" onclick="selectTimeOption(this, 90)">
                    <span class="time-value">90</span>
                    <span class="time-unit">Min</span>
                </button>
                <button type="button" class="time-option-btn" data-time="120" onclick="selectTimeOption(this, 120)">
                    <span class="time-value">120</span>
                    <span class="time-unit">Min</span>
                </button>
            </div>
            
            <!-- Eigene Zeit -->
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                <span style="font-size: 13px; color: var(--slate); white-space: nowrap;">Eigene Zeit:</span>
                <div style="flex: 1; position: relative;">
                    <input type="number" id="customTimeInput" min="5" max="180" placeholder="z.B. 50" 
                           style="width: 100%; padding: 12px 50px 12px 16px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 16px; font-weight: 600;"
                           oninput="document.querySelectorAll('.time-option-btn').forEach(b => b.classList.remove('selected'))">
                    <span style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: var(--slate); font-size: 14px;">Min</span>
                </div>
            </div>
            
            <!-- Info -->
            <div style="background: #fef3c7; border-radius: 12px; padding: 12px; display: flex; gap: 10px; margin-bottom: 20px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2" width="20" height="20" style="flex-shrink: 0; margin-top: 2px;">
                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <p style="font-size: 13px; color: #92400e; margin: 0; line-height: 1.4;">
                    Der Kunde wird per WhatsApp/SMS benachrichtigt und sieht die geschätzte Zeit in seinem Profil.
                </p>
            </div>
        </div>
        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; gap: 12px;">
            <button onclick="closeModal('acceptOrderModal')" style="flex: 1; padding: 14px; background: var(--bg-secondary); border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; color: var(--dark);">
                Abbrechen
            </button>
            <button onclick="confirmAcceptOrder()" style="flex: 2; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                Annehmen
            </button>
        </div>
    </div>
</div>

<!-- Bestellbestätigung Modal -->
<div class="modal-overlay" id="orderConfirmationModal" style="z-index: 10004; display: none;">
    <div class="modal" style="max-width: 450px; text-align: center;">
        <div style="padding: 40px 20px;">
            <div style="width: 80px; height: 80px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; border: 2px solid var(--primary);">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" width="40" height="40">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
            </div>
            <h2 style="font-family: 'Playfair Display', serif; font-size: 24px; color: var(--text-primary); margin-bottom: 8px;">Bestellung erfolgreich!</h2>
            <p style="color: var(--slate); margin-bottom: 20px;">Ihre Bestellnummer: <strong style="color: var(--text-primary);" id="confirmOrderNumber">XX-0001</strong></p>
            
            <!-- Status Tracker - KIN Design -->
            <div class="order-status-tracker" id="orderStatusTracker" style="display: flex; justify-content: space-between; margin: 24px 0; padding: 0 10px;">
                <div class="status-step active" style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                    <div class="status-icon" style="width: 36px; height: 36px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div class="status-label" style="font-size: 11px; color: var(--text-primary); margin-top: 6px;">Eingegangen</div>
                </div>
                <div class="status-step" style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                    <div class="status-icon" style="width: 36px; height: 36px; border-radius: 50%; background: var(--bg-secondary); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; color: var(--slate);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
                        </svg>
                    </div>
                    <div class="status-label" style="font-size: 11px; color: var(--slate); margin-top: 6px;">Zubereitung</div>
                </div>
                <div class="status-step" style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                    <div class="status-icon" style="width: 36px; height: 36px; border-radius: 50%; background: var(--bg-secondary); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; color: var(--slate);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <circle cx="9" cy="20" r="1.5"/><circle cx="17" cy="20" r="1.5"/>
                            <path d="M3 3h2l.4 2M7 13h10l4-8H5.4"/>
                        </svg>
                    </div>
                    <div class="status-label" style="font-size: 11px; color: var(--slate); margin-top: 6px;">Unterwegs</div>
                </div>
                <div class="status-step" style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                    <div class="status-icon" style="width: 36px; height: 36px; border-radius: 50%; background: var(--bg-secondary); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; color: var(--slate);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div class="status-label" style="font-size: 11px; color: var(--slate); margin-top: 6px;">Abgeschlossen</div>
                </div>
            </div>
            
            <p style="color: var(--slate); font-size: 14px; margin-top: 20px;" id="confirmEstimatedTime">Geschätzte Lieferzeit: ca. 30-45 Minuten</p>
            
            <div style="background: var(--bg-secondary); border-radius: 10px; padding: 16px; margin-top: 20px; text-align: left;">
                <div style="font-size: 12px; color: var(--slate); margin-bottom: 8px;">Hinweis</div>
                <p style="font-size: 13px; color: var(--text-primary); line-height: 1.5;">Sie erhalten eine Benachrichtigung, sobald Ihre Bestellung in Zubereitung ist. Bei Fragen kontaktieren Sie das Restaurant direkt.</p>
            </div>
            
            <button onclick="closeModal('orderConfirmationModal')" style="width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 24px;">
                Verstanden
            </button>
        </div>
    </div>
</div>

<!-- Warenkorb Button (Fixed) -->
<div class="cart-button-fixed" id="cartButtonFixed" onclick="openCartPanel()">
    <div class="cart-button-left">
        <div class="cart-count-badge" id="cartCountBadge">0</div>
        <span class="cart-button-text">Warenkorb</span>
    </div>
    <span class="cart-button-price" id="cartButtonPrice">0,00 €</span>
</div>



<script>
// ==================== ONLINE BESTELLUNG - JAVASCRIPT ====================

// Globale Variablen
var currentOrderRestaurant = null;
var orderCart = [];
var currentMenuItem = null;
var currentItemOptions = [];
var currentItemQty = 1;
var orderType = 'pickup';
var tipAmount = 1; // Standard: 1€
var paymentMethod = 'cash';
var deliveryTimeType = 'asap';

// Speisekarte öffnen
async function openMenuModal(restaurantId) {
    console.log('🍽️ openMenuModal:', restaurantId);
    
    var restaurant = { id: restaurantId, name: 'Restaurant' };
    
    // Methode 1: Supabase Client
    var client = sb || window.sb;
    if (client) {
        try {
            var result = await client.from('restaurants').select('*').eq('id', restaurantId).single();
            if (!result.error && result.data) restaurant = result.data;
        } catch(e) {}
    }
    
    // Methode 2: REST API Fallback
    if (restaurant.name === 'Restaurant') {
        try {
            var res = await fetch(SUPA_URL + '/rest/v1/restaurants?id=eq.' + restaurantId, { headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY } });
            var data = await res.json();
            if (data && data[0]) restaurant = data[0];
        } catch(e) {}
    }
    
    console.log('✅ Restaurant:', restaurant.name);
    
    currentOrderRestaurant = restaurant;
    window.currentOrderRestaurant = restaurant;
    
    var nameEl = document.getElementById('menuRestaurantName');
    if (nameEl) nameEl.textContent = restaurant.name;
    
    // Modal öffnen
    var modal = document.getElementById('menuModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
    }
    
    // Kategorien und Items laden
    loadMenuCategoriesFromDB(restaurantId);
}

// Kategorien aus Supabase laden
async function loadMenuCategoriesFromDB(restaurantId) {
    console.log('📂 loadMenuCategoriesFromDB:', restaurantId);
    
    var container = document.getElementById('menuCategoryTabs');
    if (!container) return;
    
    container.innerHTML = '<div style="padding: 8px 16px; color: var(--slate);">Lädt...</div>';
    
    var categories = null;
    
    // Methode 1: Supabase Client
    var client = sb || window.sb;
    if (client) {
        try {
            var result = await client.from('menu_categories').select('*').eq('restaurant_id', restaurantId).order('sort_order');
            if (!result.error && result.data) categories = result.data;
        } catch(e) { console.log('sb Fehler:', e); }
    }
    
    // Methode 2: REST API Fallback
    if (!categories) {
        try {
            var url = SUPA_URL + '/rest/v1/menu_categories?restaurant_id=eq.' + restaurantId + '&order=sort_order';
            var res = await fetch(url, { headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY } });
            categories = await res.json();
        } catch(e) { console.log('REST Fehler:', e); }
    }
    
    console.log('✅ Kategorien:', categories ? categories.length : 0);
    
    if (categories && categories.length > 0) {
        var html = '<div class="menu-category-tab active" onclick="selectMenuCategory(null, this)">Alle</div>';
        categories.forEach(function(cat) {
            html += '<div class="menu-category-tab" onclick="selectMenuCategory(\'' + cat.id + '\', this)">' + cat.name + '</div>';
        });
        container.innerHTML = html;
        loadMenuItems(restaurantId, null);
        return;
    }
    
    container.innerHTML = '<div style="padding: 8px 16px; color: var(--slate);">Keine Kategorien</div>';
    loadMenuItems(restaurantId, null);
}

// Demo Kategorien laden (Fallback)
function loadMenuCategories(restaurantId) {
    const categories = [
        { id: 'pizza', name: 'Pizza', icon: 'pizza' },
        { id: 'pasta', name: 'Pasta', icon: 'pasta' },
        { id: 'salate', name: 'Salate', icon: 'salad' },
        { id: 'burger', name: 'Burger', icon: 'burger' },
        { id: 'getraenke', name: 'Getränke', icon: 'drink' }
    ];
    
    const container = document.getElementById('menuCategoryTabs');
    container.innerHTML = `
        <div class="menu-category-tab active" onclick="selectMenuCategory(null, this)">Alle</div>
        ${categories.map(cat => `
            <div class="menu-category-tab" onclick="selectMenuCategory('${cat.id}', this)">
                ${cat.name}
            </div>
        `).join('')}
    `;
}

// Kategorie auswählen
function selectMenuCategory(categoryId, el) {
    document.querySelectorAll('.menu-category-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    loadMenuItems(currentOrderRestaurant.id, categoryId);
}

// Badge Icons für Gäste-Ansicht (KIN Design)
function getMenuBadgeIcons(item) {
    let badges = '';
    
    // Beliebt
    if (item.popular || item.is_popular) {
        badges += `<div class="menu-badge popular" title="Beliebt">
            <svg viewBox="0 0 24 24" fill="#f59e0b" stroke="#f59e0b" stroke-width="1" width="14" height="14">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
        </div>`;
    }
    
    // Fleischarten
    if (item.is_beef || item.beef) {
        badges += `<div class="menu-badge beef" title="Rind">
            <svg viewBox="0 0 24 24" fill="none" stroke="#b91c1c" stroke-width="1.5" width="14" height="14">
                <circle cx="12.5" cy="8.5" r="2.5"/><path d="M12.5 2a6.5 6.5 0 0 0-6.22 4.6c-1.1 3.13-.78 3.9-3.18 6.08A3 3 0 0 0 5 18c4 0 8.4-1.8 11.4-4.3A6.5 6.5 0 0 0 12.5 2Z"/>
            </svg>
        </div>`;
    }
    
    if (item.is_chicken || item.chicken) {
        badges += `<div class="menu-badge chicken" title="Huhn">
            <svg viewBox="0 0 24 24" fill="none" stroke="#ea580c" stroke-width="1.5" width="14" height="14">
                <path d="M15.5 8.5a4 4 0 1 0-5.66 5.66l5.66-5.66z"/><path d="m11.25 12.75-5.66 5.66a2 2 0 0 0 2.83 2.83l5.66-5.66"/><circle cx="18" cy="6" r="2"/>
            </svg>
        </div>`;
    }
    
    if (item.is_pork || item.pork) {
        badges += `<div class="menu-badge pork" title="Schwein">
            <svg viewBox="0 0 24 24" fill="none" stroke="#db2777" stroke-width="1.5" width="14" height="14">
                <ellipse cx="12" cy="13" rx="8" ry="6"/><circle cx="8" cy="11" r="1"/><circle cx="16" cy="11" r="1"/><ellipse cx="12" cy="15" rx="2" ry="1"/><path d="M4 10c-2-1-2-4 0-4"/><path d="M20 10c2-1 2-4 0-4"/>
            </svg>
        </div>`;
    }
    
    if (item.is_lamb || item.lamb) {
        badges += `<div class="menu-badge lamb" title="Lamm">
            <svg viewBox="0 0 24 24" fill="none" stroke="#7c3aed" stroke-width="1.5" width="14" height="14">
                <ellipse cx="12" cy="14" rx="7" ry="5"/><circle cx="12" cy="8" r="4"/><path d="M8 6c-1-2-3-2-4 0"/><path d="M16 6c1-2 3-2 4 0"/>
            </svg>
        </div>`;
    }
    
    if (item.is_fish || item.fish) {
        badges += `<div class="menu-badge fish" title="Fisch">
            <svg viewBox="0 0 24 24" fill="none" stroke="#0284c7" stroke-width="1.5" width="14" height="14">
                <path d="M6.5 12c.94-3.46 4.94-6 8.5-6 3.56 0 6.06 2.54 7 6-.94 3.47-3.44 6-7 6-3.56 0-7.56-2.53-8.5-6Z"/><path d="M18 12v.5"/><path d="M2 10l3 2-3 2"/>
            </svg>
        </div>`;
    }
    
    if (item.is_seafood || item.seafood) {
        badges += `<div class="menu-badge seafood" title="Meeresfrüchte">
            <svg viewBox="0 0 24 24" fill="none" stroke="#0891b2" stroke-width="1.5" width="14" height="14">
                <path d="M18 9c0 3-2.5 6-6.5 6S5 15 5 12c0-4 3-7 7-7 2 0 4 1 5 3"/><path d="M18 9c1.5 0 3 1 3 3s-1 3-3 3"/><path d="M5 16l-2 4"/><path d="M8 17l-1 3"/>
            </svg>
        </div>`;
    }
    
    // Vegetarisch & Vegan
    if (item.is_vegetarian || item.vegetarian) {
        badges += `<div class="menu-badge vegetarian" title="Vegetarisch">
            <svg viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="1.5" width="14" height="14">
                <path d="M2 2a26.6 26.6 0 0 1 10 20c.9-6.82 1.5-9.5 4-14 4.5-8 6-4 6-4"/><path d="M2 2c2 2.5 3.5 5 4.5 7.5"/>
            </svg>
        </div>`;
    }
    
    if (item.is_vegan || item.vegan) {
        badges += `<div class="menu-badge vegan" title="Vegan">
            <svg viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="1.5" width="14" height="14">
                <path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/>
            </svg>
        </div>`;
    }
    
    // Allergene & Zusatzstoffe
    if (item.is_gluten || item.gluten || item.contains_wheat) {
        badges += `<div class="menu-badge gluten" title="Enthält Gluten/Weizen">
            <svg viewBox="0 0 24 24" fill="none" stroke="#ca8a04" stroke-width="1.5" width="14" height="14">
                <path d="M12 2v8"/><path d="M8 6c0 2 2 4 4 4s4-2 4-4"/><path d="M6 10c0 2 3 4 6 4s6-2 6-4"/><path d="M4 14c0 2 4 4 8 4s8-2 8-4"/><path d="M12 18v4"/>
            </svg>
        </div>`;
    }
    
    if (item.is_gluten_free || item.gluten_free) {
        badges += `<div class="menu-badge glutenfree" title="Glutenfrei">
            <svg viewBox="0 0 24 24" fill="none" stroke="#65a30d" stroke-width="1.5" width="14" height="14">
                <circle cx="12" cy="12" r="10"/><path d="m8 12 3 3 5-5"/>
            </svg>
        </div>`;
    }
    
    if (item.is_lactose_free || item.lactose_free) {
        badges += `<div class="menu-badge lactosefree" title="Laktosefrei">
            <svg viewBox="0 0 24 24" fill="none" stroke="#0d9488" stroke-width="1.5" width="14" height="14">
                <path d="M8 2h8l1 7H7l1-7z"/><path d="M7 9h10v10a3 3 0 0 1-3 3h-4a3 3 0 0 1-3-3V9z"/><path d="m4 4 16 16"/>
            </svg>
        </div>`;
    }
    
    if (item.is_nuts || item.nuts || item.contains_nuts) {
        badges += `<div class="menu-badge nuts" title="Enthält Nüsse">
            <svg viewBox="0 0 24 24" fill="none" stroke="#92400e" stroke-width="1.5" width="14" height="14">
                <ellipse cx="12" cy="12" rx="6" ry="8"/><path d="M12 4c-2 0-4 2-4 4"/>
            </svg>
        </div>`;
    }
    
    // Scharf
    if (item.is_spicy || item.spicy) {
        const level = item.spicy || 1;
        badges += `<div class="menu-badge spicy" title="Scharf${level > 1 ? ' (' + level + 'x)' : ''}">
            <svg viewBox="0 0 24 24" fill="${level > 1 ? '#dc2626' : 'none'}" stroke="#dc2626" stroke-width="1.5" width="14" height="14">
                <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
            </svg>
        </div>`;
    }
    
    // Halal & Kosher
    if (item.is_halal || item.halal) {
        badges += `<div class="menu-badge halal" title="Halal">
            <svg viewBox="0 0 24 24" fill="none" stroke="#4f46e5" stroke-width="1.5" width="14" height="14">
                <circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/>
            </svg>
        </div>`;
    }
    
    // Alkohol
    if (item.is_alcohol || item.alcohol) {
        badges += `<div class="menu-badge alcohol" title="Enthält Alkohol">
            <svg viewBox="0 0 24 24" fill="none" stroke="#7c3aed" stroke-width="1.5" width="14" height="14">
                <path d="M8 22h8"/><path d="M12 15v7"/><path d="M12 15a5 5 0 0 0 5-5c0-2-.5-4-2-8H9c-1.5 4-2 6-2 8a5 5 0 0 0 5 5Z"/>
            </svg>
        </div>`;
    }
    
    // Bio
    if (item.is_bio || item.bio || item.organic) {
        badges += `<div class="menu-badge bio" title="Bio">
            <svg viewBox="0 0 24 24" fill="none" stroke="#15803d" stroke-width="1.5" width="14" height="14">
                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
            </svg>
        </div>`;
    }
    
    // Hausgemacht
    if (item.is_homemade || item.homemade) {
        badges += `<div class="menu-badge homemade" title="Hausgemacht">
            <svg viewBox="0 0 24 24" fill="none" stroke="#b45309" stroke-width="1.5" width="14" height="14">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
        </div>`;
    }
    
    return badges;
}

// Produkte laden (aus Supabase oder Fallback)
async function loadMenuItems(restaurantId, categoryId) {
    console.log('📦 loadMenuItems:', restaurantId, categoryId);
    
    var container = document.getElementById('menuItemsList');
    if (!container) return;
    
    container.innerHTML = '<div style="text-align: center; padding: 40px;"><p style="color: var(--slate);">Lädt Gerichte...</p></div>';
    
    var items = null;
    
    // Methode 1: Supabase Client
    var client = sb || window.sb;
    if (client) {
        try {
            var query = client.from('menu_items').select('*').eq('restaurant_id', restaurantId).eq('is_available', true).order('sort_order');
            if (categoryId) query = query.eq('category_id', categoryId);
            var result = await query;
            if (!result.error && result.data) items = result.data;
        } catch(e) { console.log('sb Fehler:', e); }
    }
    
    // Methode 2: REST API Fallback
    if (!items) {
        try {
            var url = SUPA_URL + '/rest/v1/menu_items?restaurant_id=eq.' + restaurantId + '&is_available=eq.true&order=sort_order';
            if (categoryId) url += '&category_id=eq.' + categoryId;
            var res = await fetch(url, { headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY } });
            items = await res.json();
        } catch(e) { console.log('REST Fehler:', e); }
    }
    
    console.log('✅ Items geladen:', items ? items.length : 0);
    
    if (items && items.length > 0) {
        renderMenuItemsForGuest(items);
    } else {
        container.innerHTML = '<div style="text-align: center; padding: 60px 20px;"><p style="color: var(--slate);">Keine Gerichte verfügbar</p></div>';
    }
}

// Gerichte für Gäste rendern
function renderMenuItemsForGuest(items) {
    var container = document.getElementById('menuItemsList');
    
    if (!items || items.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--slate); padding: 40px;">Keine Produkte in dieser Kategorie</p>';
        return;
    }
    
    var html = '';
    // Items global cachen für sicheren Zugriff per Index
    window._menuDisplayItems = items;
    items.forEach(function(item, idx) {
        var price = item.base_price || item.price || 0;
        html += '<div class="menu-item-card" onclick="openItemOptions(\'' + item.id + '\', window._menuDisplayItems[' + idx + '])">';
        if (item.image_url) {
            html += '<img src="' + item.image_url + '" class="menu-item-image" alt="' + (item.name || '').replace(/"/g, '') + '">';
        } else {
            html += '<div class="menu-item-image" style="display: flex; align-items: center; justify-content: center; background: var(--bg-secondary);">';
            html += '<svg viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="1.5" width="32" height="32" opacity="0.4"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/></svg>';
            html += '</div>';
        }
        html += '<div class="menu-item-info">';
        html += '<div class="menu-item-name">' + (item.name || '') + '</div>';
        html += '<div class="menu-item-description">' + (item.description || '') + '</div>';
        html += '<div class="menu-item-bottom">';
        html += '<div class="menu-item-price">' + price.toFixed(2).replace('.', ',') + ' €</div>';
        html += '</div></div></div>';
    });
    container.innerHTML = html;
}

// Produkt-Options öffnen
function openItemOptions(itemId, item) {
    // Preis normalisieren
    var itemPrice = item.base_price || item.price || 0;
    item.price = itemPrice;
    
    currentMenuItem = item;
    currentItemOptions = [];
    currentItemQty = 1;
    
    document.getElementById('itemOptionsTitle').textContent = item.name;
    document.getElementById('itemQtyValue').textContent = '1';
    
    // Options Body
    const body = document.getElementById('itemOptionsBody');
    
    // Demo Option Groups für Pizza
    let optionsHtml = '';
    
    if (item.name.includes('Pizza')) {
        optionsHtml = `
            <!-- Größe -->
            <div class="option-group">
                <div class="option-group-header">
                    <div class="option-group-title">Größe wählen</div>
                    <div class="option-group-required">Pflicht</div>
                </div>
                <div class="option-item selected" onclick="selectOption(this, 'size', 'klein', 0, 'replace')" data-group="size">
                    <div class="option-radio">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" width="14" height="14">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div class="option-info">
                        <div class="option-name">Klein (26cm)</div>
                    </div>
                    <div class="option-price">${formatPrice(itemPrice)}</div>
                </div>
                <div class="option-item" onclick="selectOption(this, 'size', 'gross', ${itemPrice + 2}, 'replace')" data-group="size">
                    <div class="option-radio">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" width="14" height="14">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div class="option-info">
                        <div class="option-name">Groß (32cm)</div>
                    </div>
                    <div class="option-price">${formatPrice(itemPrice + 2)}</div>
                </div>
                <div class="option-item" onclick="selectOption(this, 'size', 'familie', ${itemPrice + 5}, 'replace')" data-group="size">
                    <div class="option-radio">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" width="14" height="14">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div class="option-info">
                        <div class="option-name">Familie (40cm)</div>
                    </div>
                    <div class="option-price">${formatPrice(itemPrice + 5)}</div>
                </div>
            </div>
            
            <!-- Extras -->
            <div class="option-group">
                <div class="option-group-header">
                    <div class="option-group-title">Extra Zutaten</div>
                </div>
                <div class="option-item" onclick="toggleExtra(this, 'extra', 'kaese', 1.50)" data-group="extra">
                    <div class="option-checkbox">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" width="14" height="14">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div class="option-info">
                        <div class="option-name">Extra Käse</div>
                    </div>
                    <div class="option-price">+ 1,50 €</div>
                </div>
                <div class="option-item" onclick="toggleExtra(this, 'extra', 'salami', 1.50)" data-group="extra">
                    <div class="option-checkbox">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" width="14" height="14">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div class="option-info">
                        <div class="option-name">Extra Salami</div>
                    </div>
                    <div class="option-price">+ 1,50 €</div>
                </div>
                <div class="option-item" onclick="toggleExtra(this, 'extra', 'pilze', 1.00)" data-group="extra">
                    <div class="option-checkbox">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" width="14" height="14">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div class="option-info">
                        <div class="option-name">Pilze</div>
                    </div>
                    <div class="option-price">+ 1,00 €</div>
                </div>
            </div>
        `;
        
        // Default Größe setzen
        currentItemOptions = [{ group: 'size', option: 'klein', price: itemPrice, price_type: 'replace' }];
    }
    
    // Anmerkungen immer
    optionsHtml += `
        <div class="option-group">
            <div class="option-group-header">
                <div class="option-group-title">Anmerkungen</div>
            </div>
            <textarea class="form-textarea" id="itemNotes" placeholder="Besondere Wünsche (z.B. ohne Zwiebeln)"></textarea>
        </div>
    `;
    
    body.innerHTML = optionsHtml;
    
    updateItemTotalPrice();
    openModal('itemOptionsModal');
}

// Single-Select Option
function selectOption(el, group, option, price, priceType) {
    // Deselect others in group
    el.parentElement.querySelectorAll('.option-item').forEach(item => {
        item.classList.remove('selected');
    });
    el.classList.add('selected');
    
    // Update options
    currentItemOptions = currentItemOptions.filter(o => o.group !== group);
    currentItemOptions.push({ group, option, price, price_type: priceType });
    
    updateItemTotalPrice();
}

// Multi-Select Extra
function toggleExtra(el, group, option, price) {
    el.classList.toggle('selected');
    
    const existingIndex = currentItemOptions.findIndex(o => o.group === group && o.option === option);
    if (existingIndex > -1) {
        currentItemOptions.splice(existingIndex, 1);
    } else {
        currentItemOptions.push({ group, option, price, price_type: 'add' });
    }
    
    updateItemTotalPrice();
}

// Menge ändern
function changeItemQty(delta) {
    currentItemQty = Math.max(1, currentItemQty + delta);
    document.getElementById('itemQtyValue').textContent = currentItemQty;
    updateItemTotalPrice();
}

// Preis berechnen
function calculateItemPrice() {
    let price = currentMenuItem.base_price || currentMenuItem.price || 0;
    
    currentItemOptions.forEach(opt => {
        if (opt.price_type === 'replace') {
            price = opt.price;
        } else if (opt.price_type === 'add') {
            price += opt.price;
        }
    });
    
    return price;
}

function updateItemTotalPrice() {
    const unitPrice = calculateItemPrice();
    const total = unitPrice * currentItemQty;
    document.getElementById('itemTotalPrice').textContent = formatPrice(total);
}

// In den Warenkorb
function addItemToCart() {
    const unitPrice = calculateItemPrice();
    const notes = document.getElementById('itemNotes')?.value || '';
    
    const cartItem = {
        id: Date.now().toString(),
        menu_item_id: currentMenuItem.id,
        name: currentMenuItem.name,
        quantity: currentItemQty,
        unit_price: unitPrice,
        total_price: unitPrice * currentItemQty,
        selected_options: [...currentItemOptions],
        notes: notes
    };
    
    orderCart.push(cartItem);
    
    closeModal('itemOptionsModal');
    updateCartBadges();
    showToast(currentMenuItem.name + ' hinzugefügt!');
}

// Cart Badges aktualisieren
function updateCartBadges() {
    const count = orderCart.reduce((sum, item) => sum + item.quantity, 0);
    const total = orderCart.reduce((sum, item) => sum + item.total_price, 0);
    
    // Menu Badge
    const menuBadge = document.getElementById('menuCartBadge');
    if (menuBadge) {
        menuBadge.textContent = count;
        menuBadge.style.display = count > 0 ? 'flex' : 'none';
    }
    
    // Fixed Button - nur anzeigen wenn Artikel im Warenkorb UND nicht im Dashboard
    const fixedBtn = document.getElementById('cartButtonFixed');
    const countBadge = document.getElementById('cartCountBadge');
    const priceSpan = document.getElementById('cartButtonPrice');
    
    if (fixedBtn) {
        // Prüfen ob wir im Dashboard sind (dann Button verstecken)
        const isDashboard = document.getElementById('dashboardView')?.classList.contains('active') || 
                           document.querySelector('.dash-section.active');
        
        if (count > 0 && !isDashboard) {
            fixedBtn.classList.add('visible');
        } else {
            fixedBtn.classList.remove('visible');
        }
    }
    if (countBadge) countBadge.textContent = count;
    if (priceSpan) priceSpan.textContent = formatPrice(total);
    
    console.log('🛒 Warenkorb Update:', count, 'Artikel,', formatPrice(total));
}

// Warenkorb Panel öffnen
function openCartPanel() {
    renderCartItems();
    document.getElementById('cartPanel').classList.add('open');
}

function closeCartPanel() {
    document.getElementById('cartPanel').classList.remove('open');
}

// Warenkorb rendern
function renderCartItems() {
    const container = document.getElementById('cartItemsList');
    const emptyState = document.getElementById('cartEmptyState');
    const footer = document.getElementById('cartFooter');
    
    if (orderCart.length === 0) {
        emptyState.style.display = 'block';
        footer.style.display = 'none';
        return;
    }
    
    emptyState.style.display = 'none';
    footer.style.display = 'block';
    
    let html = '';
    orderCart.forEach(item => {
        const optionsText = item.selected_options
            .filter(o => o.price_type === 'add')
            .map(o => o.option)
            .join(', ');
        
        html += `
            <div class="cart-item">
                <div class="cart-item-qty">${item.quantity}x</div>
                <div class="cart-item-info">
                    <div class="cart-item-name">${item.name}</div>
                    ${optionsText ? `<div class="cart-item-options">+ ${optionsText}</div>` : ''}
                    ${item.notes ? `<div class="cart-item-options">"${item.notes}"</div>` : ''}
                </div>
                <div class="cart-item-price">${formatPrice(item.total_price)}</div>
                <button class="cart-item-edit" onclick="removeCartItem('${item.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html + document.getElementById('cartEmptyState').outerHTML;
    
    // Summen
    const subtotal = orderCart.reduce((sum, item) => sum + item.total_price, 0);
    const deliveryFee = orderType === 'delivery' ? 2.50 : 0;
    const total = subtotal + deliveryFee;
    
    document.getElementById('cartSubtotal').textContent = formatPrice(subtotal);
    document.getElementById('cartDeliveryFee').textContent = formatPrice(deliveryFee);
    document.getElementById('cartDeliveryRow').style.display = orderType === 'delivery' ? 'flex' : 'none';
    document.getElementById('cartTotal').textContent = formatPrice(total);
}

function removeCartItem(itemId) {
    orderCart = orderCart.filter(item => item.id !== itemId);
    renderCartItems();
    updateCartBadges();
}

// Checkout öffnen
function openCheckout() {
    if (orderCart.length === 0) return;
    
    closeCartPanel();
    
    // Trinkgeld auf Standard setzen (1€)
    tipAmount = 1;
    document.querySelectorAll('#checkoutModal .kin-time-btn').forEach(function(b) {
        if (b.id && b.id.startsWith('tipBtn')) {
            b.classList.remove('active');
        }
    });
    var tipBtn1 = document.getElementById('tipBtn1');
    if (tipBtn1) tipBtn1.classList.add('active');
    if (document.getElementById('checkoutCustomTip')) {
        document.getElementById('checkoutCustomTip').value = '';
    }
    
    // Bestellarten basierend auf Restaurant-Settings filtern
    updateCheckoutOrderTypes();
    
    // Checkout-Summen berechnen
    updateCheckoutTotals();
    
    openModal('checkoutModal');
}

// Bestellart setzen
// MwSt-Sätze nach deutschem Recht
var VAT_RATES = {
    pickup: 0.07,      // 7% für Abholung
    delivery: 0.07     // 7% für Lieferung
};

function setOrderType(type, btn) {
    orderType = type;
    document.querySelectorAll('.order-type-btn[data-type]').forEach(function(b) { b.classList.remove('active'); });
    if (btn) btn.classList.add('active');
    
    // Lieferadresse ein-/ausblenden
    var deliverySec = document.getElementById('deliveryAddressSection');
    if (deliverySec) deliverySec.style.display = type === 'delivery' ? 'block' : 'none';
    
    // MwSt-Info aktualisieren
    var vatInfoText = document.getElementById('vatInfoText');
    if (vatInfoText) {
        vatInfoText.innerHTML = 'Abholung & Lieferung: <strong>7% MwSt</strong> (§12 Abs. 2 UStG)';
    }
    
    renderCartItems();
    updateCheckoutTotals();
}

// Checkout-Summen mit MwSt und Trinkgeld berechnen
function updateCheckoutTotals() {
    const subtotal = orderCart.reduce((sum, item) => sum + item.total_price, 0);
    const deliveryFee = orderType === 'delivery' ? 2.50 : 0;
    const vatRate = VAT_RATES[orderType] || 0.07;
    const tip = tipAmount || 0;
    
    // Netto-Berechnung (Preis ist Brutto)
    const nettoSubtotal = subtotal / (1 + vatRate);
    const vatAmount = subtotal - nettoSubtotal;
    const total = subtotal + deliveryFee + tip;
    
    // Anzeige aktualisieren
    document.getElementById('checkoutSubtotal').textContent = formatPrice(subtotal);
    document.getElementById('checkoutDeliveryFee').textContent = formatPrice(deliveryFee);
    document.getElementById('checkoutDeliveryRow').style.display = orderType === 'delivery' ? 'flex' : 'none';
    
    // Trinkgeld-Zeile
    const tipRow = document.getElementById('checkoutTipRow');
    if (tipRow) {
        tipRow.style.display = tip > 0 ? 'flex' : 'none';
        document.getElementById('checkoutTipAmount').textContent = formatPrice(tip);
    }
    
    // MwSt-Zeile
    let vatRow = document.getElementById('checkoutVatRow');
    if (!vatRow) {
        // MwSt-Zeile erstellen wenn nicht vorhanden
        const totalRow = document.getElementById('checkoutTotalRow');
        if (totalRow) {
            vatRow = document.createElement('div');
            vatRow.id = 'checkoutVatRow';
            vatRow.className = 'checkout-summary-row';
            vatRow.innerHTML = `
                <span id="checkoutVatLabel">davon MwSt (7%)</span>
                <span id="checkoutVatAmount">0,00 €</span>
            `;
            totalRow.parentNode.insertBefore(vatRow, totalRow);
        }
    }
    
    if (vatRow) {
        document.getElementById('checkoutVatLabel').textContent = `davon MwSt (${Math.round(vatRate * 100)}%)`;
        document.getElementById('checkoutVatAmount').textContent = formatPrice(vatAmount);
    }
    
    document.getElementById('checkoutTotal').textContent = formatPrice(total);
}

// Lieferzeit setzen
function setDeliveryTime(type, btn) {
    deliveryTimeType = type;
    btn.parentElement.querySelectorAll('.order-type-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    document.getElementById('scheduledTimeSelector').style.display = type === 'scheduled' ? 'block' : 'none';
}

// Zahlungsmethode
function setPaymentMethod(method, el) {
    paymentMethod = method;
    el.parentElement.querySelectorAll('.option-item').forEach(item => item.classList.remove('selected'));
    el.classList.add('selected');
}

// Bestellung absenden - Professionelle Validierung
async function submitOrder() {
    console.log('🛒 submitOrder() aufgerufen');
    
    // Hilfsfunktion: Feld markieren und hinscrollem
    function markError(fieldId, msg) {
        var el = document.getElementById(fieldId);
        if (el) {
            el.style.border = '2px solid #ef4444';
            el.style.boxShadow = '0 0 0 3px rgba(239,68,68,0.2)';
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            el.focus();
            // Nach 5 Sekunden Reset
            setTimeout(function() { 
                el.style.border = ''; el.style.boxShadow = ''; 
            }, 5000);
        }
        showToast(msg, 'error');
    }
    
    try {
    // Pflichtfelder prüfen
    const name = document.getElementById('checkoutName')?.value?.trim() || '';
    const phone = document.getElementById('checkoutPhone')?.value?.trim() || '';
    const agbAccepted = document.getElementById('checkoutAgbAccepted')?.checked;
    
    console.log('📝 Validierung:', {name: !!name, phone: !!phone, agb: agbAccepted, orderType: orderType});
    
    // Validierung: Name
    if (!name) {
        markError('checkoutName', '⚠️ Bitte Name eingeben');
        return;
    }
    
    // Validierung: Telefon
    if (!phone) {
        markError('checkoutPhone', '⚠️ Bitte Telefonnummer eingeben');
        return;
    }
    
    // Validierung: Telefonnummer Format
    const phoneClean = phone.replace(/[\s\-\/]/g, '');
    if (phoneClean.length < 6) {
        markError('checkoutPhone', '⚠️ Telefonnummer zu kurz');
        return;
    }
    
    // Validierung: AGB
    if (!agbAccepted) {
        markError('checkoutAgbAccepted', '⚠️ Bitte AGB akzeptieren');
        return;
    }
    
    var deliveryAddress = null;
    var tableNumber = null;
    
    // Validierung: Lieferadresse bei Lieferung
    if (orderType === 'delivery') {
        const street = document.getElementById('checkoutStreet')?.value?.trim() || '';
        const houseNumber = document.getElementById('checkoutHouseNumber')?.value?.trim() || '';
        const zip = document.getElementById('checkoutZip')?.value?.trim() || '';
        const city = document.getElementById('checkoutCity')?.value?.trim() || 'Ostfriesland';
        
        if (!street) {
            markError('checkoutStreet', '⚠️ Bitte Straße eingeben');
            return;
        }
        
        if (!zip || !/^\d{5}$/.test(zip)) {
            markError('checkoutZip', '⚠️ Bitte gültige PLZ eingeben (5 Ziffern)');
            return;
        }
        
        deliveryAddress = { street: street, house_number: houseNumber, zip: zip, city: city };
    }
    
    console.log('✅ Validierung bestanden');
    
    // Button deaktivieren während Verarbeitung
    const submitBtn = document.getElementById('submitOrderBtn');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> Bestellung wird verarbeitet...';
    
    // MwSt berechnen
    const vatRate = VAT_RATES[orderType] || 0.07;
    const subtotal = orderCart.reduce((sum, item) => sum + item.total_price, 0);
    const nettoSubtotal = subtotal / (1 + vatRate);
    const vatAmount = subtotal - nettoSubtotal;
    const deliveryFee = orderType === 'delivery' ? 2.50 : 0;
    const tip = tipAmount || 0;
    const total = subtotal + deliveryFee + tip;
    
    // Order Nummer generieren (Format: KI-JJMMTT-XXXX)
    const now = new Date();
    const dateCode = String(now.getFullYear()).slice(-2) + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
    const orderNumber = 'KI-' + dateCode + '-' + String(Math.floor(Math.random() * 9999)).padStart(4, '0');
    
    // Order Objekt erstellen
    const order = {
        id: 'temp-' + Date.now(),
        order_number: orderNumber,
        restaurant_id: currentOrderRestaurant?.id,
        restaurant_name: currentOrderRestaurant?.name || 'Restaurant',
        status: 'received',
        order_type: orderType,
        customer_name: name,
        customer_phone: phone,
        customer_email: document.getElementById('checkoutEmailConfirm')?.value.trim() || null,
        table_number: tableNumber,
        delivery_address: deliveryAddress,
        delivery_notes: document.getElementById('checkoutDeliveryNotes')?.value.trim() || null,
        items: orderCart.map(item => ({
            name: item.name,
            quantity: item.quantity,
            price: item.total_price,
            options: item.options?.join(', ') || ''
        })),
        subtotal: subtotal,
        vat_rate: vatRate,
        vat_amount: vatAmount,
        delivery_fee: deliveryFee,
        tip: tip,
        total: total,
        payment_method: paymentMethod,
        notes: document.getElementById('checkoutNotes')?.value.trim() || null,
        created_at: new Date().toISOString(),
        estimated_minutes: null,
        estimated_time: null
    };
    
    // In Supabase speichern
    try {
        const response = await fetch(SUPABASE_URL + '/rest/v1/orders', {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify({
                order_number: orderNumber,
                restaurant_id: currentOrderRestaurant?.id,
                status: 'received',
                order_type: orderType,
                customer_name: name,
                customer_phone: phone,
                customer_email: order.customer_email || null,
                delivery_address: deliveryAddress,
                subtotal: subtotal,
                delivery_fee: deliveryFee,
                tip: tip,
                total: total,
                payment_method: paymentMethod,
                customer_notes: order.notes || null
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            order.id = data[0]?.id || order.id;
            
            // Order Items speichern
            for (const item of orderCart) {
                await fetch(SUPABASE_URL + '/rest/v1/order_items', {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        order_id: order.id,
                        item_name: item.name,
                        quantity: item.quantity,
                        base_price: item.base_price || item.unit_price || 0,
                        unit_price: item.unit_price || item.base_price || 0,
                        total_price: item.total_price || 0,
                        selected_options: item.selected_options || []
                    })
                });
            }
            console.log('✅ Bestellung gespeichert:', order.id);
        } else {
            console.log('⚠️ Order API:', response.status, await response.text());
        }
    } catch(e) {
        console.log('Order Save Error (continuing locally):', e);
    }
    
    // Button wieder aktivieren
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalBtnText;
    
    // === ZUERST: UI aktualisieren (muss sofort passieren) ===
    document.getElementById('confirmOrderNumber').textContent = orderNumber;
    
    var estimatedText = '';
    if (orderType === 'delivery') {
        estimatedText = 'Geschätzte Lieferzeit: ca. 30-45 Minuten';
    } else if (orderType === 'pickup') {
        estimatedText = 'Abholbereit in ca. 15-25 Minuten';
    } else {
        estimatedText = 'Wird an Ihren Tisch serviert';
    }
    document.getElementById('confirmEstimatedTime').textContent = estimatedText;
    
    // Checkout schließen + Bestätigung anzeigen
    closeModal('checkoutModal');
    openModal('orderConfirmationModal');
    showToast('Bestellung erfolgreich aufgegeben!', 'success');
    
    // Warenkorb leeren
    orderCart = [];
    tipAmount = 1;
    updateCartBadges();
    
    // Formular zurücksetzen
    if (document.getElementById('checkoutAgbAccepted')) document.getElementById('checkoutAgbAccepted').checked = false;
    if (document.getElementById('checkoutCustomTip')) document.getElementById('checkoutCustomTip').value = '';
    
    // === DANACH: Optionale Aktionen (dürfen crashen ohne UI zu blockieren) ===
    try {
        saveCustomerOrder(order);
    } catch(e) { console.log('saveCustomerOrder Error:', e); }
    
    try {
        if (document.getElementById('checkoutSendEmail')?.checked) {
            var email = document.getElementById('checkoutEmailConfirm')?.value?.trim();
            if (email) sendOrderConfirmationEmail(order, email);
        }
    } catch(e) { console.log('Email Error:', e); }
    
    try {
        if (document.getElementById('checkoutPushNotifications')?.checked) {
            registerOrderPushNotifications(order.id);
        }
    } catch(e) { console.log('Push Error:', e); }
    
    try {
        addToOrderHistory(order);
    } catch(e) { console.log('OrderHistory Error:', e); }
    
    } catch(submitError) {
        console.error('❌ submitOrder FEHLER:', submitError);
        showToast('Fehler: ' + submitError.message, 'error');
        // Button wieder aktivieren
        var btn = document.getElementById('submitOrderBtn');
        if (btn) { btn.disabled = false; btn.innerHTML = 'Jetzt zahlungspflichtig bestellen'; }
    }
}

function setTip(amount, btn) {
    tipAmount = amount;
    
    // Buttons aktualisieren
    document.querySelectorAll('#checkoutModal .kin-time-btn').forEach(b => {
        if (b.id && b.id.startsWith('tipBtn')) {
            b.classList.remove('active');
        }
    });
    if (btn) btn.classList.add('active');
    
    // Custom Tip Feld leeren
    document.getElementById('checkoutCustomTip').value = '';
    
    updateCheckoutTotals();
}

function setCustomTip(value) {
    const amount = parseFloat(value) || 0;
    tipAmount = Math.max(0, amount);
    
    // Preset Buttons deaktivieren
    document.querySelectorAll('#checkoutModal .kin-time-btn').forEach(b => {
        if (b.id && b.id.startsWith('tipBtn')) {
            b.classList.remove('active');
        }
    });
    
    updateCheckoutTotals();
}

// ==================== E-MAIL BESTÄTIGUNG ====================

async function sendOrderConfirmationEmail(order, email) {
    // E-Mail Template
    const emailContent = {
        to: email,
        subject: `Bestellbestätigung ${order.order_number} - Kiek mol in`,
        template: 'order_confirmation',
        data: {
            orderNumber: order.order_number,
            customerName: order.customer_name,
            restaurantName: order.restaurant_name,
            orderType: order.order_type === 'delivery' ? '🚗 Lieferung' : '🛍️ Abholung',
            items: order.items,
            subtotal: formatPrice(order.subtotal),
            deliveryFee: formatPrice(order.delivery_fee),
            tip: formatPrice(order.tip || 0),
            total: formatPrice(order.total),
            estimatedTime: order.order_type === 'delivery' ? '30-45 Minuten' : '15-25 Minuten',
            deliveryAddress: order.delivery_address ? 
                `${order.delivery_address.street} ${order.delivery_address.house_number}, ${order.delivery_address.zip} ${order.delivery_address.city}` : null
        }
    };
    
    try {
        // Supabase Edge Function oder externer E-Mail-Service
        const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(emailContent)
        });
        
        if (response.ok) {
            console.log('✅ Bestätigungs-E-Mail gesendet an:', email);
        } else {
            console.log('⚠️ E-Mail konnte nicht gesendet werden');
        }
    } catch(e) {
        console.log('E-Mail Service nicht verfügbar:', e);
        // Fallback: E-Mail lokal speichern für späteren Versand
        localStorage.setItem('pending_email_' + order.id, JSON.stringify(emailContent));
    }
}

// ==================== PUSH-BENACHRICHTIGUNGEN ====================

async function registerOrderPushNotifications(orderId) {
    // Push-Berechtigung anfragen
    requestNotificationPermission();
    
    // Polling starten
    startOrderStatusPolling();
    
    // Erste Test-Notification nach 3 Sekunden
    setTimeout(function() {
        sendBrowserNotification(
            '📱 Benachrichtigungen aktiv',
            'Du wirst über den Status deiner Bestellung informiert.'
        );
    }, 3000);
    
    console.log('✅ Benachrichtigungen aktiviert für Bestellung:', orderId);
}

function showPushNotification(title, body) {
    sendBrowserNotification(title, body);
}

// Simulierte Status-Updates (in Produktion: WebSocket/Realtime)
function simulateOrderStatusUpdate(orderId, newStatus) {
    const statusMessages = {
        'preparing': { title: 'Zubereitung gestartet', body: 'Ihre Bestellung wird jetzt zubereitet!' },
        'ready': { title: 'Bestellung fertig', body: 'Ihre Bestellung ist zur Abholung bereit!' },
        'out_for_delivery': { title: 'Unterwegs zu Ihnen', body: 'Ihr Fahrer ist auf dem Weg!' },
        'delivered': { title: 'Guten Appetit!', body: 'Ihre Bestellung wurde geliefert.' }
    };
    
    const msg = statusMessages[newStatus];
    if (msg) {
        showPushNotification(msg.title, msg.body);
    }
}

// ==================== BESTELLHISTORIE ====================

var orderHistory = [];

function loadOrderHistory() {
    const stored = localStorage.getItem('kmi_order_history');
    if (stored) {
        orderHistory = JSON.parse(stored);
    }
    return orderHistory;
}

function addToOrderHistory(order) {
    loadOrderHistory();
    
    // Bestellung hinzufügen (neueste zuerst)
    orderHistory.unshift({
        id: order.id,
        order_number: order.order_number,
        restaurant_name: order.restaurant_name,
        order_type: order.order_type,
        items: order.items,
        total: order.total,
        status: order.status,
        created_at: order.created_at
    });
    
    // Maximal 50 Bestellungen speichern
    if (orderHistory.length > 50) {
        orderHistory = orderHistory.slice(0, 50);
    }
    
    localStorage.setItem('kmi_order_history', JSON.stringify(orderHistory));
    console.log('✅ Bestellung zur Historie hinzugefügt');
}

function showOrderHistory() {
    loadOrderHistory();
    
    let modal = document.getElementById('orderHistoryModal');
    if (!modal) {
        const modalHtml = `
            <div class="modal-overlay" id="orderHistoryModal" style="z-index: 10025; display: none;">
                <div class="modal-container" style="max-width: 500px; max-height: 90vh;">
                    <div class="modal-header">
                        <h3 class="modal-title" style="color: var(--text-primary);">Meine Bestellungen</h3>
                        <button class="modal-close" onclick="document.getElementById('orderHistoryModal').style.display='none'">×</button>
                    </div>
                    <div class="modal-body" id="orderHistoryContent" style="max-height: 70vh; overflow-y: auto;"></div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        modal = document.getElementById('orderHistoryModal');
    }
    
    const content = document.getElementById('orderHistoryContent');
    
    if (orderHistory.length === 0) {
        content.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--slate);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 12px; opacity: 0.5;">
                    <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/>
                    <rect x="9" y="3" width="6" height="4" rx="1"/>
                    <path d="M9 12h6"/><path d="M9 16h6"/>
                </svg>
                <p style="font-size: 15px; font-weight: 500; color: var(--text-primary);">Noch keine Bestellungen</p>
                <p style="font-size: 13px; margin-top: 4px;">Ihre Bestellhistorie erscheint hier.</p>
            </div>
        `;
    } else {
        let html = '';
        orderHistory.forEach(order => {
            const date = new Date(order.created_at);
            const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const timeStr = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            const orderTypeLabel = order.order_type === 'delivery' ? 'Lieferung' : (order.order_type === 'pickup' ? 'Abholung' : 'Im Restaurant');
            const statusLabel = getOrderStatusLabel(order.status);
            
            html += `
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div>
                            <div style="font-size: 11px; color: var(--slate);">${dateStr} um ${timeStr}</div>
                            <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${order.restaurant_name}</div>
                            <div style="font-size: 12px; color: var(--slate);">${order.order_number} · ${orderTypeLabel}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${formatPrice(order.total)}</div>
                            <span style="font-size: 11px; padding: 4px 8px; border-radius: 12px; background: var(--bg-card); color: var(--slate);">${statusLabel}</span>
                        </div>
                    </div>
                    <div style="font-size: 13px; color: var(--slate);">
                        ${order.items.map(item => `${item.quantity}× ${item.name}`).join(', ')}
                    </div>
                    <button onclick="reorderFromHistory('${order.id}')" style="width: 100%; margin-top: 12px; padding: 10px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; color: var(--primary); font-size: 13px; font-weight: 500; cursor: pointer;">
                        Erneut bestellen
                    </button>
                </div>
            `;
        });
        content.innerHTML = html;
    }
    
    modal.style.display = 'flex';
}

function getOrderStatusLabel(status) {
    const labels = {
        'received': 'Eingegangen',
        'confirmed': 'Bestätigt',
        'preparing': 'In Zubereitung',
        'ready': 'Bereit',
        'out_for_delivery': 'Unterwegs',
        'delivered': 'Geliefert',
        'completed': 'Abgeschlossen',
        'cancelled': 'Storniert'
    };
    return labels[status] || status;
}

function reorderFromHistory(orderId) {
    const order = orderHistory.find(o => o.id === orderId);
    if (!order) return;
    
    // Warenkorb leeren und mit alten Items füllen
    orderCart = [];
    
    order.items.forEach(item => {
        orderCart.push({
            id: Date.now() + Math.random(),
            name: item.name,
            quantity: item.quantity,
            base_price: item.price / item.quantity,
            total_price: item.price,
            options: item.options ? item.options.split(', ') : []
        });
    });
    
    updateCartBadges();
    document.getElementById('orderHistoryModal').style.display = 'none';
    openCartPanel();
    
    showToast('Artikel wurden in den Warenkorb gelegt', 'success');
}

// Hilfsfunktion: Preis formatieren
function formatPrice(price) {
    return price.toFixed(2).replace('.', ',') + ' €';
}

// ==================== ORDERS DASHBOARD ====================

var dashboardOrders = [];
var orderSoundEnabled = true;
var orderFilterStatus = 'all';
var ordersRealtimeChannel = null;
var ordersRestaurantFilter = '';

// Bestellungen aus Supabase laden
async function loadDashboardOrders() {
    const grid = document.getElementById('ordersGrid');
    const emptyState = document.getElementById('ordersEmptyState');
    
    // Bestelloptionen-Settings laden
    try { loadOrderSettings(); } catch(e) {}
    
    // Restaurant Select befüllen
    const restaurantSelect = document.getElementById('ordersRestaurantSelect');
    if (restaurantSelect && APP_DATA.restaurants) {
        const currentVal = restaurantSelect.value;
        restaurantSelect.innerHTML = '<option value="">Alle Restaurants</option>';
        APP_DATA.restaurants.forEach(r => {
            restaurantSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
        });
        restaurantSelect.value = currentVal;
    }
    
    if (!grid) return;
    
    // Loading State
    grid.innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
            <div class="loading-spinner" style="margin: 0 auto 12px;"></div>
            <p style="color: var(--slate);">Bestellungen werden geladen...</p>
        </div>
    `;
    
    try {
        // Heute Mitternacht für Filter
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const response = await fetch(`${SUPABASE_URL}/rest/v1/orders?select=*,order_items(*)&created_at=gte.${today.toISOString()}&order=created_at.desc`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            dashboardOrders = data.map(order => ({
                id: order.id,
                order_number: order.order_number,
                status: order.status,
                order_type: order.order_type,
                customer_name: order.customer_name,
                customer_phone: order.customer_phone,
                customer_email: order.customer_email,
                delivery_address: order.delivery_address,
                items: (order.order_items || []).map(item => ({
                    name: item.item_name,
                    quantity: item.quantity,
                    options: (item.selected_options || []).map(o => o.option_name || o.option).join(', '),
                    price: item.total_price
                })),
                subtotal: order.subtotal,
                delivery_fee: order.delivery_fee || 0,
                tip: order.tip || 0,
                discount: order.discount || 0,
                total: order.total,
                created_at: order.created_at,
                estimated_minutes: order.estimated_minutes,
                payment_method: order.payment_method,
                notes: order.notes
            }));
            
            console.log('✅ Bestellungen geladen:', dashboardOrders.length);
        } else {
            console.log('⚠️ Orders API Fehler:', response.status);
            // Fallback: Demo-Daten wenn keine Orders Tabelle existiert
            loadDemoOrders();
        }
    } catch (e) {
        console.log('⚠️ Orders Fehler:', e.message);
        // Fallback: Demo-Daten
        loadDemoOrders();
    }
    
    renderDashboardOrders();
    updateOrderStats();
    
    // Realtime Subscription starten
    setupOrdersRealtime();
}

// Demo-Daten als Fallback
function loadDemoOrders() {
    dashboardOrders = [
        {
            id: '1',
            order_number: 'KI-0001',
            status: 'received',
            order_type: 'delivery',
            customer_name: 'Max Mustermann',
            customer_phone: '+49 170 1234567',
            delivery_address: { street: 'Musterstraße', house_number: '12', zip: '26721', city: 'Emden' },
            items: [
                { name: 'Pizza Salami', quantity: 2, options: 'Groß, Extra Käse', price: 24.00 },
                { name: 'Cola 0,5l', quantity: 2, options: '', price: 5.00 }
            ],
            subtotal: 29.00,
            delivery_fee: 2.50,
            total: 31.50,
            created_at: new Date(Date.now() - 5 * 60000).toISOString(),
            payment_method: 'cash'
        },
        {
            id: '2',
            order_number: 'KI-0002',
            status: 'preparing',
            order_type: 'pickup',
            customer_name: 'Anna Schmidt',
            customer_phone: '+49 171 9876543',
            items: [
                { name: 'Spaghetti Bolognese', quantity: 1, options: '', price: 9.00 },
                { name: 'Tiramisu', quantity: 1, options: '', price: 4.50 }
            ],
            subtotal: 13.50,
            delivery_fee: 0,
            total: 13.50,
            created_at: new Date(Date.now() - 20 * 60000).toISOString(),
            payment_method: 'card_on_delivery'
        },
        {
            id: '3',
            order_number: 'KI-0003',
            status: 'ready',
            order_type: 'delivery',
            customer_name: 'Thomas Weber',
            customer_phone: '+49 172 5555555',
            delivery_address: { street: 'Hafenstraße', house_number: '5a', zip: '26721', city: 'Emden' },
            items: [
                { name: 'Pizza Margherita', quantity: 1, options: 'Familie', price: 13.00 },
                { name: 'Knoblauchbrot', quantity: 1, options: '', price: 3.50 }
            ],
            subtotal: 16.50,
            delivery_fee: 2.50,
            total: 19.00,
            created_at: new Date(Date.now() - 35 * 60000).toISOString(),
            payment_method: 'cash'
        },
        {
            id: '4',
            order_number: 'KI-0004',
            status: 'accepted',
            order_type: 'delivery',
            customer_name: 'Lisa Braun',
            customer_phone: '+49 173 1111111',
            delivery_address: { street: 'Marktplatz', house_number: '8', zip: '26721', city: 'Emden' },
            estimated_minutes: 40,
            items: [
                { name: 'Pizza Diavolo', quantity: 1, options: 'Groß', price: 12.50 },
                { name: 'Pizza Hawaii', quantity: 1, options: 'Klein', price: 10.00 },
                { name: 'Wasser 0,5l', quantity: 2, options: '', price: 4.00 }
            ],
            subtotal: 26.50,
            delivery_fee: 2.50,
            total: 29.00,
            created_at: new Date(Date.now() - 15 * 60000).toISOString(),
            payment_method: 'cash'
        }
    ];
    console.log('📋 Demo-Bestellungen geladen (DB noch nicht eingerichtet)');
}

// Realtime Subscription für neue Bestellungen
function setupOrdersRealtime() {
    // Nur wenn noch nicht aktiv
    if (ordersRealtimeChannel) return;
    
    const statusEl = document.getElementById('ordersConnectionStatus');
    
    try {
        // Supabase Realtime über WebSocket
        const wsUrl = SUPABASE_URL.replace('https://', 'wss://') + '/realtime/v1/websocket?apikey=' + SUPABASE_KEY + '&vsn=1.0.0';
        
        const ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
            console.log('🔌 Realtime verbunden');
            if (statusEl) {
                statusEl.innerHTML = '<span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></span> Live';
                statusEl.style.background = '#d1fae5';
                statusEl.style.color = '#059669';
            }
            
            // Subscribe to orders table
            const subscribeMsg = {
                topic: 'realtime:public:orders',
                event: 'phx_join',
                payload: {
                    config: {
                        broadcast: { self: true },
                        presence: { key: '' },
                        postgres_changes: [
                            { event: 'INSERT', schema: 'public', table: 'orders' },
                            { event: 'UPDATE', schema: 'public', table: 'orders' }
                        ]
                    }
                },
                ref: '1'
            };
            ws.send(JSON.stringify(subscribeMsg));
            
            // Heartbeat
            setInterval(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ topic: 'phoenix', event: 'heartbeat', payload: {}, ref: Date.now().toString() }));
                }
            }, 30000);
        };
        
        ws.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                
                if (msg.event === 'postgres_changes' && msg.payload?.data?.record) {
                    const record = msg.payload.data.record;
                    
                    if (msg.payload.data.type === 'INSERT') {
                        // Neue Bestellung!
                        console.log('🆕 Neue Bestellung:', record.order_number);
                        playOrderSound();
                        showToast('Neue Bestellung: #' + record.order_number, 'success');
                        loadDashboardOrders(); // Neu laden
                    } else if (msg.payload.data.type === 'UPDATE') {
                        // Status Update
                        console.log('🔄 Order Update:', record.order_number);
                        loadDashboardOrders();
                    }
                }
            } catch (e) {
                // Ignoriere parse errors
            }
        };
        
        ws.onerror = (e) => {
            console.log('⚠️ Realtime Fehler - Polling aktiviert');
            if (statusEl) {
                statusEl.innerHTML = '<span style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%;"></span> Polling';
                statusEl.style.background = '#fef3c7';
                statusEl.style.color = '#d97706';
            }
            // Fallback: Polling alle 30 Sekunden
            startOrdersPolling();
        };
        
        ws.onclose = () => {
            console.log('🔌 Realtime getrennt');
            if (statusEl) {
                statusEl.innerHTML = '<span style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></span> Offline';
                statusEl.style.background = '#fee2e2';
                statusEl.style.color = '#dc2626';
            }
            ordersRealtimeChannel = null;
            // Fallback auf Polling statt endlosem Reconnect
            startOrdersPolling();
        };
        
        ordersRealtimeChannel = ws;
        
    } catch (e) {
        console.log('Realtime nicht verfügbar:', e);
        if (statusEl) {
            statusEl.innerHTML = '<span style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%;"></span> Polling';
            statusEl.style.background = '#fef3c7';
            statusEl.style.color = '#d97706';
        }
        startOrdersPolling();
    }
}

// Fallback Polling wenn Realtime nicht funktioniert
var ordersPollingInterval = null;
var lastOrdersHash = '';

function startOrdersPolling() {
    if (ordersPollingInterval) return;
    
    // Sofort erste Ladung
    loadDashboardOrders();
    
    // Dann alle 30 Sekunden (statt 5 - verhindert Bildschirm-Wackeln)
    ordersPollingInterval = setInterval(function() {
        var section = document.getElementById('sectionOrders');
        if (section && section.classList.contains('active')) {
            // Nur im Hintergrund prüfen, nicht direkt re-rendern
            checkForNewOrders();
        }
    }, 30000);
}

// Prüfe ob neue Bestellungen da sind, ohne sofort alles neu zu rendern
async function checkForNewOrders() {
    try {
        var today = new Date();
        today.setHours(0,0,0,0);
        var resp = await fetch(SUPABASE_URL + '/rest/v1/orders?select=id,status,updated_at&created_at=gte.' + today.toISOString() + '&order=created_at.desc', {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
        if (resp.ok) {
            var data = await resp.json();
            var hash = data.map(function(o) { return o.id + o.status + o.updated_at; }).join('|');
            if (hash !== lastOrdersHash) {
                lastOrdersHash = hash;
                loadDashboardOrders();
            }
        }
    } catch(e) {}
}

function refreshOrders() {
    loadDashboardOrders();
    showToast('Aktualisiert', 'success');
}

// Orders rendern
function renderDashboardOrders() {
    const grid = document.getElementById('ordersGrid');
    const emptyState = document.getElementById('ordersEmptyState');
    
    if (!grid) return;
    
    // Filter anwenden
    let filtered = dashboardOrders;
    if (orderFilterStatus !== 'all') {
        filtered = dashboardOrders.filter(o => o.status === orderFilterStatus);
    }
    
    // Sortieren: Neueste zuerst, aber "received" ganz oben
    filtered.sort((a, b) => {
        if (a.status === 'received' && b.status !== 'received') return -1;
        if (b.status === 'received' && a.status !== 'received') return 1;
        return new Date(b.created_at) - new Date(a.created_at);
    });
    
    if (filtered.length === 0) {
        grid.innerHTML = '';
        if (emptyState) emptyState.style.display = 'block';
        return;
    }
    
    if (emptyState) emptyState.style.display = 'none';
    
    grid.innerHTML = filtered.map(order => {
        const statusLabels = {
            'received': 'Neu',
            'accepted': 'Angenommen',
            'preparing': 'In Zubereitung',
            'ready': 'Fertig',
            'out_for_delivery': 'Unterwegs',
            'delivered': 'Geliefert',
            'picked_up': 'Abgeholt',
            'cancelled': 'Storniert'
        };
        
        const timeAgo = getTimeAgo(order.created_at);
        
        // Action Buttons je nach Status
        let actionsHtml = '';
        switch(order.status) {
            case 'received':
                actionsHtml = `
                    <button class="kin-order-btn reject" onclick="rejectOrder('${order.id}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                        Ablehnen
                    </button>
                    <button class="kin-order-btn accept" onclick="acceptOrder('${order.id}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Annehmen
                    </button>
                `;
                break;
            case 'accepted':
                actionsHtml = `
                    <button class="kin-order-btn secondary" onclick="printOrder('${order.id}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                            <rect x="6" y="14" width="12" height="8"/>
                        </svg>
                        Drucken
                    </button>
                    <button class="kin-order-btn next" onclick="updateOrderStatus('${order.id}', 'preparing')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4"/>
                        </svg>
                        Zubereiten
                    </button>
                `;
                break;
            case 'preparing':
                actionsHtml = `
                    <button class="kin-order-btn secondary" onclick="printOrder('${order.id}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <polyline points="6 9 6 2 18 2 18 9"/><rect x="6" y="14" width="12" height="8"/>
                        </svg>
                    </button>
                    <button class="kin-order-btn next" onclick="updateOrderStatus('${order.id}', 'ready')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        Fertig
                    </button>
                `;
                break;
            case 'ready':
                if (order.order_type === 'delivery') {
                    actionsHtml = `
                        <button class="kin-order-btn next" onclick="updateOrderStatus('${order.id}', 'out_for_delivery')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                <rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
                                <circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/>
                            </svg>
                            Fahrer los
                        </button>
                    `;
                } else {
                    actionsHtml = `
                        <button class="kin-order-btn next" onclick="updateOrderStatus('${order.id}', 'picked_up')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            Abgeholt
                        </button>
                    `;
                }
                break;
            case 'out_for_delivery':
                actionsHtml = `
                    <button class="kin-order-btn next" onclick="updateOrderStatus('${order.id}', 'delivered')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        Geliefert
                    </button>
                `;
                break;
        }
        
        return `
            <div class="kin-order-card status-${order.status}">
                <div class="kin-order-header">
                    <div>
                        <div class="kin-order-number">#${order.order_number}</div>
                        <div class="kin-order-time">${timeAgo}${order.estimated_minutes ? ' • ' + order.estimated_minutes + ' Min' : ''}</div>
                    </div>
                    <div class="kin-order-status ${order.status}">${statusLabels[order.status]}</div>
                </div>
                <div class="kin-order-body">
                    <div class="kin-order-type">
                        ${order.order_type === 'delivery' ? `
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16">
                                <rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
                                <circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/>
                            </svg>
                            Lieferung
                        ` : `
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16">
                                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/>
                                <path d="M16 10a4 4 0 0 1-8 0"/>
                            </svg>
                            Abholung
                        `}
                    </div>
                    <div class="kin-order-customer">
                        <div class="kin-order-customer-name">${order.customer_name}</div>
                        <div class="kin-order-customer-info">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="14" height="14">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            </svg>
                            <a href="tel:${order.customer_phone}">${order.customer_phone}</a>
                        </div>
                        ${order.delivery_address ? `
                            <div class="kin-order-address">
                                <svg viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="1.5" width="14" height="14" style="vertical-align: middle; margin-right: 4px;">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                                </svg>
                                ${order.delivery_address.street} ${order.delivery_address.house_number}, ${order.delivery_address.zip} ${order.delivery_address.city}
                            </div>
                        ` : ''}
                    </div>
                    <div class="kin-order-items">
                        ${order.items.map(item => `
                            <div class="kin-order-item">
                                <div class="kin-order-item-left">
                                    <div class="kin-order-item-qty">${item.quantity}</div>
                                    <div>
                                        <div class="kin-order-item-name">${item.name}</div>
                                        ${item.options ? `<div class="kin-order-item-options">${item.options}</div>` : ''}
                                    </div>
                                </div>
                                <div class="kin-order-item-price">${formatPrice(item.base_price || item.price)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="kin-order-footer">
                    <div>
                        <div class="kin-order-total">${formatPrice(order.total)}</div>
                        <div class="kin-order-payment">${order.payment_method === 'cash' ? 'Barzahlung' : 'Kartenzahlung'}</div>
                    </div>
                    <div class="kin-order-actions">
                        ${actionsHtml}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Zeit-Formatierung
function getTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = Math.floor((now - date) / 60000); // Minuten
    
    if (diff < 1) return 'Gerade eben';
    if (diff < 60) return `vor ${diff} Min`;
    if (diff < 1440) return `vor ${Math.floor(diff / 60)} Std`;
    return `vor ${Math.floor(diff / 1440)} Tagen`;
}

// Stats aktualisieren
function updateOrderStats() {
    const today = dashboardOrders.filter(o => {
        const orderDate = new Date(o.created_at).toDateString();
        const todayDate = new Date().toDateString();
        return orderDate === todayDate;
    });
    
    const revenue = today.reduce((sum, o) => sum + o.total, 0);
    const avgOrder = today.length > 0 ? revenue / today.length : 0;
    
    // Stats
    document.getElementById('statOrdersToday').textContent = today.length;
    document.getElementById('statRevenueToday').textContent = formatPrice(revenue);
    document.getElementById('statAvgOrder').textContent = formatPrice(avgOrder);
    document.getElementById('statAvgTime').textContent = '38 Min';
    
    // Tab Counts
    document.getElementById('ordersCountAll').textContent = dashboardOrders.length;
    document.getElementById('ordersCountNew').textContent = dashboardOrders.filter(o => o.status === 'received').length;
    document.getElementById('ordersCountAccepted').textContent = dashboardOrders.filter(o => o.status === 'accepted').length;
    document.getElementById('ordersCountPreparing').textContent = dashboardOrders.filter(o => o.status === 'preparing').length;
    document.getElementById('ordersCountReady').textContent = dashboardOrders.filter(o => o.status === 'ready').length;
    document.getElementById('ordersCountDelivery').textContent = dashboardOrders.filter(o => o.status === 'out_for_delivery').length;
    
    // Nav Badge
    const newCount = dashboardOrders.filter(o => o.status === 'received').length;
    const navBadge = document.getElementById('ordersCountNav');
    if (navBadge) {
        navBadge.textContent = newCount;
        navBadge.style.display = newCount > 0 ? 'inline' : 'none';
    }
}

// Filter Orders
function filterOrders(status, btn) {
    orderFilterStatus = status;
    
    // Update beide Tab-Typen (für Kompatibilität)
    document.querySelectorAll('.order-status-tab, .kin-filter-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    
    renderDashboardOrders();
}

// Restaurant Filter für Bestellungen
function loadOrdersForRestaurant(restaurantId) {
    ordersRestaurantFilter = restaurantId;
    renderDashboardOrders();
}

// Aktuelle Order ID für Modal
var currentAcceptOrderId = null;

// Order annehmen - Modal öffnen
function acceptOrder(orderId) {
    currentAcceptOrderId = orderId;
    const order = dashboardOrders.find(o => o.id === orderId);
    if (!order) return;
    
    // Modal Inhalt aktualisieren
    const modal = document.getElementById('acceptOrderModal');
    const orderInfo = document.getElementById('acceptOrderInfo');
    
    if (orderInfo) {
        orderInfo.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                <div style="width: 48px; height: 48px; background: ${order.order_type === 'delivery' ? '#dbeafe' : '#d1fae5'}; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    ${order.order_type === 'delivery' ? `
                        <svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="1.5" width="24" height="24">
                            <rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
                            <circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/>
                        </svg>
                    ` : `
                        <svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="1.5" width="24" height="24">
                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/>
                            <path d="M16 10a4 4 0 0 1-8 0"/>
                        </svg>
                    `}
                </div>
                <div>
                    <div style="font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 600; color: var(--dark);">#${order.order_number}</div>
                    <div style="font-size: 13px; color: var(--slate);">${order.order_type === 'delivery' ? '🚗 Lieferung' : '🛍️ Abholung'} • ${order.customer_name}</div>
                </div>
            </div>
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 12px; margin-bottom: 8px;">
                <div style="font-size: 13px; color: var(--slate); margin-bottom: 4px;">${order.items.length} Artikel</div>
                <div style="font-size: 18px; font-weight: 700; color: var(--dark);">${formatPrice(order.total)}</div>
            </div>
        `;
    }
    
    // Standard-Zeit je nach Typ
    const defaultTime = order.order_type === 'delivery' ? 45 : 25;
    document.querySelectorAll('.time-option-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (parseInt(btn.dataset.time) === defaultTime) {
            btn.classList.add('selected');
        }
    });
    document.getElementById('customTimeInput').value = '';
    
    openModal('acceptOrderModal');
}

// Zeit-Option auswählen
function selectTimeOption(btn, minutes) {
    document.querySelectorAll('.time-option-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    document.getElementById('customTimeInput').value = '';
}

// Bestellung mit Zeit bestätigen
async function confirmAcceptOrder() {
    if (!currentAcceptOrderId) return;
    
    // Zeit ermitteln
    let minutes = 0;
    const selectedBtn = document.querySelector('.time-option-btn.selected');
    const customTime = document.getElementById('customTimeInput').value;
    
    if (customTime) {
        minutes = parseInt(customTime);
    } else if (selectedBtn) {
        minutes = parseInt(selectedBtn.dataset.time);
    } else {
        showToast('Bitte Wartezeit auswählen', 'error');
        return;
    }
    
    if (minutes < 5 || minutes > 180) {
        showToast('Zeit muss zwischen 5 und 180 Minuten sein', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${currentAcceptOrderId}`, {
            method: 'PATCH',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
            },
            body: JSON.stringify({
                status: 'accepted',
                estimated_minutes: minutes,
                estimated_time: new Date(Date.now() + minutes * 60000).toISOString(),
                accepted_at: new Date().toISOString()
            })
        });
        
        if (response.ok) {
            // Lokal aktualisieren
            const order = dashboardOrders.find(o => o.id === currentAcceptOrderId);
            if (order) {
                order.status = 'accepted';
                order.estimated_minutes = minutes;
                order.estimated_time = new Date(Date.now() + minutes * 60000).toISOString();
            }
            
            closeModal('acceptOrderModal');
            renderDashboardOrders();
            updateOrderStats();
            showToast(`Bestellung angenommen • ${minutes} Min`, 'success');
        } else {
            showToast('Fehler beim Annehmen', 'error');
        }
    } catch (e) {
        console.error('Accept Order Error:', e);
        showToast('Verbindungsfehler', 'error');
    }
}

// Order ablehnen
async function rejectOrder(orderId) {
    if (!confirm('Bestellung wirklich ablehnen?')) return;
    
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${orderId}`, {
            method: 'PATCH',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
            },
            body: JSON.stringify({
                status: 'cancelled',
                cancelled_at: new Date().toISOString()
            })
        });
    } catch (e) {
        console.log('Update Fehler:', e);
    }
    
    const order = dashboardOrders.find(o => o.id === orderId);
    if (order) {
        order.status = 'cancelled';
        renderDashboardOrders();
        updateOrderStats();
        showToast('Bestellung abgelehnt', 'error');
    }
}

// Status aktualisieren
async function updateOrderStatus(orderId, newStatus) {
    const timestampField = {
        'preparing': 'preparing_at',
        'ready': 'ready_at',
        'out_for_delivery': 'out_for_delivery_at',
        'delivered': 'completed_at',
        'picked_up': 'completed_at'
    };
    
    const updateData = { status: newStatus };
    if (timestampField[newStatus]) {
        updateData[timestampField[newStatus]] = new Date().toISOString();
    }
    
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${orderId}`, {
            method: 'PATCH',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
            },
            body: JSON.stringify(updateData)
        });
    } catch (e) {
        console.log('Update Fehler:', e);
    }
    
    const order = dashboardOrders.find(o => o.id === orderId);
    if (order) {
        order.status = newStatus;
        renderDashboardOrders();
        updateOrderStats();
        
        const labels = {
            'preparing': 'In Zubereitung',
            'ready': 'Fertig zur Abholung',
            'out_for_delivery': 'Fahrer unterwegs',
            'delivered': 'Geliefert',
            'picked_up': 'Abgeholt'
        };
        showToast('Status: ' + labels[newStatus]);
    }
}

// Bon drucken (Demo)
function printOrder(orderId) {
    const order = dashboardOrders.find(o => o.id === orderId);
    if (!order) return;
    
    let printContent = `
        <div style="font-family: monospace; width: 300px; padding: 20px;">
            <div style="text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                BESTELLUNG #${order.order_number}
            </div>
            <div style="text-align: center; margin-bottom: 15px; border-bottom: 1px dashed #000; padding-bottom: 10px;">
                ${new Date(order.created_at).toLocaleString('de-DE')}
            </div>
            <div style="margin-bottom: 10px;">
                <strong>${order.order_type === 'delivery' ? 'LIEFERUNG' : 'ABHOLUNG'}</strong><br>
                ${order.customer_name}<br>
                ${order.customer_phone}
                ${order.delivery_address ? `<br>${order.delivery_address.street} ${order.delivery_address.house_number}<br>${order.delivery_address.zip} ${order.delivery_address.city}` : ''}
            </div>
            <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 10px 0; margin: 10px 0;">
                ${order.items.map(item => `
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>${item.quantity}x ${item.name}</span>
                        <span>${formatPrice(item.price)}</span>
                    </div>
                    ${item.options ? `<div style="font-size: 12px; color: #666; margin-left: 20px;">→ ${item.options}</div>` : ''}
                `).join('')}
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
                <span>GESAMT</span>
                <span>${formatPrice(order.total)}</span>
            </div>
            <div style="text-align: center; margin-top: 15px; font-size: 12px;">
                ${order.payment_method === 'cash' ? 'BARZAHLUNG' : 'KARTENZAHLUNG'}
            </div>
        </div>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
}

// Sound Toggle
function toggleOrderSound() {
    orderSoundEnabled = !orderSoundEnabled;
    const icon = document.getElementById('orderSoundIcon');
    const text = document.getElementById('orderSoundText');
    
    if (orderSoundEnabled) {
        icon.innerHTML = '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>';
        text.textContent = 'Ton an';
    } else {
        icon.innerHTML = '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>';
        text.textContent = 'Ton aus';
    }
}

// Refresh Orders
function refreshOrders() {
    loadDashboardOrders();
    showToast('Aktualisiert!');
}

// Play notification sound (wenn neue Bestellung kommt)
function playOrderSound() {
    if (!orderSoundEnabled) return;
    
    // Web Audio API für Notification Sound
    try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.value = 0.3;
        
        oscillator.start();
        setTimeout(() => {
            oscillator.frequency.value = 1000;
        }, 150);
        setTimeout(() => {
            oscillator.stop();
        }, 300);
    } catch(e) {
        console.log('Audio nicht verfügbar');
    }
}

// Initialisierung
document.addEventListener('DOMContentLoaded', function() {
    // Cart Button initial versteckt
    const cartBtn = document.getElementById('cartButtonFixed');
    if (cartBtn) cartBtn.classList.remove('visible');
    
    // Orders Dashboard laden wenn Section sichtbar wird
    loadDashboardOrders();
    
    // Aktive Bestellung für Kunden-Profil prüfen
    checkActiveCustomerOrder();
});

// ==================== KUNDEN BESTELLSTATUS ====================

var customerActiveOrder = null;
var countdownInterval = null;

// Aktive Bestellung prüfen (aus LocalStorage oder Supabase)
function checkActiveCustomerOrder() {
    // Prüfe LocalStorage für aktive Bestellung
    const savedOrder = localStorage.getItem('kin_active_order');
    if (savedOrder) {
        try {
            customerActiveOrder = JSON.parse(savedOrder);
            // Prüfen ob Bestellung noch aktiv ist (nicht älter als 24h)
            const orderTime = new Date(customerActiveOrder.created_at);
            const now = new Date();
            const hoursDiff = (now - orderTime) / (1000 * 60 * 60);
            
            if (hoursDiff < 24 && !['delivered', 'picked_up', 'cancelled'].includes(customerActiveOrder.status)) {
                updateProfileOrderStatus();
                startCountdown();
                // Polling für Status Updates
                setInterval(pollOrderStatus, 30000);
            } else {
                // Alte Bestellung entfernen
                localStorage.removeItem('kin_active_order');
                customerActiveOrder = null;
            }
        } catch(e) {
            console.log('Order Parse Error:', e);
            localStorage.removeItem('kin_active_order');
        }
    }
}

// Bestellstatus im Profil aktualisieren
function updateProfileOrderStatus() {
    const section = document.getElementById('activeOrdersSection');
    if (!section || !customerActiveOrder) {
        if (section) section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    
    const statusLabels = {
        'received': 'Warten auf Bestätigung',
        'accepted': 'Angenommen',
        'preparing': 'In Zubereitung',
        'ready': 'Fertig',
        'out_for_delivery': 'Unterwegs',
        'delivered': 'Geliefert',
        'picked_up': 'Abgeholt'
    };
    
    // Status Pill
    const statusPill = document.getElementById('profileOrderStatus');
    if (statusPill) {
        statusPill.textContent = statusLabels[customerActiveOrder.status] || customerActiveOrder.status;
        statusPill.className = 'order-status-pill ' + customerActiveOrder.status;
    }
    
    // Order Info
    document.getElementById('profileOrderNumber').textContent = '#' + customerActiveOrder.order_number;
    document.getElementById('profileOrderRestaurant').textContent = customerActiveOrder.restaurant_name || 'Restaurant';
    document.getElementById('profileOrderType').textContent = customerActiveOrder.order_type === 'delivery' ? 'Lieferung' : 'Abholung';
    document.getElementById('profileOrderTotal').textContent = formatPrice(customerActiveOrder.total);
    
    // Final Step Label
    const finalStep = document.getElementById('profileFinalStep');
    if (finalStep) {
        finalStep.textContent = customerActiveOrder.order_type === 'delivery' ? 'Geliefert' : 'Abholbereit';
    }
    
    // Progress Steps aktualisieren
    updateProgressSteps(customerActiveOrder.status);
}

// Progress Steps visuell aktualisieren
function updateProgressSteps(status) {
    const steps = ['received', 'accepted', 'preparing', 'ready'];
    const currentIndex = steps.indexOf(status);
    
    document.querySelectorAll('.progress-step').forEach((step, index) => {
        const stepStatus = step.dataset.step;
        const stepIndex = steps.indexOf(stepStatus);
        
        step.classList.remove('completed', 'active');
        
        if (stepIndex < currentIndex) {
            step.classList.add('completed');
        } else if (stepIndex === currentIndex) {
            step.classList.add('active');
        }
    });
    
    // Progress Lines
    document.querySelectorAll('.progress-line').forEach((line, index) => {
        line.classList.toggle('completed', index < currentIndex);
    });
}

// Countdown Timer starten
function startCountdown() {
    if (countdownInterval) clearInterval(countdownInterval);
    
    const updateCountdown = () => {
        if (!customerActiveOrder || !customerActiveOrder.estimated_time) {
            document.getElementById('profileCountdown').textContent = '--:--';
            document.getElementById('profileReadyTime').textContent = 'Wartezeit wird berechnet...';
            return;
        }
        
        const readyTime = new Date(customerActiveOrder.estimated_time);
        const now = new Date();
        const diff = readyTime - now;
        
        if (diff <= 0) {
            document.getElementById('profileCountdown').textContent = 'Gleich fertig!';
            document.getElementById('profileReadyTime').textContent = 'Bitte bereitmachen';
            return;
        }
        
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        
        document.getElementById('profileCountdown').textContent = 
            String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
        
        const readyTimeStr = readyTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('profileReadyTime').textContent = 'Fertig um ca. ' + readyTimeStr + ' Uhr';
    };
    
    updateCountdown();
    countdownInterval = setInterval(updateCountdown, 1000);
}

// Status von Supabase abfragen
// ==================== BESTELLOPTIONEN EINSTELLUNGEN ====================

// Settings laden (aus localStorage, pro Restaurant)
function loadOrderSettings() {
    var restId = document.getElementById('ordersRestaurantSelect')?.value || 'global';
    var stored = {};
    try { stored = JSON.parse(localStorage.getItem('kin_order_settings_' + restId) || '{}'); } catch(e) {}
    
    var pickupEl = document.getElementById('settingPickup');
    var deliveryEl = document.getElementById('settingDelivery');
    
    if (pickupEl) pickupEl.checked = stored.pickup !== false; // Default: an
    if (deliveryEl) deliveryEl.checked = stored.delivery === true; // Default: aus
    
    updateToggleVisuals();
}

// Settings speichern
function saveOrderSettings() {
    var restId = document.getElementById('ordersRestaurantSelect')?.value || 'global';
    
    var settings = {
        pickup: document.getElementById('settingPickup')?.checked || false,
        delivery: document.getElementById('settingDelivery')?.checked || false
    };
    
    try { localStorage.setItem('kin_order_settings_' + restId, JSON.stringify(settings)); } catch(e) {}
    
    // Auch für die Restaurant-Features in Supabase aktualisieren
    if (restId && restId !== 'global') {
        saveOrderSettingsToSupabase(restId, settings);
    }
    
    updateToggleVisuals();
    
    var aktiv = [];
    if (settings.pickup) aktiv.push('Abholung');
    if (settings.delivery) aktiv.push('Lieferung');
    showToast('✅ Bestelloptionen: ' + (aktiv.length ? aktiv.join(', ') : 'Keine'), 'success');
}

// Supabase features aktualisieren
async function saveOrderSettingsToSupabase(restId, settings) {
    try {
        var resp = await fetch(SUPABASE_URL + '/rest/v1/restaurants?id=eq.' + restId + '&select=features', {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
        var data = await resp.json();
        var features = (data[0]?.features || []).filter(function(f) {
            return f !== 'lieferung' && f !== 'abholung';
        });
        
        if (settings.pickup) features.push('abholung');
        if (settings.delivery) features.push('lieferung');
        
        await fetch(SUPABASE_URL + '/rest/v1/restaurants?id=eq.' + restId, {
            method: 'PATCH',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
            },
            body: JSON.stringify({ features: features })
        });
    } catch(e) { console.log('Settings save error:', e); }
}

// Toggle Visuals aktualisieren
function updateToggleVisuals() {
    ['Pickup', 'Delivery'].forEach(function(key) {
        var checkbox = document.getElementById('setting' + key);
        var toggle = document.getElementById('toggle' + key);
        if (!checkbox || !toggle) return;
        
        var isOn = checkbox.checked;
        var sw = toggle.querySelector('.toggle-switch');
        var knob = toggle.querySelector('.toggle-knob');
        var svg = toggle.querySelector('svg');
        
        if (isOn) {
            toggle.style.borderColor = 'var(--primary)';
            if (sw) { sw.style.background = 'var(--primary)'; }
            if (knob) { knob.style.left = 'auto'; knob.style.right = '2px'; }
            if (svg) svg.setAttribute('stroke', 'var(--primary)');
        } else {
            toggle.style.borderColor = 'transparent';
            if (sw) { sw.style.background = '#d1d5db'; }
            if (knob) { knob.style.right = 'auto'; knob.style.left = '2px'; }
            if (svg) svg.setAttribute('stroke', 'var(--slate)');
        }
    });
}

// ==================== CHECKOUT: BESTELLARTEN FILTERN ====================

function updateCheckoutOrderTypes() {
    if (!currentOrderRestaurant) return;
    
    var restId = currentOrderRestaurant.id;
    var settings = {};
    try { settings = JSON.parse(localStorage.getItem('kin_order_settings_' + restId) || '{}'); } catch(e) {}
    
    var features = currentOrderRestaurant.features || [];
    
    var pickupEnabled = settings.pickup !== undefined ? settings.pickup : true;
    var deliveryEnabled = settings.delivery !== undefined ? settings.delivery : features.includes('lieferung');
    
    // Buttons zeigen/verstecken
    document.querySelectorAll('.order-type-btn[data-type]').forEach(function(btn) {
        var type = btn.dataset.type;
        if (type === 'pickup') btn.style.display = pickupEnabled ? '' : 'none';
        if (type === 'delivery') btn.style.display = deliveryEnabled ? '' : 'none';
    });
    
    // Grid anpassen
    var grid = document.querySelector('.order-type-toggle');
    if (grid) {
        var visibleCount = [pickupEnabled, deliveryEnabled].filter(Boolean).length;
        grid.style.gridTemplateColumns = 'repeat(' + visibleCount + ', 1fr)';
    }
    
    // Wenn aktive Bestellart deaktiviert → erste verfügbare wählen
    if ((orderType === 'pickup' && !pickupEnabled) ||
        (orderType === 'delivery' && !deliveryEnabled)) {
        if (pickupEnabled) setOrderType('pickup', document.querySelector('.order-type-btn[data-type="pickup"]'));
        else if (deliveryEnabled) setOrderType('delivery', document.querySelector('.order-type-btn[data-type="delivery"]'));
    }
}
// ==================== KUNDEN-BENACHRICHTIGUNGSSYSTEM ====================

var orderStatusPollingInterval = null;

async function pollOrderStatus() {
    if (!customerActiveOrder) {
        // Kein aktiver Order → Polling stoppen
        if (orderStatusPollingInterval) {
            clearInterval(orderStatusPollingInterval);
            orderStatusPollingInterval = null;
        }
        return;
    }
    
    try {
        var response = await fetch(SUPABASE_URL + '/rest/v1/orders?id=eq.' + customerActiveOrder.id + '&select=status,estimated_minutes,estimated_time', {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (response.ok) {
            var data = await response.json();
            if (data.length > 0) {
                var updatedOrder = data[0];
                
                // Status geändert?
                if (updatedOrder.status !== customerActiveOrder.status) {
                    var oldStatus = customerActiveOrder.status;
                    customerActiveOrder.status = updatedOrder.status;
                    customerActiveOrder.estimated_minutes = updatedOrder.estimated_minutes;
                    customerActiveOrder.estimated_time = updatedOrder.estimated_time;
                    
                    // LocalStorage aktualisieren
                    try { localStorage.setItem('kin_active_order', JSON.stringify(customerActiveOrder)); } catch(e) {}
                    
                    // UI aktualisieren
                    try { updateProfileOrderStatus(); } catch(e) {}
                    
                    // Benachrichtigungen senden
                    var statusNotifications = {
                        'accepted': { 
                            title: '✅ Bestellung angenommen!', 
                            body: 'Deine Bestellung #' + (customerActiveOrder.order_number || '') + ' wurde angenommen.' + (updatedOrder.estimated_minutes ? ' Geschätzt: ' + updatedOrder.estimated_minutes + ' Min.' : ''),
                            icon: '✅'
                        },
                        'preparing': { 
                            title: '👨‍🍳 Wird zubereitet!', 
                            body: 'Deine Bestellung #' + (customerActiveOrder.order_number || '') + ' wird jetzt zubereitet.',
                            icon: '👨‍🍳'
                        },
                        'ready': { 
                            title: '🔔 Bestellung fertig!', 
                            body: 'Deine Bestellung #' + (customerActiveOrder.order_number || '') + ' ist zur Abholung bereit!',
                            icon: '🔔'
                        },
                        'out_for_delivery': { 
                            title: '🚗 Unterwegs!', 
                            body: 'Deine Bestellung #' + (customerActiveOrder.order_number || '') + ' ist auf dem Weg zu dir!',
                            icon: '🚗'
                        },
                        'delivered': { 
                            title: '🎉 Guten Appetit!', 
                            body: 'Deine Bestellung wurde geliefert. Vielen Dank!',
                            icon: '🎉'
                        },
                        'picked_up': { 
                            title: '🎉 Guten Appetit!', 
                            body: 'Deine Bestellung wurde abgeholt. Vielen Dank!',
                            icon: '🎉'
                        }
                    };
                    
                    var notif = statusNotifications[updatedOrder.status];
                    if (notif) {
                        // 1. Toast im UI
                        showToast(notif.icon + ' ' + notif.title, 'success');
                        
                        // 2. Browser Push Notification
                        sendBrowserNotification(notif.title, notif.body);
                        
                        // 3. Sound abspielen bei wichtigen Status
                        if (['accepted', 'ready', 'out_for_delivery'].includes(updatedOrder.status)) {
                            playNotificationSound();
                        }
                    }
                    
                    // Bestellung abgeschlossen?
                    if (['delivered', 'picked_up', 'cancelled'].includes(updatedOrder.status)) {
                        try { localStorage.removeItem('kin_active_order'); } catch(e) {}
                        customerActiveOrder = null;
                        var sec = document.getElementById('activeOrdersSection');
                        if (sec) sec.style.display = 'none';
                        // Polling stoppen
                        if (orderStatusPollingInterval) {
                            clearInterval(orderStatusPollingInterval);
                            orderStatusPollingInterval = null;
                        }
                    }
                }
            }
        }
    } catch(e) {
        console.log('Poll Order Status Error:', e);
    }
}

// Browser Notification senden
function sendBrowserNotification(title, body) {
    if (!('Notification' in window)) return;
    
    if (Notification.permission === 'granted') {
        try {
            var n = new Notification(title, {
                body: body,
                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="80" font-size="80">🍽️</text></svg>',
                tag: 'kiekmolin-status',
                renotify: true,
                requireInteraction: true
            });
            n.onclick = function() { window.focus(); n.close(); };
            // Auto-close nach 10 Sekunden
            setTimeout(function() { n.close(); }, 10000);
        } catch(e) { console.log('Notification Error:', e); }
    }
}

// Benachrichtigungston
function playNotificationSound() {
    try {
        var ctx = new (window.AudioContext || window.webkitAudioContext)();
        // Freundlicher Dreiklang
        var times = [0, 0.15, 0.3];
        var freqs = [523, 659, 784]; // C5, E5, G5
        times.forEach(function(t, i) {
            var osc = ctx.createOscillator();
            var gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = freqs[i];
            gain.gain.setValueAtTime(0.3, ctx.currentTime + t);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + t + 0.4);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start(ctx.currentTime + t);
            osc.stop(ctx.currentTime + t + 0.5);
        });
    } catch(e) {}
}

// Notification-Berechtigung anfragen
function requestNotificationPermission() {
    if (!('Notification' in window)) return;
    if (Notification.permission === 'default') {
        Notification.requestPermission().then(function(perm) {
            if (perm === 'granted') {
                showToast('🔔 Benachrichtigungen aktiviert!', 'success');
            }
        });
    }
}

// Auto-Polling starten wenn aktive Bestellung existiert
function startOrderStatusPolling() {
    if (orderStatusPollingInterval) return;
    
    // Sofort prüfen
    pollOrderStatus();
    
    // Dann alle 15 Sekunden
    orderStatusPollingInterval = setInterval(pollOrderStatus, 15000);
    console.log('📡 Order-Status-Polling gestartet (alle 15s)');
}

// Beim Laden: Prüfe ob aktive Bestellung vorhanden
(function() {
    try {
        var stored = localStorage.getItem('kin_active_order');
        if (stored) {
            customerActiveOrder = JSON.parse(stored);
            if (customerActiveOrder && customerActiveOrder.id) {
                // Bestellung noch aktiv? Starte Polling
                if (!['delivered', 'picked_up', 'cancelled'].includes(customerActiveOrder.status)) {
                    setTimeout(startOrderStatusPolling, 3000);
                }
            }
        }
    } catch(e) {}
})();

// ==================== RESERVIERUNGS-ERINNERUNG ====================

function scheduleReservationReminder(reservationDate, reservationTime, restaurantName) {
    if (!('Notification' in window)) return;
    
    // Erinnerung 1 Stunde vorher
    var dateTimeStr = reservationDate + 'T' + reservationTime;
    var resTime = new Date(dateTimeStr);
    var reminderTime = resTime.getTime() - (60 * 60 * 1000); // 1h vorher
    var now = Date.now();
    var delay = reminderTime - now;
    
    if (delay > 0 && delay < 86400000) { // Nur wenn innerhalb 24h
        setTimeout(function() {
            sendBrowserNotification(
                '🍽️ Reservierung in 1 Stunde!',
                'Du hast um ' + reservationTime + ' Uhr einen Tisch bei ' + restaurantName + ' reserviert.'
            );
            showToast('🍽️ Reservierung in 1 Stunde bei ' + restaurantName, 'success');
        }, delay);
        console.log('⏰ Reservierungs-Erinnerung geplant in ' + Math.round(delay/60000) + ' Min');
    }
}

// Bestellung speichern nach Absenden
function saveCustomerOrder(order) {
    customerActiveOrder = order;
    localStorage.setItem('kin_active_order', JSON.stringify(order));
    updateProfileOrderStatus();
    startCountdown();
}

// Meine Bestellungen anzeigen
function showMyOrders() {
    showOrderHistory();
}

// ==================== SPEISEKARTE EDITOR ====================

// Globale Variablen für Speisekarte
var currentMenuRestaurant = null;
var menuCategories = [];
var menuItems = [];
var scannedMenuItems = [];

// Global verfügbar machen
window.currentMenuRestaurant = currentMenuRestaurant;
window.menuCategories = menuCategories;
window.menuItems = menuItems;
window.scannedMenuItems = scannedMenuItems;

// Restaurant-Auswahl für Speisekarte laden - GLOBAL
window.loadMenuRestaurantSelect = async function() {
    console.log('🔄 loadMenuRestaurantSelect aufgerufen');
    
    var select = document.getElementById('menuRestaurantSelect');
    var container = document.getElementById('menuRestaurantSelectContainer');
    
    if (!select) {
        console.log('❌ menuRestaurantSelect nicht gefunden');
        return;
    }
    
    console.log('✅ Select gefunden');
    
    // Container sichtbar machen
    if (container) {
        container.style.display = 'block';
        console.log('✅ Container sichtbar');
    }
    
    select.innerHTML = '<option value="">Restaurant auswählen...</option>';
    
    // Immer aus Supabase laden für aktuelle Daten
    try {
        console.log('📡 Lade Restaurants von Supabase...');
        var response = await fetch(SUPABASE_URL + '/rest/v1/restaurants?select=id,name&order=name', {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        console.log('📡 Response Status:', response.status);
        
        if (response.ok) {
            var data = await response.json();
            console.log('📡 Restaurants erhalten:', data);
            
            if (data && data.length > 0) {
                data.forEach(function(r) {
                    var option = document.createElement('option');
                    option.value = r.id;
                    option.textContent = r.name;
                    select.appendChild(option);
                });
                console.log('✅ Restaurants geladen:', data.length);
            } else {
                console.log('⚠️ Keine Restaurants in DB - Demo hinzufügen');
                var demoOpt = document.createElement('option');
                demoOpt.value = '1';
                demoOpt.textContent = 'Demo Restaurant';
                select.appendChild(demoOpt);
            }
        } else {
            console.log('⚠️ API Fehler - Demo hinzufügen');
            var demoOpt = document.createElement('option');
            demoOpt.value = '1';
            demoOpt.textContent = 'Demo Restaurant';
            select.appendChild(demoOpt);
        }
    } catch(e) {
        console.log('❌ Restaurant-Laden Fehler:', e);
        // Fallback: Demo Restaurant
        var demoOpt = document.createElement('option');
        demoOpt.value = '1';
        demoOpt.textContent = 'Demo Restaurant';
        select.appendChild(demoOpt);
    }
};

// Alias für Kompatibilität
var loadMenuRestaurantSelect = window.loadMenuRestaurantSelect;

// Speisekarte für Restaurant laden - GLOBAL
window.loadMenuForRestaurant = async function(restaurantId) {
    console.log('🔄 loadMenuForRestaurant aufgerufen mit ID:', restaurantId);
    
    var editor = document.getElementById('menuEditorSection');
    var emptyState = document.getElementById('menuEmptyState');
    
    if (!restaurantId || restaurantId === '') {
        console.log('⚠️ Keine Restaurant ID');
        if (editor) editor.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
        return;
    }
    
    if (editor) editor.style.display = 'block';
    if (emptyState) emptyState.style.display = 'none';
    
    currentMenuRestaurant = restaurantId;
    console.log('✅ currentMenuRestaurant gesetzt:', currentMenuRestaurant);
    
    // Kategorien aus Supabase laden
    try {
        var catResponse = await fetch(SUPABASE_URL + '/rest/v1/menu_categories?restaurant_id=eq.' + restaurantId + '&order=sort_order', {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
        
        if (catResponse.ok) {
            menuCategories = await catResponse.json();
            console.log('✅ Kategorien geladen:', menuCategories.length);
        } else {
            menuCategories = [];
        }
        
        // Items laden
        var itemsResponse = await fetch(SUPABASE_URL + '/rest/v1/menu_items?restaurant_id=eq.' + restaurantId + '&order=sort_order', {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
        
        if (itemsResponse.ok) {
            menuItems = await itemsResponse.json();
            console.log('✅ Items geladen:', menuItems.length);
        } else {
            menuItems = [];
        }
    } catch(e) {
        console.log('⚠️ Menu Load Error:', e);
        // Demo Daten
        menuCategories = [
            { id: 1, name: 'Vorspeisen', icon: '🥗', sort_order: 1 },
            { id: 2, name: 'Hauptgerichte', icon: '🍽️', sort_order: 2 },
            { id: 3, name: 'Desserts', icon: '🍰', sort_order: 3 }
        ];
        menuItems = [
            { id: 1, category_id: 1, name: 'Tagessuppe', description: 'Frisch zubereitet', price: 5.90, is_active: true },
            { id: 2, category_id: 2, name: 'Wiener Schnitzel', description: 'Mit Pommes und Salat', price: 14.90, is_active: true, is_popular: true },
            { id: 3, category_id: 3, name: 'Tiramisu', description: 'Hausgemacht', price: 6.50, is_active: true }
        ];
    }
    
    renderMenuCategories();
    updateMenuStats();
    showToast('Speisekarte geladen', 'success');
};

// Alias für Kompatibilität
var loadMenuForRestaurant = window.loadMenuForRestaurant;

// Kategorien rendern
function renderMenuCategories() {
        const container = document.getElementById('menuCategoriesList');
    if (!container) return;
    
    if (menuCategories.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border-color);">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="1" width="48" height="48" style="margin-bottom: 12px; opacity: 0.5;">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
                <p style="color: var(--slate);">Noch keine Kategorien. Erstelle eine neue Kategorie oder scanne eine Speisekarte.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = menuCategories.map(cat => {
        const items = menuItems.filter(item => item.category_id === cat.id);
        
        return `
            <div class="menu-category-card" id="category-${cat.id}">
                <div class="menu-category-header" onclick="toggleMenuCategory('${cat.id}')">
                    <div class="menu-category-title">
                        <span class="menu-category-icon">${getCategoryIconSVG(cat.icon || '')}</span>
                        <span>${cat.name}</span>
                        <span class="menu-category-count">${items.length}</span>
                    </div>
                    <div class="menu-category-actions" onclick="event.stopPropagation()">
                        <button class="menu-category-btn" onclick="editCategory('${cat.id}')" title="Bearbeiten">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <button class="menu-category-btn delete" onclick="deleteCategory('${cat.id}')" title="Löschen">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="2" width="20" height="20" style="transition: transform 0.3s;" class="category-arrow">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                </div>
                <div class="menu-category-items">
                    ${items.length === 0 ? `
                        <p style="text-align: center; color: var(--slate); padding: 20px;">Keine Gerichte in dieser Kategorie</p>
                    ` : items.map(item => `
                        <div class="menu-item-row">
                            ${item.image_url ? `<img src="${item.image_url}" class="menu-item-image">` : `<div class="menu-item-image" style="display: flex; align-items: center; justify-content: center; font-size: 24px;">🍽️</div>`}
                            <div class="menu-item-info">
                                <div class="menu-item-name">
                                    ${item.name}
                                    ${item.is_popular ? '<span class="menu-item-badge popular"><svg viewBox="0 0 24 24" fill="#f59e0b" stroke="#f59e0b" stroke-width="1" width="12" height="12"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> Beliebt</span>' : ''}
                                    ${item.is_vegan ? '<span class="menu-item-badge vegan"><svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" width="12" height="12"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg> Vegan</span>' : ''}
                                    ${item.is_spicy ? '<span class="menu-item-badge spicy"><svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" width="12" height="12"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg> Scharf</span>' : ''}
                                    ${(item.is_available === false || item.is_active === false) ? '<span class="menu-item-badge inactive"><svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" width="12" height="12"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg> Inaktiv</span>' : ''}
                                </div>
                                <div class="menu-item-desc">${item.description || ''}</div>
                            </div>
                            <div class="menu-item-price">${formatPrice(item.base_price || item.price)}</div>
                            <div class="menu-item-actions">
                                <button class="menu-item-btn" onclick="editMenuItem('${item.id}')" title="Bearbeiten">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                </button>
                                <button class="menu-item-btn delete" onclick="deleteMenuItem('${item.id}')" title="Löschen">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                    <button onclick="openAddMenuItemModal('${cat.id}')" style="width: 100%; padding: 12px; background: var(--bg-card); border: 2px dashed var(--border-color); border-radius: 10px; font-size: 14px; cursor: pointer; color: var(--slate); margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Gericht hinzufügen
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    // Kategorie-Dropdown im Modal aktualisieren
    updateCategorySelect();
}

// Kategorie auf/zuklappen
function toggleMenuCategory(categoryId) {
    const card = document.getElementById(`category-${categoryId}`);
    if (card) {
        card.classList.toggle('open');
        const arrow = card.querySelector('.category-arrow');
        if (arrow) {
            arrow.style.transform = card.classList.contains('open') ? 'rotate(180deg)' : '';
        }
    }
}

// Stats aktualisieren
function updateMenuStats() {
    document.getElementById('menuCategoryCount').textContent = menuCategories.length;
    document.getElementById('menuTotalItems').textContent = menuItems.length;
    document.getElementById('menuActiveItems').textContent = menuItems.filter(i => i.is_active !== false).length;
    document.getElementById('menuPopularItems').textContent = menuItems.filter(i => i.is_popular).length;
    document.getElementById('menuItemCount').textContent = menuItems.length;
}

// Kategorie-Dropdown aktualisieren
function updateCategorySelect() {
    const select = document.getElementById('menuItemCategory');
    if (!select) return;
    
    select.innerHTML = '<option value="">Kategorie wählen...</option>';
    menuCategories.forEach(cat => {
        select.innerHTML += `<option value="${cat.id}">${cat.icon || ''} ${cat.name}</option>`;
    });
}

// Modals öffnen
// ==================== MENÜ MODALS - SUPER SIMPEL ====================
function openMenuScannerModal() {
    // Prüfen ob Restaurant gewählt
    if (!currentMenuRestaurant) {
        showToast('Bitte zuerst ein Restaurant auswählen', 'error');
        return;
    }
    
    var modal = document.getElementById('menuScannerModal');
    if (modal) {
        // Reset Scanner State
        menuScanImageData = null;
        menuScanFileType = 'image';
        menuScanFileName = '';
        scannedMenuItems = [];
        
        var uploadArea = document.getElementById('menuScanUploadArea');
        var preview = document.getElementById('menuScanPreview');
        var progress = document.getElementById('menuScanProgress');
        var results = document.getElementById('menuScanResults');
        var input = document.getElementById('menuScanInput');
        
        if (uploadArea) uploadArea.style.display = 'block';
        if (preview) preview.style.display = 'none';
        if (progress) progress.style.display = 'none';
        if (results) results.style.display = 'none';
        if (input) input.value = '';
        
        modal.style.display = 'flex';
        modal.classList.add('active');
    } else {
        showToast('Scanner nicht verfügbar', 'error');
    }
}

function openAddCategoryModal() {
    console.log('🔥 KATEGORIE MODAL ÖFFNEN');
    const modal = document.getElementById('addCategoryModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
        console.log('✅ Kategorie Modal geöffnet!');
    } else {
        console.error('❌ addCategoryModal nicht gefunden!');
        alert('Fehler: Modal nicht gefunden!');
    }
}

function openAddMenuItemModal(categoryId) {
    console.log('🔥 GERICHT MODAL ÖFFNEN');
    const modal = document.getElementById('addMenuItemModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
        resetPropertyButtons(); // Property Buttons zurücksetzen
        console.log('✅ Gericht Modal geöffnet!');
    } else {
        console.error('❌ addMenuItemModal nicht gefunden!');
        alert('Fehler: Modal nicht gefunden!');
    }
}

// Icon auswählen

// Icon-Name zu SVG umwandeln
function getCategoryIconSVG(iconName) {
    const icons = {
        // Fleisch & Geflügel
        'beef': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><circle cx="12.5" cy="8.5" r="2.5"/><path d="M12.5 2a6.5 6.5 0 0 0-6.22 4.6c-1.1 3.13-.78 3.9-3.18 6.08A3 3 0 0 0 5 18c4 0 8.4-1.8 11.4-4.3A6.5 6.5 0 0 0 12.5 2Z"/></svg>',
        'chicken': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M15.5 8.5a4 4 0 1 0-5.66 5.66l5.66-5.66z"/><path d="m11.25 12.75-5.66 5.66a2 2 0 0 0 2.83 2.83l5.66-5.66"/><circle cx="18" cy="6" r="2"/></svg>',
        'lamb': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><ellipse cx="12" cy="14" rx="7" ry="5"/><circle cx="12" cy="8" r="4"/><path d="M8 6c-1-2-3-2-4 0"/><path d="M16 6c1-2 3-2 4 0"/></svg>',
        'pork': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><ellipse cx="12" cy="13" rx="8" ry="6"/><circle cx="8" cy="11" r="1"/><circle cx="16" cy="11" r="1"/><ellipse cx="12" cy="15" rx="2" ry="1"/><path d="M4 10c-2-1-2-4 0-4"/><path d="M20 10c2-1 2-4 0-4"/></svg>',
        'steak': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M14 6c2.5 0 5 2 5 6s-2 8-7 8-8-4-8-8 3-6 6-6c1.5 0 2.5.5 4 0z"/><path d="M10 12c0 1.5 1 3 3 3"/></svg>',
        'grill': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><rect x="3" y="10" width="18" height="8" rx="2"/><path d="M6 10V8"/><path d="M10 10V6"/><path d="M14 10V6"/><path d="M18 10V8"/><path d="M3 18h18"/><path d="M8 22v-4"/><path d="M16 22v-4"/></svg>',
        
        // Fisch & Meer
        'fish': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M6.5 12c.94-3.46 4.94-6 8.5-6 3.56 0 6.06 2.54 7 6-.94 3.47-3.44 6-7 6-3.56 0-7.56-2.53-8.5-6Z"/><path d="M18 12v.5"/><path d="M2 10l3 2-3 2"/></svg>',
        'shrimp': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M18 9c0 3-2.5 6-6.5 6S5 15 5 12c0-4 3-7 7-7 2 0 4 1 5 3"/><path d="M18 9c1.5 0 3 1 3 3s-1 3-3 3"/><path d="M5 16l-2 4"/><path d="M8 17l-1 3"/></svg>',
        'crab': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><ellipse cx="12" cy="13" rx="6" ry="4"/><path d="M6 11c-2-2-4-1-5 1"/><path d="M18 11c2-2 4-1 5 1"/><path d="M8 17l-2 3"/><path d="M16 17l2 3"/><circle cx="10" cy="12" r="1"/><circle cx="14" cy="12" r="1"/></svg>',
        'sushi': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><ellipse cx="12" cy="14" rx="8" ry="4"/><path d="M4 14v2c0 2.2 3.6 4 8 4s8-1.8 8-4v-2"/><path d="M12 10c2.5 0 5 1 5 2.5"/><ellipse cx="12" cy="8" rx="4" ry="2"/></svg>',
        
        // Vegetarisch & Vegan
        'salad': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M7 21h10"/><path d="M12 21a9 9 0 0 0 9-9H3a9 9 0 0 0 9 9Z"/><path d="M11 12c-1.5-1-3 0-3 2"/><path d="M15 12c-1-2 1-3 2-2"/></svg>',
        'vegan': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>',
        'vegetarian': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M2 2a26.6 26.6 0 0 1 10 20c.9-6.82 1.5-9.5 4-14 4.5-8 6-4 6-4"/><path d="M2 2c2 2.5 3.5 5 4.5 7.5"/></svg>',
        'carrot': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M12 2c2 2 3 5 3 8l-6 12c-.5-1-1-4 0-8 1-3 2-5 3-6"/><path d="M9 3c-1-1-3-1-4 1"/><path d="M15 3c1-1 3-1 4 1"/></svg>',
        'mushroom': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M12 4c-5 0-9 3-9 7h18c0-4-4-7-9-7z"/><path d="M8 11v9c0 1 1 2 2 2h4c1 0 2-1 2-2v-9"/></svg>',
        
        // Internationale Küche
        'pizza': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M15 11h.01"/><path d="M11 15h.01"/><path d="M16 16h.01"/><path d="m2 16 20 6-6-20A20 20 0 0 0 2 16"/></svg>',
        'pasta': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M12 12a4 4 0 0 0 4 4h1a2 2 0 0 1 0 4H7a2 2 0 0 1 0-4h1a4 4 0 0 0 4-4Z"/><path d="M8 8c0-2 1-4 4-4s4 2 4 4"/></svg>',
        'burger': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M4 15h16a2 2 0 0 1 0 4H4a2 2 0 0 1 0-4z"/><path d="m4 11 7.77-6.04a2 2 0 0 1 2.46 0L22 11H4Z"/><path d="M4 11h16v4H4z"/></svg>',
        'sandwich': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M3 11v3a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1v-3"/><path d="m3 11 7.77-6.04a2 2 0 0 1 2.46 0L21 11H3Z"/></svg>',
        'taco': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M4 15c0 3 3.5 5 8 5s8-2 8-5c0-4-4-10-8-10S4 11 4 15z"/><path d="M8 13c0 1 1 2 2 2"/><path d="M14 11c0 1 1 2 2 2"/></svg>',
        'noodles': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M12 21a9 9 0 0 0 9-9H3a9 9 0 0 0 9 9Z"/><path d="M7 21h10"/><path d="M6 8c1-2 3-3 6-3s5 1 6 3"/><path d="M6 12h12"/></svg>',
        'kebab': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M12 3v18"/><ellipse cx="12" cy="6" rx="4" ry="2"/><ellipse cx="12" cy="10" rx="5" ry="2"/><ellipse cx="12" cy="14" rx="4" ry="2"/><ellipse cx="12" cy="18" rx="3" ry="1.5"/></svg>',
        
        // Vorspeisen & Suppen
        'soup': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M12 21a9 9 0 0 0 9-9H3a9 9 0 0 0 9 9Z"/><path d="M7 21h10"/><path d="M9.5 4c0 .5.5 1 .5 1.5s-.5 1-.5 1.5"/><path d="M14.5 4c0 .5.5 1 .5 1.5s-.5 1-.5 1.5"/></svg>',
        'appetizer': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><circle cx="12" cy="12" r="9"/><path d="M12 3v4"/><circle cx="12" cy="12" r="3"/><path d="M8 10h8"/><path d="M8 14h8"/></svg>',
        'bread': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M5 10c0-4 3-6 7-6s7 2 7 6c0 2-1 3-2 4H7c-1-1-2-2-2-4z"/><path d="M7 14v6h10v-6"/><path d="M9 10c0-1 1-2 3-2s3 1 3 2"/></svg>',
        'fries': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M6 9h12l-1 12H7L6 9z"/><path d="M8 9V6"/><path d="M11 9V4"/><path d="M14 9V5"/><path d="M17 9V7"/></svg>',
        
        // Desserts & Süßes
        'cake': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1"/><path d="M2 21h20"/><path d="M12 4v7"/><circle cx="12" cy="3" r="1"/></svg>',
        'icecream': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="m7 11 4.08 10.35a1 1 0 0 0 1.84 0L17 11"/><path d="M17 7A5 5 0 0 0 7 7"/><path d="M17 7a2 2 0 0 1 0 4H7a2 2 0 0 1 0-4"/></svg>',
        'cookie': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><circle cx="12" cy="12" r="9"/><circle cx="8" cy="9" r="1"/><circle cx="15" cy="8" r="1"/><circle cx="10" cy="14" r="1"/><circle cx="15" cy="14" r="1"/></svg>',
        'croissant': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="m4.6 13.11 5.79-3.21c1.89-1.05 4.79 1.78 3.71 3.71l-3.22 5.81C8.8 23.16.79 15.23 4.6 13.11Z"/><path d="m10.5 9.5-1-2.29C9.2 6.48 8.8 6 8 6H4.5C2.79 6 2 6.5 2 8.5a7.71 7.71 0 0 0 2 4.83"/></svg>',
        'chocolate': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><rect x="4" y="6" width="16" height="14" rx="2"/><path d="M4 10h16"/><path d="M4 14h16"/><path d="M10 6v14"/><path d="M14 6v14"/></svg>',
        
        // Getränke
        'coffee': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" y1="2" x2="6" y2="4"/><line x1="10" y1="2" x2="10" y2="4"/><line x1="14" y1="2" x2="14" y2="4"/></svg>',
        'tea': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M17 8h2a2 2 0 0 1 2 2v1a3 3 0 0 1-3 3h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><path d="M6 2c.6 1 1 2 1 3 0 1-.4 2-1 3"/><path d="M10 2c.6 1 1 2 1 3 0 1-.4 2-1 3"/></svg>',
        'softdrink': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M15.2 22H8.8a2 2 0 0 1-2-1.79L5 3h14l-1.81 17.21A2 2 0 0 1 15.2 22Z"/><path d="M6 12a5 5 0 0 1 6 0 5 5 0 0 0 6 0"/></svg>',
        'juice': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M8 22h8l-1-14H9l-1 14z"/><path d="M6 4h12l-1 4H7L6 4z"/><circle cx="12" cy="12" r="2"/></svg>',
        'wine': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M8 22h8"/><path d="M12 15v7"/><path d="M12 15a5 5 0 0 0 5-5c0-2-.5-4-2-8H9c-1.5 4-2 6-2 8a5 5 0 0 0 5 5Z"/></svg>',
        'beer': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M17 11h1a3 3 0 0 1 0 6h-1"/><path d="M5 8v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8"/><path d="M5 8h12V6a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v2"/></svg>',
        'cocktail': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M8 22h8"/><path d="M12 15v7"/><path d="m19 3-7 8-7-8h14z"/><circle cx="15" cy="6" r="1"/></svg>',
        
        // Spezial
        'utensils': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/></svg>',
        'kids': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><circle cx="12" cy="8" r="5"/><path d="M12 13v8"/><path d="M8 17h8"/><path d="M10 6c0-.5.5-1 1-1"/><path d="M14 6c0-.5-.5-1-1-1"/><path d="M10 9h4"/></svg>',
        'spicy': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>',
        'special': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
        'halal': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="20" height="20"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>'
    };
    if (!iconName || iconName.length <= 2) {
        return icons['utensils'];
    }
    return icons[iconName] || icons['utensils'];
}

function selectCategoryIcon(btn) {
    document.querySelectorAll('.category-icon-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    document.getElementById('selectedCategoryIcon').value = btn.dataset.icon;
}

// Property Toggle Button
function togglePropertyBtn(property) {
    const btn = document.getElementById('toggle' + property);
    const checkbox = document.getElementById('menuItem' + property);
    
    if (btn && checkbox) {
        btn.classList.toggle('active');
        checkbox.checked = btn.classList.contains('active');
    }
}

// Reset Property Buttons beim Modal öffnen
function resetPropertyButtons() {
    const properties = [
        'Popular', 'Vegan', 'Vegetarian', 'Spicy', 'GlutenFree', 'Halal',
        'Beef', 'Chicken', 'Pork', 'Lamb', 'Fish', 'Seafood',
        'Gluten', 'LactoseFree', 'Nuts', 'Alcohol', 'Bio', 'Homemade'
    ];
    properties.forEach(prop => {
        const btn = document.getElementById('toggle' + prop);
        const checkbox = document.getElementById('menuItem' + prop);
        if (btn) btn.classList.remove('active');
        if (checkbox) checkbox.checked = false;
    });
}

// Kategorie hinzufügen
function doAddCategory() {
    var name = document.getElementById('newCategoryName').value.trim();
    
    if (!name) {
        showToast('Bitte Kategorie-Name eingeben', 'error');
        return;
    }
    
    var icon = document.getElementById('selectedCategoryIcon').value || 'beef';
    
    var newCategory = {
        id: Date.now(),
        restaurant_id: typeof currentMenuRestaurant !== 'undefined' ? currentMenuRestaurant : 1,
        name: name,
        icon: icon,
        sort_order: (typeof menuCategories !== 'undefined' ? menuCategories.length : 0) + 1,
        is_active: true
    };
    
    // Zu menuCategories hinzufügen
    if (typeof menuCategories !== 'undefined') {
        menuCategories.push(newCategory);
    }
    
    // Modal schließen
    var modal = document.getElementById('addCategoryModal');
    if (modal) modal.style.display = 'none';
    
    // Formular leeren
    document.getElementById('newCategoryName').value = '';
    
    // Dropdown aktualisieren
    var dropdown = document.getElementById('menuItemCategory');
    if (dropdown) {
        var option = document.createElement('option');
        option.value = newCategory.id;
        option.textContent = newCategory.name;
        dropdown.appendChild(option);
    }
    
    // Ansichten aktualisieren
    if (typeof renderMenuCategories === 'function') renderMenuCategories();
    if (typeof updateMenuStats === 'function') updateMenuStats();
    
    showToast('Kategorie "' + name + '" erstellt!', 'success');
}

async function addMenuCategory(e) {
    e.preventDefault();
    
    const name = document.getElementById('newCategoryName').value.trim();
    const icon = document.getElementById('selectedCategoryIcon').value;
    
    if (!name) {
        showToast('Bitte Kategorienamen eingeben', 'error');
        return;
    }
    
    const newCategory = {
        id: Date.now(),
        restaurant_id: currentMenuRestaurant,
        name: name,
        icon: icon,
        sort_order: menuCategories.length + 1
    };
    
    // In Supabase speichern
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/menu_categories`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify(newCategory)
        });
        
        if (response.ok) {
            const data = await response.json();
            newCategory.id = data[0]?.id || newCategory.id;
        }
    } catch(e) {
        console.log('Save Category Error:', e);
    }
    
    menuCategories.push(newCategory);
    renderMenuCategories();
    updateMenuStats();
    closeModal('addCategoryModal');
    showToast(`Kategorie "${name}" erstellt`);
}

// Gericht hinzufügen
function doAddMenuItem() {
    var categoryId = parseInt(document.getElementById('menuItemCategory').value);
    var name = document.getElementById('menuItemName').value.trim();
    var description = document.getElementById('menuItemDescription').value.trim();
    var price = parseFloat(document.getElementById('menuItemPrice').value);
    
    if (!categoryId || !name || isNaN(price)) {
        showToast('Bitte Kategorie, Name und Preis ausfüllen', 'error');
        return;
    }
    
    var newItem = {
        id: Date.now(),
        restaurant_id: typeof currentMenuRestaurant !== 'undefined' ? currentMenuRestaurant : 1,
        category_id: categoryId,
        name: name,
        description: description,
        price: price,
        image_url: document.getElementById('menuItemImage').value.trim() || null,
        is_active: document.getElementById('menuItemActive').checked,
        is_popular: document.getElementById('menuItemPopular')?.checked || false,
        is_vegan: document.getElementById('menuItemVegan')?.checked || false,
        sort_order: (typeof menuItems !== 'undefined' ? menuItems.length : 0) + 1
    };
    
    // Zu menuItems hinzufügen
    if (typeof menuItems !== 'undefined') {
        menuItems.push(newItem);
    }
    
    // Modal schließen
    var modal = document.getElementById('addMenuItemModal');
    if (modal) modal.style.display = 'none';
    
    // Formular leeren
    document.getElementById('menuItemName').value = '';
    document.getElementById('menuItemDescription').value = '';
    document.getElementById('menuItemPrice').value = '';
    document.getElementById('menuItemImage').value = '';
    
    // Ansichten aktualisieren
    if (typeof renderMenuCategories === 'function') renderMenuCategories();
    if (typeof updateMenuStats === 'function') updateMenuStats();
    
    showToast('"' + name + '" hinzugefügt!', 'success');
}

async function addMenuItem(e) {
    e.preventDefault();
    
    const categoryId = parseInt(document.getElementById('menuItemCategory').value);
    const name = document.getElementById('menuItemName').value.trim();
    const description = document.getElementById('menuItemDescription').value.trim();
    const price = parseFloat(document.getElementById('menuItemPrice').value);
    const imageUrl = document.getElementById('menuItemImage').value.trim();
    const isActive = document.getElementById('menuItemActive').checked;
    const isPopular = document.getElementById('menuItemPopular').checked;
    const isVegan = document.getElementById('menuItemVegan').checked;
    const isSpicy = document.getElementById('menuItemSpicy')?.checked || false;
    
    if (!categoryId || !name || isNaN(price)) {
        showToast('Bitte alle Pflichtfelder ausfüllen', 'error');
        return;
    }
    
    const newItem = {
        id: Date.now(),
        restaurant_id: currentMenuRestaurant,
        category_id: categoryId,
        name: name,
        description: description,
        price: price,
        image_url: imageUrl || null,
        is_active: isActive,
        is_popular: isPopular,
        is_vegan: isVegan,
        is_spicy: isSpicy,
        sort_order: menuItems.length + 1
    };
    
    // In Supabase speichern
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/menu_items`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify(newItem)
        });
        
        if (response.ok) {
            const data = await response.json();
            newItem.id = data[0]?.id || newItem.id;
        }
    } catch(e) {
        console.log('Save Item Error:', e);
    }
    
    menuItems.push(newItem);
    renderMenuCategories();
    updateMenuStats();
    closeModal('addMenuItemModal');
    showToast(`"${name}" hinzugefügt`);
}

// Option hinzufügen (für Extras)
function addMenuItemOption() {
    const container = document.getElementById('menuItemOptionsContainer');
    const index = container.children.length;
    
    const optionHtml = `
        <div style="display: flex; gap: 8px; margin-bottom: 8px;" id="option-${index}">
            <input type="text" class="form-input" placeholder="Option Name (z.B. Extra Käse)" style="flex: 2;">
            <input type="number" class="form-input" placeholder="Preis" step="0.10" style="flex: 1;">
            <button type="button" onclick="document.getElementById('option-${index}').remove()" style="padding: 8px 12px; background: #fee2e2; border: none; border-radius: 8px; color: #ef4444; cursor: pointer;">×</button>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', optionHtml);
}

// Gericht löschen
async function deleteMenuItem(itemId) {
    if (!confirm('Gericht wirklich löschen?')) return;
    
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/menu_items?id=eq.${itemId}`, {
            method: 'DELETE',
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
    } catch(e) {
        console.log('Delete Error:', e);
    }
    
    menuItems = menuItems.filter(item => item.id !== itemId);
    renderMenuCategories();
    updateMenuStats();
    showToast('Gericht gelöscht');
}

// Kategorie löschen
async function deleteCategory(categoryId) {
    const itemsInCategory = menuItems.filter(i => i.category_id === categoryId).length;
    if (itemsInCategory > 0) {
        if (!confirm(`Diese Kategorie enthält ${itemsInCategory} Gerichte. Trotzdem löschen?`)) return;
    }
    
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/menu_categories?id=eq.${categoryId}`, {
            method: 'DELETE',
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
        
        // Items dieser Kategorie auch löschen
        await fetch(`${SUPABASE_URL}/rest/v1/menu_items?category_id=eq.${categoryId}`, {
            method: 'DELETE',
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
    } catch(e) {
        console.log('Delete Error:', e);
    }
    
    menuCategories = menuCategories.filter(cat => cat.id !== categoryId);
    menuItems = menuItems.filter(item => item.category_id !== categoryId);
    renderMenuCategories();
    updateMenuStats();
    showToast('Kategorie gelöscht');
}

// ==================== RESERVIERUNG KALENDER & TISCHPLAN ====================

// Diese Variablen werden von den globalen überschrieben
var selectedCalendarDate = null;
var currentCalendarMonth = null;

// Getter für Synchronisation mit globalem System
Object.defineProperty(window, 'selectedCalendarDate', {
    get: function() { return window.resSelectedDate || new Date(); },
    set: function(val) { window.resSelectedDate = val; }
});
Object.defineProperty(window, 'currentCalendarMonth', {
    get: function() { return window.resCurrentMonth || new Date(); },
    set: function(val) { window.resCurrentMonth = val; }
});

var reservations = [];
var selectedFloorplanTable = null;
var floorplanEditMode = true; // Immer im Edit-Mode
var floorplanTables = [
    { id: 1, seats: 2, status: 'available', x: 15, y: 20, type: 'round' },
    { id: 2, seats: 2, status: 'available', x: 15, y: 45, type: 'round' },
    { id: 3, seats: 4, status: 'reserved', x: 15, y: 70, type: 'square' },
    { id: 4, seats: 6, status: 'available', x: 45, y: 25, type: 'rect' },
    { id: 5, seats: 6, status: 'occupied', x: 45, y: 55, type: 'rect' },
    { id: 6, seats: 4, status: 'available', x: 45, y: 80, type: 'round' },
    { id: 7, seats: 4, status: 'available', x: 70, y: 20, type: 'square' },
    { id: 8, seats: 8, status: 'reserved', x: 70, y: 55, type: 'long' },
    { id: 9, seats: 2, status: 'available', x: 70, y: 85, type: 'round' }
];

// Demo Reservierungen - VERWEIST auf das globale Array
// Wird von resAllReservations überschrieben wenn geladen
var demoReservations = [];

// Synchronisiere demoReservations mit resAllReservations
Object.defineProperty(window, 'demoReservations', {
    get: function() { 
        return window.resAllReservations || []; 
    },
    set: function(val) { 
        // Ignorieren - nutze immer resAllReservations
    }
});

function getTodayString() {
    return new Date().toISOString().split('T')[0];
}

function getTomorrowString() {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    return tomorrow.toISOString().split('T')[0];
}

// Tab Navigation
function showReservationTab(tab, btn) {
    document.querySelectorAll('.res-tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.res-tab-content').forEach(c => c.classList.remove('active'));
    
    btn.classList.add('active');
    document.getElementById('resTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
    
    if (tab === 'calendar') {
        renderCalendar();
        renderDayReservations();
    } else if (tab === 'floorplan') {
        renderFloorplan();
    } else if (tab === 'list') {
        renderReservationList();
    }
}

// Kalender
function renderCalendar() {
    const container = document.getElementById('calendarDays');
    const year = currentCalendarMonth.getFullYear();
    const month = currentCalendarMonth.getMonth();
    
    // Header aktualisieren
    const months = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
    document.getElementById('calendarMonthYear').textContent = months[month] + ' ' + year;
    
    // Erster Tag des Monats
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    // Welcher Wochentag ist der 1.? (0=So, 1=Mo, ...)
    let startDay = firstDay.getDay();
    if (startDay === 0) startDay = 7; // Sonntag = 7
    startDay--; // 0-basiert für Montag
    
    let html = '';
    
    // Tage des vorherigen Monats
    const prevMonth = new Date(year, month, 0);
    for (let i = startDay - 1; i >= 0; i--) {
        const day = prevMonth.getDate() - i;
        html += `<div class="cal-day other-month">${day}</div>`;
    }
    
    // Tage des aktuellen Monats
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    const selectedStr = selectedCalendarDate.toISOString().split('T')[0];
    
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === todayStr;
        const isSelected = dateStr === selectedStr;
        const hasRes = demoReservations.some(r => r.date === dateStr);
        
        let classes = 'cal-day';
        if (isToday) classes += ' today';
        if (isSelected) classes += ' selected';
        if (hasRes) classes += ' has-reservations';
        
        html += `<div class="${classes}" onclick="selectCalendarDate('${dateStr}')">${day}</div>`;
    }
    
    // Restliche Tage
    const totalCells = Math.ceil((startDay + lastDay.getDate()) / 7) * 7;
    const remaining = totalCells - (startDay + lastDay.getDate());
    for (let day = 1; day <= remaining; day++) {
        html += `<div class="cal-day other-month">${day}</div>`;
    }
    
    container.innerHTML = html;
}

function changeCalendarMonth(delta) {
    currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + delta);
    renderCalendar();
}

function selectCalendarDate(dateStr) {
    selectedCalendarDate = new Date(dateStr);
    renderCalendar();
    renderDayReservations();
    
    // Titel aktualisieren
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    document.getElementById('selectedDateTitle').textContent = selectedCalendarDate.toLocaleDateString('de-DE', options);
}

function renderDayReservations() {
    const container = document.getElementById('dayReservations');
    const dateStr = selectedCalendarDate.toISOString().split('T')[0];
    
    // Zeitslots von 11:00 bis 21:00
    const slots = ['11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', '20:00', '20:30', '21:00'];
    
    let html = '';
    for (const time of slots) {
        const res = demoReservations.find(r => r.date === dateStr && r.time === time);
        
        if (res) {
            html += `
                <div class="timeslot has-reservation">
                    <div class="timeslot-time">${time}</div>
                    <div class="timeslot-info">
                        <div class="timeslot-name">${res.name}</div>
                        <div class="timeslot-details">${res.party_size} Personen • Tisch ${res.table}${res.notes ? ' • ' + res.notes : ''}</div>
                    </div>
                    <button onclick="editReservation(${res.id})" class="dash-btn" style="padding: 6px 10px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    </button>
                </div>
            `;
        } else {
            html += `
                <div class="timeslot" onclick="quickReservation('${dateStr}', '${time}')">
                    <div class="timeslot-time">${time}</div>
                    <div class="timeslot-info">
                        <span class="timeslot-empty">Frei - klicken zum Reservieren</span>
                    </div>
                </div>
            `;
        }
    }
    
    container.innerHTML = html;
}

// Floorplan
function renderFloorplan() {
    const tables = document.querySelectorAll('.fp-table');
    tables.forEach(table => {
        const tableId = parseInt(table.dataset.table);
        const tableData = floorplanTables.find(t => t.id === tableId);
        if (tableData) {
            table.classList.remove('available', 'reserved', 'occupied');
            table.classList.add(tableData.status);
        }
    });
    
    // Drag & Drop immer initialisieren
    setTimeout(initFloorplanDragDrop, 100);
}

function selectFloorplanTable(tableId) {
    selectedFloorplanTable = tableId;
    
    // Visuell markieren
    document.querySelectorAll('.fp-table').forEach(t => t.classList.remove('selected'));
    document.querySelector(`.fp-table[data-table="${tableId}"]`)?.classList.add('selected');
    
    // Details anzeigen
    const tableData = floorplanTables.find(t => t.id === tableId);
    if (tableData) {
        document.getElementById('elementPalette').style.display = 'none';
        document.getElementById('tableDetails').style.display = 'block';
        document.getElementById('floorplanSidebarTitle').textContent = 'Tisch Details';
        
        document.getElementById('detailTableNumber').textContent = 'Tisch ' + tableId;
        document.getElementById('detailTableSeats').textContent = tableData.seats + ' Personen';
        
        const statusEl = document.getElementById('detailTableStatus');
        statusEl.className = 'table-detail-status ' + tableData.status;
        statusEl.textContent = tableData.status === 'available' ? 'Frei' : tableData.status === 'reserved' ? 'Reserviert' : 'Besetzt';
        
        // Reservierung für heute suchen
        const dateStr = getTodayString();
        const res = demoReservations.find(r => r.date === dateStr && r.table === tableId);
        if (res) {
            document.getElementById('detailReservationInfo').style.display = 'flex';
            document.getElementById('detailReservationTime').textContent = `${res.time} - ${res.name} (${res.party_size}P)`;
        } else {
            document.getElementById('detailReservationInfo').style.display = 'none';
        }
    }
}

function toggleFloorplanEdit() {
    floorplanEditMode = !floorplanEditMode;
    
    const editBtn = document.getElementById('floorplanEditBtn');
    const saveBtn = document.getElementById('floorplanSaveBtn');
    const palette = document.getElementById('elementPalette');
    const details = document.getElementById('tableDetails');
    const sidebarTitle = document.getElementById('floorplanSidebarTitle');
    
    if (floorplanEditMode) {
        if (editBtn) editBtn.style.display = 'none';
        if (saveBtn) saveBtn.style.display = 'flex';
        if (palette) palette.style.display = 'block';
        if (details) details.style.display = 'none';
        if (sidebarTitle) sidebarTitle.textContent = 'Elemente hinzufügen';
        
        // Drag & Drop initialisieren
        initFloorplanDragDrop();
        
        showToast('Bearbeitungsmodus aktiv - Elemente ziehen', 'info');
    } else {
        if (editBtn) editBtn.style.display = 'flex';
        if (saveBtn) saveBtn.style.display = 'none';
        if (palette) palette.style.display = 'none';
    }
}

function saveFloorplan() {
    floorplanEditMode = false;
    document.getElementById('floorplanEditBtn').style.display = 'flex';
    document.getElementById('floorplanSaveBtn').style.display = 'none';
    document.getElementById('elementPalette').style.display = 'none';
    showToast('Tischplan gespeichert!', 'success');
}

// ==================== DRAG & DROP TISCHPLAN ====================
var nextTableId = 10;
var draggedElement = null;
var draggedElementType = null;

function initFloorplanDragDrop() {
    const grid = document.getElementById('floorplanGrid');
    const paletteItems = document.querySelectorAll('.palette-item');
    
    if (!grid) return;
    
    // Palette Items Drag Start
    paletteItems.forEach(item => {
        item.addEventListener('dragstart', function(e) {
            draggedElement = null;
            draggedElementType = this.dataset.element;
            e.dataTransfer.setData('text/plain', draggedElementType);
            e.dataTransfer.effectAllowed = 'copy';
            this.style.opacity = '0.5';
        });
        
        item.addEventListener('dragend', function(e) {
            this.style.opacity = '1';
        });
    });
    
    // Grid Drop Zone
    grid.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
    });
    
    grid.addEventListener('drop', function(e) {
        e.preventDefault();
        
        const rect = grid.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        
        if (draggedElementType) {
            addElementToFloorplan(draggedElementType, x, y);
            draggedElementType = null;
        }
    });
    
    // Existierende Tische draggable machen
    makeTilesDraggable();
}

function addElementToFloorplan(type, x, y) {
    const grid = document.getElementById('floorplanGrid');
    if (!grid) return;
    
    let element;
    
    if (type.startsWith('table-')) {
        // Tisch hinzufügen
        const tableId = nextTableId++;
        const parts = type.split('-');
        const shape = parts[1]; // round, square, rect, long
        const seats = parseInt(parts[2]) || 4;
        
        // Zu floorplanTables Array hinzufügen
        floorplanTables.push({
            id: tableId,
            seats: seats,
            status: 'available',
            x: x,
            y: y,
            type: shape
        });
        
        let tableClass = 'fp-table-round';
        if (shape === 'square') tableClass = 'fp-table-square';
        else if (shape === 'rect') tableClass = 'fp-table-rect';
        else if (shape === 'long') tableClass = 'fp-table-long';
        
        element = document.createElement('div');
        element.className = `fp-table ${tableClass} available`;
        element.style.left = x + '%';
        element.style.top = y + '%';
        element.dataset.table = tableId;
        element.dataset.seats = seats;
        element.onclick = function() { selectFloorplanTable(tableId); };
        element.innerHTML = `
            <span class="table-number">${tableId}</span>
            <span class="table-seats">${seats}P</span>
        `;
        element.draggable = true;
        
    } else if (type === 'plant') {
        element = document.createElement('div');
        element.className = 'fp-element fp-plant';
        element.style.left = x + '%';
        element.style.top = y + '%';
        element.dataset.type = 'plant';
        element.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="1.5" width="28" height="28"><path d="M7 17.5l-2.5 2.5M12 12v10M12 12c2-5 7-6 9-4-1 5-6 6-9 4zM12 12c-2-5-7-6-9-4 1 5 6 6 9 4z"/></svg>`;
        element.draggable = true;
        
    } else if (type === 'divider') {
        element = document.createElement('div');
        element.className = 'fp-element fp-divider';
        element.style.left = x + '%';
        element.style.top = y + '%';
        element.style.width = '120px';
        element.dataset.type = 'divider';
        element.innerHTML = `<div class="divider-line"></div><span>Trennwand</span>`;
        element.draggable = true;
        
    } else if (type === 'bar') {
        element = document.createElement('div');
        element.className = 'fp-element';
        element.style.left = x + '%';
        element.style.top = y + '%';
        element.style.background = 'linear-gradient(135deg, #92400e 0%, #78350f 100%)';
        element.style.padding = '10px 30px';
        element.style.borderRadius = '8px';
        element.style.color = 'white';
        element.style.fontSize = '12px';
        element.dataset.type = 'bar';
        element.innerHTML = 'Theke';
        element.draggable = true;
        
    } else if (type === 'entrance') {
        element = document.createElement('div');
        element.className = 'fp-element fp-entrance';
        element.style.left = x + '%';
        element.style.top = y + '%';
        element.dataset.type = 'entrance';
        element.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="24" height="24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg><span>Eingang</span>`;
        element.draggable = true;
        
    } else if (type === 'kitchen') {
        element = document.createElement('div');
        element.className = 'fp-element fp-kitchen';
        element.style.left = x + '%';
        element.style.top = y + '%';
        element.dataset.type = 'kitchen';
        element.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="24" height="24"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/></svg><span>Küche</span>`;
        element.draggable = true;
        
    } else if (type === 'wc') {
        element = document.createElement('div');
        element.className = 'fp-element';
        element.style.left = x + '%';
        element.style.top = y + '%';
        element.style.background = '#e0f2fe';
        element.style.padding = '10px 15px';
        element.style.borderRadius = '8px';
        element.style.fontSize = '12px';
        element.dataset.type = 'wc';
        element.innerHTML = '🚻 WC';
        element.draggable = true;
    }
    
    if (element) {
        grid.appendChild(element);
        makeElementDraggable(element);
        showToast('Element hinzugefügt', 'success');
    }
}

function makeElementDraggable(element) {
    let isDragging = false;
    let startX, startY, initialLeft, initialTop;
    
    element.addEventListener('mousedown', function(e) {
        // Immer bewegbar, nicht nur im Edit-Mode
        if (e.target.closest('.table-number') || e.target.closest('.table-seats')) return;
        
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        initialLeft = parseFloat(element.style.left) || 0;
        initialTop = parseFloat(element.style.top) || 0;
        
        element.style.zIndex = '1000';
        element.style.cursor = 'grabbing';
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        
        const grid = document.getElementById('floorplanGrid');
        const rect = grid.getBoundingClientRect();
        
        const deltaX = ((e.clientX - startX) / rect.width) * 100;
        const deltaY = ((e.clientY - startY) / rect.height) * 100;
        
        let newLeft = initialLeft + deltaX;
        let newTop = initialTop + deltaY;
        
        // Grenzen
        newLeft = Math.max(0, Math.min(90, newLeft));
        newTop = Math.max(0, Math.min(90, newTop));
        
        element.style.left = newLeft + '%';
        element.style.top = newTop + '%';
    });
    
    document.addEventListener('mouseup', function(e) {
        if (!isDragging) return;
        isDragging = false;
        element.style.zIndex = '';
        element.style.cursor = '';
        
        // Position in floorplanTables aktualisieren
        const tableId = parseInt(element.dataset.table);
        if (tableId) {
            const table = floorplanTables.find(t => t.id === tableId);
            if (table) {
                table.x = parseFloat(element.style.left);
                table.y = parseFloat(element.style.top);
            }
        }
    });
}

function makeTilesDraggable() {
    document.querySelectorAll('.fp-table, .fp-element').forEach(el => {
        makeElementDraggable(el);
    });
}

// Initialisierung beim Tab-Wechsel
function initFloorplanOnTabSwitch() {
    setTimeout(function() {
        initFloorplanDragDrop();
        makeTilesDraggable();
    }, 100);
}

function reserveSelectedTable() {
    if (!selectedFloorplanTable) return;
    
    document.getElementById('resTable').value = selectedFloorplanTable;
    document.getElementById('resDate').value = getTodayString();
    openModal('newReservationModal');
}

function setTableOccupied() {
    if (!selectedFloorplanTable) return;
    
    const table = floorplanTables.find(t => t.id === selectedFloorplanTable);
    if (table) {
        table.status = table.status === 'occupied' ? 'available' : 'occupied';
        renderFloorplan();
        selectFloorplanTable(selectedFloorplanTable);
        showToast(table.status === 'occupied' ? 'Tisch besetzt' : 'Tisch freigegeben', 'success');
    }
}

// Reservierungs-Liste
function renderReservationList() {
    const container = document.getElementById('reservationTableBody');
    const filter = document.getElementById('listFilterDate').value;
    
    let filtered = [...demoReservations];
    const today = getTodayString();
    const tomorrow = getTomorrowString();
    
    if (filter === 'today') {
        filtered = filtered.filter(r => r.date === today);
    } else if (filter === 'tomorrow') {
        filtered = filtered.filter(r => r.date === tomorrow);
    } else if (filter === 'week') {
        const weekEnd = new Date();
        weekEnd.setDate(weekEnd.getDate() + 7);
        filtered = filtered.filter(r => new Date(r.date) <= weekEnd);
    }
    
    // Sortieren nach Datum und Zeit
    filtered.sort((a, b) => {
        if (a.date !== b.date) return a.date.localeCompare(b.date);
        return a.time.localeCompare(b.time);
    });
    
    if (filtered.length === 0) {
        container.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--slate); padding: 40px;">Keine Reservierungen gefunden</td></tr>';
        return;
    }
    
    container.innerHTML = filtered.map(res => `
        <tr>
            <td>${formatDateShort(res.date)}</td>
            <td><strong>${res.time}</strong></td>
            <td>${res.name}</td>
            <td>${res.party_size} Pers.</td>
            <td>Tisch ${res.table}</td>
            <td><span class="res-status ${res.status}">${res.status === 'confirmed' ? 'Bestätigt' : res.status === 'pending' ? 'Ausstehend' : 'Storniert'}</span></td>
            <td>
                <button onclick="editReservation(${res.id})" class="dash-btn" style="padding: 6px 10px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
                <button onclick="cancelReservation(${res.id})" class="dash-btn" style="padding: 6px 10px; color: #dc2626;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </td>
        </tr>
    `).join('');
}

function formatDateShort(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
}

function filterReservationList() {
    renderReservationList();
}

// Neue Reservierung
function openNewReservationModal() {
    document.getElementById('resDate').value = selectedCalendarDate.toISOString().split('T')[0];
    document.getElementById('newReservationForm').reset();
    document.getElementById('resDate').value = selectedCalendarDate.toISOString().split('T')[0];
    openModal('newReservationModal');
}

function quickReservation(dateStr, time) {
    document.getElementById('resDate').value = dateStr;
    document.getElementById('resTime').value = time;
    openModal('newReservationModal');
}

function doSaveReservation() {
    // Nutze NUR das neue globale System
    if (typeof window.resSaveNew === 'function') {
        window.resSaveNew();
    }
}

function saveNewReservation(e) {
    e.preventDefault();
    
    // Nutze das neue globale System
    if (typeof window.resSaveNew === 'function') {
        window.resSaveNew();
        return;
    }
}

function findAvailableTable(partySize) {
    const suitable = floorplanTables.filter(t => t.status === 'available' && t.seats >= partySize);
    return suitable.length > 0 ? suitable[0].id : 1;
}

function editReservation(id) {
    const res = demoReservations.find(r => r.id === id);
    if (!res) return;
    
    document.getElementById('resDate').value = res.date;
    document.getElementById('resTime').value = res.time;
    document.getElementById('resName').value = res.name;
    document.getElementById('resPartySize').value = res.party_size;
    document.getElementById('resPhone').value = res.phone || '';
    document.getElementById('resTable').value = res.table;
    document.getElementById('resNotes').value = res.notes || '';
    
    // Alte Reservierung löschen
    demoReservations = demoReservations.filter(r => r.id !== id);
    
    openModal('newReservationModal');
}

function cancelReservation(id) {
    if (!confirm('Reservierung wirklich stornieren?')) return;
    
    const res = demoReservations.find(r => r.id === id);
    if (res) {
        // Tisch freigeben
        const table = floorplanTables.find(t => t.id === res.table);
        if (table) table.status = 'available';
    }
    
    demoReservations = demoReservations.filter(r => r.id !== id);
    renderCalendar();
    renderDayReservations();
    renderReservationList();
    showToast('Reservierung storniert', 'success');
}

// Init Kalender
function initReservationCalendar() {
    selectedCalendarDate = new Date();
    currentCalendarMonth = new Date();
    renderCalendar();
    renderDayReservations();
    
    // Heute als Titel
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    document.getElementById('selectedDateTitle').textContent = 'Heute, ' + new Date().toLocaleDateString('de-DE', options);
}

// ==================== MENÜ SCANNER (KI) ====================

var menuScanImageData = null;
var menuScanFileType = 'image';
var menuScanFileName = '';

// PDF Upload Trigger
function triggerPdfUpload() {
    var input = document.getElementById('menuScanInput');
    if (input) {
        input.value = '';
        input.accept = 'application/pdf,.pdf';
        input.click();
        // Accept zurücksetzen nach Auswahl
        setTimeout(function() {
            input.accept = 'image/*,application/pdf,.pdf';
        }, 1000);
    }
}

// Kamera Capture
function triggerCameraCapture() {
    var input = document.getElementById('menuScanInput');
    if (input) {
        input.value = '';
        input.setAttribute('capture', 'environment');
        input.click();
        setTimeout(function() { 
            input.removeAttribute('capture');
        }, 500);
    }
}

// Drag & Drop Handler
function handleMenuDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    document.getElementById('menuScanUploadArea').classList.add('dragover');
}

function handleMenuDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    document.getElementById('menuScanUploadArea').classList.remove('dragover');
}

function handleMenuDrop(event) {
    event.preventDefault();
    event.stopPropagation();
    document.getElementById('menuScanUploadArea').classList.remove('dragover');
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        processMenuFile(files[0]);
    }
}

// Datei verarbeiten
function processMenuFile(file) {
    if (!file) return;
    
    if (file.size > 100 * 1024 * 1024) {
        showToast('Datei zu groß (max. 100MB)', 'error');
        return;
    }
    
    var fileName = file.name.toLowerCase();
    var fileType = file.type || '';
    
    // PDF Erkennung - mehrere Methoden
    var isPDF = fileType === 'application/pdf' || 
                fileType === 'application/x-pdf' ||
                fileName.endsWith('.pdf');
    
    // Bild Erkennung
    var isImage = fileType.indexOf('image/') === 0 ||
                  fileName.endsWith('.jpg') ||
                  fileName.endsWith('.jpeg') ||
                  fileName.endsWith('.png') ||
                  fileName.endsWith('.webp');
    
    if (isPDF) {
        handlePdfUpload(file);
    } else if (isImage) {
        handleImageUpload(file);
    } else {
        showToast('Bitte Bild oder PDF hochladen', 'error');
    }
}

// Bild Upload Handler
function handleImageUpload(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        menuScanImageData = e.target.result;
        menuScanFileType = 'image';
        
        document.getElementById('menuScanImage').src = menuScanImageData;
        document.getElementById('menuScanImage').style.display = 'block';
        document.getElementById('menuPdfPreview').style.display = 'none';
        document.getElementById('menuScanUploadArea').style.display = 'none';
        document.getElementById('menuScanPreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
}

// PDF Upload Handler
function handlePdfUpload(file) {
    var fileName = file.name;
    var fileSize = file.size;
    
    // FileReader erstellen
    var reader = new FileReader();
    
    reader.onload = function(event) {
        var result = event.target.result;
        
        if (!result) {
            showToast('PDF konnte nicht gelesen werden', 'error');
            return;
        }
        
        // Globale Variablen setzen
        menuScanImageData = result;
        menuScanFileType = 'pdf';
        menuScanFileName = fileName;
        
        // UI Elemente holen
        var imgEl = document.getElementById('menuScanImage');
        var pdfPreview = document.getElementById('menuPdfPreview');
        var pdfName = document.getElementById('menuPdfName');
        var pdfPages = document.getElementById('menuPdfPages');
        var uploadArea = document.getElementById('menuScanUploadArea');
        var preview = document.getElementById('menuScanPreview');
        
        // UI aktualisieren
        if (imgEl) imgEl.style.display = 'none';
        if (pdfPreview) pdfPreview.style.display = 'block';
        if (pdfName) pdfName.textContent = fileName;
        if (pdfPages) pdfPages.textContent = Math.round(fileSize / 1024) + ' KB';
        if (uploadArea) uploadArea.style.display = 'none';
        if (preview) preview.style.display = 'block';
    };
    
    reader.onerror = function() {
        showToast('Fehler beim Lesen der PDF', 'error');
    };
    
    // Datei lesen
    reader.readAsDataURL(file);
}

function handleMenuScan(event) {
    var file = event.target.files[0];
    if (file) {
        processMenuFile(file);
    }
}

async function startMenuScan() {
    if (!menuScanImageData) {
        showToast('Bitte zuerst eine Datei hochladen', 'error');
        return;
    }
    
    document.getElementById('menuScanPreview').style.display = 'none';
    document.getElementById('menuScanProgress').style.display = 'block';
    
    var statusEl = document.getElementById('menuScanStatus');
    
    try {
        var imageToScan = menuScanImageData;
        
        // PDF: Alle Seiten zu Bildern konvertieren
        var allPageImages = [];
        if (menuScanFileType === 'pdf') {
            statusEl.textContent = '📄 PDF wird konvertiert...';
            try {
                allPageImages = await convertPdfAllPages(menuScanImageData);
                statusEl.textContent = allPageImages.length + ' Seiten konvertiert!';
            } catch (pdfError) {
                console.error('PDF Fehler:', pdfError);
                // Fallback: Einzelseite
                try {
                    var singlePage = await convertPdfToImage(menuScanImageData);
                    allPageImages = [singlePage];
                } catch(e2) {
                    throw new Error('PDF-Konvertierung fehlgeschlagen: ' + pdfError.message);
                }
            }
        } else {
            allPageImages = [imageToScan];
        }
        
        // ==================== KI-ANALYSE MIT CLAUDE ====================
        statusEl.textContent = '🧠 KI analysiert Speisekarte...';
        
        // Bilder für Claude vorbereiten
        var imageContents = [];
        for (var p = 0; p < allPageImages.length; p++) {
            var imgData = allPageImages[p];
            var base64 = imgData.split(',')[1] || imgData;
            var mediaType = 'image/png';
            if (imgData.indexOf('data:image/jpeg') === 0) mediaType = 'image/jpeg';
            if (imgData.indexOf('data:image/webp') === 0) mediaType = 'image/webp';
            
            imageContents.push({
                type: 'image',
                source: { type: 'base64', media_type: mediaType, data: base64 }
            });
        }
        
        // Claude Prompt
        imageContents.push({
            type: 'text',
            text: 'Analysiere diese Speisekarte/Menü und extrahiere ALLE Gerichte. Antworte NUR mit einem JSON-Array, kein anderer Text, keine Markdown-Backticks.\n\nFür jedes Gericht:\n- "name": Gerichtname (korrekte Schreibweise, kein Tippfehler)\n- "description": Beschreibung falls vorhanden (Zutaten, Beilagen etc.)\n- "price": Preis als Zahl (z.B. 12.9 statt "12,90 €")\n- "category": Eine passende Kategorie (z.B. "Vorspeisen", "Salate", "Suppen", "Pizza", "Pasta", "Fleischgerichte", "Fischgerichte", "Burger", "Hauptgerichte", "Kindergerichte", "Desserts", "Getränke", "Weine", "Bier", "Heißgetränke", "Alkoholfreie Getränke")\n- "is_vegetarian": true/false\n- "is_vegan": true/false\n- "is_spicy": true/false\n- "is_gluten": true/false (enthält Gluten/Weizen)\n- "is_beef": true/false\n- "is_chicken": true/false\n- "is_pork": true/false\n- "is_fish": true/false\n- "is_seafood": true/false\n- "allergens": Array mit Allergen-Codes z.B. ["A","C","G"] nach EU-Kennzeichnung (A=Gluten, B=Krebstiere, C=Eier, D=Fisch, E=Erdnüsse, F=Soja, G=Milch, H=Schalenfrüchte, L=Sellerie, M=Senf, N=Sesam, O=Sulfite, P=Lupinen, R=Weichtiere)\n\nWichtig:\n- Erkenne die Allergene intelligent aus dem Gerichtnamen und den Zutaten\n- Korrigiere Schreibfehler im Namen\n- Wenn Preise in verschiedenen Größen vorhanden sind, nimm den Standardpreis\n- Gerichte ohne Preis trotzdem aufnehmen mit price: 0\n- Auch Getränke, Beilagen etc. erfassen\n\nAntwort NUR als JSON-Array: [{...}, {...}]'
        });
        
        statusEl.textContent = '🧠 Claude analysiert ' + allPageImages.length + ' Seite(n)...';
        
        var response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'claude-sonnet-4-5-20250929',
                max_tokens: 8000,
                messages: [{ role: 'user', content: imageContents }]
            })
        });
        
        if (!response.ok) {
            var errText = await response.text();
            console.error('API Fehler:', response.status, errText);
            throw new Error('KI-API Fehler (' + response.status + '). Versuche Tesseract-Fallback...');
        }
        
        var apiResult = await response.json();
        var aiText = apiResult.content.map(function(c) { return c.text || ''; }).join('');
        
        console.log('🧠 Claude Antwort:', aiText.substring(0, 200));
        
        // JSON parsen
        var cleanJson = aiText.replace(/```json|```/g, '').trim();
        // Finde das Array
        var arrStart = cleanJson.indexOf('[');
        var arrEnd = cleanJson.lastIndexOf(']');
        if (arrStart >= 0 && arrEnd > arrStart) {
            cleanJson = cleanJson.substring(arrStart, arrEnd + 1);
        }
        
        var aiItems = JSON.parse(cleanJson);
        
        // Items formatieren
        scannedMenuItems = aiItems.map(function(item) {
            return {
                name: item.name || 'Unbekannt',
                description: item.description || '',
                price: parseFloat(item.price) || 0,
                category: item.category || 'Sonstiges',
                selected: true,
                is_vegetarian: !!item.is_vegetarian,
                is_vegan: !!item.is_vegan,
                is_spicy: !!item.is_spicy,
                is_gluten: !!item.is_gluten,
                is_beef: !!item.is_beef,
                is_chicken: !!item.is_chicken,
                is_pork: !!item.is_pork,
                is_fish: !!item.is_fish,
                is_seafood: !!item.is_seafood,
                allergens: item.allergens || []
            };
        });
        
        window.scannedMenuItems = scannedMenuItems;
        console.log('🍽️ KI hat ' + scannedMenuItems.length + ' Gerichte erkannt');
        
        if (scannedMenuItems.length === 0) {
            throw new Error('Keine Gerichte erkannt. Bitte ein deutlicheres Bild verwenden.');
        }
        
        showScannedResults();
        
    } catch (error) {
        console.error('Scan Error:', error);
        
        // Bei API-Fehler: Fallback auf Tesseract
        if (error.message.indexOf('KI-API') > -1 || error.message.indexOf('fetch') > -1) {
            statusEl.textContent = '⚡ Fallback: Tesseract OCR...';
            try {
                await startMenuScanTesseract();
                return;
            } catch(e2) {
                console.error('Tesseract Fallback auch fehlgeschlagen:', e2);
            }
        }
        
        statusEl.textContent = 'Fehler: ' + error.message;
        setTimeout(function() {
            document.getElementById('menuScanProgress').style.display = 'none';
            document.getElementById('menuScanUploadArea').style.display = 'block';
            showToast('Scannen fehlgeschlagen: ' + error.message, 'error');
        }, 3000);
    }
}

// Fallback: Tesseract OCR wenn Claude API nicht verfügbar
async function startMenuScanTesseract() {
    var statusEl = document.getElementById('menuScanStatus');
    var imageToScan = menuScanImageData;
    
    if (menuScanFileType === 'pdf') {
        imageToScan = await convertPdfToImage(menuScanImageData);
    }
    
    if (typeof Tesseract === 'undefined') throw new Error('Tesseract nicht geladen');
    
    statusEl.textContent = 'Tesseract OCR läuft...';
    var worker = await Tesseract.createWorker('deu+eng', 1, {
        logger: function(m) {
            if (m.status === 'recognizing text') {
                statusEl.textContent = 'Texterkennung: ' + Math.round(m.progress * 100) + '%';
            }
        }
    });
    
    var result = await worker.recognize(imageToScan);
    await worker.terminate();
    
    var text = result.data.text;
    if (!text || text.trim().length < 10) throw new Error('Kein Text erkannt');
    
    scannedMenuItems = parseMenuText(text);
    window.scannedMenuItems = scannedMenuItems;
    
    if (scannedMenuItems.length === 0) throw new Error('Keine Gerichte erkannt');
    showScannedResults();
}

// PDF ALLE Seiten konvertieren
async function convertPdfAllPages(pdfData) {
    var pdfjsLib = window.pdfjsLib;
    if (!pdfjsLib) throw new Error('PDF.js nicht geladen');
    
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    
    var base64 = pdfData.includes(',') ? pdfData.split(',')[1] : pdfData;
    var binary = atob(base64);
    var bytes = new Uint8Array(binary.length);
    for (var i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
    
    var pdf = await pdfjsLib.getDocument({ data: bytes, cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/cmaps/', cMapPacked: true }).promise;
    var images = [];
    
    // Maximal 10 Seiten (Speisekarten sind selten länger)
    var maxPages = Math.min(pdf.numPages, 10);
    for (var p = 1; p <= maxPages; p++) {
        var page = await pdf.getPage(p);
        var viewport = page.getViewport({ scale: 2.0 });
        var canvas = document.createElement('canvas');
        canvas.width = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        var ctx = canvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        await page.render({ canvasContext: ctx, viewport: viewport }).promise;
        images.push(canvas.toDataURL('image/png'));
    }
    
    console.log('📄 ' + images.length + ' PDF-Seiten konvertiert');
    return images;
}

// PDF zu Bild konvertieren
async function convertPdfToImage(pdfData) {
    console.log('🔄 PDF Konvertierung startet...');
    
    // PDF.js Bibliothek finden
    const pdfjsLib = window.pdfjsLib;
    
    console.log('📊 PDF.js verfügbar:', !!pdfjsLib);
    
    if (!pdfjsLib) {
        console.error('❌ PDF.js nicht gefunden!');
        throw new Error('PDF.js Bibliothek nicht geladen. Bitte Seite neu laden (F5).');
    }
    
    // Worker konfigurieren
    try {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        console.log('✅ Worker URL gesetzt');
    } catch(e) {
        console.log('Worker Konfiguration:', e.message);
    }
    
    try {
        // Base64 extrahieren
        let base64 = pdfData;
        if (pdfData.includes(',')) {
            base64 = pdfData.split(',')[1];
        }
        
        if (!base64 || base64.length < 100) {
            throw new Error('PDF-Daten ungültig');
        }
        
        console.log('📄 PDF Base64 Länge:', base64.length);
        
        // Base64 zu Uint8Array
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        
        console.log('📦 Bytes:', bytes.length);
        
        // PDF laden mit erweiterten Optionen
        console.log('📖 Lade PDF Dokument...');
        const loadingTask = pdfjsLib.getDocument({ 
            data: bytes,
            cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/cmaps/',
            cMapPacked: true,
            disableFontFace: false
        });
        
        const pdf = await loadingTask.promise;
        console.log('✅ PDF geladen! Seiten:', pdf.numPages);
        
        // Erste Seite
        const page = await pdf.getPage(1);
        console.log('📄 Seite 1 geholt');
        
        // Viewport
        const scale = 2.5;
        const viewport = page.getViewport({ scale: scale });
        console.log('📐 Größe:', Math.round(viewport.width), 'x', Math.round(viewport.height));
        
        // Canvas
        const canvas = document.createElement('canvas');
        canvas.width = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        const ctx = canvas.getContext('2d');
        
        // Weißer Hintergrund für OCR
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Rendern
        console.log('🎨 Rendere...');
        await page.render({
            canvasContext: ctx,
            viewport: viewport
        }).promise;
        
        console.log('✅ Rendering fertig!');
        
        // Export
        const result = canvas.toDataURL('image/png');
        console.log('🖼️ PNG erstellt:', result.length, 'Zeichen');
        
        return result;
        
    } catch (error) {
        console.error('❌ PDF Fehler:', error);
        throw new Error('PDF-Fehler: ' + (error.message || 'Unbekannt'));
    }
}

// Text in Menü-Items parsen (intelligentes Parsing)
function parseMenuText(text) {
    const items = [];
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 2);
    
    // Preis-Pattern: 12,90 € oder 12.90€ oder €12,90 oder 12,90 oder 12.90
    const pricePattern = /(\d{1,3}[.,]\d{2})\s*€?|€\s*(\d{1,3}[.,]\d{2})/;
    
    // Kategorie-Keywords
    const categoryKeywords = {
        'vorspeisen': 'Vorspeisen', 'starter': 'Vorspeisen', 'appetizer': 'Vorspeisen',
        'suppen': 'Suppen', 'suppe': 'Suppen',
        'salat': 'Salate', 'salate': 'Salate',
        'hauptgericht': 'Hauptgerichte', 'hauptgerichte': 'Hauptgerichte', 'main': 'Hauptgerichte',
        'fleisch': 'Fleischgerichte', 'meat': 'Fleischgerichte',
        'fisch': 'Fischgerichte', 'fish': 'Fischgerichte',
        'pasta': 'Pasta', 'nudel': 'Pasta',
        'pizza': 'Pizza',
        'burger': 'Burger',
        'dessert': 'Desserts', 'nachtisch': 'Desserts', 'süß': 'Desserts',
        'getränk': 'Getränke', 'drink': 'Getränke', 'beverage': 'Getränke',
        'wein': 'Weine', 'wine': 'Weine',
        'bier': 'Bier', 'beer': 'Bier',
        'kaffee': 'Heißgetränke', 'tee': 'Heißgetränke', 'coffee': 'Heißgetränke',
        'kinder': 'Kindergerichte', 'kids': 'Kindergerichte'
    };
    
    // Eigenschaften-Keywords
    const propertyKeywords = {
        is_vegetarian: ['vegetarisch', 'veggie', 'vegetarian', 'veg.', '(v)'],
        is_vegan: ['vegan', '(vg)', 'pflanzlich'],
        is_spicy: ['scharf', 'spicy', 'chili', 'hot', '🌶'],
        is_gluten: ['weizen', 'mehl', 'paniert', 'pasta', 'nudel', 'brot', 'semmel'],
        is_beef: ['rind', 'beef', 'steak', 'burger', 'tatar'],
        is_chicken: ['huhn', 'hähnchen', 'chicken', 'geflügel', 'pute', 'truthahn'],
        is_pork: ['schwein', 'pork', 'schnitzel', 'speck', 'bacon', 'schinken'],
        is_fish: ['fisch', 'lachs', 'salmon', 'forelle', 'zander', 'kabeljau', 'thunfisch'],
        is_seafood: ['garnelen', 'shrimp', 'muscheln', 'calamari', 'tintenfisch', 'krabben', 'hummer']
    };
    
    let currentCategory = 'Sonstiges';
    let currentItem = null;
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const lineLower = line.toLowerCase();
        
        // Kategorie erkennen
        let isCategory = false;
        for (const [keyword, category] of Object.entries(categoryKeywords)) {
            if (lineLower.includes(keyword) && !pricePattern.test(line) && line.length < 40) {
                currentCategory = category;
                isCategory = true;
                break;
            }
        }
        if (isCategory) continue;
        
        // Preis finden
        const priceMatch = line.match(pricePattern);
        
        if (priceMatch) {
            const priceStr = (priceMatch[1] || priceMatch[2]).replace(',', '.');
            const price = parseFloat(priceStr);
            
            if (price > 0 && price < 500) {
                // Name ist alles vor dem Preis
                let name = line.replace(pricePattern, '').trim();
                name = name.replace(/[€\s]+$/, '').trim();
                name = name.replace(/^[-–—•·\s]+/, '').trim();
                
                if (name.length > 2 && name.length < 100) {
                    // Beschreibung aus nächster Zeile (wenn kein Preis)
                    let description = '';
                    if (i + 1 < lines.length && !pricePattern.test(lines[i + 1])) {
                        const nextLine = lines[i + 1];
                        if (nextLine.length > 5 && nextLine.length < 150 && !Object.keys(categoryKeywords).some(k => nextLine.toLowerCase().includes(k))) {
                            description = nextLine;
                        }
                    }
                    
                    // Eigenschaften erkennen
                    const itemText = (name + ' ' + description).toLowerCase();
                    const properties = {};
                    for (const [prop, keywords] of Object.entries(propertyKeywords)) {
                        properties[prop] = keywords.some(kw => itemText.includes(kw));
                    }
                    
                    items.push({
                        name: name,
                        description: description,
                        price: price,
                        category: currentCategory,
                        selected: true,
                        ...properties
                    });
                }
            }
        }
    }
    
    // Fallback: Wenn keine Items gefunden, versuche einfacheres Parsing
    if (items.length === 0) {
        const allPrices = text.match(/\d{1,3}[.,]\d{2}/g) || [];
        const textWithoutPrices = text.replace(/\d{1,3}[.,]\d{2}\s*€?/g, '|||PRICE|||');
        const parts = textWithoutPrices.split('|||PRICE|||').filter(p => p.trim().length > 3);
        
        for (let i = 0; i < Math.min(parts.length, allPrices.length); i++) {
            const name = parts[i].trim().split('\n').pop()?.trim() || parts[i].trim();
            const price = parseFloat(allPrices[i].replace(',', '.'));
            
            if (name.length > 2 && name.length < 80 && price > 0) {
                items.push({
                    name: name.substring(0, 60),
                    description: '',
                    price: price,
                    category: 'Sonstiges',
                    selected: true
                });
            }
        }
    }
    
    return items;
}

function showScannedResults() {
    console.log('📋 showScannedResults aufgerufen');
    console.log('📋 scannedMenuItems:', scannedMenuItems.length);
    
    document.getElementById('menuScanProgress').style.display = 'none';
    document.getElementById('menuScanResults').style.display = 'block';
    
    // Kategorien zählen
    var cats = {};
    scannedMenuItems.forEach(function(i) { cats[i.category] = (cats[i.category] || 0) + 1; });
    var catCount = Object.keys(cats).length;
    document.getElementById('menuScanCount').textContent = scannedMenuItems.length + ' Gerichte in ' + catCount + ' Kategorien';
    
    window.scannedMenuItems = scannedMenuItems;
    
    var container = document.getElementById('menuScanItemsList');
    var html = '';
    var lastCat = '';
    
    // Sortiere nach Kategorie
    var sorted = scannedMenuItems.slice().sort(function(a,b) { return (a.category||'').localeCompare(b.category||''); });
    // Update indizes
    var indexMap = sorted.map(function(s) { return scannedMenuItems.indexOf(s); });
    
    for (var si = 0; si < sorted.length; si++) {
        var item = sorted[si];
        var origIdx = indexMap[si];
        
        // Kategorie-Header
        if (item.category !== lastCat) {
            lastCat = item.category;
            var catItemCount = cats[lastCat] || 0;
            html += '<div style="padding: 10px 12px; margin-top: ' + (si > 0 ? '12px' : '0') + '; background: linear-gradient(135deg, var(--primary), var(--primary-dark, #059669)); color: white; border-radius: 10px; font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center;">';
            html += '<span>📂 ' + lastCat + '</span>';
            html += '<span style="background: rgba(255,255,255,0.25); padding: 2px 10px; border-radius: 8px; font-size: 12px;">' + catItemCount + '</span>';
            html += '</div>';
        }
        
        html += '<div class="menu-scan-item" style="display: flex; gap: 10px; align-items: flex-start; padding: 10px; border-bottom: 1px solid var(--border-light, #e5e7eb);">';
        html += '<input type="checkbox" ' + (item.selected ? 'checked' : '') + ' onchange="window.scannedMenuItems[' + origIdx + '].selected = this.checked; scannedMenuItems[' + origIdx + '].selected = this.checked;" style="width: 18px; height: 18px; margin-top: 4px; accent-color: var(--primary); flex-shrink: 0;">';
        html += '<div style="flex: 1; min-width: 0;">';
        
        // Name (editierbar)
        html += '<div contenteditable="true" style="font-weight: 600; font-size: 14px; outline: none; border-bottom: 1px dashed transparent; padding: 2px 0;" onfocus="this.style.borderBottomColor=\'var(--primary)\'" onblur="this.style.borderBottomColor=\'transparent\'; window.scannedMenuItems[' + origIdx + '].name = this.textContent; scannedMenuItems[' + origIdx + '].name = this.textContent;">' + (item.name || '') + '</div>';
        
        // Beschreibung
        if (item.description) {
            html += '<div style="font-size: 12px; color: var(--slate); margin: 2px 0;">' + item.description + '</div>';
        }
        
        // Badges
        html += '<div style="display: flex; align-items: center; gap: 4px; flex-wrap: wrap; margin-top: 4px;">';
        html += getScannedItemBadges(item);
        
        // Allergene
        if (item.allergens && item.allergens.length > 0) {
            html += '<span style="font-size: 10px; background: #fef3c7; color: #92400e; padding: 1px 6px; border-radius: 4px; font-weight: 500;" title="Allergene: ' + item.allergens.join(', ') + '">⚠️ ' + item.allergens.join(',') + '</span>';
        }
        html += '</div></div>';
        
        // Preis (editierbar)
        html += '<div style="flex-shrink: 0; text-align: right;">';
        html += '<input type="number" step="0.10" value="' + (item.price || 0).toFixed(2) + '" style="width: 70px; text-align: right; font-weight: 700; font-size: 15px; color: var(--primary); border: 1px solid var(--border-light, #e5e7eb); border-radius: 8px; padding: 4px 8px; background: var(--bg-secondary, #f9fafb);" onchange="window.scannedMenuItems[' + origIdx + '].price = parseFloat(this.value) || 0; scannedMenuItems[' + origIdx + '].price = parseFloat(this.value) || 0;">';
        html += '<div style="font-size: 10px; color: var(--slate); text-align: right; margin-top: 2px;">€</div>';
        html += '</div></div>';
    }
    
    container.innerHTML = html;
    console.log('✅ Ergebnisse angezeigt');
}

// Badges für gescannte Items
function getScannedItemBadges(item) {
    let badges = '';
    
    if (item.is_vegetarian) badges += '<span class="scan-badge vegetarian" title="Vegetarisch">🌿</span>';
    if (item.is_vegan) badges += '<span class="scan-badge vegan" title="Vegan">🌱</span>';
    if (item.is_spicy) badges += '<span class="scan-badge spicy" title="Scharf">🌶️</span>';
    if (item.is_beef) badges += '<span class="scan-badge beef" title="Rind">🥩</span>';
    if (item.is_chicken) badges += '<span class="scan-badge chicken" title="Huhn">🍗</span>';
    if (item.is_pork) badges += '<span class="scan-badge pork" title="Schwein">🐷</span>';
    if (item.is_fish) badges += '<span class="scan-badge fish" title="Fisch">🐟</span>';
    if (item.is_seafood) badges += '<span class="scan-badge seafood" title="Meeresfrüchte">🦐</span>';
    if (item.is_gluten) badges += '<span class="scan-badge gluten" title="Enthält Gluten">🌾</span>';
    
    return badges;
}

function cancelMenuScan() {
    scannedMenuItems = [];
    window.scannedMenuItems = [];
    menuScanImageData = null;
    closeModal('menuScannerModal');
}

// Test-Funktion mit Demo-Daten
function testImportWithDemoData() {
    console.log('🧪 Test mit Demo-Daten gestartet');
    
    // Demo-Daten setzen
    scannedMenuItems = [
        { name: 'Tomatensuppe', description: 'Mit frischem Basilikum', price: 5.90, category: 'Vorspeisen', selected: true },
        { name: 'Bruschetta', description: 'Geröstetes Brot mit Tomaten', price: 6.50, category: 'Vorspeisen', selected: true },
        { name: 'Wiener Schnitzel', description: 'Mit Pommes und Salat', price: 14.90, category: 'Hauptgerichte', selected: true },
        { name: 'Spaghetti Carbonara', description: 'Mit Speck und Ei', price: 12.50, category: 'Hauptgerichte', selected: true },
        { name: 'Tiramisu', description: 'Hausgemacht', price: 6.90, category: 'Desserts', selected: true }
    ];
    window.scannedMenuItems = scannedMenuItems;
    
    console.log('📋 Demo-Daten gesetzt:', scannedMenuItems.length);
    
    // Ergebnisse anzeigen
    showScannedResults();
    
    showToast('Demo-Daten geladen - klicke "Alle importieren"', 'info');
}

async function importScannedMenu() {
    console.log('🚀 importScannedMenu gestartet');
    
    var restaurantId = currentMenuRestaurant || window.currentMenuRestaurant || RESTAURANT_ID;
    var selectedItems = scannedMenuItems.filter(function(item) { return item.selected; });
    
    if (selectedItems.length === 0) {
        alert('Keine Gerichte ausgewählt');
        return;
    }
    
    var SUPA_H = { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };
    var importedCount = 0;
    var categoryMap = {}; // Name → ID
    
    // Schritt 1: Bestehende Kategorien laden
    try {
        var catRes = await fetch(SUPA_URL + '/rest/v1/menu_categories?restaurant_id=eq.' + restaurantId + '&select=id,name', { headers: SUPA_H });
        var existingCats = await catRes.json();
        existingCats.forEach(function(c) { categoryMap[c.name.toLowerCase()] = c.id; });
        console.log('📂 Bestehende Kategorien:', Object.keys(categoryMap));
    } catch(e) { console.log('Kategorien laden:', e); }
    
    // Schritt 2: Fehlende Kategorien anlegen
    var neededCategories = {};
    selectedItems.forEach(function(item) {
        var catName = item.category || 'Sonstiges';
        if (!categoryMap[catName.toLowerCase()]) neededCategories[catName] = true;
    });
    
    var sortOrder = Object.keys(categoryMap).length + 1;
    for (var catName in neededCategories) {
        try {
            var catRes2 = await fetch(SUPA_URL + '/rest/v1/menu_categories', {
                method: 'POST', headers: SUPA_H,
                body: JSON.stringify({ restaurant_id: restaurantId, name: catName, sort_order: sortOrder++ })
            });
            var newCat = await catRes2.json();
            if (newCat && newCat[0]) {
                categoryMap[catName.toLowerCase()] = newCat[0].id;
                console.log('✅ Kategorie erstellt:', catName, newCat[0].id);
            }
        } catch(e) { console.log('Kategorie erstellen:', e); }
    }
    
    // Schritt 3: Items importieren
    for (var j = 0; j < selectedItems.length; j++) {
        var item = selectedItems[j];
        var catId = categoryMap[(item.category || 'Sonstiges').toLowerCase()] || KATEGORIE_ID;
        
        try {
            var itemRes = await fetch(SUPA_URL + '/rest/v1/menu_items', {
                method: 'POST', headers: SUPA_H,
                body: JSON.stringify({
                    restaurant_id: restaurantId,
                    category_id: catId,
                    name: item.name,
                    description: (item.description || '') + (item.allergens && item.allergens.length > 0 ? (item.description ? ' | ' : '') + 'Allergene: ' + item.allergens.join(', ') : ''),
                    base_price: item.price,
                    is_available: true,
                    is_vegetarian: !!item.is_vegetarian,
                    is_vegan: !!item.is_vegan,
                    is_spicy: !!item.is_spicy,
                    sort_order: j + 1
                })
            });
            if (itemRes.ok) importedCount++;
        } catch(e) { console.log('Item Import:', e); }
    }
    
    var modal = document.getElementById('menuScannerModal');
    if (modal) modal.style.display = 'none';
    
    // Menü neu laden
    try {
        var client = sb || window.sb;
        if (client) {
            var { data: cats } = await client.from('menu_categories').select('*').eq('restaurant_id', restaurantId).order('sort_order');
            if (cats) { menuCategories = cats; window.menuCategories = cats; }
            var { data: items } = await client.from('menu_items').select('*').eq('restaurant_id', restaurantId).order('sort_order');
            if (items) { menuItems = items; window.menuItems = items; }
        }
    } catch(e) {}
    
    if (typeof renderMenuCategories === 'function') renderMenuCategories();
    if (typeof updateMenuStats === 'function') updateMenuStats();
    
    showToast(importedCount + ' Gerichte in ' + Object.keys(categoryMap).length + ' Kategorien importiert!', 'success');
    scannedMenuItems = [];
}

// Placeholder für Bearbeiten-Funktionen
function editCategory(categoryId) {
    showToast('Kategorie bearbeiten wird implementiert', 'info');
}

function editMenuItem(itemId) {
    showToast('Gericht bearbeiten wird implementiert', 'info');
}

// ==================== THEME SYSTEM ====================
// Theme Modus wechseln (Light/Dark)
function setThemeMode(mode) {
    console.log('🎨 Theme Modus wechseln:', mode);
    
    if (mode === 'dark') {
        document.body.classList.add('dark-mode');
        document.documentElement.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
        document.documentElement.classList.remove('dark-mode');
    }
    
    localStorage.setItem('kin_theme_mode', mode);
    console.log('✅ Theme Modus gespeichert:', mode);
}

// Theme Farbe wechseln (für aktiven Navigator)
function setThemeColor(color) {
    console.log('🎨 Theme Farbe wechseln:', color);
    
    // Alle Theme-Farben entfernen
    const themeColors = ['green', 'blue', 'purple', 'orange', 'pink', 'teal', 'red', 'yellow'];
    themeColors.forEach(c => {
        document.body.classList.remove('theme-' + c);
    });
    
    // Neue Farbe setzen
    document.body.classList.add('theme-' + color);
    
    localStorage.setItem('kin_theme_color', color);
    console.log('✅ Theme Farbe gespeichert:', color);
}

// Theme beim Laden initialisieren
function initTheme() {
    const savedMode = localStorage.getItem('kin_theme_mode') || 'light';
    const savedColor = localStorage.getItem('kin_theme_color') || 'green';
    
    setThemeMode(savedMode);
    setThemeColor(savedColor);
    
    console.log('✅ Theme initialisiert:', savedMode, savedColor);
}

// Theme beim Laden anwenden
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTheme);
} else {
    initTheme();
}

console.log('✅ KIN mit Theme-System geladen');

// ==================== BUTTON FIX - Event Listeners ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== BUTTON FIX GESTARTET ===');
    
    // Warte 1 Sekunde damit alles geladen ist
    setTimeout(function() {
        // Menü Scanner Button
        const scannerBtn = document.getElementById('menuScannerBtn');
        if (scannerBtn) {
            scannerBtn.onclick = null; // Alte onclick entfernen
            scannerBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('🔥 SCANNER KLICK!');
                if (typeof openMenuScannerModal === 'function') {
                    openMenuScannerModal();
                } else {
                    alert('Funktion nicht gefunden!');
                }
            });
            console.log('✅ Scanner Button gefixt');
        }
        
        // Kategorie Button
        const categoryBtn = document.getElementById('addCategoryBtn');
        if (categoryBtn) {
            categoryBtn.onclick = null;
            categoryBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('🔥 KATEGORIE KLICK!');
                if (typeof openAddCategoryModal === 'function') {
                    openAddCategoryModal();
                }
            });
            console.log('✅ Kategorie Button gefixt');
        }
        
        // Gericht hinzufügen Button
        const itemBtn = document.getElementById('addMenuItemBtn');
        if (itemBtn) {
            itemBtn.onclick = null;
            itemBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('🔥 GERICHT KLICK!');
                if (typeof openAddMenuItemModal === 'function') {
                    openAddMenuItemModal();
                }
            });
            console.log('✅ Gericht Button gefixt');
        }
        
        // Reservierungen Navigation
        const navRes = document.getElementById('navReservations');
        if (navRes) {
            navRes.onclick = null;
            navRes.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('🔥 RESERVIERUNGEN KLICK!');
                if (typeof showDashboardSection === 'function') {
                    showDashboardSection('reservations');
                }
            });
            console.log('✅ Reservierungen Nav gefixt');
        }
        
        // Debug Info
        console.log('Scanner:', !!scannerBtn, '- Funktion:', typeof openMenuScannerModal);
        console.log('Kategorie:', !!categoryBtn, '- Funktion:', typeof openAddCategoryModal);
        console.log('Gericht:', !!itemBtn, '- Funktion:', typeof openAddMenuItemModal);
        console.log('Reservierungen:', !!navRes, '- Funktion:', typeof showDashboardSection);
        
    }, 1500);
});

// ==================== RESERVIERUNG & TISCHPLAN INIT ====================
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        // Kalender Navigation
        var prevBtn = document.getElementById('calPrevMonth');
        var nextBtn = document.getElementById('calNextMonth');
        
        if (prevBtn) {
            prevBtn.addEventListener('click', function() {
                if (typeof changeCalendarMonth === 'function') changeCalendarMonth(-1);
            });
        }
        
        if (nextBtn) {
            nextBtn.addEventListener('click', function() {
                if (typeof changeCalendarMonth === 'function') changeCalendarMonth(1);
            });
        }
        
        // Neue Reservierung Button
        var newResBtn = document.getElementById('newReservationBtn');
        if (newResBtn) {
            newResBtn.addEventListener('click', function() {
                var modal = document.getElementById('newReservationModal');
                if (modal) {
                    modal.style.display = 'flex';
                    modal.classList.add('active');
                    // Datum setzen
                    var dateInput = document.getElementById('resDate');
                    if (dateInput && typeof selectedCalendarDate !== 'undefined') {
                        dateInput.value = selectedCalendarDate.toISOString().split('T')[0];
                    }
                }
            });
        }
        
        // Tischplan Drag & Drop initialisieren
        initFloorplanSystem();
        
        console.log('✅ Reservierung & Tischplan initialisiert');
    }, 2000);
});

// Tischplan System komplett initialisieren
function initFloorplanSystem() {
    var grid = document.getElementById('floorplanGrid');
    var paletteItems = document.querySelectorAll('.palette-item');
    
    if (!grid) {
        console.log('Floorplan Grid nicht gefunden');
        return;
    }
    
    console.log('🔧 Initialisiere Tischplan Drag & Drop...');
    console.log('Palette Items gefunden:', paletteItems.length);
    
    // Palette Items - Drag Events
    paletteItems.forEach(function(item) {
        item.setAttribute('draggable', 'true');
        
        item.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData('element-type', this.dataset.element);
            e.dataTransfer.effectAllowed = 'copy';
            this.style.opacity = '0.5';
            console.log('Drag Start:', this.dataset.element);
        });
        
        item.addEventListener('dragend', function() {
            this.style.opacity = '1';
        });
    });
    
    // Grid - Drop Zone
    grid.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
        grid.style.background = 'rgba(26, 95, 74, 0.1)';
    });
    
    grid.addEventListener('dragleave', function(e) {
        grid.style.background = '';
    });
    
    grid.addEventListener('drop', function(e) {
        e.preventDefault();
        grid.style.background = '';
        
        var elementType = e.dataTransfer.getData('element-type');
        if (!elementType) return;
        
        var rect = grid.getBoundingClientRect();
        var x = ((e.clientX - rect.left) / rect.width) * 100;
        var y = ((e.clientY - rect.top) / rect.height) * 100;
        
        console.log('Drop:', elementType, 'at', x.toFixed(1) + '%', y.toFixed(1) + '%');
        
        createFloorplanElement(elementType, x, y, grid);
    });
    
    // Existierende Elemente bewegbar machen
    makeExistingElementsDraggable();
}

// Element auf Tischplan erstellen
function createFloorplanElement(type, x, y, grid) {
    var element = document.createElement('div');
    var tableId = Date.now();
    
    if (type.startsWith('table-')) {
        var parts = type.split('-');
        var shape = parts[1];
        var seats = parseInt(parts[2]) || 4;
        
        var tableClass = 'fp-table-round';
        if (shape === 'square') tableClass = 'fp-table-square';
        else if (shape === 'rect') tableClass = 'fp-table-rect';
        else if (shape === 'long') tableClass = 'fp-table-long';
        
        element.className = 'fp-table ' + tableClass + ' available';
        element.innerHTML = '<span class="table-number">' + (floorplanTables.length + 1) + '</span><span class="table-seats">' + seats + 'P</span>';
        element.dataset.table = tableId;
        element.dataset.seats = seats;
        
        floorplanTables.push({
            id: tableId,
            seats: seats,
            status: 'available',
            x: x,
            y: y,
            type: shape
        });
        
    } else if (type === 'plant') {
        element.className = 'fp-element fp-plant';
        element.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="1.5" width="28" height="28"><path d="M7 17.5l-2.5 2.5M12 12v10M12 12c2-5 7-6 9-4-1 5-6 6-9 4zM12 12c-2-5-7-6-9-4 1 5 6 6 9 4z"/></svg>';
        
    } else if (type === 'divider') {
        element.className = 'fp-element fp-divider';
        element.style.width = '120px';
        element.innerHTML = '<div class="divider-line"></div><span>Trennwand</span>';
        
    } else if (type === 'bar') {
        element.className = 'fp-element';
        element.style.background = 'linear-gradient(135deg, #92400e 0%, #78350f 100%)';
        element.style.padding = '10px 30px';
        element.style.borderRadius = '8px';
        element.style.color = 'white';
        element.style.fontSize = '12px';
        element.innerHTML = 'Theke';
        
    } else if (type === 'entrance') {
        element.className = 'fp-element fp-entrance';
        element.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="24" height="24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg><span>Eingang</span>';
        
    } else if (type === 'kitchen') {
        element.className = 'fp-element fp-kitchen';
        element.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="24" height="24"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3v7"/></svg><span>Küche</span>';
        
    } else if (type === 'wc') {
        element.className = 'fp-element';
        element.style.background = '#e0f2fe';
        element.style.padding = '10px 15px';
        element.style.borderRadius = '8px';
        element.innerHTML = '🚻 WC';
    }
    
    element.style.position = 'absolute';
    element.style.left = x + '%';
    element.style.top = y + '%';
    element.style.cursor = 'move';
    
    grid.appendChild(element);
    makeElementMovable(element);
    
    if (typeof showToast === 'function') showToast('Element hinzugefügt', 'success');
}

// Element bewegbar machen
function makeElementMovable(element) {
    var isDragging = false;
    var startX, startY, initialLeft, initialTop;
    
    element.addEventListener('mousedown', function(e) {
        if (e.target.tagName === 'SPAN') return;
        
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        initialLeft = parseFloat(element.style.left) || 0;
        initialTop = parseFloat(element.style.top) || 0;
        element.style.zIndex = '1000';
        element.style.cursor = 'grabbing';
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        
        var grid = document.getElementById('floorplanGrid');
        if (!grid) return;
        
        var rect = grid.getBoundingClientRect();
        var deltaX = ((e.clientX - startX) / rect.width) * 100;
        var deltaY = ((e.clientY - startY) / rect.height) * 100;
        
        var newLeft = Math.max(0, Math.min(90, initialLeft + deltaX));
        var newTop = Math.max(0, Math.min(90, initialTop + deltaY));
        
        element.style.left = newLeft + '%';
        element.style.top = newTop + '%';
    });
    
    document.addEventListener('mouseup', function() {
        if (isDragging) {
            isDragging = false;
            element.style.zIndex = '';
            element.style.cursor = 'move';
        }
    });
}

// Existierende Elemente bewegbar machen
function makeExistingElementsDraggable() {
    document.querySelectorAll('.fp-table, .fp-element').forEach(function(el) {
        el.style.cursor = 'move';
        makeElementMovable(el);
    });
}

// ==================== INIT: Restaurant-Auswahl für Speisekarte ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM geladen - Initialisiere Restaurant-Auswahl...');
    
    // Event Listener für Speisekarte Tab
    var menuTab = document.querySelector('[onclick*="speisekarte"]');
    if (menuTab) {
        menuTab.addEventListener('click', function() {
            setTimeout(function() {
                if (typeof loadMenuRestaurantSelect === 'function') {
                    loadMenuRestaurantSelect();
                }
            }, 100);
        });
    }
    
    // Globale Referenz sicherstellen
    window.currentMenuRestaurant = window.currentMenuRestaurant || null;
    window.menuCategories = window.menuCategories || [];
    window.menuItems = window.menuItems || [];
    
    console.log('✅ Restaurant-System initialisiert');
});
</script>



</body>
</html>
