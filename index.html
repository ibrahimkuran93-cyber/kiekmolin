<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- SEO Meta Tags -->
    <title>Kiek mol in (KIN) – Restaurants in Ostfriesland | Greetsiel, Norddeich, Norden</title>
    <meta name="description" content="KIN - Kiek mol in: Finde die besten Restaurants in Ostfriesland! Freie Tische in Greetsiel, Norddeich, Norden, Aurich & Emden. Jetzt reservieren - kostenlos & ohne App-Download. Die Restaurant-App für Ostfriesland.">
    <meta name="keywords" content="KIN, Kiek mol in, kiekmolin, Restaurant Ostfriesland, Essen Greetsiel, Restaurant Norddeich, Fischrestaurant Nordsee, Pizzeria Ostfriesland, Café Greetsiel, Tisch reservieren, freie Tische, Urlaub Ostfriesland, Essen gehen Norden, Restaurant Aurich, Gastronomie Emden, Restaurant App, Ostfriesland App, Nordsee Restaurant, Krummhörn, Pewsum, Marienhafe, Norderney, Juist, Baltrum, Langeoog, Spiekeroog, Borkum, Wangerooge, Ostfriesische Inseln, Lieferservice Ostfriesland, Döner Ostfriesland, Shisha Bar Ostfriesland, Bar Ostfriesland, Jobs Gastronomie, Kellner gesucht">
    <meta name="author" content="Kiek mol in (KIN) - Ibrahim Kuran - Kurani Design">
    <meta name="robots" content="index, follow, max-image-preview:large">
    <meta name="google-site-verification" content="mho-dxotdZhwJ4r1IHY3YWie_77u08U4Xt8miG5IEhs">
    <meta name="googlebot" content="index, follow">
    <link rel="canonical" href="https://kiekmolin.de/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kiekmolin.de/">
    <meta property="og:title" content="Kiek mol in (KIN) – Die besten Restaurants in Ostfriesland">
    <meta property="og:description" content="KIN App: Entdecke Restaurants, Cafés und Fischrestaurants in Greetsiel, Norddeich, Norden & mehr. Finde freie Tische und reserviere direkt!">
    <meta property="og:image" content="https://kiekmolin.de/icon-512.png">
    <meta property="og:image:width" content="512">
    <meta property="og:image:height" content="512">
    <meta property="og:locale" content="de_DE">
    <meta property="og:site_name" content="Kiek mol in">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://kiekmolin.de/">
    <meta name="twitter:title" content="Kiek mol in (KIN) – Restaurants in Ostfriesland">
    <meta name="twitter:description" content="KIN: Finde die besten Restaurants in Ostfriesland. Freie Tische, Reservierungen, Bewertungen.">
    <meta name="twitter:image" content="https://kiekmolin.de/icon-512.png">
    
    <!-- Geo Tags für lokale Suche -->
    <meta name="geo.region" content="DE-NI">
    <meta name="geo.placename" content="Ostfriesland">
    <meta name="geo.position" content="53.5021;7.0965">
    <meta name="ICBM" content="53.5021, 7.0965">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a5f4a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Kiek mol in">
    <meta name="theme-color" content="#6B46C1" id="themeColorMeta">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Kiek mol in">
    <meta name="msapplication-TileColor" content="#1a5f4a">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- App Icons -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    
    <!-- Structured Data / Schema.org für Google -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Kiek mol in",
        "alternateName": ["KIN", "Kiekmolin", "Kiek mol in App", "KIN App"],
        "description": "KIN - Finde die besten Restaurants in Ostfriesland - Greetsiel, Norddeich, Norden, Aurich, Emden. Die Restaurant-App für Ostfriesland.",
        "url": "https://kiekmolin.de",
        "applicationCategory": "FoodEstablishment, TravelApplication",
        "operatingSystem": "Web, iOS, Android",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "EUR"
        },
        "author": {
            "@type": "Organization",
            "name": "Kurani Design",
            "founder": {
                "@type": "Person",
                "name": "Ibrahim Kuran"
            }
        },
        "areaServed": {
            "@type": "Place",
            "name": "Ostfriesland",
            "geo": {
                "@type": "GeoCoordinates",
                "latitude": "53.5021",
                "longitude": "7.0965"
            }
        }
    }
    </script>
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "LocalBusiness",
        "name": "Kiek mol in (KIN) - Restaurant-Finder Ostfriesland",
        "alternateName": "KIN App",
        "description": "KIN: Entdecke Restaurants, Cafés, Bars, Shisha Lounges und Fischrestaurants in Ostfriesland. Jobs in der Gastronomie.",
        "url": "https://kiekmolin.de",
        "telephone": "",
        "email": "info@kiekmolin.de",
        "address": {
            "@type": "PostalAddress",
            "streetAddress": "Waller Weg 37",
            "addressLocality": "Südbrookmerland",
            "postalCode": "26624",
            "addressCountry": "DE"
        },
        "areaServed": ["Greetsiel", "Norddeich", "Norden", "Aurich", "Emden", "Ostfriesland", "Krummhörn", "Pewsum", "Marienhafe", "Leer", "Wiesmoor", "Norderney", "Juist", "Baltrum", "Langeoog"],
        "serviceType": ["Restaurant Reservierung", "Tischreservierung", "Restaurant Suche", "Gastronomie Jobs"]
    }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Leaflet Maps (kostenlos) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            --primary: #1a5f4a;
            --primary-light: #2d8a6b;
            --primary-dark: #0f3d2f;
            --accent: #e8a838;
            --accent-light: #ffd07a;
            --cream: #faf8f3;
            --sand: #f0ebe0;
            --charcoal: #2c2c2c;
            --slate: #5a5a5a;
            --white: #ffffff;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 40px rgba(0,0,0,0.16);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 28px;
            
            /* Theme-spezifische Variablen */
            --bg-primary: #f0ebe0;
            --bg-secondary: #faf8f3;
            --bg-card: #ffffff;
            --text-primary: #2c2c2c;
            --text-secondary: #5a5a5a;
            --border-color: #e0dbd0;
        }

        /* Dark Mode */
        [data-theme="dark"],
        .dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #242424;
            --bg-card: #2c2c2c;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --border-color: #3a3a3a;
            --sand: #1a1a1a;
            --cream: #242424;
            --charcoal: #f0f0f0;
            --slate: #a0a0a0;
            --white: #2c2c2c;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 40px rgba(0,0,0,0.5);
        }

        /* Force dark mode colors on body */
        body.dark-mode {
            background: #1a1a1a !important;
            color: #f0f0f0 !important;
        }

        .dark-mode .guest-view {
            background: #242424 !important;
        }

        .dark-mode .restaurant-card,
        .dark-mode .stat-card,
        .dark-mode .modal,
        .dark-mode .bottom-nav {
            background: #2c2c2c !important;
        }

        .dark-mode .chip:not(.active) {
            background: #2c2c2c !important;
            color: #f0f0f0 !important;
        }

        .dark-mode .search-bar {
            background: #2c2c2c !important;
        }

        .dark-mode .search-bar input {
            background: transparent !important;
            color: #f0f0f0 !important;
        }

        .dark-mode .restaurant-name,
        .dark-mode .section-title,
        .dark-mode .modal-title,
        .dark-mode .favorites-header h1 {
            color: #f0f0f0 !important;
        }

        .dark-mode .restaurant-meta,
        .dark-mode .stat-label {
            color: #a0a0a0 !important;
        }

        /* Dashboard Sidebar Dark Mode Fix */
        .dark-mode .dash-sidebar {
            background: #1a1a1a !important;
        }

        .dark-mode .dash-nav-item {
            color: rgba(255,255,255,0.7) !important;
        }

        .dark-mode .dash-nav-item:hover {
            background: rgba(255,255,255,0.1) !important;
            color: #fff !important;
        }

        .dark-mode .dash-nav-item.active {
            background: var(--primary) !important;
            color: #fff !important;
        }

        .dark-mode .dash-logo .restaurant-label {
            color: rgba(255,255,255,0.5) !important;
        }

        /* ==================== APPLE-STYLE THEME SYSTEM ==================== */
        
        /* Theme Mode Buttons */
        .theme-mode-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .theme-mode-btn:hover {
            border-color: var(--primary);
        }
        
        .theme-mode-btn.active {
            border-color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
        }
        
        .theme-mode-btn span {
            font-size: 12px;
            color: var(--text-primary);
        }
        
        .theme-preview {
            width: 60px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .theme-preview-light {
            background: linear-gradient(135deg, #f8f8f8 50%, #e0e0e0 50%);
        }
        
        .theme-preview-dark {
            background: linear-gradient(135deg, #2c2c2c 50%, #1a1a1a 50%);
        }
        
        .theme-preview-auto {
            background: linear-gradient(135deg, #f8f8f8 25%, #2c2c2c 25%, #2c2c2c 50%, #e0e0e0 50%, #e0e0e0 75%, #1a1a1a 75%);
        }
        
        /* Accent Colors */
        .accent-colors {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .accent-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 3px solid transparent;
            background: var(--accent);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .accent-btn:hover {
            transform: scale(1.1);
        }
        
        .accent-btn.active {
            border-color: var(--text-primary);
            transform: scale(1.15);
        }
        
        /* Glass Effect Buttons */
        .glass-btn, .corner-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .glass-btn:hover, .corner-btn:hover {
            border-color: var(--primary);
        }
        
        .glass-btn.active, .corner-btn.active {
            border-color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
        }
        
        .glass-btn span, .corner-btn span {
            font-size: 13px;
            color: var(--text-primary);
        }
        
        /* Glasmorphism Effects */
        .glass-effect-subtle .modal,
        .glass-effect-subtle .bottom-nav,
        .glass-effect-subtle .dash-sidebar {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.85) !important;
        }
        
        .glass-effect-strong .modal,
        .glass-effect-strong .bottom-nav,
        .glass-effect-strong .restaurant-card,
        .glass-effect-strong .stat-card,
        .glass-effect-strong .dash-sidebar {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(255,255,255,0.75) !important;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .dark-mode.glass-effect-subtle .modal,
        .dark-mode.glass-effect-subtle .bottom-nav {
            background: rgba(30,30,30,0.85) !important;
        }
        
        .dark-mode.glass-effect-strong .modal,
        .dark-mode.glass-effect-strong .bottom-nav,
        .dark-mode.glass-effect-strong .restaurant-card,
        .dark-mode.glass-effect-strong .stat-card {
            background: rgba(30,30,30,0.75) !important;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Icon Labels für Formulare - wie Navigator */
        .label-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            margin-right: 6px;
            vertical-align: middle;
        }
        
        .label-icon svg {
            width: 16px;
            height: 16px;
        }
        
        .form-label {
            display: flex;
            align-items: center;
        }
        
        /* Corner Radius Variants */
        .corners-sharp {
            --radius-sm: 2px;
            --radius-md: 4px;
            --radius-lg: 6px;
            --radius-xl: 8px;
        }
        
        .corners-rounded {
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 18px;
        }
        
        .corners-pill {
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 20px;
            --radius-xl: 24px;
        }

        .dark-mode .form-input,
        .dark-mode .form-select,
        .dark-mode .form-textarea {
            background: #2c2c2c !important;
            color: #f0f0f0 !important;
            border-color: #3a3a3a !important;
        }

        .dark-mode .location-btn:not(.active) {
            background: #2c2c2c !important;
            color: #f0f0f0 !important;
            border-color: #3a3a3a !important;
        }

        .dark-mode .rating {
            background: #3a3a3a !important;
            color: #f0f0f0 !important;
        }

        /* Weather Alert Banner Dark Mode */
        .dark-mode #weatherAlertBanner {
            background: rgba(44, 44, 44, 0.9) !important;
            border-color: rgba(60, 60, 60, 0.5) !important;
        }

        .dark-mode #alertTitle {
            color: #f0f0f0 !important;
        }

        .dark-mode #alertMessage {
            color: #a0a0a0 !important;
        }

        .dark-mode .guest-header::after {
            background: #242424 !important;
        }

        /* Dashboard Dark Mode */
        .dark-mode .dashboard-view {
            background: #1a1a1a !important;
        }

        .dark-mode .dash-main {
            background: #1a1a1a !important;
        }

        .dark-mode .dash-header {
            background: #242424 !important;
            border-color: #3a3a3a !important;
        }

        .dark-mode .dash-greeting {
            color: #f0f0f0 !important;
        }

        .dark-mode .stat-panel,
        .dark-mode .panel {
            background: #2c2c2c !important;
        }

        .dark-mode .stat-panel h3,
        .dark-mode .panel-title {
            color: #f0f0f0 !important;
        }

        .dark-mode .stat-panel p {
            color: #a0a0a0 !important;
        }

        .dark-mode table {
            background: #2c2c2c !important;
        }

        .dark-mode th {
            background: #3a3a3a !important;
            color: #f0f0f0 !important;
        }

        .dark-mode td {
            color: #f0f0f0 !important;
            border-color: #3a3a3a !important;
        }

        .dark-mode tr:hover {
            background: #3a3a3a !important;
        }

        .dark-mode .dash-btn-secondary {
            background: #3a3a3a !important;
            color: #f0f0f0 !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: transparent;
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* View Toggle */
        .view-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 6px;
            box-shadow: var(--shadow-md);
        }

        .toggle-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
        }

        .toggle-btn.active {
            background: var(--primary);
            color: var(--white);
        }

        .toggle-btn:hover:not(.active) {
            background: var(--sand);
        }

        /* Location Buttons */
        .location-btn {
            padding: 14px 16px;
            border: 2px solid var(--sand);
            background: var(--white);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--charcoal);
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        .location-btn:hover {
            border-color: var(--primary);
            background: var(--cream);
        }
        .location-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        /* Filter Chips */
        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1.5px solid var(--border-color);
            background: var(--bg-card);
            color: var(--slate);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        
        .filter-chip:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .filter-chip.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .dark-mode .filter-chip {
            background: #2c2c2c;
            border-color: #3a3a3a;
            color: #a0a0a0;
        }
        
        .dark-mode .filter-chip.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Open Badge */
        .open-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .open-badge.open {
            background: rgba(52, 199, 89, 0.15);
            color: #34c759;
        }
        
        .open-badge.closed {
            background: rgba(255, 59, 48, 0.15);
            color: #ff3b30;
        }

        /* Language Switcher */
        .lang-switcher {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        
        .lang-btn {
            padding: 6px 10px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            color: var(--slate);
            transition: all 0.2s;
        }
        
        .lang-btn.active {
            background: var(--bg-card);
            color: var(--dark);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            max-width: 450px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 24px 24px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        /* Slot Selection Styles */
        .slots-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .slot-btn {
            padding: 10px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-card);
            color: var(--dark);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'DM Sans', sans-serif;
        }
        
        .slot-btn:hover {
            border-color: var(--primary);
            background: rgba(26,79,99,0.05);
        }
        
        .slot-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .slot-btn.unavailable {
            opacity: 0.4;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        .slot-btn .slot-tables {
            font-size: 10px;
            font-weight: 400;
            opacity: 0.7;
            display: block;
            margin-top: 2px;
        }
        
        .slots-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--slate);
        }
        
        .slots-loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            transition: border-color 0.2s ease;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        /* Location Button */
        .location-btn {
            padding: 14px 16px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .location-btn:hover {
            border-color: var(--primary);
        }

        .location-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: #2c2c2c;
            color: #ffffff;
            padding: 14px 24px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        [data-theme="dark"] .toast {
            background: #404040;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Guest View */
        .guest-view {
            display: block;
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
            min-height: 100vh;
            background: var(--bg-secondary);
            position: relative;
            overflow: hidden;
        }
        
        /* Desktop: Volle Breite */
        @media (min-width: 768px) {
            .guest-view {
                max-width: 100%;
            }
            
            .bottom-nav {
                max-width: 100%;
            }
        }
        
        /* Große Bildschirme */
        @media (min-width: 1200px) {
            .guest-view {
                max-width: 100%;
            }
            
            .bottom-nav {
                max-width: 100%;
            }
        }

        .guest-view.hidden {
            display: none;
        }

        /* Header */
        .guest-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 60px 24px 100px;
            position: relative;
            overflow: hidden;
            margin: 0;
        }

        .guest-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -30%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(232,168,56,0.2) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
        }

        .guest-header::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 0;
            right: 0;
            height: 40px;
            background: var(--bg-secondary);
            border-radius: 50% 50% 0 0;
            pointer-events: none;
            z-index: 1;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 32px;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }

        .logo span {
            color: var(--accent);
        }

        .tagline {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            margin-bottom: 24px;
        }

        .location-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 14px 18px;
            border-radius: var(--radius-md);
            color: white;
            cursor: pointer;
        }

        .location-bar svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .location-bar span {
            font-weight: 500;
        }

        .location-bar .change {
            margin-left: auto;
            font-size: 13px;
            opacity: 0.8;
        }

        /* Quick Stats */
        .quick-stats {
            display: flex;
            gap: 12px;
            padding: 0 20px;
            margin-top: -50px;
            position: relative;
            z-index: 10;
        }

        .stat-card {
            flex: 1;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Section */
        .section {
            padding: 24px 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 22px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .see-all {
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
        }

        /* Search Bar */
        .search-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .search-bar svg {
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
        }

        .search-bar input {
            flex: 1;
            border: none;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            outline: none;
            background: transparent;
            color: var(--text-primary);
        }

        .search-bar input::placeholder {
            color: var(--text-secondary);
        }

        /* Filter Chips */
        .filter-chips {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-bottom: 16px;
            -webkit-overflow-scrolling: touch;
        }

        .filter-chips::-webkit-scrollbar {
            display: none;
        }

        .chip {
            padding: 10px 18px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-primary);
        }

        .chip.active {
            background: var(--primary);
            color: white;
        }

        .chip:hover:not(.active) {
            border-color: var(--primary);
        }

        /* Restaurant Card */
        .restaurant-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: visible;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .restaurant-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .restaurant-card.hidden {
            display: none;
        }

        .card-image {
            height: 160px;
            background-size: cover;
            background-position: center;
            position: relative;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            overflow: hidden;
        }

        .card-image::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(transparent, rgba(0,0,0,0.4));
        }

        .availability-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .availability-badge.available {
            background: var(--success);
            color: var(--white);
        }

        .availability-badge.limited {
            background: var(--warning);
            color: var(--white);
        }

        .availability-badge.full {
            background: var(--danger);
            color: var(--white);
        }

        .availability-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .special-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--accent);
            color: #2c2c2c;
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 700;
        }

        .favorite-btn {
            position: absolute;
            bottom: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: var(--bg-card);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            transition: all 0.2s ease;
        }

        .favorite-btn svg {
            width: 20px;
            height: 20px;
            stroke: var(--danger);
            fill: transparent;
            transition: all 0.2s ease;
        }

        .favorite-btn.active svg {
            fill: var(--danger);
        }

        .card-content {
            padding: 16px;
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .restaurant-name {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-cuisine {
            font-size: 13px;
            color: var(--slate);
            margin: 4px 0 8px 0;
        }

        .today-special {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(26, 95, 74, 0.08);
            border: 1px solid rgba(26, 95, 74, 0.2);
            border-radius: 10px;
            padding: 10px 12px;
            margin: 12px 0;
            font-size: 13px;
        }

        .ar-btn {
            background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .special-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .rating svg {
            width: 14px;
            height: 14px;
            fill: var(--accent);
        }

        .restaurant-meta {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .meta-item svg {
            width: 14px;
            height: 14px;
            opacity: 0.6;
        }

        .today-special {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            color: var(--white);
            padding: 12px;
            border-radius: var(--radius-sm);
            font-size: 13px;
        }

        .today-special strong {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .card-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-top: 14px;
        }

        .card-actions::-webkit-scrollbar {
            display: none;
        }

        .card-btn {
            padding: 10px 6px;
            border: none;
            border-radius: var(--radius-md);
            font-family: 'DM Sans', sans-serif;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            text-decoration: none;
            white-space: nowrap;
            min-height: 52px;
        }
        
        .card-btn svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .card-btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .card-btn-primary:hover {
            background: var(--primary-dark);
        }

        .card-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .card-btn-secondary:hover {
            background: var(--border-color);
        }

        .dark-mode .card-btn-secondary {
            background: #3a3a3a !important;
            color: #f0f0f0 !important;
        }

        .card-btn-whatsapp {
            background: #25D366;
            color: white;
        }

        .card-btn-whatsapp:hover {
            background: #1da851;
        }

        .card-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Swipe Container - nur für Buttons */
        .swipe-container {
            /* Normale Liste, kein Swipe für Cards */
        }

        .swipe-dots {
            display: none;
        }

        /* Live Counter */
        .live-section {
            background: var(--charcoal);
            margin: 0 20px;
            border-radius: var(--radius-lg);
            padding: 20px;
            color: var(--white);
            position: relative;
            overflow: hidden;
        }

        .live-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, var(--primary) 0%, transparent 70%);
            opacity: 0.3;
        }

        .live-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .live-title {
            font-weight: 600;
            font-size: 15px;
        }

        .live-count {
            font-family: 'Playfair Display', serif;
            font-size: 48px;
            font-weight: 700;
            color: var(--accent);
            line-height: 1;
        }

        .live-label {
            font-size: 14px;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            background: var(--bg-card);
            padding: 12px 20px calc(12px + env(safe-area-inset-bottom, 16px));
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            border-radius: 0;
            z-index: 1000;
        }
        
        @media screen and (max-width: 430px) {
            .bottom-nav {
                left: 0;
                right: 0;
                max-width: 100%;
                border-radius: 0;
            }
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: color 0.2s ease;
            position: relative;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
        }

        .nav-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: 700;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Favorites View */
        .favorites-view {
            display: none;
            padding: 0;
            padding-bottom: 100px;
        }

        .favorites-view.active {
            display: block;
        }
        
        .favorites-view .guest-header {
            border-radius: 0;
            margin: 0;
        }
        
        .favorites-view .section,
        .favorites-view .quick-stats,
        .favorites-view .search-bar,
        .favorites-view .filter-chips {
            padding-left: 20px;
            padding-right: 20px;
        }
        
        .favorites-view .quick-stats {
            margin: 0;
            padding-top: 20px;
        }

        .favorites-header {
            padding-top: 40px;
            margin-bottom: 24px;
        }

        .favorites-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* ==================== DASHBOARD VIEW ==================== */
        .dashboard-view {
            display: none;
            min-height: 100vh;
            background: var(--bg-secondary);
        }

        .dashboard-view.active {
            display: block;
        }

        .dash-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: var(--charcoal);
            padding: 24px 0;
            z-index: 100;
        }

        .dash-logo {
            padding: 0 24px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .dash-logo .logo {
            font-size: 24px;
        }

        .dash-logo .restaurant-label {
            color: rgba(255,255,255,0.5);
            font-size: 13px;
            margin-top: 4px;
        }

        .dash-nav {
            padding: 24px 16px;
        }

        .dash-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            color: rgba(255,255,255,0.6);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 4px;
        }

        .dash-nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: var(--white);
        }

        .dash-nav-item.active {
            background: var(--primary);
            color: var(--white);
        }

        .dash-nav-item svg {
            width: 20px;
            height: 20px;
        }

        .nav-count {
            margin-left: auto;
            background: var(--primary-light);
            color: var(--white);
            font-size: 11px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .dash-nav-item.active .nav-count {
            background: rgba(255,255,255,0.3);
        }

        /* Dashboard Sections */
        .dash-section {
            display: none;
        }

        .dash-section.active {
            display: block;
        }

        .gastro-view {
            display: none;
            min-height: 100vh;
            background: var(--bg);
        }
        
        .gastro-view.active {
            display: block;
        }

        .section-back {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .section-back:hover {
            color: var(--primary-dark);
        }

        .section-page-title {
            font-family: 'Playfair Display', serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--charcoal);
            margin-bottom: 24px;
        }

        .dash-main {
            margin-left: 260px;
            padding: 24px 32px;
            padding-bottom: 100px;
        }

        .dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .dash-greeting {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 600;
            color: var(--charcoal);
        }

        .dash-date {
            color: var(--slate);
            font-size: 14px;
            margin-top: 4px;
        }

        .dash-actions {
            display: flex;
            gap: 12px;
        }

        .dash-btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .dash-btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .dash-btn-primary:hover {
            background: var(--primary-dark);
        }

        .dash-btn-secondary {
            background: var(--white);
            color: var(--charcoal);
            box-shadow: var(--shadow-sm);
        }

        .dash-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-box {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
        }

        .stat-box-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-box-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-box-icon.green {
            background: rgba(52, 199, 89, 0.15);
            color: var(--success);
        }

        .stat-box-icon.orange {
            background: rgba(255, 149, 0, 0.15);
            color: var(--warning);
        }

        .stat-box-icon.blue {
            background: rgba(26, 95, 74, 0.15);
            color: var(--primary);
        }

        .stat-box-icon.gold {
            background: rgba(232, 168, 56, 0.15);
            color: var(--accent);
        }

        .stat-box-icon svg {
            width: 24px;
            height: 24px;
        }

        .stat-box-trend {
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-box-trend.up {
            color: var(--success);
        }

        .stat-box-value {
            font-family: 'Playfair Display', serif;
            font-size: 36px;
            font-weight: 700;
            color: var(--charcoal);
            line-height: 1;
        }

        .stat-box-label {
            font-size: 14px;
            color: var(--slate);
            margin-top: 8px;
        }

        /* Panels */
        .panels-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .panel {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .panel-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--sand);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 600;
        }

        .panel-content {
            padding: 20px 24px;
        }

        /* Availability Control */
        .availability-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--sand);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
        }

        .availability-status {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-indicator.closed {
            background: var(--danger);
        }

        .status-text {
            font-weight: 600;
        }

        .toggle-switch {
            width: 52px;
            height: 28px;
            background: var(--success);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            right: 3px;
            width: 22px;
            height: 22px;
            background: var(--white);
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .toggle-switch.off {
            background: var(--danger);
        }

        .toggle-switch.off::after {
            right: auto;
            left: 3px;
        }

        /* Table Grid */
        .table-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .table-item {
            aspect-ratio: 1;
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .table-item.free {
            background: rgba(52, 199, 89, 0.15);
            color: var(--success);
        }

        .table-item.occupied {
            background: rgba(255, 59, 48, 0.15);
            color: var(--danger);
        }

        .table-item.reserved {
            background: rgba(255, 149, 0, 0.15);
            color: var(--warning);
        }

        .table-item:hover {
            border-color: currentColor;
            transform: scale(1.05);
        }

        .table-number {
            font-weight: 700;
            font-size: 18px;
        }

        .table-seats {
            font-size: 11px;
            opacity: 0.8;
        }

        .table-legend {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            font-size: 13px;
            color: var(--slate);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }

        .legend-dot.free { background: rgba(52, 199, 89, 0.3); }
        .legend-dot.occupied { background: rgba(255, 59, 48, 0.3); }
        .legend-dot.reserved { background: rgba(255, 149, 0, 0.3); }

        /* Reservations */
        .reservation-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 0;
            border-bottom: 1px solid var(--sand);
        }

        .reservation-item:last-child {
            border-bottom: none;
        }

        .reservation-time {
            width: 60px;
            text-align: center;
        }

        .reservation-time-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--charcoal);
        }

        .reservation-time-label {
            font-size: 11px;
            color: var(--slate);
        }

        .reservation-info {
            flex: 1;
        }

        .reservation-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .reservation-details {
            font-size: 13px;
            color: var(--slate);
        }

        .reservation-actions {
            display: flex;
            gap: 8px;
        }

        .reservation-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reservation-btn.confirm {
            background: rgba(52, 199, 89, 0.15);
            color: var(--success);
        }

        .reservation-btn.cancel {
            background: rgba(255, 59, 48, 0.15);
            color: var(--danger);
        }

        .reservation-btn svg {
            width: 16px;
            height: 16px;
        }

        .reservation-status {
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
        }

        .reservation-status.confirmed {
            background: rgba(52, 199, 89, 0.15);
            color: var(--success);
        }

        .reservation-status.pending {
            background: rgba(255, 149, 0, 0.15);
            color: var(--warning);
        }

        .reservation-status.cancelled {
            background: rgba(255, 59, 48, 0.15);
            color: var(--danger);
        }

        /* Offer Form */
        .offer-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .offer-preview {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            color: var(--white);
            padding: 20px;
            border-radius: var(--radius-md);
            text-align: center;
        }

        .offer-preview-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .offer-preview-title {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .offer-preview-discount {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Active Offers */
        .active-offers {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--sand);
        }

        .active-offers h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--slate);
        }

        .offer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--sand);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .offer-item-info h5 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .offer-item-info p {
            font-size: 12px;
            color: var(--slate);
        }

        .offer-item-delete {
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(255, 59, 48, 0.15);
            color: var(--danger);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ==================== DESKTOP LAYOUT ==================== */
        @media (min-width: 768px) {
            /* Container zentrieren */
            .guest-view {
                max-width: 1400px;
                margin: 0 auto;
                padding: 0 40px;
            }
            
            /* Header Desktop */
            .guest-header {
                padding: 30px 40px 90px;
                border-radius: 0 0 32px 32px;
            }
            
            .guest-header .logo {
                font-size: 42px;
            }
            
            .guest-header .tagline {
                font-size: 18px;
            }
            
            /* Quick Actions Desktop */
            .quick-stats {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 16px;
            }
            
            /* Restaurant Grid Desktop */
            #restaurantList {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 24px;
            }
            
            .restaurant-card {
                margin-bottom: 0;
            }
            
            /* Offers Grid */
            .live-section {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
            }
            
            /* Navigation Desktop - oben statt unten */
            .bottom-nav {
                position: fixed;
                top: 0;
                bottom: auto;
                border-radius: 0;
                border-top: none;
                border-bottom: 1px solid var(--sand);
                padding: 12px 40px;
                justify-content: flex-end;
                gap: 32px;
                max-width: 1400px;
                left: 50%;
                transform: translateX(-50%);
                width: 100%;
            }
            
            .nav-item {
                flex-direction: row;
                gap: 8px;
            }
            
            .nav-item span {
                font-size: 14px;
            }
            
            /* Content Padding für Top-Nav */
            .guest-view {
                padding-top: 70px;
            }
            
            /* Footer anpassen */
            footer {
                padding-bottom: 40px !important;
            }
            
            /* Assistent Button Position */
            .assistant-btn {
                bottom: 30px;
                right: 40px;
            }
            
            /* Modals größer */
            .modal {
                max-width: 600px;
            }
            
            /* Section Titles */
            .section-title {
                font-size: 28px;
            }
            
            /* Filter Chips */
            .filter-chip {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            /* Wetter Widget */
            #weatherWidget {
                padding: 24px;
                border-radius: 20px;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            
            /* Map größer */
            #guestMap {
                height: 350px;
                border-radius: 20px;
            }
        }
        
        /* Große Desktops */
        @media (min-width: 1200px) {
            #restaurantList {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .quick-stats {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .live-section {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Extra große Bildschirme */
        @media (min-width: 1600px) {
            #restaurantList {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Mobile responsive */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 900px) {
            .dash-sidebar {
                display: none;
            }
            .dash-main {
                margin-left: 0;
            }
            .panels-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Handy - Bottom Nav wieder unten */
        @media (max-width: 767px) {
            .bottom-nav {
                position: fixed;
                top: auto;
                bottom: 0;
                transform: none;
                left: 0;
                border-radius: 20px 20px 0 0;
                border-bottom: none;
                border-top: 1px solid var(--sand);
                padding: 8px 0 25px;
                justify-content: space-around;
            }
            
            .guest-view {
                padding-top: 0;
            }
            
            .nav-item {
                flex-direction: column;
                gap: 2px;
            }
        }

        /* ==================== JOBS SECTION ==================== */
        .job-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .job-card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .job-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .job-badge.fulltime {
            background: rgba(52, 199, 89, 0.15);
            color: #34c759;
        }
        
        .job-badge.parttime {
            background: rgba(255, 149, 0, 0.15);
            color: #ff9500;
        }
        
        .job-badge.minijob {
            background: rgba(90, 200, 250, 0.15);
            color: #5ac8fa;
        }
        
        .job-badge.urgent {
            background: rgba(255, 59, 48, 0.15);
            color: #ff3b30;
        }

        /* KI Assistent */
        .assistant-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(26, 95, 74, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .assistant-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(26, 95, 74, 0.5);
        }

        .assistant-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 2500;
            padding: 20px;
        }

        .assistant-overlay.active {
            display: flex;
        }

        .assistant-chat {
            background: var(--bg-card);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 100%;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -4px 30px rgba(0,0,0,0.2);
            animation: slideUpChat 0.3s ease;
        }

        @keyframes slideUpChat {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .assistant-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .assistant-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .assistant-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .assistant-message {
            display: flex;
            max-width: 85%;
        }

        .assistant-message.bot {
            align-self: flex-start;
        }

        .assistant-message.user {
            align-self: flex-end;
        }

        .assistant-message .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
        }

        .assistant-message.bot .message-content {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .assistant-message.user .message-content {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .assistant-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .assistant-suggestions button {
            padding: 8px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .assistant-suggestions button:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .assistant-input {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
        }

        .assistant-input input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .assistant-input input:focus {
            border-color: var(--primary);
        }

        .assistant-input button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .assistant-input button:hover {
            background: var(--primary-dark);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* Notifications */
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            font-size: 11px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }

        .notification-badge.hidden {
            display: none;
        }

        .notification-item {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: var(--bg-secondary);
        }

        .notification-item.unread {
            background: rgba(26, 95, 74, 0.05);
        }

        [data-theme="dark"] .notification-item.unread {
            background: rgba(26, 95, 74, 0.15);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .notification-icon.green { background: rgba(52, 199, 89, 0.15); }
        .notification-icon.orange { background: rgba(255, 149, 0, 0.15); }
        .notification-icon.blue { background: rgba(0, 122, 255, 0.15); }
        .notification-icon.red { background: rgba(255, 59, 48, 0.15); }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .notification-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .notification-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .notification-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 6px;
        }

        .empty-notifications {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-notifications svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.3;
        }
        
        /* ==================== COMMUNITY & REVIEWS ==================== */
        .live-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(52, 199, 89, 0.15);
            color: #34c759;
            font-size: 11px;
            font-weight: 600;
            border-radius: 6px;
        }
        
        .live-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            background: #34c759;
            border-radius: 50%;
            animation: pulse-live 2s infinite;
        }
        
        @keyframes pulse-live {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .visitors-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(255, 149, 0, 0.15);
            color: #ff9500;
            font-size: 11px;
            font-weight: 600;
            border-radius: 6px;
        }
        
        .trending-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(255, 59, 48, 0.15);
            color: #ff3b30;
            font-size: 11px;
            font-weight: 600;
            border-radius: 6px;
        }
        
        /* Activity Feed */
        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        
        .activity-item.activity-new {
            background: rgba(52, 199, 89, 0.1);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .activity-icon {
            font-size: 16px;
        }
        
        .activity-text {
            flex: 1;
            color: var(--text-primary);
        }
        
        .activity-time {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        /* Reviews */
        .reviews-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .review-card {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .review-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .review-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
        }
        
        .review-meta {
            flex: 1;
        }
        
        .review-author {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .review-date {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .review-stars {
            color: #ffb800;
            font-size: 14px;
        }
        
        .review-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .review-comment {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }
        
        .review-photos {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            overflow-x: auto;
        }
        
        .review-photo {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
        }
        
        .review-helpful {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .helpful-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .helpful-btn:hover {
            background: var(--bg-secondary);
            color: var(--primary);
            border-color: var(--primary);
        }
        
        .helpful-btn.active {
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary);
            border-color: var(--primary);
        }
        
        /* Write Review */
        .star-rating-input {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
        }
        
        .star-rating-input span {
            font-size: 32px;
            cursor: pointer;
            color: #ddd;
            transition: all 0.15s;
        }
        
        .star-rating-input span:hover,
        .star-rating-input span.active {
            color: #ffb800;
            transform: scale(1.1);
        }
        
        .photo-upload-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .photo-upload-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .photo-upload-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-upload-item .remove-photo {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
        }
        
        .photo-upload-add {
            aspect-ratio: 1;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 24px;
            transition: all 0.2s;
        }
        
        .photo-upload-add:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        /* Stats Summary */
        .stats-summary {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        
        .stat-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 20px;
            font-size: 13px;
        }
        
        .stat-chip-icon {
            font-size: 14px;
        }
        
        .stat-chip-value {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .stat-chip-label {
            color: var(--text-secondary);
        }
        
        /* ==================== GEZEITEN WIDGET ==================== */
        .tide-widget {
            background: linear-gradient(135deg, #0077b6 0%, #00b4d8 100%);
            border-radius: 16px;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
        }
        
        .tide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .tide-title {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tide-status {
            font-size: 11px;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .tide-visual {
            height: 60px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .tide-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.3);
            transition: height 1s ease;
        }
        
        .tide-marker {
            position: absolute;
            width: 3px;
            height: 100%;
            background: white;
            opacity: 0.5;
        }
        
        .tide-times {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }
        
        .tide-time {
            text-align: center;
        }
        
        .tide-time-label {
            font-size: 10px;
            opacity: 0.7;
        }
        
        .tide-suggestions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 12px;
            display: flex;
            align-items: flex-start;
        }
        
        /* ==================== GAMIFICATION ==================== */
        .points-display {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%);
            border-radius: 20px;
            font-weight: 700;
            color: #333;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255,183,0,0.3);
        }
        
        .points-display:hover {
            transform: scale(1.05);
        }
        
        .level-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .level-bronze { background: #cd7f32; color: white; }
        .level-silver { background: #c0c0c0; color: #333; }
        .level-gold { background: #ffd700; color: #333; }
        .level-platinum { background: linear-gradient(135deg, #e5e4e2 0%, #a8a8a8 100%); color: #333; }
        .level-diamond { background: linear-gradient(135deg, #b9f2ff 0%, #48d1cc 100%); color: #333; }
        
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            border-radius: 20px;
            padding: 32px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 10000;
            animation: achievementPop 0.5s ease forwards;
        }
        
        @keyframes achievementPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        .achievement-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffb800);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        /* ==================== WARTEZEIT TRACKER ==================== */
        .wait-tracker {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .wait-bar {
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .wait-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .wait-low { background: #34c759; }
        .wait-medium { background: #ff9500; }
        .wait-high { background: #ff3b30; }
        
        .best-time-hint {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(52, 199, 89, 0.15);
            color: #34c759;
            font-size: 11px;
            border-radius: 6px;
        }
        
        /* ==================== ÜBERRASCHUNGS-MODUS ==================== */
        .surprise-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 50%, #48dbfb 100%);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(255,107,107,0.3);
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .surprise-btn:hover {
            transform: scale(1.05);
        }
        
        /* ==================== GRUPPEN-RESERVIERUNG ==================== */
        .group-invite {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            border-radius: 12px;
            padding: 16px;
            color: white;
        }
        
        .group-members {
            display: flex;
            gap: -8px;
        }
        
        .group-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid white;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-left: -8px;
        }
        
        .group-avatar:first-child {
            margin-left: 0;
        }
        
        .vote-option {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .vote-option:hover {
            border-color: var(--primary);
        }
        
        .vote-option.voted {
            border-color: #34c759;
            background: rgba(52, 199, 89, 0.1);
        }
        
        .vote-count {
            display: flex;
            gap: 4px;
        }
        
        .vote-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
        }
        
        /* Reward Icon Buttons */
        .reward-icon-btn {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-secondary);
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reward-icon-btn:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }
        
        .reward-icon-btn.active {
            border-color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.2);
        }
        
        /* ===== TISCHPLAN IM KIN-DESIGN ===== */
        .tischplan-box {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .tischplan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .tischplan-header h3 {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            margin: 0;
        }
        
        .tischplan-btn-add {
            padding: 10px 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .tischplan-btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26,95,74,0.3);
        }
        
        .tischplan-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .tischplan-filter {
            padding: 10px 18px;
            border-radius: 25px;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        .tischplan-filter:hover {
            border-color: var(--primary);
        }
        
        .tischplan-filter.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .tischplan-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            color: var(--slate);
            flex-wrap: wrap;
        }
        
        .tischplan-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tischplan-legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        
        .tischplan-legend-dot.available { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .tischplan-legend-dot.reserved { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .tischplan-legend-dot.billed { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .tischplan-legend-dot.soon { background: linear-gradient(135deg, #f59e0b, #d97706); }
        
        /* FLOORPLAN CANVAS */
        .tischplan-canvas {
            position: relative;
            background: var(--bg-secondary);
            border-radius: 16px;
            height: 420px;
            min-height: 420px;
            border: 2px solid var(--border-color);
            overflow: hidden;
        }
        
        /* Dezentes Raster */
        .tischplan-canvas::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                radial-gradient(circle, var(--border-color) 1px, transparent 1px);
            background-size: 30px 30px;
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* Raum-Elemente */
        .room-wall {
            position: absolute;
            background: var(--dark);
            opacity: 0.15;
        }
        
        .room-label {
            position: absolute;
            background: var(--primary);
            color: white;
            font-family: 'DM Sans', sans-serif;
            font-size: 11px;
            font-weight: 600;
            padding: 8px 14px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(26,95,74,0.3);
        }
        
        .room-label.bar {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            box-shadow: 0 4px 12px rgba(139,92,246,0.3);
        }
        
        .room-label.kitchen {
            background: linear-gradient(135deg, #64748b, #475569);
            box-shadow: 0 4px 12px rgba(100,116,139,0.3);
        }
        
        /* TISCHE */
        .tisch {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.25s ease;
            z-index: 10;
        }
        
        .tisch:hover {
            transform: scale(1.12);
            z-index: 20;
        }
        
        .tisch-body {
            position: relative;
            width: 68px;
            height: 68px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'DM Sans', sans-serif;
            font-weight: 700;
            font-size: 14px;
            color: #1e293b;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border: 4px solid;
            transition: all 0.25s ease;
        }
        
        .tisch-body.round {
            border-radius: 50%;
            width: 62px;
            height: 62px;
        }
        
        .tisch-body.large {
            width: 95px;
            height: 55px;
            border-radius: 12px;
        }
        
        /* Status Farben */
        .tisch.available .tisch-body {
            background: linear-gradient(145deg, #dbeafe, #bfdbfe);
            border-color: #3b82f6;
        }
        
        .tisch.reserved .tisch-body {
            background: linear-gradient(145deg, #fee2e2, #fecaca);
            border-color: #ef4444;
        }
        
        .tisch.billed .tisch-body {
            background: linear-gradient(145deg, #dcfce7, #bbf7d0);
            border-color: #22c55e;
        }
        
        .tisch.soon .tisch-body {
            background: linear-gradient(145deg, #fef3c7, #fde68a);
            border-color: #f59e0b;
        }
        
        /* Stühle */
        .tisch-chairs {
            position: absolute;
            inset: -16px;
            pointer-events: none;
        }
        
        .tisch-chair {
            position: absolute;
            width: 16px;
            height: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background 0.2s;
        }
        
        .tisch.available .tisch-chair { background: #60a5fa; }
        .tisch.reserved .tisch-chair { background: #f87171; }
        .tisch.billed .tisch-chair { background: #4ade80; }
        .tisch.soon .tisch-chair { background: #fbbf24; }
        
        .tisch-chair.top { top: 0; left: 50%; transform: translateX(-50%); }
        .tisch-chair.bottom { bottom: 0; left: 50%; transform: translateX(-50%); }
        .tisch-chair.left { left: 0; top: 50%; transform: translateY(-50%) rotate(90deg); }
        .tisch-chair.right { right: 0; top: 50%; transform: translateY(-50%) rotate(90deg); }
        
        /* Badge */
        .tisch-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            min-width: 26px;
            height: 26px;
            border-radius: 13px;
            background: white;
            border: 3px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'DM Sans', sans-serif;
            font-size: 11px;
            font-weight: 700;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            padding: 0 4px;
        }
        
        .tisch.reserved .tisch-badge { border-color: #ef4444; color: #ef4444; }
        .tisch.billed .tisch-badge { border-color: #22c55e; color: #22c55e; }
        .tisch.soon .tisch-badge { border-color: #f59e0b; color: #f59e0b; }
        
        /* Info Label */
        .tisch-label {
            margin-top: 8px;
            background: var(--bg-card);
            padding: 5px 12px;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 11px;
            color: var(--slate);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-weight: 600;
            white-space: nowrap;
        }
        
        .tisch-label .amount {
            color: var(--primary);
            font-weight: 700;
        }
        
        /* Stats */
        .tischplan-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        }
        
        .tischplan-stat {
            text-align: center;
            padding: 12px 8px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .tischplan-stat-num {
            font-family: 'DM Sans', sans-serif;
            font-size: 26px;
            font-weight: 700;
        }
        
        .tischplan-stat-label {
            font-family: 'DM Sans', sans-serif;
            font-size: 11px;
            color: var(--slate);
            margin-top: 4px;
        }
        
        /* ===== GOOGLE ÖFFNUNGSZEITEN ===== */
        /* ===== GOOGLE MAPS STYLE ÖFFNUNGSZEITEN ===== */
        .hours-google {
            margin-top: 12px;
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg-secondary);
        }
        
        .hours-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .hours-header:hover {
            background: rgba(0,0,0,0.05);
        }
        
        .dark-mode .hours-header:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .hours-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .hours-icon svg {
            width: 20px;
            height: 20px;
            stroke: var(--slate);
        }
        
        .hours-status {
            flex: 1;
            font-family: 'DM Sans', sans-serif;
        }
        
        .hours-main {
            font-size: 15px;
            font-weight: 600;
        }
        
        .hours-main.open {
            color: #34a853;
        }
        
        .hours-main.closed {
            color: #ea4335;
        }
        
        .hours-sub {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 400;
        }
        
        .hours-arrow {
            color: var(--slate);
            transition: transform 0.3s ease;
            font-size: 14px;
        }
        
        .hours-arrow.expanded {
            transform: rotate(180deg);
        }
        
        .hours-dropdown {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .hours-dropdown.expanded {
            max-height: 400px;
        }
        
        .hours-list {
            padding: 0 16px 16px;
        }
        
        .hours-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            border-bottom: 1px solid var(--border-color);
        }
        
        .hours-row:last-child {
            border-bottom: none;
        }
        
        .hours-row.today {
            font-weight: 700;
            color: var(--primary);
            background: rgba(26, 95, 74, 0.08);
            margin: 0 -16px;
            padding: 10px 16px;
            border-radius: 8px;
        }
        
        .hours-day {
            color: var(--text-primary);
        }
        
        .hours-time {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .hours-time.closed-day {
            color: #ea4335;
        }
    </style>
</head>
<body>

<!-- View Toggle -->
<div class="view-toggle" style="display: none;">
    <button class="toggle-btn active" onclick="showGuestView()">Gäste-App</button>
    <button class="toggle-btn" onclick="showDashboard()">Gastro-Dashboard</button>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Reservation Modal - Mit Verfügbarkeits-Check -->
<div class="modal-overlay" id="reservationModal">
    <div class="modal" style="max-width: 420px;">
        <div class="modal-header">
            <h2 class="modal-title" data-i18n="reserveNow">Tisch reservieren</h2>
            <button class="modal-close" onclick="closeModal('reservationModal')">×</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 20px; color: var(--slate);" id="reservationRestaurantName"></p>
            <form id="reservationForm" onsubmit="submitReservation(event)">
                <input type="hidden" id="reservationRestaurantId">
                
                <!-- Step 1: Datum & Personen -->
                <div id="reservationStep1">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" data-i18n="date">Datum</label>
                            <input type="date" class="form-input" id="reservationDate" required onchange="loadAvailableSlots()">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="guests">Personen</label>
                            <select class="form-select" id="partySize" required onchange="loadAvailableSlots()">
                                <option value="1">1 Person</option>
                                <option value="2" selected>2 Personen</option>
                                <option value="3">3 Personen</option>
                                <option value="4">4 Personen</option>
                                <option value="5">5 Personen</option>
                                <option value="6">6 Personen</option>
                                <option value="7">7 Personen</option>
                                <option value="8">8+ Personen</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Verfügbare Zeiten -->
                    <div class="form-group">
                        <label class="form-label">Verfügbare Zeiten</label>
                        <div id="availableSlotsContainer" style="min-height: 60px;">
                            <p style="color: var(--slate); font-size: 14px;">Wähle Datum & Personenzahl</p>
                        </div>
                    </div>
                    
                    <!-- Ausgewählte Zeit -->
                    <input type="hidden" id="reservationTime" required>
                    <div id="selectedSlotDisplay" style="display: none; background: rgba(26,79,99,0.1); padding: 12px 16px; border-radius: 12px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-weight: 600; color: var(--dark);" id="selectedTimeText"></span>
                                <span style="color: var(--slate); font-size: 13px; margin-left: 8px;" id="selectedTableText"></span>
                            </div>
                            <button type="button" onclick="clearSelectedSlot()" style="background: none; border: none; color: var(--slate); cursor: pointer; padding: 4px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Kontaktdaten (erscheint nach Slot-Auswahl) -->
                <div id="reservationStep2" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" data-i18n="name">Name</label>
                        <input type="text" class="form-input" id="guestName" required placeholder="Max Mustermann">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefon</label>
                        <input type="tel" class="form-input" id="guestPhone" required placeholder="0123 456789">
                    </div>
                    <div class="form-group">
                        <label class="form-label">E-Mail <span style="font-weight: normal; color: var(--slate);">(optional)</span></label>
                        <input type="email" class="form-input" id="guestEmail" placeholder="email@beispiel.de">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Anlass <span style="font-weight: normal; color: var(--slate);">(optional)</span></label>
                        <select class="form-select" id="reservationOccasion">
                            <option value="">Keiner</option>
                            <option value="birthday">🎂 Geburtstag</option>
                            <option value="anniversary">💑 Jahrestag</option>
                            <option value="business">💼 Geschäftlich</option>
                            <option value="date">❤️ Date</option>
                            <option value="celebration">🎉 Feier</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Anmerkungen <span style="font-weight: normal; color: var(--slate);">(optional)</span></label>
                        <textarea class="form-textarea" id="reservationNotes" placeholder="Allergien, Kinderstuhl, Rollstuhl..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" id="submitReservationBtn" style="width: 100%;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="margin-right: 8px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        Reservierung bestätigen
                    </button>
                </div>
                
                <!-- Warteliste Option -->
                <div id="waitlistOption" style="display: none; margin-top: 16px; padding: 16px; background: rgba(245,158,11,0.1); border-radius: 12px; text-align: center;">
                    <p style="color: var(--dark); margin-bottom: 12px;">Keine Tische verfügbar zu dieser Zeit</p>
                    <button type="button" onclick="showWaitlistForm()" class="btn" style="background: #f59e0b; color: white;">
                        📋 Auf Warteliste setzen
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Profile Modal -->
<div class="modal-overlay" id="profileModal">
    <div class="modal" style="max-width: 380px;">
        <div class="modal-header">
            <h2 class="modal-title" data-i18n="myProfile">Mein Profil</h2>
            <button class="modal-close" onclick="closeModal('profileModal')">×</button>
        </div>
        <div class="modal-body" id="profileContent">
            <!-- Default: Nicht eingeloggt -->
            <div style="text-align: center; padding: 20px 0;">
                <div style="width: 80px; height: 80px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="1.5" width="40" height="40">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </div>
                <h3 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;" data-i18n="notLoggedIn">Noch nicht angemeldet</h3>
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px;" data-i18n="loginToSave">Melde dich an um deine Favoriten zu speichern und Reservierungen zu verwalten.</p>
                
                <button onclick="closeModal('profileModal'); openModal('loginModal');" class="btn btn-primary" style="margin-bottom: 16px;" data-i18n="loginNow">
                    Jetzt anmelden
                </button>
                
                <p style="font-size: 13px; color: var(--text-secondary);" data-i18n="useWithoutLogin">Du kannst die App auch ohne Anmeldung nutzen.</p>
            </div>
            
            <div style="border-top: 1px solid var(--border-color); padding-top: 20px; margin-top: 10px;">
                <div onclick="showSection('favorites'); closeModal('profileModal');" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer; margin-bottom: 10px;">
                    <div style="width: 40px; height: 40px; background: rgba(255, 59, 48, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#ff3b30" stroke-width="2" width="20" height="20">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary);" data-i18n="myFavorites">Meine Favoriten</div>
                        <div style="font-size: 12px; color: var(--text-secondary);" data-i18n="savedLocally">Lokal gespeichert</div>
                    </div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" width="20" height="20">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </div>
                
                <div onclick="openModal('themeModalSimple'); closeModal('profileModal');" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer;">
                    <div style="width: 40px; height: 40px; background: rgba(255, 149, 0, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#ff9500" stroke-width="2" width="20" height="20">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary);" data-i18n="design">Design</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Dark / Light Mode</div>
                    </div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" width="20" height="20">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Login Modal -->
<div class="modal-overlay" id="loginModal">
    <div class="modal" style="max-width: 380px;">
        <div class="modal-header">
            <h2 class="modal-title" data-i18n="login">Anmelden</h2>
            <button class="modal-close" onclick="closeModal('loginModal')">×</button>
        </div>
        <div class="modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 20px;" data-i18n="loginToSave">Melde dich an um deine Favoriten zu speichern und Reservierungen zu verwalten.</p>
            
            <!-- Google Login Button -->
            <button onclick="loginWithGoogle()" style="width: 100%; padding: 14px; background: white; border: 2px solid var(--border-color); border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 20px; color: #333;">
                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                <span data-i18n="loginWithGoogle">Mit Google anmelden</span>
            </button>
            
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                <span style="color: var(--text-secondary); font-size: 13px;" data-i18n="orWithEmail">oder mit E-Mail</span>
                <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
            </div>
            
            <!-- Email Login -->
            <form onsubmit="loginWithEmail(event)">
                <div class="form-group">
                    <label class="form-label">E-Mail Adresse</label>
                    <input type="email" class="form-input" id="loginEmail" required placeholder="deine@email.de">
                </div>
                <button type="submit" class="btn btn-primary">Code senden</button>
            </form>
            
            <p style="text-align: center; margin-top: 16px; font-size: 12px; color: var(--text-secondary);">
                Mit der Anmeldung akzeptierst du unsere <a href="#" style="color: var(--primary);">Datenschutzrichtlinie</a>
            </p>
        </div>
    </div>
</div>

<!-- Email Code Modal -->
<div class="modal-overlay" id="emailCodeModal">
    <div class="modal" style="max-width: 380px;">
        <div class="modal-header">
            <h2 class="modal-title">Code eingeben</h2>
            <button class="modal-close" onclick="closeModal('emailCodeModal')">×</button>
        </div>
        <div class="modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Wir haben dir einen 6-stelligen Code an <strong id="sentEmailDisplay"></strong> gesendet.</p>
            
            <form onsubmit="verifyEmailCode(event)">
                <div class="form-group">
                    <label class="form-label">Bestätigungscode</label>
                    <input type="text" class="form-input" id="emailCode" required placeholder="123456" maxlength="6" style="text-align: center; font-size: 24px; letter-spacing: 8px;">
                </div>
                <button type="submit" class="btn btn-primary">Bestätigen</button>
            </form>
            
            <p style="text-align: center; margin-top: 16px; font-size: 13px; color: var(--text-secondary);">
                Keinen Code erhalten? <a href="#" onclick="resendCode()" style="color: var(--primary);">Erneut senden</a>
            </p>
        </div>
    </div>
</div>

<!-- Theme Modal -->
<div class="modal-overlay" id="themeModal">
    <div class="modal" style="max-width: 420px;">
        <div class="modal-header">
            <h2 class="modal-title">Design & Farben</h2>
            <button class="modal-close" onclick="closeModal('themeModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            
            <!-- Erscheinungsbild -->
            <div class="form-group">
                <label class="form-label" style="font-weight: 600; margin-bottom: 12px;">Erscheinungsbild</label>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <button class="theme-mode-btn" onclick="setTheme('light')" id="themeBtnLight">
                        <div class="theme-preview theme-preview-light"></div>
                        <span>Hell</span>
                    </button>
                    <button class="theme-mode-btn" onclick="setTheme('dark')" id="themeBtnDark">
                        <div class="theme-preview theme-preview-dark"></div>
                        <span>Dunkel</span>
                    </button>
                    <button class="theme-mode-btn" onclick="setTheme('auto')" id="themeBtnAuto">
                        <div class="theme-preview theme-preview-auto"></div>
                        <span>Auto</span>
                    </button>
                </div>
            </div>
            
            <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">
            
            <!-- Akzentfarbe -->
            <div class="form-group">
                <label class="form-label" style="font-weight: 600; margin-bottom: 12px;">Akzentfarbe</label>
                <div class="accent-colors">
                    <button class="accent-btn" style="--accent: #007AFF;" onclick="setAccentColor('#007AFF', 'Blau')" title="Blau"></button>
                    <button class="accent-btn" style="--accent: #34C759;" onclick="setAccentColor('#34C759', 'Grün')" title="Grün"></button>
                    <button class="accent-btn" style="--accent: #FF9500;" onclick="setAccentColor('#FF9500', 'Orange')" title="Orange"></button>
                    <button class="accent-btn" style="--accent: #FF2D55;" onclick="setAccentColor('#FF2D55', 'Pink')" title="Pink"></button>
                    <button class="accent-btn" style="--accent: #AF52DE;" onclick="setAccentColor('#AF52DE', 'Lila')" title="Lila"></button>
                    <button class="accent-btn" style="--accent: #FF3B30;" onclick="setAccentColor('#FF3B30', 'Rot')" title="Rot"></button>
                    <button class="accent-btn" style="--accent: #5856D6;" onclick="setAccentColor('#5856D6', 'Indigo')" title="Indigo"></button>
                    <button class="accent-btn" style="--accent: #00C7BE;" onclick="setAccentColor('#00C7BE', 'Türkis')" title="Türkis"></button>
                    <button class="accent-btn" style="--accent: #1a5f4a;" onclick="setAccentColor('#1a5f4a', 'Ostfriesland')" title="Ostfriesland Grün"></button>
                </div>
                <p id="currentAccentName" style="text-align: center; margin-top: 10px; font-size: 13px; color: var(--text-secondary);">Aktuell: Ostfriesland Grün</p>
            </div>
            
            <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">
            
            <!-- Glaseffekt -->
            <div class="form-group">
                <label class="form-label" style="font-weight: 600; margin-bottom: 12px;">Glaseffekt (Blur)</label>
                <div style="display: flex; gap: 10px;">
                    <button class="glass-btn" onclick="setGlassEffect('none')" id="glassNone">
                        <span>Aus</span>
                    </button>
                    <button class="glass-btn" onclick="setGlassEffect('subtle')" id="glassSubtle">
                        <span>Dezent</span>
                    </button>
                    <button class="glass-btn active" onclick="setGlassEffect('strong')" id="glassStrong">
                        <span>Stark</span>
                    </button>
                </div>
            </div>
            
            <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">
            
            <!-- Ecken -->
            <div class="form-group">
                <label class="form-label" style="font-weight: 600; margin-bottom: 12px;">Ecken-Radius</label>
                <div style="display: flex; gap: 10px;">
                    <button class="corner-btn" onclick="setCornerRadius('sharp')" id="cornerSharp">
                        <div style="width: 24px; height: 24px; background: var(--primary); border-radius: 2px;"></div>
                        <span>Eckig</span>
                    </button>
                    <button class="corner-btn" onclick="setCornerRadius('rounded')" id="cornerRounded">
                        <div style="width: 24px; height: 24px; background: var(--primary); border-radius: 6px;"></div>
                        <span>Rund</span>
                    </button>
                    <button class="corner-btn active" onclick="setCornerRadius('pill')" id="cornerPill">
                        <div style="width: 24px; height: 24px; background: var(--primary); border-radius: 12px;"></div>
                        <span>Pill</span>
                    </button>
                </div>
            </div>
            
            <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">
            
            <!-- Zurücksetzen -->
            <button onclick="resetDesign()" style="width: 100%; padding: 14px; background: var(--bg-secondary); border: none; border-radius: 12px; color: var(--text-secondary); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                </svg>
                Auf Standard zurücksetzen
            </button>
            
        </div>
    </div>
</div>

<!-- Simple Theme Modal für Gäste (nur Hell/Dunkel/Auto) -->
<div class="modal-overlay" id="themeModalSimple">
    <div class="modal" style="max-width: 340px;">
        <div class="modal-header">
            <h2 class="modal-title">Design</h2>
            <button class="modal-close" onclick="closeModal('themeModalSimple')">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Wähle dein Design</label>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 12px;">
                    <button onclick="setThemeSimple('light')" id="themeBtnLightSimple" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; border: 2px solid var(--border-color); background: var(--bg-card); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f8f8f8, #e0e0e0); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" width="22" height="22">
                                <circle cx="12" cy="12" r="5"/>
                                <line x1="12" y1="1" x2="12" y2="3"/>
                                <line x1="12" y1="21" x2="12" y2="23"/>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                <line x1="1" y1="12" x2="3" y2="12"/>
                                <line x1="21" y1="12" x2="23" y2="12"/>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                            </svg>
                        </div>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">Hell</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Helles Design</div>
                        </div>
                    </button>
                    <button onclick="setThemeSimple('dark')" id="themeBtnDarkSimple" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; border: 2px solid var(--border-color); background: var(--bg-card); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #2c2c2c, #1a1a1a); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" width="22" height="22">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                        </div>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">Dunkel</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Dunkles Design</div>
                        </div>
                    </button>
                    <button onclick="setThemeSimple('auto')" id="themeBtnAutoSimple" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; border: 2px solid var(--border-color); background: var(--bg-card); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f8f8f8 50%, #2c2c2c 50%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                                <rect x="2" y="6" width="20" height="12" rx="2"/>
                                <circle cx="12" cy="12" r="2"/>
                            </svg>
                        </div>
                        <div style="text-align: left; flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">Automatisch</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Folgt System</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Modal -->
<div class="modal-overlay" id="notificationModal">
    <div class="modal" style="max-width: 380px;">
        <div class="modal-header">
            <h2 class="modal-title">Benachrichtigungen</h2>
            <button class="modal-close" onclick="closeModal('notificationModal')">×</button>
        </div>
        <div class="modal-body" style="padding: 0;">
            <div id="notificationList">
                <!-- Notifications werden hier eingefügt -->
            </div>
            <div style="padding: 16px; border-top: 1px solid var(--border-color);">
                <button onclick="clearNotifications()" style="width: 100%; padding: 12px; background: var(--bg-secondary); border: none; border-radius: 8px; color: var(--text-secondary); font-size: 14px; cursor: pointer;">Alle löschen</button>
            </div>
        </div>
    </div>
</div>

<!-- Location Modal -->
<div class="modal-overlay" id="locationModal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title" data-i18n="chooseLocation">Ort wählen</h2>
            <button class="modal-close" onclick="closeModal('locationModal')">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <!-- Suchleiste -->
                <div style="position: relative; margin-bottom: 16px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--slate);">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" id="locationSearchInput" class="form-input" placeholder="Ort suchen..." style="padding-left: 42px;" oninput="filterLocations()">
                </div>
                
                <label class="form-label" data-i18n="whereToGo">Wo möchtest du hin?</label>
                <div id="locationButtons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; max-height: 300px; overflow-y: auto;">
                    <button class="location-btn active" onclick="setLocation('Alle')" data-location="alle">Alle Orte</button>
                    <!-- Wird dynamisch aus Supabase geladen -->
                </div>
                <p id="noLocationsHint" style="display: none; text-align: center; color: var(--slate); padding: 20px;">Keine Orte gefunden</p>
                
                <!-- Eigenen Ort hinzufügen -->
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                    <p style="font-size: 13px; color: var(--slate); margin-bottom: 10px;" data-i18n="locationNotFound">Dein Ort nicht dabei?</p>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="newLocationInput" class="form-input" placeholder="z.B. Pewsum, Marienhafe..." style="flex: 1;">
                        <button onclick="addCustomLocation()" style="padding: 10px 16px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="18" height="18">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Restaurant Hinzufügen Modal -->
<div class="modal-overlay" id="addRestaurantModal">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <h2 class="modal-title">Restaurant hinzufügen</h2>
            <button class="modal-close" onclick="closeModal('addRestaurantModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <form id="addRestaurantForm" onsubmit="addRestaurant(event)">
                <div class="form-group">
                    <label class="form-label">Restaurant-Name *</label>
                    <input type="text" class="form-input" id="newRestaurantName" required placeholder="z.B. Fischerhaus">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></span>Telefon</label>
                        <input type="tel" class="form-input" id="newRestaurantPhone" placeholder="+49 4926 ...">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></span>WhatsApp</label>
                        <input type="tel" class="form-input" id="newRestaurantWhatsapp" placeholder="+49176...">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></span>E-Mail</label>
                    <input type="email" class="form-input" id="newRestaurantEmail" placeholder="info@restaurant.de">
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></span>Straße + Hausnummer</label>
                    <input type="text" class="form-input" id="newRestaurantStreet" placeholder="Hafenstraße 12">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">PLZ</label>
                        <input type="text" class="form-input" id="newRestaurantZip" placeholder="26736">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ort</label>
                        <select class="form-select" id="newRestaurantCity">
                            <option value="Greetsiel">Greetsiel</option>
                            <option value="Norddeich">Norddeich</option>
                            <option value="Norden">Norden</option>
                            <option value="Aurich">Aurich</option>
                            <option value="Emden">Emden</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg></span>Google Maps Link</label>
                    <input type="url" class="form-input" id="newRestaurantGoogleMaps" placeholder="https://maps.google.com/...">
                    <small style="color: var(--text-secondary); font-size: 11px;">Öffne Google Maps, suche das Restaurant, klicke "Teilen" → Link kopieren</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Küche</label>
                    <select class="form-select" id="newRestaurantCuisine">
                        <option value="fisch">Fisch & Meeresfrüchte</option>
                        <option value="deutsch">Deutsch</option>
                        <option value="italienisch">Italienisch</option>
                        <option value="cafe">Café</option>
                        <option value="imbiss">Imbiss</option>
                        <option value="asiatisch">Asiatisch</option>
                        <option value="griechisch">Griechisch</option>
                        <option value="tuerkisch">Türkisch / Döner</option>
                        <option value="bar">Bar / Kneipe</option>
                        <option value="shisha">Shisha Bar</option>
                        <option value="steakhouse">Steakhouse</option>
                        <option value="burger">Burger</option>
                        <option value="indisch">Indisch</option>
                        <option value="mexikanisch">Mexikanisch</option>
                        <option value="eisdiele">Eisdiele</option>
                        <option value="baeckerei">Bäckerei</option>
                    </select>
                </div>
                
                <h4 style="margin: 16px 0 12px; color: var(--dark);">Social Media</h4>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></span>Instagram Link</label>
                    <input type="url" class="form-input" id="newRestaurantInstagram" placeholder="https://instagram.com/restaurantname">
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg></span>TikTok Link</label>
                    <input type="url" class="form-input" id="newRestaurantTiktok" placeholder="https://tiktok.com/@restaurantname">
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Google Bewertung</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Sterne (1-5)</label>
                        <input type="number" class="form-input" id="newRestaurantRating" value="4.5" min="1" max="5" step="0.1" placeholder="4.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Anzahl Bewertungen</label>
                        <input type="number" class="form-input" id="newRestaurantReviewCount" placeholder="127" min="0">
                    </div>
                </div>
                <p style="font-size: 11px; color: var(--slate); margin-top: -8px; margin-bottom: 12px;">Tipp: Öffne Google Maps → Restaurant suchen → Bewertung & Anzahl ablesen</p>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></span>Restaurant-Bild</label>
                    
                    <!-- Bild Vorschau -->
                    <div id="imagePreviewContainer" style="display: none; margin-bottom: 12px; position: relative;">
                        <img id="imagePreview" src="" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 12px;">
                        <button type="button" onclick="clearImagePreview()" style="position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; border-radius: 50%; background: rgba(0,0,0,0.6); border: none; color: white; cursor: pointer; font-size: 16px;">×</button>
                    </div>
                    
                    <!-- Upload Buttons -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px; background: var(--bg-secondary); border: 2px dashed var(--border-color); border-radius: 12px; cursor: pointer; color: var(--text-primary); font-weight: 500; transition: all 0.2s;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            📷 Foto wählen
                            <input type="file" accept="image/*" onchange="handleImageUpload(event)" style="display: none;">
                        </label>
                        <label style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px; background: var(--bg-secondary); border: 2px dashed var(--border-color); border-radius: 12px; cursor: pointer; color: var(--text-primary); font-weight: 500; transition: all 0.2s;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                <circle cx="12" cy="13" r="4"></circle>
                            </svg>
                            📱 Kamera
                            <input type="file" accept="image/*" capture="environment" onchange="handleImageUpload(event)" style="display: none;">
                        </label>
                    </div>
                    
                    <!-- URL Eingabe (Alternative) -->
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                        <span style="color: var(--text-secondary); font-size: 12px;">oder URL eingeben</span>
                        <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                    </div>
                    <input type="url" class="form-input" id="newRestaurantImage" placeholder="https://..." oninput="previewImageFromUrl(this.value)">
                    <small style="color: var(--text-secondary); font-size: 11px; margin-top: 4px; display: block;">Tipp: Auf Google Maps → Restaurant → Fotos → Bild öffnen → Rechtsklick → Bildadresse kopieren</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Anzahl Tische</label>
                    <input type="number" class="form-input" id="newRestaurantTables" value="8" min="1" max="50">
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Öffnungszeiten</h4>
                
                <div style="display: grid; grid-template-columns: auto 1fr 1fr; gap: 8px; align-items: center; font-size: 14px;">
                    <span style="color: var(--slate);">Mo</span>
                    <input type="time" class="form-input" id="openMoStart" value="11:00" style="padding: 8px;">
                    <input type="time" class="form-input" id="openMoEnd" value="22:00" style="padding: 8px;">
                    
                    <span style="color: var(--slate);">Di</span>
                    <input type="time" class="form-input" id="openDiStart" value="11:00" style="padding: 8px;">
                    <input type="time" class="form-input" id="openDiEnd" value="22:00" style="padding: 8px;">
                    
                    <span style="color: var(--slate);">Mi</span>
                    <input type="time" class="form-input" id="openMiStart" value="11:00" style="padding: 8px;">
                    <input type="time" class="form-input" id="openMiEnd" value="22:00" style="padding: 8px;">
                    
                    <span style="color: var(--slate);">Do</span>
                    <input type="time" class="form-input" id="openDoStart" value="11:00" style="padding: 8px;">
                    <input type="time" class="form-input" id="openDoEnd" value="22:00" style="padding: 8px;">
                    
                    <span style="color: var(--slate);">Fr</span>
                    <input type="time" class="form-input" id="openFrStart" value="11:00" style="padding: 8px;">
                    <input type="time" class="form-input" id="openFrEnd" value="23:00" style="padding: 8px;">
                    
                    <span style="color: var(--slate);">Sa</span>
                    <input type="time" class="form-input" id="openSaStart" value="11:00" style="padding: 8px;">
                    <input type="time" class="form-input" id="openSaEnd" value="23:00" style="padding: 8px;">
                    
                    <span style="color: var(--slate);">So</span>
                    <input type="time" class="form-input" id="openSoStart" value="11:00" style="padding: 8px;">
                    <input type="time" class="form-input" id="openSoEnd" value="22:00" style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-top: 12px;">
                    <label class="form-label">Ruhetag</label>
                    <select class="form-input" id="restDaySelect">
                        <option value="">Kein Ruhetag</option>
                        <option value="0">Montag</option>
                        <option value="1">Dienstag</option>
                        <option value="2">Mittwoch</option>
                        <option value="3">Donnerstag</option>
                        <option value="4">Freitag</option>
                        <option value="5">Samstag</option>
                        <option value="6">Sonntag</option>
                    </select>
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">💳 Zahlungsdaten (intern)</h4>
                
                <div class="form-group">
                    <label class="form-label">Kontoinhaber</label>
                    <input type="text" class="form-input" id="newRestaurantAccountHolder" placeholder="Max Mustermann">
                </div>
                <div class="form-group">
                    <label class="form-label">IBAN</label>
                    <input type="text" class="form-input" id="newRestaurantIBAN" placeholder="DE89 3704 0044 0532 0130 00" style="font-family: monospace;">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Monatsbeitrag</label>
                        <select class="form-select" id="newRestaurantPlan">
                            <option value="0">Kostenlos (Test)</option>
                            <option value="29">Basis - 29€/Monat</option>
                            <option value="49" selected>Standard - 49€/Monat</option>
                            <option value="99">Premium - 99€/Monat</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Vertragsbeginn</label>
                        <input type="date" class="form-input" id="newRestaurantContractStart">
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="newRestaurantAGBAccepted" required>
                        <span style="color: var(--slate); font-size: 13px;">Restaurant akzeptiert die <a href="#" onclick="openModal('agbModal'); return false;" style="color: var(--primary);">AGB</a></span>
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Restaurant hinzufügen</button>
            </form>
        </div>
    </div>
</div>

<!-- Admin Login Modal -->
<div class="modal-overlay" id="adminLoginModal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Admin Login</h2>
            <button class="modal-close" onclick="closeModal('adminLoginModal');">×</button>
        </div>
        <div class="modal-body">
            <p style="color: var(--slate); margin-bottom: 20px;">Gib das Admin-Passwort ein.</p>
            
            <div id="loginError" style="display: none; background: rgba(255,59,48,0.15); color: var(--danger); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px;"></div>
            
            <div class="form-group">
                <label class="form-label">Passwort</label>
                <input type="password" class="form-input" id="adminPassword" placeholder="••••••••" autocomplete="off">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="simpleLogin()">Anmelden</button>
        </div>
    </div>
</div>

<!-- ==================== GUEST VIEW ==================== -->
<div class="guest-view" id="guestView">
    
    <!-- Main View -->
    <div id="mainView">
        <header class="guest-header">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div class="logo" onclick="secretAdminTap()">Kiek mol <span>in</span></div>
                <!-- Punkte & Sprache -->
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="points-display" onclick="openModal('pointsModal')" title="Deine Punkte">
                        <span id="userPoints">0</span>
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    </div>
                    <div class="lang-switcher">
                        <button onclick="setLanguage('de')" id="langDE" class="lang-btn active">DE</button>
                        <button onclick="setLanguage('en')" id="langEN" class="lang-btn">EN</button>
                        <button onclick="setLanguage('nl')" id="langNL" class="lang-btn">NL</button>
                    </div>
                </div>
            </div>
            <p class="tagline" data-i18n="tagline">Ostfriesland genießen</p>
            
            <div class="location-bar" onclick="openModal('locationModal')" style="margin-top: 12px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                <span id="currentLocation">Greetsiel</span>
                <span class="change" data-i18n="change">Ändern ›</span>
            </div>
        </header>
        
        <!-- Quick Actions Bar -->
        <div style="display: flex; justify-content: flex-end; gap: 12px; padding: 0 20px; margin-top: -25px; margin-bottom: 16px; position: relative; z-index: 50;">
            <button onclick="openModal('notificationModal');" style="background: var(--bg-card); color: var(--text-primary); border: none; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 12px rgba(0,0,0,0.15); position: relative;" title="Benachrichtigungen">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
                <span id="notificationBadge" class="notification-badge">3</span>
            </button>
            <button onclick="openModal('themeModalSimple');" style="background: var(--bg-card); color: var(--text-primary); border: none; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 12px rgba(0,0,0,0.15);" title="Design ändern">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
            </button>
            <button onclick="openModal('profileModal');" id="profileBtn" style="background: var(--bg-card); color: var(--text-primary); border: none; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 12px rgba(0,0,0,0.15);" title="Profil">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22" id="profileIcon">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </button>
        </div>

        <!-- Wetter-Eilmeldung Banner -->
        <div id="weatherAlertBanner" style="display: none; margin: 0 20px 16px; padding: 16px 18px; background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 16px; position: relative; box-shadow: 0 4px 24px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04); border: 1px solid rgba(255,255,255,0.5);">
            <button onclick="dismissWeatherAlert()" style="position: absolute; top: 12px; right: 12px; background: var(--bg-secondary); border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.6; transition: opacity 0.2s;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="14" height="14">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            <div style="display: flex; align-items: flex-start; gap: 14px;">
                <div id="alertIconContainer" style="width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);">
                    <span id="alertIcon">⛈️</span>
                </div>
                <div style="flex: 1; padding-right: 20px;">
                    <div style="font-weight: 700; font-size: 15px; color: var(--dark); margin-bottom: 2px;" id="alertTitle">Wetter-Hinweis</div>
                    <div style="font-size: 13px; color: var(--slate); line-height: 1.5;" id="alertMessage">Schlechtes Wetter erwartet</div>
                    <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 6px;" id="alertSuggestions"></div>
                </div>
            </div>
        </div>

        <!-- Wetter Widget - Kompakt mit Klick für Details -->
        <div id="weatherWidget" style="margin: 0 20px 16px; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.12); background: var(--bg-card); border: 1px solid var(--border-color);">
            <!-- Hauptbereich - IMMER SICHTBAR -->
            <div id="weatherBg" onclick="toggleWeatherDetails()" style="padding: 20px; position: relative; cursor: pointer;">
                <!-- Ort + Haupttemperatur -->
                <div style="text-align: center;">
                    <div style="font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600; color: var(--dark);" id="weatherLocation">Ostfriesland</div>
                    <div style="font-size: 64px; font-weight: 200; line-height: 1; color: var(--dark);" id="weatherTemp">3°</div>
                    <div style="font-size: 15px; font-weight: 500; color: var(--slate);" id="weatherDesc">Windig</div>
                    <div style="font-size: 14px; color: var(--slate);">H:<span id="weatherHigh">4°</span>  T:<span id="weatherLow">1°</span></div>
                </div>
                <!-- Expand/Collapse Pfeil -->
                <div style="text-align: center; margin-top: 8px;">
                    <svg id="weatherArrow" viewBox="0 0 24 24" fill="none" stroke="var(--slate)" stroke-width="2" width="20" height="20" style="transition: transform 0.3s;">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
            </div>
            
            <!-- AUSKLAPPBARER BEREICH -->
            <div id="weatherDetails" style="max-height: 0; overflow: hidden; transition: max-height 0.4s ease;">
                <!-- Stündliche Vorhersage -->
                <div style="background: var(--bg-secondary); padding: 12px 16px; border-top: 1px solid var(--border-color);">
                    <div style="font-size: 12px; color: var(--slate); margin-bottom: 10px;" id="weatherHourlyDesc">Windiges Wetter für den Rest des Tages.</div>
                    <div style="display: flex; gap: 16px; overflow-x: auto; padding-bottom: 8px;" id="weatherHourly">
                        <div style="text-align: center; min-width: 55px;">
                            <div style="font-size: 13px; font-weight: 600; color: var(--dark);">Jetzt</div>
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="28" height="28" style="margin: 6px auto; display: block;"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
                            <div style="font-size: 15px; font-weight: 600; color: var(--dark);">3°</div>
                        </div>
                        <div style="text-align: center; min-width: 55px;">
                            <div style="font-size: 13px; color: var(--slate);">18 Uhr</div>
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="28" height="28" style="margin: 6px auto; display: block;"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
                            <div style="font-size: 15px; font-weight: 600; color: var(--dark);">3°</div>
                        </div>
                        <div style="text-align: center; min-width: 55px;">
                            <div style="font-size: 13px; color: var(--slate);">19 Uhr</div>
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="28" height="28" style="margin: 6px auto; display: block;"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
                            <div style="font-size: 15px; font-weight: 600; color: var(--dark);">3°</div>
                        </div>
                        <div style="text-align: center; min-width: 55px;">
                            <div style="font-size: 13px; color: var(--slate);">20 Uhr</div>
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="28" height="28" style="margin: 6px auto; display: block;"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
                            <div style="font-size: 15px; font-weight: 600; color: var(--dark);">2°</div>
                        </div>
                        <div style="text-align: center; min-width: 55px;">
                            <div style="font-size: 13px; color: var(--slate);">21 Uhr</div>
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="28" height="28" style="margin: 6px auto; display: block;"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
                            <div style="font-size: 15px; font-weight: 600; color: var(--dark);">2°</div>
                        </div>
                    </div>
                </div>
                
                <!-- 7-Tage Vorhersage -->
                <div style="background: var(--bg-secondary); padding: 12px 16px; border-top: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--slate); margin-bottom: 10px; font-weight: 600;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        7-TAGE-VORHERSAGE
                    </div>
                    <div id="weatherForecast">
                        <!-- Heute -->
                        <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 50px; font-size: 14px; font-weight: 600; color: var(--dark);">Heute</div>
                            <div style="width: 40px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="22" height="22"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg></div>
                            <div style="width: 35px; text-align: right; font-size: 14px; color: var(--slate);">1°</div>
                            <div style="flex: 1; margin: 0 12px; height: 4px; background: linear-gradient(to right, var(--primary) 50%, var(--border-color) 50%); border-radius: 2px;"></div>
                            <div style="width: 30px; text-align: right; font-size: 14px; font-weight: 600; color: var(--dark);">4°</div>
                        </div>
                        <!-- Sa -->
                        <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 50px; font-size: 14px; color: var(--dark);">Sa</div>
                            <div style="width: 40px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="22" height="22"><path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"/><line x1="8" y1="16" x2="8.01" y2="16"/><line x1="8" y1="20" x2="8.01" y2="20"/><line x1="12" y1="18" x2="12.01" y2="18"/><line x1="12" y1="22" x2="12.01" y2="22"/><line x1="16" y1="16" x2="16.01" y2="16"/><line x1="16" y1="20" x2="16.01" y2="20"/></svg><div style="font-size: 10px; color: var(--primary); font-weight: 600;">75%</div></div>
                            <div style="width: 35px; text-align: right; font-size: 14px; color: var(--slate);">-1°</div>
                            <div style="flex: 1; margin: 0 12px; height: 4px; background: linear-gradient(to right, var(--primary) 60%, var(--border-color) 60%); border-radius: 2px;"></div>
                            <div style="width: 30px; text-align: right; font-size: 14px; font-weight: 600; color: var(--dark);">2°</div>
                        </div>
                        <!-- So -->
                        <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 50px; font-size: 14px; color: var(--dark);">So</div>
                            <div style="width: 40px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="22" height="22"><line x1="16" y1="13" x2="16" y2="21"/><line x1="8" y1="13" x2="8" y2="21"/><line x1="12" y1="15" x2="12" y2="23"/><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg><div style="font-size: 10px; color: var(--primary); font-weight: 600;">45%</div></div>
                            <div style="width: 35px; text-align: right; font-size: 14px; color: var(--slate);">-3°</div>
                            <div style="flex: 1; margin: 0 12px; height: 4px; background: linear-gradient(to right, var(--primary) 55%, var(--border-color) 55%); border-radius: 2px;"></div>
                            <div style="width: 30px; text-align: right; font-size: 14px; font-weight: 600; color: var(--dark);">1°</div>
                        </div>
                        <!-- Mo -->
                        <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 50px; font-size: 14px; color: var(--dark);">Mo</div>
                            <div style="width: 40px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="22" height="22"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg></div>
                            <div style="width: 35px; text-align: right; font-size: 14px; color: var(--slate);">-3°</div>
                            <div style="flex: 1; margin: 0 12px; height: 4px; background: linear-gradient(to right, var(--primary) 45%, var(--border-color) 45%); border-radius: 2px;"></div>
                            <div style="width: 30px; text-align: right; font-size: 14px; font-weight: 600; color: var(--dark);">0°</div>
                        </div>
                        <!-- Di -->
                        <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 50px; font-size: 14px; color: var(--dark);">Di</div>
                            <div style="width: 40px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="22" height="22"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></div>
                            <div style="width: 35px; text-align: right; font-size: 14px; color: var(--slate);">-2°</div>
                            <div style="flex: 1; margin: 0 12px; height: 4px; background: linear-gradient(to right, var(--primary) 50%, var(--border-color) 50%); border-radius: 2px;"></div>
                            <div style="width: 30px; text-align: right; font-size: 14px; font-weight: 600; color: var(--dark);">3°</div>
                        </div>
                        <!-- Mi -->
                        <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 50px; font-size: 14px; color: var(--dark);">Mi</div>
                            <div style="width: 40px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="22" height="22"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/><circle cx="6" cy="6" r="3" fill="none"/><line x1="6" y1="1" x2="6" y2="2"/><line x1="6" y1="10" x2="6" y2="11"/><line x1="2" y1="6" x2="3" y2="6"/></svg></div>
                            <div style="width: 35px; text-align: right; font-size: 14px; color: var(--slate);">0°</div>
                            <div style="flex: 1; margin: 0 12px; height: 4px; background: linear-gradient(to right, var(--primary) 55%, var(--border-color) 55%); border-radius: 2px;"></div>
                            <div style="width: 30px; text-align: right; font-size: 14px; font-weight: 600; color: var(--dark);">5°</div>
                        </div>
                        <!-- Do -->
                        <div style="display: flex; align-items: center; padding: 10px 0;">
                            <div style="width: 50px; font-size: 14px; color: var(--dark);">Do</div>
                            <div style="width: 40px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5" width="22" height="22"><line x1="16" y1="13" x2="16" y2="21"/><line x1="8" y1="13" x2="8" y2="21"/><line x1="12" y1="15" x2="12" y2="23"/><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg><div style="font-size: 10px; color: var(--primary); font-weight: 600;">30%</div></div>
                            <div style="width: 35px; text-align: right; font-size: 14px; color: var(--slate);">1°</div>
                            <div style="flex: 1; margin: 0 12px; height: 4px; background: linear-gradient(to right, var(--primary) 50%, var(--border-color) 50%); border-radius: 2px;"></div>
                            <div style="width: 30px; text-align: right; font-size: 14px; font-weight: 600; color: var(--dark);">6°</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GEZEITEN WIDGET -->
        <div id="tideWidget" class="tide-widget" style="margin: 0 20px 16px;">
            <div class="tide-header">
                <div class="tide-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 6px;">
                        <path d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>
                        <path d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>
                        <path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>
                    </svg>
                    Gezeiten Nordsee
                </div>
                <div class="tide-status" id="tideStatus">Flut steigt</div>
            </div>
            <div class="tide-visual">
                <div class="tide-wave" id="tideWave" style="height: 40%;"></div>
                <div class="tide-marker" id="tideNow" style="left: 50%;"></div>
            </div>
            <div class="tide-times">
                <div class="tide-time">
                    <div class="tide-time-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12" style="margin-right: 4px;"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
                        Niedrigwasser
                    </div>
                    <div id="tideLow">06:32</div>
                </div>
                <div class="tide-time">
                    <div class="tide-time-label">Jetzt</div>
                    <div id="tideNowTime">--:--</div>
                </div>
                <div class="tide-time">
                    <div class="tide-time-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12" style="margin-right: 4px;"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
                        Hochwasser
                    </div>
                    <div id="tideHigh">12:48</div>
                </div>
            </div>
            <div class="tide-suggestions" id="tideSuggestions">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="margin-right: 4px; flex-shrink: 0;">
                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
                <span><strong>Perfekt jetzt:</strong> Hafenrundfahrt, Fischrestaurants am Wasser</span>
            </div>
            <div style="margin-top: 4px; padding: 6px 10px; background: rgba(255,200,0,0.15); border-radius: 6px; font-size: 10px; color: rgba(255,255,255,0.85); display: flex; align-items: center; gap: 5px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="#ffc107" stroke-width="2" width="10" height="10" style="flex-shrink: 0;">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                Ungefähre Angaben – vor Ort prüfen
            </div>
        </div>

        <div class="quick-stats" style="margin-top: 20px;">
            <div class="stat-card">
                <div class="stat-number" id="statRestaurants">0</div>
                <div class="stat-label">Restaurants</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statTables">0</div>
                <div class="stat-label">Freie Tische</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statOffers">0</div>
                <div class="stat-label">Angebote</div>
            </div>
        </div>

        <!-- KARTE - Kompakt mit Klick zum Vergrößern -->
        <div id="mapSection" class="map-section" onclick="openFullscreenMap()" style="margin: 24px 20px; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.12); position: relative; cursor: pointer;">
            <div id="guestMap" style="height: 160px; width: 100%;"></div>
            
            <!-- Overlay mit "Karte öffnen" Hinweis -->
            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.5)); padding: 12px 16px; display: flex; align-items: center; justify-content: flex-end;">
                <div style="background: white; padding: 8px 14px; border-radius: 20px; display: flex; align-items: center; gap: 6px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" width="16" height="16">
                        <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                    </svg>
                    <span style="font-size: 12px; font-weight: 600; color: var(--primary);">Karte öffnen</span>
                </div>
            </div>
        </div>

        <section class="section">
            <div class="search-bar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" placeholder="Restaurant suchen..." id="searchInput" oninput="searchRestaurants()">
            </div>
            
            <div class="filter-chips" id="filterChips">
                <div class="chip active" data-filter="all" onclick="setFilter('all')">Alle</div>
                <div class="chip" data-filter="fisch" onclick="setFilter('fisch')">Fisch</div>
                <div class="chip" data-filter="deutsch" onclick="setFilter('deutsch')">Deutsch</div>
                <div class="chip" data-filter="italienisch" onclick="setFilter('italienisch')">Italienisch</div>
                <div class="chip" data-filter="cafe" onclick="setFilter('cafe')">Café</div>
                <div class="chip" data-filter="imbiss" onclick="setFilter('imbiss')">Imbiss</div>
            </div>
        </section>

        <section class="live-section">
            <div class="live-header">
                <div class="live-dot"></div>
                <span class="live-title">Gerade in <span id="liveLocation">Ostfriesland</span></span>
            </div>
            <div class="live-count" id="liveCount">0</div>
            <div class="live-label"><span id="liveReservations">0</span> Reservierungen heute • <span id="liveFreeTables">0</span> Tische frei</div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2 class="section-title" data-i18n="restaurants">Restaurants</h2>
            </div>
            
            <!-- Schnellaktionen: Überraschung & Gruppe -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px;">
                <div onclick="surpriseMe()" style="background: var(--primary); border-radius: 12px; padding: 14px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="22" height="22">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <div style="color: white;">
                        <div style="font-size: 14px; font-weight: 700;">Überrasch mich!</div>
                        <div style="font-size: 11px; opacity: 0.8;">Zufällig wählen</div>
                    </div>
                </div>
                <div onclick="openGroupReservationModal()" style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 14px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <div>
                        <div style="font-size: 14px; font-weight: 700;">Gruppen-Tisch</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">Mit Freunden</div>
                    </div>
                </div>
            </div>
            
            <!-- Filter Buttons -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px;">
                <button onclick="filterRestaurants('all')" id="filterAll" class="filter-chip active" data-i18n="all">Alle</button>
                <button onclick="filterRestaurants('open')" id="filterOpen" class="filter-chip" data-i18n="openNow">Jetzt geöffnet</button>
                <button onclick="filterRestaurants('tables')" id="filterTables" class="filter-chip" data-i18n="freeTables">Freie Tische</button>
                <button onclick="filterRestaurants('rating')" id="filterRating" class="filter-chip" data-i18n="topRated">Top bewertet</button>
            </div>

            <div id="restaurantList">
                <!-- Restaurant cards will be inserted here -->
            </div>
        </section>

        <!-- Footer -->
        <footer style="padding: 24px 20px 120px; text-align: center; border-top: 1px solid var(--border-color); margin-top: 20px;">
            <div style="font-size: 13px; color: var(--slate); margin-bottom: 12px;">
                <span data-i18n="footerText">© 2025 Kiek mol in – Ostfriesland genießen</span>
            </div>
            <div style="display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; margin-bottom: 16px;">
                <a href="#" onclick="openModal('impressumModal'); return false;" style="font-size: 13px; color: var(--slate); text-decoration: none;" data-i18n="impressum">Impressum</a>
                <a href="#" onclick="openModal('datenschutzModal'); return false;" style="font-size: 13px; color: var(--slate); text-decoration: none;" data-i18n="privacy">Datenschutz</a>
                <a href="/cdn-cgi/l/email-protection#0c65626a634c676569676163606562226869" style="font-size: 13px; color: var(--slate); text-decoration: none;" data-i18n="contact">Kontakt</a>
            </div>
            <div style="font-size: 11px; color: var(--slate); opacity: 0.7; max-width: 320px; margin: 0 auto; line-height: 1.5;">
                Alle Angaben ohne Gewähr. Öffnungszeiten, Verfügbarkeiten und Preise können abweichen. Bitte vor Ort prüfen.
            </div>
        </footer>
    </div>

    <!-- Favorites View -->
    <div class="favorites-view" id="favoritesView">
        <div class="favorites-header">
            <h1 data-i18n="favorites">Favoriten</h1>
        </div>
        <div id="favoritesList">
            <!-- Favorites will be inserted here -->
        </div>
        <div style="height: 100px;"></div>
    </div>

    <!-- Accommodations View -->
    <div class="favorites-view" id="accommodationsView">
        <header class="guest-header">
            <div class="logo">Kiek mol <span>in</span></div>
            <p class="tagline" data-i18n="accommodationsTagline">Unterkünfte in Ostfriesland</p>
            
            <div class="location-bar" onclick="openModal('locationModal')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                <span id="currentLocationAcc">Greetsiel</span>
                <span class="change">Ändern ›</span>
            </div>
        </header>

        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-number" id="statAccommodations">0</div>
                <div class="stat-label">Unterkünfte</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statAvailable">0</div>
                <div class="stat-label">Verfügbar</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statAccOffers">0</div>
                <div class="stat-label">Angebote</div>
            </div>
        </div>

        <section class="section">
            <div class="search-bar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" placeholder="Unterkunft suchen..." id="searchAccommodation" oninput="filterAccommodationsBySearch()">
            </div>
            
            <div class="filter-chips" id="filterChipsAcc">
                <div class="chip active" data-filter="all" onclick="setAccFilter('all')">Alle</div>
                <div class="chip" data-filter="ferienwohnung" onclick="setAccFilter('ferienwohnung')">Ferienwohnung</div>
                <div class="chip" data-filter="hotel" onclick="setAccFilter('hotel')">Hotel</div>
                <div class="chip" data-filter="pension" onclick="setAccFilter('pension')">Pension</div>
                <div class="chip" data-filter="available" onclick="setAccFilter('available')">Verfügbar</div>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Unterkünfte</h2>
            </div>

            <div id="accommodationsList">
                <!-- Accommodation cards will be inserted here -->
            </div>
        </section>

        <div style="height: 100px;"></div>
    </div>

    <!-- Events View -->
    <div class="favorites-view" id="eventsView">
        <header class="guest-header">
            <div class="logo">Kiek mol <span>in</span></div>
            <p class="tagline" data-i18n="eventsTagline">Events in Ostfriesland</p>
        </header>

        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-number" id="statEvents">0</div>
                <div class="stat-label">Events</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statThisMonth">0</div>
                <div class="stat-label">Diesen Monat</div>
            </div>
        </div>

        <section class="section">
            <div class="filter-chips" id="filterChipsEvents">
                <div class="chip active" data-filter="all" onclick="setEventFilter('all')">Alle</div>
                <div class="chip" data-filter="fest" onclick="setEventFilter('fest')">Feste</div>
                <div class="chip" data-filter="markt" onclick="setEventFilter('markt')">Märkte</div>
                <div class="chip" data-filter="konzert" onclick="setEventFilter('konzert')">Konzerte</div>
                <div class="chip" data-filter="natur" onclick="setEventFilter('natur')">Natur</div>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Veranstaltungen</h2>
            </div>
            <div id="eventsList">
                <!-- Events will be inserted here -->
            </div>
        </section>

        <div style="height: 100px;"></div>
    </div>

    <!-- Attractions View -->
    <div class="favorites-view" id="attractionsView">
        <header class="guest-header">
            <div class="logo">Kiek mol <span>in</span></div>
            <p class="tagline">Entdecke Ostfriesland</p>
        </header>

        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-number" id="statAttractions">0</div>
                <div class="stat-label">Ausflugsziele</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    <svg viewBox="0 0 24 24" fill="var(--warning)" width="24" height="24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </div>
                <div class="stat-label">Top bewertet</div>
            </div>
        </div>

        <section class="section">
            <div class="filter-chips" id="filterChipsAttractions">
                <div class="chip active" data-filter="all" onclick="setAttractionFilter('all')">Alle</div>
                <div class="chip" data-filter="natur" onclick="setAttractionFilter('natur')">Natur</div>
                <div class="chip" data-filter="museum" onclick="setAttractionFilter('museum')">Museen</div>
                <div class="chip" data-filter="historisch" onclick="setAttractionFilter('historisch')">Historisch</div>
                <div class="chip" data-filter="familie" onclick="setAttractionFilter('familie')">Familie</div>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Ausflugsziele</h2>
            </div>
            <div id="attractionsList">
                <!-- Attractions will be inserted here -->
            </div>
        </section>

        <div style="height: 100px;"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="showMainView()" id="navHome">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                <line x1="6" y1="1" x2="6" y2="4"/>
                <line x1="10" y1="1" x2="10" y2="4"/>
                <line x1="14" y1="1" x2="14" y2="4"/>
            </svg>
            <span data-i18n="navFood">Essen</span>
        </div>
        <div class="nav-item" onclick="showAccommodations()" id="navAccommodations">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 20v-8a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8"/>
                <path d="M4 10V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4"/>
                <rect x="6" y="12" width="4" height="4"/>
                <rect x="14" y="12" width="4" height="4"/>
            </svg>
            <span data-i18n="navSleep">Schlafen</span>
        </div>
        <div class="nav-item" onclick="showEvents()" id="navEvents">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <span data-i18n="navEvents">Events</span>
        </div>
        <div class="nav-item" onclick="showAttractions()" id="navAttractions">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="10" r="3"/>
                <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z"/>
            </svg>
            <span data-i18n="navDiscover">Entdecken</span>
        </div>
        <div class="nav-item" onclick="showJobs()" id="navJobs">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
            </svg>
            <span data-i18n="navJobs">Jobs</span>
        </div>
    </nav>
    
    <!-- Jobs View -->
    <div class="favorites-view" id="jobsView">
        <header class="guest-header">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div class="logo">Kiek mol <span>in</span></div>
            </div>
            <p class="tagline" data-i18n="jobsTagline">Jobs in Ostfriesland</p>
            
            <div class="location-bar" onclick="openModal('locationModal')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                <span id="currentLocationJobs">Greetsiel</span>
                <span class="change" data-i18n="change">Ändern ›</span>
            </div>
        </header>

        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-number" id="statJobsTotal">0</div>
                <div class="stat-label" data-i18n="jobsOpen">Offene Stellen</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statJobsUrgent">0</div>
                <div class="stat-label" data-i18n="jobsUrgent">Dringend</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statJobsRestaurants">0</div>
                <div class="stat-label" data-i18n="restaurants">Restaurants</div>
            </div>
        </div>
        
        <!-- Job Filter -->
        <div style="padding: 0 20px; margin-bottom: 16px;">
            <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px;">
                <button onclick="filterJobs('all')" id="filterJobsAll" class="filter-chip active" data-i18n="all">Alle</button>
                <button onclick="filterJobs('fulltime')" id="filterJobsFulltime" class="filter-chip" data-i18n="fulltime">Vollzeit</button>
                <button onclick="filterJobs('parttime')" id="filterJobsParttime" class="filter-chip" data-i18n="parttime">Teilzeit</button>
                <button onclick="filterJobs('minijob')" id="filterJobsMinijob" class="filter-chip" data-i18n="minijob">Minijob</button>
            </div>
        </div>

        <section class="section" style="padding: 0 20px;">
            <div class="section-header">
                <h2 class="section-title" data-i18n="currentJobs">Aktuelle Stellenangebote</h2>
            </div>

            <div id="jobsList">
                <!-- Jobs werden hier geladen -->
                <div style="text-align: center; padding: 40px; color: var(--slate);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 16px; opacity: 0.5;">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                    </svg>
                    <p data-i18n="loadingJobs">Jobs werden geladen...</p>
                </div>
            </div>
        </section>

        <div style="height: 100px;"></div>
    </div>
    
    <!-- KI Assistent Button -->
    <button onclick="openAssistant()" class="assistant-btn" id="assistantBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
        </svg>
    </button>
</div>

<!-- KI Assistent Chat -->
<div class="assistant-overlay" id="assistantOverlay">
    <div class="assistant-chat">
        <div class="assistant-header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="assistant-avatar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                        <path d="M12 2a4 4 0 0 1 4 4v2a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4z"/>
                        <path d="M16 14H8a4 4 0 0 0-4 4v2h16v-2a4 4 0 0 0-4-4z"/>
                    </svg>
                </div>
                <div>
                    <div style="font-weight: 700; color: var(--text-primary);">Kiek Assistent</div>
                    <div style="font-size: 12px; color: var(--success);">Online</div>
                </div>
            </div>
            <button onclick="closeAssistant()" style="background: none; border: none; cursor: pointer; padding: 8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-primary)" stroke-width="2" width="24" height="24">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        
        <div class="assistant-messages" id="assistantMessages">
            <div class="assistant-message bot">
                <div class="message-content">
                    Moin! Ich bin dein Kiek mol in Assistent. Wie kann ich dir helfen?
                </div>
            </div>
            <div class="assistant-suggestions" id="assistantSuggestions">
                <button onclick="askAssistant('Wo gibt es guten Fisch?')">Fisch-Restaurant</button>
                <button onclick="askAssistant('Welches Restaurant hat jetzt frei?')">Freie Tische</button>
                <button onclick="askAssistant('Was kann ich in Greetsiel machen?')">Ausflugstipps</button>
                <button onclick="askAssistant('Wie reserviere ich einen Tisch?')">Reservierung</button>
            </div>
        </div>
        
        <div class="assistant-input">
            <input type="text" id="assistantInput" placeholder="Schreib eine Nachricht..." onkeypress="if(event.key==='Enter')sendAssistantMessage()">
            <button onclick="sendAssistantMessage()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- ==================== DASHBOARD VIEW ==================== -->
<div class="dashboard-view" id="dashboardView">
    
    <aside class="dash-sidebar">
        <div class="dash-logo">
            <div class="logo">Kiek mol <span>in</span></div>
            <div class="restaurant-label">Admin Dashboard</div>
        </div>
        
        <nav class="dash-nav">
            <div class="dash-nav-item active" id="navDashboard" onclick="showDashboardSection('dashboard')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/>
                    <rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/>
                    <rect x="3" y="14" width="7" height="7"/>
                </svg>
                Dashboard
            </div>
            <div class="dash-nav-item" id="navReservations" onclick="showDashboardSection('reservations')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Reservierungen
                <span class="nav-count" id="reservationCount">3</span>
            </div>
            <div class="dash-nav-item" id="navOffers" onclick="showDashboardSection('offers')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
                Angebote
                <span class="nav-count" id="offerCount">1</span>
            </div>
            <div class="dash-nav-item" id="navAccommodationsDash" onclick="showDashboardSection('accommodationsDash')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M2 20v-8a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8"/>
                    <path d="M4 10V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4"/>
                    <path d="M2 20h20"/>
                    <rect x="6" y="12" width="4" height="4"/>
                    <rect x="14" y="12" width="4" height="4"/>
                </svg>
                Unterkünfte
                <span class="nav-count" id="accommodationCount">0</span>
            </div>
            <div class="dash-nav-item" id="navEventsDash" onclick="showDashboardSection('eventsDash')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Events
                <span class="nav-count" id="eventCount">0</span>
            </div>
            <div class="dash-nav-item" id="navAttractionsDash" onclick="showDashboardSection('attractionsDash')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="10" r="3"/>
                    <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z"/>
                </svg>
                Ausflugsziele
                <span class="nav-count" id="attractionCount">0</span>
            </div>
            <div class="dash-nav-item" id="navJobsDash" onclick="showDashboardSection('jobsDash')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                </svg>
                Jobs
                <span class="nav-count" id="jobCount">0</span>
            </div>
            <div class="dash-nav-item" id="navRestaurantsDash" onclick="showDashboardSection('restaurantsDash')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                    <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                    <line x1="6" y1="1" x2="6" y2="4"/>
                    <line x1="10" y1="1" x2="10" y2="4"/>
                    <line x1="14" y1="1" x2="14" y2="4"/>
                </svg>
                Restaurants
                <span class="nav-count" id="restaurantCountDash">0</span>
            </div>
            <div class="dash-nav-item" id="navTischplan" onclick="showDashboardSection('tischplan')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/>
                    <rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/>
                    <rect x="3" y="14" width="7" height="7"/>
                </svg>
                Tischplan
            </div>
            <div class="dash-nav-item" id="navRewards" onclick="showDashboardSection('rewards')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="8" r="7"/>
                    <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
                </svg>
                Belohnungen
            </div>
            <div class="dash-nav-item" id="navStatistics" onclick="showDashboardSection('statistics')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Statistiken
            </div>
            <div class="dash-nav-item" id="navRevenue" onclick="showDashboardSection('revenue')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"/>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
                Umsatz
            </div>
            
            <!-- Theme Toggle -->
            <div class="dash-nav-item" onclick="openModal('themeModal');" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                </svg>
                Design
            </div>
        </nav>
        
        <!-- Admin Profile / Logout -->
        <div style="position: absolute; bottom: 24px; left: 16px; right: 16px;">
            <div style="padding: 16px; background: rgba(255,255,255,0.1); border-radius: 12px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;" id="adminAvatar">A</div>
                    <div>
                        <div style="color: white; font-weight: 600; font-size: 14px;" id="adminName">Admin</div>
                        <div style="color: rgba(255,255,255,0.6); font-size: 12px;" id="adminEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3e5f5a5357507e5b535f5752105a5b">[email&#160;protected]</a></div>
                    </div>
                </div>
                <button onclick="adminLogout()" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; color: rgba(255,255,255,0.8); font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Abmelden
                </button>
            </div>
        </div>
    </aside>

    <main class="dash-main">
        <header class="dash-header">
            <div>
                <h1 class="dash-greeting">Moin! </h1>
                <p class="dash-date" id="currentDate"></p>
                <p style="font-size: 12px; color: var(--success); margin-top: 4px;" id="connectionStatus">• Mit Supabase verbunden</p>
            </div>
            <div class="dash-actions">
                <button class="dash-btn dash-btn-secondary" onclick="refreshData()" title="Daten neu laden">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                        <path d="M21 3v5h-5"/>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                        <path d="M8 16H3v5"/>
                    </svg>
                    Aktualisieren
                </button>
                <button class="dash-btn dash-btn-secondary" onclick="openNewRestaurantModal()" title="Restaurant hinzufügen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                        <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                        <line x1="6" y1="1" x2="6" y2="4"/>
                        <line x1="10" y1="1" x2="10" y2="4"/>
                        <line x1="14" y1="1" x2="14" y2="4"/>
                    </svg>
                    Restaurant +
                </button>
                <button class="dash-btn dash-btn-primary" onclick="showDashboardSection('offers')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Angebot erstellen
                </button>
            </div>
        </header>

        <!-- DASHBOARD SECTION -->
        <div id="sectionDashboard" class="dash-section active">
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="dashGuestsToday">0</div>
                    <div class="stat-box-label">Gäste heute via App</div>
                </div>
                
                <div class="stat-box" onclick="showDashboardSection('reservations')" style="cursor: pointer;">
                    <div class="stat-box-header">
                        <div class="stat-box-icon orange">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="dashReservationsToday">0</div>
                    <div class="stat-box-label">Reservierungen heute →</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="dashRevenue">0€</div>
                    <div class="stat-box-label">Umsatz (bezahlt)</div>
                </div>
                
                <div class="stat-box" onclick="showDashboardSection('offers')" style="cursor: pointer;">
                    <div class="stat-box-header">
                        <div class="stat-box-icon gold">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="dashOffersCount">1</div>
                    <div class="stat-box-label">Aktive Angebote →</div>
                </div>
            </div>

            <div class="panels-grid">
                <div class="panel">
                    <div class="panel-header">
                        <h3 class="panel-title">Tischübersicht</h3>
                    </div>
                    <div class="panel-content">
                        <div class="availability-control">
                            <div class="availability-status">
                                <div class="status-indicator" id="restaurantStatus"></div>
                                <span class="status-text" id="restaurantStatusText">Restaurant offen</span>
                            </div>
                            <div class="toggle-switch" id="restaurantToggle" onclick="toggleRestaurant()"></div>
                        </div>
                        <div class="table-grid" id="tableGrid">
                            <!-- Tables will be inserted here -->
                        </div>
                        <div class="table-legend">
                            <span class="legend-item"><span class="legend-dot free"></span> Frei</span>
                            <span class="legend-item"><span class="legend-dot occupied"></span> Besetzt</span>
                            <span class="legend-item"><span class="legend-dot reserved"></span> Reserviert</span>
                        </div>
                    </div>
                </div>

                <div class="panel" onclick="showDashboardSection('reservations')" style="cursor: pointer;">
                    <div class="panel-header">
                        <h3 class="panel-title">Nächste Reservierungen</h3>
                        <span style="color: var(--primary); font-size: 14px; font-weight: 600;">Alle anzeigen →</span>
                    </div>
                    <div class="panel-content" id="reservationsPreview">
                        <!-- Preview will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- RESERVATIONS SECTION -->
        <div id="sectionReservations" class="dash-section">
            <div class="section-back" onclick="showDashboardSection('dashboard')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Zurück zum Dashboard
            </div>
            
            <h2 class="section-page-title">Reservierungen</h2>
            
            <div class="panel" style="margin-top: 20px;">
                <div class="panel-header">
                    <h3 class="panel-title">Heute</h3>
                    <span id="todayDate" style="color: var(--slate); font-size: 14px;"></span>
                </div>
                <div class="panel-content" id="reservationsList">
                    <!-- Reservations will be inserted here -->
                </div>
            </div>
            
            <div class="panel" style="margin-top: 20px;">
                <div class="panel-header">
                    <h3 class="panel-title">Neue Reservierung hinzufügen</h3>
                </div>
                <div class="panel-content">
                    <form id="manualReservationForm" onsubmit="addManualReservation(event)">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                            <div class="form-group">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-input" id="manualGuestName" required placeholder="Gast Name">
                            </div>
                            <div class="form-group">
                                <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></span>Telefon</label>
                                <input type="tel" class="form-input" id="manualGuestPhone" placeholder="Optional">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Uhrzeit</label>
                                <select class="form-select" id="manualTime" required>
                                    <option value="17:00">17:00</option>
                                    <option value="17:30">17:30</option>
                                    <option value="18:00">18:00</option>
                                    <option value="18:30">18:30</option>
                                    <option value="19:00">19:00</option>
                                    <option value="19:30">19:30</option>
                                    <option value="20:00">20:00</option>
                                    <option value="20:30">20:30</option>
                                    <option value="21:00">21:00</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Personen</label>
                                <select class="form-select" id="manualPartySize" required>
                                    <option value="1">1</option>
                                    <option value="2" selected>2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8+</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="dash-btn dash-btn-primary" style="margin-top: 16px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Reservierung hinzufügen
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- OFFERS SECTION -->
        <div id="sectionOffers" class="dash-section">
            <div class="section-back" onclick="showDashboardSection('dashboard')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Zurück zum Dashboard
            </div>
            
            <h2 class="section-page-title">Angebote verwalten</h2>
            
            <div class="panels-grid" style="margin-top: 20px;">
                <div class="panel">
                    <div class="panel-header">
                        <h3 class="panel-title">Neues Angebot erstellen</h3>
                        <span style="font-size: 13px; color: var(--slate);">Erreicht ~1.200 Nutzer</span>
                    </div>
                    <div class="panel-content">
                        <form class="offer-form" id="offerForm" onsubmit="createOffer(event)">
                            <div class="form-group">
                                <label class="form-label">Angebot-Titel *</label>
                                <input type="text" class="form-input" id="offerTitle" placeholder="z.B. Matjes-Spezial" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Rabatt *</label>
                                    <input type="text" class="form-input" id="offerDiscount" placeholder="z.B. 15%" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Gültig bis *</label>
                                    <input type="time" class="form-input" id="offerValidUntil" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Beschreibung (optional)</label>
                                <input type="text" class="form-input" id="offerDescription" placeholder="Kurze Beschreibung">
                            </div>
                            
                            <div class="offer-preview" style="margin: 20px 0;">
                                <div class="offer-preview-label">Vorschau</div>
                                <div class="offer-preview-title" id="previewTitle">Dein Angebot</div>
                                <div class="offer-preview-discount" id="previewDiscount">Rabatt bis --:--</div>
                            </div>
                            
                            <button type="submit" class="dash-btn dash-btn-primary" style="width: 100%;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="22" y1="2" x2="11" y2="13"/>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                </svg>
                                Jetzt veröffentlichen
                            </button>
                        </form>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <h3 class="panel-title">Aktive Angebote</h3>
                    </div>
                    <div class="panel-content" id="activeOffersList">
                        <!-- Active offers will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- CUSTOMERS SECTION -->
        <div id="sectionCustomers" class="dash-section">
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Kundenverwaltung</h2>
                    <p style="color: var(--slate); margin-top: 4px;">Restaurant-Partner verwalten</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="dash-btn" onclick="exportSEPACSV()" style="background: var(--bg-secondary); color: var(--dark);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        SEPA Export
                    </button>
                    <button class="dash-btn dash-btn-primary" onclick="openModal('addCustomerModal')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Neuer Kunde
                    </button>
                </div>
            </div>

            <!-- Statistiken -->
            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="totalCustomers">0</div>
                    <div class="stat-box-label">Kunden gesamt</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="paidCustomers">0</div>
                    <div class="stat-box-label">Bezahlt</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon orange">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="pendingCustomers">0</div>
                    <div class="stat-box-label">Ausstehend</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon" style="background: rgba(255,59,48,0.15);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#ff3b30" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="overdueCustomers" style="color: var(--danger);">0</div>
                    <div class="stat-box-label">Überfällig</div>
                </div>
            </div>

            <!-- Kundenliste -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">Alle Kunden</h3>
                </div>
                <div class="panel-content" id="customersList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Lade Kunden...</p>
                </div>
            </div>
        </div>

        <!-- ACCOMMODATIONS DASHBOARD SECTION -->
        <div id="sectionAccommodationsDash" class="dash-section">
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Unterkünfte</h2>
                    <p style="color: var(--slate); margin-top: 4px;">Hotels, Ferienwohnungen & Pensionen verwalten</p>
                </div>
                <button class="dash-btn dash-btn-primary" onclick="openModal('addAccommodationModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Neue Unterkunft
                </button>
            </div>

            <!-- Statistiken -->
            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M2 20v-8a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8"/>
                                <path d="M4 10V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="totalAccommodations">0</div>
                    <div class="stat-box-label">Unterkünfte gesamt</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="availableAccommodations">0</div>
                    <div class="stat-box-label">Verfügbar</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon orange">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="accommodationInquiries">0</div>
                    <div class="stat-box-label">Anfragen</div>
                </div>
            </div>

            <!-- Unterkünfte Liste -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">Alle Unterkünfte</h3>
                </div>
                <div class="panel-content" id="accommodationsDashList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Lade Unterkünfte...</p>
                </div>
            </div>

            <!-- Anfragen Liste -->
            <div class="panel" style="margin-top: 24px;">
                <div class="panel-header">
                    <h3 class="panel-title">Aktuelle Anfragen</h3>
                </div>
                <div class="panel-content" id="accommodationInquiriesList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Keine Anfragen</p>
                </div>
            </div>
        </div>

        <!-- EVENTS DASHBOARD SECTION -->
        <div id="sectionEventsDash" class="dash-section">
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Events</h2>
                    <p style="color: var(--slate); margin-top: 4px;">Veranstaltungen verwalten</p>
                </div>
                <button class="dash-btn dash-btn-primary" onclick="openModal('addEventModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Neues Event
                </button>
            </div>

            <!-- Stats -->
            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-box">
                    <div class="stat-box-value" id="statTotalEvents">0</div>
                    <div class="stat-box-label">Gesamt</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="statUpcomingEvents">0</div>
                    <div class="stat-box-label">Kommende</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="statFeaturedEvents">0</div>
                    <div class="stat-box-label">Highlights</div>
                </div>
            </div>

            <!-- Events Liste -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">Alle Events</h3>
                </div>
                <div class="panel-content" id="eventsDashList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Lade Events...</p>
                </div>
            </div>
        </div>

        <!-- ATTRACTIONS DASHBOARD SECTION -->
        <div id="sectionAttractionsDash" class="dash-section">
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Ausflugsziele</h2>
                    <p style="color: var(--slate); margin-top: 4px;">Sehenswürdigkeiten verwalten</p>
                </div>
                <button class="dash-btn dash-btn-primary" onclick="openModal('addAttractionModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Neues Ausflugsziel
                </button>
            </div>

            <!-- Stats -->
            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-box">
                    <div class="stat-box-value" id="statTotalAttractions">0</div>
                    <div class="stat-box-label">Gesamt</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="statNaturAttractions">0</div>
                    <div class="stat-box-label">Natur</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="statMuseumAttractions">0</div>
                    <div class="stat-box-label">Museen</div>
                </div>
            </div>

            <!-- Attractions Liste -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">Alle Ausflugsziele</h3>
                </div>
                <div class="panel-content" id="attractionsDashList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Lade Ausflugsziele...</p>
                </div>
            </div>
        </div>

        <!-- JOBS DASHBOARD SECTION -->
        <div id="sectionJobsDash" class="dash-section" style="display: none;">
            <div class="section-header" style="margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Jobs verwalten</h2>
                <p style="color: var(--slate); margin-top: 4px;">Stellenanzeigen erstellen und verwalten</p>
            </div>

            <!-- Job hinzufügen -->
            <div class="panel" style="margin-bottom: 24px;">
                <div class="panel-header">
                    <h3 class="panel-title">Neue Stellenanzeige</h3>
                </div>
                <div class="panel-content">
                    <form id="addJobForm" onsubmit="addJob(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Jobtitel *</label>
                                <input type="text" class="form-input" id="newJobTitle" placeholder="z.B. Kellner/in gesucht" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Art</label>
                                <select class="form-select" id="newJobType">
                                    <option value="fulltime">Vollzeit</option>
                                    <option value="parttime">Teilzeit</option>
                                    <option value="minijob">Minijob</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Restaurant</label>
                                <select class="form-select" id="newJobRestaurant">
                                    <option value="">-- Restaurant wählen --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gehalt (optional)</label>
                                <input type="text" class="form-input" id="newJobSalary" placeholder="z.B. 13€/Stunde">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Beschreibung</label>
                            <textarea class="form-input" id="newJobDescription" rows="3" placeholder="Was sind die Aufgaben? Was wird erwartet?"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Kontakt WhatsApp</label>
                                <input type="text" class="form-input" id="newJobWhatsApp" placeholder="+49 176 ...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Kontakt E-Mail</label>
                                <input type="email" class="form-input" id="newJobEmail" placeholder="jobs@restaurant.de">
                            </div>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="newJobUrgent">
                                <span style="color: var(--slate);">Dringend gesucht</span>
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary">Job veröffentlichen</button>
                    </form>
                </div>
            </div>

            <!-- Jobs Liste -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">Aktive Stellenanzeigen</h3>
                </div>
                <div class="panel-content" id="jobsDashList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Lade Jobs...</p>
                </div>
            </div>
        </div>

        <!-- RESTAURANTS DASHBOARD SECTION -->
        <div id="sectionRestaurantsDash" class="dash-section" style="display: none;">
            <div class="section-header" style="margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Alle Restaurants</h2>
                <p style="color: var(--slate); margin-top: 4px;">Übersicht und Verwaltung aller Restaurants</p>
            </div>

            <!-- Schnellübersicht -->
            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-box">
                    <div class="stat-box-value" id="statActiveRestaurants">0</div>
                    <div class="stat-box-label">Aktive Restaurants</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="statTotalTablesAll">0</div>
                    <div class="stat-box-label">Tische gesamt</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="statFreeTablesAll">0</div>
                    <div class="stat-box-label">Freie Tische</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="statTodayReservationsAll">0</div>
                    <div class="stat-box-label">Reservierungen heute</div>
                </div>
            </div>

            <!-- Restaurants Liste -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">Restaurant-Liste</h3>
                    <button class="btn btn-primary" onclick="openNewRestaurantModal()" style="padding: 8px 16px; font-size: 13px;">
                        + Neues Restaurant
                    </button>
                </div>
                <div class="panel-content" id="restaurantsDashList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Lade Restaurants...</p>
                </div>
            </div>
        </div>

        <!-- TISCHPLAN ADMIN SECTION -->
        <div id="sectionTischplan" class="dash-section" style="display: none;">
            <div class="section-header" style="margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">🪑 Tischplan</h2>
                <p style="color: var(--slate); margin-top: 4px;">Visuelle Tischverwaltung für alle Restaurants</p>
            </div>
            
            <!-- Restaurant Auswahl -->
            <div style="background: var(--bg-card); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                <label style="font-size: 14px; font-weight: 600; color: var(--dark); display: block; margin-bottom: 8px;">Restaurant auswählen:</label>
                <select id="adminTischplanSelect" onchange="adminLoadTischplan(this.value)" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 15px; background: var(--bg-secondary);">
                    <option value="">-- Restaurant wählen --</option>
                </select>
            </div>
            
            <!-- Tischplan Container -->
            <div class="tischplan-box" id="adminTischplanBox" style="display: none;">
                <div class="tischplan-header">
                    <h3 style="font-size: 18px; font-weight: 700; color: var(--dark); margin: 0;">🪑 Tische</h3>
                    <button onclick="tpAddTable()" style="padding: 8px 16px; background: #ff6b35; color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">+ Tisch</button>
                </div>
                <div class="tischplan-filters">
                    <button class="tischplan-filter active" data-filter="all" onclick="tpFilter('all')">Alle Tische</button>
                    <button class="tischplan-filter" data-filter="available" onclick="tpFilter('available')">Verfügbar</button>
                    <button class="tischplan-filter" data-filter="reserved" onclick="tpFilter('reserved')">Reserviert</button>
                    <button class="tischplan-filter" data-filter="billed" onclick="tpFilter('billed')">Besetzt</button>
                </div>
                <div class="tischplan-legend">
                    <div class="tischplan-legend-item"><div class="tischplan-legend-dot available"></div> Verfügbar</div>
                    <div class="tischplan-legend-item"><div class="tischplan-legend-dot reserved"></div> Reserviert</div>
                    <div class="tischplan-legend-item"><div class="tischplan-legend-dot billed"></div> Besetzt</div>
                    <div class="tischplan-legend-item"><div class="tischplan-legend-dot soon"></div> Bald frei</div>
                </div>
                <div class="tischplan-canvas" id="adminTischplanCanvas"></div>
                <div class="tischplan-stats">
                    <div class="tischplan-stat"><div class="tischplan-stat-num" id="adminTpAvailable" style="color:#3b82f6">0</div><div class="tischplan-stat-label">Verfügbar</div></div>
                    <div class="tischplan-stat"><div class="tischplan-stat-num" id="adminTpReserved" style="color:#ef4444">0</div><div class="tischplan-stat-label">Reserviert</div></div>
                    <div class="tischplan-stat"><div class="tischplan-stat-num" id="adminTpBilled" style="color:#22c55e">0</div><div class="tischplan-stat-label">Besetzt</div></div>
                    <div class="tischplan-stat"><div class="tischplan-stat-num" id="adminTpRevenue" style="color:#ff6b35">0€</div><div class="tischplan-stat-label">Umsatz</div></div>
                </div>
            </div>
        </div>

        <!-- REWARDS SECTION - Belohnungen verwalten -->
        <div id="sectionRewards" class="dash-section" style="display: none;">
            <div class="section-header" style="margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Belohnungen</h2>
                <p style="color: var(--slate); margin-top: 4px;">Erstelle Belohnungen für treue Gäste</p>
            </div>

            <!-- Info Box -->
            <div style="background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%); border-radius: 16px; padding: 20px; margin-bottom: 24px; color: #333;">
                <h3 style="margin: 0 0 8px; font-size: 18px;">💡 So funktioniert's</h3>
                <p style="margin: 0; font-size: 14px; line-height: 1.5;">
                    Gäste sammeln Punkte für Reservierungen und Bewertungen. 
                    Mit deinen Belohnungen gibst du ihnen einen Grund, wiederzukommen!
                    <br><strong>Tipp:</strong> Belohnungen ab 300-500 Punkte sind am beliebtesten.
                </p>
            </div>

            <!-- Aktive Belohnungen -->
            <div class="panel" style="margin-bottom: 24px;">
                <div class="panel-header">
                    <h3 class="panel-title">Meine Belohnungen</h3>
                    <button class="btn btn-primary" onclick="openModal('addRewardModal')" style="padding: 8px 16px; font-size: 13px;">
                        + Neue Belohnung
                    </button>
                </div>
                <div class="panel-content" id="rewardsList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Noch keine Belohnungen erstellt</p>
                </div>
            </div>

            <!-- Eingelöste Belohnungen -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">📋 Eingelöste Belohnungen</h3>
                    <span id="pendingRedemptionsCount" style="background: var(--warning); color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">0 offen</span>
                </div>
                <div class="panel-content" id="redemptionsList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Keine Einlösungen vorhanden</p>
                </div>
            </div>
        </div>

        <!-- STATISTICS SECTION -->
        <div id="sectionStatistics" class="dash-section">
            <div class="section-header" style="margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Statistiken</h2>
                <p style="color: var(--slate); margin-top: 4px;">Übersicht über alle Aktivitäten</p>
            </div>

            <!-- Übersicht Karten -->
            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                                <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="statTotalRestaurants">0</div>
                    <div class="stat-box-label">Restaurants</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M2 20v-8a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8"/>
                                <rect x="6" y="12" width="4" height="4"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="statTotalAccommodations">0</div>
                    <div class="stat-box-label">Unterkünfte</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon orange">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="statTotalReservations">0</div>
                    <div class="stat-box-label">Reservierungen</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon purple" style="background: rgba(175,82,222,0.15);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #AF52DE;">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="statTotalCustomers">0</div>
                    <div class="stat-box-label">Kunden</div>
                </div>
            </div>

            <!-- Aktivitäten diese Woche -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">Diese Woche</h3>
                </div>
                <div class="panel-content">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center;">
                        <div>
                            <div style="font-size: 32px; font-weight: 700; color: var(--primary);" id="weekReservations">0</div>
                            <div style="font-size: 13px; color: var(--slate);">Reservierungen</div>
                        </div>
                        <div>
                            <div style="font-size: 32px; font-weight: 700; color: var(--success);" id="weekInquiries">0</div>
                            <div style="font-size: 13px; color: var(--slate);">Anfragen</div>
                        </div>
                        <div>
                            <div style="font-size: 32px; font-weight: 700; color: var(--warning);" id="weekNewCustomers">0</div>
                            <div style="font-size: 13px; color: var(--slate);">Neue Kunden</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orte Übersicht -->
            <div class="panel" style="margin-top: 24px;">
                <div class="panel-header">
                    <h3 class="panel-title">Nach Ort</h3>
                </div>
                <div class="panel-content" id="locationStats">
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--cream); border-radius: 8px;">
                            <span style="font-weight: 600;">Greetsiel</span>
                            <span style="color: var(--primary); font-weight: 700;" id="statGreetsiel">0 Einträge</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--cream); border-radius: 8px;">
                            <span style="font-weight: 600;">Norddeich</span>
                            <span style="color: var(--primary); font-weight: 700;" id="statNorddeich">0 Einträge</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--cream); border-radius: 8px;">
                            <span style="font-weight: 600;">Norden</span>
                            <span style="color: var(--primary); font-weight: 700;" id="statNorden">0 Einträge</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--cream); border-radius: 8px;">
                            <span style="font-weight: 600;">Andere</span>
                            <span style="color: var(--primary); font-weight: 700;" id="statOther">0 Einträge</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- REVENUE SECTION -->
        <div id="sectionRevenue" class="dash-section">
            <div class="section-header" style="margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 700; color: var(--dark);">Umsatz</h2>
                <p style="color: var(--slate); margin-top: 4px;">Einnahmen und Zahlungsübersicht</p>
            </div>

            <!-- Umsatz Karten -->
            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="monthlyRevenue">0 €</div>
                    <div class="stat-box-label">Diesen Monat</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="yearlyRevenue">0 €</div>
                    <div class="stat-box-label">Dieses Jahr</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon orange">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="pendingRevenue">0 €</div>
                    <div class="stat-box-label">Ausstehend</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-header">
                        <div class="stat-box-icon" style="background: rgba(255,59,48,0.15);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--danger);">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-box-value" id="overdueRevenue" style="color: var(--danger);">0 €</div>
                    <div class="stat-box-label">Überfällig</div>
                </div>
            </div>

            <!-- Monatliche Einnahmen -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">Monatliche Einnahmen</h3>
                </div>
                <div class="panel-content" id="monthlyRevenueChart">
                    <div style="display: flex; align-items: flex-end; justify-content: space-between; height: 150px; padding: 20px 0;">
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0; transition: height 0.3s;" id="barJan"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Jan</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barFeb"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Feb</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barMar"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Mär</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barApr"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Apr</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barMay"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Mai</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barJun"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Jun</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barJul"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Jul</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barAug"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Aug</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barSep"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Sep</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barOct"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Okt</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--primary); width: 30px; border-radius: 4px 4px 0 0;" id="barNov"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Nov</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--success); width: 30px; border-radius: 4px 4px 0 0;" id="barDec"></div>
                            <span style="font-size: 11px; color: var(--slate); margin-top: 8px;">Dez</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Letzte Zahlungen -->
            <div class="panel" style="margin-top: 24px;">
                <div class="panel-header">
                    <h3 class="panel-title">Letzte Zahlungen</h3>
                </div>
                <div class="panel-content" id="recentPaymentsList" style="padding: 0;">
                    <p style="padding: 20px; color: var(--slate); text-align: center;">Keine Zahlungen</p>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Add Accommodation Modal -->
<div class="modal-overlay" id="addAccommodationModal">
    <div class="modal" style="max-width: 550px;">
        <div class="modal-header">
            <h2 class="modal-title">Neue Unterkunft</h2>
            <button class="modal-close" onclick="closeModal('addAccommodationModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <form id="addAccommodationForm" onsubmit="addAccommodation(event)">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="accName" required placeholder="z.B. Ferienwohnung Meerblick">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Typ</label>
                        <select class="form-input" id="accType">
                            <option value="ferienwohnung">Ferienwohnung</option>
                            <option value="hotel">Hotel</option>
                            <option value="pension">Pension</option>
                            <option value="b&b">B&B</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ort</label>
                        <input type="text" class="form-input" id="accCity" placeholder="z.B. Greetsiel">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></span>Preis-Info</label>
                        <input type="text" class="form-input" id="accPrice" placeholder="z.B. ab 75€ / Nacht">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max. Gäste</label>
                        <input type="number" class="form-input" id="accMaxGuests" value="4" min="1">
                    </div>
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Adresse</h4>
                
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></span>Straße</label>
                    <input type="text" class="form-input" id="accStreet" placeholder="z.B. Deichstraße 15">
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg></span>Google Maps Link</label>
                    <input type="url" class="form-input" id="accGoogleMaps" placeholder="https://maps.google.com/...">
                    <p style="font-size: 11px; color: var(--slate); margin-top: 4px;">Google Maps → Ort suchen → Teilen → Link kopieren</p>
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Kontakt</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></span>Telefon</label>
                        <input type="tel" class="form-input" id="accPhone" placeholder="+49 ...">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></span>WhatsApp</label>
                        <input type="tel" class="form-input" id="accWhatsapp" placeholder="+49 176 ...">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></span>Email</label>
                    <input type="email" class="form-input" id="accEmail" placeholder="info@unterkunft.de">
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Online</h4>
                
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></span>Webseite</label>
                    <input type="url" class="form-input" id="accWebsite" placeholder="https://...">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></span>Instagram</label>
                        <input type="text" class="form-input" id="accInstagram" placeholder="@name">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></span>Facebook</label>
                        <input type="url" class="form-input" id="accFacebook" placeholder="https://facebook.com/...">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span>Buchungslink</label>
                    <input type="url" class="form-input" id="accBookingUrl" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></span>Bild-URL</label>
                    <input type="url" class="form-input" id="accImage" placeholder="https://...">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 12px;">Unterkunft anlegen</button>
            </form>
        </div>
    </div>
</div>

<!-- Add Customer Modal -->
<div class="modal-overlay" id="addCustomerModal">
    <div class="modal" style="max-width: 550px;">
        <div class="modal-header">
            <h2 class="modal-title">Neuer Kunde</h2>
            <button class="modal-close" onclick="closeModal('addCustomerModal')">×</button>
        </div>
        <div class="modal-body">
            <form id="addCustomerForm" onsubmit="addCustomer(event)">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Kundendaten</h4>
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="customerName" required placeholder="z.B. Hans Müller">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-input" id="customerEmail" required placeholder="email@restaurant.de">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Passwort *</label>
                        <input type="text" class="form-input" id="customerPassword" required placeholder="Login-Passwort">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></span>Telefon</label>
                    <input type="tel" class="form-input" id="customerPhone" placeholder="+49 ...">
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--sand);">
                
                <h4 style="margin-bottom: 12px; color: var(--dark);">Restaurant</h4>
                <div class="form-group">
                    <label class="form-label">Restaurant zuweisen</label>
                    <select class="form-input" id="customerRestaurant" onchange="toggleNewRestaurant()">
                        <option value="">-- Neues Restaurant anlegen --</option>
                    </select>
                </div>
                
                <div id="newRestaurantFields">
                    <div class="form-group">
                        <label class="form-label">Restaurant Name *</label>
                        <input type="text" class="form-input" id="newRestName" placeholder="z.B. Greetsieler Fischhaus">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label class="form-label">Ort</label>
                            <input type="text" class="form-input" id="newRestCity" placeholder="z.B. Greetsiel, Norddeich, Norden...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Küche</label>
                            <input type="text" class="form-input" id="newRestCuisine" placeholder="z.B. Fisch, Deutsch, Türkisch, Café...">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></span>Telefon</label>
                            <input type="tel" class="form-input" id="newRestPhone" placeholder="+49 4926 ...">
                        </div>
                        <div class="form-group">
                            <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></span>WhatsApp</label>
                            <input type="tel" class="form-input" id="newRestWhatsapp" placeholder="+49 176 ...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></span>Webseite</label>
                        <input type="url" class="form-input" id="newRestWebsite" placeholder="https://www.restaurant.de">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></span>Facebook</label>
                            <input type="url" class="form-input" id="newRestFacebook" placeholder="https://facebook.com/...">
                        </div>
                        <div class="form-group">
                            <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></span>Instagram</label>
                            <input type="url" class="form-input" id="newRestInstagram" placeholder="https://instagram.com/...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Speisekarte</label>
                        <input type="text" class="form-input" id="newRestMenu" placeholder="Link zur Speisekarte oder PDF-URL">
                        <p style="font-size: 11px; color: var(--slate); margin-top: 4px;">Tipp: PDF auf Google Drive oder Dropbox hochladen und Link hier einfügen</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></span>Straße</label>
                        <input type="text" class="form-input" id="newRestStreet" placeholder="z.B. Hafenstraße 12">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg></span>Google Maps Link</label>
                        <input type="url" class="form-input" id="newRestGoogleMaps" placeholder="https://maps.google.com/...">
                        <p style="font-size: 11px; color: var(--slate); margin-top: 4px;">Google Maps öffnen → Restaurant suchen → "Teilen" → Link kopieren</p>
                    </div>
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--sand);">
                
                <h4 style="margin-bottom: 12px; color: var(--dark);">Abrechnung</h4>
                <div class="form-group">
                    <label class="form-label">Monatsbeitrag (€)</label>
                    <input type="number" class="form-input" id="customerFee" value="29.90" step="0.01" min="0">
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--sand);">
                
                <h4 style="margin-bottom: 12px; color: var(--dark);">SEPA-Lastschrift</h4>
                <div class="form-group">
                    <label class="form-label">Kontoinhaber</label>
                    <input type="text" class="form-input" id="customerAccountHolder" placeholder="Name wie auf dem Konto">
                </div>
                <div class="form-group">
                    <label class="form-label">IBAN</label>
                    <input type="text" class="form-input" id="customerIBAN" placeholder="DE89 3704 0044 0532 0130 00" oninput="formatIBAN(this)">
                </div>
                <div class="form-group">
                    <label class="form-label">BIC (optional)</label>
                    <input type="text" class="form-input" id="customerBIC" placeholder="COBADEFFXXX">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="customerSEPAMandat" style="margin-top: 4px; width: 18px; height: 18px;">
                        <span style="font-size: 13px; color: var(--slate); line-height: 1.4;">
                            Ich ermächtige Kiek mol in, Zahlungen von meinem Konto mittels Lastschrift einzuziehen. 
                            Zugleich weise ich mein Kreditinstitut an, die von Kiek mol in auf mein Konto gezogenen 
                            Lastschriften einzulösen.
                        </span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">Mandatsreferenz (wird automatisch generiert)</label>
                    <input type="text" class="form-input" id="customerMandateRef" readonly placeholder="Wird beim Speichern generiert" style="background: var(--cream);">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">Kunde anlegen</button>
            </form>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal-overlay" id="paymentModal">
    <div class="modal" style="max-width: 400px;">
        <div class="modal-header">
            <h2 class="modal-title">Zahlung erfassen</h2>
            <button class="modal-close" onclick="closeModal('paymentModal')">×</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 16px; color: var(--slate);">Zahlung für: <strong id="paymentCustomerName"></strong></p>
            <input type="hidden" id="paymentCustomerId">
            <div class="form-group">
                <label class="form-label">Betrag (€)</label>
                <input type="number" class="form-input" id="paymentAmount" value="29.90" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label class="form-label">Zahlungsart</label>
                <select class="form-input" id="paymentMethod">
                    <option value="bank">Überweisung</option>
                    <option value="paypal">PayPal</option>
                    <option value="cash">Bar</option>
                </select>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="recordPayment()">Zahlung buchen</button>
        </div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal-overlay" id="addEventModal">
    <div class="modal" style="max-width: 550px;">
        <div class="modal-header">
            <h2 class="modal-title">Neues Event</h2>
            <button class="modal-close" onclick="closeModal('addEventModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <form id="addEventForm" onsubmit="addEvent(event)">
                <div class="form-group">
                    <label class="form-label">Titel *</label>
                    <input type="text" class="form-input" id="eventTitle" required placeholder="z.B. Greetsieler Woche">
                </div>
                <div class="form-group">
                    <label class="form-label">Beschreibung</label>
                    <textarea class="form-textarea" id="eventDescription" placeholder="Was erwartet die Besucher?"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Datum *</label>
                        <input type="date" class="form-input" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Uhrzeit</label>
                        <input type="time" class="form-input" id="eventTime">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Ort</label>
                        <input type="text" class="form-input" id="eventCity" placeholder="z.B. Greetsiel">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kategorie</label>
                        <select class="form-input" id="eventCategory">
                            <option value="fest">Fest</option>
                            <option value="markt">Markt</option>
                            <option value="konzert">Konzert</option>
                            <option value="natur">Natur</option>
                            <option value="sonstiges">Sonstiges</option>
                        </select>
                    </div>
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Adresse & Kontakt</h4>
                
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></span>Straße</label>
                    <input type="text" class="form-input" id="eventStreet" placeholder="z.B. Hafenstraße 12">
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg></span>Google Maps Link</label>
                    <input type="url" class="form-input" id="eventGoogleMaps" placeholder="https://maps.google.com/...">
                    <p style="font-size: 11px; color: var(--slate); margin-top: 4px;">Google Maps → Ort suchen → Teilen → Link kopieren</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></span>Telefon</label>
                        <input type="tel" class="form-input" id="eventPhone" placeholder="+49 ...">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></span>WhatsApp</label>
                        <input type="tel" class="form-input" id="eventWhatsapp" placeholder="+49 176 ...">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></span>Webseite</label>
                        <input type="url" class="form-input" id="eventWebsite" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></span>Instagram</label>
                        <input type="text" class="form-input" id="eventInstagram" placeholder="@eventname">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></span>Facebook</label>
                    <input type="url" class="form-input" id="eventFacebook" placeholder="https://facebook.com/...">
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></span>Preis-Info</label>
                        <input type="text" class="form-input" id="eventPrice" placeholder="z.B. Eintritt frei">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></span>Bild-URL</label>
                        <input type="url" class="form-input" id="eventImage" placeholder="https://...">
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="eventFeatured">
                        <span>Als Highlight markieren</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Event hinzufügen</button>
            </form>
        </div>
    </div>
</div>

<!-- Add Attraction Modal -->
<div class="modal-overlay" id="addAttractionModal">
    <div class="modal" style="max-width: 550px;">
        <div class="modal-header">
            <h2 class="modal-title">Neues Ausflugsziel</h2>
            <button class="modal-close" onclick="closeModal('addAttractionModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <form id="addAttractionForm" onsubmit="addAttraction(event)">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="attractionName" required placeholder="z.B. Pilsumer Leuchtturm">
                </div>
                <div class="form-group">
                    <label class="form-label">Beschreibung</label>
                    <textarea class="form-textarea" id="attractionDescription" placeholder="Was macht diesen Ort besonders?"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Ort</label>
                        <input type="text" class="form-input" id="attractionCity" placeholder="z.B. Pilsum">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kategorie</label>
                        <select class="form-input" id="attractionCategory">
                            <option value="natur">Natur</option>
                            <option value="museum">Museum</option>
                            <option value="historisch">Historisch</option>
                            <option value="familie">Familie</option>
                            <option value="sonstiges">Sonstiges</option>
                        </select>
                    </div>
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                <h4 style="margin-bottom: 12px; color: var(--dark);">Adresse & Kontakt</h4>
                
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></span>Straße</label>
                    <input type="text" class="form-input" id="attractionStreet" placeholder="z.B. Leuchtturmweg 1">
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg></span>Google Maps Link</label>
                    <input type="url" class="form-input" id="attractionGoogleMaps" placeholder="https://maps.google.com/...">
                    <p style="font-size: 11px; color: var(--slate); margin-top: 4px;">Google Maps → Ort suchen → Teilen → Link kopieren</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></span>Telefon</label>
                        <input type="tel" class="form-input" id="attractionPhone" placeholder="+49 ...">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></span>WhatsApp</label>
                        <input type="tel" class="form-input" id="attractionWhatsapp" placeholder="+49 176 ...">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></span>Webseite</label>
                        <input type="url" class="form-input" id="attractionWebsite" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></span>Instagram</label>
                        <input type="text" class="form-input" id="attractionInstagram" placeholder="@name">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></span>Facebook</label>
                    <input type="url" class="form-input" id="attractionFacebook" placeholder="https://facebook.com/...">
                </div>
                
                <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--sand);">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></span>Preis-Info</label>
                        <input type="text" class="form-input" id="attractionPrice" placeholder="z.B. Eintritt frei">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg></span>Bewertung</label>
                        <input type="number" class="form-input" id="attractionRating" value="4.5" min="1" max="5" step="0.1">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></span>Bild-URL</label>
                    <input type="url" class="form-input" id="attractionImage" placeholder="https://...">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Ausflugsziel hinzufügen</button>
            </form>
        </div>
    </div>
</div>

<!-- Accommodation Inquiry Modal -->
<div class="modal-overlay" id="accommodationInquiryModal">
    <div class="modal" style="max-width: 450px;">
        <div class="modal-header">
            <h2 class="modal-title">Unterkunft anfragen</h2>
            <button class="modal-close" onclick="closeModal('accommodationInquiryModal')">×</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 16px; color: var(--slate);"><strong id="inquiryAccommodationName"></strong></p>
            <input type="hidden" id="inquiryAccommodationId">
            
            <form id="accommodationInquiryForm" onsubmit="submitAccommodationInquiry(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Check-in *</label>
                        <input type="date" class="form-input" id="inquiryCheckIn" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Check-out *</label>
                        <input type="date" class="form-input" id="inquiryCheckOut" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Anzahl Gäste</label>
                    <select class="form-input" id="inquiryGuests">
                        <option value="1">1 Person</option>
                        <option value="2" selected>2 Personen</option>
                        <option value="3">3 Personen</option>
                        <option value="4">4 Personen</option>
                        <option value="5">5 Personen</option>
                        <option value="6">6+ Personen</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ihr Name *</label>
                    <input type="text" class="form-input" id="inquiryName" required placeholder="Max Mustermann">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label"><span class="label-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></span>Email</label>
                        <input type="email" class="form-input" id="inquiryEmail" placeholder="ihre@email.de">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefon *</label>
                        <input type="tel" class="form-input" id="inquiryPhone" required placeholder="+49 ...">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Nachricht (optional)</label>
                    <textarea class="form-input" id="inquiryMessage" rows="2" placeholder="Besondere Wünsche..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Anfrage senden</button>
            </form>
            
            <div id="accommodationBookingLink" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--sand); text-align: center; display: none;">
                <p style="font-size: 13px; color: var(--slate); margin-bottom: 8px;">Oder direkt buchen:</p>
                <a id="bookingLinkBtn" href="#" target="_blank" class="btn btn-secondary" style="width: 100%;">
                    Zur Buchungsseite
                </a>
            </div>
        </div>
    </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ==================== SOFORTIGE THEME-INITIALISIERUNG ====================
(function() {
    const savedTheme = localStorage.getItem('kmi_theme') || 'auto';
    let actualTheme = savedTheme;
    
    if (savedTheme === 'auto') {
        // Safari-kompatible Erkennung
        try {
            const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            actualTheme = darkModeMediaQuery.matches ? 'dark' : 'light';
            
            // Safari braucht manchmal einen Listener
            darkModeMediaQuery.addListener(function(e) {
                if (localStorage.getItem('kmi_theme') === 'auto') {
                    if (e.matches) {
                        document.documentElement.classList.add('dark-mode');
                        document.body.classList.add('dark-mode');
                    } else {
                        document.documentElement.classList.remove('dark-mode');
                        document.body.classList.remove('dark-mode');
                    }
                }
            });
        } catch(e) {
            actualTheme = 'light';
        }
    }
    
    if (actualTheme === 'dark') {
        document.documentElement.classList.add('dark-mode');
    }
})();

// ==================== MEHRSPRACHIGKEIT ====================
let currentLanguage = localStorage.getItem('kmi_language') || 'de';

const translations = {
    de: {
        // Header & Tagline
        tagline: 'Ostfriesland genießen',
        change: 'Ändern ›',
        
        // Restaurants
        restaurants: 'Restaurants',
        all: 'Alle',
        openNow: 'Jetzt geöffnet',
        closed: 'Geschlossen',
        freeTables: 'Freie Tische',
        topRated: 'Top bewertet',
        available: 'Sofort verfügbar',
        waitlist: 'Warteliste',
        tablesLeft: 'Noch',
        tables: 'Tische',
        table: 'Tisch',
        reserve: 'Reservieren',
        reserveNow: 'Jetzt reservieren',
        noRestaurants: 'Keine Restaurants gefunden',
        searchPlaceholder: 'Restaurant suchen...',
        
        // Navigation
        navFood: 'Essen',
        navSleep: 'Schlafen',
        navEvents: 'Events',
        navDiscover: 'Entdecken',
        navJobs: 'Jobs',
        home: 'Start',
        map: 'Karte',
        search: 'Suchen',
        favorites: 'Favoriten',
        profile: 'Profil',
        settings: 'Einstellungen',
        
        // Location
        chooseLocation: 'Ort wählen',
        whereToGo: 'Wo möchtest du hin?',
        locationNotFound: 'Dein Ort nicht dabei?',
        allLocations: 'Alle Orte',
        searchLocation: 'Ort suchen...',
        addLocation: 'Ort hinzufügen',
        
        // Taglines
        accommodationsTagline: 'Unterkünfte in Ostfriesland',
        eventsTagline: 'Events in Ostfriesland',
        jobsTagline: 'Jobs in Ostfriesland',
        attractionsTagline: 'Ausflugsziele in Ostfriesland',
        
        // Jobs
        jobsOpen: 'Offene Stellen',
        jobsUrgent: 'Dringend',
        currentJobs: 'Aktuelle Stellenangebote',
        loadingJobs: 'Jobs werden geladen...',
        noJobs: 'Keine Stellenangebote verfügbar',
        fulltime: 'Vollzeit',
        parttime: 'Teilzeit',
        minijob: 'Minijob',
        apply: 'Bewerben',
        urgent: 'Dringend',
        
        // Reservierung
        name: 'Name',
        phone: 'Telefon',
        email: 'E-Mail',
        date: 'Datum',
        time: 'Uhrzeit',
        guests: 'Personen',
        person: 'Person',
        persons: 'Personen',
        notes: 'Anmerkungen',
        notesPlaceholder: 'z.B. Kinderstuhl benötigt',
        send: 'Absenden',
        cancel: 'Abbrechen',
        confirm: 'Bestätigen',
        reservationSuccess: 'Reservierung erfolgreich!',
        reservationError: 'Fehler bei der Reservierung',
        
        // Restaurant Details
        cuisine: 'Küche',
        address: 'Adresse',
        openingHours: 'Öffnungszeiten',
        rating: 'Bewertung',
        reviews: 'Bewertungen',
        menu: 'Speisekarte',
        call: 'Anrufen',
        directions: 'Route',
        website: 'Webseite',
        share: 'Teilen',
        
        // Wetter
        weather: 'Wetter',
        sunny: 'Sonnig',
        cloudy: 'Bewölkt',
        rainy: 'Regnerisch',
        stormy: 'Gewitter',
        wind: 'Wind',
        temperature: 'Temperatur',
        
        // Zeit
        today: 'Heute',
        tomorrow: 'Morgen',
        yesterday: 'Gestern',
        now: 'Jetzt',
        daysAgo: 'Tagen',
        monday: 'Montag',
        tuesday: 'Dienstag',
        wednesday: 'Mittwoch',
        thursday: 'Donnerstag',
        friday: 'Freitag',
        saturday: 'Samstag',
        sunday: 'Sonntag',
        restDay: 'Ruhetag',
        
        // Allgemein
        more: 'Mehr',
        less: 'Weniger',
        none: 'Keine',
        loading: 'Laden...',
        error: 'Fehler',
        success: 'Erfolg',
        noResults: 'Keine Ergebnisse',
        tryAgain: 'Erneut versuchen',
        back: 'Zurück',
        close: 'Schließen',
        save: 'Speichern',
        delete: 'Löschen',
        edit: 'Bearbeiten',
        
        // Footer & Legal
        footerText: '© 2025 Kiek mol in – Ostfriesland genießen',
        impressum: 'Impressum',
        privacy: 'Datenschutz',
        contact: 'Kontakt',
        agb: 'AGB',
        
        // Angebote
        todaysOffers: 'Angebote heute',
        discount: 'Rabatt',
        validUntil: 'Gültig bis',
        specialOffer: 'Tagesangebot',
        
        // Unterkünfte
        accommodations: 'Unterkünfte',
        hotel: 'Hotel',
        apartment: 'Ferienwohnung',
        pension: 'Pension',
        pricePerNight: 'pro Nacht',
        checkIn: 'Anreise',
        checkOut: 'Abreise',
        availability: 'Verfügbarkeit',
        bookNow: 'Jetzt buchen',
        inquire: 'Anfragen',
        
        // Events
        events: 'Events',
        upcomingEvents: 'Kommende Events',
        noEvents: 'Keine Events',
        eventDate: 'Datum',
        eventTime: 'Uhrzeit',
        eventLocation: 'Ort',
        
        // Attraktionen
        attractions: 'Ausflugsziele',
        sights: 'Sehenswürdigkeiten',
        nature: 'Natur',
        culture: 'Kultur',
        family: 'Familie',
        
        // Suche
        searchResults: 'Suchergebnisse',
        filterBy: 'Filtern nach',
        sortBy: 'Sortieren nach',
        distance: 'Entfernung',
        popularity: 'Beliebtheit',
        
        // Bewertungen
        excellent: 'Ausgezeichnet',
        veryGood: 'Sehr gut',
        good: 'Gut',
        average: 'Durchschnittlich',
        
        // Cookie
        cookieText: 'Wir nutzen Cookies für die Funktion der App.',
        cookieMore: 'Mehr erfahren',
        cookieAccept: 'Verstanden',
        
        // Favoriten
        addToFavorites: 'Zu Favoriten',
        removeFromFavorites: 'Aus Favoriten entfernen',
        noFavorites: 'Noch keine Favoriten',
        
        // Assistent
        assistantTitle: 'Dein Ostfriesland-Guide',
        assistantPlaceholder: 'Schreib eine Nachricht...',
        askMe: 'Frag mich etwas...',
        
        // Reservierung erweitert
        sendReservation: 'Reservierung anfragen',
        optional: 'optional',
        namePlaceholder: 'Max Mustermann',
        notesPlaceholder: 'Kinderstuhl benötigt, Allergien, etc.',
        '1person': '1 Person',
        '2persons': '2 Personen',
        '3persons': '3 Personen',
        '4persons': '4 Personen',
        '5persons': '5 Personen',
        '6persons': '6 Personen',
        '7persons': '7 Personen',
        '8persons': '8+ Personen',
        
        // Profil
        myProfile: 'Mein Profil',
        notLoggedIn: 'Noch nicht angemeldet',
        loginToSave: 'Melde dich an um deine Favoriten zu speichern und Reservierungen zu verwalten.',
        loginWithGoogle: 'Mit Google anmelden',
        orWithEmail: 'oder mit E-Mail',
        logout: 'Abmelden',
        
        // Statistiken
        reservationsToday: 'Reservierungen heute',
        tablesFree: 'Tische frei',
        
        // Suche
        searchRestaurant: 'Restaurant suchen...',
        
        // Profil & Login
        loginNow: 'Jetzt anmelden',
        login: 'Anmelden',
        useWithoutLogin: 'Du kannst die App auch ohne Anmeldung nutzen.',
        myFavorites: 'Meine Favoriten',
        savedLocally: 'Lokal gespeichert',
        design: 'Design',
        
        // Reviews & Community
        writeReview: 'Bewertung schreiben',
        reviewSuccess: 'Bewertung gespeichert! ⭐',
        reviewError: 'Fehler beim Speichern',
        noReviews: 'Noch keine Bewertungen',
        beFirst: 'Sei der Erste!',
        helpful: 'Hilfreich',
        liveActivity: 'Letzte Aktivität',
        visitorsToday: 'Besucher heute',
        reservedTable: 'hat einen Tisch reserviert',
        gaveStars: 'hat bewertet',
        uploadedPhoto: 'hat ein Foto hochgeladen',
        howWasExperience: 'Wie war dein Erlebnis?',
        yourName: 'Dein Name',
        titleOptional: 'Titel (optional)',
        yourReview: 'Deine Bewertung',
        addPhotos: 'Fotos hinzufügen',
        submitReview: 'Bewertung absenden',
        maxPhotos: 'Maximal 4 Fotos',
        pleaseRate: 'Bitte Sterne vergeben'
    },
    en: {
        // Header & Tagline
        tagline: 'Enjoy East Frisia',
        change: 'Change ›',
        
        // Restaurants
        restaurants: 'Restaurants',
        all: 'All',
        openNow: 'Open now',
        closed: 'Closed',
        freeTables: 'Free tables',
        topRated: 'Top rated',
        available: 'Available now',
        waitlist: 'Waitlist',
        tablesLeft: 'Only',
        tables: 'tables left',
        table: 'table',
        reserve: 'Reserve',
        reserveNow: 'Reserve now',
        noRestaurants: 'No restaurants found',
        searchPlaceholder: 'Search restaurants...',
        
        // Navigation
        navFood: 'Food',
        navSleep: 'Stay',
        navEvents: 'Events',
        navDiscover: 'Discover',
        navJobs: 'Jobs',
        home: 'Home',
        map: 'Map',
        search: 'Search',
        favorites: 'Favorites',
        profile: 'Profile',
        settings: 'Settings',
        
        // Location
        chooseLocation: 'Choose location',
        whereToGo: 'Where would you like to go?',
        locationNotFound: 'Location not listed?',
        allLocations: 'All locations',
        searchLocation: 'Search location...',
        addLocation: 'Add location',
        
        // Taglines
        accommodationsTagline: 'Accommodations in East Frisia',
        eventsTagline: 'Events in East Frisia',
        jobsTagline: 'Jobs in East Frisia',
        attractionsTagline: 'Attractions in East Frisia',
        
        // Jobs
        jobsOpen: 'Open positions',
        jobsUrgent: 'Urgent',
        currentJobs: 'Current job offers',
        loadingJobs: 'Loading jobs...',
        noJobs: 'No job offers available',
        fulltime: 'Full-time',
        parttime: 'Part-time',
        minijob: 'Mini job',
        apply: 'Apply',
        urgent: 'Urgent',
        
        // Reservation
        name: 'Name',
        phone: 'Phone',
        email: 'Email',
        date: 'Date',
        time: 'Time',
        guests: 'Guests',
        person: 'person',
        persons: 'persons',
        notes: 'Notes',
        notesPlaceholder: 'e.g. need high chair',
        send: 'Send',
        cancel: 'Cancel',
        confirm: 'Confirm',
        reservationSuccess: 'Reservation successful!',
        reservationError: 'Reservation failed',
        
        // Restaurant Details
        cuisine: 'Cuisine',
        address: 'Address',
        openingHours: 'Opening hours',
        rating: 'Rating',
        reviews: 'reviews',
        menu: 'Menu',
        call: 'Call',
        directions: 'Directions',
        website: 'Website',
        share: 'Share',
        
        // Weather
        weather: 'Weather',
        sunny: 'Sunny',
        cloudy: 'Cloudy',
        rainy: 'Rainy',
        stormy: 'Stormy',
        wind: 'Wind',
        temperature: 'Temperature',
        
        // Time
        today: 'Today',
        tomorrow: 'Tomorrow',
        yesterday: 'Yesterday',
        now: 'Now',
        daysAgo: 'days ago',
        monday: 'Monday',
        tuesday: 'Tuesday',
        wednesday: 'Wednesday',
        thursday: 'Thursday',
        friday: 'Friday',
        saturday: 'Saturday',
        sunday: 'Sunday',
        restDay: 'Closed',
        
        // General
        more: 'More',
        less: 'Less',
        none: 'None',
        loading: 'Loading...',
        error: 'Error',
        success: 'Success',
        noResults: 'No results',
        tryAgain: 'Try again',
        back: 'Back',
        close: 'Close',
        save: 'Save',
        delete: 'Delete',
        edit: 'Edit',
        
        // Footer & Legal
        footerText: '© 2025 Kiek mol in – Enjoy East Frisia',
        impressum: 'Legal Notice',
        privacy: 'Privacy Policy',
        contact: 'Contact',
        agb: 'Terms',
        
        // Offers
        todaysOffers: "Today's offers",
        discount: 'Discount',
        validUntil: 'Valid until',
        specialOffer: 'Special offer',
        
        // Accommodations
        accommodations: 'Accommodations',
        hotel: 'Hotel',
        apartment: 'Holiday apartment',
        pension: 'Guest house',
        pricePerNight: 'per night',
        checkIn: 'Check-in',
        checkOut: 'Check-out',
        availability: 'Availability',
        bookNow: 'Book now',
        inquire: 'Inquire',
        
        // Events
        events: 'Events',
        upcomingEvents: 'Upcoming events',
        noEvents: 'No events',
        eventDate: 'Date',
        eventTime: 'Time',
        eventLocation: 'Location',
        
        // Attractions
        attractions: 'Attractions',
        sights: 'Sights',
        nature: 'Nature',
        culture: 'Culture',
        family: 'Family',
        
        // Search
        searchResults: 'Search results',
        filterBy: 'Filter by',
        sortBy: 'Sort by',
        distance: 'Distance',
        popularity: 'Popularity',
        
        // Ratings
        excellent: 'Excellent',
        veryGood: 'Very good',
        good: 'Good',
        average: 'Average',
        
        // Cookie
        cookieText: 'We use cookies for app functionality.',
        cookieMore: 'Learn more',
        cookieAccept: 'Got it',
        
        // Favorites
        addToFavorites: 'Add to favorites',
        removeFromFavorites: 'Remove from favorites',
        noFavorites: 'No favorites yet',
        
        // Assistant
        assistantTitle: 'Your East Frisia Guide',
        assistantPlaceholder: 'Write a message...',
        askMe: 'Ask me something...',
        
        // Reservation extended
        sendReservation: 'Request reservation',
        optional: 'optional',
        namePlaceholder: 'John Doe',
        notesPlaceholder: 'High chair needed, allergies, etc.',
        '1person': '1 person',
        '2persons': '2 persons',
        '3persons': '3 persons',
        '4persons': '4 persons',
        '5persons': '5 persons',
        '6persons': '6 persons',
        '7persons': '7 persons',
        '8persons': '8+ persons',
        
        // Profile
        myProfile: 'My Profile',
        notLoggedIn: 'Not logged in',
        loginToSave: 'Log in to save your favorites and manage reservations.',
        loginWithGoogle: 'Login with Google',
        orWithEmail: 'or with email',
        logout: 'Logout',
        
        // Statistics
        reservationsToday: 'Reservations today',
        tablesFree: 'tables free',
        
        // Search
        searchRestaurant: 'Search restaurant...',
        
        // Profile & Login
        loginNow: 'Login now',
        login: 'Login',
        useWithoutLogin: 'You can use the app without logging in.',
        myFavorites: 'My Favorites',
        savedLocally: 'Saved locally',
        design: 'Design',
        
        // Reviews & Community
        writeReview: 'Write a review',
        reviewSuccess: 'Review saved! ⭐',
        reviewError: 'Error saving review',
        noReviews: 'No reviews yet',
        beFirst: 'Be the first!',
        helpful: 'Helpful',
        liveActivity: 'Recent activity',
        visitorsToday: 'Visitors today',
        reservedTable: 'reserved a table',
        gaveStars: 'gave a rating',
        uploadedPhoto: 'uploaded a photo',
        howWasExperience: 'How was your experience?',
        yourName: 'Your name',
        titleOptional: 'Title (optional)',
        yourReview: 'Your review',
        addPhotos: 'Add photos',
        submitReview: 'Submit review',
        maxPhotos: 'Maximum 4 photos',
        pleaseRate: 'Please give a rating'
    },
    nl: {
        // Header & Tagline
        tagline: 'Geniet van Oost-Friesland',
        change: 'Wijzigen ›',
        
        // Restaurants
        restaurants: 'Restaurants',
        all: 'Alles',
        openNow: 'Nu open',
        closed: 'Gesloten',
        freeTables: 'Vrije tafels',
        topRated: 'Best beoordeeld',
        available: 'Direct beschikbaar',
        waitlist: 'Wachtlijst',
        tablesLeft: 'Nog',
        tables: 'tafels vrij',
        table: 'tafel',
        reserve: 'Reserveren',
        reserveNow: 'Nu reserveren',
        noRestaurants: 'Geen restaurants gevonden',
        searchPlaceholder: 'Zoek restaurants...',
        
        // Navigation
        navFood: 'Eten',
        navSleep: 'Slapen',
        navEvents: 'Events',
        navDiscover: 'Ontdekken',
        navJobs: 'Vacatures',
        home: 'Home',
        map: 'Kaart',
        search: 'Zoeken',
        favorites: 'Favorieten',
        profile: 'Profiel',
        settings: 'Instellingen',
        
        // Location
        chooseLocation: 'Kies locatie',
        whereToGo: 'Waar wil je naartoe?',
        locationNotFound: 'Locatie niet gevonden?',
        allLocations: 'Alle locaties',
        searchLocation: 'Zoek locatie...',
        addLocation: 'Locatie toevoegen',
        
        // Taglines
        accommodationsTagline: 'Accommodaties in Oost-Friesland',
        eventsTagline: 'Evenementen in Oost-Friesland',
        jobsTagline: 'Vacatures in Oost-Friesland',
        attractionsTagline: 'Bezienswaardigheden in Oost-Friesland',
        
        // Jobs
        jobsOpen: 'Open vacatures',
        jobsUrgent: 'Dringend',
        currentJobs: 'Actuele vacatures',
        loadingJobs: 'Vacatures laden...',
        noJobs: 'Geen vacatures beschikbaar',
        fulltime: 'Voltijd',
        parttime: 'Deeltijd',
        minijob: 'Bijbaan',
        apply: 'Solliciteren',
        urgent: 'Dringend',
        
        // Reservering
        name: 'Naam',
        phone: 'Telefoon',
        email: 'E-mail',
        date: 'Datum',
        time: 'Tijd',
        guests: 'Gasten',
        person: 'persoon',
        persons: 'personen',
        notes: 'Opmerkingen',
        notesPlaceholder: 'bijv. kinderstoel nodig',
        send: 'Versturen',
        cancel: 'Annuleren',
        confirm: 'Bevestigen',
        reservationSuccess: 'Reservering gelukt!',
        reservationError: 'Reservering mislukt',
        
        // Restaurant Details
        cuisine: 'Keuken',
        address: 'Adres',
        openingHours: 'Openingstijden',
        rating: 'Beoordeling',
        reviews: 'beoordelingen',
        menu: 'Menukaart',
        call: 'Bellen',
        directions: 'Route',
        website: 'Website',
        share: 'Delen',
        
        // Weer
        weather: 'Weer',
        sunny: 'Zonnig',
        cloudy: 'Bewolkt',
        rainy: 'Regenachtig',
        stormy: 'Onweer',
        wind: 'Wind',
        temperature: 'Temperatuur',
        
        // Tijd
        today: 'Vandaag',
        tomorrow: 'Morgen',
        yesterday: 'Gisteren',
        now: 'Nu',
        daysAgo: 'dagen geleden',
        monday: 'Maandag',
        tuesday: 'Dinsdag',
        wednesday: 'Woensdag',
        thursday: 'Donderdag',
        friday: 'Vrijdag',
        saturday: 'Zaterdag',
        sunday: 'Zondag',
        restDay: 'Rustdag',
        
        // Algemeen
        more: 'Meer',
        less: 'Minder',
        none: 'Geen',
        loading: 'Laden...',
        error: 'Fout',
        success: 'Gelukt',
        noResults: 'Geen resultaten',
        tryAgain: 'Opnieuw proberen',
        back: 'Terug',
        close: 'Sluiten',
        save: 'Opslaan',
        delete: 'Verwijderen',
        edit: 'Bewerken',
        
        // Footer & Legal
        footerText: '© 2025 Kiek mol in – Geniet van Oost-Friesland',
        impressum: 'Impressum',
        privacy: 'Privacybeleid',
        contact: 'Contact',
        agb: 'Voorwaarden',
        
        // Aanbiedingen
        todaysOffers: 'Aanbiedingen vandaag',
        discount: 'Korting',
        validUntil: 'Geldig tot',
        specialOffer: 'Dagaanbieding',
        
        // Accommodaties
        accommodations: 'Accommodaties',
        hotel: 'Hotel',
        apartment: 'Vakantieappartement',
        pension: 'Pension',
        pricePerNight: 'per nacht',
        checkIn: 'Inchecken',
        checkOut: 'Uitchecken',
        availability: 'Beschikbaarheid',
        bookNow: 'Nu boeken',
        inquire: 'Aanvragen',
        
        // Events
        events: 'Evenementen',
        upcomingEvents: 'Komende evenementen',
        noEvents: 'Geen evenementen',
        eventDate: 'Datum',
        eventTime: 'Tijd',
        eventLocation: 'Locatie',
        
        // Attracties
        attractions: 'Bezienswaardigheden',
        sights: 'Bezienswaardigheden',
        nature: 'Natuur',
        culture: 'Cultuur',
        family: 'Familie',
        
        // Zoeken
        searchResults: 'Zoekresultaten',
        filterBy: 'Filteren op',
        sortBy: 'Sorteren op',
        distance: 'Afstand',
        popularity: 'Populariteit',
        
        // Beoordelingen
        excellent: 'Uitstekend',
        veryGood: 'Zeer goed',
        good: 'Goed',
        average: 'Gemiddeld',
        
        // Cookie
        cookieText: 'We gebruiken cookies voor de werking van de app.',
        cookieMore: 'Meer informatie',
        cookieAccept: 'Begrepen',
        
        // Favorieten
        addToFavorites: 'Aan favorieten toevoegen',
        removeFromFavorites: 'Uit favorieten verwijderen',
        noFavorites: 'Nog geen favorieten',
        
        // Assistent
        assistantTitle: 'Jouw Oost-Friesland Gids',
        assistantPlaceholder: 'Schrijf een bericht...',
        askMe: 'Vraag me iets...',
        
        // Reservering uitgebreid
        sendReservation: 'Reservering aanvragen',
        optional: 'optioneel',
        namePlaceholder: 'Jan Jansen',
        notesPlaceholder: 'Kinderstoel nodig, allergieën, etc.',
        '1person': '1 persoon',
        '2persons': '2 personen',
        '3persons': '3 personen',
        '4persons': '4 personen',
        '5persons': '5 personen',
        '6persons': '6 personen',
        '7persons': '7 personen',
        '8persons': '8+ personen',
        
        // Profiel
        myProfile: 'Mijn Profiel',
        notLoggedIn: 'Niet ingelogd',
        loginToSave: 'Log in om je favorieten op te slaan en reserveringen te beheren.',
        loginWithGoogle: 'Inloggen met Google',
        orWithEmail: 'of met e-mail',
        logout: 'Uitloggen',
        
        // Statistieken
        reservationsToday: 'Reserveringen vandaag',
        tablesFree: 'tafels vrij',
        
        // Zoeken
        searchRestaurant: 'Zoek restaurant...',
        
        // Profiel & Login
        loginNow: 'Nu inloggen',
        login: 'Inloggen',
        useWithoutLogin: 'Je kunt de app ook zonder inloggen gebruiken.',
        myFavorites: 'Mijn Favorieten',
        savedLocally: 'Lokaal opgeslagen',
        design: 'Design',
        
        // Reviews & Community
        writeReview: 'Schrijf een beoordeling',
        reviewSuccess: 'Beoordeling opgeslagen! ⭐',
        reviewError: 'Fout bij opslaan',
        noReviews: 'Nog geen beoordelingen',
        beFirst: 'Wees de eerste!',
        helpful: 'Nuttig',
        liveActivity: 'Recente activiteit',
        visitorsToday: 'Bezoekers vandaag',
        reservedTable: 'heeft gereserveerd',
        gaveStars: 'heeft beoordeeld',
        uploadedPhoto: 'heeft een foto geüpload',
        howWasExperience: 'Hoe was je ervaring?',
        yourName: 'Je naam',
        titleOptional: 'Titel (optioneel)',
        yourReview: 'Je beoordeling',
        addPhotos: "Foto's toevoegen",
        submitReview: 'Beoordeling versturen',
        maxPhotos: "Maximaal 4 foto's",
        pleaseRate: 'Geef een beoordeling'
    }
};

function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('kmi_language', lang);
    
    const t = translations[lang] || translations.de;
    
    // Buttons aktualisieren
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const activeBtn = document.getElementById('lang' + lang.toUpperCase());
    if (activeBtn) activeBtn.classList.add('active');
    
    // Texte aktualisieren
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
            el.textContent = t[key];
        }
    });
    
    // Placeholders aktualisieren
    document.querySelectorAll('[data-placeholder-i18n]').forEach(el => {
        const key = el.getAttribute('data-placeholder-i18n');
        if (t[key]) {
            el.placeholder = t[key];
        }
    });
    
    // Select Optionen (Personen) aktualisieren
    const partySizeSelect = document.getElementById('partySize');
    if (partySizeSelect) {
        const personWord = lang === 'en' ? 'person' : (lang === 'nl' ? 'persoon' : 'Person');
        const personsWord = lang === 'en' ? 'persons' : (lang === 'nl' ? 'personen' : 'Personen');
        partySizeSelect.innerHTML = `
            <option value="1">1 ${personWord}</option>
            <option value="2" selected>2 ${personsWord}</option>
            <option value="3">3 ${personsWord}</option>
            <option value="4">4 ${personsWord}</option>
            <option value="5">5 ${personsWord}</option>
            <option value="6">6 ${personsWord}</option>
            <option value="7">7 ${personsWord}</option>
            <option value="8">8+ ${personsWord}</option>
        `;
    }
    
    // Suchfeld Placeholder
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.placeholder = t.searchRestaurant || t.searchPlaceholder || 'Suchen...';
    }
    
    // Live Stats Text
    const liveLabel = document.querySelector('.live-label');
    if (liveLabel) {
        const resCount = document.getElementById('liveReservations')?.textContent || '0';
        const tablesCount = document.getElementById('liveFreeTables')?.textContent || '0';
        const resText = lang === 'en' ? 'reservations today' : (lang === 'nl' ? 'reserveringen vandaag' : 'Reservierungen heute');
        const tablesText = lang === 'en' ? 'tables free' : (lang === 'nl' ? 'tafels vrij' : 'Tische frei');
        liveLabel.innerHTML = `<span id="liveReservations">${resCount}</span> ${resText} • <span id="liveFreeTables">${tablesCount}</span> ${tablesText}`;
    }
    
    // Restaurants neu rendern
    renderRestaurants(currentRestaurantFilter);
    
    console.log('[OK] Sprache geändert:', lang);
}

function initLanguage() {
    const savedLang = localStorage.getItem('kmi_language') || 'de';
    setLanguage(savedLang);
}

// ==================== ÖFFNUNGSZEITEN ====================
function checkIfOpen(restaurant) {
    if (!restaurant.opening_hours) return true; // Default: offen
    
    const now = new Date();
    const currentDay = now.getDay(); // 0 = Sonntag, 1 = Montag, ...
    const currentTime = now.getHours() * 60 + now.getMinutes(); // Minuten seit Mitternacht
    
    // Ruhetag prüfen
    if (restaurant.rest_day !== null && restaurant.rest_day !== undefined) {
        const restDayMap = { 0: 1, 1: 2, 2: 3, 3: 4, 4: 5, 5: 6, 6: 0 }; // Konvertierung
        if (currentDay === restDayMap[restaurant.rest_day]) return false;
    }
    
    // Öffnungszeiten parsen
    const hours = restaurant.opening_hours;
    if (typeof hours === 'object') {
        const dayNames = ['so', 'mo', 'di', 'mi', 'do', 'fr', 'sa'];
        const dayKey = dayNames[currentDay];
        
        if (hours[dayKey + '_start'] && hours[dayKey + '_end']) {
            const openTime = parseTime(hours[dayKey + '_start']);
            const closeTime = parseTime(hours[dayKey + '_end']);
            return currentTime >= openTime && currentTime <= closeTime;
        }
    }
    
    // Standard-Öffnungszeiten (11:00 - 22:00)
    return currentTime >= 660 && currentTime <= 1320;
}

function parseTime(timeStr) {
    if (!timeStr) return 0;
    const [hours, minutes] = timeStr.split(':').map(Number);
    return hours * 60 + (minutes || 0);
}

// Google-Style Wochentage HTML generieren
function getWeekdayHoursHTML(restaurant) {
    const days = [
        {key: 'mo', name: 'Montag'},
        {key: 'di', name: 'Dienstag'},
        {key: 'mi', name: 'Mittwoch'},
        {key: 'do', name: 'Donnerstag'},
        {key: 'fr', name: 'Freitag'},
        {key: 'sa', name: 'Samstag'},
        {key: 'so', name: 'Sonntag'}
    ];
    
    const now = new Date();
    const currentDayIndex = now.getDay(); // 0=So, 1=Mo...
    const todayKey = ['so','mo','di','mi','do','fr','sa'][currentDayIndex];
    
    // Standard Öffnungszeiten aus Restaurant oder Default
    const openTime = restaurant?.opening_time || '11:00';
    const closeTime = restaurant?.closing_time || '22:00';
    const restDay = restaurant?.rest_day; // 0=Mo, 1=Di, 2=Mi, 3=Do, 4=Fr, 5=Sa, 6=So
    const restDayKeys = ['mo', 'di', 'mi', 'do', 'fr', 'sa', 'so'];
    
    let html = '';
    days.forEach(function(d, index) {
        const isToday = d.key === todayKey;
        let timeText = openTime + ' – ' + closeTime;
        let isClosed = false;
        
        // Ruhetag prüfen
        if (restDay !== null && restDay !== undefined && restDayKeys[restDay] === d.key) {
            timeText = 'Ruhetag';
            isClosed = true;
        }
        
        html += '<div class="hours-row' + (isToday ? ' today' : '') + '">';
        html += '<span class="hours-day">' + d.name + '</span>';
        html += '<span class="hours-time' + (isClosed ? ' closed-day' : '') + '">' + timeText + '</span>';
        html += '</div>';
    });
    
    return html;
}

// ==================== RESTAURANT FILTER ====================
let currentRestaurantFilter = 'all';

function filterRestaurants(filter) {
    currentRestaurantFilter = filter;
    
    // Buttons aktualisieren
    document.querySelectorAll('.filter-chip').forEach(btn => {
        btn.classList.remove('active');
    });
    const activeBtn = document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1));
    if (activeBtn) activeBtn.classList.add('active');
    
    // Restaurants neu rendern
    renderRestaurants(filter);
}

// ==================== SUPABASE CONFIG ====================
// HINWEIS: Keys werden für Realtime benötigt, aber API-Calls gehen über Netlify Functions
const SUPABASE_URL = 'https://mvrgmbdokdzmumdyezha.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12cmdtYmRva2R6bXVtZHllemhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjEyOTgsImV4cCI6MjA4MTEzNzI5OH0.7Ciwa2UKUHwtorvq3p6sN69XmVvPg0Kvg5lgrovxpDw';

// Sicherer API Wrapper - nutzt Netlify Function wenn verfügbar
const USE_SECURE_API = window.location.hostname !== 'localhost';

async function secureApiCall(action, table, options = {}) {
    const { data, filters, id } = options;
    
    // Auf localhost direkt zu Supabase (für Entwicklung)
    if (!USE_SECURE_API) {
        return directSupabaseCall(action, table, options);
    }
    
    // Über Netlify Function (Produktion)
    try {
        const response = await fetch('/.netlify/functions/api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, table, data, filters, id })
        });
        
        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('Secure API Error:', error);
        // Fallback zu direktem Call
        return directSupabaseCall(action, table, options);
    }
}

async function directSupabaseCall(action, table, options = {}) {
    const { data, filters, id } = options;
    let url = `${SUPABASE_URL}/rest/v1/${table}`;
    let method = 'GET';
    let body = null;
    
    switch (action) {
        case 'select':
            if (filters) url += `?${filters}`;
            method = 'GET';
            break;
        case 'insert':
            method = 'POST';
            body = JSON.stringify(data);
            break;
        case 'update':
            if (id) url += `?id=eq.${id}`;
            else if (filters) url += `?${filters}`;
            method = 'PATCH';
            body = JSON.stringify(data);
            break;
        case 'delete':
            if (id) url += `?id=eq.${id}`;
            else if (filters) url += `?${filters}`;
            method = 'DELETE';
            break;
    }
    
    const response = await fetch(url, {
        method,
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': action === 'insert' ? 'return=representation' : undefined
        },
        body
    });
    
    return await response.json().catch(() => ({}));
}

let useSupabase = false;
let currentAdmin = null;

// Session ID für Presence Tracking
const SESSION_ID = localStorage.getItem('kmi_session_id') || (() => {
    const id = 'sess_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('kmi_session_id', id);
    return id;
})();

// ==================== REALTIME SUBSCRIPTIONS ====================
let realtimeSubscriptions = [];

async function initRealtime() {
    if (!window.supabaseClient) return;
    
    try {
        // Reviews Echtzeit
        const reviewChannel = window.supabaseClient
            .channel('reviews-changes')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'reviews' },
                (payload) => {
                    console.log('🔴 Neue Review:', payload);
                    handleRealtimeReview(payload);
                }
            )
            .subscribe();
        realtimeSubscriptions.push(reviewChannel);
        
        // Activity Echtzeit
        const activityChannel = window.supabaseClient
            .channel('activity-changes')
            .on('postgres_changes',
                { event: 'INSERT', schema: 'public', table: 'activity_log' },
                (payload) => {
                    console.log('🔴 Neue Aktivität:', payload);
                    handleRealtimeActivity(payload);
                }
            )
            .subscribe();
        realtimeSubscriptions.push(activityChannel);
        
        console.log('[OK] Realtime aktiviert');
    } catch (e) {
        console.log('Realtime nicht verfügbar:', e);
    }
}

function handleRealtimeReview(payload) {
    if (payload.eventType === 'INSERT') {
        const review = payload.new;
        // Toast anzeigen
        showToast(`⭐ Neue ${review.rating}-Sterne Bewertung!`, 'success');
        // Reviews neu laden wenn Modal offen
        if (document.getElementById('reviewsModal')?.classList.contains('active')) {
            loadReviews(review.target_type, review.target_id);
        }
    }
}

function handleRealtimeActivity(payload) {
    const activity = payload.new;
    // Live-Feed aktualisieren
    updateLiveActivityFeed(activity);
}

// ==================== REVIEWS SYSTEM ====================
async function loadReviews(targetType, targetId) {
    try {
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/reviews?target_type=eq.${targetType}&target_id=eq.${targetId}&is_approved=eq.true&order=created_at.desc&limit=20`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY
                }
            }
        );
        
        if (!response.ok) return [];
        return await response.json();
    } catch (e) {
        console.error('Reviews laden fehlgeschlagen:', e);
        return [];
    }
}

async function loadReviewPhotos(reviewId) {
    try {
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/review_photos?review_id=eq.${reviewId}`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY
                }
            }
        );
        
        if (!response.ok) return [];
        return await response.json();
    } catch (e) {
        console.error('Review Fotos laden fehlgeschlagen:', e);
        return [];
    }
}

async function submitReview(targetType, targetId, targetName, rating, title, comment, photos = []) {
    const t = translations[currentLanguage] || translations.de;
    
    // User Name
    const userName = APP_DATA.currentUser?.name || localStorage.getItem('kmi_guest_name') || 'Gast';
    
    try {
        // Review erstellen
        const response = await fetch(`${SUPABASE_URL}/rest/v1/reviews`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify({
                target_type: targetType,
                target_id: targetId,
                user_id: APP_DATA.currentUser?.id || null,
                user_name: userName,
                user_avatar: APP_DATA.currentUser?.avatar || null,
                rating: rating,
                title: title,
                comment: comment
            })
        });
        
        if (!response.ok) throw new Error('Review speichern fehlgeschlagen');
        
        const review = (await response.json())[0];
        
        // Fotos hochladen
        if (photos.length > 0) {
            for (const photo of photos) {
                await fetch(`${SUPABASE_URL}/rest/v1/review_photos`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        review_id: review.id,
                        image_url: photo
                    })
                });
            }
        }
        
        // Activity loggen
        await logActivity('review', targetType, targetId, targetName, `hat ${rating} Sterne gegeben`, { rating, title });
        
        showToast(t.reviewSuccess || 'Bewertung gespeichert! ⭐', 'success');
        return review;
        
    } catch (e) {
        console.error('Review Fehler:', e);
        showToast(t.reviewError || 'Fehler beim Speichern', 'error');
        return null;
    }
}

// ==================== ACTIVITY LOG ====================
async function logActivity(activityType, targetType, targetId, targetName, message, metadata = {}) {
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/activity_log`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                activity_type: activityType,
                target_type: targetType,
                target_id: targetId,
                target_name: targetName,
                user_id: APP_DATA.currentUser?.id || null,
                user_name: APP_DATA.currentUser?.name || localStorage.getItem('kmi_guest_name') || 'Jemand',
                message: message,
                metadata: metadata
            })
        });
    } catch (e) {
        console.log('Activity log fehlgeschlagen:', e);
    }
}

async function loadRecentActivity(targetType, targetId, limit = 5) {
    try {
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/activity_log?target_type=eq.${targetType}&target_id=eq.${targetId}&order=created_at.desc&limit=${limit}`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY
                }
            }
        );
        
        if (!response.ok) return [];
        return await response.json();
    } catch (e) {
        console.error('Activity laden fehlgeschlagen:', e);
        return [];
    }
}

// ==================== PRESENCE TRACKING ====================
async function updatePresence(targetType, targetId) {
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/presence`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'resolution=merge-duplicates'
            },
            body: JSON.stringify({
                target_type: targetType,
                target_id: targetId,
                session_id: SESSION_ID,
                user_id: APP_DATA.currentUser?.id || null,
                last_seen: new Date().toISOString()
            })
        });
    } catch (e) {
        console.log('Presence update fehlgeschlagen:', e);
    }
}

async function getPresenceCount(targetType, targetId) {
    try {
        // Nur Sessions der letzten 5 Minuten
        const fiveMinAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
        
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/presence?target_type=eq.${targetType}&target_id=eq.${targetId}&last_seen=gte.${fiveMinAgo}&select=count`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Prefer': 'count=exact'
                }
            }
        );
        
        const count = response.headers.get('content-range')?.split('/')[1] || 0;
        return parseInt(count);
    } catch (e) {
        return 0;
    }
}

// ==================== STATS ====================
async function getTargetStats(targetType, targetId) {
    try {
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/target_stats?target_type=eq.${targetType}&target_id=eq.${targetId}`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY
                }
            }
        );
        
        if (!response.ok) return null;
        const data = await response.json();
        return data[0] || null;
    } catch (e) {
        return null;
    }
}

async function getTodayVisitors(targetType, targetId) {
    try {
        const today = new Date().toISOString().split('T')[0];
        
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/activity_log?target_type=eq.${targetType}&target_id=eq.${targetId}&created_at=gte.${today}&select=count`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Prefer': 'count=exact'
                }
            }
        );
        
        const count = response.headers.get('content-range')?.split('/')[1] || 0;
        return parseInt(count);
    } catch (e) {
        return 0;
    }
}

// Live Activity Feed Update
function updateLiveActivityFeed(activity) {
    const feedContainer = document.getElementById('liveActivityFeed');
    if (!feedContainer) return;
    
    const timeAgo = getTimeAgo(new Date(activity.created_at));
    const icon = activity.activity_type === 'reservation' ? '🍴' : 
                 activity.activity_type === 'review' ? '⭐' : 
                 activity.activity_type === 'photo' ? '📸' : '👀';
    
    const item = document.createElement('div');
    item.className = 'activity-item activity-new';
    item.innerHTML = `
        <span class="activity-icon">${icon}</span>
        <span class="activity-text">${activity.user_name || 'Jemand'} ${activity.message}</span>
        <span class="activity-time">${timeAgo}</span>
    `;
    
    feedContainer.insertBefore(item, feedContainer.firstChild);
    
    // Animation
    setTimeout(() => item.classList.remove('activity-new'), 100);
    
    // Max 10 Items
    while (feedContainer.children.length > 10) {
        feedContainer.removeChild(feedContainer.lastChild);
    }
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    if (seconds < 60) return 'gerade eben';
    if (seconds < 3600) return `vor ${Math.floor(seconds / 60)} Min`;
    if (seconds < 86400) return `vor ${Math.floor(seconds / 3600)} Std`;
    return `vor ${Math.floor(seconds / 86400)} Tagen`;
}

// ==================== ADMIN AUTH ====================
// Passwort wird in Supabase gespeichert - nicht im Code!

function checkAdminSession() {
    return localStorage.getItem('kmi_admin_logged_in') === 'true';
}

async function simpleLogin() {
    const password = document.getElementById('adminPassword').value;
    const errorEl = document.getElementById('loginError');
    
    if (!password) {
        if (errorEl) {
            errorEl.textContent = 'Bitte Passwort eingeben';
            errorEl.style.display = 'block';
        }
        return;
    }
    
    try {
        // Passwort aus Supabase prüfen
        const response = await fetch(`${SUPABASE_URL}/rest/v1/settings?key=eq.admin_password`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        const data = await response.json();
        const storedPassword = data[0]?.value;
        
        if (password === storedPassword) {
            localStorage.setItem('kmi_admin_logged_in', 'true');
            currentAdmin = { name: 'Ibo', email: 'ibo@kiekmolin.de', role: 'Inhaber' };
            
            closeModal('adminLoginModal');
            document.getElementById('adminPassword').value = '';
            
            // Dashboard anzeigen
            document.getElementById('guestView').classList.add('hidden');
            document.getElementById('dashboardView').classList.add('active');
            document.querySelectorAll('.toggle-btn')[0].classList.remove('active');
            document.querySelectorAll('.toggle-btn')[1].classList.add('active');
            
            // Greeting aktualisieren
            const greeting = document.querySelector('.dash-greeting');
            if (greeting) greeting.textContent = 'Moin, Ibo! ';
            
            updateAdminProfile();
            updateDashboard();
            showToast('Willkommen zurück, Ibo!', 'success');
        } else {
            if (errorEl) {
                errorEl.textContent = 'Falsches Passwort';
                errorEl.style.display = 'block';
            }
            document.getElementById('adminPassword').value = '';
        }
    } catch (e) {
        console.error('Login Fehler:', e);
        if (errorEl) {
            errorEl.textContent = 'Verbindungsfehler';
            errorEl.style.display = 'block';
        }
    }
}

// Geheimer Admin-Zugang: 5x auf Logo tippen
let adminTapCount = 0;
let adminTapTimer = null;

function secretAdminTap() {
    adminTapCount++;
    
    if (adminTapTimer) clearTimeout(adminTapTimer);
    
    // Reset nach 3 Sekunden
    adminTapTimer = setTimeout(() => {
        adminTapCount = 0;
    }, 3000);
    
    // Nach 5 Taps: Admin Login öffnen
    if (adminTapCount >= 5) {
        adminTapCount = 0;
        openModal('adminLoginModal');
    }
}

function adminLogout() {
    currentAdmin = null;
    localStorage.removeItem('kmi_admin_logged_in');
    
    document.getElementById('guestView').classList.remove('hidden');
    document.getElementById('dashboardView').classList.remove('active');
    document.querySelectorAll('.toggle-btn')[0].classList.add('active');
    document.querySelectorAll('.toggle-btn')[1].classList.remove('active');
    
    showToast('Abgemeldet');
}

function updateAdminProfile() {
    const avatarEl = document.getElementById('adminAvatar');
    const nameEl = document.getElementById('adminName');
    const emailEl = document.getElementById('adminEmailDisplay');
    
    if (avatarEl) avatarEl.textContent = 'I';
    if (nameEl) nameEl.textContent = 'Ibo';
    if (emailEl) emailEl.textContent = 'Inhaber • Kiek mol in';
}

// REST API Helper
async function supabaseGet(table, query = '') {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, {
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + SUPABASE_KEY
        }
    });
    if (!response.ok) throw new Error('HTTP ' + response.status);
    return response.json();
}

async function supabasePost(table, data) {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
        method: 'POST',
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + SUPABASE_KEY,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
        },
        body: JSON.stringify(data)
    });
    if (!response.ok) throw new Error('HTTP ' + response.status);
    return true;
}

async function initSupabase() {
    const statusEl = document.getElementById('connectionStatus');
    console.log('Verbinde mit Supabase...');
    
    try {
        // Test connection und Daten laden
        const response = await fetch(`${SUPABASE_URL}/rest/v1/restaurants?select=*&is_active=eq.true`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (!response.ok) {
            throw new Error('HTTP ' + response.status);
        }
        
        const restaurants = await response.json();
        console.log('[OK] Supabase verbunden! Restaurants:', restaurants.length);
        
        useSupabase = true;
        
        if (statusEl) {
            statusEl.innerHTML = '2022 Mit Supabase verbunden';
            statusEl.style.color = 'var(--success)';
        }
        
        // Restaurants direkt verarbeiten
        if (restaurants && restaurants.length > 0) {
            APP_DATA.restaurants = restaurants.map(r => ({
                id: r.id,
                name: r.name,
                cuisine: r.cuisine_type?.[0] || 'deutsch',
                rating: r.rating || 4.5,
                reviewCount: r.review_count || 0,
                freeTables: 5,
                waitTime: 0,
                phone: r.phone || '',
                whatsapp: r.whatsapp || null,
                address: r.address || `${r.street || ''}, ${r.zip || ''} ${r.city || ''}`,
                street: r.street || '',
                city: r.city || '',
                zip: r.zip || '',
                googleMapsUrl: r.google_maps_url || '',
                instagram: r.instagram || '',
                tiktok: r.tiktok || '',
                lat: parseFloat(r.latitude) || 53.5021,
                lng: parseFloat(r.longitude) || 7.0965,
                image: r.image_url || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800',
                offer: null
            }));
            console.log('[OK] Restaurants geladen:', APP_DATA.restaurants.length);
        }
        
        // UI aktualisieren
        renderRestaurants();
        if (typeof updateMapMarkers === 'function') updateMapMarkers();
        
        // Orte aus den Daten laden
        setTimeout(() => {
            loadLocations();
            loadCustomLocations();
            updateLiveStats();
        }, 500);
        
        showToast(`${APP_DATA.restaurants.length} Restaurants geladen!`, 'success');
        
    } catch (e) {
        console.error('[!] Supabase Fehler:', e.message);
        useSupabase = false;
        
        if (statusEl) {
            statusEl.innerHTML = '○ Offline-Modus';
            statusEl.style.color = 'var(--warning)';
        }
    }
}

async function refreshData() {
    showToast('Daten werden aktualisiert...', '');
    
    if (useSupabase) {
        await loadFromSupabase();
        showToast('Daten aktualisiert!', 'success');
    } else {
        renderRestaurants();
        updateDashboard();
        showToast('Lokale Daten geladen', '');
    }
}

async function loadFromSupabase() {
    try {
        // Restaurants laden
        const restaurants = await supabaseGet('restaurants', 'select=*&is_active=eq.true');
        
        if (restaurants && restaurants.length > 0) {
            APP_DATA.restaurants = restaurants.map(r => ({
                id: r.id,
                name: r.name,
                cuisine: r.cuisine_type?.[0] || 'deutsch',
                rating: r.rating || 4.5,
                freeTables: 5,
                waitTime: 0,
                phone: r.phone || '',
                whatsapp: r.whatsapp || null,
                address: r.address || `${r.street || ''}, ${r.zip || ''} ${r.city || ''}`,
                street: r.street || '',
                city: r.city || '',
                zip: r.zip || '',
                googleMapsUrl: r.google_maps_url || '',
                instagram: r.instagram || '',
                tiktok: r.tiktok || '',
                lat: parseFloat(r.latitude) || 53.5021,
                lng: parseFloat(r.longitude) || 7.0965,
                image: r.image_url || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800',
                offer: null
            }));
        }
        
        // Tische laden
        const tables = await supabaseGet('tables', 'select=*');
        if (tables) {
            APP_DATA.restaurants.forEach(r => {
                const restaurantTables = tables.filter(t => t.restaurant_id === r.id);
                const free = restaurantTables.filter(t => t.status === 'free').length;
                if (free > 0) r.freeTables = free;
            });
        }
        
        // Reservierungen laden
        const reservations = await supabaseGet('reservations', `select=*&reservation_date=eq.${TODAY}`);
        if (reservations && reservations.length > 0) {
            APP_DATA.reservations = reservations.map(r => ({
                id: r.id,
                restaurantId: r.restaurant_id,
                restaurantName: APP_DATA.restaurants.find(rest => rest.id === r.restaurant_id)?.name || '',
                guestName: r.guest_name,
                guestPhone: r.guest_phone || '',
                date: r.reservation_date,
                time: r.reservation_time,
                partySize: r.party_size,
                notes: r.notes || '',
                status: r.status,
                source: r.source || 'app'
            }));
        }
        
        // Angebote laden
        const offers = await supabaseGet('offers', 'select=*&is_active=eq.true');
        if (offers && offers.length > 0) {
            APP_DATA.offers = offers.map(o => ({
                id: o.id,
                restaurantId: o.restaurant_id,
                title: o.title,
                discount: o.discount,
                validUntil: o.valid_until ? new Date(o.valid_until).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'}) : '20:00',
                description: o.description || ''
            }));
            
            // Offers zu Restaurants zuordnen
            APP_DATA.restaurants.forEach(r => {
                const offer = offers.find(o => o.restaurant_id === r.id);
                if (offer) {
                    r.offer = { title: offer.title, discount: offer.discount, price: '' };
                }
            });
        }
        
        // UI aktualisieren
        renderRestaurants();
        updateDashboard();
        if (typeof updateMapMarkers === 'function') updateMapMarkers();
        
        console.log('[OK] Daten geladen:', APP_DATA.restaurants.length, 'Restaurants');
        
    } catch (e) {
        console.error('Fehler beim Laden:', e);
    }
}

async function saveReservationToSupabase(reservation) {
    if (!useSupabase) return;
    
    try {
        await supabasePost('reservations', {
            restaurant_id: reservation.restaurantId,
            guest_name: reservation.guestName,
            guest_phone: reservation.guestPhone,
            party_size: parseInt(reservation.partySize),
            reservation_date: reservation.date,
            reservation_time: reservation.time,
            status: 'pending',
            source: 'app',
            notes: reservation.notes || ''
        });
        console.log('[OK] Reservierung gespeichert');
    } catch (e) {
        console.error('Speichern fehlgeschlagen:', e);
    }
}

async function saveOfferToSupabase(offer) {
    if (!useSupabase) return;
    
    try {
        const validUntil = new Date();
        const [hours, minutes] = offer.validUntil.split(':');
        validUntil.setHours(parseInt(hours), parseInt(minutes), 0);
        
        await supabasePost('offers', {
            restaurant_id: offer.restaurantId || APP_DATA.restaurants[0]?.id,
            title: offer.title,
            discount: offer.discount,
            description: offer.description || '',
            valid_until: validUntil.toISOString(),
            is_active: true
        });
        console.log('[OK] Angebot gespeichert');
    } catch (e) {
        console.error('Speichern fehlgeschlagen:', e);
    }
}

// ==================== DATA STORE ====================
// Get today's date in YYYY-MM-DD format
const TODAY = new Date().toISOString().split('T')[0];

// Keine Demo-Daten - alles aus Supabase
const DEFAULT_RESERVATIONS = [];
const DEFAULT_OFFERS = [];

// Initialize data
function getInitialData(key, defaultValue) {
    return defaultValue; // Immer leer starten, Daten kommen aus Supabase
}

const APP_DATA = {
    currentLocation: 'Greetsiel',
    currentFilter: 'all',
    favorites: getInitialData('kmi_favorites', []),
    reservations: getInitialData('kmi_reservations', []),
    offers: [],
    restaurantOpen: true,
    tables: [],
    restaurants: []
};

// ==================== UTILITY FUNCTIONS ====================
function saveData() {
    localStorage.setItem('kmi_favorites', JSON.stringify(APP_DATA.favorites));
    localStorage.setItem('kmi_reservations', JSON.stringify(APP_DATA.reservations));
    localStorage.setItem('kmi_offers', JSON.stringify(APP_DATA.offers));
    localStorage.setItem('kmi_tables', JSON.stringify(APP_DATA.tables));
    localStorage.setItem('kmi_restaurant_open', JSON.stringify(APP_DATA.restaurantOpen));
}

function showToast(message, type = 'default') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('active');
    } else {
        console.error('Modal nicht gefunden:', modalId);
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
    }
}

function formatDate(date) {
    const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
    return new Date(date).toLocaleDateString('de-DE', options);
}

// ==================== VIEW SWITCHING ====================
function showGuestView() {
    document.getElementById('guestView').classList.remove('hidden');
    document.getElementById('dashboardView').classList.remove('active');
    document.querySelectorAll('.toggle-btn')[0].classList.add('active');
    document.querySelectorAll('.toggle-btn')[1].classList.remove('active');
}

function showView(view) {
    if (view === 'guest') {
        showGuestView();
    } else if (view === 'dashboard') {
        showDashboard();
    }
}

function showDashboard() {
    // Check if logged in
    if (!currentAdmin && !checkAdminSession()) {
        // Show login modal
        openModal('adminLoginModal');
        return;
    }
    
    // Update greeting with name
    const greeting = document.querySelector('.dash-greeting');
    if (greeting && currentAdmin) {
        greeting.textContent = `Moin, ${currentAdmin.name}! `;
    }
    
    // Update sidebar profile
    updateAdminProfile();
    
    document.getElementById('guestView').classList.add('hidden');
    document.getElementById('dashboardView').classList.add('active');
    document.querySelectorAll('.toggle-btn')[0].classList.remove('active');
    document.querySelectorAll('.toggle-btn')[1].classList.add('active');
    updateDashboard();
}

// ==================== GUEST APP FUNCTIONS ====================
function renderRestaurants(filter = 'all') {
    const container = document.getElementById('restaurantList');
    if (!container) return;
    
    const t = translations[currentLanguage] || translations.de;
    
    const searchInput = document.getElementById('searchInput');
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    
    // Wenn keine Restaurants, zeige Ladehinweis
    if (!APP_DATA.restaurants || APP_DATA.restaurants.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                <div style="font-size: 32px; margin-bottom: 16px; color: var(--slate);">🍽️</div>
                <h3 style="color: var(--text-primary); margin-bottom: 8px;">${t.noRestaurants || 'Keine Restaurants gefunden'}</h3>
                <p>${t.loading || 'Laden...'}</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    let visibleCount = 0;
    let totalFreeTables = 0;
    let offersCount = 0;
    
    // Sortierung basierend auf Filter
    let restaurants = [...APP_DATA.restaurants];
    if (filter === 'rating') {
        restaurants.sort((a, b) => (b.rating || 0) - (a.rating || 0));
    }
    
    restaurants.forEach(r => {
        const matchesFilter = APP_DATA.currentFilter === 'all' || r.cuisine === APP_DATA.currentFilter;
        const matchesSearch = r.name.toLowerCase().includes(searchTerm);
        
        // Öffnungszeiten prüfen
        const isOpen = checkIfOpen(r);
        
        // Filter-Logik
        let passesFilter = true;
        if (filter === 'open' && !isOpen) passesFilter = false;
        if (filter === 'tables' && r.freeTables < 1) passesFilter = false;
        
        const isVisible = matchesFilter && matchesSearch && passesFilter;
        
        if (isVisible) {
            visibleCount++;
            totalFreeTables += r.freeTables;
            if (r.offer) offersCount++;
        }
        
        const isFavorite = APP_DATA.favorites.includes(r.id);
        
        let availabilityClass, availabilityText;
        if (r.freeTables === 0) {
            availabilityClass = 'full';
            availabilityText = t.waitlist || 'Warteliste';
        } else if (r.freeTables <= 2) {
            availabilityClass = 'limited';
            availabilityText = `${t.tablesLeft || 'Noch'} ${r.freeTables} ${r.freeTables === 1 ? (t.table || 'Tisch') : (t.tables || 'Tische')}`;
        } else {
            availabilityClass = 'available';
            availabilityText = t.available || 'Sofort verfügbar';
        }
        
        // Öffnungszeiten Badge
        const openBadge = isOpen 
            ? `<span class="open-badge open">${t.openNow || 'Jetzt geöffnet'}</span>`
            : `<span class="open-badge closed">${t.closed || 'Geschlossen'}</span>`;
        
        // Tische frei Text
        const tablesText = r.freeTables === 1 
            ? `1 ${t.table || 'Tisch'} ${currentLanguage === 'nl' ? 'vrij' : (currentLanguage === 'en' ? 'free' : 'frei')}`
            : `${r.freeTables} ${t.tables || 'Tische'} ${currentLanguage === 'nl' ? 'vrij' : (currentLanguage === 'en' ? 'free' : 'frei')}`;
        
        // Wartezeit Text
        const waitText = r.waitTime > 0 
            ? `~${r.waitTime} ${currentLanguage === 'en' ? 'min' : 'Min'}`
            : (t.available || 'Sofort verfügbar');
        
        // Heute Spezial Text
        const specialLabel = currentLanguage === 'en' ? 'Special today' : (currentLanguage === 'nl' ? 'Dagspecial' : 'Heute Spezial');
        const onlyText = currentLanguage === 'en' ? 'only' : (currentLanguage === 'nl' ? 'slechts' : 'nur');
        
        // WhatsApp Nachricht
        const whatsappMsg = currentLanguage === 'en' 
            ? 'Hello! I would like to reserve a table via Kiek mol in.'
            : (currentLanguage === 'nl' 
                ? 'Hallo! Ik wil graag een tafel reserveren via Kiek mol in.'
                : 'Hallo! Ich möchte gerne einen Tisch reservieren über Kiek mol in.');
        
        // Besucher heute (aus Cache oder 0)
        const visitorsToday = r.visitorsToday || Math.floor(Math.random() * 15) + 1; // Demo-Daten
        const isTrending = visitorsToday > 10;
        const visitorsText = currentLanguage === 'en' ? 'today' : (currentLanguage === 'nl' ? 'vandaag' : 'heute');
        
        // Beste Zeit berechnen
        const bestTimeInfo = getBestTime(r.id);
        const bestTimeText = bestTimeInfo ? `Beste Zeit: ${bestTimeInfo.bestHour}:00` : '';
        
        // Wartezeit berechnen
        const waitTimeInfo = getWaitTime(r.id);
        const dynamicWaitText = waitTimeInfo.waitTime > 0 
            ? `~${waitTimeInfo.waitTime} Min Wartezeit`
            : (t.available || 'Sofort verfügbar');
        
        html += `
            <div class="restaurant-card ${isVisible ? '' : 'hidden'}" data-id="${r.id}" data-cuisine="${r.cuisine}">
                <div class="card-image" style="background-image: url('${r.image}')">
                    ${r.offer ? `<div class="special-badge">${r.offer.discount}</div>` : ''}
                    <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite('${r.id}')">
                        <svg viewBox="0 0 24 24" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                    </button>
                </div>
                <div class="card-content">
                    <div class="card-top">
                        <h3 class="restaurant-name">${r.name}</h3>
                        <div class="rating">
                            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            ${r.rating}
                        </div>
                    </div>
                    <p class="card-cuisine">${r.cuisine} · ${r.city || 'Ostfriesland'}</p>
                    
                    <!-- Google Öffnungszeiten -->
                    <div class="hours-google">
                        <div class="hours-header" onclick="this.nextElementSibling.classList.toggle('expanded'); this.querySelector('.hours-arrow').classList.toggle('expanded')">
                            <div class="hours-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                            </div>
                            <div class="hours-status">
                                <span class="hours-main ${isOpen ? 'open' : 'closed'}">${isOpen ? 'Geöffnet' : 'Geschlossen'}</span><span class="hours-sub"> · ${isOpen ? 'Schließt um ' + (r.closing_time || '22:00') : 'Öffnet ' + (r.opening_time || '11:00')}</span>
                            </div>
                            <svg class="hours-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                        <div class="hours-dropdown">
                            <div class="hours-list">
                                ${getWeekdayHoursHTML(r)}
                            </div>
                        </div>
                    </div>
                    
                    ${r.offer ? `
                        <div class="today-special">
                            <div>
                                <strong>Heute:</strong> ${r.offer.title}
                            </div>
                            <button onclick="event.stopPropagation(); openARPreview('${r.offer.title.replace(/'/g, "\\'")}', '${r.image}')" class="ar-btn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                    <circle cx="12" cy="13" r="4"/>
                                </svg>
                                AR
                            </button>
                        </div>
                    ` : ''}
                    
                    <div class="card-actions">
                        <button class="card-btn card-btn-primary" onclick="openReservation('${r.id}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            Reservieren
                        </button>
                        <a href="https://wa.me/${(r.whatsapp || r.phone || '').replace(/[^0-9]/g, '')}?text=${encodeURIComponent('Hallo! Ich möchte gerne einen Tisch reservieren bei ' + r.name)}" target="_blank" class="card-btn card-btn-whatsapp">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                            </svg>
                            WhatsApp
                        </a>
                        ${r.phone ? `
                            <a href="tel:${r.phone}" class="card-btn card-btn-secondary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                </svg>
                                Anrufen
                            </a>
                        ` : ''}
                        <a href="${r.googleMapsUrl || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.name + ' ' + (r.city || 'Ostfriesland'))}`}" target="_blank" class="card-btn card-btn-secondary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="3 11 22 2 13 21 11 13 3 11"/>
                            </svg>
                            Route
                        </a>
                        <button class="card-btn card-btn-secondary" onclick="openReviewsModal('restaurant', '${r.id}', '${r.name.replace(/'/g, "\\'")}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                            Bewertungen
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Update stats (nur wenn Elemente existieren)
    const statRestaurants = document.getElementById('statRestaurants');
    const statTables = document.getElementById('statTables');
    const statOffers = document.getElementById('statOffers');
    
    if (statRestaurants) statRestaurants.textContent = visibleCount;
    if (statTables) statTables.textContent = totalFreeTables;
    if (statOffers) statOffers.textContent = offersCount + APP_DATA.offers.length;
    
    updateFavoritesBadge();
    
    // Karte aktualisieren
    if (typeof updateMapMarkers === 'function') {
        updateMapMarkers();
    }
}

function searchRestaurants() {
    renderRestaurants(currentRestaurantFilter);
}

function setFilter(filter) {
    APP_DATA.currentFilter = filter;
    document.querySelectorAll('.chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.filter === filter);
    });
    renderRestaurants(currentRestaurantFilter);
}

function toggleFavorite(id) {
    const index = APP_DATA.favorites.indexOf(id);
    if (index > -1) {
        APP_DATA.favorites.splice(index, 1);
        showToast('Aus Favoriten entfernt');
    } else {
        APP_DATA.favorites.push(id);
        showToast('Zu Favoriten hinzugefügt', 'success');
    }
    saveData();
    renderRestaurants();
}

function updateFavoritesBadge() {
    const badge = document.getElementById('favBadge');
    const count = APP_DATA.favorites.length;
    badge.textContent = count;
    badge.style.display = count > 0 ? 'flex' : 'none';
}

function renderFavorites() {
    const container = document.getElementById('favoritesList');
    const favorites = APP_DATA.restaurants.filter(r => APP_DATA.favorites.includes(r.id));
    
    if (favorites.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
                <p>Noch keine Favoriten</p>
                <p style="font-size: 14px;">Tippe auf das Herz bei einem Restaurant</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    favorites.forEach(r => {
        html += `
            <div class="restaurant-card" style="margin-bottom: 16px;">
                <div class="card-image" style="background-image: url('${r.image}'); height: 120px;">
                    <button class="favorite-btn active" onclick="toggleFavorite('${r.id}'); renderFavorites();">
                        <svg viewBox="0 0 24 24" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                    </button>
                </div>
                <div class="card-content">
                    <h3 class="restaurant-name">${r.name}</h3>
                    <p style="color: var(--slate); font-size: 14px;">${r.freeTables} Tische frei</p>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function changeLocation() {
    const select = document.getElementById('locationSelect');
    setLocation(select.value);
}

let currentLocation = 'Alle';
let availableLocations = [];

// Orte aus Supabase laden
async function loadLocations() {
    try {
        // Alle einzigartigen Orte aus restaurants, events, attractions, accommodations sammeln
        const cities = new Set();
        
        // Aus Restaurants
        APP_DATA.restaurants.forEach(r => {
            if (r.city) cities.add(r.city);
        });
        
        // Aus Events
        events.forEach(e => {
            if (e.city) cities.add(e.city);
        });
        
        // Aus Attractions
        attractions.forEach(a => {
            if (a.city) cities.add(a.city);
        });
        
        // Aus Accommodations
        accommodations.forEach(a => {
            if (a.city) cities.add(a.city);
        });
        
        availableLocations = Array.from(cities).sort();
        console.log('Orte geladen:', availableLocations);
        
        renderLocationButtons();
        
    } catch (e) {
        console.error('Fehler beim Laden der Orte:', e);
    }
}

function renderLocationButtons(filter = '') {
    const container = document.getElementById('locationButtons');
    const hint = document.getElementById('noLocationsHint');
    if (!container) return;
    
    const filterLower = filter.toLowerCase().trim();
    
    let html = '';
    
    // "Alle Orte" nur anzeigen wenn kein Filter
    if (!filterLower) {
        html += '<button class="location-btn active" onclick="setLocation(\'Alle\')" data-location="alle">Alle Orte</button>';
    }
    
    let matchCount = 0;
    
    if (availableLocations.length === 0 && !filterLower) {
        if (hint) {
            hint.textContent = 'Noch keine Orte in der Datenbank';
            hint.style.display = 'block';
        }
    } else {
        availableLocations.forEach(city => {
            // Filter anwenden
            if (filterLower && !city.toLowerCase().includes(filterLower)) {
                return;
            }
            matchCount++;
            const isActive = city === currentLocation;
            html += `<button class="location-btn ${isActive ? 'active' : ''}" onclick="setLocation('${city}')" data-location="${city.toLowerCase()}">${city}</button>`;
        });
        
        if (matchCount === 0 && filterLower) {
            if (hint) {
                hint.textContent = `Kein Ort mit "${filter}" gefunden`;
                hint.style.display = 'block';
            }
        } else {
            if (hint) hint.style.display = 'none';
        }
    }
    
    container.innerHTML = html;
}

function filterLocations() {
    const searchInput = document.getElementById('locationSearchInput');
    const filter = searchInput ? searchInput.value : '';
    renderLocationButtons(filter);
}

function addCustomLocation() {
    const input = document.getElementById('newLocationInput');
    const newLocation = input ? input.value.trim() : '';
    
    if (!newLocation) {
        showToast('Bitte einen Ortsnamen eingeben');
        return;
    }
    
    // Prüfen ob Ort schon existiert
    const exists = availableLocations.some(loc => loc.toLowerCase() === newLocation.toLowerCase());
    if (exists) {
        showToast('Dieser Ort existiert bereits');
        setLocation(availableLocations.find(loc => loc.toLowerCase() === newLocation.toLowerCase()));
        input.value = '';
        return;
    }
    
    // Ort hinzufügen und auswählen
    availableLocations.push(newLocation);
    availableLocations.sort();
    
    // In localStorage speichern für spätere Nutzung
    const customLocations = JSON.parse(localStorage.getItem('kmi_custom_locations') || '[]');
    if (!customLocations.includes(newLocation)) {
        customLocations.push(newLocation);
        localStorage.setItem('kmi_custom_locations', JSON.stringify(customLocations));
    }
    
    renderLocationButtons();
    setLocation(newLocation);
    input.value = '';
    
    showToast(`"${newLocation}" hinzugefügt!`, 'success');
}

// Custom Locations beim Start laden
function loadCustomLocations() {
    const customLocations = JSON.parse(localStorage.getItem('kmi_custom_locations') || '[]');
    customLocations.forEach(loc => {
        if (!availableLocations.includes(loc)) {
            availableLocations.push(loc);
        }
    });
    availableLocations.sort();
}

function setLocation(location) {
    currentLocation = location;
    APP_DATA.currentLocation = location;
    
    // Update UI
    const currentLocationEl = document.getElementById('currentLocation');
    if (currentLocationEl) currentLocationEl.textContent = location === 'Alle' ? 'Ostfriesland' : location;
    const liveLocation = document.getElementById('liveLocation');
    if (liveLocation) liveLocation.textContent = location === 'Alle' ? 'Ostfriesland' : location;
    
    const currentLocationAcc = document.getElementById('currentLocationAcc');
    if (currentLocationAcc) currentLocationAcc.textContent = location === 'Alle' ? 'Ostfriesland' : location;
    
    // Update active button
    document.querySelectorAll('.location-btn').forEach(btn => {
        const btnText = btn.textContent.replace('', '');
        btn.classList.toggle('active', btnText === location || (location === 'Alle' && btnText === 'Alle Orte'));
    });
    
    closeModal('locationModal');
    showToast(location === 'Alle' ? 'Alle Orte' : location);
    
    // Echtzeit Statistiken basierend auf Daten
    const restaurantsInLocation = location === 'Alle' 
        ? APP_DATA.restaurants 
        : APP_DATA.restaurants.filter(r => r.city === location);
    
    const freeTables = restaurantsInLocation.reduce((sum, r) => sum + (r.freeTables || 0), 0);
    const reservationsToday = APP_DATA.reservations.filter(r => {
        if (location === 'Alle') return true;
        const restaurant = APP_DATA.restaurants.find(rest => rest.id === r.restaurantId);
        return restaurant && restaurant.city === location;
    }).length;
    
    const liveCount = document.getElementById('liveCount');
    const liveReservations = document.getElementById('liveReservations');
    const liveFreeTables = document.getElementById('liveFreeTables');
    
    if (liveCount) liveCount.textContent = reservationsToday;
    if (liveReservations) liveReservations.textContent = reservationsToday;
    if (liveFreeTables) liveFreeTables.textContent = freeTables;
    
    // Karte auf neuen Ort zentrieren
    if (guestMap && LOCATIONS[location]) {
        const loc = LOCATIONS[location];
        guestMap.flyTo([loc.lat, loc.lng], loc.zoom, { duration: 1 });
    } else if (guestMap && location !== 'Alle') {
        // Dynamische Koordinaten aus erstem Restaurant des Ortes
        const firstInCity = APP_DATA.restaurants.find(r => r.city === location);
        if (firstInCity && firstInCity.lat && firstInCity.lng) {
            guestMap.flyTo([firstInCity.lat, firstInCity.lng], 15, { duration: 1 });
        }
    }
    
    // Wetter für neuen Ort laden
    loadWeatherForLocation(location);
    
    // Filter restaurants & accommodations by location
    renderRestaurants();
    if (typeof renderAccommodations === 'function') renderAccommodations();
}

// Echtzeit Stats aktualisieren
function updateLiveStats() {
    const location = APP_DATA.currentLocation || 'Alle';
    
    const restaurantsInLocation = location === 'Alle' 
        ? APP_DATA.restaurants 
        : APP_DATA.restaurants.filter(r => r.city === location);
    
    const freeTables = restaurantsInLocation.reduce((sum, r) => sum + (r.freeTables || 0), 0);
    const reservationsToday = APP_DATA.reservations.length;
    
    const liveCount = document.getElementById('liveCount');
    const liveReservations = document.getElementById('liveReservations');
    const liveFreeTables = document.getElementById('liveFreeTables');
    
    if (liveCount) liveCount.textContent = reservationsToday;
    if (liveReservations) liveReservations.textContent = reservationsToday;
    if (liveFreeTables) liveFreeTables.textContent = freeTables;
}

async function loadWeatherForLocation(location) {
    // Koordinaten für jeden Ort
    const coords = {
        'Greetsiel': { lat: 53.5021, lon: 7.0965 },
        'Norddeich': { lat: 53.6108, lon: 7.1542 },
        'Norden': { lat: 53.5967, lon: 7.2058 },
        'Aurich': { lat: 53.4714, lon: 7.4808 },
        'Emden': { lat: 53.3594, lon: 7.2060 },
        'Norderney': { lat: 53.7066, lon: 7.1509 },
        'Juist': { lat: 53.6772, lon: 6.9936 },
        'Alle': { lat: 53.5021, lon: 7.0965 }
    };
    
    const loc = coords[location] || coords['Greetsiel'];
    
    try {
        // Erweiterte API mit stündlicher und täglicher Vorhersage
        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current=temperature_2m,wind_speed_10m,weather_code,relative_humidity_2m,is_day&hourly=temperature_2m,weather_code,is_day&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=Europe/Berlin&forecast_days=10`);
        const data = await response.json();
        
        const temp = Math.round(data.current.temperature_2m);
        const windSpeed = Math.round(data.current.wind_speed_10m);
        const weatherCode = data.current.weather_code;
        const humidity = data.current.relative_humidity_2m;
        const isDay = data.current.is_day;
        
        // Wetter-Beschreibung
        const desc = getWeatherDescription(weatherCode);
        
        // High/Low für heute
        const todayHigh = Math.round(data.daily.temperature_2m_max[0]);
        const todayLow = Math.round(data.daily.temperature_2m_min[0]);
        
        // UI Updates
        updateWeatherUI(temp, desc, windSpeed, humidity, todayHigh, todayLow, location, isDay);
        updateHourlyForecast(data.hourly);
        updateDailyForecast(data.daily);
        updateWeatherTheme(weatherCode, isDay);
        
    } catch (e) {
        console.log('Wetter-API Fehler:', e);
    }
}

function getWeatherDescription(code) {
    if (code === 0) return 'Sonnig';
    if (code <= 3) return 'Meist bewölkt';
    if (code <= 48) return 'Nebelig';
    if (code <= 55) return 'Leichter Nieselregen';
    if (code <= 67) return 'Regen';
    if (code <= 77) return 'Schneefall';
    if (code <= 86) return 'Regenschauer';
    if (code >= 95) return 'Gewitter';
    return 'Bewölkt';
}

function getWeatherIcon(code, isDay = 1) {
    // SVG Icons statt Emojis
    if (code === 0) {
        return isDay 
            ? '<svg viewBox="0 0 24 24" fill="#FFD700" width="24" height="24"><circle cx="12" cy="12" r="5"/><path stroke="#FFD700" stroke-width="2" d="M12 1v3M12 20v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M1 12h3M20 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/></svg>'
            : '<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="24" height="24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
    }
    if (code <= 3) {
        return isDay
            ? '<svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/><circle cx="12" cy="12" r="4" fill="#FFD700"/><path d="M18 10a4 4 0 0 1 0 8H8a5 5 0 1 1 .9-9.9" fill="white" opacity="0.9"/></svg>'
            : '<svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M18 10a4 4 0 0 1 0 8H8a5 5 0 1 1 .9-9.9"/></svg>';
    }
    if (code <= 48) return '<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="24" height="24"><path d="M5 5h14M3 10h18M5 15h14M7 20h10"/></svg>';
    if (code <= 67) return '<svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M18 10a4 4 0 0 1 0 8H8a5 5 0 1 1 .9-9.9"/><path d="M8 16v2M12 16v3M16 16v2" stroke="white" stroke-width="2"/></svg>';
    if (code <= 77) return '<svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M18 10a4 4 0 0 1 0 8H8a5 5 0 1 1 .9-9.9"/><circle cx="8" cy="18" r="1"/><circle cx="12" cy="20" r="1"/><circle cx="16" cy="18" r="1"/></svg>';
    return '<svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M18 10a4 4 0 0 1 0 8H8a5 5 0 1 1 .9-9.9"/></svg>';
}

function updateWeatherUI(temp, desc, wind, humidity, high, low, location, isDay) {
    // Haupt-Widget
    const tempEl = document.getElementById('weatherTemp');
    const descEl = document.getElementById('weatherDesc');
    const highEl = document.getElementById('weatherHigh');
    const lowEl = document.getElementById('weatherLow');
    const locEl = document.getElementById('weatherLocation');
    
    if (tempEl) tempEl.textContent = temp + '°';
    if (descEl) descEl.textContent = desc;
    if (highEl) highEl.textContent = high + '°';
    if (lowEl) lowEl.textContent = low + '°';
    if (locEl) locEl.textContent = location.toUpperCase();
    
    // Speichere aktuelle Wetter-Daten global
    window.currentWeatherData = { temp, desc, wind, humidity, high, low, location, isDay };
    
    // Modal auch aktualisieren
    syncWeatherModal();
}

function syncWeatherModal() {
    const data = window.currentWeatherData;
    if (!data) return;
    
    const modalTemp = document.getElementById('weatherModalTemp');
    const modalDesc = document.getElementById('weatherModalDesc');
    const modalHigh = document.getElementById('weatherModalHigh');
    const modalLow = document.getElementById('weatherModalLow');
    const modalLoc = document.getElementById('weatherModalLocation');
    const modalWind = document.getElementById('weatherModalWind');
    const modalHumidity = document.getElementById('weatherModalHumidity');
    const modalSummary = document.getElementById('weatherModalSummary');
    
    if (modalTemp) modalTemp.textContent = data.temp + '°';
    if (modalDesc) modalDesc.textContent = data.desc;
    if (modalHigh) modalHigh.textContent = data.high + '°';
    if (modalLow) modalLow.textContent = data.low + '°';
    if (modalLoc) modalLoc.textContent = data.location.toUpperCase();
    if (modalWind) modalWind.textContent = data.wind + ' km/h';
    if (modalHumidity) modalHumidity.textContent = data.humidity + '%';
    if (modalSummary) modalSummary.textContent = `${data.desc}. Wind mit bis zu ${data.wind} km/h.`;
}

function toggleWeatherDetails() {
    const details = document.getElementById('weatherDetails');
    const arrow = document.getElementById('weatherArrow');
    if (!details) return;
    
    if (details.style.maxHeight === '0px' || details.style.maxHeight === '') {
        details.style.maxHeight = '600px';
        if (arrow) arrow.style.transform = 'rotate(180deg)';
    } else {
        details.style.maxHeight = '0px';
        if (arrow) arrow.style.transform = 'rotate(0deg)';
    }
}

function openWeatherDetail() {
    // Modal Daten synchronisieren
    syncWeatherModal();
    // Modal öffnen
    openModal('weatherDetailModal');
}

function updateHourlyForecast(hourly) {
    const container = document.getElementById('hourlyForecast');
    const modalContainer = document.getElementById('hourlyForecastModal');
    if (!container && !modalContainer) return;
    
    const now = new Date();
    const currentHour = now.getHours();
    
    let html = '';
    for (let i = 0; i < 24; i++) {
        const hourIndex = currentHour + i;
        if (hourIndex >= hourly.time.length) break;
        
        const time = i === 0 ? 'Jetzt' : `${(currentHour + i) % 24} Uhr`;
        const temp = Math.round(hourly.temperature_2m[hourIndex]);
        const code = hourly.weather_code[hourIndex];
        const isDay = hourly.is_day?.[hourIndex] ?? 1;
        const icon = getWeatherIcon(code, isDay);
        
        html += `
            <div style="flex: 0 0 auto; width: 56px; text-align: center; padding: 8px 4px; color: white;">
                <div style="font-size: 12px; font-weight: 500; opacity: 0.9;">${time}</div>
                <div style="margin: 8px 0; height: 28px; display: flex; align-items: center; justify-content: center;">${icon}</div>
                <div style="font-size: 16px; font-weight: 500;">${temp}°</div>
            </div>
        `;
    }
    
    if (container) container.innerHTML = html;
    if (modalContainer) modalContainer.innerHTML = html;
}

function updateDailyForecast(daily) {
    const container = document.getElementById('dailyForecastModal');
    if (!container) return;
    
    const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
    const today = new Date();
    
    // Min/Max für Temperatur-Balken
    const allTemps = [...daily.temperature_2m_min, ...daily.temperature_2m_max];
    const minTemp = Math.min(...allTemps);
    const maxTemp = Math.max(...allTemps);
    const tempRange = maxTemp - minTemp;
    
    let html = '';
    for (let i = 0; i < Math.min(10, daily.time.length); i++) {
        const date = new Date(daily.time[i]);
        const dayName = i === 0 ? 'Heute' : days[date.getDay()];
        const low = Math.round(daily.temperature_2m_min[i]);
        const high = Math.round(daily.temperature_2m_max[i]);
        const code = daily.weather_code[i];
        const icon = getWeatherIcon(code, 1);
        
        // Temperatur-Balken Position
        const lowPos = ((low - minTemp) / tempRange) * 100;
        const highPos = ((high - minTemp) / tempRange) * 100;
        
        html += `
            <div style="display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="width: 50px; font-size: 15px; font-weight: 500;">${dayName}</div>
                <div style="width: 32px; display: flex; justify-content: center;">${icon}</div>
                <div style="width: 40px; text-align: right; font-size: 15px; opacity: 0.7;">${low}°</div>
                <div style="flex: 1; margin: 0 10px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; position: relative;">
                    <div style="position: absolute; left: ${lowPos}%; right: ${100 - highPos}%; height: 100%; background: linear-gradient(90deg, #64B5F6, #FFD54F, #FF8A65); border-radius: 2px;"></div>
                    <div style="position: absolute; left: calc(${(lowPos + highPos) / 2}% - 3px); top: -2px; width: 8px; height: 8px; background: white; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>
                </div>
                <div style="width: 40px; font-size: 15px; font-weight: 500;">${high}°</div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// ==================== RESERVATION FUNCTIONS ====================
function openReservation(restaurantId) {
    const restaurant = APP_DATA.restaurants.find(r => r.id == restaurantId);
    if (!restaurant) {
        console.error('Restaurant nicht gefunden:', restaurantId);
        showToast('Restaurant nicht gefunden', 'error');
        return;
    }
    const reservationRestaurantId = document.getElementById('reservationRestaurantId');
    const reservationRestaurantName = document.getElementById('reservationRestaurantName');
    const reservationDate = document.getElementById('reservationDate');
    
    if (reservationRestaurantId) reservationRestaurantId.value = restaurantId;
    if (reservationRestaurantName) reservationRestaurantName.textContent = restaurant.name;
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    if (reservationDate) {
        reservationDate.value = today;
        reservationDate.min = today;
    }
    
    openModal('reservationModal');
}

// ============================================================================
// RESERVATION SYSTEM - Mit Verfügbarkeits-Check
// ============================================================================

let selectedSlot = null;
let availableSlots = [];

async function loadAvailableSlots() {
    const restaurantId = document.getElementById('reservationRestaurantId').value;
    const date = document.getElementById('reservationDate').value;
    const partySize = parseInt(document.getElementById('partySize').value);
    
    if (!date || !partySize) return;
    
    const container = document.getElementById('availableSlotsContainer');
    container.innerHTML = '<div class="slots-loading">Verfügbarkeit prüfen</div>';
    
    // Verstecke Step 2 und Warteliste
    document.getElementById('reservationStep2').style.display = 'none';
    document.getElementById('waitlistOption').style.display = 'none';
    document.getElementById('selectedSlotDisplay').style.display = 'none';
    selectedSlot = null;
    
    try {
        // Supabase RPC aufrufen
        const { data, error } = await supabase.rpc('get_available_slots', {
            p_restaurant_id: restaurantId,
            p_date: date,
            p_party_size: partySize
        });
        
        if (error) throw error;
        
        availableSlots = data || [];
        renderSlots(availableSlots);
        
    } catch (err) {
        console.error('Slot-Fehler:', err);
        // Fallback: Generiere Standard-Slots ohne DB-Check
        renderFallbackSlots();
    }
}

function renderSlots(slots) {
    const container = document.getElementById('availableSlotsContainer');
    
    if (!slots || slots.length === 0) {
        container.innerHTML = '<p style="color: var(--slate); font-size: 14px;">Keine verfügbaren Zeiten</p>';
        document.getElementById('waitlistOption').style.display = 'block';
        return;
    }
    
    // Gruppiere nach Tageszeit
    const morning = slots.filter(s => s.slot_time < '12:00:00');
    const afternoon = slots.filter(s => s.slot_time >= '12:00:00' && s.slot_time < '17:00:00');
    const evening = slots.filter(s => s.slot_time >= '17:00:00');
    
    let html = '<div class="slots-grid">';
    
    const allSlots = [...morning, ...afternoon, ...evening];
    
    allSlots.forEach(slot => {
        const time = slot.slot_time.substring(0, 5);
        const tableCount = slot.available_tables?.length || 0;
        const areas = [...new Set(slot.areas || [])].join(', ');
        
        html += `
            <button type="button" class="slot-btn" onclick="selectSlot('${slot.slot_time}', ${JSON.stringify(slot.available_tables)}, '${areas}')">
                ${time}
                <span class="slot-tables">${tableCount} ${tableCount === 1 ? 'Tisch' : 'Tische'}</span>
            </button>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function renderFallbackSlots() {
    // Fallback wenn Supabase nicht erreichbar
    const container = document.getElementById('availableSlotsContainer');
    const times = ['11:30', '12:00', '12:30', '13:00', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', '20:00', '20:30'];
    
    let html = '<div class="slots-grid">';
    times.forEach(time => {
        html += `
            <button type="button" class="slot-btn" onclick="selectSlot('${time}:00', null, '')">
                ${time}
            </button>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function selectSlot(time, tables, areas) {
    selectedSlot = { time, tables, areas };
    
    // Alle Buttons deselektieren
    document.querySelectorAll('.slot-btn').forEach(btn => btn.classList.remove('selected'));
    
    // Geklickten Button selektieren
    event.target.closest('.slot-btn').classList.add('selected');
    
    // Hidden Input setzen
    document.getElementById('reservationTime').value = time;
    
    // Anzeige aktualisieren
    const displayTime = time.substring(0, 5);
    document.getElementById('selectedTimeText').textContent = displayTime + ' Uhr';
    document.getElementById('selectedTableText').textContent = areas ? `(${areas})` : '';
    document.getElementById('selectedSlotDisplay').style.display = 'block';
    
    // Step 2 zeigen
    document.getElementById('reservationStep2').style.display = 'block';
    document.getElementById('waitlistOption').style.display = 'none';
    
    // Zum Formular scrollen
    document.getElementById('guestName').focus();
}

function clearSelectedSlot() {
    selectedSlot = null;
    document.getElementById('reservationTime').value = '';
    document.getElementById('selectedSlotDisplay').style.display = 'none';
    document.getElementById('reservationStep2').style.display = 'none';
    document.querySelectorAll('.slot-btn').forEach(btn => btn.classList.remove('selected'));
}

function showWaitlistForm() {
    // TODO: Wartelisten-Modal öffnen
    showToast('Wartelisten-Funktion kommt bald!', 'info');
}

function submitReservation(e) {
    e.preventDefault();
    
    const restaurantId = document.getElementById('reservationRestaurantId').value;
    const restaurant = APP_DATA.restaurants.find(r => r.id == restaurantId);
    
    const reservation = {
        id: Date.now(),
        restaurantId: restaurantId,
        restaurantName: restaurant?.name || 'Restaurant',
        guestName: document.getElementById('guestName').value,
        guestPhone: document.getElementById('guestPhone').value,
        guestEmail: document.getElementById('guestEmail')?.value || '',
        date: document.getElementById('reservationDate').value,
        time: document.getElementById('reservationTime').value,
        partySize: parseInt(document.getElementById('partySize').value),
        occasion: document.getElementById('reservationOccasion')?.value || '',
        notes: document.getElementById('reservationNotes').value,
        tableId: selectedSlot?.tables?.[0] || null,
        status: 'pending',
        source: 'website',
        createdAt: new Date().toISOString()
    };
    
    APP_DATA.reservations.push(reservation);
    saveData();
    
    // In Supabase speichern (neue Funktion)
    createReservationInSupabase(reservation);
    
    closeModal('reservationModal');
    document.getElementById('reservationForm').reset();
    clearSelectedSlot();
    
    // WhatsApp oder Bestätigung
    if (restaurant?.whatsapp) {
        const formattedDate = new Date(reservation.date).toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' });
        const message = `Hallo ${restaurant.name}! 

Ich möchte gerne einen Tisch reservieren:

📅 Datum: ${formattedDate}
🕐 Uhrzeit: ${reservation.time.substring(0,5)} Uhr
👥 Personen: ${reservation.partySize}
👤 Name: ${reservation.guestName}
📞 Telefon: ${reservation.guestPhone}
${reservation.occasion ? `🎉 Anlass: ${reservation.occasion}` : ''}
${reservation.notes ? `📝 Anmerkungen: ${reservation.notes}` : ''}

Gesendet über Kiek mol in`;
        
        const whatsappUrl = `https://wa.me/${restaurant.whatsapp.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
        showReservationConfirmation(reservation, whatsappUrl);
    } else {
        showToast('Reservierung angefragt! Das Restaurant wird Sie kontaktieren.', 'success');
    }
    
    updateDashboard();
}

async function createReservationInSupabase(reservation) {
    try {
        const { data, error } = await supabase.rpc('create_reservation', {
            p_restaurant_id: reservation.restaurantId,
            p_date: reservation.date,
            p_time: reservation.time,
            p_party_size: reservation.partySize,
            p_guest_name: reservation.guestName,
            p_guest_email: reservation.guestEmail || null,
            p_guest_phone: reservation.guestPhone,
            p_table_id: reservation.tableId,
            p_special_requests: reservation.notes || null,
            p_occasion: reservation.occasion || null,
            p_source: 'website'
        });
        
        if (error) {
            console.error('Supabase Reservierung Fehler:', error);
            // Fallback zur alten Methode
            saveReservationToSupabase(reservation);
        } else if (data?.success) {
            console.log('Reservierung erstellt:', data);
        }
    } catch (err) {
        console.error('Reservierung Fehler:', err);
        saveReservationToSupabase(reservation);
    }
}

function showReservationConfirmation(reservation, whatsappUrl) {
    const formattedDate = new Date(reservation.date).toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' });
    
    // Create confirmation modal
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.id = 'confirmationModal';
    modal.innerHTML = `
        <div class="modal" style="text-align: center;">
            <div class="modal-body" style="padding: 40px;">
                <div style="width: 80px; height: 80px; background: rgba(52,199,89,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#34c759" stroke-width="3" width="40" height="40">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                </div>
                <h2 style="font-family: 'Playfair Display', serif; font-size: 28px; margin-bottom: 8px;">Reservierung erstellt!</h2>
                <p style="color: var(--slate); margin-bottom: 24px;">${reservation.restaurantName}<br>${formattedDate} um ${reservation.time} Uhr<br>${reservation.partySize} Personen</p>
                
                <p style="font-weight: 600; margin-bottom: 16px;">Jetzt per WhatsApp bestätigen:</p>
                
                <a href="${whatsappUrl}" target="_blank" class="card-btn card-btn-whatsapp" style="display: flex; justify-content: center; padding: 16px 32px; font-size: 16px; margin-bottom: 16px; text-decoration: none;">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24" style="margin-right: 12px;">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                    </svg>
                    WhatsApp öffnen
                </a>
                
                <button onclick="closeConfirmationModal()" style="background: none; border: none; color: var(--slate); font-size: 14px; cursor: pointer;">
                    Später bestätigen
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function closeConfirmationModal() {
    const modal = document.getElementById('confirmationModal');
    if (modal) modal.remove();
    showToast('Reservierung gespeichert!', 'success');
}

// ==================== DASHBOARD SECTION SWITCHING ====================
function showDashboardSection(section) {
    // Hide all sections
    document.querySelectorAll('.dash-section').forEach(s => s.classList.remove('active'));
    
    // Show selected section
    const sectionEl = document.getElementById('section' + section.charAt(0).toUpperCase() + section.slice(1));
    if (sectionEl) sectionEl.classList.add('active');
    
    // Update nav
    document.querySelectorAll('.dash-nav-item').forEach(item => item.classList.remove('active'));
    const navItem = document.getElementById('nav' + section.charAt(0).toUpperCase() + section.slice(1));
    if (navItem) navItem.classList.add('active');
    
    // Update content based on section
    if (section === 'reservations') {
        renderReservations();
        const todayDate = document.getElementById('todayDate');
        if (todayDate) todayDate.textContent = formatDate(new Date());
    } else if (section === 'offers') {
        renderActiveOffers();
    } else if (section === 'customers') {
        loadCustomers();
    } else if (section === 'accommodationsDash') {
        loadAccommodationsDash();
    } else if (section === 'eventsDash') {
        loadEventsDash();
    } else if (section === 'attractionsDash') {
        loadAttractionsDash();
    } else if (section === 'jobsDash') {
        loadJobsDash();
    } else if (section === 'restaurantsDash') {
        loadRestaurantsDash();
    } else if (section === 'tischplan') {
        loadAdminTischplan();
    } else if (section === 'rewards') {
        loadRestaurantRewards();
    } else if (section === 'statistics') {
        loadStatistics();
    } else if (section === 'revenue') {
        loadRevenue();
    }
}

// ==================== JOBS DASHBOARD ====================
let dashboardJobs = [];

async function loadJobsDash() {
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/jobs?select=*,restaurants(name,city)&order=created_at.desc`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (response.ok) {
            dashboardJobs = await response.json();
        }
    } catch (e) {
        console.log('Jobs laden Fehler:', e);
    }
    
    // Stats aktualisieren
    const jobCount = document.getElementById('jobCount');
    if (jobCount) jobCount.textContent = dashboardJobs.filter(j => j.is_active).length;
    
    // Restaurant-Dropdown füllen
    const select = document.getElementById('newJobRestaurant');
    if (select && APP_DATA.restaurants) {
        select.innerHTML = '<option value="">-- Restaurant wählen --</option>';
        APP_DATA.restaurants.forEach(r => {
            select.innerHTML += `<option value="${r.id}">${r.name} (${r.city})</option>`;
        });
    }
    
    renderJobsDash();
}

function renderJobsDash() {
    const container = document.getElementById('jobsDashList');
    if (!container) return;
    
    if (dashboardJobs.length === 0) {
        container.innerHTML = '<p style="padding: 20px; color: var(--slate); text-align: center;">Keine Stellenanzeigen vorhanden</p>';
        return;
    }
    
    let html = '<table class="dash-table"><thead><tr><th>Titel</th><th>Restaurant</th><th>Art</th><th>Status</th><th>Erstellt</th><th>Aktionen</th></tr></thead><tbody>';
    
    dashboardJobs.forEach(job => {
        const restaurantName = job.restaurants ? job.restaurants.name : '-';
        const typeLabels = { fulltime: 'Vollzeit', parttime: 'Teilzeit', minijob: 'Minijob' };
        const typeLabel = typeLabels[job.job_type] || job.job_type;
        const createdDate = new Date(job.created_at).toLocaleDateString('de-DE');
        
        html += `
            <tr>
                <td>
                    <strong>${job.title}</strong>
                    ${job.is_urgent ? '<span style="background: #ff3b30; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 6px;">DRINGEND</span>' : ''}
                </td>
                <td>${restaurantName}</td>
                <td><span class="job-badge ${job.job_type}">${typeLabel}</span></td>
                <td>
                    <span style="color: ${job.is_active ? 'var(--success)' : 'var(--slate)'};">
                        ${job.is_active ? '● Aktiv' : '○ Inaktiv'}
                    </span>
                </td>
                <td>${createdDate}</td>
                <td>
                    <button onclick="toggleJobStatus('${job.id}', ${!job.is_active})" class="action-btn" title="${job.is_active ? 'Deaktivieren' : 'Aktivieren'}">
                        ${job.is_active ? '⏸' : '▶'}
                    </button>
                    <button onclick="deleteJob('${job.id}')" class="action-btn delete" title="Löschen">🗑</button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

async function addJob(event) {
    event.preventDefault();
    
    const job = {
        title: document.getElementById('newJobTitle').value,
        job_type: document.getElementById('newJobType').value,
        restaurant_id: document.getElementById('newJobRestaurant').value || null,
        salary: document.getElementById('newJobSalary').value || null,
        description: document.getElementById('newJobDescription').value || null,
        contact_whatsapp: document.getElementById('newJobWhatsApp').value || null,
        contact_email: document.getElementById('newJobEmail').value || null,
        is_urgent: document.getElementById('newJobUrgent').checked,
        is_active: true
    };
    
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/jobs`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
            },
            body: JSON.stringify(job)
        });
        
        if (response.ok) {
            showToast('Stellenanzeige veröffentlicht!', 'success');
            document.getElementById('addJobForm').reset();
            loadJobsDash();
        } else {
            showToast('Fehler beim Speichern', 'error');
        }
    } catch (e) {
        console.error('Job speichern Fehler:', e);
        showToast('Fehler beim Speichern', 'error');
    }
}

async function toggleJobStatus(jobId, newStatus) {
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/jobs?id=eq.${jobId}`, {
            method: 'PATCH',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_active: newStatus })
        });
        loadJobsDash();
        showToast(newStatus ? 'Job aktiviert' : 'Job deaktiviert');
    } catch (e) {
        console.error('Status ändern Fehler:', e);
    }
}

async function deleteJob(jobId) {
    if (!confirm('Stellenanzeige wirklich löschen?')) return;
    
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/jobs?id=eq.${jobId}`, {
            method: 'DELETE',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        loadJobsDash();
        showToast('Stellenanzeige gelöscht');
    } catch (e) {
        console.error('Löschen Fehler:', e);
    }
}

// ==================== RESTAURANTS DASHBOARD ====================
async function loadRestaurantsDash() {
    // Stats berechnen
    const restaurants = APP_DATA.restaurants || [];
    const activeCount = restaurants.filter(r => r.is_active !== false).length;
    const totalTables = restaurants.reduce((sum, r) => sum + (r.totalTables || 0), 0);
    const freeTables = restaurants.reduce((sum, r) => sum + (r.freeTables || 0), 0);
    
    // Reservierungen heute zählen
    let todayReservations = 0;
    const today = new Date().toISOString().split('T')[0];
    if (APP_DATA.reservations) {
        todayReservations = APP_DATA.reservations.filter(r => r.date === today).length;
    }
    
    // Stats updaten
    const statActive = document.getElementById('statActiveRestaurants');
    const statTotal = document.getElementById('statTotalTablesAll');
    const statFree = document.getElementById('statFreeTablesAll');
    const statToday = document.getElementById('statTodayReservationsAll');
    const restaurantCountDash = document.getElementById('restaurantCountDash');
    
    if (statActive) statActive.textContent = activeCount;
    if (statTotal) statTotal.textContent = totalTables;
    if (statFree) statFree.textContent = freeTables;
    if (statToday) statToday.textContent = todayReservations;
    if (restaurantCountDash) restaurantCountDash.textContent = restaurants.length;
    
    renderRestaurantsDash();
}

function renderRestaurantsDash() {
    const container = document.getElementById('restaurantsDashList');
    if (!container) return;
    
    const restaurants = APP_DATA.restaurants || [];
    
    if (restaurants.length === 0) {
        container.innerHTML = '<p style="padding: 20px; color: var(--slate); text-align: center;">Keine Restaurants vorhanden</p>';
        return;
    }
    
    let html = '<table class="dash-table"><thead><tr><th>Restaurant</th><th>Ort</th><th>Küche</th><th>Tische</th><th>Bewertung</th><th>Reserv. heute</th><th>Aktionen</th></tr></thead><tbody>';
    
    restaurants.forEach(r => {
        const todayRes = (APP_DATA.reservations || []).filter(res => res.restaurant_id === r.id && res.date === new Date().toISOString().split('T')[0]).length;
        
        html += `
            <tr>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        ${r.image ? `<img src="${r.image}" style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;">` : '<div style="width: 40px; height: 40px; background: var(--sand); border-radius: 8px;"></div>'}
                        <div>
                            <strong>${r.name}</strong>
                            ${r.is_active === false ? '<span style="color: var(--slate);"> (inaktiv)</span>' : ''}
                        </div>
                    </div>
                </td>
                <td>${r.city || '-'}</td>
                <td>${r.cuisine || '-'}</td>
                <td>
                    <span style="color: var(--success);">${r.freeTables || 0}</span> / ${r.totalTables || 0}
                </td>
                <td>⭐ ${r.rating || '-'}</td>
                <td style="text-align: center;">
                    <span style="background: ${todayRes > 0 ? 'var(--primary)' : 'var(--sand)'}; color: ${todayRes > 0 ? 'white' : 'var(--slate)'}; padding: 4px 10px; border-radius: 12px; font-weight: 600;">
                        ${todayRes}
                    </span>
                </td>
                <td>
                    <button onclick="editRestaurant('${r.id}')" class="action-btn" title="Bearbeiten">✏️</button>
                    <button onclick="viewRestaurantReservations('${r.id}')" class="action-btn" title="Reservierungen">📋</button>
                    <button onclick="deleteRestaurant('${r.id}')" class="action-btn delete" title="Löschen">🗑</button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function viewRestaurantReservations(restaurantId) {
    const restaurant = APP_DATA.restaurants.find(r => r.id === restaurantId);
    if (!restaurant) return;
    
    const reservations = (APP_DATA.reservations || []).filter(r => r.restaurant_id === restaurantId);
    
    let html = `
        <div style="padding: 20px;">
            <h3 style="margin-bottom: 16px;">Reservierungen für ${restaurant.name}</h3>
    `;
    
    if (reservations.length === 0) {
        html += '<p style="color: var(--slate);">Keine Reservierungen vorhanden</p>';
    } else {
        html += '<table class="dash-table"><thead><tr><th>Datum</th><th>Uhrzeit</th><th>Name</th><th>Personen</th><th>Status</th></tr></thead><tbody>';
        
        reservations.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(res => {
            const statusColors = { confirmed: 'var(--success)', pending: 'var(--warning)', cancelled: 'var(--error)' };
            const statusLabels = { confirmed: 'Bestätigt', pending: 'Ausstehend', cancelled: 'Storniert' };
            
            html += `
                <tr>
                    <td>${new Date(res.date).toLocaleDateString('de-DE')}</td>
                    <td>${res.time}</td>
                    <td>${res.name}</td>
                    <td>${res.guests} Pers.</td>
                    <td style="color: ${statusColors[res.status] || 'var(--slate)'};">${statusLabels[res.status] || res.status}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
    }
    
    html += '</div>';
    
    // Modal anzeigen
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Reservierungen</h2>
                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                ${html}
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function deleteRestaurant(restaurantId) {
    if (!confirm('Restaurant wirklich löschen? Alle Reservierungen werden auch gelöscht!')) return;
    
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/restaurants?id=eq.${restaurantId}`, {
            method: 'DELETE',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        // Lokal entfernen
        APP_DATA.restaurants = APP_DATA.restaurants.filter(r => r.id !== restaurantId);
        loadRestaurantsDash();
        renderRestaurants();
        showToast('Restaurant gelöscht');
    } catch (e) {
        console.error('Löschen Fehler:', e);
        showToast('Fehler beim Löschen', 'error');
    }
}

function editRestaurant(restaurantId) {
    const restaurant = APP_DATA.restaurants.find(r => r.id === restaurantId);
    if (!restaurant) return;
    
    // Formular mit Daten füllen
    document.getElementById('newRestaurantName').value = restaurant.name || '';
    document.getElementById('newRestaurantPhone').value = restaurant.phone || '';
    document.getElementById('newRestaurantWhatsapp').value = restaurant.whatsapp || '';
    document.getElementById('newRestaurantEmail').value = restaurant.email || '';
    document.getElementById('newRestaurantStreet').value = restaurant.street || '';
    document.getElementById('newRestaurantZip').value = restaurant.zip || '';
    document.getElementById('newRestaurantCity').value = restaurant.city || '';
    document.getElementById('newRestaurantCuisine').value = restaurant.cuisine || '';
    document.getElementById('newRestaurantInstagram').value = restaurant.instagram || '';
    document.getElementById('newRestaurantTiktok').value = restaurant.tiktok || '';
    document.getElementById('newRestaurantRating').value = restaurant.rating || '';
    document.getElementById('newRestaurantReviews').value = restaurant.reviewCount || '';
    document.getElementById('newRestaurantTables').value = restaurant.totalTables || '';
    document.getElementById('newRestaurantImage').value = restaurant.image || '';
    
    // Restaurant-ID speichern für Update
    document.getElementById('addRestaurantForm').dataset.editId = restaurantId;
    
    // Modal-Titel ändern
    const modalTitle = document.querySelector('#addRestaurantModal .modal-title');
    if (modalTitle) modalTitle.textContent = 'Restaurant bearbeiten';
    
    // Button-Text ändern
    const submitBtn = document.querySelector('#addRestaurantForm button[type="submit"]');
    if (submitBtn) submitBtn.textContent = 'Speichern';
    
    openModal('addRestaurantModal');
}

function openNewRestaurantModal() {
    // Formular zurücksetzen
    const form = document.getElementById('addRestaurantForm');
    if (form) {
        form.reset();
        delete form.dataset.editId;
    }
    
    // Bild-Preview zurücksetzen
    uploadedImageBase64 = null;
    if (typeof clearImagePreview === 'function') clearImagePreview();
    
    // Modal-Titel für Neu
    const modalTitle = document.querySelector('#addRestaurantModal .modal-title');
    if (modalTitle) modalTitle.textContent = 'Neues Restaurant';
    
    // Button-Text für Neu
    const submitBtn = document.querySelector('#addRestaurantForm button[type="submit"]');
    if (submitBtn) submitBtn.textContent = 'Restaurant hinzufügen';
    
    openModal('addRestaurantModal');
}

// ==================== EVENTS DASHBOARD ====================
async function loadEventsDash() {
    // Stats aktualisieren
    const statTotal = document.getElementById('statTotalEvents');
    const statUpcoming = document.getElementById('statUpcomingEvents');
    const statFeatured = document.getElementById('statFeaturedEvents');
    const eventCount = document.getElementById('eventCount');
    
    const today = new Date().toISOString().split('T')[0];
    const upcoming = events.filter(e => e.event_date >= today).length;
    const featured = events.filter(e => e.is_featured).length;
    
    if (statTotal) statTotal.textContent = events.length;
    if (statUpcoming) statUpcoming.textContent = upcoming;
    if (statFeatured) statFeatured.textContent = featured;
    if (eventCount) eventCount.textContent = events.length;
    
    renderEventsDash();
}

function renderEventsDash() {
    const container = document.getElementById('eventsDashList');
    if (!container) return;
    
    if (events.length === 0) {
        container.innerHTML = '<p style="padding: 20px; color: var(--slate); text-align: center;">Keine Events vorhanden</p>';
        return;
    }
    
    let html = '<table class="dash-table"><thead><tr><th>Titel</th><th>Datum</th><th>Ort</th><th>Kategorie</th><th>Status</th><th>Aktionen</th></tr></thead><tbody>';
    
    events.forEach(e => {
        const eventDate = new Date(e.event_date);
        const dateStr = eventDate.toLocaleDateString('de-DE');
        const isPast = e.event_date < new Date().toISOString().split('T')[0];
        
        html += `
            <tr>
                <td style="font-weight: 600;">${e.title}</td>
                <td>${dateStr}</td>
                <td>${e.city || '-'}</td>
                <td><span style="background: var(--cream); padding: 2px 8px; border-radius: 4px; font-size: 12px;">${e.category || 'sonstiges'}</span></td>
                <td>
                    ${e.is_featured ? '<span style="color: var(--warning);">Highlight</span>' : ''}
                    ${isPast ? '<span style="color: var(--slate);">Vergangen</span>' : '<span style="color: var(--success);">Aktiv</span>'}
                </td>
                <td>
                    <button onclick="deleteEvent('${e.id}')" style="background: none; border: none; cursor: pointer; color: var(--danger);" title="Löschen">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

async function addEvent(e) {
    e.preventDefault();
    
    const newEvent = {
        id: Date.now(),
        title: document.getElementById('eventTitle').value,
        description: document.getElementById('eventDescription').value,
        event_date: document.getElementById('eventDate').value,
        event_time: document.getElementById('eventTime').value,
        city: document.getElementById('eventCity').value || 'Greetsiel',
        category: document.getElementById('eventCategory').value,
        price_info: document.getElementById('eventPrice').value,
        website: document.getElementById('eventWebsite').value,
        is_featured: document.getElementById('eventFeatured').checked,
        is_active: true
    };
    
    if (useSupabase) {
        try {
            await supabasePost('events', newEvent);
            await loadEvents();
        } catch (err) {
            console.error('Fehler beim Speichern:', err);
        }
    } else {
        events.push(newEvent);
    }
    
    closeModal('addEventModal');
    document.getElementById('addEventForm').reset();
    loadEventsDash();
    showToast('Event hinzugefügt!', 'success');
}

async function deleteEvent(id) {
    if (!confirm('Event wirklich löschen?')) return;
    
    if (useSupabase) {
        try {
            await supabaseDelete('events', id);
            await loadEvents();
        } catch (err) {
            console.error('Fehler beim Löschen:', err);
        }
    } else {
        events = events.filter(e => e.id != id);
    }
    
    loadEventsDash();
    showToast('Event gelöscht', 'success');
}

// ==================== ATTRACTIONS DASHBOARD ====================
async function loadAttractionsDash() {
    // Stats aktualisieren
    const statTotal = document.getElementById('statTotalAttractions');
    const statNatur = document.getElementById('statNaturAttractions');
    const statMuseum = document.getElementById('statMuseumAttractions');
    const attractionCount = document.getElementById('attractionCount');
    
    const natur = attractions.filter(a => a.category === 'natur').length;
    const museum = attractions.filter(a => a.category === 'museum').length;
    
    if (statTotal) statTotal.textContent = attractions.length;
    if (statNatur) statNatur.textContent = natur;
    if (statMuseum) statMuseum.textContent = museum;
    if (attractionCount) attractionCount.textContent = attractions.length;
    
    renderAttractionsDash();
}

function renderAttractionsDash() {
    const container = document.getElementById('attractionsDashList');
    if (!container) return;
    
    if (attractions.length === 0) {
        container.innerHTML = '<p style="padding: 20px; color: var(--slate); text-align: center;">Keine Ausflugsziele vorhanden</p>';
        return;
    }
    
    let html = '<table class="dash-table"><thead><tr><th>Name</th><th>Ort</th><th>Kategorie</th><th>Bewertung</th><th>Aktionen</th></tr></thead><tbody>';
    
    attractions.forEach(a => {
        html += `
            <tr>
                <td style="font-weight: 600;">${a.name}</td>
                <td>${a.city || '-'}</td>
                <td><span style="background: var(--cream); padding: 2px 8px; border-radius: 4px; font-size: 12px;">${a.category || 'sonstiges'}</span></td>
                <td>
                    <span style="color: var(--warning);">H</span> ${a.rating || 4.5}
                </td>
                <td>
                    <button onclick="deleteAttraction('${a.id}')" style="background: none; border: none; cursor: pointer; color: var(--danger);" title="Löschen">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

async function addAttraction(e) {
    e.preventDefault();
    
    const newAttraction = {
        id: Date.now(),
        name: document.getElementById('attractionName').value,
        description: document.getElementById('attractionDescription').value,
        city: document.getElementById('attractionCity').value || 'Greetsiel',
        category: document.getElementById('attractionCategory').value,
        price_info: document.getElementById('attractionPrice').value,
        rating: parseFloat(document.getElementById('attractionRating').value) || 4.5,
        phone: document.getElementById('attractionPhone').value,
        website: document.getElementById('attractionWebsite').value,
        is_active: true
    };
    
    if (useSupabase) {
        try {
            await supabasePost('attractions', newAttraction);
            await loadAttractions();
        } catch (err) {
            console.error('Fehler beim Speichern:', err);
        }
    } else {
        attractions.push(newAttraction);
    }
    
    closeModal('addAttractionModal');
    document.getElementById('addAttractionForm').reset();
    loadAttractionsDash();
    showToast('Ausflugsziel hinzugefügt!', 'success');
}

async function deleteAttraction(id) {
    if (!confirm('Ausflugsziel wirklich löschen?')) return;
    
    if (useSupabase) {
        try {
            await supabaseDelete('attractions', id);
            await loadAttractions();
        } catch (err) {
            console.error('Fehler beim Löschen:', err);
        }
    } else {
        attractions = attractions.filter(a => a.id != id);
    }
    
    loadAttractionsDash();
    showToast('Ausflugsziel gelöscht', 'success');
}

// ==================== STATISTICS ====================
async function loadStatistics() {
    // Grundzahlen
    const statRestaurants = document.getElementById('statTotalRestaurants');
    const statAccommodations = document.getElementById('statTotalAccommodations');
    const statReservations = document.getElementById('statTotalReservations');
    const statCustomers = document.getElementById('statTotalCustomers');
    
    if (statRestaurants) statRestaurants.textContent = APP_DATA.restaurants?.length || 0;
    if (statAccommodations) statAccommodations.textContent = accommodations?.length || 0;
    if (statReservations) statReservations.textContent = APP_DATA.reservations?.length || 0;
    if (statCustomers) statCustomers.textContent = customers?.length || 0;
    
    // Diese Woche (Demo-Daten)
    const weekRes = document.getElementById('weekReservations');
    const weekInq = document.getElementById('weekInquiries');
    const weekNew = document.getElementById('weekNewCustomers');
    
    if (weekRes) weekRes.textContent = Math.floor(Math.random() * 20) + 5;
    if (weekInq) weekInq.textContent = Math.floor(Math.random() * 10) + 2;
    if (weekNew) weekNew.textContent = Math.floor(Math.random() * 5) + 1;
    
    // Nach Ort
    const allItems = [...(APP_DATA.restaurants || []), ...(accommodations || [])];
    const greetsiel = allItems.filter(i => i.city === 'Greetsiel' || i.location === 'Greetsiel').length;
    const norddeich = allItems.filter(i => i.city === 'Norddeich' || i.location === 'Norddeich').length;
    const norden = allItems.filter(i => i.city === 'Norden' || i.location === 'Norden').length;
    const other = allItems.length - greetsiel - norddeich - norden;
    
    const statGreetsiel = document.getElementById('statGreetsiel');
    const statNorddeich = document.getElementById('statNorddeich');
    const statNorden = document.getElementById('statNorden');
    const statOther = document.getElementById('statOther');
    
    if (statGreetsiel) statGreetsiel.textContent = greetsiel + ' Einträge';
    if (statNorddeich) statNorddeich.textContent = norddeich + ' Einträge';
    if (statNorden) statNorden.textContent = norden + ' Einträge';
    if (statOther) statOther.textContent = other + ' Einträge';
}

// ==================== REVENUE ====================
async function loadRevenue() {
    // Berechne Umsatz aus Kunden
    const monthlyFee = 29.90;
    const paidCustomers = customers.filter(c => c.payment_status === 'paid').length;
    const pendingCustomers = customers.filter(c => c.payment_status === 'pending').length;
    const overdueCustomers = customers.filter(c => c.payment_status === 'overdue').length;
    
    const monthlyRev = (paidCustomers * monthlyFee).toFixed(2);
    const yearlyRev = (paidCustomers * monthlyFee * 12).toFixed(2);
    const pendingRev = (pendingCustomers * monthlyFee).toFixed(2);
    const overdueRev = (overdueCustomers * monthlyFee).toFixed(2);
    
    const monthlyRevEl = document.getElementById('monthlyRevenue');
    const yearlyRevEl = document.getElementById('yearlyRevenue');
    const pendingRevEl = document.getElementById('pendingRevenue');
    const overdueRevEl = document.getElementById('overdueRevenue');
    
    if (monthlyRevEl) monthlyRevEl.textContent = monthlyRev + ' €';
    if (yearlyRevEl) yearlyRevEl.textContent = yearlyRev + ' €';
    if (pendingRevEl) pendingRevEl.textContent = pendingRev + ' €';
    if (overdueRevEl) overdueRevEl.textContent = overdueRev + ' €';
    
    // Balkendiagramm (Demo-Daten für Monate)
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const currentMonth = new Date().getMonth();
    
    months.forEach((month, i) => {
        const bar = document.getElementById('bar' + month.charAt(0).toUpperCase() + month.slice(1));
        if (bar) {
            // Demo: Höhe basiert auf Kundenanzahl + Variation
            const baseHeight = customers.length * 10;
            const variation = Math.random() * 30;
            const height = i <= currentMonth ? Math.min(baseHeight + variation, 100) : 5;
            bar.style.height = height + 'px';
        }
    });
    
    // Letzte Zahlungen laden
    loadRecentPayments();
}

async function loadRecentPayments() {
    const container = document.getElementById('recentPaymentsList');
    if (!container) return;
    
    if (!useSupabase) {
        container.innerHTML = '<p style="padding: 20px; color: var(--slate); text-align: center;">Keine Zahlungen vorhanden</p>';
        return;
    }
    
    try {
        const payments = await supabaseGet('payments', 'select=*,customers(name)&order=payment_date.desc&limit=10');
        
        if (!payments || payments.length === 0) {
            container.innerHTML = '<p style="padding: 20px; color: var(--slate); text-align: center;">Keine Zahlungen vorhanden</p>';
            return;
        }
        
        let html = '';
        payments.forEach(p => {
            const date = new Date(p.payment_date).toLocaleDateString('de-DE');
            const customer = p.customers?.name || 'Unbekannt';
            const statusColor = p.status === 'completed' ? 'var(--success)' : p.status === 'pending' ? 'var(--warning)' : 'var(--danger)';
            const statusText = p.status === 'completed' ? 'Bezahlt' : p.status === 'pending' ? 'Ausstehend' : 'Fehlgeschlagen';
            
            html += `
                <div style="padding: 16px; border-bottom: 1px solid var(--sand); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: var(--dark);">${customer}</div>
                        <div style="font-size: 13px; color: var(--slate);">${date} • ${p.payment_method || 'Überweisung'}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-weight: 700; color: var(--primary);">${p.amount?.toFixed(2) || '29.90'} €</span>
                        <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(52,199,89,0.15); color: ${statusColor};">${statusText}</span>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (e) {
        console.error('Fehler beim Laden der Zahlungen:', e);
    }
}

// ==================== DASHBOARD FUNCTIONS ====================
function updateDashboard() {
    // Update date
    const currentDate = document.getElementById('currentDate');
    if (currentDate) currentDate.textContent = formatDate(new Date());
    
    // Update reservations count
    const todayReservations = APP_DATA.reservations.filter(r => r.date === TODAY);
    const dashReservationsToday = document.getElementById('dashReservationsToday');
    if (dashReservationsToday) {
        dashReservationsToday.textContent = todayReservations.length;
    }
    
    // Update reservation count in nav
    const reservationCount = document.getElementById('reservationCount');
    if (reservationCount) reservationCount.textContent = todayReservations.length;
    
    // Update offers count
    const offerCount = document.getElementById('offerCount');
    if (offerCount) offerCount.textContent = APP_DATA.offers.length;
    
    const dashOffersCount = document.getElementById('dashOffersCount');
    if (dashOffersCount) dashOffersCount.textContent = APP_DATA.offers.length;
    
    // Update Gäste heute (aus Reservierungen berechnen)
    const dashGuestsToday = document.getElementById('dashGuestsToday');
    if (dashGuestsToday) {
        const totalGuests = todayReservations.reduce((sum, r) => sum + (r.partySize || r.guests || 2), 0);
        dashGuestsToday.textContent = totalGuests;
    }
    
    // Update Umsatz (aus Kunden berechnen)
    const dashRevenue = document.getElementById('dashRevenue');
    if (dashRevenue) {
        const monthlyRevenue = customers.reduce((sum, c) => {
            if (c.payment_status === 'paid') {
                return sum + (c.monthly_fee || 29.90);
            }
            return sum;
        }, 0);
        dashRevenue.textContent = monthlyRevenue.toFixed(0) + '€';
    }
    
    // Restaurants Anzahl
    const dashRestaurants = document.getElementById('dashRestaurants');
    if (dashRestaurants) {
        dashRestaurants.textContent = APP_DATA.restaurants.length;
    }
    
    // Render tables
    renderTables();
    
    // Render reservations preview
    renderReservationsPreview();
    
    // Render active offers
    renderActiveOffers();
    
    // Update restaurant status
    updateRestaurantStatus();
    
    // Lade Echtzeit-Statistiken aus Supabase
    loadDashboardStats();
}

// Echtzeit Statistiken aus Supabase laden
async function loadDashboardStats() {
    if (!useSupabase) return;
    
    try {
        // Restaurants zählen
        const restResponse = await fetch(`${SUPABASE_URL}/rest/v1/restaurants?select=id&is_active=eq.true`, {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
        const restaurants = await restResponse.json();
        
        const statRestaurants = document.getElementById('statRestaurants');
        if (statRestaurants) statRestaurants.textContent = restaurants.length;
        
        const statTotalRestaurants = document.getElementById('statTotalRestaurants');
        if (statTotalRestaurants) statTotalRestaurants.textContent = restaurants.length;
        
        // Heutige Reservierungen
        const today = new Date().toISOString().split('T')[0];
        const resResponse = await fetch(`${SUPABASE_URL}/rest/v1/reservations?select=id,guests&date=eq.${today}`, {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
        const todayRes = await resResponse.json();
        
        const dashReservationsToday = document.getElementById('dashReservationsToday');
        if (dashReservationsToday) dashReservationsToday.textContent = todayRes.length;
        
        const reservationCount = document.getElementById('reservationCount');
        if (reservationCount) reservationCount.textContent = todayRes.length;
        
        const dashGuestsToday = document.getElementById('dashGuestsToday');
        if (dashGuestsToday) {
            const totalGuests = todayRes.reduce((sum, r) => sum + (r.guests || 2), 0);
            dashGuestsToday.textContent = totalGuests;
        }
        
        // Aktive Angebote
        const offersResponse = await fetch(`${SUPABASE_URL}/rest/v1/offers?select=id`, {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
        const offers = await offersResponse.json();
        
        const dashOffersCount = document.getElementById('dashOffersCount');
        if (dashOffersCount) dashOffersCount.textContent = offers.length;
        
        const offerCount = document.getElementById('offerCount');
        if (offerCount) offerCount.textContent = offers.length;
        
        // Freie Tische
        const tablesResponse = await fetch(`${SUPABASE_URL}/rest/v1/restaurants?select=free_tables&is_active=eq.true`, {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
        const tablesData = await tablesResponse.json();
        const totalFreeTables = tablesData.reduce((sum, r) => sum + (r.free_tables || 0), 0);
        
        const statTables = document.getElementById('statTables');
        if (statTables) statTables.textContent = totalFreeTables;
        
        // Kunden zählen
        const customersResponse = await fetch(`${SUPABASE_URL}/rest/v1/customers?select=id,payment_status,is_active`, {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
        const customersData = await customersResponse.json();
        
        const totalCustomers = document.getElementById('totalCustomers');
        if (totalCustomers) totalCustomers.textContent = customersData.length;
        
        const customerCount = document.getElementById('customerCount');
        if (customerCount) customerCount.textContent = customersData.length;
        
        const paidCustomers = document.getElementById('paidCustomers');
        if (paidCustomers) paidCustomers.textContent = customersData.filter(c => c.payment_status === 'paid').length;
        
        const pendingCustomers = document.getElementById('pendingCustomers');
        if (pendingCustomers) pendingCustomers.textContent = customersData.filter(c => c.payment_status === 'pending').length;
        
        const overdueCustomers = document.getElementById('overdueCustomers');
        if (overdueCustomers) overdueCustomers.textContent = customersData.filter(c => c.payment_status === 'overdue').length;
        
        // Unterkünfte zählen
        const accResponse = await fetch(`${SUPABASE_URL}/rest/v1/accommodations?select=id,has_availability`, {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
        const accData = await accResponse.json();
        
        const totalAccommodations = document.getElementById('totalAccommodations');
        if (totalAccommodations) totalAccommodations.textContent = accData.length;
        
        const statTotalAccommodations = document.getElementById('statTotalAccommodations');
        if (statTotalAccommodations) statTotalAccommodations.textContent = accData.length;
        
        const accommodationCount = document.getElementById('accommodationCount');
        if (accommodationCount) accommodationCount.textContent = accData.length;
        
        const availableAccommodations = document.getElementById('availableAccommodations');
        if (availableAccommodations) availableAccommodations.textContent = accData.filter(a => a.has_availability).length;
        
        // Events zählen
        const eventsResponse = await fetch(`${SUPABASE_URL}/rest/v1/events?select=id,is_featured,date`, {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
        const eventsData = await eventsResponse.json();
        
        const statTotalEvents = document.getElementById('statTotalEvents');
        if (statTotalEvents) statTotalEvents.textContent = eventsData.length;
        
        const upcomingEvents = eventsData.filter(e => new Date(e.date) >= new Date());
        const statUpcomingEvents = document.getElementById('statUpcomingEvents');
        if (statUpcomingEvents) statUpcomingEvents.textContent = upcomingEvents.length;
        
        const statFeaturedEvents = document.getElementById('statFeaturedEvents');
        if (statFeaturedEvents) statFeaturedEvents.textContent = eventsData.filter(e => e.is_featured).length;
        
        // Attraktionen zählen
        const attrResponse = await fetch(`${SUPABASE_URL}/rest/v1/attractions?select=id,category`, {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
        const attrData = await attrResponse.json();
        
        const statTotalAttractions = document.getElementById('statTotalAttractions');
        if (statTotalAttractions) statTotalAttractions.textContent = attrData.length;
        
        console.log('[OK] Dashboard Stats aktualisiert');
        
    } catch (e) {
        console.log('Dashboard Stats Fehler:', e);
    }
}

// Auto-Refresh: Dashboard alle 30 Sekunden aktualisieren
setInterval(() => {
    if (document.getElementById('dashboardView')?.classList.contains('active') || 
        document.querySelector('.dash-section.active')) {
        loadDashboardStats();
    }
}, 30000);

function renderReservationsPreview() {
    const container = document.getElementById('reservationsPreview');
    if (!container) return;
    
    const todayReservations = APP_DATA.reservations.filter(r => r.date === TODAY);
    
    if (todayReservations.length === 0) {
        container.innerHTML = '<p style="color: var(--slate); text-align: center; padding: 20px;">Keine Reservierungen</p>';
        return;
    }
    
    // Show only first 3
    let html = '';
    todayReservations.sort((a, b) => a.time.localeCompare(b.time)).slice(0, 3).forEach(r => {
        const statusClass = r.status === 'confirmed' ? 'confirmed' : r.status === 'cancelled' ? 'cancelled' : 'pending';
        const statusText = r.status === 'confirmed' ? 'Bestätigt' : r.status === 'cancelled' ? 'Storniert' : 'Ausstehend';
        
        html += `
            <div class="reservation-item">
                <div class="reservation-time">
                    <div class="reservation-time-value">${r.time}</div>
                </div>
                <div class="reservation-info">
                    <div class="reservation-name">${r.guestName}</div>
                    <div class="reservation-details">${r.partySize} Pers.</div>
                </div>
                <span class="reservation-status ${statusClass}">${statusText}</span>
            </div>
        `;
    });
    
    if (todayReservations.length > 3) {
        html += `<p style="text-align: center; color: var(--primary); font-weight: 600; margin-top: 12px;">+${todayReservations.length - 3} weitere</p>`;
    }
    
    container.innerHTML = html;
}

function renderActiveOffers() {
    const container = document.getElementById('activeOffersList');
    if (!container) return;
    
    if (APP_DATA.offers.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--slate);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48" style="opacity: 0.3; margin-bottom: 16px;">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
                <p>Keine aktiven Angebote</p>
                <p style="font-size: 13px; margin-top: 4px;">Erstelle dein erstes Angebot links!</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    APP_DATA.offers.forEach(offer => {
        html += `
            <div class="offer-item" style="margin-bottom: 12px;">
                <div class="offer-item-info">
                    <h5 style="font-size: 16px; margin-bottom: 4px;">${offer.title}</h5>
                    <p>${offer.discount} • Gültig bis ${offer.validUntil}</p>
                    ${offer.description ? `<p style="margin-top: 4px; font-size: 12px;">${offer.description}</p>` : ''}
                </div>
                <button class="offer-item-delete" onclick="deleteOffer(${offer.id})" title="Löschen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function addManualReservation(e) {
    e.preventDefault();
    
    const reservation = {
        id: Date.now(),
        restaurantId: 1,
        restaurantName: APP_DATA.restaurants[0]?.name || 'Restaurant',
        guestName: document.getElementById('manualGuestName').value,
        guestPhone: document.getElementById('manualGuestPhone').value || '',
        date: TODAY,
        time: document.getElementById('manualTime').value,
        partySize: document.getElementById('manualPartySize').value,
        notes: '',
        status: 'confirmed',
        source: 'phone',
        createdAt: new Date().toISOString()
    };
    
    APP_DATA.reservations.push(reservation);
    saveData();
    
    // Reset form
    document.getElementById('manualGuestName').value = '';
    document.getElementById('manualGuestPhone').value = '';
    
    renderReservations();
    renderReservationsPreview();
    updateDashboard();
    
    showToast(`Reservierung für ${reservation.guestName} hinzugefügt!`, 'success');
}

function renderTables() {
    const container = document.getElementById('tableGrid');
    let html = '';
    
    APP_DATA.tables.forEach(table => {
        html += `
            <div class="table-item ${table.status}" onclick="cycleTableStatus(${table.id})">
                <span class="table-number">${table.id}</span>
                <span class="table-seats">${table.seats} Plätze</span>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Update free tables count in guest view
    const freeTables = APP_DATA.tables.filter(t => t.status === 'free').length;
    // Update first restaurant to reflect dashboard (if exists)
    if (APP_DATA.restaurants && APP_DATA.restaurants.length > 0) {
        APP_DATA.restaurants[0].freeTables = freeTables;
    }
}

function cycleTableStatus(tableId) {
    const table = APP_DATA.tables.find(t => t.id === tableId);
    const statuses = ['free', 'reserved', 'occupied'];
    const currentIndex = statuses.indexOf(table.status);
    table.status = statuses[(currentIndex + 1) % 3];
    
    saveData();
    renderTables();
    renderRestaurants();
    
    const statusNames = { free: 'Frei', reserved: 'Reserviert', occupied: 'Besetzt' };
    showToast(`Tisch ${tableId}: ${statusNames[table.status]}`);
}

function renderReservations() {
    const container = document.getElementById('reservationsList');
    if (!container) return;
    
    const todayReservations = APP_DATA.reservations.filter(r => r.date === TODAY);
    
    // Update stats
    const dashReservationsToday = document.getElementById('dashReservationsToday');
    if (dashReservationsToday) {
        dashReservationsToday.textContent = todayReservations.length;
    }
    
    if (todayReservations.length === 0) {
        container.innerHTML = '<p style="color: var(--slate); text-align: center; padding: 20px;">Keine Reservierungen für heute</p>';
        return;
    }
    
    let html = '';
    todayReservations.sort((a, b) => a.time.localeCompare(b.time)).forEach(r => {
        const statusClass = r.status === 'confirmed' ? 'confirmed' : r.status === 'cancelled' ? 'cancelled' : 'pending';
        const statusText = r.status === 'confirmed' ? 'Bestätigt' : r.status === 'cancelled' ? 'Storniert' : 'Ausstehend';
        
        // Prepare WhatsApp message for guest
        const guestPhone = r.guestPhone ? r.guestPhone.replace(/[^0-9]/g, '') : '';
        const confirmMessage = `Hallo ${r.guestName}!

Ihre Reservierung ist bestätigt:

Heute um ${r.time} Uhr
${r.partySize} Personen

Wir freuen uns auf Sie!`;
        
        html += `
            <div class="reservation-item">
                <div class="reservation-time">
                    <div class="reservation-time-value">${r.time}</div>
                    <div class="reservation-time-label">Heute</div>
                </div>
                <div class="reservation-info">
                    <div class="reservation-name">${r.guestName}</div>
                    <div class="reservation-details">${r.partySize} Personen • via ${r.source === 'app' ? 'App' : 'Telefon'}${r.notes ? ' • ' + r.notes : ''}</div>
                    ${r.guestPhone ? `<div class="reservation-details" style="margin-top: 2px; font-size: 12px;">${r.guestPhone}</div>` : ''}
                </div>
                ${r.status === 'pending' ? `
                    <div class="reservation-actions">
                        <button class="reservation-btn confirm" onclick="updateReservation('${r.id}', 'confirmed')" title="Bestätigen">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </button>
                        ${guestPhone ? `
                            <a href="https://wa.me/${guestPhone}?text=${encodeURIComponent(confirmMessage)}" target="_blank" class="reservation-btn" style="background: rgba(37,211,102,0.15); color: #25D366;" title="WhatsApp Bestätigung senden">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/>
                                </svg>
                            </a>
                        ` : ''}
                        <button class="reservation-btn cancel" onclick="updateReservation('${r.id}', 'cancelled')" title="Stornieren">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                ` : `
                    <span class="reservation-status ${statusClass}">${statusText}</span>
                `}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

async function updateReservation(id, status) {
    // Lokal aktualisieren
    const reservation = APP_DATA.reservations.find(r => r.id == id);
    if (reservation) {
        reservation.status = status;
        saveData();
        renderReservations();
        renderReservationsPreview();
        
        // In Supabase aktualisieren
        if (useSupabase) {
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/reservations?id=eq.${id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_KEY,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ status: status })
                });
                console.log('[OK] Reservierung in Supabase aktualisiert');
            } catch (e) {
                console.error('Fehler beim Aktualisieren:', e);
            }
        }
        
        if (status === 'confirmed') {
            showToast(`Reservierung für ${reservation.guestName} bestätigt!`, 'success');
        } else {
            showToast(`Reservierung für ${reservation.guestName} storniert`, 'error');
        }
    }
}

function toggleRestaurant() {
    APP_DATA.restaurantOpen = !APP_DATA.restaurantOpen;
    saveData();
    updateRestaurantStatus();
    showToast(APP_DATA.restaurantOpen ? 'Restaurant geöffnet' : 'Restaurant geschlossen');
}

function updateRestaurantStatus() {
    const toggle = document.getElementById('restaurantToggle');
    const indicator = document.getElementById('restaurantStatus');
    const text = document.getElementById('restaurantStatusText');
    
    if (APP_DATA.restaurantOpen) {
        toggle.classList.remove('off');
        indicator.classList.remove('closed');
        text.textContent = 'Restaurant offen';
    } else {
        toggle.classList.add('off');
        indicator.classList.add('closed');
        text.textContent = 'Restaurant geschlossen';
    }
}

// ==================== OFFER FUNCTIONS ====================
function createOffer(e) {
    e.preventDefault();
    
    const titleEl = document.getElementById('offerTitle');
    const discountEl = document.getElementById('offerDiscount');
    const validUntilEl = document.getElementById('offerValidUntil');
    const descEl = document.getElementById('offerDescription');
    
    if (!titleEl.value || !discountEl.value || !validUntilEl.value) {
        showToast('Bitte alle Pflichtfelder ausfüllen', 'error');
        return;
    }
    
    const offer = {
        id: Date.now(),
        title: titleEl.value,
        discount: discountEl.value,
        validUntil: validUntilEl.value,
        description: descEl.value,
        createdAt: new Date().toISOString()
    };
    
    APP_DATA.offers.push(offer);
    saveData();
    
    // In Supabase speichern
    saveOfferToSupabase(offer);
    
    // Reset form
    titleEl.value = '';
    discountEl.value = '';
    validUntilEl.value = '';
    descEl.value = '';
    
    const previewTitle = document.getElementById('previewTitle');
    const previewDiscount = document.getElementById('previewDiscount');
    if (previewTitle) previewTitle.textContent = 'Dein Angebot';
    if (previewDiscount) previewDiscount.textContent = 'Rabatt bis --:--';
    
    renderOffers();
    renderActiveOffers();
    renderRestaurants();
    updateDashboard();
    showToast('Angebot veröffentlicht!', 'success');
}

async function deleteOffer(id) {
    APP_DATA.offers = APP_DATA.offers.filter(o => o.id != id);
    saveData();
    
    // In Supabase löschen (deaktivieren)
    if (useSupabase) {
        try {
            await fetch(`${SUPABASE_URL}/rest/v1/offers?id=eq.${id}`, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({ is_active: false })
            });
            console.log('[OK] Angebot in Supabase gelöscht');
        } catch (e) {
            console.error('Fehler beim Löschen:', e);
        }
    }
    
    renderOffers();
    renderActiveOffers();
    renderRestaurants();
    updateDashboard();
    showToast('Angebot gelöscht');
}

function renderOffers() {
    const container = document.getElementById('activeOffers');
    if (!container) return;
    
    if (APP_DATA.offers.length === 0) {
        container.innerHTML = '<h4>Aktive Angebote</h4><p style="color: var(--slate); font-size: 13px;">Keine aktiven Angebote</p>';
        return;
    }
    
    let html = '<h4>Aktive Angebote</h4>';
    APP_DATA.offers.forEach(offer => {
        html += `
            <div class="offer-item">
                <div class="offer-item-info">
                    <h5>${offer.title}</h5>
                    <p>${offer.discount} bis ${offer.validUntil}</p>
                </div>
                <button class="offer-item-delete" onclick="deleteOffer(${offer.id})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ==================== RESET FUNCTION ====================
function resetAllData() {
    if (confirm('Alle Demo-Daten zurücksetzen?')) {
        localStorage.removeItem('kmi_favorites');
        localStorage.removeItem('kmi_reservations');
        localStorage.removeItem('kmi_offers');
        localStorage.removeItem('kmi_tables');
        localStorage.removeItem('kmi_restaurant_open');
        localStorage.removeItem('kmi_restaurants');
        location.reload();
    }
}

// ==================== REWARDS SYSTEM (Restaurant) ====================
let restaurantRewards = [];

async function loadRestaurantRewards() {
    const restaurantId = currentAdmin?.restaurant_id;
    if (!restaurantId) return;
    
    try {
        const { data, error } = await window.supabaseClient
            .from('rewards')
            .select('*')
            .eq('restaurant_id', restaurantId)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        restaurantRewards = data || [];
        renderRestaurantRewards();
        loadRedemptions();
    } catch (e) {
        console.error('Rewards laden fehlgeschlagen:', e);
        // Demo-Daten
        restaurantRewards = [];
        renderRestaurantRewards();
    }
}

function renderRestaurantRewards() {
    const container = document.getElementById('rewardsList');
    if (!container) return;
    
    if (restaurantRewards.length === 0) {
        container.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--slate);">
                <div style="width: 64px; height: 64px; margin: 0 auto 16px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    ${getRewardIconSvg('gift', 32)}
                </div>
                <p>Noch keine Belohnungen erstellt</p>
                <p style="font-size: 13px; margin-top: 8px;">Erstelle deine erste Belohnung um Stammkunden zu gewinnen!</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    restaurantRewards.forEach(r => {
        const statusBadge = r.is_active 
            ? '<span style="background: #34c759; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">Aktiv</span>'
            : '<span style="background: var(--slate); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">Inaktiv</span>';
        
        const redemptionInfo = r.max_redemptions 
            ? `${r.current_redemptions || 0}/${r.max_redemptions} eingelöst`
            : `${r.current_redemptions || 0}x eingelöst`;
        
        const iconHtml = `<div style="width: 44px; height: 44px; background: var(--bg-secondary); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 16px;">${getRewardIconSvg(r.icon || 'gift', 24)}</div>`;
        
        html += `
            <div style="display: flex; align-items: center; padding: 16px; border-bottom: 1px solid var(--border-color);">
                ${iconHtml}
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <strong>${r.title}</strong>
                        ${statusBadge}
                    </div>
                    <div style="font-size: 13px; color: var(--slate);">
                        ${r.points_required} Pkt. • ${redemptionInfo}
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="toggleRewardActive('${r.id}', ${!r.is_active})" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">
                        ${r.is_active ? 'Pause' : 'Aktiv'}
                    </button>
                    <button onclick="deleteReward('${r.id}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; color: #ff3b30;">
                        Löschen
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

async function saveReward(e) {
    e.preventDefault();
    
    const restaurantId = currentAdmin?.restaurant_id;
    if (!restaurantId) {
        showToast('Bitte erst Restaurant auswählen', 'error');
        return;
    }
    
    const reward = {
        restaurant_id: restaurantId,
        icon: document.getElementById('rewardIcon').value,
        title: document.getElementById('rewardTitle').value,
        description: document.getElementById('rewardDescription').value,
        points_required: parseInt(document.getElementById('rewardPoints').value),
        reward_type: document.getElementById('rewardType').value,
        discount_percent: document.getElementById('rewardType').value === 'discount' 
            ? parseInt(document.getElementById('rewardDiscount').value) : null,
        max_redemptions: document.getElementById('rewardMaxRedemptions').value 
            ? parseInt(document.getElementById('rewardMaxRedemptions').value) : null,
        is_active: true
    };
    
    try {
        const { data, error } = await window.supabaseClient
            .from('rewards')
            .insert([reward])
            .select();
        
        if (error) throw error;
        
        showToast('Belohnung erstellt!', 'success');
        closeModal('addRewardModal');
        document.getElementById('addRewardForm').reset();
        loadRestaurantRewards();
    } catch (e) {
        console.error('Speichern fehlgeschlagen:', e);
        showToast('Fehler beim Speichern', 'error');
    }
}

async function toggleRewardActive(rewardId, isActive) {
    try {
        const { error } = await window.supabaseClient
            .from('rewards')
            .update({ is_active: isActive })
            .eq('id', rewardId);
        
        if (error) throw error;
        
        showToast(isActive ? 'Belohnung aktiviert' : 'Belohnung pausiert', 'success');
        loadRestaurantRewards();
    } catch (e) {
        showToast('Fehler beim Aktualisieren', 'error');
    }
}

async function deleteReward(rewardId) {
    if (!confirm('Belohnung wirklich löschen?')) return;
    
    try {
        const { error } = await window.supabaseClient
            .from('rewards')
            .delete()
            .eq('id', rewardId);
        
        if (error) throw error;
        
        showToast('Belohnung gelöscht', 'success');
        loadRestaurantRewards();
    } catch (e) {
        showToast('Fehler beim Löschen', 'error');
    }
}

function selectRewardIcon(btn) {
    document.querySelectorAll('.reward-icon-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('rewardIcon').value = btn.dataset.icon;
}

// SVG Icons für Belohnungen
const REWARD_ICONS = {
    coffee: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>',
    cake: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1"/><path d="M2 21h20"/></svg>',
    percent: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>',
    utensils: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/></svg>',
    gift: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>',
    star: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
    award: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>',
    crown: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg>'
};

function getRewardIconSvg(iconName, size = 24) {
    const icon = REWARD_ICONS[iconName] || REWARD_ICONS.gift;
    return icon.replace(/width="24"/g, `width="${size}"`).replace(/height="24"/g, `height="${size}"`);
}

function toggleDiscountField() {
    const type = document.getElementById('rewardType').value;
    document.getElementById('discountField').style.display = type === 'discount' ? 'block' : 'none';
}

// Einlösungen laden (für Restaurant Dashboard)
async function loadRedemptions() {
    const restaurantId = currentAdmin?.restaurant_id;
    if (!restaurantId) return;
    
    try {
        const { data, error } = await window.supabaseClient
            .from('reward_redemptions')
            .select('*, rewards!inner(title, icon, restaurant_id)')
            .eq('rewards.restaurant_id', restaurantId)
            .order('redeemed_at', { ascending: false })
            .limit(50);
        
        if (error) throw error;
        renderRedemptions(data || []);
    } catch (e) {
        console.error('Einlösungen laden fehlgeschlagen:', e);
    }
}

function renderRedemptions(redemptions) {
    const container = document.getElementById('redemptionsList');
    const countEl = document.getElementById('pendingRedemptionsCount');
    if (!container) return;
    
    const pending = redemptions.filter(r => r.status === 'pending');
    if (countEl) countEl.textContent = `${pending.length} offen`;
    
    if (redemptions.length === 0) {
        container.innerHTML = '<p style="padding: 20px; color: var(--slate); text-align: center;">Keine Einlösungen vorhanden</p>';
        return;
    }
    
    let html = '';
    redemptions.forEach(r => {
        const statusColors = {
            pending: '#ff9500',
            confirmed: '#34c759',
            expired: '#8e8e93',
            cancelled: '#ff3b30'
        };
        const statusLabels = {
            pending: 'Offen',
            confirmed: 'Bestätigt',
            expired: 'Abgelaufen',
            cancelled: 'Storniert'
        };
        
        const date = new Date(r.redeemed_at).toLocaleDateString('de-DE', { 
            day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' 
        });
        
        html += `
            <div style="display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border-color);">
                <div style="font-size: 24px; margin-right: 12px;">${r.rewards?.icon || '🎁'}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600;">${r.rewards?.title || 'Belohnung'}</div>
                    <div style="font-size: 12px; color: var(--slate);">
                        ${r.user_name || 'Gast'} • Code: <strong>${r.redemption_code}</strong>
                    </div>
                    <div style="font-size: 11px; color: var(--slate);">${date}</div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px;">
                    <span style="background: ${statusColors[r.status]}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                        ${statusLabels[r.status]}
                    </span>
                    ${r.status === 'pending' ? `
                        <button onclick="confirmRedemption('${r.id}')" class="btn btn-primary" style="padding: 4px 12px; font-size: 11px;">
                            ✓ Bestätigen
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

async function confirmRedemption(redemptionId) {
    try {
        const { error } = await window.supabaseClient
            .from('reward_redemptions')
            .update({ 
                status: 'confirmed',
                confirmed_at: new Date().toISOString()
            })
            .eq('id', redemptionId);
        
        if (error) throw error;
        
        showToast('Einlösung bestätigt! ✓', 'success');
        loadRedemptions();
    } catch (e) {
        showToast('Fehler beim Bestätigen', 'error');
    }
}

// ==================== REWARDS FÜR GÄSTE ====================
async function loadAvailableRewards() {
    document.getElementById('availableRewardsPoints').textContent = userPoints;
    const container = document.getElementById('availableRewardsList');
    
    try {
        const { data, error } = await window.supabaseClient
            .from('rewards')
            .select('*, restaurants(name, city)')
            .eq('is_active', true)
            .order('points_required', { ascending: true });
        
        if (error) throw error;
        
        if (!data || data.length === 0) {
            container.innerHTML = `
                <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                    <div style="width: 64px; height: 64px; margin: 0 auto 16px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        ${getRewardIconSvg('gift', 32)}
                    </div>
                    <p>Noch keine Belohnungen verfügbar</p>
                    <p style="font-size: 13px; margin-top: 8px;">Schau später nochmal vorbei!</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        data.forEach(r => {
            const canRedeem = userPoints >= r.points_required;
            const restaurantName = r.restaurants?.name || 'Restaurant';
            const city = r.restaurants?.city ? ` • ${r.restaurants.city}` : '';
            const iconHtml = `<div style="width: 48px; height: 48px; background: var(--bg-secondary); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 16px;">${getRewardIconSvg(r.icon || 'gift', 24)}</div>`;
            
            html += `
                <div style="display: flex; align-items: center; padding: 16px; border: 2px solid ${canRedeem ? 'var(--primary)' : 'var(--border-color)'}; border-radius: 12px; margin-bottom: 12px; ${canRedeem ? '' : 'opacity: 0.6;'}">
                    ${iconHtml}
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 2px;">${r.title}</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">@ ${restaurantName}${city}</div>
                        <div style="font-size: 14px; color: var(--primary); font-weight: 600; margin-top: 4px;">${r.points_required} Punkte</div>
                    </div>
                    <button 
                        onclick="redeemReward('${r.id}')" 
                        class="btn ${canRedeem ? 'btn-primary' : 'btn-secondary'}" 
                        style="padding: 8px 16px;"
                        ${canRedeem ? '' : 'disabled'}
                    >
                        ${canRedeem ? 'Einlösen' : 'Gesperrt'}
                    </button>
                </div>
            `;
        });
        
        container.innerHTML = html;
    } catch (e) {
        console.error('Rewards laden fehlgeschlagen:', e);
        container.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--text-secondary);">Fehler beim Laden</p>';
    }
}

async function redeemReward(rewardId) {
    if (!confirm('Belohnung wirklich einlösen?')) return;
    
    try {
        const { data, error } = await window.supabaseClient
            .rpc('redeem_reward', {
                p_reward_id: rewardId,
                p_session: SESSION_ID,
                p_user_name: localStorage.getItem('kmi_guest_name') || null,
                p_user_email: localStorage.getItem('kmi_guest_email') || null
            });
        
        if (error) throw error;
        
        if (data?.success) {
            // Code anzeigen
            document.getElementById('redemptionCode').textContent = data.code;
            document.getElementById('redeemedRewardTitle').textContent = data.reward;
            
            // Restaurant Name laden
            const { data: restData } = await window.supabaseClient
                .from('restaurants')
                .select('name')
                .eq('id', data.restaurant_id)
                .single();
            
            document.getElementById('redeemedRewardRestaurant').textContent = `@ ${restData?.name || 'Restaurant'}`;
            
            // Lokale Punkte aktualisieren
            await syncUserPoints();
            
            closeModal('availableRewardsModal');
            openModal('redeemCodeModal');
            
            showToast('Belohnung eingelöst!', 'success');
        } else {
            showToast(data?.error || 'Einlösen fehlgeschlagen', 'error');
        }
    } catch (e) {
        console.error('Einlösen fehlgeschlagen:', e);
        showToast('Fehler beim Einlösen', 'error');
    }
}

function copyRedemptionCode() {
    const code = document.getElementById('redemptionCode').textContent;
    navigator.clipboard.writeText(code).then(() => {
        showToast('Code kopiert! 📋', 'success');
    });
}

// Punkte mit Server synchronisieren
async function syncUserPoints() {
    try {
        const { data, error } = await window.supabaseClient
            .from('user_points')
            .select('total_points, level')
            .eq('user_session', SESSION_ID)
            .single();
        
        if (data) {
            userPoints = data.total_points;
            userLevel = data.level;
            localStorage.setItem('kmi_points', userPoints.toString());
            localStorage.setItem('kmi_level', userLevel);
            updatePointsDisplay();
        }
    } catch (e) {
        // Fallback zu lokalen Punkten
    }
}

// Points Modal öffnen - mit Belohnungen Button
function openPointsModal() {
    document.getElementById('pointsModalTotal').textContent = userPoints;
    updateLevelProgress();
    openModal('pointsModal');
}

function updateLevelProgress() {
    const levels = ['bronze', 'silver', 'gold', 'platinum', 'diamond'];
    const thresholds = [0, 500, 1500, 3000, 5000];
    
    const currentIdx = levels.indexOf(userLevel);
    const nextIdx = Math.min(currentIdx + 1, levels.length - 1);
    
    const currentThreshold = thresholds[currentIdx];
    const nextThreshold = thresholds[nextIdx];
    
    const progress = currentIdx === levels.length - 1 
        ? 100 
        : ((userPoints - currentThreshold) / (nextThreshold - currentThreshold)) * 100;
    
    const progressBar = document.getElementById('levelProgress');
    if (progressBar) progressBar.style.width = Math.min(progress, 100) + '%';
    
    const currentLabel = document.getElementById('currentLevelLabel');
    const nextLabel = document.getElementById('nextLevelLabel');
    if (currentLabel) currentLabel.textContent = LEVELS[userLevel].name;
    if (nextLabel) nextLabel.textContent = currentIdx < levels.length - 1 
        ? `${LEVELS[levels[nextIdx]].name} (${nextThreshold})` 
        : 'Max Level erreicht!';
}

// ==================== GEZEITEN SYSTEM ====================
// Gezeiten für Norderney/Greetsiel Bereich (vereinfacht)
let tideData = {
    highTide: null,
    lowTide: null,
    nextHigh: null,
    nextLow: null,
    currentLevel: 50 // 0-100%
};

function initTides() {
    updateTideData();
    setInterval(updateTideData, 60000); // Jede Minute aktualisieren
}

function updateTideData() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const currentTime = hours * 60 + minutes;
    
    // Vereinfachte Gezeitenberechnung (ca. 12h 25min Zyklus)
    // Basierend auf typischen Nordsee-Gezeiten
    const tidalCycle = 745; // 12h 25min in Minuten
    const dayStart = 0;
    
    // Simulierte Hochwasser-Zeiten (2x täglich, verschiebt sich ~50min pro Tag)
    const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    const baseHighTide = (dayOfYear * 50) % tidalCycle; // Verschiebung pro Tag
    
    const highTide1 = baseHighTide % (24 * 60);
    const highTide2 = (baseHighTide + tidalCycle) % (24 * 60);
    const lowTide1 = (baseHighTide + tidalCycle / 2) % (24 * 60);
    const lowTide2 = (baseHighTide + tidalCycle * 1.5) % (24 * 60);
    
    // Nächste Gezeiten finden
    const tides = [
        { type: 'high', time: highTide1 },
        { type: 'high', time: highTide2 },
        { type: 'low', time: lowTide1 },
        { type: 'low', time: lowTide2 }
    ].sort((a, b) => a.time - b.time);
    
    // Aktuelle Position im Zyklus
    let nextTide = tides.find(t => t.time > currentTime) || tides[0];
    let prevTide = tides.filter(t => t.time <= currentTime).pop() || tides[tides.length - 1];
    
    // Wasserstand berechnen (0-100%)
    const cyclePosition = (currentTime - prevTide.time) / (nextTide.time - prevTide.time || 1);
    
    if (nextTide.type === 'high') {
        tideData.currentLevel = 20 + (cyclePosition * 80); // Steigt
        tideData.status = 'rising';
    } else {
        tideData.currentLevel = 100 - (cyclePosition * 80); // Fällt
        tideData.status = 'falling';
    }
    
    // Zeiten formatieren
    const formatTime = (mins) => {
        const h = Math.floor(mins / 60) % 24;
        const m = mins % 60;
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    };
    
    tideData.nextHigh = formatTime(tides.find(t => t.type === 'high' && t.time > currentTime)?.time || highTide1);
    tideData.nextLow = formatTime(tides.find(t => t.type === 'low' && t.time > currentTime)?.time || lowTide1);
    
    // UI aktualisieren
    updateTideUI();
}

function updateTideUI() {
    const t = translations[currentLanguage] || translations.de;
    
    const waveEl = document.getElementById('tideWave');
    const statusEl = document.getElementById('tideStatus');
    const highEl = document.getElementById('tideHigh');
    const lowEl = document.getElementById('tideLow');
    const nowTimeEl = document.getElementById('tideNowTime');
    const suggestionsEl = document.getElementById('tideSuggestions');
    
    if (waveEl) waveEl.style.height = tideData.currentLevel + '%';
    
    const now = new Date();
    if (nowTimeEl) nowTimeEl.textContent = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
    if (highEl) highEl.textContent = tideData.nextHigh;
    if (lowEl) lowEl.textContent = tideData.nextLow;
    
    if (statusEl) {
        if (tideData.status === 'rising') {
            statusEl.textContent = currentLanguage === 'en' ? 'Tide rising' : (currentLanguage === 'nl' ? 'Vloed stijgt' : 'Flut steigt');
            statusEl.style.background = 'rgba(52, 199, 89, 0.3)';
        } else {
            statusEl.textContent = currentLanguage === 'en' ? 'Tide falling' : (currentLanguage === 'nl' ? 'Eb daalt' : 'Ebbe fällt');
            statusEl.style.background = 'rgba(255, 149, 0, 0.3)';
        }
    }
    
    // Aktivitäts-Empfehlungen
    const infoIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="margin-right: 4px; flex-shrink: 0;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>';
    if (suggestionsEl) {
        if (tideData.currentLevel > 70) {
            suggestionsEl.innerHTML = infoIcon + '<span><strong>Perfekt jetzt:</strong> Hafenrundfahrt, Restaurants am Wasser, Schiffstouren</span>';
        } else if (tideData.currentLevel > 40) {
            suggestionsEl.innerHTML = infoIcon + '<span><strong>Empfohlen:</strong> Strandspaziergang, Krabbenpulen lernen</span>';
        } else {
            suggestionsEl.innerHTML = infoIcon + '<span><strong>Ideal für:</strong> Wattwanderung, Muscheln sammeln, Wattführung</span>';
        }
    }
}

// ==================== GAMIFICATION SYSTEM ====================
let userPoints = parseInt(localStorage.getItem('kmi_points') || '0');
let userLevel = localStorage.getItem('kmi_level') || 'bronze';
let userAchievements = JSON.parse(localStorage.getItem('kmi_achievements') || '[]');

const POINTS_CONFIG = {
    reservation: 50,
    review: 100,
    photoUpload: 30,
    firstVisit: 20,
    shareApp: 200,
    inviteFriend: 300,
    fiveReservations: 250,
    tenReviews: 500
};

const LEVELS = {
    bronze: { min: 0, name: 'Bronze', icon: '🥉' },
    silver: { min: 500, name: 'Silber', icon: '🥈' },
    gold: { min: 1500, name: 'Gold', icon: '🥇' },
    platinum: { min: 3000, name: 'Platin', icon: '💎' },
    diamond: { min: 5000, name: 'Diamant', icon: '👑' }
};

const ACHIEVEMENTS = [
    { id: 'first_reservation', name: 'Erste Reservierung', icon: '🍽️', points: 50, desc: 'Erste Tischreservierung gemacht' },
    { id: 'first_review', name: 'Kritiker', icon: '⭐', points: 100, desc: 'Erste Bewertung geschrieben' },
    { id: 'photo_star', name: 'Foto-Star', icon: '📸', points: 150, desc: '5 Fotos hochgeladen' },
    { id: 'explorer', name: 'Entdecker', icon: '🗺️', points: 200, desc: '10 verschiedene Restaurants besucht' },
    { id: 'local_hero', name: 'Local Hero', icon: '🦸', points: 500, desc: '50 Bewertungen geschrieben' },
    { id: 'tide_master', name: 'Gezeiten-Meister', icon: '🌊', points: 100, desc: 'App bei Ebbe UND Flut genutzt' }
];

function addPoints(amount, reason) {
    userPoints += amount;
    localStorage.setItem('kmi_points', userPoints.toString());
    
    // Level prüfen
    updateLevel();
    
    // UI aktualisieren
    updatePointsDisplay();
    
    // Toast zeigen
    showToast(`+${amount} 🌟 ${reason}`, 'success');
    
    // Konfetti bei Level-Up
    if (checkLevelUp()) {
        showLevelUpCelebration();
    }
}

function updateLevel() {
    let newLevel = 'bronze';
    for (const [level, config] of Object.entries(LEVELS)) {
        if (userPoints >= config.min) {
            newLevel = level;
        }
    }
    
    if (newLevel !== userLevel) {
        userLevel = newLevel;
        localStorage.setItem('kmi_level', userLevel);
        return true; // Level Up!
    }
    return false;
}

function checkLevelUp() {
    return updateLevel();
}

function updatePointsDisplay() {
    const pointsEl = document.getElementById('userPoints');
    const levelEl = document.getElementById('userLevel');
    
    if (pointsEl) pointsEl.textContent = userPoints;
    if (levelEl) {
        levelEl.textContent = LEVELS[userLevel].icon + ' ' + LEVELS[userLevel].name;
        levelEl.className = `level-badge level-${userLevel}`;
    }
}

function unlockAchievement(achievementId) {
    if (userAchievements.includes(achievementId)) return;
    
    const achievement = ACHIEVEMENTS.find(a => a.id === achievementId);
    if (!achievement) return;
    
    userAchievements.push(achievementId);
    localStorage.setItem('kmi_achievements', JSON.stringify(userAchievements));
    
    // Punkte hinzufügen
    addPoints(achievement.points, achievement.name);
    
    // Achievement Popup
    showAchievementPopup(achievement);
}

function showAchievementPopup(achievement) {
    const popup = document.createElement('div');
    popup.className = 'achievement-popup';
    popup.innerHTML = `
        <div class="achievement-icon">${achievement.icon}</div>
        <h3 style="margin: 0 0 8px; font-size: 24px;">Achievement freigeschaltet!</h3>
        <p style="font-size: 18px; font-weight: 600; margin: 0 0 8px;">${achievement.name}</p>
        <p style="color: var(--text-secondary); margin: 0 0 16px;">${achievement.desc}</p>
        <div style="color: #ffd700; font-size: 20px; font-weight: 700;">+${achievement.points} 🌟</div>
    `;
    
    document.body.appendChild(popup);
    
    // Sound abspielen (optional)
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2JjoyMi4eCenZ4');
        audio.volume = 0.3;
        audio.play().catch(() => {});
    } catch (e) {}
    
    // Nach 3 Sekunden entfernen
    setTimeout(() => {
        popup.style.animation = 'achievementPop 0.3s ease reverse forwards';
        setTimeout(() => popup.remove(), 300);
    }, 3000);
}

function showLevelUpCelebration() {
    const level = LEVELS[userLevel];
    
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;';
    overlay.innerHTML = `
        <div style="text-align: center; color: white; animation: achievementPop 0.5s ease;">
            <div style="font-size: 100px; margin-bottom: 24px;">${level.icon}</div>
            <h2 style="font-size: 36px; margin: 0 0 12px;">LEVEL UP!</h2>
            <p style="font-size: 24px; opacity: 0.9;">Du bist jetzt ${level.name}!</p>
        </div>
    `;
    
    document.body.appendChild(overlay);
    overlay.onclick = () => overlay.remove();
    
    setTimeout(() => overlay.remove(), 4000);
}

// ==================== ÜBERRASCHUNGS-MODUS ====================
function surpriseMe() {
    const restaurants = APP_DATA.restaurants.filter(r => r.freeTables > 0);
    
    if (restaurants.length === 0) {
        showToast('Keine verfügbaren Restaurants gefunden', 'error');
        return;
    }
    
    // Zufälliges Restaurant
    const random = restaurants[Math.floor(Math.random() * restaurants.length)];
    
    // Loading Overlay zeigen
    const overlay = document.createElement('div');
    overlay.id = 'surpriseOverlay';
    overlay.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;';
    overlay.innerHTML = `
        <div style="text-align: center; color: white;">
            <div style="font-size: 24px; margin-bottom: 16px;" id="surpriseText">Suche Restaurant...</div>
            <div style="width: 200px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; overflow: hidden;">
                <div style="width: 0%; height: 100%; background: white; border-radius: 2px; animation: loadBar 1.5s ease forwards;"></div>
            </div>
        </div>
        <style>
            @keyframes loadBar { to { width: 100%; } }
        </style>
    `;
    document.body.appendChild(overlay);
    
    // Slot-Machine Effekt
    let count = 0;
    const textEl = overlay.querySelector('#surpriseText');
    const interval = setInterval(() => {
        const temp = restaurants[Math.floor(Math.random() * restaurants.length)];
        textEl.textContent = temp.name;
        count++;
        
        if (count > 12) {
            clearInterval(interval);
            textEl.innerHTML = `<div style="font-size: 18px; opacity: 0.7; margin-bottom: 8px;">Perfekt für dich:</div><div style="font-size: 28px; font-weight: 700;">${random.name}</div>`;
            
            // Nach 2 Sekunden Reservierung öffnen
            setTimeout(() => {
                overlay.remove();
                openReservation(random.id);
            }, 1500);
        }
    }, 100);
    
    // Punkte für Abenteuer
    addPoints(10, 'Abenteurer!');
}

function createConfetti() {
    const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd'];
    
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.style.cssText = `
            position: fixed;
            width: 10px;
            height: 10px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            top: -10px;
            left: ${Math.random() * 100}%;
            z-index: 10000;
            pointer-events: none;
            border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
            animation: confettiFall ${2 + Math.random() * 2}s linear forwards;
        `;
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 4000);
    }
    
    // Confetti Animation CSS hinzufügen wenn nicht vorhanden
    if (!document.getElementById('confettiStyle')) {
        const style = document.createElement('style');
        style.id = 'confettiStyle';
        style.textContent = `
            @keyframes confettiFall {
                to {
                    transform: translateY(100vh) rotate(720deg);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    }
}

// ==================== BESTE ZEIT VORHERSAGE ====================
function getBestTime(restaurantId) {
    // Simulierte Daten (in Produktion: echte Analytics)
    const hours = [];
    for (let h = 11; h <= 22; h++) {
        const busyness = Math.sin((h - 11) / 11 * Math.PI) * 70 + 30 + Math.random() * 20;
        hours.push({ hour: h, busyness: Math.min(100, busyness) });
    }
    
    const bestHour = hours.reduce((best, h) => h.busyness < best.busyness ? h : best, hours[0]);
    
    return {
        hours,
        bestTime: bestHour.hour,
        currentBusyness: hours.find(h => h.hour === new Date().getHours())?.busyness || 50
    };
}

// ==================== WARTEZEIT TRACKER ====================
function getWaitTime(restaurantId) {
    const restaurant = APP_DATA.restaurants.find(r => r.id === restaurantId);
    if (!restaurant) return null;
    
    // Simuliert basierend auf freien Tischen
    const occupancy = ((restaurant.totalTables - restaurant.freeTables) / restaurant.totalTables) * 100;
    
    let waitMinutes = 0;
    let status = 'low';
    
    if (occupancy > 90) {
        waitMinutes = 20 + Math.floor(Math.random() * 20);
        status = 'high';
    } else if (occupancy > 70) {
        waitMinutes = 10 + Math.floor(Math.random() * 10);
        status = 'medium';
    } else if (occupancy > 50) {
        waitMinutes = 5;
        status = 'low';
    }
    
    return { waitMinutes, occupancy, status };
}

// ==================== GRUPPEN-RESERVIERUNG ====================
let groupSession = null;
let currentGroupData = JSON.parse(localStorage.getItem('kmi_group') || 'null');

function openGroupReservationModal() {
    // Datum auf heute setzen
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('groupDate');
    if (dateInput) {
        dateInput.value = today;
        dateInput.min = today;
    }
    
    // Prüfen ob aktive Gruppe existiert
    if (currentGroupData) {
        document.getElementById('activeGroupSection').style.display = 'block';
        document.getElementById('activeGroupName').textContent = currentGroupData.name;
        document.getElementById('activeGroupMembers').textContent = (currentGroupData.size || currentGroupData.members?.length || 1) + ' Personen';
        const dateTimeEl = document.getElementById('activeGroupDateTime');
        if (dateTimeEl && currentGroupData.formattedDate) {
            dateTimeEl.textContent = '📅 ' + currentGroupData.formattedDate + ' um ' + currentGroupData.time + ' Uhr';
        }
        renderGroupVoting();
    } else {
        document.getElementById('activeGroupSection').style.display = 'none';
    }
    openModal('groupReservationModal');
}

function createNewGroup() {
    const name = document.getElementById('groupName').value || 'Meine Gruppe';
    const size = parseInt(document.getElementById('groupSize').value) || 6;
    const date = document.getElementById('groupDate').value || new Date().toISOString().split('T')[0];
    const time = document.getElementById('groupTime').value || '18:00';
    
    const sessionId = 'grp_' + Math.random().toString(36).substr(2, 9);
    
    // Datum formatieren
    const dateObj = new Date(date);
    const formattedDate = dateObj.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' });
    
    currentGroupData = {
        id: sessionId,
        name: name,
        size: size,
        date: date,
        time: time,
        formattedDate: formattedDate,
        creator: localStorage.getItem('kmi_guest_name') || 'Anonym',
        members: [localStorage.getItem('kmi_guest_name') || 'Du'],
        votes: {},
        myVotes: [],
        restaurants: [],
        createdAt: new Date().toISOString()
    };
    
    // In localStorage speichern (für alle Teilnehmer abrufbar)
    const savedGroups = JSON.parse(localStorage.getItem('kmi_groups') || '{}');
    savedGroups[sessionId] = currentGroupData;
    localStorage.setItem('kmi_groups', JSON.stringify(savedGroups));
    localStorage.setItem('kmi_group', JSON.stringify(currentGroupData));
    
    // Link teilen
    shareGroupLink();
    
    // UI aktualisieren
    document.getElementById('activeGroupSection').style.display = 'block';
    document.getElementById('activeGroupName').textContent = name;
    document.getElementById('activeGroupMembers').textContent = size + ' Personen';
    document.getElementById('activeGroupDateTime').textContent = '📅 ' + formattedDate + ' um ' + time + ' Uhr';
    
    showToast('Gruppe erstellt! Teile den Link!', 'success');
    addPoints(50, 'Gruppenplaner');
}

function shareGroupLink() {
    if (!currentGroupData) {
        showToast('Keine Gruppe vorhanden', 'error');
        return;
    }
    
    const link = `${window.location.origin}?group=${currentGroupData.id}`;
    
    // Text zusammenbauen
    let text = `Hey! 🍽️\n\n`;
    text += `Wir planen: "${currentGroupData.name || 'Gemeinsames Essen'}"\n`;
    if (currentGroupData.formattedDate) {
        text += `📅 ${currentGroupData.formattedDate}\n`;
    }
    if (currentGroupData.time) {
        text += `🕐 ${currentGroupData.time} Uhr\n`;
    }
    text += `👥 ${currentGroupData.size || 6} Personen\n\n`;
    text += `Stimm hier ab wo wir hingehen:\n${link}`;
    
    if (navigator.share) {
        navigator.share({
            title: currentGroupData.name || 'Gruppenessen',
            text: text,
            url: link
        });
    } else {
        // WhatsApp Fallback
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
    }
}

function renderGroupVoting() {
    const container = document.getElementById('groupVotingList');
    const modalContainer = document.getElementById('groupVotingListModal');
    if (!currentGroupData) return;
    
    // Gruppen-Infos im Modal anzeigen
    const nameEl = document.getElementById('votingGroupName');
    const infoEl = document.getElementById('votingGroupInfo');
    const dateEl = document.getElementById('votingGroupDateTime');
    
    if (nameEl) nameEl.textContent = currentGroupData.name || 'Gruppenessen';
    if (infoEl) infoEl.textContent = (currentGroupData.size || 6) + ' Personen';
    if (dateEl && currentGroupData.formattedDate) {
        dateEl.textContent = '📅 ' + currentGroupData.formattedDate + ' um ' + currentGroupData.time + ' Uhr';
    }
    
    // Top 3 Restaurants vorschlagen
    const suggestions = APP_DATA.restaurants
        .filter(r => r.freeTables >= Math.ceil((currentGroupData.size || 6) / 4))
        .slice(0, 5);
    
    if (suggestions.length === 0) {
        const noResults = '<p style="color: var(--text-secondary); font-size: 14px; text-align: center; padding: 20px;">Keine passenden Restaurants gefunden</p>';
        if (container) container.innerHTML = noResults;
        if (modalContainer) modalContainer.innerHTML = noResults;
        return;
    }
    
    let html = '';
    suggestions.forEach(r => {
        const votes = currentGroupData.votes?.[r.id] || 0;
        const hasVoted = currentGroupData.myVotes?.includes(r.id);
        
        html += `
            <div onclick="voteForRestaurant('${r.id}')" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 10px; cursor: pointer; border: 2px solid ${hasVoted ? 'var(--primary)' : 'transparent'}; transition: all 0.2s;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <img src="${r.image}" style="width: 50px; height: 50px; border-radius: 10px; object-fit: cover;">
                    <div>
                        <div style="font-weight: 600; font-size: 15px;">${r.name}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${r.cuisine || 'Restaurant'} • ${r.freeTables} Tische frei</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; background: ${hasVoted ? 'var(--primary)' : 'var(--bg-card)'}; padding: 8px 12px; border-radius: 20px;">
                    <span style="font-weight: 700; color: ${hasVoted ? 'white' : 'var(--primary)'}; font-size: 16px;">${votes}</span>
                    <svg viewBox="0 0 24 24" fill="${hasVoted ? 'white' : 'none'}" stroke="${hasVoted ? 'white' : 'var(--primary)'}" stroke-width="2" width="18" height="18">
                        <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
                    </svg>
                </div>
            </div>
        `;
    });
    
    if (container) container.innerHTML = html;
    if (modalContainer) modalContainer.innerHTML = html;
}

function voteForRestaurant(restaurantId) {
    if (!currentGroupData) return;
    
    if (!currentGroupData.votes) currentGroupData.votes = {};
    if (!currentGroupData.myVotes) currentGroupData.myVotes = [];
    
    if (currentGroupData.myVotes.includes(restaurantId)) {
        // Vote entfernen
        currentGroupData.votes[restaurantId] = (currentGroupData.votes[restaurantId] || 1) - 1;
        currentGroupData.myVotes = currentGroupData.myVotes.filter(id => id !== restaurantId);
        showToast('Stimme entfernt');
    } else {
        // Vote hinzufügen
        currentGroupData.votes[restaurantId] = (currentGroupData.votes[restaurantId] || 0) + 1;
        currentGroupData.myVotes.push(restaurantId);
        showToast('Abgestimmt! 👍');
    }
    
    // In localStorage speichern
    localStorage.setItem('kmi_group', JSON.stringify(currentGroupData));
    
    // Auch in groups-Liste aktualisieren
    const savedGroups = JSON.parse(localStorage.getItem('kmi_groups') || '{}');
    savedGroups[currentGroupData.id] = currentGroupData;
    localStorage.setItem('kmi_groups', JSON.stringify(savedGroups));
    
    renderGroupVoting();
}

function joinGroup(groupId) {
    // In echter App: Gruppe von Server laden
    showToast('Gruppe beigetreten!', 'success');
    openGroupReservationModal();
}

function createGroupReservation(restaurantId) {
    const sessionId = 'grp_' + Math.random().toString(36).substr(2, 9);
    
    groupSession = {
        id: sessionId,
        restaurantId,
        creator: APP_DATA.currentUser?.name || localStorage.getItem('kmi_guest_name') || 'Anonym',
        members: [],
        votes: {},
        createdAt: new Date()
    };
    
    // Link generieren
    const shareLink = `${window.location.origin}?group=${sessionId}`;
    
    // Share Modal öffnen
    openGroupShareModal(shareLink);
    
    return sessionId;
}

function openGroupShareModal(link) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.innerHTML = `
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">Gruppe einladen</h2>
                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
            </div>
            <div class="modal-body">
                <div class="group-invite" style="margin-bottom: 16px;">
                    <p style="margin: 0 0 12px;">Teile diesen Link mit deinen Freunden:</p>
                    <input type="text" value="${link}" readonly style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 12px;" onclick="this.select()">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button onclick="shareViaWhatsApp('${link}')" class="btn btn-primary" style="background: #25D366;">
                        WhatsApp
                    </button>
                    <button onclick="copyToClipboard('${link}')" class="btn btn-secondary">
                        Kopieren
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function shareViaWhatsApp(link) {
    const text = encodeURIComponent(`Hey! Lass uns zusammen essen gehen! Stimm hier ab: ${link}`);
    window.open(`https://wa.me/?text=${text}`, '_blank');
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Link kopiert!', 'success');
    });
}

// ==================== PUSH-BENACHRICHTIGUNGEN ====================
let pushEnabled = localStorage.getItem('kmi_push_enabled') === 'true';

function enablePushNotifications() {
    if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                pushEnabled = true;
                localStorage.setItem('kmi_push_enabled', 'true');
                
                // Einstellungen speichern
                const settings = {
                    reservations: document.getElementById('pushReservations').checked,
                    offers: document.getElementById('pushOffers').checked,
                    tables: document.getElementById('pushTables').checked
                };
                localStorage.setItem('kmi_push_settings', JSON.stringify(settings));
                
                showToast('Benachrichtigungen aktiviert!', 'success');
                closeModal('pushNotificationModal');
                
                // Test-Benachrichtigung
                setTimeout(() => {
                    sendPushNotification('Willkommen!', 'Du erhältst jetzt Updates zu deinen Favoriten.');
                }, 1000);
                
                addPoints(30, 'Benachrichtigungen aktiviert');
            } else {
                showToast('Benachrichtigungen wurden abgelehnt', 'error');
            }
        });
    } else {
        showToast('Dein Browser unterstützt keine Benachrichtigungen', 'error');
    }
}

function sendPushNotification(title, body, icon = null) {
    if (pushEnabled && 'Notification' in window && Notification.permission === 'granted') {
        const notification = new Notification(title, {
            body: body,
            icon: icon || '/icon-192.png',
            badge: '/icon-192.png',
            tag: 'kmi-notification'
        });
        
        notification.onclick = () => {
            window.focus();
            notification.close();
        };
    }
}

function checkAndShowPushModal() {
    // Nach 30 Sekunden Push-Modal zeigen wenn noch nicht aktiviert
    if (!pushEnabled && !localStorage.getItem('kmi_push_asked')) {
        setTimeout(() => {
            localStorage.setItem('kmi_push_asked', 'true');
            openModal('pushNotificationModal');
        }, 30000);
    }
}

// ==================== VOICE-RESERVIERUNG ====================
let voiceRecognition = null;
let isListening = false;

function initVoiceRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        voiceRecognition = new SpeechRecognition();
        voiceRecognition.continuous = false;
        voiceRecognition.interimResults = true;
        voiceRecognition.lang = 'de-DE';
        
        voiceRecognition.onresult = (event) => {
            const transcript = Array.from(event.results)
                .map(result => result[0].transcript)
                .join('');
            
            document.getElementById('voiceTranscript').textContent = transcript;
            
            if (event.results[0].isFinal) {
                processVoiceCommand(transcript);
            }
        };
        
        voiceRecognition.onend = () => {
            isListening = false;
            updateVoiceButton();
        };
        
        voiceRecognition.onerror = (event) => {
            console.error('Voice error:', event.error);
            isListening = false;
            updateVoiceButton();
            
            if (event.error === 'not-allowed') {
                showToast('Mikrofon-Zugriff verweigert', 'error');
            }
        };
        
        return true;
    }
    return false;
}

function toggleVoiceRecognition() {
    if (!voiceRecognition) {
        if (!initVoiceRecognition()) {
            showToast('Spracherkennung nicht unterstützt', 'error');
            return;
        }
    }
    
    if (isListening) {
        voiceRecognition.stop();
        isListening = false;
    } else {
        openModal('voiceReservationModal');
        document.getElementById('voiceTranscript').textContent = 'Höre zu...';
        document.getElementById('voiceResult').innerHTML = '';
        
        setTimeout(() => {
            voiceRecognition.start();
            isListening = true;
            updateVoiceButton();
        }, 500);
    }
}

function updateVoiceButton() {
    const btn = document.getElementById('voiceMicBtn');
    if (btn) {
        btn.classList.toggle('listening', isListening);
    }
}

function processVoiceCommand(text) {
    const lower = text.toLowerCase();
    let persons = 2;
    let time = null;
    let date = 'heute';
    let restaurant = null;
    
    // Personenanzahl erkennen
    const personMatch = lower.match(/(\d+)\s*(person|leute|gäste|personen)/);
    if (personMatch) persons = parseInt(personMatch[1]);
    
    // "für zwei", "für drei" etc.
    const wordNumbers = {'zwei': 2, 'drei': 3, 'vier': 4, 'fünf': 5, 'sechs': 6, 'sieben': 7, 'acht': 8};
    Object.entries(wordNumbers).forEach(([word, num]) => {
        if (lower.includes(`für ${word}`)) persons = num;
    });
    
    // Zeit erkennen
    const timeMatch = lower.match(/(\d{1,2})\s*(uhr|:)/);
    if (timeMatch) time = timeMatch[1] + ':00';
    
    if (lower.includes('mittag')) time = '12:00';
    if (lower.includes('abend')) time = '19:00';
    if (lower.includes('nachmittag')) time = '15:00';
    
    // Datum erkennen
    if (lower.includes('morgen')) date = 'morgen';
    if (lower.includes('übermorgen')) date = 'übermorgen';
    if (lower.includes('samstag')) date = 'Samstag';
    if (lower.includes('sonntag')) date = 'Sonntag';
    
    // Restaurant erkennen
    APP_DATA.restaurants.forEach(r => {
        if (lower.includes(r.name.toLowerCase())) {
            restaurant = r;
        }
    });
    
    // Küche erkennen
    let cuisine = null;
    const cuisines = {
        'italienisch': 'Italienisch',
        'pizza': 'Italienisch',
        'deutsch': 'Deutsch',
        'fisch': 'Fisch',
        'asiatisch': 'Asiatisch',
        'griechisch': 'Griechisch'
    };
    Object.entries(cuisines).forEach(([key, value]) => {
        if (lower.includes(key)) cuisine = value;
    });
    
    // Ergebnis anzeigen
    displayVoiceResult(persons, time, date, restaurant, cuisine);
}

function displayVoiceResult(persons, time, date, restaurant, cuisine) {
    const resultDiv = document.getElementById('voiceResult');
    
    let html = `
        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-top: 16px;">
            <h4 style="margin: 0 0 12px;">Verstanden:</h4>
            <div style="display: grid; gap: 8px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Personen:</span>
                    <strong>${persons}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Datum:</span>
                    <strong>${date}</strong>
                </div>
                ${time ? `
                    <div style="display: flex; justify-content: space-between;">
                        <span>Uhrzeit:</span>
                        <strong>${time}</strong>
                    </div>
                ` : ''}
                ${restaurant ? `
                    <div style="display: flex; justify-content: space-between;">
                        <span>Restaurant:</span>
                        <strong>${restaurant.name}</strong>
                    </div>
                ` : cuisine ? `
                    <div style="display: flex; justify-content: space-between;">
                        <span>Küche:</span>
                        <strong>${cuisine}</strong>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    // Passende Restaurants vorschlagen
    let suggestions = APP_DATA.restaurants.filter(r => r.freeTables > 0);
    if (cuisine) {
        suggestions = suggestions.filter(r => r.cuisine === cuisine);
    }
    if (restaurant) {
        suggestions = [restaurant];
    }
    suggestions = suggestions.slice(0, 3);
    
    if (suggestions.length > 0) {
        html += `
            <div style="margin-top: 16px;">
                <h4 style="margin: 0 0 12px;">${restaurant ? 'Dein Restaurant:' : 'Vorschläge:'}</h4>
                ${suggestions.map(r => {
                    const routeUrl = r.googleMapsUrl || (r.lat && r.lng ? `https://www.google.com/maps/dir/?api=1&destination=${r.lat},${r.lng}` : `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent((r.street || '') + ' ' + (r.city || r.name))}`);
                    return `
                    <div style="background: var(--bg-secondary); border-radius: 12px; margin-bottom: 10px; overflow: hidden;">
                        <div onclick="closeModal('voiceReservationModal'); openReservation('${r.id}')" style="display: flex; align-items: center; gap: 12px; padding: 12px; cursor: pointer;">
                            <img src="${r.image}" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${r.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${r.freeTables} Tische frei</div>
                            </div>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="opacity: 0.5;">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid var(--border-color);">
                            <button onclick="closeModal('voiceReservationModal'); openReservation('${r.id}')" style="background: var(--primary); color: white; border: none; padding: 10px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                Reservieren
                            </button>
                            <a href="${routeUrl}" target="_blank" onclick="event.stopPropagation();" style="background: transparent; color: var(--text-primary); border: none; padding: 10px; font-size: 13px; font-weight: 500; cursor: pointer; text-decoration: none; text-align: center; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <polygon points="3 11 22 2 13 21 11 13 3 11"/>
                                </svg>
                                Route
                            </a>
                        </div>
                    </div>
                `}).join('')}
            </div>
        `;
    }
    
    resultDiv.innerHTML = html;
    
    addPoints(15, 'Voice-Reservierung genutzt');
}

function retryVoice() {
    document.getElementById('voiceTranscript').textContent = 'Höre zu...';
    document.getElementById('voiceResult').innerHTML = '';
    voiceRecognition.start();
    isListening = true;
    updateVoiceButton();
}

// ==================== AR PREVIEW ====================
let arStream = null;
let arCanvas = null;
let arContext = null;

function openARPreview(dishName, dishImage) {
    openModal('arPreviewModal');
    document.getElementById('arDishName').textContent = dishName;
    document.getElementById('arDishImg').src = dishImage;
    
    // Kamera starten
    startARCamera();
}

async function startARCamera() {
    const video = document.getElementById('arVideo');
    const container = document.getElementById('arCameraContainer');
    
    try {
        arStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }
        });
        video.srcObject = arStream;
        video.play();
        
        // Canvas für Overlay
        arCanvas = document.getElementById('arCanvas');
        arContext = arCanvas.getContext('2d');
        
        // Warten bis Video geladen
        video.onloadedmetadata = () => {
            arCanvas.width = video.videoWidth;
            arCanvas.height = video.videoHeight;
            renderARFrame();
        };
        
        document.getElementById('arPlaceholder').style.display = 'none';
        video.style.display = 'block';
        arCanvas.style.display = 'block';
        
    } catch (err) {
        console.error('Kamera-Fehler:', err);
        document.getElementById('arPlaceholder').innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48" style="margin-bottom: 12px; opacity: 0.5;">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
            </svg>
            <p>Kamera nicht verfügbar</p>
            <p style="font-size: 12px; opacity: 0.7;">Bitte Zugriff erlauben</p>
        `;
    }
}

function renderARFrame() {
    if (!arStream || !arContext) return;
    
    const video = document.getElementById('arVideo');
    const dishImg = document.getElementById('arDishImg');
    const scale = parseFloat(document.getElementById('arScale')?.value || 1);
    
    // Video Frame zeichnen
    arContext.drawImage(video, 0, 0, arCanvas.width, arCanvas.height);
    
    // Gericht-Bild überlagern (Mitte des Bildschirms)
    const imgSize = Math.min(arCanvas.width, arCanvas.height) * 0.4 * scale;
    const x = (arCanvas.width - imgSize) / 2;
    const y = (arCanvas.height - imgSize) / 2;
    
    // Schatten für 3D-Effekt
    arContext.shadowColor = 'rgba(0,0,0,0.4)';
    arContext.shadowBlur = 20;
    arContext.shadowOffsetY = 10;
    
    // Rundes Bild zeichnen
    arContext.save();
    arContext.beginPath();
    arContext.arc(x + imgSize/2, y + imgSize/2, imgSize/2, 0, Math.PI * 2);
    arContext.clip();
    arContext.drawImage(dishImg, x, y, imgSize, imgSize);
    arContext.restore();
    
    // Schatten zurücksetzen
    arContext.shadowColor = 'transparent';
    
    // Nächsten Frame
    requestAnimationFrame(renderARFrame);
}

function closeARPreview() {
    if (arStream) {
        arStream.getTracks().forEach(track => track.stop());
        arStream = null;
    }
    closeModal('arPreviewModal');
}

function captureARPhoto() {
    if (!arCanvas) return;
    
    // Canvas als Bild speichern
    const dataUrl = arCanvas.toDataURL('image/png');
    
    // Download Link erstellen
    const link = document.createElement('a');
    link.download = 'kiek-mol-in-ar-preview.png';
    link.href = dataUrl;
    link.click();
    
    showToast('Foto gespeichert!', 'success');
    addPoints(10, 'AR Foto gemacht');
}

// ==================== INIT NEUE FEATURES ====================
function initNewFeatures() {
    initTides();
    updatePointsDisplay();
    
    // Check für Gruppe in URL
    const urlParams = new URLSearchParams(window.location.search);
    const groupId = urlParams.get('group');
    if (groupId) {
        joinGroup(groupId);
    }
    
    // Erste Nutzung Achievement
    if (!localStorage.getItem('kmi_first_visit')) {
        localStorage.setItem('kmi_first_visit', 'true');
        setTimeout(() => {
            addPoints(POINTS_CONFIG.firstVisit, 'Willkommen!');
        }, 2000);
    }
    
    // Push-Benachrichtigungen Modal anzeigen
    checkAndShowPushModal();
}

// ==================== REVIEWS UI ====================
let currentReviewRating = 0;
let currentReviewPhotos = [];
let currentReviewTarget = { type: null, id: null, name: null };

function openReviewsModal(targetType, targetId, targetName) {
    currentReviewTarget = { type: targetType, id: targetId, name: targetName };
    
    document.getElementById('reviewsModalTitle').textContent = `Bewertungen - ${targetName}`;
    
    // Daten laden
    loadReviewsForModal(targetType, targetId);
    
    openModal('reviewsModal');
    
    // Presence tracken
    updatePresence(targetType, targetId);
}

async function loadReviewsForModal(targetType, targetId) {
    const reviewsList = document.getElementById('reviewsList');
    const activityFeed = document.getElementById('liveActivityFeed');
    
    // Reviews laden
    const reviews = await loadReviews(targetType, targetId);
    
    if (reviews.length === 0) {
        reviewsList.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                <div style="font-size: 48px; margin-bottom: 12px;">💬</div>
                <p>Noch keine Bewertungen</p>
                <p style="font-size: 13px;">Sei der Erste!</p>
            </div>
        `;
    } else {
        // Durchschnitt berechnen
        const avgRating = (reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length).toFixed(1);
        document.getElementById('reviewsAvgRating').textContent = avgRating;
        document.getElementById('reviewsTotalCount').textContent = reviews.length;
        
        reviewsList.innerHTML = reviews.map(review => renderReviewCard(review)).join('');
    }
    
    // Activity laden
    const activities = await loadRecentActivity(targetType, targetId, 5);
    
    if (activities.length === 0) {
        activityFeed.innerHTML = `
            <div style="text-align: center; padding: 12px; color: var(--text-secondary); font-size: 13px;">
                Noch keine Aktivität
            </div>
        `;
    } else {
        activityFeed.innerHTML = activities.map(activity => {
            const icon = activity.activity_type === 'reservation' ? '🍴' : 
                         activity.activity_type === 'review' ? '⭐' : 
                         activity.activity_type === 'photo' ? '📸' : '👀';
            const timeAgo = getTimeAgo(new Date(activity.created_at));
            
            return `
                <div class="activity-item">
                    <span class="activity-icon">${icon}</span>
                    <span class="activity-text">${activity.user_name || 'Jemand'} ${activity.message}</span>
                    <span class="activity-time">${timeAgo}</span>
                </div>
            `;
        }).join('');
    }
    
    // Today visitors
    const todayCount = await getTodayVisitors(targetType, targetId);
    document.getElementById('reviewsTodayVisitors').textContent = todayCount;
}

function renderReviewCard(review) {
    const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
    const initial = (review.user_name || 'G')[0].toUpperCase();
    const timeAgo = getTimeAgo(new Date(review.created_at));
    
    return `
        <div class="review-card">
            <div class="review-header">
                <div class="review-avatar" style="background: ${getAvatarColor(review.user_name)};">
                    ${review.user_avatar ? `<img src="${review.user_avatar}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : initial}
                </div>
                <div class="review-meta">
                    <div class="review-author">${review.user_name || 'Gast'}${review.is_verified ? ' ✓' : ''}</div>
                    <div class="review-date">${timeAgo}</div>
                </div>
                <div class="review-stars">${stars}</div>
            </div>
            ${review.title ? `<div class="review-title">${escapeHtml(review.title)}</div>` : ''}
            ${review.comment ? `<div class="review-comment">${escapeHtml(review.comment)}</div>` : ''}
            <div class="review-helpful">
                <button class="helpful-btn" onclick="markHelpful('${review.id}')">
                    👍 Hilfreich ${review.helpful_count > 0 ? `(${review.helpful_count})` : ''}
                </button>
            </div>
        </div>
    `;
}

function getAvatarColor(name) {
    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dfe6e9', '#a29bfe', '#fd79a8'];
    const index = (name || 'G').charCodeAt(0) % colors.length;
    return colors[index];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function openWriteReview() {
    if (!currentReviewTarget.id) return;
    
    document.getElementById('reviewTargetType').value = currentReviewTarget.type;
    document.getElementById('reviewTargetId').value = currentReviewTarget.id;
    document.getElementById('reviewTargetName').value = currentReviewTarget.name;
    document.getElementById('writeReviewFor').textContent = currentReviewTarget.name;
    
    // Reset Form
    currentReviewRating = 0;
    currentReviewPhotos = [];
    document.getElementById('writeReviewForm').reset();
    updateStarDisplay();
    updatePhotoGrid();
    
    // Name-Feld nur zeigen wenn nicht eingeloggt
    const nameGroup = document.getElementById('reviewNameGroup');
    if (APP_DATA.currentUser) {
        nameGroup.style.display = 'none';
    } else {
        nameGroup.style.display = 'block';
        const savedName = localStorage.getItem('kmi_guest_name');
        if (savedName) {
            document.getElementById('reviewUserName').value = savedName;
        }
    }
    
    closeModal('reviewsModal');
    openModal('writeReviewModal');
}

function setRating(rating) {
    currentReviewRating = rating;
    updateStarDisplay();
    
    const texts = ['', 'Schlecht', 'Geht so', 'Okay', 'Gut', 'Ausgezeichnet!'];
    document.getElementById('ratingText').textContent = texts[rating] || '';
}

function updateStarDisplay() {
    const stars = document.querySelectorAll('#starRatingInput span');
    stars.forEach((star, index) => {
        if (index < currentReviewRating) {
            star.textContent = '★';
            star.classList.add('active');
        } else {
            star.textContent = '☆';
            star.classList.remove('active');
        }
    });
}

function handleReviewPhotoUpload(event) {
    const files = event.target.files;
    
    for (const file of files) {
        if (currentReviewPhotos.length >= 4) {
            showToast('Maximal 4 Fotos', 'error');
            break;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            showToast('Bild zu groß (max 5MB)', 'error');
            continue;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            compressImage(e.target.result, 800, 0.8, function(compressed) {
                currentReviewPhotos.push(compressed);
                updatePhotoGrid();
            });
        };
        reader.readAsDataURL(file);
    }
    
    event.target.value = '';
}

function removeReviewPhoto(index) {
    currentReviewPhotos.splice(index, 1);
    updatePhotoGrid();
}

function updatePhotoGrid() {
    const grid = document.getElementById('reviewPhotoGrid');
    
    let html = currentReviewPhotos.map((photo, index) => `
        <div class="photo-upload-item">
            <img src="${photo}" alt="Foto ${index + 1}">
            <button type="button" class="remove-photo" onclick="removeReviewPhoto(${index})">×</button>
        </div>
    `).join('');
    
    if (currentReviewPhotos.length < 4) {
        html += `
            <label class="photo-upload-add">
                <input type="file" accept="image/*" multiple onchange="handleReviewPhotoUpload(event)" style="display: none;">
                +
            </label>
        `;
    }
    
    grid.innerHTML = html;
}

async function handleSubmitReview(event) {
    event.preventDefault();
    
    if (currentReviewRating === 0) {
        showToast('Bitte Sterne vergeben', 'error');
        return;
    }
    
    const targetType = document.getElementById('reviewTargetType').value;
    const targetId = document.getElementById('reviewTargetId').value;
    const targetName = document.getElementById('reviewTargetName').value;
    const title = document.getElementById('reviewTitle').value;
    const comment = document.getElementById('reviewComment').value;
    
    // Name speichern für nächstes Mal
    const userName = document.getElementById('reviewUserName').value;
    if (userName && !APP_DATA.currentUser) {
        localStorage.setItem('kmi_guest_name', userName);
    }
    
    const result = await submitReview(
        targetType,
        targetId,
        targetName,
        currentReviewRating,
        title,
        comment,
        currentReviewPhotos
    );
    
    if (result) {
        closeModal('writeReviewModal');
        // Reviews Modal wieder öffnen
        setTimeout(() => {
            openReviewsModal(targetType, targetId, targetName);
        }, 500);
    }
}

async function markHelpful(reviewId) {
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/helpful_votes`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                review_id: reviewId,
                user_id: APP_DATA.currentUser?.id || null,
                session_id: SESSION_ID
            })
        });
        
        showToast('Danke! 👍', 'success');
    } catch (e) {
        console.log('Helpful vote fehlgeschlagen:', e);
    }
}

// ==================== IMAGE UPLOAD ====================
let uploadedImageBase64 = null;

function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Dateigröße prüfen (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showToast('Bild zu groß (max. 5MB)', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const base64 = e.target.result;
        
        // Bild komprimieren
        compressImage(base64, 800, 0.8, function(compressedBase64) {
            uploadedImageBase64 = compressedBase64;
            
            // Vorschau anzeigen
            document.getElementById('imagePreview').src = compressedBase64;
            document.getElementById('imagePreviewContainer').style.display = 'block';
            document.getElementById('newRestaurantImage').value = '';
            
            showToast('Bild geladen!', 'success');
        });
    };
    reader.readAsDataURL(file);
}

function compressImage(base64, maxWidth, quality, callback) {
    const img = new Image();
    img.onload = function() {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        // Skalieren wenn zu groß
        if (width > maxWidth) {
            height = Math.round((height * maxWidth) / width);
            width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        callback(canvas.toDataURL('image/jpeg', quality));
    };
    img.src = base64;
}

function previewImageFromUrl(url) {
    if (!url) {
        document.getElementById('imagePreviewContainer').style.display = 'none';
        return;
    }
    
    // Prüfen ob gültige URL
    if (url.startsWith('http')) {
        document.getElementById('imagePreview').src = url;
        document.getElementById('imagePreviewContainer').style.display = 'block';
        uploadedImageBase64 = null;
    }
}

function clearImagePreview() {
    document.getElementById('imagePreviewContainer').style.display = 'none';
    document.getElementById('imagePreview').src = '';
    document.getElementById('newRestaurantImage').value = '';
    uploadedImageBase64 = null;
}

// ==================== ADD RESTAURANT ====================
async function addRestaurant(e) {
    e.preventDefault();
    
    // Prüfen ob Edit-Modus
    const editId = document.getElementById('addRestaurantForm').dataset.editId;
    const isEdit = !!editId;
    
    const name = document.getElementById('newRestaurantName').value;
    const cuisine = document.getElementById('newRestaurantCuisine').value;
    const phone = document.getElementById('newRestaurantPhone').value || '';
    const whatsapp = document.getElementById('newRestaurantWhatsapp').value || null;
    const email = document.getElementById('newRestaurantEmail').value || null;
    const city = document.getElementById('newRestaurantCity')?.value || 'Greetsiel';
    const street = document.getElementById('newRestaurantStreet')?.value || '';
    const zip = document.getElementById('newRestaurantZip')?.value || '';
    const googleMaps = document.getElementById('newRestaurantGoogleMaps')?.value || '';
    const instagram = document.getElementById('newRestaurantInstagram')?.value || '';
    const tiktok = document.getElementById('newRestaurantTiktok')?.value || '';
    const rating = parseFloat(document.getElementById('newRestaurantRating')?.value) || 4.5;
    const reviewCount = parseInt(document.getElementById('newRestaurantReviewCount')?.value) || 0;
    
    // Bild: Erst Upload prüfen, dann URL, dann Default
    const image = uploadedImageBase64 || document.getElementById('newRestaurantImage').value || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800';
    const tables = parseInt(document.getElementById('newRestaurantTables').value) || 8;
    
    // Koordinaten basierend auf Ort
    const cityCoords = {
        'Greetsiel': { lat: 53.5021, lng: 7.0965 },
        'Norddeich': { lat: 53.6108, lng: 7.1542 },
        'Norden': { lat: 53.5967, lng: 7.2058 },
        'Aurich': { lat: 53.4714, lng: 7.4808 },
        'Emden': { lat: 53.3594, lng: 7.2060 }
    };
    const coords = cityCoords[city] || { lat: 53.5021, lng: 7.0965 };
    
    // Vollständige Adresse für Route (wird aus street/zip/city zusammengesetzt)
    const fullAddress = `${street}, ${zip} ${city}, Deutschland`;
    
    // Restaurant Daten
    const restaurantData = {
        name: name,
        phone: phone,
        whatsapp: whatsapp,
        email: email,
        city: city,
        street: street,
        zip: zip,
        google_maps_url: googleMaps,
        instagram: instagram,
        tiktok: tiktok,
        cuisine_type: [cuisine],
        image_url: image,
        rating: rating,
        review_count: reviewCount
    };
    
    // Nur bei Neuanlage Koordinaten und Status setzen
    if (!isEdit) {
        const lat = coords.lat + (Math.random() - 0.5) * 0.005;
        const lng = coords.lng + (Math.random() - 0.5) * 0.005;
        restaurantData.latitude = lat;
        restaurantData.longitude = lng;
        restaurantData.is_active = true;
        restaurantData.is_open = true;
    }
    
    console.log(isEdit ? 'Restaurant aktualisieren:' : 'Restaurant hinzufügen:', name);
    
    // In Supabase speichern oder aktualisieren
    try {
        let url = `${SUPABASE_URL}/rest/v1/restaurants`;
        let method = 'POST';
        
        if (isEdit) {
            url += `?id=eq.${editId}`;
            method = 'PATCH';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify(restaurantData)
        });
        
        console.log('Response Status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Supabase Fehler:', errorText);
            showToast('Fehler beim Speichern: ' + errorText, 'error');
            return;
        }
        
        const data = await response.json();
        console.log('Restaurant gespeichert:', data);
        
        if (isEdit) {
            // Bei Update: Restaurant in APP_DATA aktualisieren
            const index = APP_DATA.restaurants.findIndex(r => r.id === editId);
            if (index !== -1) {
                APP_DATA.restaurants[index] = {
                    ...APP_DATA.restaurants[index],
                    name: name,
                    cuisine: cuisine,
                    phone: phone,
                    whatsapp: whatsapp,
                    image: image,
                    city: city,
                    street: street,
                    zip: zip
                };
            }
        } else {
            // Bei Neuanlage: Restaurant hinzufügen
            const newRestaurant = {
                id: data[0].id,
                name: name,
                cuisine: cuisine,
                rating: rating,
                freeTables: tables,
                waitTime: 0,
                phone: phone,
                whatsapp: whatsapp,
                lat: restaurantData.latitude,
                lng: restaurantData.longitude,
                image: image,
                offer: null
            };
            
            APP_DATA.restaurants.push(newRestaurant);
            
            // Tische für das Restaurant erstellen (nur bei Neuanlage)
            for (let i = 1; i <= tables; i++) {
                await fetch(`${SUPABASE_URL}/rest/v1/tables`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        restaurant_id: data[0].id,
                        table_number: i,
                        seats: i <= 2 ? 2 : (i <= 4 ? 4 : 6),
                        status: 'free'
                    })
                });
            }
        }
        
        // Modal schließen und Form zurücksetzen
        closeModal('addRestaurantModal');
        const addRestaurantForm = document.getElementById('addRestaurantForm');
        if (addRestaurantForm) {
            addRestaurantForm.reset();
            delete addRestaurantForm.dataset.editId; // Edit-ID entfernen
        }
        
        // Bild-Upload zurücksetzen
        uploadedImageBase64 = null;
        clearImagePreview();
        
        // UI aktualisieren
        try { renderRestaurants(); } catch(e) { console.log('renderRestaurants error:', e); }
        try { if (typeof updateMapMarkers === 'function') updateMapMarkers(); } catch(e) { console.log('updateMapMarkers error:', e); }
        try { updateDashboard(); } catch(e) { console.log('updateDashboard error:', e); }
        try { loadRestaurantsDash(); } catch(e) { console.log('loadRestaurantsDash error:', e); }
        
        showToast(isEdit ? `${name} aktualisiert!` : `${name} hinzugefügt!`, 'success');
        
    } catch (e) {
        console.error('Fehler:', e);
        showToast('Verbindungsfehler: ' + e.message, 'error');
    }
}

// Live preview for offer form
function updateOfferPreview() {
    const title = document.getElementById('offerTitle');
    const discount = document.getElementById('offerDiscount');
    const validUntil = document.getElementById('offerValidUntil');
    const previewTitle = document.getElementById('previewTitle');
    const previewDiscount = document.getElementById('previewDiscount');
    
    if (title && previewTitle) {
        previewTitle.textContent = title.value || 'Dein Angebot';
    }
    if (discount && validUntil && previewDiscount) {
        const discountVal = discount.value || 'Rabatt';
        const timeVal = validUntil.value || '--:--';
        previewDiscount.textContent = `${discountVal} bis ${timeVal}`;
    }
}

// ==================== EVENTS ====================
let events = [];
let currentEventFilter = 'all';

async function loadEvents() {
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/events?select=*&is_active=eq.true&order=event_date`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (response.ok) {
            events = await response.json();
            console.log('[OK] Events geladen:', events.length);
        } else {
            events = [];
        }
        renderEvents();
    } catch (e) {
        console.error('Fehler beim Laden der Events:', e);
        events = [];
        renderEvents();
    }
}

function renderEvents(filter = currentEventFilter) {
    const container = document.getElementById('eventsList');
    if (!container) return;
    
    let filtered = events;
    if (filter !== 'all') {
        filtered = events.filter(e => e.category === filter);
    }
    
    if (filtered.length === 0) {
        container.innerHTML = '<p style="padding: 40px; color: var(--slate); text-align: center;">Keine Events gefunden</p>';
        return;
    }
    
    let html = '';
    filtered.forEach(e => {
        const eventDate = new Date(e.event_date);
        const dateStr = eventDate.toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' });
        const categoryLabel = e.category === 'fest' ? 'Fest' : e.category === 'markt' ? 'Markt' : e.category === 'konzert' ? 'Konzert' : e.category === 'natur' ? 'Natur' : 'Event';
        
        html += `
            <div class="restaurant-card" style="margin-bottom: 16px;">
                <div class="card-image" style="background-image: url('${e.image_url || 'https://images.unsplash.com/photo-1533174072545-7a4b6ad7a6c3?w=800'}');">
                    ${e.is_featured ? '<div class="special-badge">Highlight</div>' : ''}
                    <div class="availability-badge available">${dateStr}</div>
                </div>
                <div class="card-content">
                    <div class="card-top">
                        <h3 class="restaurant-name">${e.title}</h3>
                        <span style="background: var(--cream); padding: 4px 8px; border-radius: 4px; font-size: 11px; color: var(--primary);">${categoryLabel}</span>
                    </div>
                    <div class="restaurant-meta">
                        <span class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            ${e.city || 'Ostfriesland'}
                        </span>
                        <span class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            ${e.event_time || 'Ganztägig'}
                        </span>
                    </div>
                    <p style="color: var(--slate); font-size: 14px; margin: 8px 0;">${e.description || ''}</p>
                    <div style="font-weight: 700; color: var(--primary);">${e.price_info || ''}</div>
                    <div class="card-actions" style="margin-top: 12px;">
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent((e.location_name || e.title) + ' ' + (e.city || 'Ostfriesland'))}" target="_blank" class="card-btn card-btn-secondary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="3 11 22 2 13 21 11 13 3 11"/>
                            </svg>
                            Route
                        </a>
                        ${e.website || e.ticket_url ? `
                            <a href="${e.ticket_url || e.website}" target="_blank" class="card-btn card-btn-primary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                    <polyline points="15 3 21 3 21 9"/>
                                    <line x1="10" y1="14" x2="21" y2="3"/>
                                </svg>
                                Mehr Info
                            </a>
                        ` : ''}
                        <button class="card-btn card-btn-secondary" onclick="openReviewsModal('event', '${e.id}', '${e.title.replace(/'/g, "\\'")}')">
                            ⭐ Bewertungen
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Update stats
    const statEvents = document.getElementById('statEvents');
    if (statEvents) statEvents.textContent = events.length;
}

function setEventFilter(filter) {
    currentEventFilter = filter;
    document.querySelectorAll('#filterChipsEvents .chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.filter === filter);
    });
    renderEvents(filter);
}

function showEvents() {
    document.getElementById('mainView').style.display = 'none';
    document.getElementById('favoritesView').classList.remove('active');
    document.getElementById('accommodationsView').classList.remove('active');
    document.getElementById('eventsView').classList.add('active');
    document.getElementById('attractionsView').classList.remove('active');
    if (document.getElementById('jobsView')) document.getElementById('jobsView').classList.remove('active');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('navEvents').classList.add('active');
    
    loadEvents();
}

// ==================== ATTRACTIONS ====================
let attractions = [];
let currentAttractionFilter = 'all';

async function loadAttractions() {
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/attractions?select=*&is_active=eq.true&order=rating.desc`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (response.ok) {
            attractions = await response.json();
            console.log('[OK] Ausflugsziele geladen:', attractions.length);
        } else {
            attractions = [];
        }
        renderAttractions();
    } catch (e) {
        console.error('Fehler beim Laden der Ausflugsziele:', e);
        attractions = [];
        renderAttractions();
    }
}

function renderAttractions(filter = currentAttractionFilter) {
    const container = document.getElementById('attractionsList');
    if (!container) return;
    
    let filtered = attractions;
    if (filter !== 'all') {
        filtered = attractions.filter(a => a.category === filter);
    }
    
    if (filtered.length === 0) {
        container.innerHTML = '<p style="padding: 40px; color: var(--slate); text-align: center;">Keine Ausflugsziele gefunden</p>';
        return;
    }
    
    let html = '';
    filtered.forEach(a => {
        const categoryLabel = a.category === 'natur' ? 'Natur' : a.category === 'museum' ? 'Museum' : a.category === 'historisch' ? 'Historisch' : a.category === 'familie' ? 'Familie' : 'Ausflug';
        
        html += `
            <div class="restaurant-card" style="margin-bottom: 16px;">
                <div class="card-image" style="background-image: url('${a.image_url || 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=800'}');">
                    <div class="rating" style="position: absolute; top: 12px; right: 12px; background: white; padding: 4px 10px; border-radius: 20px; display: flex; align-items: center; gap: 4px;">
                        <svg viewBox="0 0 24 24" fill="var(--warning)" width="14" height="14">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <span style="font-weight: 700; font-size: 13px; color: var(--charcoal);">${a.rating || 4.5}</span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="card-top">
                        <h3 class="restaurant-name">${a.name}</h3>
                        <span style="background: var(--cream); padding: 4px 8px; border-radius: 4px; font-size: 11px; color: var(--primary); font-weight: 600;">${categoryLabel}</span>
                    </div>
                    <div class="restaurant-meta">
                        <span class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            ${a.city || 'Ostfriesland'}
                        </span>
                        ${a.opening_hours ? `
                            <span class="meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                                ${a.opening_hours}
                            </span>
                        ` : ''}
                    </div>
                    <p style="color: var(--slate); font-size: 14px; margin: 8px 0; line-height: 1.4;">${a.description || ''}</p>
                    <div style="font-weight: 700; color: var(--primary); margin-bottom: 12px;">${a.price_info || ''}</div>
                    <div class="card-actions">
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(a.name + ' ' + (a.city || 'Ostfriesland'))}" target="_blank" class="card-btn card-btn-secondary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="3 11 22 2 13 21 11 13 3 11"/>
                            </svg>
                            Route
                        </a>
                        ${a.phone ? `
                            <a href="tel:${a.phone}" class="card-btn card-btn-secondary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                </svg>
                                Anrufen
                            </a>
                        ` : ''}
                        ${a.website ? `
                            <a href="${a.website}" target="_blank" class="card-btn card-btn-primary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                    <polyline points="15 3 21 3 21 9"/>
                                    <line x1="10" y1="14" x2="21" y2="3"/>
                                </svg>
                                Website
                            </a>
                        ` : ''}
                        <button class="card-btn card-btn-secondary" onclick="openReviewsModal('attraction', '${a.id}', '${a.name.replace(/'/g, "\\'")}')">
                            ⭐ Bewertungen
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Update stats
    const statAttractions = document.getElementById('statAttractions');
    if (statAttractions) statAttractions.textContent = attractions.length;
}

function setAttractionFilter(filter) {
    currentAttractionFilter = filter;
    document.querySelectorAll('#filterChipsAttractions .chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.filter === filter);
    });
    renderAttractions(filter);
}

function showAttractions() {
    document.getElementById('mainView').style.display = 'none';
    document.getElementById('favoritesView').classList.remove('active');
    document.getElementById('accommodationsView').classList.remove('active');
    document.getElementById('eventsView').classList.remove('active');
    document.getElementById('attractionsView').classList.add('active');
    if (document.getElementById('jobsView')) document.getElementById('jobsView').classList.remove('active');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('navAttractions').classList.add('active');
    
    loadAttractions();
}

// ==================== JOBS ====================
let jobs = [];
let currentJobFilter = 'all';

function showJobs() {
    document.getElementById('mainView').style.display = 'none';
    document.getElementById('favoritesView').classList.remove('active');
    document.getElementById('accommodationsView').classList.remove('active');
    document.getElementById('eventsView').classList.remove('active');
    document.getElementById('attractionsView').classList.remove('active');
    document.getElementById('jobsView').classList.add('active');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('navJobs').classList.add('active');
    
    loadJobs();
}

async function loadJobs() {
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/jobs?select=*,restaurants(name,city)&is_active=eq.true&order=created_at.desc`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (response.ok) {
            jobs = await response.json();
            renderJobs();
            updateJobStats();
        }
    } catch (e) {
        console.log('Jobs laden Fehler:', e);
        renderJobs();
    }
}

function renderJobs(filter = 'all') {
    const container = document.getElementById('jobsList');
    if (!container) return;
    
    let filteredJobs = jobs;
    if (filter !== 'all') {
        filteredJobs = jobs.filter(j => j.job_type === filter);
    }
    
    if (filteredJobs.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--slate);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 16px; opacity: 0.5;">
                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                </svg>
                <p>${translations[currentLanguage].noJobs || 'Keine Stellenangebote verfügbar'}</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    filteredJobs.forEach(job => {
        const restaurantName = job.restaurants ? job.restaurants.name : 'Restaurant';
        const city = job.restaurants ? job.restaurants.city : '';
        
        const typeLabels = {
            fulltime: { de: 'Vollzeit', en: 'Full-time', nl: 'Voltijd' },
            parttime: { de: 'Teilzeit', en: 'Part-time', nl: 'Deeltijd' },
            minijob: { de: 'Minijob', en: 'Mini job', nl: 'Minibaan' }
        };
        
        const typeLabel = typeLabels[job.job_type] ? typeLabels[job.job_type][currentLanguage] || typeLabels[job.job_type].de : job.job_type;
        
        html += `
            <div class="job-card" onclick="showJobDetail('${job.id}')">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <div>
                        <h3 style="font-size: 17px; font-weight: 700; color: var(--dark); margin-bottom: 4px;">${job.title}</h3>
                        <p style="font-size: 14px; color: var(--slate);">${restaurantName}${city ? ' • ' + city : ''}</p>
                    </div>
                    ${job.is_urgent ? '<span class="job-badge urgent">Dringend</span>' : ''}
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                    <span class="job-badge ${job.job_type}">${typeLabel}</span>
                    ${job.salary ? `<span style="font-size: 13px; color: var(--slate);">${job.salary}</span>` : ''}
                </div>
                ${job.description ? `<p style="font-size: 14px; color: var(--slate); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${job.description}</p>` : ''}
                <div style="margin-top: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 12px; color: var(--slate);">${formatJobDate(job.created_at)}</span>
                    <button style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;" onclick="event.stopPropagation(); applyForJob('${job.id}')">
                        ${translations[currentLanguage].apply || 'Bewerben'}
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function filterJobs(filter) {
    currentJobFilter = filter;
    
    document.querySelectorAll('[id^="filterJobs"]').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const filterMap = { all: 'All', fulltime: 'Fulltime', parttime: 'Parttime', minijob: 'Minijob' };
    const activeBtn = document.getElementById('filterJobs' + filterMap[filter]);
    if (activeBtn) activeBtn.classList.add('active');
    
    renderJobs(filter);
}

function updateJobStats() {
    const totalEl = document.getElementById('statJobsTotal');
    const urgentEl = document.getElementById('statJobsUrgent');
    const restaurantsEl = document.getElementById('statJobsRestaurants');
    
    if (totalEl) totalEl.textContent = jobs.length;
    if (urgentEl) urgentEl.textContent = jobs.filter(j => j.is_urgent).length;
    if (restaurantsEl) {
        const uniqueRestaurants = [...new Set(jobs.map(j => j.restaurant_id))];
        restaurantsEl.textContent = uniqueRestaurants.length;
    }
}

function formatJobDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const now = new Date();
    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return translations[currentLanguage].today || 'Heute';
    if (diffDays === 1) return translations[currentLanguage].yesterday || 'Gestern';
    if (diffDays < 7) return `${diffDays} ${translations[currentLanguage].daysAgo || 'Tage'}`;
    return date.toLocaleDateString('de-DE');
}

function applyForJob(jobId) {
    const job = jobs.find(j => j.id === jobId);
    if (!job) return;
    
    // WhatsApp oder Email
    if (job.contact_whatsapp) {
        const text = encodeURIComponent(`Hallo, ich interessiere mich für die Stelle "${job.title}".`);
        window.open(`https://wa.me/${job.contact_whatsapp.replace(/[^0-9]/g, '')}?text=${text}`, '_blank');
    } else if (job.contact_email) {
        window.location.href = `mailto:${job.contact_email}?subject=Bewerbung: ${job.title}`;
    } else {
        showToast('Kontaktdaten nicht verfügbar');
    }
}

// ==================== ACCOMMODATIONS ====================
let accommodations = [];

async function loadAccommodations() {
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/accommodations?select=*&is_active=eq.true&order=name`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (response.ok) {
            accommodations = await response.json();
            console.log('[OK] Unterkünfte geladen:', accommodations.length);
        } else {
            accommodations = [];
        }
        renderAccommodations();
    } catch (e) {
        console.error('Fehler beim Laden der Unterkünfte:', e);
        accommodations = [];
        renderAccommodations();
    }
}

function renderAccommodations(filter = 'all') {
    const container = document.getElementById('accommodationsList');
    if (!container) return;
    
    const searchTerm = document.getElementById('searchAccommodation')?.value?.toLowerCase() || '';
    
    let filtered = accommodations;
    
    // Filter by type
    if (filter === 'available') {
        filtered = accommodations.filter(a => a.has_availability);
    } else if (filter !== 'all') {
        filtered = accommodations.filter(a => a.type === filter);
    }
    
    // Filter by search
    if (searchTerm) {
        filtered = filtered.filter(a => 
            a.name.toLowerCase().includes(searchTerm) ||
            (a.city && a.city.toLowerCase().includes(searchTerm)) ||
            (a.type && a.type.toLowerCase().includes(searchTerm))
        );
    }
    
    // Update stats
    const statAcc = document.getElementById('statAccommodations');
    const statAvail = document.getElementById('statAvailable');
    const statOffers = document.getElementById('statAccOffers');
    
    if (statAcc) statAcc.textContent = accommodations.length;
    if (statAvail) statAvail.textContent = accommodations.filter(a => a.has_availability).length;
    if (statOffers) statOffers.textContent = accommodations.filter(a => a.offer).length;
    
    if (filtered.length === 0) {
        container.innerHTML = '<p style="padding: 40px; color: var(--slate); text-align: center;">Keine Unterkünfte gefunden</p>';
        return;
    }
    
    let html = '';
    filtered.forEach(a => {
        const typeLabel = a.type === 'ferienwohnung' ? 'Ferienwohnung' : 
                         a.type === 'hotel' ? 'Hotel' : 
                         a.type === 'pension' ? 'Pension' : 'Unterkunft';
        
        html += `
            <div class="restaurant-card" style="margin-bottom: 16px;">
                <div class="card-image" style="background-image: url('${a.image_url || 'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=800'}');">
                    <div class="availability-badge ${a.has_availability ? 'available' : 'full'}">
                        ${a.has_availability ? 'Verfügbar' : 'Ausgebucht'}
                    </div>
                    ${a.offer ? `<div class="special-badge">${a.offer.discount}</div>` : ''}
                </div>
                <div class="card-content">
                    <div class="card-top">
                        <h3 class="restaurant-name">${a.name}</h3>
                        <span style="background: var(--cream); padding: 4px 8px; border-radius: 4px; font-size: 11px; color: var(--primary);">${typeLabel}</span>
                    </div>
                    <div class="restaurant-meta">
                        <span class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            ${a.city || 'Ostfriesland'}
                        </span>
                        <span class="meta-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                            </svg>
                            max. ${a.max_guests || 4} Gäste
                        </span>
                    </div>
                    <div style="font-weight: 700; color: var(--primary); margin: 8px 0; font-size: 16px;">${a.price_info || ''}</div>
                    
                    <div class="card-actions">
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(a.name + ' ' + (a.city || 'Ostfriesland'))}" target="_blank" class="card-btn card-btn-secondary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="3 11 22 2 13 21 11 13 3 11"/>
                            </svg>
                            Route
                        </a>
                        ${a.whatsapp ? `
                            <a href="https://wa.me/${a.whatsapp.replace(/[^0-9]/g, '')}?text=${encodeURIComponent('Hallo! Ich interessiere mich für Ihre Unterkunft über Kiek mol in.')}" target="_blank" class="card-btn card-btn-whatsapp">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                </svg>
                                WhatsApp
                            </a>
                        ` : `
                            <a href="tel:${a.phone}" class="card-btn card-btn-secondary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                </svg>
                                Anrufen
                            </a>
                        `}
                        <button class="card-btn card-btn-primary" onclick="openAccommodationInquiry('${a.id}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            Anfragen
                        </button>
                        <button class="card-btn card-btn-secondary" onclick="openReviewsModal('accommodation', '${a.id}', '${a.name.replace(/'/g, "\\'")}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>
                            ⭐ Bewertungen
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function filterAccommodations(filter) {
    renderAccommodations(filter);
}

let currentAccFilter = 'all';

function setAccFilter(filter) {
    currentAccFilter = filter;
    
    // Update active chip
    document.querySelectorAll('#filterChipsAcc .chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.filter === filter);
    });
    
    renderAccommodations(filter);
}

function filterAccommodationsBySearch() {
    renderAccommodations(currentAccFilter);
}

function showMainView() {
    document.getElementById('mainView').style.display = 'block';
    document.getElementById('favoritesView').classList.remove('active');
    document.getElementById('accommodationsView').classList.remove('active');
    document.getElementById('eventsView').classList.remove('active');
    document.getElementById('attractionsView').classList.remove('active');
    if (document.getElementById('jobsView')) document.getElementById('jobsView').classList.remove('active');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('navHome').classList.add('active');
}

function showFavorites() {
    document.getElementById('mainView').style.display = 'none';
    document.getElementById('favoritesView').classList.add('active');
    document.getElementById('accommodationsView').classList.remove('active');
    document.getElementById('eventsView').classList.remove('active');
    document.getElementById('attractionsView').classList.remove('active');
    if (document.getElementById('jobsView')) document.getElementById('jobsView').classList.remove('active');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    
    renderFavorites();
}

function showAccommodations() {
    document.getElementById('mainView').style.display = 'none';
    document.getElementById('favoritesView').classList.remove('active');
    document.getElementById('accommodationsView').classList.add('active');
    document.getElementById('eventsView').classList.remove('active');
    document.getElementById('attractionsView').classList.remove('active');
    if (document.getElementById('jobsView')) document.getElementById('jobsView').classList.remove('active');
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('navAccommodations').classList.add('active');
    
    loadAccommodations();
}

function openAccommodationInquiry(accommodationId) {
    const accommodation = accommodations.find(a => a.id == accommodationId);
    if (!accommodation) return;
    
    document.getElementById('inquiryAccommodationId').value = accommodationId;
    document.getElementById('inquiryAccommodationName').textContent = accommodation.name;
    
    // Set default dates
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const dayAfter = new Date(today);
    dayAfter.setDate(dayAfter.getDate() + 3);
    
    document.getElementById('inquiryCheckIn').value = tomorrow.toISOString().split('T')[0];
    document.getElementById('inquiryCheckIn').min = today.toISOString().split('T')[0];
    document.getElementById('inquiryCheckOut').value = dayAfter.toISOString().split('T')[0];
    
    // Show booking link if available
    const bookingLinkDiv = document.getElementById('accommodationBookingLink');
    const bookingLinkBtn = document.getElementById('bookingLinkBtn');
    if (accommodation.booking_url) {
        bookingLinkBtn.href = accommodation.booking_url;
        bookingLinkDiv.style.display = 'block';
    } else {
        bookingLinkDiv.style.display = 'none';
    }
    
    openModal('accommodationInquiryModal');
}

async function submitAccommodationInquiry(e) {
    e.preventDefault();
    
    const accommodationId = document.getElementById('inquiryAccommodationId').value;
    const accommodation = accommodations.find(a => a.id == accommodationId);
    
    const inquiry = {
        accommodation_id: accommodationId,
        guest_name: document.getElementById('inquiryName').value,
        guest_email: document.getElementById('inquiryEmail').value,
        guest_phone: document.getElementById('inquiryPhone').value,
        check_in: document.getElementById('inquiryCheckIn').value,
        check_out: document.getElementById('inquiryCheckOut').value,
        guests_count: parseInt(document.getElementById('inquiryGuests').value),
        message: document.getElementById('inquiryMessage').value,
        status: 'pending'
    };
    
    if (useSupabase) {
        try {
            await supabasePost('accommodation_inquiries', inquiry);
            console.log('[OK] Anfrage gespeichert');
        } catch (e) {
            console.error('Fehler:', e);
        }
    }
    
    closeModal('accommodationInquiryModal');
    document.getElementById('accommodationInquiryForm').reset();
    
    // WhatsApp wenn vorhanden
    if (accommodation && accommodation.whatsapp) {
        const checkIn = new Date(inquiry.check_in).toLocaleDateString('de-DE');
        const checkOut = new Date(inquiry.check_out).toLocaleDateString('de-DE');
        const message = `Hallo! 

Ich interessiere mich für Ihre Unterkunft "${accommodation.name}":

Check-in: ${checkIn}
Check-out: ${checkOut}
${inquiry.guests_count} Gäste
Name: ${inquiry.guest_name}
Telefon: ${inquiry.guest_phone}
${inquiry.message ? `${inquiry.message}` : ''}

Gesendet über Kiek mol in`;
        
        const whatsappUrl = `https://wa.me/${accommodation.whatsapp.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }
    
    showToast('Anfrage gesendet! Die Unterkunft wird sich bei Ihnen melden.', 'success');
}

// ==================== ACCOMMODATIONS DASHBOARD ====================
async function loadAccommodationsDash() {
    if (!useSupabase) {
        renderAccommodationsDash();
        return;
    }
    
    try {
        const accData = await supabaseGet('accommodations', 'select=*&is_active=eq.true&order=name');
        accommodations = accData || [];
        
        const inquiryData = await supabaseGet('accommodation_inquiries', 'select=*&order=created_at.desc&limit=20');
        
        renderAccommodationsDash();
        renderAccommodationInquiries(inquiryData || []);
        updateAccommodationStats();
        
    } catch (e) {
        console.error('Fehler beim Laden:', e);
    }
}

function renderAccommodationsDash() {
    const container = document.getElementById('accommodationsDashList');
    if (!container) return;
    
    if (accommodations.length === 0) {
        container.innerHTML = '<p style="padding: 40px; color: var(--slate); text-align: center;">Noch keine Unterkünfte angelegt</p>';
        return;
    }
    
    let html = `
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: var(--cream); text-align: left;">
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Unterkunft</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Typ</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Ort</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Status</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Aktionen</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    accommodations.forEach(a => {
        const typeLabel = a.type === 'ferienwohnung' ? 'Ferienwohnung' : 
                         a.type === 'hotel' ? 'Hotel' : 
                         a.type === 'pension' ? 'Pension' : 'Unterkunft';
        
        html += `
            <tr style="border-bottom: 1px solid var(--sand);">
                <td style="padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 50px; height: 50px; background-image: url('${a.image_url || 'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=200'}'); background-size: cover; border-radius: 8px;"></div>
                        <div>
                            <div style="font-weight: 600; color: var(--dark);">${a.name}</div>
                            <div style="font-size: 13px; color: var(--slate);">${a.price_info || ''}</div>
                        </div>
                    </div>
                </td>
                <td style="padding: 16px; color: var(--dark);">${typeLabel}</td>
                <td style="padding: 16px; color: var(--dark);">${a.city || '-'}</td>
                <td style="padding: 16px;">
                    <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${a.has_availability ? 'rgba(52,199,89,0.15)' : 'rgba(255,149,0,0.15)'}; color: ${a.has_availability ? 'var(--success)' : 'var(--warning)'};">
                        ${a.has_availability ? 'Verfügbar' : 'Ausgebucht'}
                    </span>
                </td>
                <td style="padding: 16px;">
                    <div style="display: flex; gap: 8px;">
                        <button onclick="toggleAccommodationAvailability('${a.id}', ${a.has_availability})" style="padding: 8px 12px; background: ${a.has_availability ? 'rgba(255,149,0,0.15)' : 'rgba(52,199,89,0.15)'}; color: ${a.has_availability ? 'var(--warning)' : 'var(--success)'}; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;" title="${a.has_availability ? 'Als ausgebucht markieren' : 'Als verfügbar markieren'}">
                            ${a.has_availability ? 'Ausgebucht' : 'Verfügbar'}
                        </button>
                        <button onclick="deleteAccommodation('${a.id}', '${a.name}')" style="padding: 8px 12px; background: rgba(255,59,48,0.15); color: var(--danger); border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Löschen"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function renderAccommodationInquiries(inquiries) {
    const container = document.getElementById('accommodationInquiriesList');
    if (!container) return;
    
    if (!inquiries || inquiries.length === 0) {
        container.innerHTML = '<p style="padding: 20px; color: var(--slate); text-align: center;">Keine Anfragen</p>';
        return;
    }
    
    let html = '';
    inquiries.forEach(i => {
        const accommodation = accommodations.find(a => a.id === i.accommodation_id);
        const checkIn = new Date(i.check_in).toLocaleDateString('de-DE');
        const checkOut = new Date(i.check_out).toLocaleDateString('de-DE');
        
        html += `
            <div style="padding: 16px; border-bottom: 1px solid var(--sand); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600; color: var(--dark);">${i.guest_name}</div>
                    <div style="font-size: 13px; color: var(--slate);">
                        ${accommodation ? accommodation.name : 'Unterkunft'} • ${checkIn} - ${checkOut} • ${i.guests_count} Gäste
                    </div>
                    <div style="font-size: 13px; color: var(--slate); margin-top: 4px;">
                        ${i.guest_phone || '-'} • ${i.guest_email || '-'}
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${i.status === 'confirmed' ? 'rgba(52,199,89,0.15)' : i.status === 'cancelled' ? 'rgba(255,59,48,0.15)' : 'rgba(255,149,0,0.15)'}; color: ${i.status === 'confirmed' ? 'var(--success)' : i.status === 'cancelled' ? 'var(--danger)' : 'var(--warning)'};">
                        ${i.status === 'confirmed' ? 'Bestätigt' : i.status === 'cancelled' ? 'Storniert' : 'Neu'}
                    </span>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Update inquiry count
    const countEl = document.getElementById('accommodationInquiries');
    if (countEl) countEl.textContent = inquiries.filter(i => i.status === 'pending').length;
}

function updateAccommodationStats() {
    const totalEl = document.getElementById('totalAccommodations');
    const availEl = document.getElementById('availableAccommodations');
    const countEl = document.getElementById('accommodationCount');
    
    if (totalEl) totalEl.textContent = accommodations.length;
    if (availEl) availEl.textContent = accommodations.filter(a => a.has_availability).length;
    if (countEl) countEl.textContent = accommodations.length;
}

async function addAccommodation(e) {
    e.preventDefault();
    
    const accommodation = {
        name: document.getElementById('accName').value,
        type: document.getElementById('accType').value,
        city: document.getElementById('accCity').value || 'Greetsiel',
        price_info: document.getElementById('accPrice').value,
        max_guests: parseInt(document.getElementById('accMaxGuests').value) || 4,
        phone: document.getElementById('accPhone').value,
        whatsapp: document.getElementById('accWhatsapp').value,
        email: document.getElementById('accEmail').value,
        website: document.getElementById('accWebsite').value,
        booking_url: document.getElementById('accBookingUrl').value,
        is_active: true,
        has_availability: true,
        latitude: 53.5021,
        longitude: 7.0965
    };
    
    if (!useSupabase) {
        showToast('Keine Datenbankverbindung', 'error');
        return;
    }
    
    try {
        await supabasePost('accommodations', accommodation);
        
        closeModal('addAccommodationModal');
        document.getElementById('addAccommodationForm').reset();
        loadAccommodationsDash();
        showToast(`${accommodation.name} angelegt!`, 'success');
        
    } catch (e) {
        showToast('Fehler: ' + e.message, 'error');
    }
}

async function toggleAccommodationAvailability(id, currentStatus) {
    if (!useSupabase) return;
    
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/accommodations?id=eq.${id}`, {
            method: 'PATCH',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ has_availability: !currentStatus })
        });
        
        loadAccommodationsDash();
        loadAccommodations();
        showToast(currentStatus ? 'Als ausgebucht markiert' : 'Als verfügbar markiert', 'success');
        
    } catch (e) {
        showToast('Fehler: ' + e.message, 'error');
    }
}

async function deleteAccommodation(id, name) {
    if (!confirm(`Unterkunft "${name}" wirklich löschen?`)) return;
    
    if (!useSupabase) return;
    
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/accommodations?id=eq.${id}`, {
            method: 'DELETE',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        loadAccommodationsDash();
        loadAccommodations();
        showToast('Unterkunft gelöscht', 'success');
        
    } catch (e) {
        showToast('Fehler: ' + e.message, 'error');
    }
}

// ==================== CUSTOMER MANAGEMENT ====================
let customers = [];

async function loadCustomers() {
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/customers?select=*&role=neq.superadmin&order=created_at.desc`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        if (response.ok) {
            customers = await response.json();
            console.log('[OK] Kunden geladen:', customers.length);
            renderCustomers();
            updateCustomerStats();
            populateRestaurantDropdown();
        }
    } catch (e) {
        console.error('Fehler beim Laden der Kunden:', e);
    }
}

function renderCustomers() {
    const container = document.getElementById('customersList');
    if (!container) return;
    
    if (customers.length === 0) {
        container.innerHTML = '<p style="padding: 40px; color: var(--slate); text-align: center;">Noch keine Kunden angelegt</p>';
        return;
    }
    
    let html = `
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: var(--cream); text-align: left;">
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Kunde</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Restaurant</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Beitrag</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Status</th>
                    <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; color: var(--slate);">Aktionen</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    customers.forEach(c => {
        const statusColor = c.payment_status === 'paid' ? 'var(--success)' : 
                           c.payment_status === 'overdue' ? 'var(--danger)' : 'var(--warning)';
        const statusBg = c.payment_status === 'paid' ? 'rgba(52,199,89,0.15)' : 
                        c.payment_status === 'overdue' ? 'rgba(255,59,48,0.15)' : 'rgba(255,149,0,0.15)';
        const statusText = c.payment_status === 'paid' ? 'Bezahlt' : 
                          c.payment_status === 'overdue' ? 'Überfällig' : 'Ausstehend';
        
        const restaurant = APP_DATA.restaurants.find(r => r.id === c.restaurant_id);
        
        html += `
            <tr style="border-bottom: 1px solid var(--sand);">
                <td style="padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">${c.name.charAt(0).toUpperCase()}</div>
                        <div>
                            <div style="font-weight: 600; color: var(--dark);">${c.name}</div>
                            <div style="font-size: 13px; color: var(--slate);">${c.email}</div>
                        </div>
                    </div>
                </td>
                <td style="padding: 16px; color: var(--dark);">${restaurant ? restaurant.name : '<span style="color: var(--slate);">-</span>'}</td>
                <td style="padding: 16px; font-weight: 600; color: var(--dark);">${c.monthly_fee ? c.monthly_fee.toFixed(2) + ' €' : '-'}</td>
                <td style="padding: 16px;">
                    <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${statusBg}; color: ${statusColor};">${statusText}</span>
                </td>
                <td style="padding: 16px;">
                    <div style="display: flex; gap: 8px;">
                        <button onclick="openPaymentModal('${c.id}', '${c.name.replace(/'/g, "\\'")}', ${c.monthly_fee || 29.90})" style="padding: 8px 12px; background: rgba(52,199,89,0.15); color: var(--success); border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Zahlung erfassen"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></button>
                        <button onclick="toggleCustomerStatus('${c.id}', ${c.is_active})" style="padding: 8px 12px; background: ${c.is_active ? 'rgba(255,149,0,0.15)' : 'rgba(52,199,89,0.15)'}; color: ${c.is_active ? 'var(--warning)' : 'var(--success)'}; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="${c.is_active ? 'Sperren' : 'Aktivieren'}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">${c.is_active ? '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>' : '<polyline points="20 6 9 17 4 12"/>'}</svg></button>
                        <button onclick="deleteCustomer('${c.id}', '${c.name.replace(/'/g, "\\'")}')\" style="padding: 8px 12px; background: rgba(255,59,48,0.15); color: var(--danger); border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Löschen"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function updateCustomerStats() {
    const total = customers.length;
    const paid = customers.filter(c => c.payment_status === 'paid').length;
    const pending = customers.filter(c => c.payment_status === 'pending').length;
    const overdue = customers.filter(c => c.payment_status === 'overdue').length;
    
    const totalEl = document.getElementById('totalCustomers');
    const paidEl = document.getElementById('paidCustomers');
    const pendingEl = document.getElementById('pendingCustomers');
    const overdueEl = document.getElementById('overdueCustomers');
    const countEl = document.getElementById('customerCount');
    
    if (totalEl) totalEl.textContent = total;
    if (paidEl) paidEl.textContent = paid;
    if (pendingEl) pendingEl.textContent = pending;
    if (overdueEl) overdueEl.textContent = overdue;
    if (countEl) countEl.textContent = total;
}

function populateRestaurantDropdown() {
    const select = document.getElementById('customerRestaurant');
    if (!select) return;
    
    let html = '<option value="">-- Kein Restaurant --</option>';
    APP_DATA.restaurants.forEach(r => {
        html += `<option value="${r.id}">${r.name}</option>`;
    });
    select.innerHTML = html;
}

function toggleNewRestaurant() {
    const select = document.getElementById('customerRestaurant');
    const fields = document.getElementById('newRestaurantFields');
    if (fields) {
        fields.style.display = select.value ? 'none' : 'block';
    }
}

async function addCustomer(e) {
    e.preventDefault();
    
    const name = document.getElementById('customerName').value;
    const email = document.getElementById('customerEmail').value;
    const password = document.getElementById('customerPassword').value;
    const phone = document.getElementById('customerPhone').value;
    let restaurantId = document.getElementById('customerRestaurant').value;
    const fee = parseFloat(document.getElementById('customerFee').value) || 29.90;
    
    console.log('Kunde anlegen:', name, email);
    
    try {
        // Wenn kein Restaurant ausgewählt, neues anlegen
        if (!restaurantId) {
            const restName = document.getElementById('newRestName').value;
            if (!restName) {
                showToast('Bitte Restaurant-Name eingeben', 'error');
                return;
            }
            
            const restCity = document.getElementById('newRestCity').value || 'Greetsiel';
            const restCuisine = document.getElementById('newRestCuisine').value || 'deutsch';
            const restPhone = document.getElementById('newRestPhone').value || '';
            const restWhatsapp = document.getElementById('newRestWhatsapp').value || '';
            const restWebsite = document.getElementById('newRestWebsite').value || '';
            const restFacebook = document.getElementById('newRestFacebook').value || '';
            const restInstagram = document.getElementById('newRestInstagram').value || '';
            const restMenu = document.getElementById('newRestMenu').value || '';
            const restStreet = document.getElementById('newRestStreet').value || '';
            const restGoogleMaps = document.getElementById('newRestGoogleMaps').value || '';
            
            // Koordinaten basierend auf Ort
            const cityCoords = {
                'Greetsiel': { lat: 53.5021, lng: 7.0965 },
                'Norddeich': { lat: 53.6108, lng: 7.1542 },
                'Norden': { lat: 53.5967, lng: 7.2058 },
                'Aurich': { lat: 53.4714, lng: 7.4808 },
                'Emden': { lat: 53.3594, lng: 7.2060 }
            };
            const coords = cityCoords[restCity] || { lat: 53.5021, lng: 7.0965 };
            const lat = coords.lat + (Math.random() - 0.5) * 0.005;
            const lng = coords.lng + (Math.random() - 0.5) * 0.005;
            
            // Restaurant in Supabase anlegen
            const response = await fetch(`${SUPABASE_URL}/rest/v1/restaurants`, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify({
                    name: restName,
                    city: restCity,
                    street: restStreet,
                    cuisine_type: [restCuisine],
                    phone: restPhone,
                    whatsapp: restWhatsapp,
                    website: restWebsite,
                    facebook: restFacebook,
                    instagram: restInstagram,
                    menu_url: restMenu,
                    google_maps_url: restGoogleMaps,
                    is_active: true,
                    is_open: true,
                    rating: 4.5,
                    latitude: lat,
                    longitude: lng
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                restaurantId = data[0].id;
                console.log('[OK] Restaurant angelegt:', restName);
                
                // Lokal auch hinzufügen
                APP_DATA.restaurants.push({
                    id: restaurantId,
                    name: restName,
                    cuisine: restCuisine,
                    rating: 4.5,
                    freeTables: 8,
                    waitTime: 0,
                    phone: restPhone,
                    whatsapp: restWhatsapp,
                    website: restWebsite,
                    googleMapsUrl: restGoogleMaps,
                    lat: lat,
                    lng: lng,
                    image: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800',
                    offer: null
                });
            } else {
                const error = await response.json();
                throw new Error(error.message || 'Restaurant konnte nicht angelegt werden');
            }
        }
        
        // Kunde anlegen
        console.log('Speichere Kunde in Supabase...');
        
        // SEPA-Daten
        const accountHolder = document.getElementById('customerAccountHolder')?.value || '';
        const iban = document.getElementById('customerIBAN')?.value?.replace(/\s/g, '') || '';
        const bic = document.getElementById('customerBIC')?.value || '';
        const sepaMandat = document.getElementById('customerSEPAMandat')?.checked || false;
        const mandateRef = sepaMandat ? 'KMI-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase() : '';
        
        const customerResponse = await fetch(`${SUPABASE_URL}/rest/v1/customers`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify({
                name: name,
                email: email,
                password: password,
                phone: phone,
                restaurant_id: restaurantId || null,
                monthly_fee: fee,
                payment_status: 'pending',
                is_active: true,
                role: 'restaurant',
                account_holder: accountHolder,
                iban: iban,
                bic: bic,
                sepa_mandate: sepaMandat,
                mandate_reference: mandateRef,
                mandate_date: sepaMandat ? new Date().toISOString().split('T')[0] : null
            })
        });
        
        if (!customerResponse.ok) {
            const errorText = await customerResponse.text();
            console.error('Kunde Fehler:', errorText);
            throw new Error(errorText);
        }
        
        console.log('[OK] Kunde gespeichert');
        
        closeModal('addCustomerModal');
        const addCustomerForm = document.getElementById('addCustomerForm');
        if (addCustomerForm) addCustomerForm.reset();
        const newRestaurantFields = document.getElementById('newRestaurantFields');
        if (newRestaurantFields) newRestaurantFields.style.display = 'block';
        
        try { loadCustomers(); } catch(e) { console.log('loadCustomers error:', e); }
        try { renderRestaurants(); } catch(e) { console.log('renderRestaurants error:', e); }
        try { populateRestaurantDropdown(); } catch(e) { console.log('populateRestaurantDropdown error:', e); }
        
        showToast(`Kunde ${name} angelegt!`, 'success');
        
    } catch (e) {
        console.error('Fehler:', e);
        showToast('Fehler: ' + e.message, 'error');
    }
}

function openPaymentModal(customerId, customerName, amount) {
    document.getElementById('paymentCustomerId').value = customerId;
    document.getElementById('paymentCustomerName').textContent = customerName;
    document.getElementById('paymentAmount').value = amount;
    openModal('paymentModal');
}

async function recordPayment() {
    const customerId = document.getElementById('paymentCustomerId').value;
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const method = document.getElementById('paymentMethod').value;
    
    if (!useSupabase) {
        showToast('Keine Datenbankverbindung', 'error');
        return;
    }
    
    try {
        // Zahlung speichern
        await supabasePost('payments', {
            customer_id: customerId,
            amount,
            payment_method: method,
            status: 'completed'
        });
        
        // Kundenstatus aktualisieren
        const nextMonth = new Date();
        nextMonth.setMonth(nextMonth.getMonth() + 1);
        
        await fetch(`${SUPABASE_URL}/rest/v1/customers?id=eq.${customerId}`, {
            method: 'PATCH',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                payment_status: 'paid',
                last_payment_date: new Date().toISOString().split('T')[0],
                next_payment_date: nextMonth.toISOString().split('T')[0]
            })
        });
        
        closeModal('paymentModal');
        loadCustomers();
        showToast('Zahlung erfasst!', 'success');
        
    } catch (e) {
        showToast('Fehler: ' + e.message, 'error');
    }
}

// IBAN automatisch formatieren (DE89 3704 0044 ...)
function formatIBAN(input) {
    let value = input.value.replace(/\s/g, '').toUpperCase();
    let formatted = '';
    for (let i = 0; i < value.length; i++) {
        if (i > 0 && i % 4 === 0) formatted += ' ';
        formatted += value[i];
    }
    input.value = formatted;
    
    // Mandatsreferenz generieren wenn IBAN eingegeben
    if (value.length >= 22) {
        const mandateEl = document.getElementById('customerMandateRef');
        if (mandateEl && !mandateEl.value) {
            mandateEl.value = 'KMI-' + Date.now().toString().slice(-8);
        }
    }
}

// SEPA-Lastschrift CSV Export
function exportSEPACSV() {
    const sepaCustomers = customers.filter(c => c.iban && c.sepa_mandate);
    
    if (sepaCustomers.length === 0) {
        showToast('Keine Kunden mit SEPA-Mandat gefunden', 'error');
        return;
    }
    
    // CSV Header
    let csv = 'Mandatsreferenz;Kontoinhaber;IBAN;BIC;Betrag;Verwendungszweck;Mandatsdatum\n';
    
    // Daten
    sepaCustomers.forEach(c => {
        const restaurant = APP_DATA.restaurants.find(r => r.id === c.restaurant_id);
        const verwendung = `Kiek mol in - ${restaurant?.name || 'Monatsbeitrag'} - ${new Date().toLocaleDateString('de-DE', { month: 'long', year: 'numeric' })}`;
        
        csv += `${c.mandate_reference || ''};${c.account_holder || c.name};${c.iban};${c.bic || ''};${c.monthly_fee || 29.90};${verwendung};${c.mandate_date || ''}\n`;
    });
    
    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `SEPA-Lastschrift-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast(`${sepaCustomers.length} SEPA-Lastschriften exportiert`, 'success');
}

async function toggleCustomerStatus(customerId, currentStatus) {
    if (!useSupabase) return;
    
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/customers?id=eq.${customerId}`, {
            method: 'PATCH',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_active: !currentStatus })
        });
        
        loadCustomers();
        showToast(currentStatus ? 'Kunde gesperrt' : 'Kunde aktiviert', 'success');
        
    } catch (e) {
        showToast('Fehler: ' + e.message, 'error');
    }
}

async function deleteCustomer(customerId, customerName) {
    if (!confirm(`Kunde "${customerName}" wirklich löschen?`)) return;
    
    if (!useSupabase) {
        showToast('Supabase nicht verbunden', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/customers?id=eq.${customerId}`, {
            method: 'DELETE',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Prefer': 'return=minimal'
            }
        });
        
        if (!response.ok) {
            throw new Error('Löschen fehlgeschlagen: ' + response.status);
        }
        
        // Aus lokaler Liste entfernen
        customers = customers.filter(c => c.id !== customerId);
        renderCustomers();
        showToast('Kunde gelöscht', 'success');
        
    } catch (e) {
        console.error('Delete Customer Error:', e);
        showToast('Fehler: ' + e.message, 'error');
    }
}

// ==================== INITIALIZATION ====================
function init() {
    // Nur App-Daten löschen, NICHT Theme-Einstellungen
    localStorage.removeItem('kmi_favorites');
    localStorage.removeItem('kmi_reservations');
    localStorage.removeItem('kmi_offers');
    localStorage.removeItem('kmi_tables');
    console.log('[CLEAR] App-Daten zurückgesetzt (Theme behalten)');
    
    renderRestaurants();
    updateDashboard();
    initMap();
    
    // Supabase verbinden - Daten laden
    initSupabase();
    
    // Kunden laden
    setTimeout(() => loadCustomers(), 1000);
    
    // Wetter laden (Theme wird automatisch mit aktualisiert)
    loadWeather();
    
    // Bind offer form live preview
    const offerTitle = document.getElementById('offerTitle');
    const offerDiscount = document.getElementById('offerDiscount');
    const offerValidUntil = document.getElementById('offerValidUntil');
    
    if (offerTitle) offerTitle.addEventListener('input', updateOfferPreview);
    if (offerDiscount) offerDiscount.addEventListener('input', updateOfferPreview);
    if (offerValidUntil) offerValidUntil.addEventListener('input', updateOfferPreview);
    
    // Live Stats alle 30 Sekunden aktualisieren
    setInterval(() => {
        updateLiveStats();
    }, 30000);
    
    // Theme initialisieren
    initTheme();
    
    // Sprache initialisieren
    initLanguage();
    
    // Benachrichtigungen initialisieren
    initNotifications();
    
    // Profil initialisieren
    initProfile();
    
    // Auto-Refresh für Restaurant Updates (alle 30 Sekunden)
    setInterval(autoRefreshRestaurants, 30000);
    
    console.log('Kiek mol in - App initialisiert');
}

// ==================== NOTIFICATIONS ====================
let notifications = [];

function initNotifications() {
    // Gespeicherte Notifications laden
    const saved = localStorage.getItem('kmi_notifications');
    if (saved) {
        try {
            notifications = JSON.parse(saved);
        } catch (e) {
            notifications = [];
        }
    }
    
    // Keine Demo-Notifications - nur echte Daten
    renderNotifications();
    updateNotificationBadge();
}

function renderNotifications() {
    const container = document.getElementById('notificationList');
    if (!container) return;
    
    if (notifications.length === 0) {
        container.innerHTML = `
            <div class="empty-notifications">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
                <p>Keine Benachrichtigungen</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    notifications.forEach(n => {
        const timeAgo = getTimeAgo(n.time);
        html += `
            <div class="notification-item ${n.read ? '' : 'unread'}" onclick="markAsRead(${n.id})">
                <div class="notification-icon ${n.iconClass}">${n.icon}</div>
                <div class="notification-content">
                    <div class="notification-title">${n.title}</div>
                    <div class="notification-text">${n.text}</div>
                    <div class="notification-time">${timeAgo}</div>
                </div>
                ${n.read ? '' : '<div class="notification-dot"></div>'}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function getTimeAgo(timestamp) {
    const diff = Date.now() - timestamp;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Gerade eben';
    if (minutes < 60) return `Vor ${minutes} Min.`;
    if (hours < 24) return `Vor ${hours} Std.`;
    return `Vor ${days} Tag${days > 1 ? 'en' : ''}`;
}

function markAsRead(id) {
    const notification = notifications.find(n => n.id === id);
    if (notification) {
        notification.read = true;
        saveNotifications();
        renderNotifications();
        updateNotificationBadge();
    }
}

function updateNotificationBadge() {
    const badge = document.getElementById('notificationBadge');
    if (!badge) return;
    
    const unread = notifications.filter(n => !n.read).length;
    if (unread > 0) {
        badge.textContent = unread;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

function clearNotifications() {
    notifications = [];
    saveNotifications();
    renderNotifications();
    updateNotificationBadge();
    closeModal('notificationModal');
    showToast('Alle Benachrichtigungen gelöscht');
}

function saveNotifications() {
    localStorage.setItem('kmi_notifications', JSON.stringify(notifications));
}

function addNotification(type, icon, iconClass, title, text) {
    const notification = {
        id: Date.now(),
        type,
        icon,
        iconClass,
        title,
        text,
        time: Date.now(),
        read: false
    };
    
    notifications.unshift(notification);
    if (notifications.length > 20) notifications.pop();
    
    saveNotifications();
    renderNotifications();
    updateNotificationBadge();
    
    // Toast anzeigen
    showToast(`🔔 ${title}`);
}

// ==================== AUTO-REFRESH ====================
let previousFreeTables = {};

function autoRefreshRestaurants() {
    // Speichere vorherige Werte
    APP_DATA.restaurants.forEach(r => {
        if (previousFreeTables[r.id] === undefined) {
            previousFreeTables[r.id] = r.freeTables;
        }
    });
    
    // Simuliere Updates (in Produktion: API-Call)
    APP_DATA.restaurants.forEach(r => {
        const change = Math.floor(Math.random() * 3) - 1;
        const newTables = Math.max(0, Math.min(r.totalTables, r.freeTables + change));
        
        // Prüfe ob Favorit wieder frei wurde
        if (previousFreeTables[r.id] === 0 && newTables > 0) {
            if (APP_DATA.favorites.includes(r.id)) {
                addNotification(
                    'table',
                    'table',
                    'green',
                    'Tisch frei bei Favorit!',
                    `${r.name} hat wieder ${newTables} ${newTables === 1 ? 'Tisch' : 'Tische'} frei!`
                );
            }
        }
        
        previousFreeTables[r.id] = newTables;
        r.freeTables = newTables;
    });
    
    // UI aktualisieren
    renderRestaurants();
    updateMapMarkers();
}

// ==================== PROFILE / AUTH ====================
let currentUser = null;

function initProfile() {
    // Gespeicherten User laden
    const saved = localStorage.getItem('kmi_user');
    if (saved) {
        try {
            currentUser = JSON.parse(saved);
            updateProfileUI();
        } catch (e) {
            currentUser = null;
        }
    }
    renderProfileContent();
}

function renderProfileContent() {
    const container = document.getElementById('profileContent');
    if (!container) return;
    
    if (currentUser) {
        // Eingeloggt
        container.innerHTML = `
            <div style="text-align: center; padding: 10px 0 20px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 32px; color: white;">
                    ${currentUser.avatar || currentUser.name.charAt(0).toUpperCase()}
                </div>
                <h3 style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${currentUser.name}</h3>
                <p style="font-size: 14px; color: var(--text-secondary);">${currentUser.email}</p>
            </div>
            
            <div style="border-top: 1px solid var(--border-color); padding-top: 20px;">
                <div onclick="showMyReservations()" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer; margin-bottom: 10px;">
                    <div style="width: 40px; height: 40px; background: rgba(26, 95, 74, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" width="20" height="20">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary);">Meine Reservierungen</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${currentUser.reservations || 0} Buchungen</div>
                    </div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" width="20" height="20">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </div>
                
                <div onclick="showSection('favorites')" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer; margin-bottom: 10px;">
                    <div style="width: 40px; height: 40px; background: rgba(255, 59, 48, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#ff3b30" stroke-width="2" width="20" height="20">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary);">Meine Favoriten</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${APP_DATA.favorites.length} gespeichert</div>
                    </div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" width="20" height="20">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </div>
                
                <div onclick="openModal('themeModal'); closeModal('profileModal');" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer; margin-bottom: 20px;">
                    <div style="width: 40px; height: 40px; background: rgba(255, 149, 0, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#ff9500" stroke-width="2" width="20" height="20">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary);">Design</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Dark / Light Mode</div>
                    </div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" width="20" height="20">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </div>
            </div>
            
            <button onclick="logout()" style="width: 100%; padding: 14px; background: var(--bg-secondary); border: none; border-radius: 12px; font-size: 15px; font-weight: 600; color: var(--danger); cursor: pointer;">
                Abmelden
            </button>
        `;
    } else {
        // Nicht eingeloggt
        container.innerHTML = `
            <div style="text-align: center; padding: 20px 0;">
                <div style="width: 80px; height: 80px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="1.5" width="40" height="40">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </div>
                <h3 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">Noch nicht angemeldet</h3>
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px;">Melde dich an um deine Favoriten zu speichern und Reservierungen zu verwalten.</p>
                
                <button onclick="closeModal('profileModal'); openModal('loginModal');" class="btn btn-primary" style="margin-bottom: 16px;">
                    Jetzt anmelden
                </button>
                
                <p style="font-size: 13px; color: var(--text-secondary);">Du kannst die App auch ohne Anmeldung nutzen.</p>
            </div>
            
            <div style="border-top: 1px solid var(--border-color); padding-top: 20px; margin-top: 10px;">
                <div onclick="showSection('favorites'); closeModal('profileModal');" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer; margin-bottom: 10px;">
                    <div style="width: 40px; height: 40px; background: rgba(255, 59, 48, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#ff3b30" stroke-width="2" width="20" height="20">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary);">Meine Favoriten</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${APP_DATA.favorites.length} gespeichert (lokal)</div>
                    </div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" width="20" height="20">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </div>
                
                <div onclick="openModal('themeModal'); closeModal('profileModal');" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: 12px; cursor: pointer;">
                    <div style="width: 40px; height: 40px; background: rgba(255, 149, 0, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#ff9500" stroke-width="2" width="20" height="20">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary);">Design</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Dark / Light Mode</div>
                    </div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2" width="20" height="20">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </div>
            </div>
        `;
    }
}

function updateProfileUI() {
    const profileBtn = document.getElementById('profileBtn');
    if (profileBtn && currentUser) {
        profileBtn.style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%)';
        profileBtn.innerHTML = `<span style="color: white; font-weight: 700; font-size: 16px;">${currentUser.name.charAt(0).toUpperCase()}</span>`;
    }
}

// Supabase Client für Auth
let supabaseClient = null;

function initSupabaseAuth() {
    if (typeof supabase !== 'undefined' && supabase.createClient) {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true
            }
        });
        console.log('[OK] Supabase Auth Client initialisiert');
        
        // Auth State Listener
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth Event:', event, session ? 'mit Session' : 'ohne Session');
            if (event === 'SIGNED_IN' && session?.user) {
                handleGoogleLoginSuccess(session.user);
            } else if (event === 'SIGNED_OUT') {
                handleLogout();
            } else if (event === 'TOKEN_REFRESHED') {
                console.log('[OK] Token aktualisiert');
            }
        });
        
        // Check if returning from OAuth redirect
        handleOAuthRedirect();
        
        // Check if already logged in
        checkExistingSession();
    } else {
        console.log('[!] Supabase Client nicht verfügbar');
    }
}

// Handle OAuth Redirect (nach Google Login)
async function handleOAuthRedirect() {
    // Prüfe ob wir von OAuth zurückkommen (URL enthält access_token oder code)
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const queryParams = new URLSearchParams(window.location.search);
    
    if (hashParams.get('access_token') || queryParams.get('code')) {
        console.log('[OK] OAuth Redirect erkannt, verarbeite...');
        
        try {
            const { data, error } = await supabaseClient.auth.getSession();
            
            if (error) {
                console.error('OAuth Session Fehler:', error);
                showToast('Anmeldung fehlgeschlagen', 'error');
            } else if (data?.session?.user) {
                console.log('[OK] OAuth Session erfolgreich');
                // URL aufräumen (Hash entfernen)
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        } catch (e) {
            console.error('OAuth Redirect Fehler:', e);
        }
    }
}

async function checkExistingSession() {
    try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session?.user) {
            console.log('[OK] Bestehende Session gefunden');
            handleGoogleLoginSuccess(session.user);
        }
    } catch (e) {
        console.log('Keine bestehende Session');
    }
}

async function loginWithGoogle() {
    if (!supabaseClient) {
        showToast('Verbindung wird hergestellt...', 'default');
        initSupabaseAuth();
        setTimeout(loginWithGoogle, 500);
        return;
    }
    
    try {
        closeModal('loginModal');
        showToast('Weiterleitung zu Google...', 'default');
        
        const { data, error } = await supabaseClient.auth.signInWithOAuth({
            provider: 'google',
            options: {
                redirectTo: window.location.origin + window.location.pathname
            }
        });
        
        if (error) {
            console.error('Google Login Fehler:', error);
            showToast('Login fehlgeschlagen: ' + error.message, 'error');
        }
    } catch (e) {
        console.error('Google Login Fehler:', e);
        showToast('Login fehlgeschlagen', 'error');
    }
}

function handleGoogleLoginSuccess(user) {
    console.log('Google User:', user);
    
    const userEmail = user.email;
    
    // Prüfen ob User ein Gastronom ist (Email in customers Tabelle)
    checkIfGastronom(userEmail, user);
}

async function checkIfGastronom(email, googleUser) {
    try {
        // Prüfe ob Email in der Kunden-Tabelle existiert
        const response = await fetch(`${SUPABASE_URL}/rest/v1/customers?email=eq.${encodeURIComponent(email)}&is_active=eq.true`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        const customers = await response.json();
        
        if (customers && customers.length > 0) {
            // GASTRONOM gefunden!
            const customer = customers[0];
            console.log('[OK] Gastronom erkannt:', customer.name);
            
            currentUser = {
                id: googleUser.id,
                name: customer.name || googleUser.user_metadata?.full_name,
                email: email,
                avatar: googleUser.user_metadata?.avatar_url || null,
                role: 'gastronom',
                customerId: customer.id,
                restaurantId: customer.restaurant_id
            };
            
            localStorage.setItem('kmi_user', JSON.stringify(currentUser));
            localStorage.setItem('kmi_gastro_logged_in', 'true');
            
            closeModal('loginModal');
            
            // Gastro-Dashboard öffnen
            showGastroDashboard(customer);
            
        } else {
            // Normaler Gast
            console.log('[OK] Normaler Gast');
            
            currentUser = {
                id: googleUser.id,
                name: googleUser.user_metadata?.full_name || email.split('@')[0] || 'Gast',
                email: email,
                avatar: googleUser.user_metadata?.avatar_url || null,
                role: 'guest',
                reservations: 0,
                createdAt: googleUser.created_at
            };
            
            localStorage.setItem('kmi_user', JSON.stringify(currentUser));
            
            closeModal('loginModal');
            renderProfileContent();
            updateProfileUI();
            showToast(`Willkommen ${currentUser.name}!`, 'success');
            
            addNotification('login', '', 'icon-green', 'Angemeldet', `Willkommen zurück, ${currentUser.name}!`);
        }
        
    } catch (e) {
        console.error('Gastronom-Check Fehler:', e);
        // Fallback: als Gast anmelden
        currentUser = {
            id: googleUser.id,
            name: googleUser.user_metadata?.full_name || googleUser.email?.split('@')[0] || 'Gast',
            email: googleUser.email,
            avatar: googleUser.user_metadata?.avatar_url || null,
            role: 'guest'
        };
        localStorage.setItem('kmi_user', JSON.stringify(currentUser));
        closeModal('loginModal');
        renderProfileContent();
        updateProfileUI();
        showToast(`Willkommen ${currentUser.name}!`, 'success');
    }
}

// Gastro-Dashboard anzeigen
async function showGastroDashboard(customer) {
    // Restaurant-Daten laden
    let restaurant = APP_DATA.restaurants.find(r => r.id === customer.restaurant_id);
    
    if (!restaurant && customer.restaurant_id) {
        // Aus Supabase laden
        try {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/restaurants?id=eq.${customer.restaurant_id}`, {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY
                }
            });
            const data = await response.json();
            if (data && data[0]) {
                restaurant = data[0];
            }
        } catch (e) {
            console.error('Restaurant laden Fehler:', e);
        }
    }
    
    // Gastro-View aktivieren
    document.getElementById('guestView').classList.add('hidden');
    document.getElementById('dashboardView').classList.remove('active');
    
    // Gastro-Dashboard erstellen/anzeigen
    let gastroView = document.getElementById('gastroView');
    if (!gastroView) {
        gastroView = document.createElement('div');
        gastroView.id = 'gastroView';
        gastroView.className = 'gastro-view';
        document.querySelector('.app-container').appendChild(gastroView);
    }
    
    gastroView.innerHTML = renderGastroDashboardHTML(customer, restaurant);
    gastroView.classList.add('active');
    
    // Reservierungen für dieses Restaurant laden
    loadGastroReservations(customer.restaurant_id);
    
    // Tischplan initialisieren
    setTimeout(tpInit, 500);
    
    showToast(`Willkommen ${customer.name}!`, 'success');
}

function renderGastroDashboardHTML(customer, restaurant) {
    const restName = restaurant?.name || 'Mein Restaurant';
    
    return `
        <div class="gastro-dashboard" style="padding: 20px; padding-bottom: 100px;">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h1 style="font-size: 24px; font-weight: 700; color: var(--dark);">Moin, ${customer.name}!</h1>
                    <p style="color: var(--slate); margin-top: 4px;">${restName}</p>
                </div>
                <button onclick="gastroLogout()" style="padding: 10px 16px; background: var(--bg-secondary); border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; color: var(--slate);">
                    Abmelden
                </button>
            </div>
            
            <!-- Quick Stats -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px;">
                <div style="background: var(--bg-card); padding: 16px; border-radius: 16px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                    <div style="font-size: 28px; font-weight: 700; color: var(--primary);" id="gastroTodayRes">0</div>
                    <div style="font-size: 12px; color: var(--slate);">Heute</div>
                </div>
                <div style="background: var(--bg-card); padding: 16px; border-radius: 16px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                    <div style="font-size: 28px; font-weight: 700; color: var(--success);" id="gastroFreeTables">${restaurant?.free_tables || 0}</div>
                    <div style="font-size: 12px; color: var(--slate);">Freie Tische</div>
                </div>
                <div style="background: var(--bg-card); padding: 16px; border-radius: 16px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                    <div style="font-size: 28px; font-weight: 700; color: var(--warning);" id="gastroWeekRes">0</div>
                    <div style="font-size: 12px; color: var(--slate);">Diese Woche</div>
                </div>
            </div>
            
            <!-- PROFI TISCHPLAN -->
            <div class="tischplan-box">
                <div class="tischplan-header">
                    <h3>Tischplan</h3>
                    <button class="tischplan-btn-add" onclick="tpAddTable()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Tisch hinzufügen
                    </button>
                </div>
                <div class="tischplan-filters">
                    <button class="tischplan-filter active" data-filter="all" onclick="tpFilter('all')">Alle Tische</button>
                    <button class="tischplan-filter" data-filter="available" onclick="tpFilter('available')">Verfügbar</button>
                    <button class="tischplan-filter" data-filter="reserved" onclick="tpFilter('reserved')">Reserviert</button>
                    <button class="tischplan-filter" data-filter="billed" onclick="tpFilter('billed')">Besetzt</button>
                </div>
                <div class="tischplan-legend">
                    <div class="tischplan-legend-item"><div class="tischplan-legend-dot available"></div> Verfügbar</div>
                    <div class="tischplan-legend-item"><div class="tischplan-legend-dot reserved"></div> Reserviert</div>
                    <div class="tischplan-legend-item"><div class="tischplan-legend-dot billed"></div> Besetzt</div>
                    <div class="tischplan-legend-item"><div class="tischplan-legend-dot soon"></div> Bald frei</div>
                </div>
                <div class="tischplan-canvas" id="tischplanCanvas">
                    <!-- Statische Tische als Fallback -->
                    <div class="room-label kitchen" style="left:20px;top:20px;">🍳 Küche</div>
                    <div class="room-label bar" style="right:20px;top:45%;padding:15px;">🍺 Bar</div>
                    <div class="room-label" style="left:50%;bottom:10px;transform:translateX(-50%);">🚪 Eingang</div>
                    
                    <div class="tisch available" style="left:18%;top:20%;" onclick="tpOpen(1)">
                        <div class="tisch-body round"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-01</div>
                        <div class="tisch-label">4 Plätze</div>
                    </div>
                    
                    <div class="tisch available" style="left:40%;top:20%;" onclick="tpOpen(2)">
                        <div class="tisch-body"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-02</div>
                        <div class="tisch-label">4 Plätze</div>
                    </div>
                    
                    <div class="tisch billed" style="left:62%;top:18%;" onclick="tpOpen(3)">
                        <div class="tisch-body large"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-03</div>
                        <div class="tisch-badge">€</div>
                        <div class="tisch-label"><span class="amount">87€</span> · 45m</div>
                    </div>
                    
                    <div class="tisch reserved" style="left:18%;top:50%;" onclick="tpOpen(4)">
                        <div class="tisch-body"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-04</div>
                        <div class="tisch-badge">⏰</div>
                        <div class="tisch-label">19:30 Uhr</div>
                    </div>
                    
                    <div class="tisch available" style="left:40%;top:50%;" onclick="tpOpen(5)">
                        <div class="tisch-body round"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-05</div>
                        <div class="tisch-label">2 Plätze</div>
                    </div>
                    
                    <div class="tisch soon" style="left:62%;top:48%;" onclick="tpOpen(6)">
                        <div class="tisch-body large"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-06</div>
                        <div class="tisch-badge">€</div>
                        <div class="tisch-label"><span class="amount">156€</span> · 72m</div>
                    </div>
                    
                    <div class="tisch available" style="left:18%;top:78%;" onclick="tpOpen(7)">
                        <div class="tisch-body"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-07</div>
                        <div class="tisch-label">4 Plätze</div>
                    </div>
                    
                    <div class="tisch billed" style="left:40%;top:78%;" onclick="tpOpen(8)">
                        <div class="tisch-body"><div class="tisch-chairs"><div class="tisch-chair top"></div><div class="tisch-chair bottom"></div><div class="tisch-chair left"></div><div class="tisch-chair right"></div></div>T-08</div>
                        <div class="tisch-badge">€</div>
                        <div class="tisch-label"><span class="amount">43€</span> · 28m</div>
                    </div>
                </div>
                <div class="tischplan-stats">
                    <div class="tischplan-stat"><div class="tischplan-stat-num" id="tpAvailable" style="color:#3b82f6">0</div><div class="tischplan-stat-label">Verfügbar</div></div>
                    <div class="tischplan-stat"><div class="tischplan-stat-num" id="tpReserved" style="color:#ef4444">0</div><div class="tischplan-stat-label">Reserviert</div></div>
                    <div class="tischplan-stat"><div class="tischplan-stat-num" id="tpBilled" style="color:#22c55e">0</div><div class="tischplan-stat-label">Besetzt</div></div>
                    <div class="tischplan-stat"><div class="tischplan-stat-num" id="tpRevenue" style="color:var(--primary)">0€</div><div class="tischplan-stat-label">Umsatz</div></div>
                </div>
            </div>
            
            <!-- Heutiges Angebot -->
            <div style="background: var(--bg-card); padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--dark);">Tagesangebot</h3>
                <input type="text" id="gastroOfferTitle" placeholder="z.B. Fischplatte für 2 Personen" style="width: 100%; padding: 14px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 15px; margin-bottom: 12px; box-sizing: border-box;">
                <div style="display: flex; gap: 12px;">
                    <input type="text" id="gastroOfferDiscount" placeholder="z.B. -20%" style="flex: 1; padding: 14px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 15px;">
                    <button onclick="saveGastroOffer()" style="padding: 14px 24px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer;">Speichern</button>
                </div>
            </div>
            
            <!-- Reservierungen -->
            <div style="background: var(--bg-card); padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--dark);">Heutige Reservierungen</h3>
                <div id="gastroReservationsList">
                    <p style="color: var(--slate); text-align: center; padding: 20px;">Lade Reservierungen...</p>
                </div>
            </div>
        </div>
    `;
}

// Reservierungen für Gastronom laden
async function loadGastroReservations(restaurantId) {
    if (!restaurantId) return;
    
    const today = new Date().toISOString().split('T')[0];
    
    try {
        // Reservierungen laden mit neuen Spaltennamen
        const { data: reservations, error } = await supabase
            .from('reservations')
            .select('*')
            .eq('restaurant_id', restaurantId)
            .eq('reservation_date', today)
            .in('status', ['pending', 'confirmed', 'reminded', 'seated'])
            .order('reservation_time', { ascending: true });
        
        if (error) throw error;
        
        const container = document.getElementById('gastroReservationsList');
        if (!container) return;
        
        if (!reservations || reservations.length === 0) {
            container.innerHTML = '<p style="color: var(--slate); text-align: center; padding: 20px;">Keine Reservierungen für heute</p>';
            document.getElementById('gastroTodayRes').textContent = '0';
            return;
        }
        
        // Stats aktualisieren
        document.getElementById('gastroTodayRes').textContent = reservations.length;
        
        // Reservierungen rendern
        container.innerHTML = reservations.map(r => {
            const time = r.reservation_time ? r.reservation_time.substring(0,5) : '19:00';
            const statusColors = {
                'pending': { bg: 'rgba(245,158,11,0.15)', color: '#f59e0b', text: 'Ausstehend' },
                'confirmed': { bg: 'rgba(59,130,246,0.15)', color: '#3b82f6', text: 'Bestätigt' },
                'reminded': { bg: 'rgba(139,92,246,0.15)', color: '#8b5cf6', text: 'Erinnert' },
                'seated': { bg: 'rgba(34,197,94,0.15)', color: '#22c55e', text: 'Sitzt' }
            };
            const statusStyle = statusColors[r.status] || statusColors.pending;
            
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 10px; border-left: 4px solid ${statusStyle.color};">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--dark); display: flex; align-items: center; gap: 8px;">
                            ${r.guest_name || 'Gast'}
                            <span style="font-size: 11px; padding: 2px 8px; background: ${statusStyle.bg}; color: ${statusStyle.color}; border-radius: 6px;">${statusStyle.text}</span>
                        </div>
                        <div style="font-size: 13px; color: var(--slate); margin-top: 4px;">
                            👥 ${r.party_size || 2} Personen • 🕐 ${time} Uhr
                            ${r.table_id ? ' • 🪑 Tisch zugewiesen' : ''}
                        </div>
                        ${r.special_requests ? `<div style="font-size: 12px; color: var(--slate); margin-top: 4px;">📝 ${r.special_requests}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        ${r.status === 'pending' ? `
                            <button onclick="updateReservationStatus('${r.id}', 'confirmed')" style="padding: 8px 12px; background: rgba(34,197,94,0.15); color: #22c55e; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">✓ Bestätigen</button>
                        ` : ''}
                        ${r.status === 'confirmed' || r.status === 'reminded' ? `
                            <button onclick="updateReservationStatus('${r.id}', 'seated')" style="padding: 8px 12px; background: rgba(59,130,246,0.15); color: #3b82f6; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">🪑 Sitzt</button>
                        ` : ''}
                        ${r.status === 'seated' ? `
                            <button onclick="updateReservationStatus('${r.id}', 'finished')" style="padding: 8px 12px; background: rgba(34,197,94,0.15); color: #22c55e; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">✓ Fertig</button>
                        ` : ''}
                        <button onclick="updateReservationStatus('${r.id}', 'cancelled')" style="padding: 8px 12px; background: rgba(239,68,68,0.1); color: #ef4444; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">✕</button>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (e) {
        console.error('Reservierungen laden Fehler:', e);
        document.getElementById('gastroReservationsList').innerHTML = '<p style="color: var(--slate); text-align: center; padding: 20px;">Fehler beim Laden</p>';
    }
    
    // Auch Tische laden
    loadGastroTables(restaurantId);
}

// Reservierungsstatus aktualisieren
async function updateReservationStatus(reservationId, newStatus) {
    try {
        const { data, error } = await supabase.rpc('update_reservation_status', {
            p_reservation_id: reservationId,
            p_new_status: newStatus
        });
        
        if (error) throw error;
        
        if (data?.success) {
            showToast(`Status: ${newStatus}`, 'success');
            // Reload
            const customer = JSON.parse(localStorage.getItem('gastro_customer') || '{}');
            if (customer.restaurant_id) {
                loadGastroReservations(customer.restaurant_id);
            }
        } else {
            showToast(data?.error || 'Fehler', 'error');
        }
    } catch (e) {
        console.error('Status-Update Fehler:', e);
        showToast('Fehler beim Aktualisieren', 'error');
    }
}

// Tische aus Datenbank laden
async function loadGastroTables(restaurantId) {
    try {
        const today = new Date().toISOString().split('T')[0];
        
        const { data, error } = await supabase.rpc('get_live_table_status', {
            p_restaurant_id: restaurantId,
            p_date: today
        });
        
        if (error) throw error;
        
        if (data && data.length > 0) {
            // Konvertiere DB-Daten zu tpTables Format
            tpTables = data.map((t, idx) => {
                let status = 'available';
                if (t.current_reservation) status = 'billed';
                else if (t.next_reservation && isUpcomingSoon(t.next_reservation.time)) status = 'reserved';
                else if (t.current_status === 'blocked') status = 'blocked';
                
                return {
                    id: t.table_id,
                    num: t.table_number,
                    name: t.table_name,
                    seats: t.max_capacity,
                    area: t.area,
                    status: status,
                    shape: t.max_capacity > 6 ? 'large' : (t.max_capacity <= 2 ? 'round' : 'square'),
                    x: 15 + (idx % 3) * 28,
                    y: 18 + Math.floor(idx / 3) * 30,
                    currentRes: t.current_reservation,
                    nextRes: t.next_reservation,
                    upcoming: t.upcoming_count
                };
            });
            
            // Stats aktualisieren
            const available = tpTables.filter(t => t.status === 'available').length;
            const reserved = tpTables.filter(t => t.status === 'reserved').length;
            const billed = tpTables.filter(t => t.status === 'billed').length;
            
            document.getElementById('gastroFreeTables').textContent = available;
            
            tpRender();
            tpUpdateStats();
        }
    } catch (e) {
        console.error('Tische laden Fehler:', e);
    }
}

function isUpcomingSoon(timeStr) {
    if (!timeStr) return false;
    const now = new Date();
    const [h, m] = timeStr.split(':');
    const resTime = new Date(now);
    resTime.setHours(parseInt(h), parseInt(m), 0);
    const diff = (resTime - now) / 1000 / 60;
    return diff <= 30 && diff >= -15;
}

// ===== PROFI TISCHPLAN =====
var tpTables = [];
var tpFilter_current = 'all';

function tpInit() {
    console.log('tpInit gestartet');
    
    // Tische initialisieren
    if (tpTables.length === 0) {
        tpTables = [
            {id:1, num:'T-01', seats:4, status:'available', shape:'round', x:15, y:18},
            {id:2, num:'T-02', seats:4, status:'available', shape:'square', x:38, y:18},
            {id:3, num:'T-03', seats:6, status:'billed', shape:'large', x:62, y:15, amount:87, time:45},
            {id:4, num:'T-04', seats:4, status:'reserved', shape:'square', x:15, y:48},
            {id:5, num:'T-05', seats:2, status:'available', shape:'round', x:38, y:48},
            {id:6, num:'T-06', seats:8, status:'soon', shape:'large', x:62, y:45, amount:156, time:72},
            {id:7, num:'T-07', seats:4, status:'available', shape:'square', x:15, y:78},
            {id:8, num:'T-08', seats:4, status:'billed', shape:'square', x:38, y:78, amount:43, time:28}
        ];
    }
    
    var canvas = document.getElementById('tischplanCanvas');
    console.log('Canvas:', canvas);
    
    if (canvas) {
        // Direkt Content setzen
        tpRender();
        tpUpdateStats();
        console.log('Tischplan gerendert!');
    } else {
        console.log('Canvas nicht gefunden, retry...');
        setTimeout(tpInit, 500);
    }
}

function tpRender() {
    var c = document.getElementById('tischplanCanvas');
    if (!c) { console.log('tpRender: Canvas nicht da'); return; }
    
    var list = tpFilter_current === 'all' ? tpTables : tpTables.filter(function(t){ return t.status === tpFilter_current; });
    console.log('Rendering', list.length, 'Tische');
    
    var h = '';
    
    // Wände
    h += '<div class="room-wall" style="left:0;top:0;width:100%;height:12px;"></div>';
    h += '<div class="room-wall" style="left:0;top:0;width:12px;height:100%;"></div>';
    h += '<div class="room-wall" style="right:0;top:0;width:12px;height:100%;"></div>';
    h += '<div class="room-wall" style="left:0;bottom:0;width:35%;height:12px;"></div>';
    h += '<div class="room-wall" style="right:0;bottom:0;width:35%;height:12px;"></div>';
    
    // Eingang
    h += '<div class="room-label" style="left:50%;bottom:8px;transform:translateX(-50%);">';
    h += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"/></svg>';
    h += 'Eingang</div>';
    
    // Küche
    h += '<div class="room-label kitchen" style="left:20px;top:20px;">';
    h += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>';
    h += 'Küche</div>';
    
    // Bar
    h += '<div class="room-label bar" style="right:20px;top:50%;transform:translateY(-50%);flex-direction:column;padding:12px 16px;">';
    h += '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 22h8M12 11v11M17 2c-.7 0-1.4.3-2 1-.5-.7-1.3-1-2-1-1.2 0-2.6.7-3 3h10c-.4-2.3-1.8-3-3-3z"/><path d="M7 6c-.7 0-1.4.3-2 1-.5-.7-1.3-1-2-1-1.2 0-2.6.7-3 3h10c-.4-2.3-1.8-3-3-3z"/></svg>';
    h += '<span style="margin-top:4px;">Bar</span></div>';
    
    // Tische rendern
    if (list.length === 0) {
        h += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--slate);font-size:15px;font-family:DM Sans,sans-serif;">Keine Tische in dieser Ansicht</div>';
    } else {
        for (var i = 0; i < list.length; i++) {
            var t = list[i];
            var px = t.x || (15 + (i % 3) * 25);
            var py = t.y || (18 + Math.floor(i / 3) * 28);
            
            h += '<div class="tisch ' + t.status + '" style="left:' + px + '%;top:' + py + '%;" onclick="tpOpen(' + t.id + ')">';
            h += '<div class="tisch-body ' + (t.shape || 'square') + '">';
            
            // Stühle
            h += '<div class="tisch-chairs">';
            h += '<div class="tisch-chair top"></div>';
            h += '<div class="tisch-chair bottom"></div>';
            h += '<div class="tisch-chair left"></div>';
            h += '<div class="tisch-chair right"></div>';
            h += '</div>';
            
            h += t.num;
            h += '</div>';
            
            // Badge
            if (t.status === 'reserved') {
                h += '<div class="tisch-badge">⏰</div>';
            } else if (t.status === 'billed' || t.status === 'soon') {
                h += '<div class="tisch-badge">€</div>';
            }
            
            // Label
            if (t.status === 'available') {
                h += '<div class="tisch-label">' + t.seats + ' Plätze</div>';
            } else if (t.amount) {
                h += '<div class="tisch-label"><span class="amount">' + t.amount + '€</span> · ' + t.time + 'm</div>';
            } else if (t.status === 'reserved') {
                h += '<div class="tisch-label">Reserviert</div>';
            }
            
            h += '</div>';
        }
    }
    
    c.innerHTML = h;
}

function tpFilter(f) {
    tpFilter_current = f;
    document.querySelectorAll('.tischplan-filter').forEach(function(b){ b.classList.remove('active'); if(b.dataset.filter===f) b.classList.add('active'); });
    tpRender();
}

function tpUpdateStats() {
    var av=0, res=0, bil=0, rev=0;
    tpTables.forEach(function(t){ if(t.status==='available')av++; if(t.status==='reserved')res++; if(t.status==='billed'||t.status==='soon')bil++; if(t.amount)rev+=t.amount; });
    var e1=document.getElementById('tpAvailable'), e2=document.getElementById('tpReserved'), e3=document.getElementById('tpBilled'), e4=document.getElementById('tpRevenue');
    if(e1)e1.textContent=av; if(e2)e2.textContent=res; if(e3)e3.textContent=bil; if(e4)e4.textContent=rev+'€';
    var ft=document.getElementById('gastroFreeTables'); if(ft)ft.textContent=av;
}

function tpOpen(id) {
    var t = tpTables.find(function(x){return x.id===id;});
    if (!t) return;
    var colors = {'available':'#3b82f6','reserved':'#ef4444','billed':'#22c55e','soon':'#f59e0b'};
    var h = '<div id="tpModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px" onclick="if(event.target===this)this.remove()">';
    h += '<div style="background:var(--bg-card);border-radius:20px;width:100%;max-width:340px;overflow:hidden">';
    h += '<div style="padding:24px;text-align:center;background:'+(colors[t.status]||'#3b82f6')+';color:white"><div style="font-size:36px;font-weight:700">'+t.num+'</div><div style="opacity:0.9">'+t.seats+' Plätze</div></div>';
    h += '<div style="padding:20px">';
    if (t.status === 'available') {
        h += '<button onclick="tpSet('+id+',\'billed\')" style="width:100%;padding:14px;background:#22c55e;color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;margin-bottom:10px">🍽️ Gäste setzen</button>';
        h += '<button onclick="tpSet('+id+',\'reserved\')" style="width:100%;padding:14px;background:#ef4444;color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer">📅 Reservieren</button>';
    } else if (t.status === 'billed' || t.status === 'soon') {
        h += '<div style="background:var(--bg-secondary);padding:14px;border-radius:12px;margin-bottom:14px"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Umsatz</span><b style="color:#22c55e">'+(t.amount||0)+'€</b></div><div style="display:flex;justify-content:space-between"><span>Zeit</span><b>'+(t.time||0)+' Min</b></div></div>';
        h += '<button onclick="tpAddAmount('+id+')" style="width:100%;padding:14px;background:#ff6b35;color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;margin-bottom:10px">💰 Betrag +</button>';
        h += '<button onclick="tpSet('+id+',\'available\')" style="width:100%;padding:14px;background:#3b82f6;color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer">✓ Freigeben</button>';
    } else {
        h += '<button onclick="tpSet('+id+',\'billed\')" style="width:100%;padding:14px;background:#22c55e;color:white;border:none;border-radius:12px;font-weight:600;cursor:pointer;margin-bottom:10px">🍽️ Gäste da</button>';
        h += '<button onclick="tpSet('+id+',\'available\')" style="width:100%;padding:14px;background:var(--bg-secondary);color:var(--dark);border:none;border-radius:12px;font-weight:600;cursor:pointer">✗ Stornieren</button>';
    }
    h += '</div><div style="padding:0 20px 20px"><button onclick="document.getElementById(\'tpModal\').remove()" style="width:100%;padding:12px;background:var(--bg-secondary);color:var(--slate);border:none;border-radius:10px;cursor:pointer">Schließen</button></div></div></div>';
    document.body.insertAdjacentHTML('beforeend', h);
}

function tpSet(id, status) {
    var t = tpTables.find(function(x){return x.id===id;});
    if(t){ t.status=status; if(status==='billed'||status==='available'){t.time=0;t.amount=0;} }
    var m=document.getElementById('tpModal'); if(m)m.remove();
    tpRender(); tpUpdateStats(); showToast('Tisch aktualisiert','success');
}

function tpAddAmount(id) {
    var val = prompt('Betrag (€):');
    if(!val) return;
    var t = tpTables.find(function(x){return x.id===id;});
    if(t) t.amount = (t.amount||0) + (parseFloat(val)||0);
    var m=document.getElementById('tpModal'); if(m)m.remove();
    tpRender(); tpUpdateStats(); showToast(val+'€ hinzugefügt','success');
}

function tpAddTable() {
    var num = prompt('Tischnummer (z.B. T-14):');
    if(!num) return;
    var seats = parseInt(prompt('Plätze:','4')) || 4;
    var newId = Math.max.apply(null,tpTables.map(function(t){return t.id;}))+1;
    tpTables.push({id:newId, num:num, seats:seats, status:'available', shape:'square'});
    tpRender(); tpUpdateStats(); showToast('Tisch '+num+' hinzugefügt','success');
}

// ===== ADMIN TISCHPLAN =====
async function loadAdminTischplan() {
    var select = document.getElementById('adminTischplanSelect');
    if (!select) return;
    
    // Restaurants laden
    if (APP_DATA && APP_DATA.restaurants) {
        select.innerHTML = '<option value="">-- Restaurant wählen --</option>';
        APP_DATA.restaurants.forEach(function(r) {
            select.innerHTML += '<option value="' + r.id + '">' + r.name + ' (' + (r.city || 'Ostfriesland') + ')</option>';
        });
    }
}

function adminLoadTischplan(restaurantId) {
    var box = document.getElementById('adminTischplanBox');
    if (!restaurantId) {
        if (box) box.style.display = 'none';
        return;
    }
    if (box) box.style.display = 'block';
    
    // Demo-Tische für dieses Restaurant generieren
    tpTables = [
        {id:1, num:'T-01', seats:4, status:'available', shape:'square'},
        {id:2, num:'T-02', seats:4, status:'available', shape:'round'},
        {id:3, num:'T-03', seats:6, status:'billed', shape:'square', amount:87, time:45},
        {id:4, num:'T-04', seats:4, status:'reserved', shape:'square'},
        {id:5, num:'T-05', seats:2, status:'available', shape:'round'},
        {id:6, num:'T-06', seats:8, status:'soon', shape:'large', amount:156, time:72},
        {id:7, num:'T-07', seats:4, status:'available', shape:'square'},
        {id:8, num:'T-08', seats:4, status:'billed', shape:'square', amount:43, time:28}
    ];
    
    // Admin Canvas verwenden
    tpRenderAdmin();
    tpUpdateStatsAdmin();
}

function tpRenderAdmin() {
    var c = document.getElementById('adminTischplanCanvas');
    if (!c) { tpRender(); return; }
    
    var list = tpFilter_current === 'all' ? tpTables : tpTables.filter(function(t){ return t.status === tpFilter_current; });
    
    // Raum-Elemente
    var h = '';
    h += '<div class="room-element" style="left:0;top:0;width:100%;height:8px;background:#64748b;"></div>';
    h += '<div class="room-element" style="right:0;top:0;width:8px;height:100%;background:#64748b;"></div>';
    h += '<div class="room-element" style="left:0;bottom:0;width:40%;height:8px;background:#64748b;"></div>';
    h += '<div class="room-element" style="right:0;bottom:0;width:40%;height:8px;background:#64748b;"></div>';
    h += '<div class="room-element" style="left:0;top:0;width:8px;height:100%;background:#64748b;"></div>';
    h += '<div class="room-element" style="left:40%;bottom:0;width:20%;height:20px;background:#22c55e;color:white;font-size:11px;">🚪 Eingang</div>';
    h += '<div class="room-element" style="right:15px;top:50%;transform:translateY(-50%);width:60px;height:80px;background:#8b5cf6;color:white;flex-direction:column;font-size:10px;border-radius:8px;">🍺<br>Bar</div>';
    
    if (list.length === 0) {
        h += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--slate);">Keine Tische</div>';
    } else {
        for (var i = 0; i < list.length; i++) {
            var t = list[i];
            var posStyle = 'left:' + (t.x || 20 + i*15) + '%;top:' + (t.y || 30) + '%;';
            h += '<div class="tisch ' + t.status + '" style="' + posStyle + '" onclick="tpOpen(' + t.id + ')">';
            h += '<div class="tisch-shape ' + (t.shape || 'square') + '">';
            h += '<div class="tisch-chairs"><div class="chair top"></div><div class="chair bottom"></div><div class="chair left"></div><div class="chair right"></div></div>';
            h += t.num + '</div>';
            if (t.status === 'reserved') h += '<div class="tisch-badge">⏰</div>';
            else if (t.status === 'billed' || t.status === 'soon') h += '<div class="tisch-badge">€</div>';
            if (t.status === 'available') h += '<div class="tisch-info">' + t.seats + ' Pl.</div>';
            else if (t.amount) h += '<div class="tisch-info"><span class="tisch-amount">' + t.amount + '€</span></div>';
            h += '</div>';
        }
    }
    c.innerHTML = h;
}

function tpUpdateStatsAdmin() {
    var av=0, res=0, bil=0, rev=0;
    tpTables.forEach(function(t){ if(t.status==='available')av++; if(t.status==='reserved')res++; if(t.status==='billed'||t.status==='soon')bil++; if(t.amount)rev+=t.amount; });
    var e1=document.getElementById('adminTpAvailable'), e2=document.getElementById('adminTpReserved'), e3=document.getElementById('adminTpBilled'), e4=document.getElementById('adminTpRevenue');
    if(e1)e1.textContent=av; if(e2)e2.textContent=res; if(e3)e3.textContent=bil; if(e4)e4.textContent=rev+'€';
    tpUpdateStats(); // Auch normale Stats
}

// Tische aktualisieren (Kompatibilität)
async function updateGastroTables(change) {
    tpUpdateStats();
}

// Angebot speichern
async function saveGastroOffer() {
    const title = document.getElementById('gastroOfferTitle')?.value;
    const discount = document.getElementById('gastroOfferDiscount')?.value;
    
    if (!title) {
        showToast('Bitte Angebot eingeben', 'error');
        return;
    }
    
    const restaurantId = currentUser?.restaurantId;
    if (!restaurantId) return;
    
    try {
        // Altes Angebot löschen
        await fetch(`${SUPABASE_URL}/rest/v1/offers?restaurant_id=eq.${restaurantId}`, {
            method: 'DELETE',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        // Neues Angebot speichern
        await fetch(`${SUPABASE_URL}/rest/v1/offers`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                restaurant_id: restaurantId,
                title: title,
                discount: discount,
                valid_until: new Date(Date.now() + 24*60*60*1000).toISOString().split('T')[0]
            })
        });
        
        showToast('Angebot gespeichert!', 'success');
        
    } catch (e) {
        showToast('Fehler beim Speichern', 'error');
    }
}

// Reservierung bestätigen
async function confirmGastroReservation(reservationId) {
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/reservations?id=eq.${reservationId}`, {
            method: 'PATCH',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: 'confirmed' })
        });
        
        showToast('Reservierung bestätigt!', 'success');
        loadGastroReservations(currentUser?.restaurantId);
        
    } catch (e) {
        showToast('Fehler', 'error');
    }
}

// Gastro Logout
function gastroLogout() {
    localStorage.removeItem('kmi_gastro_logged_in');
    localStorage.removeItem('kmi_user');
    currentUser = null;
    
    // Zurück zur Gäste-App
    const gastroView = document.getElementById('gastroView');
    if (gastroView) gastroView.classList.remove('active');
    document.getElementById('guestView').classList.remove('hidden');
    
    if (supabaseClient) {
        supabaseClient.auth.signOut();
    }
    
    renderProfileContent();
    updateProfileUI();
    showToast('Abgemeldet', 'success');
}

function handleLogout() {
    currentUser = null;
    localStorage.removeItem('kmi_user');
    renderProfileContent();
    updateProfileUI();
}

async function logout() {
    if (supabaseClient) {
        await supabaseClient.auth.signOut();
    }
    handleLogout();
    showToast('Erfolgreich abgemeldet', 'success');
}

// Init Auth when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initSupabaseAuth, 1000);
    initNewFeatures(); // Gezeiten, Gamification, etc.
    checkGroupFromURL(); // Gruppen-Link prüfen
});

// Prüft ob jemand über einen Gruppen-Link kommt
function checkGroupFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const groupId = urlParams.get('group');
    
    if (groupId) {
        // Gruppen-Daten aus localStorage laden
        const savedGroups = JSON.parse(localStorage.getItem('kmi_groups') || '{}');
        
        if (savedGroups[groupId]) {
            currentGroupData = savedGroups[groupId];
            setTimeout(() => {
                openModal('groupVotingModal');
                renderGroupVoting();
                showToast('Stimme für dein Lieblingsrestaurant ab! 🗳️');
            }, 500);
        } else {
            // Neue Gruppen-Session erstellen für Teilnehmer
            currentGroupData = {
                id: groupId,
                name: 'Gemeinsam Essen',
                size: 4,
                votes: {},
                myVotes: []
            };
            localStorage.setItem('kmi_groups', JSON.stringify({...savedGroups, [groupId]: currentGroupData}));
            setTimeout(() => {
                openModal('groupVotingModal');
                renderGroupVoting();
                showToast('Willkommen! Stimme ab wo ihr essen wollt! 🍽️');
            }, 500);
        }
        
        // URL Parameter entfernen (cleaner)
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}

function loginWithEmail(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    
    // Email speichern für Code-Eingabe
    localStorage.setItem('kmi_pending_email', email);
    document.getElementById('sentEmailDisplay').textContent = email;
    
    closeModal('loginModal');
    openModal('emailCodeModal');
    
    showToast('Code wurde gesendet!');
}

function verifyEmailCode(e) {
    e.preventDefault();
    const code = document.getElementById('emailCode').value;
    const email = localStorage.getItem('kmi_pending_email');
    
    // Simuliert Code-Verifizierung (in Produktion: Backend-Call)
    if (code.length === 6) {
        const name = email.split('@')[0];
        simulateLogin(name.charAt(0).toUpperCase() + name.slice(1), email, 'email');
        closeModal('emailCodeModal');
        localStorage.removeItem('kmi_pending_email');
    } else {
        showToast('Bitte 6-stelligen Code eingeben', 'error');
    }
}

function resendCode() {
    showToast('Neuer Code wurde gesendet!');
}

function simulateLogin(name, email, avatar) {
    currentUser = {
        id: Date.now(),
        name: name,
        email: email,
        avatar: avatar,
        reservations: Math.floor(Math.random() * 5),
        createdAt: new Date().toISOString()
    };
    
    localStorage.setItem('kmi_user', JSON.stringify(currentUser));
    updateProfileUI();
    renderProfileContent();
    openModal('profileModal');
    
    showToast('Willkommen, ' + name + '! ', 'success');
    
    addNotification('login', '', 'green', 'Anmeldung erfolgreich', 'Willkommen bei Kiek mol in!');
}

function logout() {
    currentUser = null;
    localStorage.removeItem('kmi_user');
    
    const profileBtn = document.getElementById('profileBtn');
    if (profileBtn) {
        profileBtn.style.background = 'var(--bg-card)';
        profileBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
        `;
    }
    
    renderProfileContent();
    closeModal('profileModal');
    showToast('Du wurdest abgemeldet');
}

function showMyReservations() {
    closeModal('profileModal');
    showToast('Reservierungen werden geladen...');
    // Hier könnte man eine Reservierungsübersicht anzeigen
}

// ==================== THEME ====================
function initTheme() {
    const savedTheme = localStorage.getItem('kmi_theme') || 'auto';
    const savedAccent = localStorage.getItem('kmi_accent') || '#1a5f4a';
    const savedAccentName = localStorage.getItem('kmi_accent_name') || 'Ostfriesland Grün';
    const savedGlass = localStorage.getItem('kmi_glass') || 'none';
    const savedCorners = localStorage.getItem('kmi_corners') || 'pill';
    
    applyTheme(savedTheme);
    applyAccentColor(savedAccent, savedAccentName);
    applyGlassEffect(savedGlass);
    applyCornerRadius(savedCorners);
    
    updateThemeButtons(savedTheme);
    updateGlassButtons(savedGlass);
    updateCornerButtons(savedCorners);
    
    // System Theme Change Listener
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        const currentTheme = localStorage.getItem('kmi_theme');
        if (currentTheme === 'auto') {
            applyTheme('auto');
        }
    });
}

function setTheme(theme) {
    localStorage.setItem('kmi_theme', theme);
    applyTheme(theme);
    updateThemeButtons(theme);
    
    const themeNames = { light: 'Hell', dark: 'Dunkel', auto: 'Automatisch' };
    showToast('' + themeNames[theme] + ' aktiviert');
}

// Einfache Theme-Funktion für Gäste
function setThemeSimple(theme) {
    localStorage.setItem('kmi_theme', theme);
    applyTheme(theme);
    
    // Simple Buttons aktualisieren
    ['Light', 'Dark', 'Auto'].forEach(btn => {
        const el = document.getElementById('themeBtn' + btn + 'Simple');
        if (el) {
            if (btn.toLowerCase() === theme) {
                el.style.borderColor = 'var(--primary)';
                el.style.background = 'var(--cream)';
            } else {
                el.style.borderColor = 'var(--border-color)';
                el.style.background = 'var(--bg-card)';
            }
        }
    });
    
    closeModal('themeModalSimple');
    const themeNames = { light: 'Hell', dark: 'Dunkel', auto: 'Automatisch' };
    showToast('' + themeNames[theme] + ' aktiviert');
}

function setAccentColor(color, name) {
    localStorage.setItem('kmi_accent', color);
    localStorage.setItem('kmi_accent_name', name);
    applyAccentColor(color, name);
    
    // Update active button
    document.querySelectorAll('.accent-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.style.getPropertyValue('--accent') === color) {
            btn.classList.add('active');
        }
    });
    
    showToast('' + name + ' aktiviert');
}

function applyAccentColor(color, name) {
    document.documentElement.style.setProperty('--primary', color);
    document.documentElement.style.setProperty('--primary-light', color + '33');
    
    // RGB Version für rgba()
    const r = parseInt(color.slice(1,3), 16);
    const g = parseInt(color.slice(3,5), 16);
    const b = parseInt(color.slice(5,7), 16);
    document.documentElement.style.setProperty('--primary-rgb', `${r}, ${g}, ${b}`);
    
    const nameEl = document.getElementById('currentAccentName');
    if (nameEl) nameEl.textContent = 'Aktuell: ' + name;
}

function setGlassEffect(effect) {
    localStorage.setItem('kmi_glass', effect);
    applyGlassEffect(effect);
    updateGlassButtons(effect);
    
    const names = { none: 'Aus', subtle: 'Dezent', strong: 'Stark' };
    showToast('Glaseffekt: ' + names[effect]);
}

function applyGlassEffect(effect) {
    document.body.classList.remove('glass-effect-none', 'glass-effect-subtle', 'glass-effect-strong');
    if (effect !== 'none') {
        document.body.classList.add('glass-effect-' + effect);
    }
}

function updateGlassButtons(active) {
    ['None', 'Subtle', 'Strong'].forEach(btn => {
        const el = document.getElementById('glass' + btn);
        if (el) {
            el.classList.toggle('active', btn.toLowerCase() === active);
        }
    });
}

function setCornerRadius(corners) {
    localStorage.setItem('kmi_corners', corners);
    applyCornerRadius(corners);
    updateCornerButtons(corners);
    
    const names = { sharp: 'Eckig', rounded: 'Rund', pill: 'Pill' };
    showToast('Ecken: ' + names[corners]);
}

function applyCornerRadius(corners) {
    document.body.classList.remove('corners-sharp', 'corners-rounded', 'corners-pill');
    document.body.classList.add('corners-' + corners);
}

function updateCornerButtons(active) {
    ['Sharp', 'Rounded', 'Pill'].forEach(btn => {
        const el = document.getElementById('corner' + btn);
        if (el) {
            el.classList.toggle('active', btn.toLowerCase() === active);
        }
    });
}

function resetDesign() {
    localStorage.removeItem('kmi_theme');
    localStorage.removeItem('kmi_accent');
    localStorage.removeItem('kmi_accent_name');
    localStorage.removeItem('kmi_glass');
    localStorage.removeItem('kmi_corners');
    
    applyTheme('auto');
    applyAccentColor('#1a5f4a', 'Ostfriesland Grün');
    applyGlassEffect('none');
    applyCornerRadius('pill');
    
    updateThemeButtons('auto');
    updateGlassButtons('none');
    updateCornerButtons('pill');
    
    showToast('Design zurückgesetzt');
    closeModal('themeModal');
}

function applyTheme(theme) {
    let actualTheme = theme;
    
    if (theme === 'auto') {
        // Safari-kompatible Erkennung
        try {
            const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            actualTheme = darkModeMediaQuery.matches ? 'dark' : 'light';
            console.log('Auto-Theme erkannt:', actualTheme);
        } catch(e) {
            // Fallback für ältere Browser
            actualTheme = 'light';
            console.log('Auto-Theme Fallback: light');
        }
    }
    
    // Theme anwenden - mehrere Methoden für beste Kompatibilität
    if (actualTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.documentElement.classList.add('dark-mode');
        if (document.body) document.body.classList.add('dark-mode');
    } else {
        document.documentElement.removeAttribute('data-theme');
        document.documentElement.classList.remove('dark-mode');
        if (document.body) document.body.classList.remove('dark-mode');
    }
    
    // Theme color für Statusleiste aktualisieren
    const themeColorMeta = document.getElementById('themeColorMeta');
    if (themeColorMeta) {
        themeColorMeta.content = actualTheme === 'dark' ? '#1a1a1a' : '#6B46C1';
    }
    
    console.log('[OK] Theme angewendet:', actualTheme);
}

function updateThemeButtons(activeTheme) {
    const buttons = ['Light', 'Dark', 'Auto'];
    buttons.forEach(btn => {
        const el = document.getElementById('themeBtn' + btn);
        if (el) {
            el.classList.toggle('active', btn.toLowerCase() === activeTheme);
        }
    });
}

// ==================== WEATHER ====================
let currentWeatherCode = 0; // Speichert aktuellen Wetter-Code

async function loadWeather() {
    // Hole Location aus aktueller Auswahl
    const loc = LOCATIONS[APP_DATA.currentLocation] || LOCATIONS['Greetsiel'];
    const lat = loc.lat;
    const lon = loc.lng;
    
    try {
        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m,weather_code,is_day&timezone=Europe/Berlin`);
        const data = await response.json();
        
        const temp = Math.round(data.current.temperature_2m);
        const windSpeed = Math.round(data.current.wind_speed_10m);
        const weatherCode = data.current.weather_code;
        const isDay = data.current.is_day; // 1 = Tag, 0 = Nacht
        
        currentWeatherCode = weatherCode;
        
        // Wetter-Beschreibung und Icon
        let desc = 'Unbekannt';
        let icon = '⛅';
        
        if (weatherCode === 0) { desc = 'Sonnig'; icon = isDay ? '☀️' : '🌙'; }
        else if (weatherCode <= 3) { desc = 'Teilweise bewölkt'; icon = isDay ? '⛅' : '☁️'; }
        else if (weatherCode <= 48) { desc = 'Nebelig'; icon = '🌫️'; }
        else if (weatherCode <= 67) { desc = 'Regen'; icon = '🌧️'; }
        else if (weatherCode <= 77) { desc = 'Schnee'; icon = '❄️'; }
        else if (weatherCode <= 86) { desc = 'Schauer'; icon = '🌦️'; }
        else if (weatherCode >= 95) { desc = 'Gewitter'; icon = '⛈️'; }
        
        const tempEl = document.getElementById('weatherTemp');
        const descEl = document.getElementById('weatherDesc');
        const iconEl = document.getElementById('weatherIcon');
        const windEl = document.getElementById('weatherWind');
        
        if (tempEl) tempEl.textContent = temp + '°C';
        if (descEl) descEl.textContent = desc;
        if (iconEl) iconEl.textContent = icon;
        if (windEl) windEl.textContent = 'Wind: ' + windSpeed + ' km/h';
        
        // Dynamisches Theme basierend auf echtem Wetter + Tageszeit
        updateWeatherTheme(weatherCode, isDay);
        
        // Wetter-Vorhersage für Eilmeldung laden
        checkWeatherForecast(lat, lon);
        
        console.log('[OK] Wetter aktualisiert:', temp + '°C', desc, isDay ? '(Tag)' : '(Nacht)');
        
    } catch (e) {
        console.log('Wetter-API Fehler:', e);
    }
}

// Wetter-Vorhersage prüfen und ggf. Eilmeldung zeigen
async function checkWeatherForecast(lat, lon) {
    try {
        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=weather_code,precipitation_probability&forecast_hours=12&timezone=Europe/Berlin`);
        const data = await response.json();
        
        const hourlyWeather = data.hourly.weather_code;
        const hourlyPrecip = data.hourly.precipitation_probability;
        const times = data.hourly.time;
        
        // Prüfe die nächsten 6 Stunden auf schlechtes Wetter
        let alertInfo = null;
        
        for (let i = 0; i < Math.min(6, hourlyWeather.length); i++) {
            const code = hourlyWeather[i];
            const precip = hourlyPrecip[i];
            const time = new Date(times[i]);
            const hours = time.getHours();
            const timeStr = hours + ':00 Uhr';
            
            // Gewitter (95+)
            if (code >= 95) {
                alertInfo = {
                    icon: '⛈️',
                    title: 'Gewitter erwartet!',
                    message: `Ab ca. ${timeStr} sind Gewitter möglich. Sucht Schutz in Gebäuden!`,
                    gradient: 'linear-gradient(135deg, #1F1C2C 0%, #928DAB 100%)',
                    suggestions: ['Teemuseum Norden', 'Seehundstation', 'Cafés', 'Shopping']
                };
                break;
            }
            // Starker Regen (61-67) oder Schauer (80-86)
            else if ((code >= 61 && code <= 67) || (code >= 80 && code <= 86)) {
                alertInfo = {
                    icon: '🌧️',
                    title: 'Regen angekündigt',
                    message: `Ab ca. ${timeStr} wird Regen erwartet. Perfekt für Indoor-Aktivitäten!`,
                    gradient: 'linear-gradient(135deg, #373B44 0%, #4286f4 100%)',
                    suggestions: ['Museen', 'Cafés', 'Wellness', 'Kino']
                };
                break;
            }
            // Schnee (71-77)
            else if (code >= 71 && code <= 77) {
                alertInfo = {
                    icon: '❄️',
                    title: 'Schneefall erwartet',
                    message: `Ab ca. ${timeStr} kann es schneien. Warme Kleidung empfohlen!`,
                    gradient: 'linear-gradient(135deg, #E6DADA 0%, #274046 100%)',
                    suggestions: ['Tee trinken', 'Museen', 'Sauna', 'Restaurants']
                };
                break;
            }
            // Dichter Nebel (45-48)
            else if (code >= 45 && code <= 48) {
                alertInfo = {
                    icon: '🌫️',
                    title: 'Dichter Nebel',
                    message: `Nebel erwartet - Fährverbindungen könnten verzögert sein.`,
                    gradient: 'linear-gradient(135deg, #8E9EAB 0%, #B8C6DB 100%)',
                    suggestions: ['Fähre prüfen', 'Indoor-Tipps', 'Restaurants']
                };
                break;
            }
            // Hohe Regenwahrscheinlichkeit (>70%)
            else if (precip > 70 && !alertInfo) {
                alertInfo = {
                    icon: '🌦️',
                    title: 'Regen möglich',
                    message: `${precip}% Regenwahrscheinlichkeit ab ${timeStr}. Regenjacke einpacken!`,
                    gradient: 'linear-gradient(135deg, #536976 0%, #4B79A1 100%)',
                    suggestions: ['Cafés', 'Museen', 'Shopping']
                };
            }
        }
        
        // Alert anzeigen oder verstecken
        showWeatherAlert(alertInfo);
        
    } catch (e) {
        console.log('Wetter-Vorhersage Fehler:', e);
    }
}

// Wetter-Eilmeldung anzeigen
function showWeatherAlert(alertInfo) {
    const banner = document.getElementById('weatherAlertBanner');
    if (!banner) return;
    
    // Prüfen ob User die Meldung schon weggeklickt hat (für diese Stunde)
    const dismissedUntil = localStorage.getItem('kmi_weather_alert_dismissed');
    if (dismissedUntil && new Date().getTime() < parseInt(dismissedUntil)) {
        banner.style.display = 'none';
        return;
    }
    
    if (alertInfo) {
        document.getElementById('alertIcon').textContent = alertInfo.icon;
        document.getElementById('alertTitle').textContent = alertInfo.title;
        document.getElementById('alertMessage').textContent = alertInfo.message;
        
        // Icon-Container Farbe setzen
        const iconContainer = document.getElementById('alertIconContainer');
        if (iconContainer) {
            iconContainer.style.background = alertInfo.gradient;
        }
        
        // Vorschläge anzeigen im Apple-Style
        const suggestionsEl = document.getElementById('alertSuggestions');
        if (suggestionsEl && alertInfo.suggestions) {
            suggestionsEl.innerHTML = alertInfo.suggestions.map(s => 
                `<span style="background: var(--bg-secondary); color: var(--dark); padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; border: 1px solid var(--border-color);">${s}</span>`
            ).join('');
        }
        
        banner.style.display = 'block';
    } else {
        banner.style.display = 'none';
    }
}

// Wetter-Eilmeldung schließen (für 1 Stunde)
function dismissWeatherAlert() {
    const banner = document.getElementById('weatherAlertBanner');
    if (banner) banner.style.display = 'none';
    
    // Für 1 Stunde nicht mehr anzeigen
    const dismissUntil = new Date().getTime() + (60 * 60 * 1000);
    localStorage.setItem('kmi_weather_alert_dismissed', dismissUntil.toString());
}

// Dynamisches Theme basierend auf ECHTEM Wetter + Tageszeit
function updateWeatherTheme(weatherCode = currentWeatherCode, isDay = 1) {
    const hour = new Date().getHours();
    const weatherBg = document.getElementById('weatherBg');
    const weatherModalBg = document.getElementById('weatherModalBg');
    const mapContainer = document.getElementById('guestMap');
    
    let gradient, mapFilter;
    
    // Nacht (egal welches Wetter)
    if (!isDay || hour < 6 || hour >= 21) {
        gradient = 'linear-gradient(180deg, #0f172a 0%, #1e293b 30%, #334155 100%)';
        mapFilter = 'brightness(0.7) saturate(0.8)';
    }
    // Sonnig / Klar (weatherCode 0)
    else if (weatherCode === 0) {
        if (hour >= 6 && hour < 9) {
            // Morgen - Sonnenaufgang
            gradient = 'linear-gradient(180deg, #FF9A8B 0%, #FECFEF 40%, #87CEEB 100%)';
            mapFilter = 'brightness(1.05) saturate(1.1) sepia(0.05)';
        } else if (hour >= 17 && hour < 21) {
            // Abend - Sonnenuntergang
            gradient = 'linear-gradient(180deg, #ff7e5f 0%, #feb47b 30%, #ffcf91 100%)';
            mapFilter = 'brightness(0.95) saturate(1.2) sepia(0.1)';
        } else {
            // Klarer Tag
            gradient = 'linear-gradient(180deg, #4A90D9 0%, #56CCF2 50%, #87CEEB 100%)';
            mapFilter = 'brightness(1.05) saturate(1.1)';
        }
    }
    // Teilweise bewölkt (weatherCode 1-3)
    else if (weatherCode <= 3) {
        gradient = 'linear-gradient(180deg, #4A90D9 0%, #67B8DE 50%, #8BC4E8 100%)';
        mapFilter = 'brightness(1) saturate(1)';
    }
    // Nebel (weatherCode 45-48)
    else if (weatherCode <= 48) {
        gradient = 'linear-gradient(180deg, #8E9EAB 0%, #B8C6DB 50%, #D7DDE8 100%)';
        mapFilter = 'brightness(0.9) saturate(0.7) contrast(0.95)';
    }
    // Regen (weatherCode 51-67)
    else if (weatherCode <= 67) {
        gradient = 'linear-gradient(180deg, #373B44 0%, #4286f4 50%, #667eea 100%)';
        mapFilter = 'brightness(0.85) saturate(0.9)';
    }
    // Schnee (weatherCode 71-77)
    else if (weatherCode <= 77) {
        gradient = 'linear-gradient(180deg, #e0e5ec 0%, #f5f7fa 50%, #c3cfe2 100%)';
        mapFilter = 'brightness(1.1) saturate(0.8) contrast(1.05)';
    }
    // Schauer (weatherCode 80-86)
    else if (weatherCode <= 86) {
        gradient = 'linear-gradient(180deg, #536976 0%, #292E49 50%, #4B79A1 100%)';
        mapFilter = 'brightness(0.9) saturate(0.85)';
    }
    // Gewitter (weatherCode 95+)
    else if (weatherCode >= 95) {
        gradient = 'linear-gradient(180deg, #1F1C2C 0%, #3E3B4F 50%, #928DAB 100%)';
        mapFilter = 'brightness(0.75) saturate(0.7) contrast(1.1)';
    }
    // Fallback
    else {
        gradient = 'linear-gradient(180deg, #4A90D9 0%, #67B8DE 50%, #8BC4E8 100%)';
        mapFilter = 'brightness(1) saturate(1)';
    }
    
    if (weatherBg) {
        weatherBg.style.background = gradient;
        weatherBg.style.transition = 'background 1s ease';
    }
    
    if (weatherModalBg) {
        weatherModalBg.style.background = gradient;
    }
    
    if (mapContainer) {
        mapContainer.style.filter = mapFilter;
        mapContainer.style.transition = 'filter 1s ease';
    }
}

// Wetter alle 10 Minuten aktualisieren
setInterval(loadWeather, 600000);

// ==================== MAP FUNCTIONS ====================
let guestMap = null;
let mapMarkers = [];

const LOCATIONS = {
    'Greetsiel': { lat: 53.5021, lng: 7.0965, zoom: 16 },
    'Norddeich': { lat: 53.6108, lng: 7.1542, zoom: 15 },
    'Norden': { lat: 53.5967, lng: 7.2058, zoom: 14 },
    'Aurich': { lat: 53.4714, lng: 7.4808, zoom: 14 },
    'Emden': { lat: 53.3594, lng: 7.2060, zoom: 14 },
    'Norderney': { lat: 53.7066, lng: 7.1509, zoom: 14 },
    'Juist': { lat: 53.6772, lng: 6.9936, zoom: 14 },
    'Alle': { lat: 53.55, lng: 7.20, zoom: 10 }
};

function initMap() {
    const mapContainer = document.getElementById('guestMap');
    if (!mapContainer) {
        console.log('Karte Container nicht gefunden');
        return;
    }
    
    if (guestMap) {
        console.log('Karte bereits initialisiert');
        return;
    }
    
    // Warte bis Container sichtbar ist
    if (mapContainer.offsetWidth === 0) {
        setTimeout(initMap, 100);
        return;
    }
    
    try {
        const loc = LOCATIONS[APP_DATA.currentLocation] || LOCATIONS['Greetsiel'];
        
        guestMap = L.map('guestMap', {
            zoomControl: false,
            attributionControl: false
        }).setView([loc.lat, loc.lng], loc.zoom);
        
        // OpenStreetMap Tiles (zuverlässiger)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(guestMap);
        
        // User Location anzeigen
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    
                    const userIcon = L.divIcon({
                        className: 'user-location-marker',
                        html: '<div style="background:#007AFF;width:14px;height:14px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
                        iconSize: [14, 14],
                        iconAnchor: [7, 7]
                    });
                    
                    L.marker([userLat, userLng], { icon: userIcon })
                        .addTo(guestMap)
                        .bindPopup('Dein Standort');
                },
                (error) => console.log('Geolocation nicht verfügbar'),
                { enableHighAccuracy: true, timeout: 5000 }
            );
        }
        
        updateMapMarkers();
        console.log('Karte erfolgreich initialisiert');
        
    } catch (e) {
        console.error('Karten-Fehler:', e);
    }
}

function updateMapMarkers() {
    console.log('updateMapMarkers aufgerufen');
    
    if (!guestMap) {
        console.log('Keine Map vorhanden - versuche zu initialisieren');
        initMap();
        return;
    }
    
    // Alte Marker entfernen
    mapMarkers.forEach(m => guestMap.removeLayer(m));
    mapMarkers = [];
    
    // Keine Restaurants? Nichts anzeigen
    if (!APP_DATA.restaurants || APP_DATA.restaurants.length === 0) {
        console.log('Keine Restaurants zum Anzeigen');
        return;
    }
    
    // Review Cards für Map Preview
    let reviewCardsHtml = '';
    
    // Neue Marker hinzufügen
    APP_DATA.restaurants.forEach((r, index) => {
        if (!r.lat || !r.lng) {
            return;
        }
        
        // Marker-Farbe und SVG Icon basierend auf Küche/Typ
        let bgColor = '#4A90D9'; // default blau
        
        // SVG Icons für Küchen (clean, keine Emojis)
        const cuisineData = {
            'Italienisch': { bg: '#e74c3c', svg: '<svg viewBox="0 0 24 24" fill="white" width="20" height="20"><circle cx="12" cy="12" r="10"/><circle cx="8" cy="10" r="2" fill="#e74c3c"/><circle cx="14" cy="8" r="1.5" fill="#e74c3c"/><circle cx="16" cy="13" r="2" fill="#e74c3c"/><circle cx="10" cy="14" r="1.5" fill="#e74c3c"/></svg>' },
            'Deutsch': { bg: '#f39c12', svg: '<svg viewBox="0 0 24 24" fill="white" width="20" height="20"><rect x="7" y="4" width="10" height="16" rx="2"/><rect x="5" y="8" width="2" height="6" rx="1"/><line x1="7" y1="12" x2="17" y2="12" stroke="#f39c12" stroke-width="2"/></svg>' },
            'Fisch': { bg: '#3498db', svg: '<svg viewBox="0 0 24 24" fill="white" width="20" height="20"><path d="M12 6c-4 0-7 3-9 6 2 3 5 6 9 6s7-3 9-6c-2-3-5-6-9-6z"/><circle cx="8" cy="12" r="1" fill="#3498db"/></svg>' },
            'Café': { bg: '#9b59b6', svg: '<svg viewBox="0 0 24 24" fill="white" width="20" height="20"><path d="M18 8h1a3 3 0 0 1 0 6h-1M4 8h14v9a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8z"/><path d="M6 1v3M10 1v3M14 1v3" stroke="white" stroke-width="2"/></svg>' },
            'Asiatisch': { bg: '#2ecc71', svg: '<svg viewBox="0 0 24 24" fill="white" width="20" height="20"><path d="M12 3C7 3 3 7 3 12h18c0-5-4-9-9-9z"/><rect x="11" y="12" width="2" height="8"/></svg>' },
            'Griechisch': { bg: '#1abc9c', svg: '<svg viewBox="0 0 24 24" fill="white" width="20" height="20"><circle cx="12" cy="12" r="8"/><path d="M8 10c0-2 1-3 4-3s4 1 4 3" stroke="#1abc9c" stroke-width="2" fill="none"/></svg>' },
            'Türkisch': { bg: '#e67e22', svg: '<svg viewBox="0 0 24 24" fill="white" width="20" height="20"><ellipse cx="12" cy="14" rx="8" ry="5"/><path d="M8 9c0-3 2-5 4-5s4 2 4 5"/></svg>' }
        };
        
        // Default SVG
        let iconSvg = '<svg viewBox="0 0 24 24" fill="white" width="20" height="20"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"/></svg>';
        
        if (r.cuisine && cuisineData[r.cuisine]) {
            bgColor = cuisineData[r.cuisine].bg;
            iconSvg = cuisineData[r.cuisine].svg;
        }
        
        // Verfügbarkeits-Ring
        let ringColor = '#34c759'; // grün
        if (r.freeTables === 0) ringColor = '#ff3b30';
        else if (r.freeTables <= 2) ringColor = '#ff9500';
        
        // Moderner runder Marker mit SVG
        const icon = L.divIcon({
            className: 'custom-map-marker',
            html: `
                <div class="map-marker-pin" data-id="${r.id}" style="
                    width: 40px;
                    height: 40px;
                    background: ${bgColor};
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    position: relative;
                ">
                    ${iconSvg}
                    <div style="
                        position: absolute;
                        bottom: -2px;
                        right: -2px;
                        width: 12px;
                        height: 12px;
                        background: ${ringColor};
                        border-radius: 50%;
                        border: 2px solid white;
                    "></div>
                </div>
            `,
            iconSize: [44, 44],
            iconAnchor: [22, 44]
        });
        
        const marker = L.marker([r.lat, r.lng], { icon }).addTo(guestMap);
        
        // Bei Klick: Bottom Sheet öffnen
        marker.on('click', () => {
            openMapBottomSheet(r);
        });
        
        mapMarkers.push(marker);
        
        // Review Card für Preview (nur erste 5)
        if (index < 5 && r.freeTables > 0) {
            reviewCardsHtml += `
                <div onclick="openMapBottomSheet(APP_DATA.restaurants.find(x => x.id === '${r.id}'))" style="
                    flex: 0 0 auto;
                    width: 200px;
                    background: white;
                    border-radius: 16px;
                    padding: 12px;
                    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
                    cursor: pointer;
                ">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="${r.image}" style="width: 40px; height: 40px; border-radius: 10px; object-fit: cover;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 13px; font-weight: 700; color: var(--primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${r.name}</div>
                            <div style="font-size: 11px; color: #64748b;">${r.freeTables} Tische frei</div>
                        </div>
                        <svg viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" width="16" height="16">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </div>
                </div>
            `;
        }
    });
    
    // Review Cards einfügen
    const reviewContainer = document.getElementById('mapReviewCards');
    if (reviewContainer) {
        reviewContainer.innerHTML = reviewCardsHtml;
    }
}

// Bottom Sheet für Restaurant öffnen
function openMapBottomSheet(restaurant) {
    if (!restaurant) return;
    
    // Bestehendes Sheet entfernen
    const existing = document.getElementById('mapBottomSheet');
    if (existing) existing.remove();
    
    const isOpen = checkIfOpen(restaurant);
    const routeUrl = restaurant.googleMapsUrl || `https://www.google.com/maps/dir/?api=1&destination=${restaurant.lat},${restaurant.lng}`;
    
    const sheet = document.createElement('div');
    sheet.id = 'mapBottomSheet';
    sheet.innerHTML = `
        <div style="
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -4px 32px rgba(0,0,0,0.15);
            z-index: 10000;
            max-height: 70vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        ">
            <style>
                @keyframes slideUp {
                    from { transform: translateY(100%); }
                    to { transform: translateY(0); }
                }
            </style>
            
            <!-- Handle -->
            <div style="display: flex; justify-content: center; padding: 12px;">
                <div style="width: 40px; height: 4px; background: #e2e8f0; border-radius: 2px;"></div>
            </div>
            
            <!-- Restaurant Header -->
            <div style="position: relative;">
                <img src="${restaurant.image}" style="width: 100%; height: 180px; object-fit: cover;">
                <button onclick="document.getElementById('mapBottomSheet').remove()" style="
                    position: absolute;
                    top: 12px;
                    right: 12px;
                    width: 32px;
                    height: 32px;
                    background: rgba(0,0,0,0.5);
                    border: none;
                    border-radius: 50%;
                    color: white;
                    font-size: 18px;
                    cursor: pointer;
                ">×</button>
                <div style="
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    padding: 16px;
                    background: linear-gradient(transparent, rgba(0,0,0,0.7));
                    color: white;
                ">
                    <h3 style="margin: 0; font-size: 20px; font-weight: 700;">${restaurant.name}</h3>
                    <div style="font-size: 13px; opacity: 0.9;">${restaurant.street || restaurant.city || 'Ostfriesland'}</div>
                </div>
            </div>
            
            <!-- Info -->
            <div style="padding: 16px;">
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div style="flex: 1; text-align: center; padding: 12px; background: #f8fafc; border-radius: 12px;">
                        <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">Status</div>
                        <div style="font-size: 13px; font-weight: 600; color: ${isOpen ? '#34c759' : '#ff3b30'};">${isOpen ? 'Geöffnet' : 'Geschlossen'}</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 12px; background: #f8fafc; border-radius: 12px;">
                        <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">Tische</div>
                        <div style="font-size: 13px; font-weight: 600; color: ${restaurant.freeTables > 0 ? '#34c759' : '#ff3b30'};">${restaurant.freeTables} frei</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 12px; background: #f8fafc; border-radius: 12px;">
                        <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">Bewertung</div>
                        <div style="font-size: 13px; font-weight: 600;">⭐ ${restaurant.rating || '4.5'}</div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button onclick="document.getElementById('mapBottomSheet').remove(); openReservation('${restaurant.id}')" style="
                        background: var(--primary);
                        color: white;
                        border: none;
                        padding: 14px;
                        border-radius: 12px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                    ">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <rect x="3" y="4" width="18" height="18" rx="2"/>
                            <path d="M16 2v4M8 2v4M3 10h18"/>
                        </svg>
                        Reservieren
                    </button>
                    <a href="${routeUrl}" target="_blank" style="
                        background: #f1f5f9;
                        color: var(--text-primary);
                        border: none;
                        padding: 14px;
                        border-radius: 12px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        text-decoration: none;
                    ">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <polygon points="3 11 22 2 13 21 11 13 3 11"/>
                        </svg>
                        Route
                    </a>
                </div>
                
                ${restaurant.whatsapp ? `
                    <a href="https://wa.me/${restaurant.whatsapp.replace(/[^0-9]/g, '')}" target="_blank" style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        background: #25D366;
                        color: white;
                        padding: 14px;
                        border-radius: 12px;
                        margin-top: 10px;
                        text-decoration: none;
                        font-weight: 600;
                    ">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/></svg>
                        WhatsApp
                    </a>
                ` : ''}
            </div>
        </div>
        <div onclick="document.getElementById('mapBottomSheet').remove()" style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 9999;
        "></div>
    `;
    
    document.body.appendChild(sheet);
    
    // Karte auf Restaurant zentrieren
    if (guestMap) {
        guestMap.flyTo([restaurant.lat, restaurant.lng], 16, { duration: 0.5 });
    }
}

// User Location zentrieren
let userLocationMarker = null;

function centerOnUserLocation() {
    if (navigator.geolocation) {
        showToast('Suche Standort...', 'info');
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Auf Fullscreen Map zentrieren
                if (fullscreenMap) {
                    fullscreenMap.flyTo([lat, lng], 15, { duration: 1 });
                    addUserLocationMarker(fullscreenMap, lat, lng);
                }
                
                // Auch auf kleine Karte
                if (guestMap) {
                    guestMap.flyTo([lat, lng], 14, { duration: 1 });
                    addUserLocationMarker(guestMap, lat, lng);
                }
                
                showToast('Standort gefunden!', 'success');
            },
            (error) => {
                showToast('Standort nicht verfügbar', 'error');
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    } else {
        showToast('Standort nicht unterstützt', 'error');
    }
}

function addUserLocationMarker(map, lat, lng) {
    // Bestehenden Marker entfernen
    if (userLocationMarker) {
        try { userLocationMarker.remove(); } catch(e) {}
    }
    
    // Blauer pulsierender Punkt (wie bei Google Maps)
    const userIcon = L.divIcon({
        className: 'user-location-marker',
        html: `
            <div style="position: relative; width: 24px; height: 24px;">
                <div style="
                    position: absolute;
                    width: 24px;
                    height: 24px;
                    background: rgba(66, 133, 244, 0.2);
                    border-radius: 50%;
                    animation: pulse 2s ease-out infinite;
                "></div>
                <div style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 14px;
                    height: 14px;
                    background: #4285F4;
                    border: 3px solid white;
                    border-radius: 50%;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                "></div>
            </div>
        `,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });
    
    userLocationMarker = L.marker([lat, lng], { icon: userIcon, zIndexOffset: 1000 }).addTo(map);
}

// CSS für Pulsing Animation hinzufügen
if (!document.getElementById('userLocationStyles')) {
    const style = document.createElement('style');
    style.id = 'userLocationStyles';
    style.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
}

// Vollbild-Karte öffnen
let fullscreenMap = null;
let fullscreenMarkers = [];

function openFullscreenMap() {
    openModal('fullscreenMapModal');
    
    // Kleine Verzögerung für Modal-Animation
    setTimeout(() => {
        initFullscreenMap();
    }, 100);
}

function initFullscreenMap() {
    const container = document.getElementById('fullscreenMapContainer');
    if (!container) return;
    
    // Bestehende Map zerstören
    if (fullscreenMap) {
        fullscreenMap.remove();
        fullscreenMap = null;
    }
    
    // Neue Map erstellen
    fullscreenMap = L.map('fullscreenMapContainer', {
        zoomControl: false
    }).setView([53.5, 7.1], 11);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '© OpenStreetMap © CartoDB'
    }).addTo(fullscreenMap);
    
    // Zoom Control rechts unten
    L.control.zoom({ position: 'bottomright' }).addTo(fullscreenMap);
    
    // Marker hinzufügen
    updateFullscreenMarkers();
    
    // Map-Größe korrigieren
    setTimeout(() => {
        fullscreenMap.invalidateSize();
    }, 200);
}

function updateFullscreenMarkers(filter = 'all') {
    if (!fullscreenMap) return;
    
    // Alte Marker entfernen
    fullscreenMarkers.forEach(m => fullscreenMap.removeLayer(m));
    fullscreenMarkers = [];
    
    // Cards HTML
    let cardsHtml = '';
    
    APP_DATA.restaurants.forEach((r, index) => {
        if (!r.lat || !r.lng) return;
        
        // Filter anwenden
        if (filter === 'available' && r.freeTables === 0) return;
        if (filter === 'restaurant' && r.cuisine === 'Café') return;
        if (filter === 'cafe' && r.cuisine !== 'Café') return;
        
        // Marker-Farbe und SVG nach Küche
        let bgColor = '#4A90D9';
        
        const cuisineData = {
            'Italienisch': { bg: '#e74c3c', svg: '<svg viewBox="0 0 24 24" fill="white" width="18" height="18"><circle cx="12" cy="12" r="10"/></svg>' },
            'Deutsch': { bg: '#f39c12', svg: '<svg viewBox="0 0 24 24" fill="white" width="18" height="18"><rect x="7" y="4" width="10" height="16" rx="2"/></svg>' },
            'Fisch': { bg: '#3498db', svg: '<svg viewBox="0 0 24 24" fill="white" width="18" height="18"><path d="M12 6c-4 0-7 3-9 6 2 3 5 6 9 6s7-3 9-6c-2-3-5-6-9-6z"/></svg>' },
            'Café': { bg: '#9b59b6', svg: '<svg viewBox="0 0 24 24" fill="white" width="18" height="18"><path d="M18 8h1a3 3 0 0 1 0 6h-1M4 8h14v9a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8z"/></svg>' },
            'Asiatisch': { bg: '#2ecc71', svg: '<svg viewBox="0 0 24 24" fill="white" width="18" height="18"><path d="M12 3C7 3 3 7 3 12h18c0-5-4-9-9-9z"/></svg>' },
            'Griechisch': { bg: '#1abc9c', svg: '<svg viewBox="0 0 24 24" fill="white" width="18" height="18"><circle cx="12" cy="12" r="8"/></svg>' },
            'Türkisch': { bg: '#e67e22', svg: '<svg viewBox="0 0 24 24" fill="white" width="18" height="18"><ellipse cx="12" cy="14" rx="8" ry="5"/></svg>' }
        };
        
        let iconSvg = '<svg viewBox="0 0 24 24" fill="white" width="18" height="18"><circle cx="12" cy="12" r="8"/></svg>';
        
        if (r.cuisine && cuisineData[r.cuisine]) {
            bgColor = cuisineData[r.cuisine].bg;
            iconSvg = cuisineData[r.cuisine].svg;
        }
        
        // Verfügbarkeits-Farbe
        let statusColor = '#34c759';
        if (r.freeTables === 0) statusColor = '#ff3b30';
        else if (r.freeTables <= 2) statusColor = '#ff9500';
        
        // Marker erstellen
        const icon = L.divIcon({
            className: 'fullscreen-marker',
            html: `
                <div style="
                    width: 40px;
                    height: 40px;
                    background: ${bgColor};
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    position: relative;
                ">
                    ${iconSvg}
                    <div style="
                        position: absolute;
                        bottom: -2px;
                        right: -2px;
                        width: 12px;
                        height: 12px;
                        background: ${statusColor};
                        border-radius: 50%;
                        border: 2px solid white;
                    "></div>
                </div>
            `,
            iconSize: [40, 40],
            iconAnchor: [20, 40]
        });
        
        const marker = L.marker([r.lat, r.lng], { icon }).addTo(fullscreenMap);
        marker.on('click', () => openMapBottomSheet(r));
        fullscreenMarkers.push(marker);
        
        // Card für Preview (erste 6)
        if (index < 6) {
            cardsHtml += `
                <div onclick="openMapBottomSheet(APP_DATA.restaurants.find(x => x.id === '${r.id}')); fullscreenMap.flyTo([${r.lat}, ${r.lng}], 15);" style="
                    flex: 0 0 auto;
                    width: 180px;
                    background: white;
                    border-radius: 16px;
                    padding: 12px;
                    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
                    cursor: pointer;
                ">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="${r.image}" style="width: 44px; height: 44px; border-radius: 10px; object-fit: cover;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 13px; font-weight: 700; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${r.name}</div>
                            <div style="font-size: 11px; color: ${statusColor}; font-weight: 600;">${r.freeTables > 0 ? r.freeTables + ' Tische frei' : 'Ausgebucht'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
    });
    
    // Cards einfügen
    const cardsContainer = document.getElementById('fullscreenMapCards');
    if (cardsContainer) cardsContainer.innerHTML = cardsHtml;
}

function filterMapFullscreen(filter, btn) {
    // Button-Status
    document.querySelectorAll('#fullscreenMapModal .map-chip').forEach(b => {
        b.style.background = 'var(--bg-secondary)';
        b.style.color = 'var(--text-primary)';
    });
    btn.style.background = 'var(--primary)';
    btn.style.color = 'white';
    
    // Marker aktualisieren
    updateFullscreenMarkers(filter);
}

function filterMap(filter) {
    // Button-Status aktualisieren
    document.querySelectorAll('.map-chip').forEach(btn => {
        btn.style.background = 'white';
        btn.style.color = '#64748b';
        btn.style.fontWeight = '500';
    });
    event.target.style.background = 'white';
    event.target.style.color = 'var(--primary)';
    event.target.style.fontWeight = '600';
    event.target.style.color = 'white';
    
    // Marker filtern
    if (!guestMap) return;
    
    mapMarkers.forEach(m => guestMap.removeLayer(m));
    mapMarkers = [];
    
    APP_DATA.restaurants.forEach(r => {
        if (!r.lat || !r.lng) return;
        
        // Filter anwenden
        if (filter === 'available' && r.freeTables === 0) return;
        if (filter === 'offers' && !r.offer) return;
        
        let color = '#34c759';
        if (r.freeTables === 0) color = '#ff3b30';
        else if (r.freeTables <= 2) color = '#ff9500';
        if (r.offer) color = '#e8a838'; // Gold für Angebote
        
        const icon = L.divIcon({
            className: 'custom-map-marker',
            html: `<div style="
                background: ${color};
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 700;
                font-size: 14px;
            ">${r.offer ? 'H' : r.freeTables}</div>`,
            iconSize: [36, 36],
            iconAnchor: [18, 18]
        });
        
        const marker = L.marker([r.lat, r.lng], { icon }).addTo(guestMap);
        marker.bindPopup(`
            <div style="text-align: center; min-width: 150px;">
                <strong style="font-size: 14px;">${r.name}</strong><br>
                ${r.offer ? `<span style="color: #e8a838; font-weight: 600;">${r.offer.discount} Rabatt!</span><br>` : ''}
                <span style="color: #5a5a5a; font-size: 12px;">${r.freeTables} Tische frei</span><br>
                <button onclick="openReservation('${r.id}')" style="
                    margin-top: 8px;
                    padding: 8px 16px;
                    background: #1a5f4a;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    ">Reservieren</button>
            </div>
        `);
        
        guestMapMarkers.push(marker);
    });
}

// ==================== KI ASSISTENT ====================
function openAssistant() {
    document.getElementById('assistantOverlay').classList.add('active');
    document.getElementById('assistantInput').focus();
}

function closeAssistant() {
    document.getElementById('assistantOverlay').classList.remove('active');
}

function sendAssistantMessage() {
    const input = document.getElementById('assistantInput');
    const message = input.value.trim();
    if (!message) return;
    
    addMessage(message, 'user');
    input.value = '';
    
    // Suggestions ausblenden nach erster Nachricht
    const suggestions = document.getElementById('assistantSuggestions');
    if (suggestions) suggestions.style.display = 'none';
    
    // Typing Indicator
    showTyping();
    
    // Antwort generieren
    setTimeout(() => {
        hideTyping();
        const response = generateResponse(message);
        addMessage(response, 'bot');
    }, 800 + Math.random() * 700);
}

function askAssistant(question) {
    document.getElementById('assistantInput').value = question;
    sendAssistantMessage();
}

function addMessage(text, type) {
    const container = document.getElementById('assistantMessages');
    const div = document.createElement('div');
    div.className = `assistant-message ${type}`;
    div.innerHTML = `<div class="message-content">${text}</div>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function showTyping() {
    const container = document.getElementById('assistantMessages');
    const div = document.createElement('div');
    div.className = 'assistant-message bot';
    div.id = 'typingIndicator';
    div.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function hideTyping() {
    const typing = document.getElementById('typingIndicator');
    if (typing) typing.remove();
}

function generateResponse(message) {
    const msg = message.toLowerCase().trim();
    const hour = new Date().getHours();
    const isEvening = hour >= 17 || hour < 6;
    const isMorning = hour >= 6 && hour < 11;
    const isLunchTime = hour >= 11 && hour < 14;
    
    // Zeitbasierte Begrüßung
    const greeting = isMorning ? 'Guten Morgen' : (isEvening ? 'Guten Abend' : 'Hallo');
    
    // Wetter-Daten holen
    const currentTemp = document.getElementById('weatherTemp')?.textContent || '8°C';
    const currentWeather = document.getElementById('weatherDesc')?.textContent || 'Bewölkt';
    const isRainy = currentWeather.toLowerCase().includes('regen') || currentWeather.toLowerCase().includes('schauer');
    const isSunny = currentWeather.toLowerCase().includes('sonn') || currentWeather.toLowerCase().includes('klar');
    
    // ==================== BEGRÜSSUNGEN ====================
    if (msg.match(/^(hallo|hi|hey|moin|guten|servus|grüß)/)) {
        const greetings = [
            `Moin moin! 👋 Schön dass du da bist! Was suchst du? Ich kann dir bei Restaurants, freien Tischen, Ausflügen oder Unterkünften helfen.`,
            `${greeting}! Willkommen in Ostfriesland! 🌊 Wie kann ich dir helfen? Restaurant gesucht? Oder Tipps für heute?`,
            `Moin! Bei uns in Ostfriesland ist es gerade ${currentTemp} und ${currentWeather}. Was möchtest du unternehmen?`
        ];
        return greetings[Math.floor(Math.random() * greetings.length)];
    }
    
    // ==================== PERSONALISIERTE EMPFEHLUNGEN ====================
    // "Was soll ich essen" / "Was empfiehlst du" / "Hunger"
    if (msg.match(/(was.*(essen|empf)|hunger|hungrig|appetit|lust auf|worauf)/)) {
        const available = APP_DATA.restaurants.filter(r => r.freeTables > 0);
        
        if (isLunchTime) {
            const quick = available.filter(r => ['imbiss', 'cafe', 'italienisch'].includes(r.cuisine));
            if (quick.length > 0) {
                const r = quick[Math.floor(Math.random() * quick.length)];
                return `🍽️ Zur Mittagszeit empfehle ich <strong>${r.name}</strong>! Schnell, lecker und ${r.freeTables} Tische sind noch frei. ${r.offer ? `<br><br>🎁 Tipp: ${r.offer.title}!` : ''}`;
            }
        }
        
        if (isEvening) {
            const dinner = available.filter(r => ['fisch', 'deutsch', 'italienisch', 'griechisch'].includes(r.cuisine));
            if (dinner.length > 0) {
                const r = dinner[Math.floor(Math.random() * dinner.length)];
                return `🌙 Für ein schönes Abendessen empfehle ich <strong>${r.name}</strong> (${r.cuisine})! Noch ${r.freeTables} Tische frei. Bewertung: ⭐ ${r.rating}`;
            }
        }
        
        if (available.length > 0) {
            const r = available[Math.floor(Math.random() * available.length)];
            return `Ich empfehle dir <strong>${r.name}</strong>! ${r.freeTables > 0 ? `Noch ${r.freeTables} Plätze frei.` : ''} ${r.offer ? `Aktuelles Angebot: ${r.offer.title}` : ''}`;
        }
        
        return 'Alle Restaurants sind gut besucht! Schau unter "Essen" - dort siehst du wer gerade Platz hat.';
    }
    
    // ==================== WETTER-BASIERTE EMPFEHLUNGEN ====================
    if (msg.match(/(wetter|regen|sonn|kalt|warm|draußen|drinnen)/)) {
        if (isRainy) {
            return `🌧️ Aktuell: ${currentTemp}, ${currentWeather}. <br><br>Bei Regen empfehle ich:<br>• Gemütliches Café mit Tee<br>• Fischrestaurant am Hafen (mit Blick aufs Wasser!)<br>• Museum oder Seehundstation<br><br>Soll ich ein Restaurant mit überdachter Terrasse suchen?`;
        }
        if (isSunny) {
            return `☀️ Super Wetter! ${currentTemp}, ${currentWeather}.<br><br>Perfekt für:<br>• Terrasse am Hafen<br>• Eis essen am Strand<br>• Wattwanderung & danach Fischbrötchen<br><br>Unter "Entdecken" findest du Outdoor-Aktivitäten!`;
        }
        return `🌤️ Aktuell: ${currentTemp}, ${currentWeather}. Gutes Wetter für einen Spaziergang am Hafen! Danach lecker Einkehren?`;
    }
    
    // ==================== KÜCHEN-SPEZIFISCH ====================
    // Fisch
    if (msg.match(/(fisch|krabben|meer|garnelen|lachs|matjes|hering|nordsee)/)) {
        const fish = APP_DATA.restaurants.filter(r => r.cuisine === 'fisch');
        if (fish.length > 0) {
            const r = fish[0];
            const r2 = fish[1];
            let response = `🐟 Frischer Fisch? Da bist du in Ostfriesland richtig!<br><br>`;
            response += `<strong>${r.name}</strong> - ${r.freeTables > 0 ? `${r.freeTables} Tische frei` : 'Voll, aber Warteliste möglich'} - ⭐ ${r.rating}`;
            if (r2) response += `<br><strong>${r2.name}</strong> - ${r2.freeTables > 0 ? `${r2.freeTables} Tische frei` : 'Beliebt!'} - ⭐ ${r2.rating}`;
            response += `<br><br>🦐 Tipp: Probier die Krabbensuppe - ostfriesische Spezialität!`;
            return response;
        }
        return 'Leider gerade keine Fisch-Restaurants verfügbar. Schau später nochmal!';
    }
    
    // Pizza/Italienisch
    if (msg.match(/(pizza|pasta|italien|lasagne|spaghetti)/)) {
        const italian = APP_DATA.restaurants.filter(r => r.cuisine === 'italienisch');
        if (italian.length > 0) {
            const r = italian[0];
            return `🍕 Pizza-Zeit! <strong>${r.name}</strong> hat leckere italienische Küche!<br><br>• ${r.freeTables} Tische verfügbar<br>• Bewertung: ⭐ ${r.rating}<br>${r.offer ? `• 🎁 ${r.offer.title}` : ''}<br><br>Soll ich reservieren?`;
        }
    }
    
    // Café/Kaffee
    if (msg.match(/(kaffee|café|cafe|kuchen|tee|frühstück|torte)/)) {
        const cafes = APP_DATA.restaurants.filter(r => r.cuisine === 'cafe');
        if (cafes.length > 0) {
            const r = cafes[0];
            return `☕ ${isMorning ? 'Perfekt für ein Frühstück!' : 'Zeit für Kaffee und Kuchen!'}<br><br><strong>${r.name}</strong> - Gemütlich mit ${r.freeTables > 0 ? `${r.freeTables} freien Plätzen` : 'aktuell voller Hütte'}.<br><br>🍵 Tipp: Probier einen echten Ostfriesentee mit Kluntje und Sahne!`;
        }
    }
    
    // Döner/Türkisch
    if (msg.match(/(döner|türk|kebab|lahmacun|pide)/)) {
        const turkish = APP_DATA.restaurants.filter(r => r.cuisine === 'tuerkisch');
        if (turkish.length > 0) {
            const r = turkish[0];
            return `🥙 Döner gesucht? <strong>${r.name}</strong> hat leckere türkische Küche! ${r.freeTables > 0 ? `Noch ${r.freeTables} Plätze.` : ''}`;
        }
        return 'Ich suche nach türkischen Restaurants in der Nähe... Schau mal unter "Essen" und filtere nach Küche!';
    }
    
    // Bar/Shisha
    if (msg.match(/(bar|cocktail|bier|shisha|kneipe|ausgehen|trinken|abend)/)) {
        const bars = APP_DATA.restaurants.filter(r => r.cuisine === 'bar' || r.cuisine === 'shisha');
        if (bars.length > 0) {
            const r = bars[0];
            return `🍹 Lust auf Ausgehen? <strong>${r.name}</strong> ist ein guter Spot! ${r.freeTables > 0 ? `${r.freeTables} Plätze frei.` : ''}<br><br>Schau unter "Essen" und filtere nach "Bar" oder "Shisha"!`;
        }
        return 'Bars und Shisha-Lounges findest du unter "Essen" - wähle die passende Kategorie!';
    }
    
    // ==================== FREIE TISCHE ====================
    if (msg.match(/(frei|verfügbar|tisch|platz|sofort|jetzt|spontan)/)) {
        const available = APP_DATA.restaurants.filter(r => r.freeTables > 0).sort((a,b) => b.freeTables - a.freeTables);
        if (available.length > 0) {
            let response = `✅ ${available.length} Restaurants mit freien Tischen:<br><br>`;
            available.slice(0, 4).forEach(r => {
                response += `• <strong>${r.name}</strong> - ${r.freeTables} Tische - ⭐ ${r.rating}<br>`;
            });
            response += `<br>Tippe auf "Jetzt geöffnet" im Filter für alle!`;
            return response;
        }
        return '😅 Gerade sind alle Restaurants voll. Versuch es in 30 Minuten nochmal oder ruf direkt an!';
    }
    
    // ==================== RESERVIERUNG ====================
    if (msg.match(/(reserv|buchen|bestellen|tisch.*für)/)) {
        // Versuche Personenzahl zu erkennen
        const personMatch = msg.match(/(\d+)\s*(person|leute|gäste|pax)/);
        const persons = personMatch ? personMatch[1] : null;
        
        let response = '📋 <strong>So reservierst du:</strong><br><br>';
        response += '1️⃣ Geh zu "Essen" und wähle ein Restaurant<br>';
        response += '2️⃣ Tippe auf "Reservieren"<br>';
        response += '3️⃣ Wähle Datum, Uhrzeit' + (persons ? ` und ${persons} Personen` : ' und Personenzahl') + '<br>';
        response += '4️⃣ Bestätige per WhatsApp<br><br>';
        response += '💡 Das Restaurant meldet sich dann bei dir!';
        return response;
    }
    
    // ==================== AUSFLÜGE & AKTIVITÄTEN ====================
    if (msg.match(/(ausflug|machen|sehen|tipps|unternehmen|aktivität|sehenswürdig|besuch|entdecken|langweilig)/)) {
        const tips = [
            { name: 'Pilsumer Leuchtturm', desc: 'Der berühmte gelbe Otto-Leuchtturm', icon: '🏠' },
            { name: 'Seehundstation', desc: 'Robbenbabys beobachten', icon: '🦭' },
            { name: 'Wattwanderung', desc: 'UNESCO Weltnaturerbe erleben', icon: '🦶' },
            { name: 'Greetsiel Hafen', desc: 'Krabbenkutter und frischer Fisch', icon: '⛵' },
            { name: 'Teemuseum', desc: 'Ostfriesische Teekultur', icon: '🍵' }
        ];
        
        let response = '🗺️ <strong>Top Ausflugstipps:</strong><br><br>';
        tips.forEach(t => {
            response += `${t.icon} <strong>${t.name}</strong> - ${t.desc}<br>`;
        });
        response += `<br>Mehr unter "Entdecken"!`;
        
        if (isRainy) {
            response += `<br><br>☔ Bei Regen: Seehundstation oder Teemuseum sind drinnen!`;
        }
        return response;
    }
    
    // ==================== UNTERKÜNFTE ====================
    if (msg.match(/(hotel|unterkunft|übernacht|schlafen|ferien|pension|ferienwohnung|airbnb)/)) {
        return '🏨 <strong>Unterkünfte findest du unter "Schlafen"!</strong><br><br>Wir haben:<br>• Hotels<br>• Ferienwohnungen<br>• Pensionen<br><br>Du kannst direkt anfragen oder per WhatsApp Kontakt aufnehmen. Brauchst du was Bestimmtes?';
    }
    
    // ==================== EVENTS ====================
    if (msg.match(/(event|veranstaltung|fest|markt|konzert|heute abend|was.*los)/)) {
        return '🎉 <strong>Events findest du unter "Events"!</strong><br><br>Dort siehst du:<br>• Wochenmärkte<br>• Feste & Feiern<br>• Konzerte<br>• Naturevents<br><br>Schau mal rein - vielleicht ist heute was los!';
    }
    
    // ==================== JOBS ====================
    if (msg.match(/(job|arbeit|stell|bewerbung|kellner|koch|aushilfe)/)) {
        return '💼 <strong>Jobs findest du unter "Jobs"!</strong><br><br>Restaurants suchen:<br>• Kellner/innen<br>• Köche<br>• Aushilfen<br>• Minijobber<br><br>Du kannst dich direkt per WhatsApp bewerben!';
    }
    
    // ==================== PREISE ====================
    if (msg.match(/(preis|kostet|günstig|billig|teuer|budget)/)) {
        const cheap = APP_DATA.restaurants.filter(r => ['imbiss', 'cafe'].includes(r.cuisine));
        return '💰 <strong>Preisübersicht:</strong><br><br>• Imbiss/Café: 5-15€<br>• Pizzeria: 10-20€<br>• Fischrestaurant: 15-35€<br>• Gehobenes Restaurant: 25-50€<br><br>Tipp: Schau auf "Angebote" - dort gibt es oft Rabatte!';
    }
    
    // ==================== ÖFFNUNGSZEITEN ====================
    if (msg.match(/(öffnung|geöffnet|wann.*auf|wann.*zu|schließ)/)) {
        return '🕐 <strong>Typische Öffnungszeiten:</strong><br><br>• Mittagstisch: 11:30 - 14:00<br>• Abends: 17:30 - 21:00<br>• Cafés: oft durchgehend<br><br>Tippe auf "Jetzt geöffnet" um nur offene Restaurants zu sehen!';
    }
    
    // ==================== DANKE ====================
    if (msg.match(/(danke|super|toll|perfekt|klasse|prima|genial)/)) {
        const thanks = [
            'Gern geschehen! 😊 Genieß deinen Aufenthalt in Ostfriesland!',
            'Freut mich dass ich helfen konnte! Bei Fragen - einfach schreiben!',
            'Immer gerne! Viel Spaß beim Essen und Entdecken! 🌊'
        ];
        return thanks[Math.floor(Math.random() * thanks.length)];
    }
    
    // ==================== HILFE ====================
    if (msg.match(/(hilfe|help|was kannst|wie funktioniert|erklär)/)) {
        return '🤖 <strong>Ich bin dein Ostfriesland-Guide!</strong><br><br>Frag mich nach:<br>• 🍽️ "Wo kann ich Fisch essen?"<br>• 🪑 "Wer hat freie Tische?"<br>• 🌧️ "Was bei Regen machen?"<br>• 🗺️ "Ausflugstipps"<br>• 🏨 "Unterkünfte"<br>• ☕ "Gutes Café in der Nähe"<br><br>Ich kenne alle Restaurants und gebe dir persönliche Tipps!';
    }
    
    // ==================== ENGLISCH ERKENNEN ====================
    if (msg.match(/^(hello|hi there|good|what|where|how|can you|please|thank)/)) {
        return '🇬🇧 Hi! I can help you in English too!<br><br>Ask me about:<br>• Restaurants with free tables<br>• Fish restaurants<br>• Things to do<br>• Weather tips<br><br>Or switch to English with the language button (EN) at the top!';
    }
    
    // ==================== NIEDERLÄNDISCH ERKENNEN ====================
    if (msg.match(/^(hoi|hallo|goedendag|waar|wat|hoe|kun je|alsjeblieft|bedankt)/)) {
        return '🇳🇱 Hoi! Ik kan je ook in het Nederlands helpen!<br><br>Klik op "NL" bovenaan om de taal te wijzigen. Dan is alles in het Nederlands!';
    }
    
    // ==================== FALLBACK - SMARTER ====================
    // Versuche irgendwas Nützliches zu finden
    if (APP_DATA.restaurants && APP_DATA.restaurants.length > 0) {
        const random = APP_DATA.restaurants[Math.floor(Math.random() * APP_DATA.restaurants.length)];
        const fallbacks = [
            `Hmm, das habe ich nicht verstanden. 🤔 Aber schau mal: <strong>${random.name}</strong> hat gerade ${random.freeTables} freie Tische! Oder frag mich nach "freie Tische", "Fischrestaurant" oder "Ausflugstipps"!`,
            `Das weiß ich leider nicht. Aber ich kann dir bei Restaurants helfen! Gerade ist <strong>${random.name}</strong> eine gute Wahl mit ⭐ ${random.rating} Bewertung.`,
            `Keine Ahnung... 😅 Aber versuch mal: "Was soll ich essen?" oder "Wer hat freie Tische?" - da kann ich helfen!`
        ];
        return fallbacks[Math.floor(Math.random() * fallbacks.length)];
    }
    
    return 'Das habe ich nicht verstanden. Versuch mal: "Freie Tische", "Fisch-Restaurant", "Ausflugstipps" oder "Hilfe"!';
}

// Initialize on load
document.addEventListener("DOMContentLoaded", function() {
    init();
    
    // Event Listeners für Header Buttons
    const themeBtn = document.getElementById('themeBtn');
    const notificationBtn = document.getElementById('notificationBtn');
    
    if (themeBtn) {
        themeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Theme Button geklickt');
            openModal('themeModal');
        });
    }
    
    if (notificationBtn) {
        notificationBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Notification Button geklickt');
            openModal('notificationModal');
        });
    }
});

// ==================== PWA SERVICE WORKER ====================
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then((registration) => {
                console.log('[OK] ServiceWorker registriert:', registration.scope);
            })
            .catch((error) => {
                console.log('❌ ServiceWorker Fehler:', error);
            });
    });
}

// ==================== PWA INSTALL BANNER ====================
let deferredPrompt;
const installBanner = document.getElementById('installBanner');

window.addEventListener('beforeinstallprompt', (e) => {
    console.log('Install Prompt verfügbar');
    e.preventDefault();
    deferredPrompt = e;
    
    // Banner anzeigen wenn noch nicht installiert
    if (installBanner) {
        installBanner.classList.add('show');
    }
});

function installPWA() {
    if (!deferredPrompt) {
        console.log('Kein Install Prompt verfügbar');
        return;
    }
    
    deferredPrompt.prompt();
    
    deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
            console.log('[OK] App wurde installiert');
            showToast('App wurde installiert!', 'success');
        }
        deferredPrompt = null;
        
        if (installBanner) {
            installBanner.classList.remove('show');
        }
    });
}

function dismissInstallBanner() {
    if (installBanner) {
        installBanner.classList.remove('show');
    }
    localStorage.setItem('kmi_install_dismissed', 'true');
}

// Banner nicht anzeigen wenn schon abgelehnt
window.addEventListener('appinstalled', () => {
    console.log('[OK] PWA wurde zum Homescreen hinzugefügt');
    if (installBanner) {
        installBanner.classList.remove('show');
    }
});
</script>

<!-- PWA Install Banner -->
<div id="installBanner" class="install-banner">
    <div class="install-content">
        <div class="install-icon" style="font-size: 24px;">App</div>
        <div class="install-text">
            <strong>Kiek mol in installieren</strong>
            <span>Zum Startbildschirm hinzufügen</span>
        </div>
    </div>
    <div class="install-actions">
        <button onclick="dismissInstallBanner()" class="install-btn-later">Später</button>
        <button onclick="installPWA()" class="install-btn-install">Installieren</button>
    </div>
</div>

<style>
.install-banner {
    position: fixed;
    bottom: -120px;
    left: 20px;
    right: 20px;
    max-width: 400px;
    margin: 0 auto;
    background: var(--bg-card);
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 -4px 30px rgba(0,0,0,0.2);
    z-index: 9999;
    transition: bottom 0.4s ease;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.install-banner.show {
    bottom: 90px;
}

.install-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

.install-icon {
    font-size: 32px;
}

.install-text {
    display: flex;
    flex-direction: column;
}

.install-text strong {
    font-size: 15px;
    color: var(--text-primary);
}

.install-text span {
    font-size: 13px;
    color: var(--text-secondary);
}

.install-actions {
    display: flex;
    gap: 10px;
}

.install-btn-later {
    flex: 1;
    padding: 12px;
    background: var(--bg-secondary);
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
}

.install-btn-install {
    flex: 2;
    padding: 12px;
    background: var(--primary);
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    color: white;
    cursor: pointer;
}
</style>

<!-- Cookie Banner -->
<div id="cookieBanner" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 16px 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 10000; border-top: 1px solid var(--border-color);">
    <div style="max-width: 600px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
            <p style="font-size: 14px; color: var(--dark); margin: 0; line-height: 1.5;">
                <span data-i18n="cookieText">Wir nutzen Cookies für die Funktion der App.</span> 
                <a href="#" onclick="openModal('datenschutzModal'); return false;" style="color: var(--primary); text-decoration: underline;" data-i18n="cookieMore">Mehr erfahren</a>
            </p>
        </div>
        <button onclick="acceptCookies()" style="padding: 12px 28px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;" data-i18n="cookieAccept">
            Verstanden
        </button>
    </div>
</div>

<!-- Impressum Modal -->
<div class="modal-overlay" id="impressumModal">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <h2 class="modal-title">Impressum</h2>
            <button class="modal-close" onclick="closeModal('impressumModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">Angaben gemäß § 5 TMG</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px;">
                Ibrahim Kuran<br>
                Kurani Design<br>
                Waller Weg 37<br>
                26624 Südbrookmerland<br>
                Deutschland
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">Kontakt</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px;">
                E-Mail: <a href="/cdn-cgi/l/email-protection#f59c9b939ab59e9c909e989a999c9bdb9190" style="color: var(--primary);"><span class="__cf_email__" data-cfemail="aac3c4ccc5eac1c3cfc1c7c5c6c3c484cecf">[email&#160;protected]</span></a>
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">Verantwortlich für den Inhalt</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px;">
                Ibrahim Kuran<br>
                Waller Weg 37<br>
                26624 Südbrookmerland
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">Haftungsausschluss</h3>
            <p style="color: var(--slate); line-height: 1.6; font-size: 13px;">
                Die Inhalte unserer Seiten wurden mit größter Sorgfalt erstellt. Für die Richtigkeit, Vollständigkeit und Aktualität der Inhalte können wir jedoch keine Gewähr übernehmen. Als Diensteanbieter sind wir gemäß § 7 Abs.1 TMG für eigene Inhalte auf diesen Seiten nach den allgemeinen Gesetzen verantwortlich.
            </p>
        </div>
    </div>
</div>

<!-- Datenschutz Modal -->
<div class="modal-overlay" id="datenschutzModal">
    <div class="modal" style="max-width: 550px;">
        <div class="modal-header">
            <h2 class="modal-title">Datenschutzerklärung</h2>
            <button class="modal-close" onclick="closeModal('datenschutzModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">1. Datenschutz auf einen Blick</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Wir nehmen den Schutz Ihrer persönlichen Daten sehr ernst. Diese Datenschutzerklärung klärt Sie über die Art, den Umfang und Zweck der Verarbeitung von personenbezogenen Daten auf.
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">2. Verantwortlicher</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Ibrahim Kuran<br>
                Kurani Design<br>
                Waller Weg 37<br>
                26624 Südbrookmerland<br>
                E-Mail: <a href="/cdn-cgi/l/email-protection#c7aea9a1a887acaea2acaaa8abaea9e9a3a2" style="color: var(--primary);"><span class="__cf_email__" data-cfemail="a5cccbc3cae5ceccc0cec8cac9cccb8bc1c0">[email&#160;protected]</span></a>
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">3. Welche Daten wir erheben</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                <strong>Technisch notwendige Cookies:</strong> Wir nutzen localStorage, um Ihre Einstellungen (z.B. Dark Mode) zu speichern. Diese Daten bleiben auf Ihrem Gerät.<br><br>
                <strong>Google Login:</strong> Wenn Sie sich mit Google anmelden, erhalten wir Ihren Namen und Ihre E-Mail-Adresse von Google.<br><br>
                <strong>Reservierungen:</strong> Bei einer Reservierung speichern wir Ihren Namen, Kontaktdaten und die Reservierungsdetails.
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">4. Datenverarbeitung</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Die Daten werden auf Servern von Supabase (EU) gespeichert. Wir geben keine Daten an Dritte weiter, außer an die Restaurants für Ihre Reservierung.
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">5. Ihre Rechte</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Sie haben jederzeit das Recht auf Auskunft, Berichtigung, Löschung und Einschränkung der Verarbeitung Ihrer Daten. Kontaktieren Sie uns unter <a href="/cdn-cgi/l/email-protection#ef86818980af84868a848280838681c18b8a" style="color: var(--primary);"><span class="__cf_email__" data-cfemail="264f484049664d4f434d4b494a4f48084243">[email&#160;protected]</span></a>.
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">6. Wetter-Daten</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Wir nutzen die Open-Meteo API für Wetterdaten. Es werden keine persönlichen Daten an Open-Meteo übermittelt.
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">7. Hinweis zur Genauigkeit</h3>
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; border-left: 4px solid var(--primary);">
                <p style="color: var(--slate); line-height: 1.6; font-size: 14px; margin: 0;">
                    <strong>Wichtiger Hinweis:</strong> Alle Angaben in dieser App (Öffnungszeiten, Verfügbarkeiten, Gezeiten, Preise etc.) sind ohne Gewähr. Wir bemühen uns um Aktualität und Richtigkeit, können jedoch keine Garantie übernehmen. Bitte prüfen Sie wichtige Informationen vor Ort oder kontaktieren Sie die Restaurants direkt.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Reviews Modal -->
<div class="modal-overlay" id="reviewsModal">
    <div class="modal" style="max-width: 550px;">
        <div class="modal-header">
            <h2 class="modal-title" id="reviewsModalTitle">Bewertungen</h2>
            <button class="modal-close" onclick="closeModal('reviewsModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Stats Summary -->
            <div class="stats-summary" id="reviewsStatsSummary">
                <div class="stat-chip">
                    <span class="stat-chip-icon">⭐</span>
                    <span class="stat-chip-value" id="reviewsAvgRating">-</span>
                    <span class="stat-chip-label">Bewertung</span>
                </div>
                <div class="stat-chip">
                    <span class="stat-chip-icon">💬</span>
                    <span class="stat-chip-value" id="reviewsTotalCount">0</span>
                    <span class="stat-chip-label">Bewertungen</span>
                </div>
                <div class="stat-chip">
                    <span class="stat-chip-icon">🔥</span>
                    <span class="stat-chip-value" id="reviewsTodayVisitors">0</span>
                    <span class="stat-chip-label">heute</span>
                </div>
            </div>
            
            <!-- Live Activity -->
            <div style="margin-bottom: 20px;">
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 10px; color: var(--text-primary);">
                    <span class="live-badge">LIVE</span> Letzte Aktivität
                </h4>
                <div class="activity-feed" id="liveActivityFeed">
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        Lade Aktivität...
                    </div>
                </div>
            </div>
            
            <!-- Write Review Button -->
            <button onclick="openWriteReview()" class="btn btn-primary" style="width: 100%; margin-bottom: 20px;">
                ✏️ Bewertung schreiben
            </button>
            
            <!-- Reviews List -->
            <div class="reviews-container" id="reviewsList">
                <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                    <div style="font-size: 48px; margin-bottom: 12px;">💬</div>
                    <p>Noch keine Bewertungen</p>
                    <p style="font-size: 13px;">Sei der Erste!</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Write Review Modal -->
<div class="modal-overlay" id="writeReviewModal">
    <div class="modal" style="max-width: 450px;">
        <div class="modal-header">
            <h2 class="modal-title">Bewertung schreiben</h2>
            <button class="modal-close" onclick="closeModal('writeReviewModal')">×</button>
        </div>
        <div class="modal-body">
            <form id="writeReviewForm" onsubmit="handleSubmitReview(event)">
                <input type="hidden" id="reviewTargetType">
                <input type="hidden" id="reviewTargetId">
                <input type="hidden" id="reviewTargetName">
                
                <p style="margin-bottom: 16px; font-weight: 600; color: var(--text-primary);" id="writeReviewFor"></p>
                
                <!-- Star Rating -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Wie war dein Erlebnis?</p>
                    <div class="star-rating-input" id="starRatingInput">
                        <span onclick="setRating(1)" data-rating="1">☆</span>
                        <span onclick="setRating(2)" data-rating="2">☆</span>
                        <span onclick="setRating(3)" data-rating="3">☆</span>
                        <span onclick="setRating(4)" data-rating="4">☆</span>
                        <span onclick="setRating(5)" data-rating="5">☆</span>
                    </div>
                    <p id="ratingText" style="font-size: 14px; color: var(--primary); font-weight: 500;"></p>
                </div>
                
                <!-- Name (wenn nicht eingeloggt) -->
                <div class="form-group" id="reviewNameGroup">
                    <label class="form-label">Dein Name</label>
                    <input type="text" class="form-input" id="reviewUserName" placeholder="Wie möchtest du heißen?">
                </div>
                
                <!-- Title -->
                <div class="form-group">
                    <label class="form-label">Titel (optional)</label>
                    <input type="text" class="form-input" id="reviewTitle" placeholder="z.B. Tolles Essen!">
                </div>
                
                <!-- Comment -->
                <div class="form-group">
                    <label class="form-label">Deine Bewertung</label>
                    <textarea class="form-textarea" id="reviewComment" rows="4" placeholder="Erzähl von deinem Erlebnis..."></textarea>
                </div>
                
                <!-- Photo Upload -->
                <div class="form-group">
                    <label class="form-label">📸 Fotos hinzufügen (optional)</label>
                    <div class="photo-upload-grid" id="reviewPhotoGrid">
                        <label class="photo-upload-add">
                            <input type="file" accept="image/*" multiple onchange="handleReviewPhotoUpload(event)" style="display: none;">
                            +
                        </label>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    ⭐ Bewertung absenden
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Punkte & Achievements Modal -->
<div class="modal-overlay" id="pointsModal">
    <div class="modal" style="max-width: 450px;">
        <div class="modal-header">
            <h2 class="modal-title">Meine Belohnungen</h2>
            <button class="modal-close" onclick="closeModal('pointsModal')">×</button>
        </div>
        <div class="modal-body">
            <!-- Punkte Übersicht -->
            <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%); border-radius: 16px; margin-bottom: 20px; color: #333;">
                <div style="font-size: 48px; font-weight: 700;" id="pointsModalTotal">0</div>
                <div style="font-size: 14px; opacity: 0.8;">Gesammelte Punkte</div>
                <div style="margin-top: 12px;">
                    <span class="level-badge" id="userLevel">🥉 Bronze</span>
                </div>
            </div>
            
            <!-- Fortschritt zum nächsten Level -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px;">
                    <span id="currentLevelLabel">Bronze</span>
                    <span id="nextLevelLabel">Silber (500)</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="levelProgress" style="width: 0%;"></div>
                </div>
            </div>
            
            <!-- So verdienst du Punkte -->
            <h4 style="margin: 0 0 12px; font-size: 14px;">So verdienst du Punkte:</h4>
            <div style="display: grid; gap: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                    <span>🍽️ Tisch reservieren</span>
                    <span style="font-weight: 600; color: #ffd700;">+50</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                    <span>⭐ Bewertung schreiben</span>
                    <span style="font-weight: 600; color: #ffd700;">+100</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                    <span>📸 Foto hochladen</span>
                    <span style="font-weight: 600; color: #ffd700;">+30</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                    <span>👥 Freund einladen</span>
                    <span style="font-weight: 600; color: #ffd700;">+300</span>
                </div>
            </div>
            
            <!-- Achievements -->
            <h4 style="margin: 0 0 12px; font-size: 14px;">🏅 Achievements:</h4>
            <div id="achievementsList" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                <!-- Wird dynamisch gefüllt -->
            </div>
            
            <!-- Belohnungen Button -->
            <button onclick="closeModal('pointsModal'); loadAvailableRewards(); openModal('availableRewardsModal');" class="btn btn-primary" style="width: 100%; margin-top: 20px; padding: 14px; font-size: 16px;">
                Belohnungen einlösen
            </button>
        </div>
    </div>
</div>

<!-- Belohnung erstellen Modal -->
<div class="modal-overlay" id="addRewardModal">
    <div class="modal" style="max-width: 480px;">
        <div class="modal-header">
            <h2 class="modal-title">Neue Belohnung erstellen</h2>
            <button class="modal-close" onclick="closeModal('addRewardModal')">×</button>
        </div>
        <div class="modal-body">
            <form id="addRewardForm" onsubmit="saveReward(event)">
                <!-- Icon Auswahl -->
                <div class="form-group">
                    <label class="form-label">Icon wählen:</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;" id="rewardIconPicker">
                        <button type="button" class="reward-icon-btn active" data-icon="coffee" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
                        </button>
                        <button type="button" class="reward-icon-btn" data-icon="cake" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1"/><path d="M2 21h20"/><path d="M7 8v2"/><path d="M12 8v2"/><path d="M17 8v2"/><path d="M7 4h.01"/><path d="M12 4h.01"/><path d="M17 4h.01"/></svg>
                        </button>
                        <button type="button" class="reward-icon-btn" data-icon="percent" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>
                        </button>
                        <button type="button" class="reward-icon-btn" data-icon="utensils" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/></svg>
                        </button>
                        <button type="button" class="reward-icon-btn" data-icon="gift" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>
                        </button>
                        <button type="button" class="reward-icon-btn" data-icon="star" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                        </button>
                        <button type="button" class="reward-icon-btn" data-icon="award" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
                        </button>
                        <button type="button" class="reward-icon-btn" data-icon="crown" onclick="selectRewardIcon(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg>
                        </button>
                    </div>
                    <input type="hidden" id="rewardIcon" value="coffee">
                </div>

                <!-- Titel -->
                <div class="form-group">
                    <label class="form-label">Titel der Belohnung *</label>
                    <input type="text" class="form-input" id="rewardTitle" placeholder="z.B. Gratis Kaffee" required maxlength="100">
                </div>

                <!-- Beschreibung -->
                <div class="form-group">
                    <label class="form-label">Beschreibung (optional)</label>
                    <textarea class="form-input" id="rewardDescription" placeholder="z.B. Ein Heißgetränk nach Wahl" rows="2"></textarea>
                </div>

                <!-- Punkte -->
                <div class="form-group">
                    <label class="form-label">Benötigte Punkte *</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" class="form-input" id="rewardPoints" value="500" min="100" max="10000" step="50" required>
                        <span style="display: flex; align-items: center; color: var(--text-secondary);">🌟</span>
                    </div>
                    <small style="color: var(--text-secondary);">Empfohlen: 300-1000 Punkte</small>
                </div>

                <!-- Typ -->
                <div class="form-group">
                    <label class="form-label">Art der Belohnung</label>
                    <select class="form-input" id="rewardType" onchange="toggleDiscountField()">
                        <option value="freebie">Gratis-Artikel (Kaffee, Dessert, etc.)</option>
                        <option value="discount">Rabatt auf Rechnung</option>
                        <option value="upgrade">Upgrade (größere Portion, etc.)</option>
                        <option value="special">Spezial-Erlebnis</option>
                    </select>
                </div>

                <!-- Rabatt Prozent (nur bei discount) -->
                <div class="form-group" id="discountField" style="display: none;">
                    <label class="form-label">Rabatt in %</label>
                    <input type="number" class="form-input" id="rewardDiscount" value="10" min="5" max="50" step="5">
                </div>

                <!-- Max Einlösungen -->
                <div class="form-group">
                    <label class="form-label">Maximale Einlösungen (optional)</label>
                    <input type="number" class="form-input" id="rewardMaxRedemptions" placeholder="Leer = unbegrenzt" min="1">
                    <small style="color: var(--text-secondary);">Leer lassen für unbegrenzt</small>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">
                    🎁 Belohnung erstellen
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Code einlösen Modal (für Gäste) -->
<div class="modal-overlay" id="redeemCodeModal">
    <div class="modal" style="max-width: 400px; text-align: center;">
        <div class="modal-header">
            <h2 class="modal-title">Dein Belohnungs-Code</h2>
            <button class="modal-close" onclick="closeModal('redeemCodeModal')">×</button>
        </div>
        <div class="modal-body">
            <div style="background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%); border-radius: 16px; padding: 24px; margin-bottom: 20px;">
                <div style="font-size: 14px; color: #333; opacity: 0.8; margin-bottom: 8px;">Zeige diesen Code im Restaurant:</div>
                <div id="redemptionCode" style="font-size: 32px; font-weight: 700; color: #333; letter-spacing: 4px; font-family: monospace;">
                    KMI-XXXXXX
                </div>
            </div>
            
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: left;">
                <div style="font-weight: 600; margin-bottom: 8px;" id="redeemedRewardTitle">Gratis Kaffee</div>
                <div style="font-size: 14px; color: var(--text-secondary);" id="redeemedRewardRestaurant">@ Restaurant Name</div>
            </div>

            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                Gültig für 24 Stunden. Zeige den Code beim Bezahlen.
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button onclick="copyRedemptionCode()" class="btn btn-secondary">
                    📋 Kopieren
                </button>
                <button onclick="closeModal('redeemCodeModal')" class="btn btn-primary">
                    ✓ Verstanden
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Verfügbare Belohnungen Modal (für Gäste) -->
<div class="modal-overlay" id="availableRewardsModal">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <h2 class="modal-title">Belohnungen einlösen</h2>
            <button class="modal-close" onclick="closeModal('availableRewardsModal')">×</button>
        </div>
        <div class="modal-body">
            <!-- Punkte-Stand -->
            <div style="background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center; color: #333;">
                <div style="font-size: 12px; opacity: 0.8;">Deine Punkte</div>
                <div style="font-size: 36px; font-weight: 700;" id="availableRewardsPoints">0</div>
            </div>

            <!-- Belohnungen Liste -->
            <div id="availableRewardsList">
                <p style="padding: 20px; color: var(--text-secondary); text-align: center;">Lade Belohnungen...</p>
            </div>
        </div>
    </div>
</div>

<!-- Vollbild Karten Modal -->
<div class="modal-overlay" id="fullscreenMapModal" style="z-index: 10001;">
    <div class="modal" style="max-width: 100%; max-height: 100%; width: 100%; height: 100%; margin: 0; border-radius: 0; overflow: hidden;">
        <!-- Header -->
        <div style="position: absolute; top: 0; left: 0; right: 0; z-index: 1001; padding: 16px; background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(255,255,255,0.8)); backdrop-filter: blur(10px);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <button onclick="closeModal('fullscreenMapModal')" style="background: var(--bg-secondary); border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h3 style="margin: 0; font-size: 17px; font-weight: 600;">Karte</h3>
                <button onclick="centerOnUserLocation()" style="background: var(--primary); border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="18" height="18">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
                    </svg>
                </button>
            </div>
            
            <!-- Filter Chips -->
            <div style="display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; padding-bottom: 4px;">
                <button class="map-chip active" onclick="filterMapFullscreen('all', this)" style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap;">Alle</button>
                <button class="map-chip" onclick="filterMapFullscreen('restaurant', this)" style="background: var(--bg-secondary); color: var(--text-primary); border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 500; cursor: pointer; white-space: nowrap;">Restaurants</button>
                <button class="map-chip" onclick="filterMapFullscreen('cafe', this)" style="background: var(--bg-secondary); color: var(--text-primary); border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 500; cursor: pointer; white-space: nowrap;">Cafés</button>
                <button class="map-chip" onclick="filterMapFullscreen('available', this)" style="background: var(--bg-secondary); color: var(--text-primary); border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 500; cursor: pointer; white-space: nowrap;">Verfügbar</button>
            </div>
        </div>
        
        <!-- Fullscreen Map Container -->
        <div id="fullscreenMapContainer" style="width: 100%; height: 100%;"></div>
        
        <!-- Bottom Preview Cards -->
        <div id="fullscreenMapCards" style="position: absolute; bottom: 20px; left: 0; right: 0; z-index: 1001; display: flex; gap: 12px; padding: 0 16px; overflow-x: auto; scrollbar-width: none;">
            <!-- Wird dynamisch gefüllt -->
        </div>
    </div>
</div>

<!-- Wetter Detail Modal - Apple Style -->
<div class="modal-overlay" id="weatherDetailModal">
    <div class="modal" style="max-width: 100%; max-height: 90vh; width: 100%; margin: auto 0 0; border-radius: 20px 20px 0 0; overflow: hidden;">
        <div id="weatherModalBg" style="background: linear-gradient(180deg, #4A90D9 0%, #67B8DE 100%); min-height: 80vh; position: relative;">
            <!-- Close Button -->
            <button onclick="closeModal('weatherDetailModal')" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 50%; color: white; font-size: 18px; cursor: pointer; z-index: 10;">×</button>
            
            <!-- Header -->
            <div style="text-align: center; padding: 40px 20px 20px; color: white;">
                <div style="font-size: 28px; font-weight: 300;">Mein Standort</div>
                <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;" id="weatherModalLocation">OSTFRIESLAND</div>
                <div style="font-size: 86px; font-weight: 100; line-height: 1; margin: 10px 0;" id="weatherModalTemp">8°</div>
                <div style="font-size: 18px;" id="weatherModalDesc">Meist bewölkt</div>
                <div style="font-size: 16px; opacity: 0.9; margin-top: 6px;">
                    H: <span id="weatherModalHigh">12°</span>  T: <span id="weatherModalLow">5°</span>
                </div>
            </div>
            
            <!-- Stündliche Vorhersage Card -->
            <div style="margin: 0 16px 16px; background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 16px; overflow: hidden;">
                <div style="padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.2); color: white; font-size: 13px; opacity: 0.8;" id="weatherModalSummary">
                    Wolken den ganzen Tag. Windböen mit bis zu 15 km/h.
                </div>
                <div id="hourlyForecastModal" style="display: flex; overflow-x: auto; padding: 12px 8px; gap: 0; scrollbar-width: none;">
                    <!-- Wird dynamisch gefüllt -->
                </div>
            </div>
            
            <!-- 10-Tage Vorhersage -->
            <div style="margin: 0 16px 20px; background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 16px; overflow: hidden;">
                <div style="padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.2); color: white; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
                    10-TAGE-VORHERSAGE
                </div>
                <div id="dailyForecastModal" style="padding: 8px 16px; color: white;">
                    <!-- Wird dynamisch gefüllt -->
                </div>
            </div>
            
            <!-- Zusätzliche Infos -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 0 16px 30px;">
                <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); border-radius: 16px; padding: 14px;">
                    <div style="color: white; opacity: 0.7; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M17.7 7.7a7.5 7.5 0 1 0-10.6 10.6"/><path d="M12 2v4M2 12h4M20 12h2M12 20v2"/></svg>
                        WIND
                    </div>
                    <div style="color: white; font-size: 28px; font-weight: 300; margin-top: 8px;" id="weatherModalWind">15 km/h</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); border-radius: 16px; padding: 14px;">
                    <div style="color: white; opacity: 0.7; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                        LUFTFEUCHTIGKEIT
                    </div>
                    <div style="color: white; font-size: 28px; font-weight: 300; margin-top: 8px;" id="weatherModalHumidity">75%</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gruppen-Reservierung Modal -->
<div class="modal-overlay" id="groupReservationModal">
    <div class="modal" style="max-width: 480px;">
        <div class="modal-header">
            <h2 class="modal-title">Gruppen-Reservierung</h2>
            <button class="modal-close" onclick="closeModal('groupReservationModal')">×</button>
        </div>
        <div class="modal-body">
            <!-- Info -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" width="20" height="20">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <strong>So funktioniert's:</strong>
                </div>
                <ol style="margin: 0; padding-left: 20px; font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                    <li>Erstelle eine Gruppen-Session</li>
                    <li>Teile den Link mit Freunden</li>
                    <li>Alle können abstimmen</li>
                    <li>Reserviere für alle zusammen</li>
                </ol>
            </div>
            
            <!-- Neue Gruppe erstellen -->
            <div style="margin-bottom: 16px;">
                <label class="form-label">Gruppenname</label>
                <input type="text" class="form-input" id="groupName" placeholder="z.B. Geburtstagsessen Anna">
            </div>
            
            <div style="margin-bottom: 16px;">
                <label class="form-label">Anzahl Personen (ca.)</label>
                <input type="number" class="form-input" id="groupSize" value="6" min="2" max="30">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label class="form-label">Datum</label>
                    <input type="date" class="form-input" id="groupDate">
                </div>
                <div>
                    <label class="form-label">Uhrzeit</label>
                    <select class="form-input" id="groupTime">
                        <option value="12:00">12:00</option>
                        <option value="12:30">12:30</option>
                        <option value="13:00">13:00</option>
                        <option value="13:30">13:30</option>
                        <option value="14:00">14:00</option>
                        <option value="17:00">17:00</option>
                        <option value="17:30">17:30</option>
                        <option value="18:00" selected>18:00</option>
                        <option value="18:30">18:30</option>
                        <option value="19:00">19:00</option>
                        <option value="19:30">19:30</option>
                        <option value="20:00">20:00</option>
                        <option value="20:30">20:30</option>
                        <option value="21:00">21:00</option>
                    </select>
                </div>
            </div>
            
            <button onclick="createNewGroup()" class="btn btn-primary" style="width: 100%;">
                Gruppe erstellen & Link teilen
            </button>
            
            <!-- Aktive Gruppe -->
            <div id="activeGroupSection" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
                <h4 style="margin-bottom: 12px;">Deine aktive Gruppe:</h4>
                <div style="background: var(--primary); color: white; border-radius: 12px; padding: 16px;">
                    <div style="font-weight: 600; margin-bottom: 4px;" id="activeGroupName">Geburtstagsessen</div>
                    <div style="font-size: 13px; opacity: 0.8;" id="activeGroupMembers">3 Teilnehmer</div>
                    <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;" id="activeGroupDateTime"></div>
                </div>
                
                <!-- Voting -->
                <div style="margin-top: 16px;">
                    <h5 style="margin-bottom: 8px;">Restaurant-Vorschläge:</h5>
                    <div id="groupVotingList">
                        <!-- Wird dynamisch gefüllt -->
                    </div>
                </div>
                
                <button onclick="shareGroupLink()" class="btn btn-secondary" style="width: 100%; margin-top: 12px;">
                    Link erneut teilen
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Gruppen-Voting Modal für Teilnehmer -->
<div class="modal-overlay" id="groupVotingModal">
    <div class="modal" style="max-width: 480px;">
        <div class="modal-header">
            <h2 class="modal-title">Gruppen-Abstimmung</h2>
            <button class="modal-close" onclick="closeModal('groupVotingModal')">×</button>
        </div>
        <div class="modal-body">
            <!-- Gruppen-Info -->
            <div style="background: var(--primary); color: white; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                <div style="font-weight: 700; font-size: 18px; margin-bottom: 4px;" id="votingGroupName">Gruppenname</div>
                <div style="font-size: 14px; opacity: 0.9;" id="votingGroupInfo">6 Personen</div>
                <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;" id="votingGroupDateTime"></div>
            </div>
            
            <!-- Abstimmung Info -->
            <div style="text-align: center; margin-bottom: 16px;">
                <p style="color: var(--text-secondary); font-size: 14px;">Tippe auf dein Lieblingsrestaurant um abzustimmen!</p>
            </div>
            
            <!-- Restaurant Voting Liste -->
            <div id="groupVotingListModal">
                <!-- Wird dynamisch gefüllt -->
            </div>
            
            <!-- Teilen Button -->
            <button onclick="shareGroupLink()" class="btn btn-secondary" style="width: 100%; margin-top: 16px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;">
                    <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                </svg>
                Weitere Freunde einladen
            </button>
        </div>
    </div>
</div>

<!-- AR Preview Modal -->
<div class="modal-overlay" id="arPreviewModal">
    <div class="modal" style="max-width: 100%; max-height: 100%; width: 100%; height: 100%; margin: 0; border-radius: 0;">
        <div class="modal-header" style="position: absolute; top: 0; left: 0; right: 0; z-index: 10; background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent); padding: 16px;">
            <h2 class="modal-title" style="color: white;" id="arDishName">Gericht</h2>
            <button class="modal-close" onclick="closeARPreview()" style="color: white;">×</button>
        </div>
        <div class="modal-body" style="padding: 0; height: 100%; position: relative; overflow: hidden;">
            <!-- Kamera Container -->
            <div id="arCameraContainer" style="width: 100%; height: 100%; background: #000;">
                <video id="arVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover; display: none;"></video>
                <canvas id="arCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none;"></canvas>
                
                <!-- Placeholder -->
                <div id="arPlaceholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: white; text-align: center; padding: 20px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64" style="margin-bottom: 16px; opacity: 0.5;">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                        <circle cx="12" cy="13" r="4"/>
                    </svg>
                    <p style="margin: 0 0 8px;">Kamera wird geladen...</p>
                    <p style="font-size: 12px; opacity: 0.7;">Erlaube den Kamera-Zugriff</p>
                </div>
            </div>
            
            <!-- Hidden Dish Image für AR -->
            <img id="arDishImg" src="" crossorigin="anonymous" style="display: none;">
            
            <!-- Controls -->
            <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);">
                <!-- Größen-Slider -->
                <div style="margin-bottom: 16px;">
                    <label style="color: white; font-size: 12px; display: block; margin-bottom: 8px;">Größe anpassen:</label>
                    <input type="range" id="arScale" min="0.5" max="2" step="0.1" value="1" style="width: 100%;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button onclick="captureARPhoto()" class="btn btn-primary">
                        Foto machen
                    </button>
                    <button onclick="closeARPreview()" class="btn btn-secondary" style="background: rgba(255,255,255,0.2); color: white; border: none;">
                        Schließen
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Push-Benachrichtigungen Modal -->
<div class="modal-overlay" id="pushNotificationModal">
    <div class="modal" style="max-width: 400px; text-align: center;">
        <div class="modal-header">
            <h2 class="modal-title">Benachrichtigungen</h2>
            <button class="modal-close" onclick="closeModal('pushNotificationModal')">×</button>
        </div>
        <div class="modal-body">
            <div style="width: 80px; height: 80px; background: var(--bg-secondary); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" width="40" height="40">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
            </div>
            
            <h3 style="margin-bottom: 8px;">Verpasse nichts!</h3>
            <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 24px;">
                Erhalte Benachrichtigungen über:
            </p>
            
            <div style="text-align: left; margin-bottom: 24px;">
                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="pushReservations" checked style="width: 18px; height: 18px;">
                    <div>
                        <div style="font-weight: 600;">Reservierungsbestätigungen</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Wenn dein Tisch bestätigt wird</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="pushOffers" checked style="width: 18px; height: 18px;">
                    <div>
                        <div style="font-weight: 600;">Neue Angebote</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Spezielle Deals in deiner Nähe</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; cursor: pointer;">
                    <input type="checkbox" id="pushTables" style="width: 18px; height: 18px;">
                    <div>
                        <div style="font-weight: 600;">Tisch frei geworden</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Bei deinen Favoriten</div>
                    </div>
                </label>
            </div>
            
            <button onclick="enablePushNotifications()" class="btn btn-primary" style="width: 100%;">
                Benachrichtigungen aktivieren
            </button>
            <button onclick="closeModal('pushNotificationModal')" class="btn btn-secondary" style="width: 100%; margin-top: 8px;">
                Später
            </button>
        </div>
    </div>
</div>

<!-- AGB Modal -->
<div class="modal-overlay" id="agbModal">
    <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
            <h2 class="modal-title">Allgemeine Geschäftsbedingungen</h2>
            <button class="modal-close" onclick="closeModal('agbModal')">×</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">1. Geltungsbereich</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Diese AGB gelten für alle Verträge zwischen Kurani Design (nachfolgend "Anbieter") und den teilnehmenden Restaurants (nachfolgend "Partner") über die Nutzung der Plattform "Kiek mol in" (kiekmolin.de).
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">2. Leistungen</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Der Anbieter stellt dem Partner eine Online-Plattform zur Verfügung, über die:<br><br>
                • Das Restaurant präsentiert wird<br>
                • Tischverfügbarkeiten angezeigt werden<br>
                • Reservierungsanfragen entgegengenommen werden<br>
                • Angebote und Aktionen beworben werden können
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">3. Vertragslaufzeit</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Der Vertrag wird auf unbestimmte Zeit geschlossen. Er kann von beiden Seiten mit einer Frist von 30 Tagen zum Monatsende gekündigt werden.
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">4. Preise und Zahlung</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                • Die monatliche Gebühr richtet sich nach dem gewählten Tarif<br>
                • Die Zahlung erfolgt per SEPA-Lastschrift<br>
                • Der Betrag wird am 1. eines jeden Monats eingezogen<br>
                • Bei fehlgeschlagener Abbuchung werden 5€ Mahngebühren berechnet
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">5. Pflichten des Partners</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Der Partner verpflichtet sich:<br><br>
                • Korrekte und aktuelle Daten bereitzustellen<br>
                • Tischverfügbarkeiten zeitnah zu aktualisieren<br>
                • Reservierungsanfragen zu bearbeiten<br>
                • Keine irreführenden Informationen zu veröffentlichen
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">6. Haftung</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Der Anbieter haftet nicht für entgangene Umsätze oder Schäden, die durch technische Störungen entstehen. Die Plattform wird "wie besehen" bereitgestellt.
            </p>
            
            <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--dark);">7. Datenschutz</h3>
            <p style="color: var(--slate); line-height: 1.6; margin-bottom: 16px; font-size: 14px;">
                Beide Parteien verpflichten sich zur Einhaltung der DSGVO. Kundendaten werden nur zu
